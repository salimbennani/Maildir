Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from pop3.zju.edu.cn (124.160.105.205:110) by
  likexu-MOBL1.ccr.corp.intel.com with POP3; 12 Nov 2018 00:45:47 -0000
Received: from icoremail.net (unknown [209.85.214.177])
	by mail-app2 (Coremail) with SMTP id by_KCgCn3yQGxOhbi9x4AQ--.36887S3;
	Mon, 12 Nov 2018 08:06:31 +0800 (CST)
Received: from mail-pl1-f177.google.com (unknown [209.85.214.177])
	by mx2.icoremail.net (Coremail) with SMTP id AQAAfwCXEE0ExOhbRMUuAA--.6702S3;
	Mon, 12 Nov 2018 08:06:28 +0800 (CST)
Received: by mail-pl1-f177.google.com with SMTP id p16-v6so3405941plr.8
        for <xuliker@zju.edu.cn>; Sun, 11 Nov 2018 16:06:28 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:delivered-to:dkim-signature:from:to:cc:subject
         :date:message-id:in-reply-to:references:user-agent:mime-version
         :content-transfer-encoding:sender:precedence:list-id;
        bh=Cilkn3QOKAYfRI7spLDZiqQIdABPjz4sbfR7JcPNODM=;
        b=JRgfVsfL1QA2FmWc01UBVbDeQ/qZlD57MLvv6eOqmyh/Rn8Ymg/oAyUTPcz7mUBtg4
         TKQPcycizaWNcnsmDfp6mXBaT8ufYjtb0fy1IcdlXv86l8osqIS/sbkrSyuT9i7I6h5X
         ky5oCcQHdqPB5UVoG6kjXKvx57o+53GtIw0WKkLBQpJeIMuEki7xnA7rcOqMvao28J19
         WkhCduVPavMpfLWGOU7i3Z+TdELMQUcAiPVZPVXTmaRQ6zZJrL+AiA3aItfTTouev6Xh
         19lNANI/xcR7qYWJetT2/cCilko4OKpKOgJUtYKEbLzDFvj/tLqufSo43xOTyx0vH0WS
         6pdg==
X-Gm-Message-State: AGRZ1gJKU55SXAU7MD8YxuuayG+QMSROm/MmKnOzRz7ZkZhRekPVBJpw
	dS2nIb0yvAW1dj9YLxsNw+hL9XOWx1ozUUgnrOuVC6MFsahdFH4=
X-Received: by 2002:a17:902:bd4a:: with SMTP id b10-v6mr17483233plx.171.1541981188366;
        Sun, 11 Nov 2018 16:06:28 -0800 (PST)
X-Forwarded-To: xuliker@zju.edu.cn
X-Forwarded-For: liker.xu@gmail.com xuliker@zju.edu.cn
Delivered-To: liker.xu@gmail.com
Received: by 2002:a17:90a:c304:0:0:0:0 with SMTP id g4-v6csp2588042pjt;
        Sun, 11 Nov 2018 16:06:27 -0800 (PST)
X-Google-Smtp-Source: AJdET5d/B45FlORHdbKpnEG71rwIZQa1UNdtXgf+EBgbE8oVN1Cc4tf+GSdz+Z7A6vMAM18OjkL0
X-Received: by 2002:a17:902:1124:: with SMTP id d33-v6mr18458569pla.125.1541981187630;
        Sun, 11 Nov 2018 16:06:27 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; t=1541981187; cv=none;
        d=google.com; s=arc-20160816;
        b=c9mUP8GaZxqEmpk+DFTaNzDRWewg6TY96AFxjAGNq9PyCwYuwTVdPLwJqyhyj0ykiw
         de3fgX6u1hoyRouF3bQlIzXM/nwlkb+bdEcMxKFmC8ZsbigLYNfaVzCLYpF/WsMgRbCw
         2MxkqYuaInadd5M5YFItyx8mUADmcX+6OUBv8ABC4NEyfuxfDyeOH3ec4j83vPRFG0MZ
         wGS3/NopxqJjK3fwM6o0EHmuzi+9zlTxHTqyVGJP3tRLtukYb+yYtjNtwzjP40TW0UQU
         tvItzv3WWxOgdWZZ6CXH2lYzYhcSA0vW9puYJzvxD9auckdeTeuol510U/R46YT2d8xO
         kzAQ==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;
        h=list-id:precedence:sender:content-transfer-encoding:mime-version
         :user-agent:references:in-reply-to:message-id:date:subject:cc:to
         :from:dkim-signature;
        bh=Cilkn3QOKAYfRI7spLDZiqQIdABPjz4sbfR7JcPNODM=;
        b=GZ5Zwbhi3A4uwxqcTLttuP3EwyRov+U3LvB1EgrafJja4xOUg13xupCHwvTO4tJ9cA
         bmfbO69eyUOzBYyihzJw0iZ1JLrY9HXpWkp1lC45ACn4BIakMsR21lnq5ovU0mufIn1a
         SGGI6J2NG8qII8lD4Eb1CZqph7keuWrk0UBOIcVgJsX3M+9eazlDffV/UGyxYmUvgZvi
         dpdSbjZ2cSFn4rxidPi3Xs1MF4XUAyMjMPb8Bqb0RT/aHoeMmd5kPYgAqAF+WvQKlNp/
         MOjANaWpdSTBvjox+V7PSoqbeSPONKeksVP1acyWdSeO0ISD2hlToqeYBH93P5JVvPdk
         kGXQ==
ARC-Authentication-Results: i=1; mx.google.com;
       dkim=pass header.i=@kernel.org header.s=default header.b=oYvziUZ2;
       spf=pass (google.com: best guess record for domain of linux-kernel-owner@vger.kernel.org designates 209.132.180.67 as permitted sender) smtp.mailfrom=linux-kernel-owner@vger.kernel.org
Received: from vger.kernel.org (vger.kernel.org. [209.132.180.67])
        by mx.google.com with ESMTP id 188-v6si15602737pfa.199.2018.11.11.16.06.13;
        Sun, 11 Nov 2018 16:06:27 -0800 (PST)
Received-SPF: pass (google.com: best guess record for domain of linux-kernel-owner@vger.kernel.org designates 209.132.180.67 as permitted sender) client-ip=209.132.180.67;
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1732225AbeKLJ4a (ORCPT <rfc822;berg.ding@gmail.com> + 99 others);
        Mon, 12 Nov 2018 04:56:30 -0500
Received: from mail.kernel.org ([198.145.29.99]:34152 "EHLO mail.kernel.org"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1730995AbeKLIRl (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 12 Nov 2018 03:17:41 -0500
Received: from localhost (unknown [206.108.79.134])
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
        (No client certificate requested)
        by mail.kernel.org (Postfix) with ESMTPSA id 642D7215EA;
        Sun, 11 Nov 2018 22:27:45 +0000 (UTC)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=kernel.org;
        s=default; t=1541975265;
        bh=+3/qLX+Ss2De3DtbR0bXT6jcS+jBws7MwoA5xftZ0jI=;
        h=From:To:Cc:Subject:Date:In-Reply-To:References:From;
        b=oYvziUZ27aGxYNdRaDJvsgFg/XW3Ryyre8FkY4aVs7Fi87IoLHowMziDXydipfcvS
         2tRsQjUIpzQmU7VL2RpnQYMSDrz0MOqG5K9MZ2b8UygErcskFFBwDWzc1DAJA9gNQG
         +SbUBwxfQzlBU2dsaP22IYGKuI5/bR5Y7uiz0Ri4=
From: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
To: linux-kernel@vger.kernel.org
Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>,
        stable@vger.kernel.org, Evan Green <evgreen@chromium.org>,
        Douglas Anderson <dianders@chromium.org>,
        Stephen Boyd <swboyd@chromium.org>,
        "Martin K. Petersen" <martin.petersen@oracle.com>,
        Sasha Levin <sashal@kernel.org>
Subject: [PATCH 4.19 138/361] scsi: ufs: Schedule clk gating work on correct queue
Date: Sun, 11 Nov 2018 14:18:05 -0800
Message-Id: <20181111221639.842633609@linuxfoundation.org>
X-Mailer: git-send-email 2.19.1
In-Reply-To: <20181111221619.915519183@linuxfoundation.org>
References: <20181111221619.915519183@linuxfoundation.org>
User-Agent: quilt/0.65
X-stable: review
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
Sender: liker.xu+caf_=xuliker=zju.edu.cn@gmail.com
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-CM-TRANSID: AQAAfwCXEE0ExOhbRMUuAA--.6702S3
Authentication-Results: mail-app2; spf=pass smtp.mail=liker.xu+caf_=xu
	liker=zju.edu.cn@gmail.com;
X-Coremail-Antispam: 1UD129KBjvJXoWxWr4UuF1fKr1rWF45Xw43KFg_yoW5uFW5pF
	yfuw1akr4ktr48XrWktr4UWr93Wa1DX3W7GF93Zw1Fya1rKFnFq3s7tFZYgFWDArZ3Xw47
	ZanFgr4jga4qkrUanT9S1TB71UUUUU7qnTZGkaVYY2UrUUUUjbIjqfuFe4nvWSU8nxnvy2
	9KBjDU0xBIdaVrnRJUUUPIb7Iv0xC_KF4lb4IE77IF4wAFF20E14v26r1j6r4UM7CIcVAF
	z4kK6r1j6r18M28lY4IEw2IIxxk0rwA2F7IY1VAKz4vEj48ve4kI8wA2z4x0Y4vE2Ix0cI
	8IcVAFwI0_tr0E3s1l84ACjcxK6xIIjxv20xvEc7CjxVAFwI0_Gr1j6F4UJwA2z4x0Y4vE
	x4A2jsIE14v26rxl6s0DM28EF7xvwVC2z280aVCY1x0267AKxVW0oVCq3wAS0I0E0xvYzx
	vE52x082IY62kv0487Mc02F40EFcxC0VAKzVAqx4xG6I80ewAv7VC0I7IYx2IY67AKxVWU
	AVWUtwAv7VC2z280aVAFwI0_Gr0_Cr1lOx8S6xCaFVCjc4AY6r1j6r4UM4x0Y48IcxkI7V
	AKI48JMx02cVCv0xWlc7CjxVAKzI0EY4vE52x082I5MxkFs20EY4vE44CYbxCE4x80FwCY
	02Avz4vEIxC_twCY0x0Ix7I2Y4AK64vIr41lcIIF0xvE2Ix0cI8IcVAFwI0_tr0E3s1lcI
	IF0xvE2Ix0cI8IcVCY1x0267AKxVW8Jr0_Cr1UMxvI42IY6I8E87Iv67AKxVW0oVCq3wCY
	IxAIcVC2z280aVCY1x0267AKxVW0oVCq3wCF04k20xvY0x0EwIxGrwCF04k20xvEw4C26c
	xK6c8Ij28IcwCF72vE77IF4wCFx2IqxVCFs4IE7xkEbVWUJVW8JwC20s026c02F40E14v2
	6r1j6r18MI8I3I0E7480Y4vE14v26r106r1rMI8E67AF67kF1VAFwI0_Jw0_GFylIxkGc2
	Ij64vIr41lIxAIcVCF04k26cxKx2IYs7xG6r1I6r4UYxBIdaVFxhVjvjDU0xZFpf9x07b5
	XdbUUUUU=

4.19-stable review patch.  If anyone has any objections, please let me know.

------------------

From: Evan Green <evgreen@chromium.org>

[ Upstream commit f4bb7704699beee9edfbee875daa9089c86cf724 ]

With commit 10e5e37581fc ("scsi: ufs: Add clock ungating to a separate
workqueue"), clock gating work was moved to a separate work queue with
WQ_MEM_RECLAIM set, since clock gating could occur from a memory reclaim
context. Unfortunately, clk_gating.gate_work was left queued via
schedule_delayed_work, which is a system workqueue that does not have
WQ_MEM_RECLAIM set.  Because ufshcd_ungate_work attempts to cancel
gate_work, the following warning appears:

[   14.174170] workqueue: WQ_MEM_RECLAIM ufs_clk_gating_0:ufshcd_ungate_work is flushing !WQ_MEM_RECLAIM events:ufshcd_gate_work
[   14.174179] WARNING: CPU: 4 PID: 173 at kernel/workqueue.c:2440 check_flush_dependency+0x110/0x118
[   14.205725] CPU: 4 PID: 173 Comm: kworker/u16:3 Not tainted 4.14.68 #1
[   14.212437] Hardware name: Google Cheza (rev1) (DT)
[   14.217459] Workqueue: ufs_clk_gating_0 ufshcd_ungate_work
[   14.223107] task: ffffffc0f6a40080 task.stack: ffffff800a490000
[   14.229195] PC is at check_flush_dependency+0x110/0x118
[   14.234569] LR is at check_flush_dependency+0x110/0x118
[   14.239944] pc : [<ffffff80080cad14>] lr : [<ffffff80080cad14>] pstate: 60c001c9
[   14.333050] Call trace:
[   14.427767] [<ffffff80080cad14>] check_flush_dependency+0x110/0x118
[   14.434219] [<ffffff80080cafec>] start_flush_work+0xac/0x1fc
[   14.440046] [<ffffff80080caeec>] flush_work+0x40/0x94
[   14.445246] [<ffffff80080cb288>] __cancel_work_timer+0x11c/0x1b8
[   14.451433] [<ffffff80080cb4b8>] cancel_delayed_work_sync+0x20/0x30
[   14.457886] [<ffffff80085b9294>] ufshcd_ungate_work+0x24/0xd0
[   14.463800] [<ffffff80080cfb04>] process_one_work+0x32c/0x690
[   14.469713] [<ffffff80080d0154>] worker_thread+0x218/0x338
[   14.475361] [<ffffff80080d527c>] kthread+0x120/0x130
[   14.480470] [<ffffff8008084814>] ret_from_fork+0x10/0x18

The simple solution is to put the gate_work on the same WQ_MEM_RECLAIM
work queue as the ungate_work.

Fixes: 10e5e37581fc ("scsi: ufs: Add clock ungating to a separate workqueue")
Signed-off-by: Evan Green <evgreen@chromium.org>
Reviewed-by: Douglas Anderson <dianders@chromium.org>
Reviewed-by: Stephen Boyd <swboyd@chromium.org>
Signed-off-by: Martin K. Petersen <martin.petersen@oracle.com>
Signed-off-by: Sasha Levin <sashal@kernel.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
---
 drivers/scsi/ufs/ufshcd.c |    5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

--- a/drivers/scsi/ufs/ufshcd.c
+++ b/drivers/scsi/ufs/ufshcd.c
@@ -1691,8 +1691,9 @@ static void __ufshcd_release(struct ufs_
 
 	hba->clk_gating.state = REQ_CLKS_OFF;
 	trace_ufshcd_clk_gating(dev_name(hba->dev), hba->clk_gating.state);
-	schedule_delayed_work(&hba->clk_gating.gate_work,
-			msecs_to_jiffies(hba->clk_gating.delay_ms));
+	queue_delayed_work(hba->clk_gating.clk_gating_workq,
+			   &hba->clk_gating.gate_work,
+			   msecs_to_jiffies(hba->clk_gating.delay_ms));
 }
 
 void ufshcd_release(struct ufs_hba *hba)

