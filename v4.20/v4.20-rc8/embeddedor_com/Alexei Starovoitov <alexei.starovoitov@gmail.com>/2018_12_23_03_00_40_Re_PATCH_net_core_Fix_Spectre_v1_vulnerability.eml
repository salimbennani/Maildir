Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by i7-8700 with POP3-SSL;
  24 Dec 2018 15:59:36 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga005.fm.intel.com (fmsmga005.fm.intel.com [10.253.24.32])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 7B252580522;
	Sat, 22 Dec 2018 19:00:49 -0800 (PST)
Received: from fmsmga103.fm.intel.com ([10.1.193.90])
  by fmsmga005-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 22 Dec 2018 19:00:49 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3A6GjQcBenTZssHLEitMiGBWcXlGMj4u6mDksu8pMi?=
 =?us-ascii?q?zoh2WeGdxc6/ZBGN2/xhgRfzUJnB7Loc0qyK6/CmATRIyK3CmUhKSIZLWR4BhJ?=
 =?us-ascii?q?detC0bK+nBN3fGKuX3ZTcxBsVIWQwt1Xi6NU9IBJS2PAWK8TW94jEIBxrwKxd+?=
 =?us-ascii?q?KPjrFY7OlcS30P2594HObwlSizexfbB/IA+qoQnNq8IbnZZsJqEtxxXTv3BGYf?=
 =?us-ascii?q?5WxWRmJVKSmxbz+MK994N9/ipTpvws6ddOXb31cKokQ7NYCi8mM30u683wqRbD?=
 =?us-ascii?q?VwqP6WACXWgQjxFFHhLK7BD+Xpf2ryv6qu9w0zSUMMHqUbw5Xymp4rx1QxH0li?=
 =?us-ascii?q?gIKz858HnWisNuiqJbvAmhrAF7z4LNfY2ZKOZycqbbcNgHR2ROQ9xRWjRPDI28?=
 =?us-ascii?q?cYUBEukPPehXoIbhulQBrxWxBRK0BO7t0TJImmP60Lcm3+g9CwzKwgotFM8Ovn?=
 =?us-ascii?q?TOq9X1Mb8fXPyxzKbWwjTMcfJW0irg5ojUaB8hu/aMXax3ccrQ1UkvEB3FhUiX?=
 =?us-ascii?q?pIP/OzOayOsMvHaa7+Z6TuKvl3Qoqxt2ojixwccsi5XJhoULyl3f+iV5xZw6Jd?=
 =?us-ascii?q?y8SEJhfdGkF55QujicOoBrTM0iRGRotzw7yr0AoZO7eTIFyI47yBLFavyHdYaI?=
 =?us-ascii?q?4hXlWe2MIjl4nGpodKyjixu260Ss1+PxWteu3FpXrSdJjsPAu3EP2hDL9MSKS+?=
 =?us-ascii?q?Vx8luk1DqSywzc9+RJLlwomaffN5Isx6M8m5kPvUnGGyL6hUD7ga2Xe0o6++Wl?=
 =?us-ascii?q?7fnsbK/8qZ+GLYB0jxnzMqQwlcy7BuQ1KhYOX2eF9uSmzrHj/lP2QK9MjvIolq?=
 =?us-ascii?q?nVqpfaJd4UpqKhAg9V1Jgs6wqnAju4zNgVmWMLIE9LdR6ZlYTlJlLDLOziAfq+?=
 =?us-ascii?q?gVmgiDJryOrHPr3lDJXNNH/DkLL5cLZ56k5czhczzN9G65JXFL4BOvTzVVH1tN?=
 =?us-ascii?q?DBCR84PQq0zPj9CNhmyIMeVnyAArWDPKPRr1CI/OQvLPeIZIMPvzb9Mfcl6+b0?=
 =?us-ascii?q?jXAlgV8dYbWp3ZwPZXC8H/RmIFuWbWDjg9ccCmoKugs+TOr3iFyNSzJTZnCyX7?=
 =?us-ascii?q?4i6TE/Eo6pEYDDRoW1irybwCi7BoFWZnxBCl2UEXfnbYSEW+sWZyKVOMNhkiEE?=
 =?us-ascii?q?WqKnS48uzhyusA76y7x6Luvb4CEYtJTj1MRr6O3Xjx096Tt0D8GF2WGXU250hn?=
 =?us-ascii?q?8IRyMx3K1nu0N90VeD0a97g/BCD9xc/fFJXxw+NZ7dyex6Ft/zVhjAftePVFap?=
 =?us-ascii?q?XNGmDSstQdI2xt8Ee1x9FMm6jhDfwyqqBKcYl7+RC5wy6K7c23nxKNx7y3bJz6?=
 =?us-ascii?q?Qhi1gmQs1SNWypnKJ/9g7TB5LXnEWdjaqlaaMc3CvV/meZ0WWOpF1YUBJ3Uajd?=
 =?us-ascii?q?QH8QfFXWosrj6kPCVbCuD68nPRVHycKFLqtKadjpjVFdSffnOdTeZX+xmmiqCR?=
 =?us-ascii?q?aJwLOMcJTle2EH0CrBD0gElhgZ/WyaOggmGiehv2XeASRzGl31fUPj7/NyqHOh?=
 =?us-ascii?q?QU8y1AGFcUth2qGx+h4Ug/ycVvwS0qgFuCcntzV7AlK908jKBNqHogprZL9cbs?=
 =?us-ascii?q?8l4FdbyWLZsBRwPoChL6BngV4ebwR3vkP02xVrEIlAltIqrHcrzAp0JqKVy1dB?=
 =?us-ascii?q?dzKe3ZDtNbzbMGjy/Baza6HI3lHSysqZ+qAK6P4gsVXsoBmpFlY+83Vgy9RayX?=
 =?us-ascii?q?+c6YvFDQUMUZP9SF049wVnqL7AZCk95ITU1WN3PKmwsz/C3c8pBeQ/xhaheddf?=
 =?us-ascii?q?LL2LFAvoH8IGAMiuLfQgm0K1YRIcIOBS6Kk0MtumdvubwqKkIPxsnTOmjWtd5o?=
 =?us-ascii?q?B93VmB9y59Su7OwpYEzOuU3gqBVzfgklihttr7lpxDZTEXBmC/0zTrBJZNZq1u?=
 =?us-ascii?q?eoYGEX2uI8yrydpknZ7iRnlY+ESlB1wYws+peAOeYEDn0g1UyEsYv2anmSy+zz?=
 =?us-ascii?q?FvlzEpr6yf3DHBwuj4dRoHPHJLS3dmjVv2PYe0iNUaVlCybwc1jBul+Vr6x69D?=
 =?us-ascii?q?qaV/LmnfW0dJczLtL2F/VKu9rb6CY89J6JM1viRbSuW8YVaGSrHjpxsWyT/sH2?=
 =?us-ascii?q?xbxDojbTGlpo35nwBmiGKaNHtzrmDWedtzxRfc49zQX+VR0SAFRCl7iDnXAEaz?=
 =?us-ascii?q?P9+y8NWQlpfDtP2+Vm27Wp1Sdynr0Z2PtC+h6WJ2Bh2/mui5msf7HggizS/7y9?=
 =?us-ascii?q?5qWD3IrRnmZYnnzaa6MeNhfkRzAF/86sx6Gpxxk4cqhZEQ32QaiYuR/XYdjWjz?=
 =?us-ascii?q?NtBb07rkbHURXT4L38LV4A/91U1gNH2Jxpj1VnWAwsR7Ydm6bXgb2iY878BMFa?=
 =?us-ascii?q?eV46ZInSpzolqksw3RZeJxkSsayfsr8HQamf0GuBIxziWBBbAfBUxYPS3vlxuS?=
 =?us-ascii?q?9dy/ortYZH2zcbeuzkpxhs6uDKuNogxHXHb5e5EiHTJ/78llMVLM1mHz5Z/geN?=
 =?us-ascii?q?XKcd0TsRiUmQ/aj+dJMJIxiuYKhS1/NGLhun0lzvQ3jB100pG8oYiHMH5t/KOi?=
 =?us-ascii?q?Dx5cNz31Yd4T+z73gaZfmMaWw56gHpF7FjoXW5voSOqiECgOuvT/KwaODDo8p2?=
 =?us-ascii?q?+AFrXFGg+f7Fpmo2jLE5C2LHyXIHgZzdN/RBiSPkBfgQYUXCkkkZ49DAyl2Mvh?=
 =?us-ascii?q?cEJh7DAL+lH4sgdMyv5vNxTnUGfQvgKoZSkvSJSFMBpa9AJC51rWMcyD6OJ8BT?=
 =?us-ascii?q?pY84alrAyMLGybegtJAXsIWkyCG1DsIL2u6cPc/OifA+q0N+HObqmWqexCS/eI?=
 =?us-ascii?q?woqi04th/zaRL8WPI2NtD/sh1kpYWnB5HcvZli4LSywWkSLNcsGaqA29+i1xss?=
 =?us-ascii?q?Cw7vDrVBjz6ouIDrtYKc9v9AyugaefK+6Qgz50KTZG2ZMNxn/Iy7kf0EQRiyF0?=
 =?us-ascii?q?cDmtHqoPtTTQTKLLgaJXCx8bayVuNMpH9a483w9NOdLFhdPxzLJ3kvk1C1JdX1?=
 =?us-ascii?q?z7hs6pfdAKI326NF7fHkmLKa+JJSfVzMD3e6+8TbxQgf5Qtx2xvzabDkDiMi6C?=
 =?us-ascii?q?lznvSxCgL+VMgDuHMxxZvYG3agxtBnT7TNL6dh27N8d6jSE3wb0xnH/FKXQQPi?=
 =?us-ascii?q?R8c0xTqL2d9idYgvR5G2xc4XtpN+iEmyCF7+bGLpYaq+dkAiNxl+hC+nQ116NV?=
 =?us-ascii?q?7D1YRPxygCbTrsRho1ejkumOzDpoSBtPqjZRi4KNskVvIqHZ9phGWXbZ8xMB92?=
 =?us-ascii?q?SQCxIWp9R7Dt3jobxfyt/KlPG7FDAXuf3J5tcVGc+cAYTPCjxpChvtBjeeRF8K?=
 =?us-ascii?q?UCW3PH/Yr0FYmvye+nCZqYJ8oZ/pzskgULheAXUxG+MXCwxeANUYJ4lwXy8jj/?=
 =?us-ascii?q?bPhcoF9Xe/6gLNTd9doJfGSvWMKfrqITedy7JDYk1bkvvDMY0PO9ijiARZYV5g?=
 =?us-ascii?q?kdGPQhKIUA=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AcAADy+R5ch0O0hNFiHAEBAQQBAQcEA?=
 =?us-ascii?q?QGBUwUBAQsBgTCBOYECJ5oeFJdPgXEVAQEYCwgBhzAiNgcNAQMBAQEBAQECARM?=
 =?us-ascii?q?BAQEKCwkIKSMMgjopAYJmAQEBAQMBAjcGARsdAQMCCQEBBQUUAQMJJQMMEgIRA?=
 =?us-ascii?q?QUBHAYTBYMdAYFoAQMVAQQKmkQ8jCsFAReCdwWEMAoZJw1egTcCAQUSils2gRw?=
 =?us-ascii?q?0AYEiP4QjgldHBBiBAYYlApBjkDUzBwKCJQSEaYZnPYMnJIIDh3iHa45agRKKF?=
 =?us-ascii?q?gIEAgQFAgUPIYEsAYIGcIM8E4FtGwwXg0qCWYgbHzKBBQEBiy2CPgEB?=
X-IPAS-Result: =?us-ascii?q?A0AcAADy+R5ch0O0hNFiHAEBAQQBAQcEAQGBUwUBAQsBgTC?=
 =?us-ascii?q?BOYECJ5oeFJdPgXEVAQEYCwgBhzAiNgcNAQMBAQEBAQECARMBAQEKCwkIKSMMg?=
 =?us-ascii?q?jopAYJmAQEBAQMBAjcGARsdAQMCCQEBBQUUAQMJJQMMEgIRAQUBHAYTBYMdAYF?=
 =?us-ascii?q?oAQMVAQQKmkQ8jCsFAReCdwWEMAoZJw1egTcCAQUSils2gRw0AYEiP4QjgldHB?=
 =?us-ascii?q?BiBAYYlApBjkDUzBwKCJQSEaYZnPYMnJIIDh3iHa45agRKKFgIEAgQFAgUPIYE?=
 =?us-ascii?q?sAYIGcIM8E4FtGwwXg0qCWYgbHzKBBQEBiy2CPgEB?=
X-IronPort-AV: E=Sophos;i="5.56,386,1539673200"; 
   d="scan'208";a="57005747"
X-Amp-Result: UNKNOWN
X-Amp-Original-Verdict: FILE UNKNOWN
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 22 Dec 2018 19:00:47 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2393079AbeLWDAp (ORCPT <rfc822;like.xu@linux.intel.com>
        + 22 others); Sat, 22 Dec 2018 22:00:45 -0500
Received: from mail-pl1-f194.google.com ([209.85.214.194]:38757 "EHLO
        mail-pl1-f194.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S2387701AbeLWDAo (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sat, 22 Dec 2018 22:00:44 -0500
Received: by mail-pl1-f194.google.com with SMTP id e5so4253745plb.5;
        Sat, 22 Dec 2018 19:00:44 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=date:from:to:cc:subject:message-id:references:mime-version
         :content-disposition:in-reply-to:user-agent;
        bh=vYa18Rz8NMTPK9foY4G30QJN+CBPDZCSj4oOmObdA88=;
        b=AXfN9+01KI1Fa7BWVwLQrcsp/yIST70GEslQYBYrTwa3cxEPoCbuJfxhO5O3cFUmVR
         Z3UJ5jrZrQ6UFBppdzHq+Pbml/UB08Fk+s5LPpk8LR9pc5KMXgIUfgB35mkxf0XEQHgW
         mIDnnkcHSk4Qb21q9/1zvibcMSjVxKxg3cHyftMCLZwIBAI+SHRSrg2XbeU+WyQxyVVZ
         1BXH5U37YetDhMJLmVRLjUsY7M8q6/pIoGP31bknhC7RojxdXjZbkNd1xeEltv9o2RCl
         LV8hxzNeKo86Tzv8HJ6zfKbndOqyLdAR2OUJck6ImVylb8qInt5rQJljVb7pMWEbUDXN
         2F9w==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:date:from:to:cc:subject:message-id:references
         :mime-version:content-disposition:in-reply-to:user-agent;
        bh=vYa18Rz8NMTPK9foY4G30QJN+CBPDZCSj4oOmObdA88=;
        b=YDnKS+/iv5iANDb5qIHf2qdN67zNwBrQYBtv+Qwcm+AzRrTTyEy1xfZ+IAQAwsxh9+
         YSkOH5JWj+ZPGwVRiZxQ+x45d/siDG6Iuxzfo1m8QqyHo27lzOM6+KnJAJ4vTP6d4L+4
         DPTo7V7jq+4kKK4UOEDHrEhjdN1tCe1oi8o3MyPTCnQbQmv3iqOiNmbi4kCFbKjQVoAH
         QDHX831U7SpF+odt6dggJULgMRxLJTDx+5s5BOfW9W3FC/yjYK/637HXm4PaI1kf7Yzr
         x5ZQ1sYTcD2pJ1ijLi72G40k7xeVnL8t0oPIwt+iLviGLZDzgG1qOJMiugyyOgLGy2Qr
         O2aw==
X-Gm-Message-State: AJcUukdoBYPOsVLcQJdbXGhOLutwuOh65HMgyiFf6hhRkINBsxAPKR0Z
        Gx92QR4MNSA1pQW1wmCL12Y=
X-Google-Smtp-Source: ALg8bN6AC2EOkWSXKnpdfM7mhS5CMoc7rEnh0E9Hw6bE9QMgbFpLhU2oBDCdWk51hK1rxDeBpkYeYQ==
X-Received: by 2002:a17:902:bf44:: with SMTP id u4mr8464740pls.5.1545534043415;
        Sat, 22 Dec 2018 19:00:43 -0800 (PST)
Received: from ast-mbp.dhcp.thefacebook.com ([2620:10d:c090:180::1:76e6])
        by smtp.gmail.com with ESMTPSA id g136sm40091600pfb.154.2018.12.22.19.00.41
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Sat, 22 Dec 2018 19:00:42 -0800 (PST)
Date: Sat, 22 Dec 2018 19:00:40 -0800
From: Alexei Starovoitov <alexei.starovoitov@gmail.com>
To: "Gustavo A. R. Silva" <gustavo@embeddedor.com>
Cc: David Miller <davem@davemloft.net>, ast@kernel.org,
        daniel@iogearbox.net, netdev@vger.kernel.org,
        linux-kernel@vger.kernel.org
Subject: Re: [PATCH] net: core: Fix Spectre v1 vulnerability
Message-ID: <20181223030039.wrpytx7pwfcljdjm@ast-mbp.dhcp.thefacebook.com>
References: <20181221204901.GA30045@embeddedor>
 <20181222.150722.1493687829239836271.davem@davemloft.net>
 <20181222235952.keue7a336sg7jfim@ast-mbp.dhcp.thefacebook.com>
 <20181222.184051.718127928973898182.davem@davemloft.net>
 <e1c8e69b-3417-6176-6b49-1b7a23febb21@embeddedor.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <e1c8e69b-3417-6176-6b49-1b7a23febb21@embeddedor.com>
User-Agent: NeoMutt/20180223
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Sat, Dec 22, 2018 at 08:53:40PM -0600, Gustavo A. R. Silva wrote:
> Hi,
> 
> On 12/22/18 8:40 PM, David Miller wrote:
> > From: Alexei Starovoitov <alexei.starovoitov@gmail.com>
> > Date: Sat, 22 Dec 2018 15:59:54 -0800
> > 
> > > On Sat, Dec 22, 2018 at 03:07:22PM -0800, David Miller wrote:
> > > > From: "Gustavo A. R. Silva" <gustavo@embeddedor.com>
> > > > Date: Fri, 21 Dec 2018 14:49:01 -0600
> > > > 
> > > > > flen is indirectly controlled by user-space, hence leading to
> > > > > a potential exploitation of the Spectre variant 1 vulnerability.
> > > > > 
> > > > > This issue was detected with the help of Smatch:
> > > > > 
> > > > > net/core/filter.c:1101 bpf_check_classic() warn: potential spectre issue 'filter' [w]
> > > > > 
> > > > > Fix this by sanitizing flen before using it to index filter at line 1101:
> > > > > 
> > > > > 	switch (filter[flen - 1].code) {
> > > > > 
> > > > > and through pc at line 1040:
> > > > > 	
> > > > > 	const struct sock_filter *ftest = &filter[pc];
> > > > > 
> > > > > Notice that given that speculation windows are large, the policy is
> > > > > to kill the speculation on the first load and not worry if it can be
> > > > > completed with a dependent load/store [1].
> > > > > 
> > > > > [1] https://marc.info/?l=linux-kernel&m=152449131114778&w=2
> > > > > 
> > > > > Signed-off-by: Gustavo A. R. Silva <gustavo@embeddedor.com>
> > > > 
> > > > BPF folks, I'll take this directly.
> > > > 
> > > > Applied and queued up for -stable, thanks.
> > > 
> > > hmm. what was the rush?
> > > I think it is unnecessary change.
> > > Though fp is passed initially from user space
> > > it's copied into kernel struct first.
> > > There is no way user space can force kernel to mispredict
> > > branch in for (pc = 0; pc < flen; pc++) loop.
> The following piece of code is the one that can be mispredicted, not the for
> loop:
> 
> 1013         if (flen == 0 || flen > BPF_MAXINSNS)
> 1014                 return false;
> 
> Instead of calling array_index_nospec() inside bpf_check_basics_ok(), I
> decided to place the call close to the code that could be compromised. This
> is when accessing filter[].

Why do you think it can be mispredicted?

I've looked at your other patch for nfc_sock_create() where you're adding:
+ proto = array_index_nospec(proto, NFC_SOCKPROTO_MAX);

'proto' is the value passed in _register_ into system call.
There is no need to wrap it with array_index_nospec().
It's not a load from memory and user space cannot make it slow.
Slow load is a necessary attribute to trigger speculative execution
into mispredicted branch.

What tool did you use to analyze this?
Did you analyze all warnings case by case or just trusted the tool
and generated these patches?

