Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by i7-8700 with POP3-SSL;
  24 Dec 2018 16:01:30 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga004.fm.intel.com (fmsmga004.fm.intel.com [10.253.24.48])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 47B58580522;
	Sun, 23 Dec 2018 11:14:46 -0800 (PST)
Received: from orsmga102-1.jf.intel.com (HELO mga09.intel.com) ([10.7.208.27])
  by fmsmga004-1.fm.intel.com with ESMTP; 23 Dec 2018 11:14:45 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3ApHMe+hILyf8He323f9mcpTZWNBhigK39O0sv0rFi?=
 =?us-ascii?q?tYgUL//+rarrMEGX3/hxlliBBdydt6oUzbKO+4nbGkU4qa6bt34DdJEeHzQksu?=
 =?us-ascii?q?4x2zIaPcieFEfgJ+TrZSFpVO5LVVti4m3peRMNQJW2aFLduGC94iAPERvjKwV1?=
 =?us-ascii?q?Ov71GonPhMiryuy+4ZLebxlLiTanfb9+MAi9oBnMuMURnYZsMLs6xAHTontPde?=
 =?us-ascii?q?RWxGdoKkyWkh3h+Mq+/4Nt/jpJtf45+MFOTav1f6IjTbxFFzsmKHw65NfqtRbY?=
 =?us-ascii?q?UwSC4GYXX3gMnRpJBwjF6wz6Xov0vyDnuOdxxDWWMMvrRr0vRz+s87lkRwPpiC?=
 =?us-ascii?q?cfNj427mfXitBrjKlGpB6tvgFzz5LIbI2QMvd1Y6HTcs4ARWdZQ8hfSSJBDIO/?=
 =?us-ascii?q?YYUBAeUOMuRXoJXyqVsVtRuzBxKhBP/txzJSmnP6waM33uYnHArb3AIgBdUOsH?=
 =?us-ascii?q?HModvsMKcSUP61w7fSzT7ebf1Zwy396JTLchAmufGMRa97fM3KyUkoCwzFjUuf?=
 =?us-ascii?q?qZD5MDyP0OQAqGib4PB6VeKziG4nrBlxoiC1yscqlIbJmpsYx1bZ/it3x4Y1IM?=
 =?us-ascii?q?e3SE99YdO8FZtfrTuaOJdsTsMjRWFotiE6x7sbspC4ZCgH0IorywLbZvCdboSF?=
 =?us-ascii?q?7AzvWPyMLTp7mH5pYrOyihSq/UWjyuDwTNe43EtKoyZfjNXBtnAA2wbN5sWHTP?=
 =?us-ascii?q?Z2412v1iyV1w/J7+FJOUA0mrTfK54m2rMwiJUTvlrZHiPsm0X5krWWdkM69eis?=
 =?us-ascii?q?8ejnZa/mppCEO491jAHxLLgul9ShDegkNgUCRXWX9Oqi2LH54EH0Q6lGguc3n6?=
 =?us-ascii?q?TbqJzaIN4Upq+9Aw9byIYj7BO/Ai+i0NQZm3kHMV1EdAuEj4f3IVHOJu73DfOm?=
 =?us-ascii?q?j1SrnjZrwe7JPqf6D5XTIXjMjq3hcax+60FC0gozy85Q55ZOBrEGOvLzVVf9tM?=
 =?us-ascii?q?bEAR8hLwy03+HnBc151oMfWmKAHLWVMazPsVKT4uIvIu+MZJIauTrnKvgl4eLu?=
 =?us-ascii?q?gmE9mVMHYaap2p4XYmiiHvt6O0WZfWbsgtAZHGcKpAU+TfDqh0eFUTJJZ3ayQr?=
 =?us-ascii?q?gz5jc0CI+9CYfDR4atgKGO3SuhH51WYHxGBU6IEXvya4qEXPIMYjqIIsB9ijwE?=
 =?us-ascii?q?SaShS4g52B60rw/6y71nLunO9i0Cr53j1sN45+nSlRE06Dx1AN6R02CLT2FogG?=
 =?us-ascii?q?wIQyU607x4oUx40l2Dy7R3g+REFdxP4PNESgQ6OoTaz+BgD9DyWxjOftGGSFu9?=
 =?us-ascii?q?RtWmADcxTs8+wtMUYkZ9HcmigQ7H3yawH7AVkLmLDoQu8q3Ax3jxO9p9y3He2a?=
 =?us-ascii?q?Y8lVYmXNVAOXemhqFl8QjTHJDGk0Oem6audqQc2SrN+XyHzWqPukFYTQFxXb/E?=
 =?us-ascii?q?XXAZekvZs9D56lneQL+pDLQtKhFBxtKaKqtWdt3pik1LS+r5N9TAfW29gWewCg?=
 =?us-ascii?q?yOxrOXcoXqfX4Q3CHcCEgCjgAS8myKNQk4Bie9vW3eCCZiGk7oY0Pp6eN+sm+0?=
 =?us-ascii?q?TlcozwGWaE1sz6a1+h8QhfybV/MT3rIFtD09qzluG1a9xdbWC9uGpwpuZ6hcZd?=
 =?us-ascii?q?I94FFa1WPWrQB9P5qgL7x8iV4aaQh4o0Tu1xBvAIVajccqtG8qzBZ1Ka+AylxB?=
 =?us-ascii?q?cy2X3J/uNbzXMGX95w2vZLPM1VHY09aW/bkP5e88q1XiugGpC0Uj/29m09lTz3?=
 =?us-ascii?q?uT+JHKABAOXpL2V0Y97wJ6qK3CYikh+4PU0mVhMKmpsjPYx90lHuokyha6cNdZ?=
 =?us-ascii?q?P6OJDwvyE8wcB8izJ+0mgVmpbhQYPO9M8K44Jd+pd/yD2KSzJuZvgCqmjXhb4I?=
 =?us-ascii?q?B6yk+M7St8RfLS0JYf3v6Y2RGLVzHig1e7s8D7gJxLaisWHmWi1yfkHolRZqtp?=
 =?us-ascii?q?cIYPCGeuJdC3x9pki57sXX5Y6ECsB1cc1MC1fhqSakT33RdM2kQPvXynhSy4wi?=
 =?us-ascii?q?R0kjEotKae3DbCw///dBoBIWNLQGhijVHxIYm7ldwaXU6obxQ3mxuh/0r1269b?=
 =?us-ascii?q?pKFnJWnJXUhIZzT2L31lUqaotLqNedRP6JArsSVQSui8ekqVSr3+oxsb1SPsAW?=
 =?us-ascii?q?1eySs/dzGrvJX5ghN7hHicLHZ1sHrWZ8VwyQ3D69zbQP5bxiAGSzVgiTnLGli8?=
 =?us-ascii?q?OMGk/NWOmJfEqOy+VWOhVptIfCnvzIOAsja75GJwDR2+mfCzhsPoEQwg3SDn0N?=
 =?us-ascii?q?lqUD3CrAzgbYnzy6S6LeVnc1FrBFDm6sp2AIF+kpYqi5EW1ngXnZGV/XsBkWfu?=
 =?us-ascii?q?PtRXw6P+bHwRRTEVx97Z+hTq2EpmLniR3YL2Sm2dwtd9Z9m9em4W3yM978NQB6?=
 =?us-ascii?q?uO4r1LgzB1okamogLLevdygC0dyfQ15X4eguEJvhctzyqHDrATG0lYITLjlxCS?=
 =?us-ascii?q?49+iq6VXYX6lcaKs20pmgdChELaCrxlAWHb+f5cuBy5x4d95MFLRy33z8YDkdc?=
 =?us-ascii?q?LUbdISsB2UjhjBg/JUKJI3ivoFmy5nNXjhsn0izu4xlQZu0o2ivIibN2Vt+7q0?=
 =?us-ascii?q?DQVCOT3yY8MT5yvhjaJDnsuN24CvH5NhGigEXZfyTPKoFi4SuurjNwqUDDI8rX?=
 =?us-ascii?q?KbE6LFHQCD8Edms27PE5ezOnGVPnYZyMttRAKHKExDmgwUXyg6np0kFgCs3sPh?=
 =?us-ascii?q?a1x05jQQ5l7+txtNxfhkNxj5UmfDugiobi04R4SYLBpT9gtC/VvaMdSC7uJvGC?=
 =?us-ascii?q?FV5p2grAuQKmyCegRHF2cJVlafB1DkOLmu6sLN8+yZBuq4MvvPbq+Cqe1YV/eU?=
 =?us-ascii?q?252v1pFq8CqLNsWKJnNiFeE02lJfXXBlHMTUgzUPRDIWlyLObM6bpQ2w+i5trs?=
 =?us-ascii?q?C4//TkRhjv5ZaUC7ZJNdVv+ha2gbqMNuKKhSZ5LypY2Y0IxXPS1Lcf21sSgTl0?=
 =?us-ascii?q?dzaxCbQAqTLNTKXIl6BNEh4UcDlzO9VI7q4m2glNONXWitf01r5+k/40BE1JVV?=
 =?us-ascii?q?3nmsG1e8MKJ3uxO0/ABEaOLL6GPyHEw9nrYaOgTr1dlPlUtxy1uTqBD0DvJCiM?=
 =?us-ascii?q?lzn3WBCpKuxMiCCbPBpDuICyaBptCG7jTM74ZR2/KtN4kTo2wbgsjHPQKWEcKS?=
 =?us-ascii?q?R8c19KrrCI7SJXmPN/G2lA7npjNeaFmiaZ4PPeKpYZqvZrBiV0l+RH4HU10bdV?=
 =?us-ascii?q?7SdEROBrlyvWtNJhv1amkuzcggZgBVBhty1XjZyM9WwkcZ+fvqJBXWjNtlpZ4n?=
 =?us-ascii?q?iLFx0UoPNoD9fit6xdxt/V0qn0LWEGu/fd58BUJMzZKcSKdVA8PRbkUGrRDw8t?=
 =?us-ascii?q?VTOtOnzDnUtbkeHU+nDD6tBwhpHymZZGcfkTcV0xEv4AQAwxENUcLZJfUjo6nL?=
 =?us-ascii?q?ufi8AUo3yzsE+Cat9du8XgUvOMDO+nCD+DkbpDfwNAlaj/JoceKoby3WRiY0Nm?=
 =?us-ascii?q?n4PSAwzWUMwb8X4pVRM9vEgYqCs2dWY0wU+wL1r1uHI=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ACAACL3R9ch0O0hNFiGgEBAQEBAgEBA?=
 =?us-ascii?q?QEHAgEBAQGBUQUBAQEBCwGCaYECJ4N+iBmLeIFgLRSXT4FuGhgLCAGHMCI0CQ0?=
 =?us-ascii?q?BAwEBAQEBAQIBEwEBAQoLCQgpIwyCOikBgmcBAgMBAiAVCAEBKQ4BBQkBAQoYA?=
 =?us-ascii?q?gImAgIDVAYBDAYCAQEBgx0BggEEAQqkdnCBL4J2AQEFgkOEVAMFgQuLNBeBf4E?=
 =?us-ascii?q?4gmuDHgQYhE+CV5AuhXyLIwmHEoZng2oeggOHeAwFh1otiSyFAYtPgUaCDk0ug?=
 =?us-ascii?q?zETgW0bhkaCAIV7PgEygQUBAY0mAQE?=
X-IPAS-Result: =?us-ascii?q?A0ACAACL3R9ch0O0hNFiGgEBAQEBAgEBAQEHAgEBAQGBUQU?=
 =?us-ascii?q?BAQEBCwGCaYECJ4N+iBmLeIFgLRSXT4FuGhgLCAGHMCI0CQ0BAwEBAQEBAQIBE?=
 =?us-ascii?q?wEBAQoLCQgpIwyCOikBgmcBAgMBAiAVCAEBKQ4BBQkBAQoYAgImAgIDVAYBDAY?=
 =?us-ascii?q?CAQEBgx0BggEEAQqkdnCBL4J2AQEFgkOEVAMFgQuLNBeBf4E4gmuDHgQYhE+CV?=
 =?us-ascii?q?5AuhXyLIwmHEoZng2oeggOHeAwFh1otiSyFAYtPgUaCDk0ugzETgW0bhkaCAIV?=
 =?us-ascii?q?7PgEygQUBAY0mAQE?=
X-IronPort-AV: E=Sophos;i="5.56,388,1539673200"; 
   d="scan'208";a="58650935"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 23 Dec 2018 11:14:43 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1725836AbeLWTOd (ORCPT <rfc822;like.xu@linux.intel.com>
        + 22 others); Sun, 23 Dec 2018 14:14:33 -0500
Received: from mo4-p00-ob.smtp.rzone.de ([85.215.255.25]:18928 "EHLO
        mo4-p00-ob.smtp.rzone.de" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1725308AbeLWTOc (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sun, 23 Dec 2018 14:14:32 -0500
X-Greylist: delayed 538 seconds by postgrey-1.27 at vger.kernel.org; Sun, 23 Dec 2018 14:14:31 EST
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; t=1545592470;
        s=strato-dkim-0002; d=hartkopp.net;
        h=In-Reply-To:Date:Message-ID:From:References:Cc:To:Subject:
        X-RZG-CLASS-ID:X-RZG-AUTH:From:Subject:Sender;
        bh=E8sMHdpZ56bdbaNqESoFKn20Q1s8hoTdAcM2MB+qsRo=;
        b=pbGyShBEluBSCnavpXuHnB6h+XQhfX4k5LWb3gzzS/L9cgVvQmmatR0KJeHLWRQAZy
        LJ4Xzn+1C0NKBIlh6xg58+zBisd02XgMynKrIrx8J+VZND6p3aTSTTi1BX7QKovirkM4
        WoeKe6+zxtUhJLNahvI4lQCm+dLQKxdjvnVk+8gSuaMd//9eldJdQTyAjedNoor7OKY9
        cbtUgENskSft7BFxOCDKeArITS7tG47O8tVBVRYvU/G+IzsyIX1jtpAhuNcrGayFckgX
        hi5g9SOweBuCvh9/nw/zwSIS2EaPLoAcgsy9ne7Yam0f9f+z7giQ39lh6biRp71qeY9t
        zEQg==
X-RZG-AUTH: ":P2MHfkW8eP4Mre39l357AZT/I7AY/7nT2yrDxb8mjG14FZxedJy6qgO1q3DbdV+MXxxxQl9RzJU="
X-RZG-CLASS-ID: mo00
Received: from [172.20.10.3]
        by smtp.strato.de (RZmta 44.8 DYNA|AUTH)
        with ESMTPSA id L0b8b9uBNJ2PHSq
        (using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (curve secp521r1 with 521 ECDH bits, eq. 15360 bits RSA))
        (Client did not present a certificate);
        Sun, 23 Dec 2018 20:02:25 +0100 (CET)
Subject: Re: [PATCH] can: af_can: Fix Spectre v1 vulnerability
To: "Gustavo A. R. Silva" <gustavo@embeddedor.com>,
        Marc Kleine-Budde <mkl@pengutronix.de>,
        "David S. Miller" <davem@davemloft.net>
Cc: linux-can@vger.kernel.org, netdev@vger.kernel.org,
        linux-kernel@vger.kernel.org
References: <20181221212229.GA32635@embeddedor>
From: Oliver Hartkopp <socketcan@hartkopp.net>
Message-ID: <f0c42e0b-7d10-be7e-4b52-82567cf747eb@hartkopp.net>
Date: Sun, 23 Dec 2018 20:02:18 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101
 Thunderbird/60.3.1
MIME-Version: 1.0
In-Reply-To: <20181221212229.GA32635@embeddedor>
Content-Type: text/plain; charset=utf-8; format=flowed
Content-Language: en-US
Content-Transfer-Encoding: 7bit
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

After *trying* to follow the discussion on ...

https://marc.info/?l=linux-kernel&m=154554485324143&w=2
[PATCH] net: core: Fix Spectre v1 vulnerability

... I'm still not sure whether af_can.c needs this enhancement or not.

Just waiting for the end of the discussion :-)

Thanks to the experts!

Oliver

On 12/21/18 10:22 PM, Gustavo A. R. Silva wrote:
> protocol is indirectly controlled by user-space, hence leading to
> a potential exploitation of the Spectre variant 1 vulnerability.
> 
> This issue was detected with the help of Smatch:
> 
> net/can/af_can.c:115 can_get_proto() warn: potential spectre issue 'proto_tab' [w]
> 
> Fix this by sanitizing protocol before using it to index proto_tab.
> 
> Notice that given that speculation windows are large, the policy is
> to kill the speculation on the first load and not worry if it can be
> completed with a dependent load/store [1].
> 
> [1] https://marc.info/?l=linux-kernel&m=152449131114778&w=2
> 
> Signed-off-by: Gustavo A. R. Silva <gustavo@embeddedor.com>
> ---
>   net/can/af_can.c | 2 ++
>   1 file changed, 2 insertions(+)
> 
> diff --git a/net/can/af_can.c b/net/can/af_can.c
> index 1684ba5b51eb..cade7250c6d4 100644
> --- a/net/can/af_can.c
> +++ b/net/can/af_can.c
> @@ -59,6 +59,7 @@
>   #include <linux/can/core.h>
>   #include <linux/can/skb.h>
>   #include <linux/ratelimit.h>
> +#include <linux/nospec.h>
>   #include <net/net_namespace.h>
>   #include <net/sock.h>
>   
> @@ -136,6 +137,7 @@ static int can_create(struct net *net, struct socket *sock, int protocol,
>   
>   	if (protocol < 0 || protocol >= CAN_NPROTO)
>   		return -EINVAL;
> +	protocol = array_index_nospec(protocol, CAN_NPROTO);
>   
>   	cp = can_get_proto(protocol);
>   
> 
