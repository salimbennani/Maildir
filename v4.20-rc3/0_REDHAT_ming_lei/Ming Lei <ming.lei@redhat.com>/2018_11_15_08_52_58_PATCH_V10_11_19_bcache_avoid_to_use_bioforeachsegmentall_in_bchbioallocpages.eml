Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from pop3.zju.edu.cn (61.164.42.155:110) by
  likexu-MOBL1.ccr.corp.intel.com with POP3; 15 Nov 2018 14:03:03 -0000
Received: from icoremail.net (unknown [209.85.215.173])
	by mail-app2 (Coremail) with SMTP id by_KCgDHH371NO1bbYuYAQ--.45664S3;
	Thu, 15 Nov 2018 16:57:26 +0800 (CST)
Received: from mail-pg1-f173.google.com (unknown [209.85.215.173])
	by mx2.icoremail.net (Coremail) with SMTP id AQAAfwCXeETzNO1bJd9CAA--.5954S3;
	Thu, 15 Nov 2018 16:57:23 +0800 (CST)
Received: by mail-pg1-f173.google.com with SMTP id z11so6078341pgu.0
        for <xuliker@zju.edu.cn>; Thu, 15 Nov 2018 00:57:23 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-original-authentication-results:x-gm-message-state:delivered-to
         :from:to:cc:subject:date:message-id:in-reply-to:references:sender
         :precedence:list-id;
        bh=KsK+yW7qYUQuHCvE6rEDlffDmIoBa+mM4kNBOYDMPlI=;
        b=W5pHbHvg1Q2f3gZNEzsMOBANb8x7/qSoAWA566ZymJH7NXGfiJQWEA5417eVd30d/f
         e7GOkzh5SlGLK+i4W0F+giUiAz0Yp19OYtHibORTDk45PdQpriKk4mokN7D5i90ou6uy
         6M7VP3zoidPcrT8iuF8W5Sff/b9hs8sYPKJpE7DvO5BjCGFOH/FelA1Z/mmyRBmEvcLw
         5ttzeZPSyaRNvfOZ3I+uW/Go+HYHbHTXmO3OteYop7gclUvZJbjzN0/0cngEXIYoE8/H
         zabH+GlZcBLwxRiWfX/LrgoKMl8jtQB0wkYNyJWIlCHKH/DPGMUBlV/iikDala/UXL1P
         /wiw==
X-Original-Authentication-Results: mx.google.com;       spf=pass (google.com: best guess record for domain of linux-kernel-owner@vger.kernel.org designates 209.132.180.67 as permitted sender) smtp.mailfrom=linux-kernel-owner@vger.kernel.org;       dmarc=fail (p=NONE sp=NONE dis=NONE) header.from=redhat.com
X-Gm-Message-State: AGRZ1gKkAhHxzan7dG/YS7/xhe28ZofKfgxUvgIljx6ZXvBOaim2Nbqj
	2tUT9bLOny1Qg02yzQW3TO1Bd7I6BxmQYiy794+/l8TXBh54hxexlw==
X-Received: by 2002:a62:520b:: with SMTP id g11mr3098543pfb.53.1542272243390;
        Thu, 15 Nov 2018 00:57:23 -0800 (PST)
X-Forwarded-To: xuliker@zju.edu.cn
X-Forwarded-For: liker.xu@gmail.com xuliker@zju.edu.cn
Delivered-To: liker.xu@gmail.com
Received: by 2002:a17:90a:d106:0:0:0:0 with SMTP id l6-v6csp300874pju;
        Thu, 15 Nov 2018 00:57:22 -0800 (PST)
X-Google-Smtp-Source: AJdET5excq9u6DqntOJYyLhXOXrtVcswHUqOI4SfR1VxXH3tS28BdakWo5z4ZhUhQIE80dhDH9bo
X-Received: by 2002:a17:902:780a:: with SMTP id p10mr5579543pll.54.1542272242699;
        Thu, 15 Nov 2018 00:57:22 -0800 (PST)
ARC-Seal: i=1; a=rsa-sha256; t=1542272242; cv=none;
        d=google.com; s=arc-20160816;
        b=MOKbRVBMqQmMsgFNNbbxyKgQnuGjlRB8k/SFw2RMG3nVyb/RPlqxztwrDp3lyQ3utp
         hDXBxz3+xmQ2QDXH09jNdssCqUwkRTgccUD8E3skEglVzB2Dc1RLTIEWLZNufYLwHHWP
         45is6Kx9C39VaXPf3XjUCMPTPLJhwompZp4LTgHCbIWliBOadXYwtiXYZ29Dz4kUcss4
         PC2z/N6ypAEdlNwKPuYxjN1PmWsJMRpKomgUyDfxJ59muElyJ6uIg52gDsqnWkd0TaJ2
         K5Q8NcNsR8Z/PFLUSZJAjWPUZRe7WGoVy0zmpdmEa8wQ5Et1SgD39YKPWULnRjPt5iBn
         NutA==
ARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;
        h=list-id:precedence:sender:references:in-reply-to:message-id:date
         :subject:cc:to:from;
        bh=KsK+yW7qYUQuHCvE6rEDlffDmIoBa+mM4kNBOYDMPlI=;
        b=A23x7MnRsmkqDiQU4Cj9o3/+HoGQKTVgjer7eCHupzggRtbEdH8DAG6RgkOgirWYTU
         aA7Q/L+EaWABF0KZ4KxZX+cC0LpGEsWLE4Adm56Ttk2MA0sBZurC2FuW8jLmECibXFjU
         lkqabEZrJHB72N73/6fmVXz1Q9TuNWrMVuvbECL6caUsB36yL5O4bXuULQoojYqDzmB6
         f0A5jMsrJcbGJcps1dinp0PhLPWuqeAa2fS163hsVh64wmUufwa3HGTYTMqBdEHeR61v
         5WPajnJCr87VPqEBCbQaikXhZjrEQxlm/dHaPRo9kAosWSDunQPhjNsjbWnQlnd223Q9
         +zIA==
ARC-Authentication-Results: i=1; mx.google.com;
       spf=pass (google.com: best guess record for domain of linux-kernel-owner@vger.kernel.org designates 209.132.180.67 as permitted sender) smtp.mailfrom=linux-kernel-owner@vger.kernel.org;
       dmarc=fail (p=NONE sp=NONE dis=NONE) header.from=redhat.com
Received: from vger.kernel.org (vger.kernel.org. [209.132.180.67])
        by mx.google.com with ESMTP id e129si25722153pgc.333.2018.11.15.00.57.08;
        Thu, 15 Nov 2018 00:57:22 -0800 (PST)
Received-SPF: pass (google.com: best guess record for domain of linux-kernel-owner@vger.kernel.org designates 209.132.180.67 as permitted sender) client-ip=209.132.180.67;
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2388114AbeKOTDW (ORCPT <rfc822;jroi.martin@gmail.com>
        + 99 others); Thu, 15 Nov 2018 14:03:22 -0500
Received: from mx1.redhat.com ([209.132.183.28]:40096 "EHLO mx1.redhat.com"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1728527AbeKOTDV (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 15 Nov 2018 14:03:21 -0500
Received: from smtp.corp.redhat.com (int-mx06.intmail.prod.int.phx2.redhat.com [10.5.11.16])
        (using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
        (No client certificate requested)
        by mx1.redhat.com (Postfix) with ESMTPS id 4EE95308ED4B;
        Thu, 15 Nov 2018 08:56:27 +0000 (UTC)
Received: from localhost (ovpn-8-23.pek2.redhat.com [10.72.8.23])
        by smtp.corp.redhat.com (Postfix) with ESMTP id 4796A5E1BF;
        Thu, 15 Nov 2018 08:55:59 +0000 (UTC)
From: Ming Lei <ming.lei@redhat.com>
To: Jens Axboe <axboe@kernel.dk>
Cc: linux-block@vger.kernel.org, linux-kernel@vger.kernel.org,
        linux-mm@kvack.org, Ming Lei <ming.lei@redhat.com>,
        Dave Chinner <dchinner@redhat.com>,
        Kent Overstreet <kent.overstreet@gmail.com>,
        Mike Snitzer <snitzer@redhat.com>, dm-devel@redhat.com,
        Alexander Viro <viro@zeniv.linux.org.uk>,
        linux-fsdevel@vger.kernel.org, Shaohua Li <shli@kernel.org>,
        linux-raid@vger.kernel.org, linux-erofs@lists.ozlabs.org,
        David Sterba <dsterba@suse.com>, linux-btrfs@vger.kernel.org,
        "Darrick J . Wong" <darrick.wong@oracle.com>,
        linux-xfs@vger.kernel.org, Gao Xiang <gaoxiang25@huawei.com>,
        Christoph Hellwig <hch@lst.de>, Theodore Ts'o <tytso@mit.edu>,
        linux-ext4@vger.kernel.org, Coly Li <colyli@suse.de>,
        linux-bcache@vger.kernel.org, Boaz Harrosh <ooo@electrozaur.com>,
        Bob Peterson <rpeterso@redhat.com>, cluster-devel@redhat.com
Subject: [PATCH V10 11/19] bcache: avoid to use bio_for_each_segment_all() in bch_bio_alloc_pages()
Date: Thu, 15 Nov 2018 16:52:58 +0800
Message-Id: <20181115085306.9910-12-ming.lei@redhat.com>
In-Reply-To: <20181115085306.9910-1-ming.lei@redhat.com>
References: <20181115085306.9910-1-ming.lei@redhat.com>
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.16
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16 (mx1.redhat.com [10.5.110.44]); Thu, 15 Nov 2018 08:56:27 +0000 (UTC)
Sender: liker.xu+caf_=xuliker=zju.edu.cn@gmail.com
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org
X-CM-TRANSID: AQAAfwCXeETzNO1bJd9CAA--.5954S3
Authentication-Results: mail-app2; spf=pass smtp.mail=liker.xu+caf_=xu
	liker=zju.edu.cn@gmail.com;
X-Coremail-Antispam: 1UD129KBjvJXoW7Cr4xCrW5XF1rJr4DWr13CFg_yoW8Aw1fpF
	srWry3C3s3Xw1rJ34DKFyq9Fy3Xa4DGrW5Gr17Ja48Zryavr1FgFnIqw1aqryDGF15CF45
	Xr1qgw1Igas5XaDanT9S1TB71UUUUUUqnTZGkaVYY2UrUUUUjbIjqfuFe4nvWSU8nxnvy2
	9KBjDU0xBIdaVrnRJUUUPYb7Iv0xC_Cr1lb4IE77IF4wAFF20E14v26r1j6r4UM7CIcVAF
	z4kK6r1j6r18M28lY4IEw2IIxxk0rwA2F7IY1VAKz4vEj48ve4kI8wA2z4x0Y4vE2Ix0cI
	8IcVAFwI0_Ar0_tr1l84ACjcxK6xIIjxv20xvEc7CjxVAFwI0_Cr0_Gr1UM28EF7xvwVC2
	z280aVAFwI0_GcCE3s1l84ACjcxK6I8E87Iv6xkF7I0E14v26rxl6s0DM2AIxVAIcxkEcV
	Aq07x20xvEncxIr21l5I8CrVACY4xI64kE6c02F40Ex7xfMcIj6xIIjxv20xvE14v26r1Y
	6r17McIj6I8E87Iv67AKxVW8JVWxJwAm72CE4IkC6x0Yz7v_Jr0_Gr1lF7xvr2IY64vIr4
	1l7I0Y6sxI4wCY1x0264kExVAvwVAq07x20xylc7Ca8VAvwVCFzxkY4VCF77xAMxkIecxE
	wVCI4VW8ZwCY0x0Ix7I2Y4AK64vIr41lcIIF0xvE2Ix0cI8IcVAFwI0_Xr0_Ar1lcIIF0x
	vE2Ix0cI8IcVCY1x0267AKxVW8JVWxJwCYIxAIcVC2z280aVAFwI0_Cr1j6rxdMxvI42IY
	6I8E87Iv6xkF7I0E14v26F4UJVW0owCF04k20xvY0x0EwIxGrwCF04k20xvEw4C26cxK6c
	8Ij28IcwCF72vE77IF4wCFx2IqxVCFs4IE7xkEbVWUJVW8JwC20s026c02F40E14v26r1j
	6r18MI8I3I0E7480Y4vE14v26r106r1rMI8E67AF67kF1VAFwI0_GFv_WrylIxkGc2Ij64
	vIr41lIxAIcVCF04k26cxKx2IYs7xG6r1I6r4UYxBIdaVFxhVjvjDU0xZFpf9x07b5MKZU
	UUUU=

bch_bio_alloc_pages() is always called on one new bio, so it is safe
to access the bvec table directly. Given it is the only kind of this
case, open code the bvec table access since bio_for_each_segment_all()
will be changed to support for iterating over multipage bvec.

Cc: Dave Chinner <dchinner@redhat.com>
Cc: Kent Overstreet <kent.overstreet@gmail.com>
Acked-by: Coly Li <colyli@suse.de>
Cc: Mike Snitzer <snitzer@redhat.com>
Cc: dm-devel@redhat.com
Cc: Alexander Viro <viro@zeniv.linux.org.uk>
Cc: linux-fsdevel@vger.kernel.org
Cc: Shaohua Li <shli@kernel.org>
Cc: linux-raid@vger.kernel.org
Cc: linux-erofs@lists.ozlabs.org
Cc: David Sterba <dsterba@suse.com>
Cc: linux-btrfs@vger.kernel.org
Cc: Darrick J. Wong <darrick.wong@oracle.com>
Cc: linux-xfs@vger.kernel.org
Cc: Gao Xiang <gaoxiang25@huawei.com>
Cc: Christoph Hellwig <hch@lst.de>
Cc: Theodore Ts'o <tytso@mit.edu>
Cc: linux-ext4@vger.kernel.org
Cc: Coly Li <colyli@suse.de>
Cc: linux-bcache@vger.kernel.org
Cc: Boaz Harrosh <ooo@electrozaur.com>
Cc: Bob Peterson <rpeterso@redhat.com>
Cc: cluster-devel@redhat.com
Signed-off-by: Ming Lei <ming.lei@redhat.com>
---
 drivers/md/bcache/util.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/drivers/md/bcache/util.c b/drivers/md/bcache/util.c
index 20eddeac1531..8517aebcda2d 100644
--- a/drivers/md/bcache/util.c
+++ b/drivers/md/bcache/util.c
@@ -270,7 +270,7 @@ int bch_bio_alloc_pages(struct bio *bio, gfp_t gfp_mask)
 	int i;
 	struct bio_vec *bv;
 
-	bio_for_each_segment_all(bv, bio, i) {
+	for (i = 0, bv = bio->bi_io_vec; i < bio->bi_vcnt; bv++) {
 		bv->bv_page = alloc_page(gfp_mask);
 		if (!bv->bv_page) {
 			while (--bv >= bio->bi_io_vec)
-- 
2.9.5
