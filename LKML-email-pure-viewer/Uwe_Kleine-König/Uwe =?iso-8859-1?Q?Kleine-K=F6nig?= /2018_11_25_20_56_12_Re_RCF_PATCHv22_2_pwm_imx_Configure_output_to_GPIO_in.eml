Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 26 Nov 2018 08:51:58 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga007.jf.intel.com (orsmga007.jf.intel.com [10.7.209.58])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 77E7F5803C2;
	Sun, 25 Nov 2018 12:59:27 -0800 (PST)
Received: from orsmga102-1.jf.intel.com (HELO mga09.intel.com) ([10.7.208.27])
  by orsmga007-1.jf.intel.com with ESMTP; 25 Nov 2018 12:59:27 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3ArPy6RhwTD+2CL9PXCy+O+j09IxM/srCxBDY+r6Qd?=
 =?us-ascii?q?0e8RKvad9pjvdHbS+e9qxAeQG9mDu7Qc06L/iOPJYSQ4+5GPsXQPItRndiQuro?=
 =?us-ascii?q?EopTEmG9OPEkbhLfTnPGQQFcVGU0J5rTngaRAGUMnxaEfPrXKs8DUcBgvwNRZv?=
 =?us-ascii?q?JuTyB4Xek9m72/q99pHPYAhEniaxba9vJxiqsAvdsdUbj5F/Iagr0BvJpXVIe+?=
 =?us-ascii?q?VSxWx2IF+Yggjx6MSt8pN96ipco/0u+dJOXqX8ZKQ4UKdXDC86PGAv5c3krgfM?=
 =?us-ascii?q?QA2S7XYBSGoWkx5IAw/Y7BHmW5r6ryX3uvZh1CScIMb7Vq4/Vyi84Kh3SR/okC?=
 =?us-ascii?q?YHOCA/8GHLkcx7kaZXrAu8qxBj34LYZYeYP+d8cKzAZ9MXXWRPUMZPWSJcAY28?=
 =?us-ascii?q?YYQAAPYcMuhXrYbyqUAOrQO8CAS3GOPiySVFimPq0aAg0eksFxzN0gw6H9IJtX?=
 =?us-ascii?q?TZtNv6NakMXuuoyafIySvMb/JQ2Tjj8YTGdxY5ofeNXbJ/bMHczlQvGxnGjlWU?=
 =?us-ascii?q?t4PlPjWV2foUv2iY6OpvS+Svi28oqwxqujig2MEsiobUhoIJ0FDE8iN5wIc6JN?=
 =?us-ascii?q?GiVUF0f8epHZ1NvC+UMIt2R9ktQ2BuuCsi0r0Jp5i7fCcXyJQ73R7fbPqHc4mH?=
 =?us-ascii?q?4x75SemePzF1j29mdrKnnxu+71Ssx+nmWsWp3ltGsDBJnsTPu3wRzRDe68qKRu?=
 =?us-ascii?q?Nj8ku9xTqDygXe5+BGLE8okKfWKpwszqI1m5YOrUjPAir7lFjrg6KTc0gr5vSk?=
 =?us-ascii?q?5uL6abv8vJCcLZV7igTmP6QuhMO/BeM4PxAQX2iU5+u8zqfv/U7nT7VQiP05jK?=
 =?us-ascii?q?3ZvIrdJcQBqa61Gw5V0oA95BajFzqqzsgUkH0dIF5Ydh+LkZLlN0zNLfzkF/uy?=
 =?us-ascii?q?glahnC9ux//cP73hBpvNLmLEkLfkZbt9709cyAwuzdFQ/p5UCa8OIOj1WkDvsN?=
 =?us-ascii?q?zUFxg5MgKyw+n5EtVwzZ0eWW2RDa+DKq/SskGH5vgpI+aSYI8ZojH9K+Iq5/L2?=
 =?us-ascii?q?l382hUcdfbW13ZsQcH24GvVmI0aHbnb2jdYBDHwHvg4/TOzslV2DXiRfZ3e0X6?=
 =?us-ascii?q?Ig+D47DJiqApvERoComLaBxju0HoVKZmBaDVCBCXfoeJ+FW/cQci2SJdVtkjwZ?=
 =?us-ascii?q?Vbe7TY8h2gqjtAv7y7phM+rV9TcUtZPl1Nhp+eLTkQs++iBzD8SYy2uNVX17nn?=
 =?us-ascii?q?sURz8q26ByuU59ylCd3qRigPxYEtpT5/VOUgohMZ7czup6C839Ww7bf9eJTkqm?=
 =?us-ascii?q?TcuiAT0rUt0xxNoOaV5nG9q+lhDDwzaqA7gNmrORH5w08qXc33vrK8Zn0XnG1r?=
 =?us-ascii?q?Isj10nQstJKG2nibRz9wnVB47VjUqZk7ymergb3C7I7G2D13aBvFlEUA5sVqXI?=
 =?us-ascii?q?RXMfaVHQrdjj4kPCTqWhCbIoMgZazc6CK61KasDmjFlcRffjPsjebHy1m2uqGR?=
 =?us-ascii?q?mIwbaMZpLwe2oBxCXdFFQEkwcL8HmbLwc+GDmur3jeDDN0E1LveF3j8e95pHO/?=
 =?us-ascii?q?TU80ygWKYlZl17q0/B4VmPOdR+kS3rICpCcutTF0EEyh0NLRDtqKvxBhc7lEYd?=
 =?us-ascii?q?Mh/FdH0nrUuBFnMZy+Ma9unF4efB5xv0P1yRp3DJ5NkcwrrHMs0QpzJriU0FJH?=
 =?us-ascii?q?dzOEw5/wPqfbJXX1/BCqc6TWwE3R0M6K+qcT7/Q1s0njvACsFkol73Vn09lU32?=
 =?us-ascii?q?GA5pnQCwoSS5bxUkcx9xh1vLzaZig954XJ1XxjK6W0sznC2843C+sh0BqvY9Bf?=
 =?us-ascii?q?MKacHg/oD8IaH9SuKPAtm1WxdB0EOP5d9aEqMMKmbfeJw7OrM/t6kzKgjmRH55?=
 =?us-ascii?q?5931mI9yp9TO7IwpkEz+uZ3guBSzfzklOhvtrrloBDYDEYBnC/xjT8BI5Neq1y?=
 =?us-ascii?q?ep4GCGezI8Gt2tpynZ/sW35C+16lCFMLw8upeRuUb1zg0gxcz0UXoXq7mSSmyz?=
 =?us-ascii?q?x4iS0mrq2a3CbW2eTtaAIHOnJXRGlllVrsO4m0gMwAU0iycgcpkwGp5UDkyKhB?=
 =?us-ascii?q?paRzNnXcTl1MfyfrMW5iSKywtryZbs5L6ZMotzhXUeumbVCbTL79vwUV0yf5E2?=
 =?us-ascii?q?RCwzA7cimguo/lkBxilGKdMHFzoWLZeMFx3xve5MbQReVM3joAXyR4jTjXBl6h?=
 =?us-ascii?q?P9im59mUlpHDsvygWGKlTJFcbS7rzYaYviuh+WJqGQG/n+y0mtD/Ewg1yzX719?=
 =?us-ascii?q?ppVSXPthr8eZPk16e5MeJmeElnGln85tF+GoF/lIswmZ4R1WIbhpWT4XoIj2Pz?=
 =?us-ascii?q?Pc9H1qL5aXoHXSQLzMLN4Aj5xE1jKWqExoLjWXWa2MdhZdi6YmUN1yI57sBKDr?=
 =?us-ascii?q?qU7bNekSt0pFq4sRzeYfxnkjgBzvsu7WYQg/sVtwo10iWdHrcSEFFbPSP2lhSE?=
 =?us-ascii?q?9dC+rLhNa2apfri9z05+ndGnDLGfrQBQQnf5epE+HSBu6sVzKk7D0Hr26ov8Yt?=
 =?us-ascii?q?nfccoTtgGIkxfHl+VVLZMxlvkQiiZ9N2Pyo2Yly/Ilghx0xp61opKHK2p28aK9?=
 =?us-ascii?q?Ax5YMCD1ZswJ9jHsi6ZegtiZ34S1Epp9HTULWYPiTei0HzIKqfTnKwGOHSUgqn?=
 =?us-ascii?q?ecHLrTBw6e511gr3LSCJCrLHCXKWIdzdVjQhmdOUNejBoVXDU8gp42CASqyNb9?=
 =?us-ascii?q?f0d+4zAb/kT4pQdUyuJ0Kxn/VX/SqxyyZTczTJifMQBa7gVf50rONcye7+RzHz?=
 =?us-ascii?q?xX/5G7rQyNLHCbaBpMDW0TRkOEAFXjNKG05dbc6+iYGva+L/zWbLWMs+NeUumH?=
 =?us-ascii?q?xYm13ot65TqMNdiPPnp/D/09wEVDRmt0G8DYmzUJViwWmDjBb8+dpBeg5CJ3qt?=
 =?us-ascii?q?qz/+jsWALq/YGPEaddMc1z+xCqhqeOL+6RhCFkKTZBy5MD33nIxKIE3F4VjSFu?=
 =?us-ascii?q?eCKgEbABtS7LUaLRlbVbDx8dayNvKsRI67gw0RVKOc7ektn1zKJ3juYpC1dZUl?=
 =?us-ascii?q?zsgsGpatILI2G+N1PHBVyHNLecJT3MzMH4f7m8SaBLjOhPsx2wuDCbE1LsPziZ?=
 =?us-ascii?q?ljnpUQyvPv9IjC2BIBNev4S9eA53CWf/VNLmdgG7MNhvgDIs3L07nWnKOnAcMD?=
 =?us-ascii?q?Rmd0NNr6ad7SdZgvV5BmxA4WBpLeiCmyaF8ebYLowavudsAiRxj+ha+mg1y6NJ?=
 =?us-ascii?q?7CFYQ/x4gDfSrt9ro128juaD0CZoUBpQpTZNn4+LuURiOaPE9phPQ3rE/RQN7X?=
 =?us-ascii?q?mOBBQOvddqFtrvu6VIwNjViK3zMCtC887T/cYEB8nbMsSHMH8gMRrvADHVDQsF?=
 =?us-ascii?q?QiStNWHQnEFdlPCS9nuIrpk1sJTsmZwOSqNFW1wxDP8VFkNlHNlRaKtwCw0jkj?=
 =?us-ascii?q?eQxOsJ7nq3qFGFYcRRvpnDEMyVAvzkACeCirdYIRAPxOWrA54UM9jGxEEqSV13?=
 =?us-ascii?q?nYLHXmlOW9FC6nl8KAwwrURL/T19SWA12k3Ncg6r72IPD/mynw5whgYoMrdlzy?=
 =?us-ascii?q?vl/1pifgmCnyA3ikRk3Iy92T0=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ANAACZDPtbh0O0hNFhHAEBAQQBAQcEA?=
 =?us-ascii?q?QGBUQcBAQsBgTCBOYEChCCIGIt+gg0UlyiBcxQYBwwBiFoiNAkNAQMBAQEBAQE?=
 =?us-ascii?q?CARMBAQEIDQkIKSMMgjYkAYJhAQEBAQIBAQIgDwFGBQEJAQEIAhgCAgUhAgIDD?=
 =?us-ascii?q?C0bBhgWgwYBgXkIAQMBihibUIEviheBC4p+ghaBEYMShHODD4JXAokRggCUcQc?=
 =?us-ascii?q?CgRGQEyOBWYULgniHLJgwgUaCDXGDPAiCHheDfYogP4E3AQGMSgEB?=
X-IPAS-Result: =?us-ascii?q?A0ANAACZDPtbh0O0hNFhHAEBAQQBAQcEAQGBUQcBAQsBgTC?=
 =?us-ascii?q?BOYEChCCIGIt+gg0UlyiBcxQYBwwBiFoiNAkNAQMBAQEBAQECARMBAQEIDQkIK?=
 =?us-ascii?q?SMMgjYkAYJhAQEBAQIBAQIgDwFGBQEJAQEIAhgCAgUhAgIDDC0bBhgWgwYBgXk?=
 =?us-ascii?q?IAQMBihibUIEviheBC4p+ghaBEYMShHODD4JXAokRggCUcQcCgRGQEyOBWYULg?=
 =?us-ascii?q?niHLJgwgUaCDXGDPAiCHheDfYogP4E3AQGMSgEB?=
X-IronPort-AV: E=Sophos;i="5.56,279,1539673200"; 
   d="scan'208";a="54721396"
X-Amp-Result: UNSCANNABLE
X-Amp-File-Uploaded: False
Unscannable: 2
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 25 Nov 2018 12:59:25 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1726145AbeKZHsT (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Mon, 26 Nov 2018 02:48:19 -0500
Received: from metis.ext.pengutronix.de ([85.220.165.71]:52453 "EHLO
        metis.ext.pengutronix.de" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1726021AbeKZHsS (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 26 Nov 2018 02:48:18 -0500
Received: from ptx.hi.pengutronix.de ([2001:67c:670:100:1d::c0])
        by metis.ext.pengutronix.de with esmtps (TLS1.2:ECDHE_RSA_AES_256_GCM_SHA384:256)
        (Exim 4.89)
        (envelope-from <ukl@pengutronix.de>)
        id 1gR1Ru-00006N-V4; Sun, 25 Nov 2018 21:56:14 +0100
Received: from ukl by ptx.hi.pengutronix.de with local (Exim 4.89)
        (envelope-from <ukl@pengutronix.de>)
        id 1gR1Rs-0001eq-MU; Sun, 25 Nov 2018 21:56:12 +0100
Date: Sun, 25 Nov 2018 21:56:12 +0100
From: Uwe =?iso-8859-1?Q?Kleine-K=F6nig?= 
        <u.kleine-koenig@pengutronix.de>
To: =?utf-8?B?Vm9rw6HEjQ==?= Michal <Michal.Vokac@ysoft.com>
Cc: Lothar =?iso-8859-1?Q?Wa=DFmann?= <LW@KARO-electronics.de>,
        Thierry Reding <thierry.reding@gmail.com>,
        Mark Rutland <mark.rutland@arm.com>,
        "devicetree@vger.kernel.org" <devicetree@vger.kernel.org>,
        "linux-pwm@vger.kernel.org" <linux-pwm@vger.kernel.org>,
        Lukasz Majewski <l.majewski@majess.pl>,
        "linux-kernel@vger.kernel.org" <linux-kernel@vger.kernel.org>,
        Rob Herring <robh+dt@kernel.org>,
        "kernel@pengutronix.de" <kernel@pengutronix.de>,
        Fabio Estevam <fabio.estevam@nxp.com>,
        Linus Walleij <linus.walleij@linaro.org>,
        viresh kumar <viresh.kumar@linaro.org>
Subject: Re: [RCF PATCH,v2,2/2] pwm: imx: Configure output to GPIO in
 disabled state
Message-ID: <20181125205612.aownvgjnpxhqyxed@pengutronix.de>
References: <20181114215120.vddykljqyavm64wj@pengutronix.de>
 <20181115152545.GA8611@ulmo>
 <20181115203733.qvonika6yhn2bsnb@pengutronix.de>
 <20181116083430.7f1d8452@ipc1.ka-ro>
 <20181116082557.l2ljgu3hsu7tvdci@pengutronix.de>
 <91640f9b-d219-553e-043a-c6151f2f68d7@ysoft.com>
 <20181122162359.ufngpgxkenlmgqni@pengutronix.de>
 <b332b319-cbb3-547f-c8b7-1dd275c1596d@ysoft.com>
 <20181122190321.ktqegs7kpvhcemvi@pengutronix.de>
 <9da8c6d9-d97c-200c-d8e4-2eb9f73eedc5@ysoft.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <9da8c6d9-d97c-200c-d8e4-2eb9f73eedc5@ysoft.com>
User-Agent: NeoMutt/20170113 (1.7.2)
X-SA-Exim-Connect-IP: 2001:67c:670:100:1d::c0
X-SA-Exim-Mail-From: ukl@pengutronix.de
X-SA-Exim-Scanned: No (on metis.ext.pengutronix.de); SAEximRunCond expanded to false
X-PTX-Original-Recipient: linux-kernel@vger.kernel.org
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Hello Michal,

On Fri, Nov 23, 2018 at 03:15:11PM +0000, Vokáč Michal wrote:
> On 22.11.2018 20:03, Uwe Kleine-König wrote:
> > On Thu, Nov 22, 2018 at 04:46:39PM +0000, Vokáč Michal wrote:
> >> On 22.11.2018 17:23, Uwe Kleine-König wrote:
> >>> So I'd expect this to really work on i.MX6 but not the earlier SoCs
> >>> without a gpio specifier.
> >>
> >> Maybe you would expect it to work but I already tested and measured
> >> that weeks ago ;) It did not work.
> > 
> > Which pin/gpio do we talk about? Which i.MX6 variant did you test this
> > on? (Assuming i.MX6D or i.MX6Q and PAD_DISP0_DATA09, did you try setting
> > 
> > 	IOMUXC_SW_MUX_CTL_PAD_DISP0_DATA09 (0x020E0194) = 0x00000005
> > 	IOMUXC_SW_PAD_CTL_PAD_DISP0_DATA09 (0x020E04A8) = 0x0000b080
> > 
> > and then play with GPIO 4.30 direction and output value?)
> 
> My test setup is as follows:
> - SoC is i.MX6DL or i.MX6S - I have three board variants in total.
> - Pin used for PWM/GPIO is PAD_GPIO9.
> - The pin is not connected to any circuit. Just a test point.
> - pinctrl setup in DT:
>    - for "pwm":
>      - fsl,pins = <MX6QDL_PAD_GPIO_9__PWM1_OUT 0x8>
>      - IOMUXC_SW_MUX_CTL_PAD_GPIO09 = 0x00000004
>      - IOMUXC_SW_PAD_CTL_PAD_GPIO09 = 0x00000008
> 
>    - for "gpio":
>     - fsl,pins = <MX6QDL_PAD_GPIO_9__GPIO1_IO09 0xb000>
>     - IOMUXC_SW_MUX_CTL_PAD_GPIO09 = 0x00000005
>     - IOMUXC_SW_PAD_CTL_PAD_GPIO09 = 0x0000b000

FTR: I suggested 0x0000b080 here, but 0x0000b000 is just fine.

> Test scenario:
> 
> - In bootloader configure the pin as GPIO output, set it LOW (0V).
>    I set it LOW to start in the oposite state than I want to end up in.
> - Boot Linux
> - Use sysfs to configure the PWM to produce some signal.
> - In the PWM driver select the "pwm" pinctrl state.
> - Measure the output - expected waveform on the scope.
> - Use sysfs to stop the PWM "echo 0 > /sys/class/pwm/pwmchip0/pwm0/enable°
> - In the PWM driver select the "gpio" pinctrl state.
> - Then in the PWM driver:
> 
> a) non-working variant
> - Do not request the GPIO - so do not touch its pad control reg.
>    It is set as output from the bootloader, data register = 0.
> - Measure voltage on the output
>    - against GND = 0V
>    - against VCC = 0V
> - Measure resistance against VCC: Hi-Z
> 
> The pin is in Hi-Z mode. That is fine but that does not satisfy any
> logic level.
> 
> b) working variant
> - Request the GPIO, configure it as input.
> - Measure voltage on the output
>    - against GND = VCC (3.3V)
>    - against VCC = 0V
> - Measure resistance against VCC = 91.1kOhm
> 
> The pull-up is active.

Thanks for your detailed test. So DSE = 0 doesn't work as I (and I think
Lothar) expected.

@Lothar: if Michal did something different than you expected, please
tell us with a few more details.

> I can repeat the results on both i.MX6DL and i.MX6S on pwm1 and pwm4.
> All pull-up and pull-down combinations gave me the expected results
> only if the pin is configured as input. So if I repeat the test and
> do not touch the pin in bootloader at all, it works as well even if
> I do not request/configure the GPIO in the PWM driver.

OK.

Best regards
Uwe

-- 
Pengutronix e.K.                           | Uwe Kleine-König            |
Industrial Linux Solutions                 | http://www.pengutronix.de/  |
