Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 24 Nov 2018 12:37:50 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga006.jf.intel.com (orsmga006.jf.intel.com [10.7.209.51])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 6A07158037D;
	Fri, 23 Nov 2018 15:33:19 -0800 (PST)
Received: from fmsmga103.fm.intel.com ([10.1.193.90])
  by orsmga006-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 15:33:18 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3ALT1YsxAqMd/CWvSzR51sUyQJP3N1i/DPJgcQr6Af?=
 =?us-ascii?q?oPdwSP7+pM6wAkXT6L1XgUPTWs2DsrQY07qQ6/iocFdDyK7JiGoFfp1IWk1Nou?=
 =?us-ascii?q?QttCtkPvS4D1bmJuXhdS0wEZcKflZk+3amLRodQ56mNBXdrXKo8DEdBAj0OxZr?=
 =?us-ascii?q?KeTpAI7SiNm82/yv95HJbAhEmDmwbaluIBmqsA7cqtQYjYx+J6gr1xDHuGFIe+?=
 =?us-ascii?q?NYxWNpIVKcgRPx7dqu8ZBg7ipdpesv+9ZPXqvmcas4S6dYDCk9PGAu+MLrrxjD?=
 =?us-ascii?q?QhCR6XYaT24bjwBHAwnB7BH9Q5fxri73vfdz1SWGIcH7S60/VC+85Kl3VhDnlC?=
 =?us-ascii?q?YHNyY48G7JjMxwkLlbqw+lqxBm3oLYfJ2ZOP94c6zaYN0aWHFBXt5PWCNdHoOy?=
 =?us-ascii?q?YYwPD+8bMuZZqYn2ul8CoBS6CAWpAu7k1z1GiWLs3aAi3eovER/I0hEjEdIAv3?=
 =?us-ascii?q?vbsMj6O6UcXuCu1KnFzy7Ob/xK1Trn8oXEbgosre+KULltccTR004vFwbdg1uK?=
 =?us-ascii?q?s4PlIS2a1uAQuGac9eVvSeKvhHAkqwpspTWv3t0jipfXiYIR0V3E6Dl2wYgvKd?=
 =?us-ascii?q?KkSU92eNipG4ZeuSGdMot5WMIiQ2dwtSY+y70Gp4C0fCoNyJQ63R7fbeaIc4yS?=
 =?us-ascii?q?7h3/U+aRJC90i254eLK5hha+61Svy+z6W8Kp01hKtjJInsfQun0JzRDf98aKRu?=
 =?us-ascii?q?Vn8ku82juDyxrf5+BGLEwsiKbWL54szqQtmpYOv0nPBDH6lUTsgKOLckgp9O6l?=
 =?us-ascii?q?4Pn9bLr8vJ+TLYp0hxn+Mqswnsy/Bvw1MhYBX2eF4+Swzr7j8lPjQLVMkPI2lr?=
 =?us-ascii?q?PVsJfAJcQUvqK5AglV3Zg/6xunETuqzNAVkWMaIF9LZh6LlZXlNlLSLPziDPqy?=
 =?us-ascii?q?gUygkDJxyPDHOr3hDI/NLn/GkLr5ebZ96khcyBc8zNxG5JJbFKsBIPTtVU/1rd?=
 =?us-ascii?q?DYCRE4MwqqzOb9E9h9yIweVnyVAqODM6Pdr0WI5uQxLOmIfoMVvyz9K/c96/70?=
 =?us-ascii?q?kXA5gUMdfbWu3ZYPbHC4H/dmLFuDbXvjn9cMCmMKvgs4TOz3h1yOSz9TZ3CuX6?=
 =?us-ascii?q?0i4jE3Ep6pDYDGRoq1mryOwD+7HoFKZmBBEl2MEW3nd4SYW/gWbyKeOM9hkiEe?=
 =?us-ascii?q?WrinRI8szhWutA78y7p6IevY4CwYtZT/1Ndr4+3fjw099TtxD86FyWGCU3l0nn?=
 =?us-ascii?q?8URz8xxK1/o0t9xUmZ3ah7hPxYE9pT5/RSXwc+NJ7cyfF6Ct/oVgLAeNeJVEip?=
 =?us-ascii?q?QtG8DT4tSdIxxscEY1xhFNW6khDDwy2qDqcPmLyQBJw09aHc02LrJ8lnyXbLz6?=
 =?us-ascii?q?0hj1ggQstSOmyqnK9/9w7PB4HXl0WVjbqldaMZ3CTV7meM0XKOvF1EUA53SajF?=
 =?us-ascii?q?XmoQZk3ModT950PNVbmuCbs8PwtFyM6CLLZKa9LzgVVHQvfjJMrRY2arl2isAh?=
 =?us-ascii?q?aIw6uGbJD2dGUFwCXdFE8EnhgO8nmcKwgxGD2to2LEAzxoDlLgfUXs/e56qHO4?=
 =?us-ascii?q?S080yxqHb0lg17qz5x4UiuaQS/IV3rIYpighry94E0q639LTE9CAvRZufL1AYd?=
 =?us-ascii?q?Mh51dKzX/WuBZjPpO+NaxihkQRcwJsv0zw0RV6EYFAkcksrHM3wwt+M6OY0FVd?=
 =?us-ascii?q?dzyG2ZD8IKHYKm73/Bq3ca7Zxkne0MqK+qcI8Pk4t1TjvASuFko+83Vm08NZ02?=
 =?us-ascii?q?eG6pXNFgoSVZPxUkA49xVho7HaYy89557b1HF2MKm0tCPC1MwtBOc/1hmgeNJf?=
 =?us-ascii?q?OrueFADuC80aG9SuKOsyllezahILIu9T+7A0Ps+8bPSGxbOkM/xmnDKlimRH/p?=
 =?us-ascii?q?tw0kaN9yp6V+7J0IwJw/Ce3gubSTj8iE2tvdzwmYBBfTsSBHawyTD4BI5NYa1/?=
 =?us-ascii?q?ZYYKCXq0L8Kr3Nl/hp7tVGRe9F6sHF4G3M6peRyPb13yxwFQ1EIXoWC5liu81T?=
 =?us-ascii?q?B7jzYprq+H1izU3+vibAYHOnJMRGR6l1fsIJS7gMoAXEe1aAgljh2l6ljgx6ha?=
 =?us-ascii?q?vahwM3PcQUNVcCfoNWFiVa2wu6GGY85O7pMorCpWXP69YVCcVr7yvR8a3zn/EG?=
 =?us-ascii?q?tZwTAxbyuqtYnhnxxmlGKdK25+rXrYec1qxRbT/sfcReNX3jcdQCl4iD/XBkWz?=
 =?us-ascii?q?PtWz/NWUkYvDvf66V267SpJTdizrx5uatCSn/W1qHQG/n/erl93lCwc6yyz719?=
 =?us-ascii?q?ptVSnStxbzeIrr16e7MeJhYEZoAkTx6857GoF4j4sxi4sc2XkchpWJ43UHlX3/?=
 =?us-ascii?q?Pslc2aL7dHANXyIEw8bJ4Aj5301uNnKIyJj+VnmHwMthZt+6b3gS2iI86cBKFa?=
 =?us-ascii?q?iV4KZFnStzvlq3swbRbeJhkTcazPsk8GQajP0RuAox0iWdBagfHUpCMiztjRiI?=
 =?us-ascii?q?782+o79RZGagarWw0Et+nda8DLCNuA1cWXD5eos8Ei909MlwLFXM0Hjr4IH+ZN?=
 =?us-ascii?q?bQdc4TtgGTkxrYiuhVKZExmeAQiStpJ239pmElxPAhjRN1w566poeHJn5p/KK4?=
 =?us-ascii?q?BB5YKzL0a9kS+jHrkaZRgMKW05qzEZVmHzUBRIHoQu6wEDIOqfTnMB6DECE7qn?=
 =?us-ascii?q?eeA7beHBWQ6EF7r3LUCJCrNmqaJH0YzdVkWRmcK1ZTgAESXDUmgJE5Ehqmy9Dm?=
 =?us-ascii?q?cEd8/joR/EL3qgNQyuJ0MBnySnzQqx2vajcwVZiTNh5W7hxZ6kfRMMye6P9zHi?=
 =?us-ascii?q?5C8p2gqgyNNnKUZwBSAW4VXUyEAkjpPqOy6tnY7+iYGu2+IuPMYbqUrOxRSeyI?=
 =?us-ascii?q?yYiz0od8/DaMK8aPPmRkD/IhwUpORnR5G8XfmzUSRC0bjSPNb8iHpBii/i17tN?=
 =?us-ascii?q?yw8PPuWAj3/4uAF6NSMclz+xCxmaqCN+mQhDtgKTZFzJwMw2XEyKMY3F4UhCFj?=
 =?us-ascii?q?bD2tEbUGtS7QQ6PcgK5XDxgHayxtMMtE9b4z3g5IOcTDkNP6yqZ4juIpC1dCTV?=
 =?us-ascii?q?Hhmt+mZc0JI2G+NVPLHkWLNK6BJT3E3c73e768SaZLgeVQth2wvyubEkD5MjSC?=
 =?us-ascii?q?kTnpSw6gMeVWgC6HOxxevZm3cgxxBmj7UNLmdhq7Pcdtgj0r2rI0nG3FNG4GPT?=
 =?us-ascii?q?h4ckNAtbmQ7SJegvViFG1N9HtlLe+YmymH6+nUMIoZsfxuAi5sjeJV/Gw6y6dJ?=
 =?us-ascii?q?7CFDXPF1hCrSrtt0r166iOWA1jpnXwRIqjtQgIKLvENiObjW95VaWHbE+g4N4n?=
 =?us-ascii?q?uUCxgQu9RlDdjvsbhKytfTjKLzNCtC89XM8MocHcfULseHMHsnMRXxGT/UDBEK?=
 =?us-ascii?q?TTikNWzEg0xdkfeS9mCar5Qgq5jsnoYORaFfVFAvCvwaDUFlT5Q+J8JLVzAtir?=
 =?us-ascii?q?6axO8X7Hv2+AXQW8xblovaTf/UDfi5exiDirwRXxIWzLewCI0YNoD4kxh6Y0d3?=
 =?us-ascii?q?mKzXEFWWVsIb8X4pVRM9vEgYqCs2dWY0wU+wL1707Q=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AKAABMjfhbh0O0hNFjFgQBAQEBAQIBA?=
 =?us-ascii?q?QEBBwIBAQEBgVEFAQEBAQsBgmmBAieIfoMTjACCDRRmjQmJOBSBWQYPHQsIAYh?=
 =?us-ascii?q?aIjQJDQEDAQEBAQEBAgETAQEBCA0JCCkjDII2JIJjAQICAQECJFIGCQEBCg4TJ?=
 =?us-ascii?q?QMMBRgxEwUWgwYBgXkIBAEKp1ozigwPgm2JHBeBf4ERgl01gxALA4Elg3CCJgK?=
 =?us-ascii?q?LEZRxCYIghFyKKCMKVXpNhD6KJI1DjDOCDTMaCDCDJwmCHheDSiiKKz4zAQGBA?=
 =?us-ascii?q?wEBjCEBAQ?=
X-IPAS-Result: =?us-ascii?q?A0AKAABMjfhbh0O0hNFjFgQBAQEBAQIBAQEBBwIBAQEBgVE?=
 =?us-ascii?q?FAQEBAQsBgmmBAieIfoMTjACCDRRmjQmJOBSBWQYPHQsIAYhaIjQJDQEDAQEBA?=
 =?us-ascii?q?QEBAgETAQEBCA0JCCkjDII2JIJjAQICAQECJFIGCQEBCg4TJQMMBRgxEwUWgwY?=
 =?us-ascii?q?BgXkIBAEKp1ozigwPgm2JHBeBf4ERgl01gxALA4Elg3CCJgKLEZRxCYIghFyKK?=
 =?us-ascii?q?CMKVXpNhD6KJI1DjDOCDTMaCDCDJwmCHheDSiiKKz4zAQGBAwEBjCEBAQ?=
X-IronPort-AV: E=Sophos;i="5.56,271,1539673200"; 
   d="asc'?scan'208";a="53125112"
X-Amp-Result: UNKNOWN
X-Amp-Original-Verdict: FILE UNKNOWN
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 23 Nov 2018 15:33:17 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727875AbeKXKT1 (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Sat, 24 Nov 2018 05:19:27 -0500
Received: from atrey.karlin.mff.cuni.cz ([195.113.26.193]:40933 "EHLO
        atrey.karlin.mff.cuni.cz" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727607AbeKXKT1 (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sat, 24 Nov 2018 05:19:27 -0500
Received: by atrey.karlin.mff.cuni.cz (Postfix, from userid 512)
        id D46A78080F; Sat, 24 Nov 2018 00:33:07 +0100 (CET)
Date: Sat, 24 Nov 2018 00:33:09 +0100
From: Pavel Machek <pavel@ucw.cz>
To: Takashi Iwai <tiwai@suse.de>
Cc: Andy Shevchenko <andy.shevchenko@gmail.com>,
        Ayman Bagabas <ayman.bagabas@gmail.com>,
        ALSA Development Mailing List <alsa-devel@alsa-project.org>,
        Hui Wang <hui.wang@canonical.com>,
        Andy Shevchenko <andy@infradead.org>,
        Darren Hart <dvhart@infradead.org>,
        Jaroslav Kysela <perex@perex.cz>,
        Kailang Yang <kailang@realtek.com>,
        Linux Kernel Mailing List <linux-kernel@vger.kernel.org>,
        Platform Driver <platform-driver-x86@vger.kernel.org>
Subject: Re: [PATCH v3 3/3] ALSA: hda: add support for Huawei WMI micmute LED
Message-ID: <20181123233309.GA4340@amd>
References: <s5hr2fgfcrm.wl-tiwai@suse.de>
 <20181120091039.GA16916@amd>
 <s5hbm6kf6gi.wl-tiwai@suse.de>
 <20181120093610.GF16916@amd>
 <s5h4lccf58f.wl-tiwai@suse.de>
 <20181120115159.GG16916@amd>
 <s5hzhu4c569.wl-tiwai@suse.de>
 <CAHp75VddanEB-7qQutSWkbSZW4srRzGXkigCMxEP7zJ=KC6iKw@mail.gmail.com>
 <20181122131802.GB13339@amd>
 <s5h8t1l5ish.wl-tiwai@suse.de>
MIME-Version: 1.0
Content-Type: multipart/signed; micalg=pgp-sha1;
        protocol="application/pgp-signature"; boundary="C7zPtVaVf+AK4Oqc"
Content-Disposition: inline
In-Reply-To: <s5h8t1l5ish.wl-tiwai@suse.de>
User-Agent: Mutt/1.5.23 (2014-03-12)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org


--C7zPtVaVf+AK4Oqc
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
Content-Transfer-Encoding: quoted-printable

Hi!

> > > > > > > You have general-purpose LED, yet you are treating it as "som=
ething
> > > > > > > special". That means ugly code (quoted above) and lack of fle=
xibility.
> > > > > > >

> > I'd prefer this to be normal LED and "mic muted" to become normal
> > trigger.
>=20
> But how would you solve the existing problem?
>=20
> As already mentioned, you'll need to hook the LED trigger and the
> actual mixer value change.  This is the biggest missing piece, and
> it's the very reason we have the exported symbol from the platform
> driver side.
>=20
> So, if you prefer in that way, please implement that for the existing
> driver (thinkpad_acpi and dell-laptop) at first.  I'll be really happy
> to get rid of the present ugly solution!  But it's been there just
> because it's not so trivial at all.  FWIW, this must be all done
> inside the kernel; otherwise you'll hit a regression.

Ok, what about something like this?

Tested, and it did not work. I guess I hooked it up at the wrong place
in LED subsystem... or maybe thinkpad x60 is wrong machine to test on.

Anyway, it looks less ugly than current code in alsa. We should not
really be using mixer settings to turn LED on and off.

Plus, it works in similar way triggers and LEDs "usually" do, and has
all the flexibility.

Signed-off-by: Pavel Machek <pavel@ucw.cz>

commit e7d6d170f2f45ea7a42c9ebb31869f440382e3ad

    leds: ledtrig-sound: provide indication of muted microphone
   =20
    Signed-off-by: Pavel Machek <pavel@ucw.cz>

diff --git a/drivers/leds/trigger/Makefile b/drivers/leds/trigger/Makefile
index 9bcb64e..c5ea19e 100644
--- a/drivers/leds/trigger/Makefile
+++ b/drivers/leds/trigger/Makefile
@@ -14,3 +14,4 @@ obj-$(CONFIG_LEDS_TRIGGER_CAMERA)	+=3D ledtrig-camera.o
 obj-$(CONFIG_LEDS_TRIGGER_PANIC)	+=3D ledtrig-panic.o
 obj-$(CONFIG_LEDS_TRIGGER_NETDEV)	+=3D ledtrig-netdev.o
 obj-$(CONFIG_LEDS_TRIGGER_PATTERN)	+=3D ledtrig-pattern.o
+obj-y					+=3D ledtrig-sound.o
diff --git a/drivers/leds/trigger/ledtrig-sound.c b/drivers/leds/trigger/le=
dtrig-sound.c
new file mode 100644
index 0000000..608df35
--- /dev/null
+++ b/drivers/leds/trigger/ledtrig-sound.c
@@ -0,0 +1,23 @@
+/* GPLv2+.
+ * Copyright 2018 Pavel Machek <pavel@ucw.cz>
+ */
+
+#include <linux/kernel.h>
+#include <linux/init.h>
+#include <linux/leds.h>
+
+DEFINE_LED_TRIGGER(ledtrig_micmute);
+
+void ledtrig_mic_muted(bool muted)
+{
+	led_trigger_event(ledtrig_micmute, muted ? LED_FULL : LED_OFF);
+}
+EXPORT_SYMBOL(ledtrig_mic_muted);
+
+static int __init ledtrig_micmute_init(void)
+{
+	led_trigger_register_simple("mic-muted", &ledtrig_micmute);
+
+	return 0;
+}
+device_initcall(ledtrig_micmute_init);
diff --git a/include/linux/leds.h b/include/linux/leds.h
index e4a9a00..c30e1cb 100644
--- a/include/linux/leds.h
+++ b/include/linux/leds.h
@@ -494,6 +494,14 @@ static inline void ledtrig_cpu(enum cpu_led_event evt)
 }
 #endif
=20
+#ifdef CONFIG_LEDS_TRIGGERS
+extern void ledtrig_mic_muted(bool m);
+#else
+static inline void ledtrig_mic_muted(bool m) {}
+#endif
+
+
+
 #ifdef CONFIG_LEDS_BRIGHTNESS_HW_CHANGED
 extern void led_classdev_notify_brightness_hw_changed(
 	struct led_classdev *led_cdev, enum led_brightness brightness);
diff --git a/sound/pci/hda/hda_generic.c b/sound/pci/hda/hda_generic.c
index 276150f..3ec1f61 100644
--- a/sound/pci/hda/hda_generic.c
+++ b/sound/pci/hda/hda_generic.c
@@ -29,6 +29,7 @@
 #include <linux/string.h>
 #include <linux/bitops.h>
 #include <linux/module.h>
+#include <linux/leds.h>
 #include <sound/core.h>
 #include <sound/jack.h>
 #include <sound/tlv.h>
@@ -3929,6 +3930,7 @@ static void call_micmute_led_update(struct hda_codec =
*codec)
 		val =3D !spec->micmute_led.capture;
 		break;
 	}
+	ledtrig_mic_muted(!spec->micmute_led.capture);
=20
 	if (val =3D=3D spec->micmute_led.led_value)
 		return;
diff --git a/sound/pci/hda/thinkpad_helper.c b/sound/pci/hda/thinkpad_helpe=
r.c
index 568575b..f1b2265 100644
--- a/sound/pci/hda/thinkpad_helper.c
+++ b/sound/pci/hda/thinkpad_helper.c
@@ -23,6 +23,8 @@ static void update_tpacpi_mute_led(void *private_data, in=
t enabled)
 	if (old_vmaster_hook)
 		old_vmaster_hook(private_data, enabled);
=20
+	printk("mute led... %d\n", !enabled);
+
 	if (led_set_func)
 		led_set_func(TPACPI_LED_MUTE, !enabled);
 }


--=20
(english) http://www.livejournal.com/~pavelmachek
(cesky, pictures) http://atrey.karlin.mff.cuni.cz/~pavel/picture/horses/blo=
g.html

--C7zPtVaVf+AK4Oqc
Content-Type: application/pgp-signature; name="signature.asc"
Content-Description: Digital signature

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1

iEYEARECAAYFAlv4jjUACgkQMOfwapXb+vJAGgCeMG4/q2ENCFEKzXy0t38q3MXG
SXEAoJ1ul32RBQTk3ftSyS1sCDHRevmK
=xYkY
-----END PGP SIGNATURE-----

--C7zPtVaVf+AK4Oqc--
