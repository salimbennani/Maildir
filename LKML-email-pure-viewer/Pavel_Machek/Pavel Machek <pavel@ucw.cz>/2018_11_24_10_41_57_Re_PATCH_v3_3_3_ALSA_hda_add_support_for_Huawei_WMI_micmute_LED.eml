Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 25 Nov 2018 14:41:58 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga006.jf.intel.com (orsmga006.jf.intel.com [10.7.209.51])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 57E155803EB;
	Sat, 24 Nov 2018 02:44:06 -0800 (PST)
Received: from orsmga106.jf.intel.com ([10.7.208.65])
  by orsmga006-1.jf.intel.com with ESMTP; 24 Nov 2018 02:44:06 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AQZM4jRNUB5hcg17DvAAl6mtUPXoX/o7sNwtQ0KIM?=
 =?us-ascii?q?zox0KPn4pcbcNUDSrc9gkEXOFd2Cra4c26yO6+jJYi8p2d65qncMcZhBBVcuqP?=
 =?us-ascii?q?49uEgeOvODElDxN/XwbiY3T4xoXV5h+GynYwAOQJ6tL1LdrWev4jEMBx7xKRR6?=
 =?us-ascii?q?JvjvGo7Vks+7y/2+94fcbglUhzexe69+IAmrpgjNq8cahpdvJLwswRXTuHtIfO?=
 =?us-ascii?q?pWxWJsJV2Nmhv3+9m98p1+/SlOovwt78FPX7n0cKQ+VrxYES8pM3sp683xtBnM?=
 =?us-ascii?q?VhWA630BWWgLiBVIAgzF7BbnXpfttybxq+Rw1DWGMcDwULs5Qiqp4bt1RxD0iS?=
 =?us-ascii?q?cHLz85/3/Risxsl6JQvRatqwViz4LIfI2ZMfxzcaTAc9MHXmpBRtheWDBdAo2y?=
 =?us-ascii?q?aIsPCvAOPeder4Lgo1cDoh+zCQyqCejyyDFHm2X20LU03eohDw/IwQ8uH9wBv3?=
 =?us-ascii?q?vIsdr6NqkdUfutzKTK1jjDYO9a1C3n5YTUaB0tv/eBVq9wf8rLzkkvEhvIgE+K?=
 =?us-ascii?q?poz7ITyV0vkGvW+B4OV8VeKglW0noBx2rzi33MgslJfGhoYOx1DZ6Sp4zpw5Ks?=
 =?us-ascii?q?G5SUNiZ9OvDZVetyafN4RsQ8MiRXlluCI7yr0Yp5G7fi8KyIk9xx7ZcfOHd5KE?=
 =?us-ascii?q?7Q7kVOaUOTt3mG9leLS+hxqo7Uehy+vxXdS33lZStidJjMXAu3QX2xDO5MWLVO?=
 =?us-ascii?q?Fx8lqi1DqTzQze6+NJLVgpmaffK5Mt2KM8mocdvEjZACP7mV/6gLKSe0gq/OWj?=
 =?us-ascii?q?9v7pba/8ppCGMo95kgH+Pboqmsy4Gek4LAcOUHaB+eim173s41f5QLNUgf0yiK?=
 =?us-ascii?q?XZt4raJcsDqq64BQ9azJoj5g6hAzu61NkUh2QLIVxbdB6dkoTkOE3CLOr5APq9?=
 =?us-ascii?q?m1islS1kx/HCPr3vGJXNKX3Dna/lfbZ87U5c1QUywclc551KELEBJuz8WkvouN?=
 =?us-ascii?q?zfAB45NRK7w/z8BdVj2YMRR3iPDrWaMKzMq1+I4PwgI+2WaI8Sojb9JOAp5+Ty?=
 =?us-ascii?q?gn8hhV8dYa6p0IMTaHC5HfRpPV+VYHXxgtoaFWcKvww+TPHliVGYUD5TYWqyUL?=
 =?us-ascii?q?w45j0hFI2mCoLDTJi3gLOdxCe7AoFWZmdeB1CMC3jodpmEVO0LaC6IIs9hjyYL?=
 =?us-ascii?q?Vb6uS4I60RGutQn6y6doL+bO+y0Ys47j28Zx5+HJiR4y8jl0BdyH026RV2F0gn?=
 =?us-ascii?q?8IRzgu0aB9pkxy1E2P0at/g/xeE9xT4OhEUgM7NZ7a0ux7BMr+WgPHfteVVlmm?=
 =?us-ascii?q?Rs+qDi02TtI029UOeVpyG82+jhDf2CqnG6Ual6eLBJwz8aLQxWLxKNx/y3vd0K?=
 =?us-ascii?q?khjl8mQtZANGG8h65/8RTTCJDNk0mDi6mqcqEc1jbX9Gif1WqOoF1YUAloXKXG?=
 =?us-ascii?q?R38fYFHardD45kzYSb+uBq8qMg9Ayc6EN6tLZcfljVRARPf/JtveZ3i9lHu3BR?=
 =?us-ascii?q?aN3rmMdpble30B3CXBD0gJix0c8myYNQcgHCuho3jRDDp1FV3xZUPg9u1+qHC+?=
 =?us-ascii?q?Tk8w1AyKa0xh17yo+h8an/CcSvUT3q4atyclsTl7AFG939fOAdqauwVhZLlcYc?=
 =?us-ascii?q?864FpfyG3WrRJ9MYK6I6BinFEedR93sF3o1xhsDoVAkM4qrG4lzQZoKKKY1k9B?=
 =?us-ascii?q?eC2c3ZzqJrLXLWzy9gi1a6HKwlHezMqW+qAX5fQkqlXjuQapFlYi83RnydVVz2?=
 =?us-ascii?q?GQ5pLQDAoWUJLxVEk3+gN+p7HbZCk9+ozV2WdtMamyrj/NxdYpCPE5xRanetdV?=
 =?us-ascii?q?KLmEGxPqE80GG8iuL/QnlEKtbh0aM+Fd6q41M9m9ePubxaGkJuBgnDGhjWRZ+4?=
 =?us-ascii?q?191kOM9yxhSu/HxZoFwveY3heZWDf4lluursf3mYVcbzEIAmW/0TTkBJJWZqBq?=
 =?us-ascii?q?fYcLFH2iLNGtytR/h57iQXhY9FG4ClMC2c+pfweSblPn0Q1R00QXvWKomS+iwz?=
 =?us-ascii?q?NolDEpq7KV3DbSzOT6aBoHJmlLSXF4jVftPYe7lcoaU1WvbwQzkhuq+1z6x6lC?=
 =?us-ascii?q?qKtjNWbTRVpHcDbsL2FlVKu9rb6CY89J6JM1viRbSuW8YVaGSrHjpxsWyT/sH2?=
 =?us-ascii?q?xbxDojbTGlpo35nwBmiGKaNHtyrHvZddtwxBvF/9zcWPhR0yECRCl5jznXG1e9?=
 =?us-ascii?q?M8Oo/dWSi5fMrOS+W3i9WZ1UdCnh1ZmAuzej5W12HR2/mOi+mt/9Hggg0i/71N?=
 =?us-ascii?q?5qWT/TrBnmYYnr1KW6MeR5cUluH1L878t6Godjkoo/np0Q2H4ahomL8noDi2v8?=
 =?us-ascii?q?LdJb2afmZnoXWTEL28LV4BTi2EB7LnOG3YX5Wm+fwstgYdm3eWcW2iM778BXB6?=
 =?us-ascii?q?aY9r1EnS1polWmqQLde+RynjAYyfE28n4Vn/kJuBYxziWaGr0SHlNXPS32mxSI?=
 =?us-ascii?q?8tCxtqNXZGm0fLi01Up+m82hDb6YrgFdXnb5ZoktHStq4spjN1LM1WX56pv4d9?=
 =?us-ascii?q?nIcdITqhqUng/Fj+hUK5I+jOAGhCR5NmLmoX0q1fQ7ggdw0pGgs4iKMGFt/KO/?=
 =?us-ascii?q?Ah5FOTz5fcIT+jfxjalAmsaaxZygHpJkGj8TRpvnUeqoEC4OtfTgLwuODDo8qn?=
 =?us-ascii?q?KBFbveBwCf7lpmr2nUE5CqLHyXIHgZzdN/RBiSPkBfgQYUXCkkkZ49DAyl2Mvh?=
 =?us-ascii?q?cEJh7DAL+lH4sgdMyv5vNxTnSWjQvgCoajMpSJSFKBpW8xpP50PUMcyY8+JyED?=
 =?us-ascii?q?tU/pynrAyRNGObYx5EAn0OWkyBH1rjJKWh5cHc8+iEAeqzN/nObq+LqeNATPeE?=
 =?us-ascii?q?346v3pFl/zaRNcWPI39iAOcg2kdYWXB5GsLZmygASiANliLNadKbqwm4+iFtss?=
 =?us-ascii?q?+/9/HrUhr15YSTE7tSLclv+xeujKaDMO6QmT95KStC2ZMK33PI078f3Fgdiyx1?=
 =?us-ascii?q?czmtELIAtTPCTa7Km69XCQIbZD13NMdS86082QxNM9bBitzpzr54kuI1C1BdWF?=
 =?us-ascii?q?zhhM6pZM8KI2K8NF/dB0aLLrOGJTLVzMHtfKO8UqZdjOFVtx22pDaaHFXvPjWF?=
 =?us-ascii?q?lzn1SR+vNftAgz2cPBxboIu9aApiCXD/TNL6bR22KMV4jSAtzr0umHzLNXQQMT?=
 =?us-ascii?q?x9c05Wqr2Q7CVYguhwGmBb73plK/WElDid7+XCNpkWtv5rCDxul+1G+HQ616dV?=
 =?us-ascii?q?7CZcSfxpmSvSq8RirE28nuaTyjpoThxOpy1PhIKKu0ViJKrY+oNBWXbC4BIC82?=
 =?us-ascii?q?GQBw4WqNtiD93lo7pQxcTXlKLvNDdC9MrZ/MsGCMjSLcKHMXwhPgLoGT7UFgQF?=
 =?us-ascii?q?SzGrOHrbh0xclvGS63KUooI7qpjqhJoBVLtbWEYpGfMdD0Q2VOAFdat+XTo/kb?=
 =?us-ascii?q?/TrdEB5DLqsBjOTcRypY3cW7SeDKO8BiyeiOx8bgUFxfvdJI8TO46zj1RrdFR+?=
 =?us-ascii?q?tJnBBAzbT4Ye8WVacgYorRAVozBFRWop1hegN1qg?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0CBAACSKflbh0O0hNFjFgQBAQEBAQIBA?=
 =?us-ascii?q?QEBBwIBAQEBgWWBW4EPgQIniH6PFIINFGaNCoslBg8dCwgBiFoiOBIBAwEBAQE?=
 =?us-ascii?q?BAQIBEwEBAQgNCQgpIwyCNiSCYwECAgEBAnYFAQkBAQoOBA8lAwwFGB0UGBaCO?=
 =?us-ascii?q?0sBgXkIBAEKqAqKDQ+CbYkcF4F/gRGCFEk1gxALA4UVgiYCixGUcQmCIIRcgy2?=
 =?us-ascii?q?GeyMKVXpNhD6KJI1DjEqBdjMaCDCDJwmCHheDSiiKKz4zAQGBAwEBjBgBAQ?=
X-IPAS-Result: =?us-ascii?q?A0CBAACSKflbh0O0hNFjFgQBAQEBAQIBAQEBBwIBAQEBgWW?=
 =?us-ascii?q?BW4EPgQIniH6PFIINFGaNCoslBg8dCwgBiFoiOBIBAwEBAQEBAQIBEwEBAQgNC?=
 =?us-ascii?q?QgpIwyCNiSCYwECAgEBAnYFAQkBAQoOBA8lAwwFGB0UGBaCO0sBgXkIBAEKqAq?=
 =?us-ascii?q?KDQ+CbYkcF4F/gRGCFEk1gxALA4UVgiYCixGUcQmCIIRcgy2GeyMKVXpNhD6KJ?=
 =?us-ascii?q?I1DjEqBdjMaCDCDJwmCHheDSiiKKz4zAQGBAwEBjBgBAQ?=
X-IronPort-AV: E=Sophos;i="5.56,273,1539673200"; 
   d="asc'?scan'208";a="41367714"
X-Amp-Result: UNSCANNABLE
X-Amp-File-Uploaded: False
Unscannable: 2
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 24 Nov 2018 02:42:04 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1726134AbeKXVaK (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Sat, 24 Nov 2018 16:30:10 -0500
Received: from atrey.karlin.mff.cuni.cz ([195.113.26.193]:55305 "EHLO
        atrey.karlin.mff.cuni.cz" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1725959AbeKXVaK (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sat, 24 Nov 2018 16:30:10 -0500
Received: by atrey.karlin.mff.cuni.cz (Postfix, from userid 512)
        id 032A680977; Sat, 24 Nov 2018 11:41:55 +0100 (CET)
Date: Sat, 24 Nov 2018 11:41:57 +0100
From: Pavel Machek <pavel@ucw.cz>
To: Takashi Iwai <tiwai@suse.de>
Cc: Andy Shevchenko <andy.shevchenko@gmail.com>,
        Ayman Bagabas <ayman.bagabas@gmail.com>,
        ALSA Development Mailing List <alsa-devel@alsa-project.org>,
        Hui Wang <hui.wang@canonical.com>,
        Andy Shevchenko <andy@infradead.org>,
        Darren Hart <dvhart@infradead.org>,
        Jaroslav Kysela <perex@perex.cz>,
        Kailang Yang <kailang@realtek.com>,
        Linux Kernel Mailing List <linux-kernel@vger.kernel.org>,
        Platform Driver <platform-driver-x86@vger.kernel.org>
Subject: Re: [PATCH v3 3/3] ALSA: hda: add support for Huawei WMI micmute LED
Message-ID: <20181124104157.GA17954@amd>
References: <s5hbm6kf6gi.wl-tiwai@suse.de>
 <20181120093610.GF16916@amd>
 <s5h4lccf58f.wl-tiwai@suse.de>
 <20181120115159.GG16916@amd>
 <s5hzhu4c569.wl-tiwai@suse.de>
 <CAHp75VddanEB-7qQutSWkbSZW4srRzGXkigCMxEP7zJ=KC6iKw@mail.gmail.com>
 <20181122131802.GB13339@amd>
 <s5h8t1l5ish.wl-tiwai@suse.de>
 <20181123233309.GA4340@amd>
 <s5hftvq99qe.wl-tiwai@suse.de>
MIME-Version: 1.0
Content-Type: multipart/signed; micalg=pgp-sha1;
        protocol="application/pgp-signature"; boundary="SUOF0GtieIMvvwua"
Content-Disposition: inline
In-Reply-To: <s5hftvq99qe.wl-tiwai@suse.de>
User-Agent: Mutt/1.5.23 (2014-03-12)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org


--SUOF0GtieIMvvwua
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
Content-Transfer-Encoding: quoted-printable

Hi!

> > > > > > > > > You have general-purpose LED, yet you are treating it as =
"something
> > > > > > > > > special". That means ugly code (quoted above) and lack of=
 flexibility.
> > > > > > > > >
> >=20
> > > > I'd prefer this to be normal LED and "mic muted" to become normal
> > > > trigger.
> > >=20
> > > But how would you solve the existing problem?
> > >=20
> > > As already mentioned, you'll need to hook the LED trigger and the
> > > actual mixer value change.  This is the biggest missing piece, and
> > > it's the very reason we have the exported symbol from the platform
> > > driver side.
> > >=20
> > > So, if you prefer in that way, please implement that for the existing
> > > driver (thinkpad_acpi and dell-laptop) at first.  I'll be really happy
> > > to get rid of the present ugly solution!  But it's been there just
> > > because it's not so trivial at all.  FWIW, this must be all done
> > > inside the kernel; otherwise you'll hit a regression.
> >=20
> > Ok, what about something like this?
> >=20
> > Tested, and it did not work. I guess I hooked it up at the wrong place
> > in LED subsystem... or maybe thinkpad x60 is wrong machine to test on.

I meant to say "wrong place in ALSA subsystem".

> > Anyway, it looks less ugly than current code in alsa. We should not
> > really be using mixer settings to turn LED on and off.
> >=20
> > Plus, it works in similar way triggers and LEDs "usually" do, and has
> > all the flexibility.
>=20
> Yes, thanks, that's something similar as what I had in mind, too.
> I guess it's just a matter of thinkpad_acpi side implementation that
> differs from your expectation.
>=20
> However, one remaining problem is that the state will be inconsistent
> depending on the driver module order, if we get rid of the dynamic
> symbol binding.  Then both modules become completely individual and
> thinkpad_acpi can be loaded at anytime later than HD-audio codec.
> If a mixer state is already changed before loading thinkpad_acpi, this
> event is lost and the state may be different in both sides.



> So, we'd need to record the state in the mute-trigger side, and add a
> function to return the current state.  Then thinkpad_acpi will query
> the state at the initialization time.

We want to record state at mute-trigger side, yes. Should not be
really different from other triggers.

> Also, we'll need also the normal mute LED in addition to the mic mute
> LED, so there need to be two triggers.

Yes.

> In anyway, moving to this direction requires the leds class
> implementation for dell-laptop.c as well as the new huawei stuff.  So,
> I'd really like to have the "already good working" code before
> actually hacking this, so that we can see and track the functional
> regression more obviously.

As well as thinkpad; note I did not do that part, because I don't have
that LED on my test machine.

Anyway, normally we get the architecture right and only then we merge
the drivers.

All Huawei hackers need to do is to convert their driver into normal
LED driver, and test it with some other trigger (like heartbeat). Then
we can be fairly sure it will work when we get the micmute done.

> I can start hacking this in the next week.  At least I have a Dell
> laptop and I can check the part of the changes locally.
>=20
> Since the changes will be fairly cross-tree, it's better to have an
> immutable branch to start with.  I'd branch off at 4.20-rc3 (or rc4),
> apply the current patches, so that it can be merged to all relevant
> trees cleanly.

As you will not change any core LED code, I don't think any heavy
synchronization with LED tree should be neccessary. We have LED
triggers living outside drivers/leds/triggers, too, such as
drivers/usb/common/led.c .

(Actually, that's the beauty of the LED subsystem. You have standard
trigger. You have standard LED -- which says it prefers that trigger if
available. They are really independend, so you can test and merge them
separately).

Let me know if you need any more help.

Best regards,
									Pavel
--=20
(english) http://www.livejournal.com/~pavelmachek
(cesky, pictures) http://atrey.karlin.mff.cuni.cz/~pavel/picture/horses/blo=
g.html

--SUOF0GtieIMvvwua
Content-Type: application/pgp-signature; name="signature.asc"
Content-Description: Digital signature

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1

iEYEARECAAYFAlv5KvUACgkQMOfwapXb+vIWUACgo9XFD+cSHR467QJO5t/Qxr8N
FqQAmwbVs/CvpqDfPYzkubV/vFMCztZq
=xDts
-----END PGP SIGNATURE-----

--SUOF0GtieIMvvwua--
