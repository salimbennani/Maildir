Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 25 Nov 2018 22:12:58 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga006.fm.intel.com (fmsmga006.fm.intel.com [10.253.24.20])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id C0054580474;
	Sun, 25 Nov 2018 02:22:36 -0800 (PST)
Received: from fmsmga105.fm.intel.com ([10.1.193.10])
  by fmsmga006-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 25 Nov 2018 02:22:36 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3A4TgiIhf9ujYg6fqR5ekpqshLlGMj4u6mDksu8pMi?=
 =?us-ascii?q?zoh2WeGdxc6/YRyN2/xhgRfzUJnB7Loc0qyK6/CmATRIyK3CmUhKSIZLWR4BhJ?=
 =?us-ascii?q?detC0bK+nBN3fGKuX3ZTcxBsVIWQwt1Xi6NU9IBJS2PAWK8TW94jEIBxrwKxd+?=
 =?us-ascii?q?KPjrFY7OlcS30P2594HObwlSizexfbB/IA+qoQnNq8IbnZZsJqEtxxXTv3BGYf?=
 =?us-ascii?q?5WxWRmJVKSmxbz+MK994N9/ipTpvws6ddOXb31cKokQ7NYCi8mM30u683wqRbD?=
 =?us-ascii?q?VwqP6WACXWgQjxFFHhLK7BD+Xpf2ryv6qu9w0zSUMMHqUbw5Xymp4rx1QxH0li?=
 =?us-ascii?q?gIKz858HnWisNuiqJbvAmhrAF7z4LNfY2ZKOZycqbbcNwdWGRBQ91RVzRfDYyg?=
 =?us-ascii?q?c4sBAe0BPeNCoIn8oVsFsB+yCAaoCe/qzDJDm3340rAg0+k5Hw/I3BIuEc8Nvn?=
 =?us-ascii?q?Tao9r6KLodXuK7w6nT1TXObehb2Tjh5IXSaB0tveuBUax2fMHMyUcvDQTFjlCI?=
 =?us-ascii?q?pIL/JTyVyPoCs2yG5ORnT+2gl24npB9yojOywcoskpPGhpwLxVDA7ih53Zo6JN?=
 =?us-ascii?q?OiREFnYN+pCZ1dvDyUOYtxR8MtWWBouCAix70CuJ67YjYFyJYgxx7CcfyHdZKH?=
 =?us-ascii?q?4hb5WOmNJjd4gWppd66ihxa08Eis0PHzV8iy3V1XrSRFisHBum4R2xHX8MSLV/?=
 =?us-ascii?q?Vw8lm71TqS1A3f9vtILEE2mKbDNpIsxr49moAOvUjeECL6glv6ga6Mekk5/uWl?=
 =?us-ascii?q?5eLqaaj8qJCGLY97kAT+P7wumsOhBeQ4NRADX3aU+euizr3v5075T6tQjv0wjK?=
 =?us-ascii?q?bZtIrWJcMBpq62GwNV04Aj5AijDzq+ztgUgX0KIEhYdB+JkYTlIUzCLfPkAful?=
 =?us-ascii?q?glmhki9nx/XcMb3gBpXNIGLDkLDkfbtl705cyQwzzc1Q5p5NCbEOPujzWknvu9?=
 =?us-ascii?q?zcFxM5NAK1w+D5B9VnzY4eR22PDbGDMK/Isl+H+PgvI++Sa48Rojr9LOIl5/H2?=
 =?us-ascii?q?gX8jhVAdZbWp3YcQaH2gGvRmIkaZbmT2jtYODGcHpQ4+TO3siF2fXj9ffXeyX6?=
 =?us-ascii?q?Qg5j4lDIKqF5vMRoeogLaZxie0AoVWZnxaClCLCXrod5+LW/YQaC2IJc9tiDwE?=
 =?us-ascii?q?VaW7RI8n2hGjrwv6y7thLurJ9SwUr5Pj1N5p5+LNkRE+7yB7D8OY02uVVWF7gn?=
 =?us-ascii?q?sIRyMq3KB4uUF9yFCD3rZij/xbEtxT4fVJUgAhOJ7Yzux6Dc3yWw3bcteITlam?=
 =?us-ascii?q?XsupATUrQt0txN8OZl53G8++gRDbwyqqH7gVmqSRC5wv8qLc2HvxK9xny3nc1q?=
 =?us-ascii?q?kslF0mQspJNW27ia9z7QnTB4jVk0qHk6amb7gT3CnI9G2b12qBoFlYUBJsUaXC?=
 =?us-ascii?q?RX0fZVHZrdLj6kPGTr+hE7InMgRaxM6GK6tKbMDpjFpcSPfiPtTef3y+m2OqCR?=
 =?us-ascii?q?mUwbOMaZLge38B0yXFFEgEjwcT8G6bOgckGCeuvXjSDDx0GlLpeEPj7+9+pHS/?=
 =?us-ascii?q?Tk83ygGKa1Zs1760+h4TmPydROkf3rMCuCc9tTp0GEyx0M7RC9qFvwBhZrlTYc?=
 =?us-ascii?q?sh4Fdb0mLUrxFyMYa+L698nFIecx54v0X11xppDIVNiswqrHIszApvJqOUylJB?=
 =?us-ascii?q?dzWE3Z/uPr3bMHX9/Beqa6TOwFHRzM6W+rsT6PQ/s1jjoACpFk8l83V709lU02?=
 =?us-ascii?q?GQ5onQAAoVS5LxVkc39x51p7zBZik95oXU1WBjMKWusz/C3c4pC/Uhyhq6Y9hf?=
 =?us-ascii?q?N6aEHhfoE8IGH8iuNPAqm1+xYx0eOOBd6qE1MN2mdvecw6GrIftvkyigjWRE54?=
 =?us-ascii?q?B9zFmB9y59Su7OwpYEzOuU3gqBVzfgklihttr7lpxDZTEXBmC/0zTrBJZNZq1u?=
 =?us-ascii?q?eoYGEWevI9CtytpinZLsWn5Y+0SlB1MJw8KpfRuSb1rg3Qxfz0gXoHqnmTemwD?=
 =?us-ascii?q?xwiT0msq2f3CnWyeT4aBUHInJLRHVljVr0O4i0jswVU1Kybwc0kxup/0D6yLZB?=
 =?us-ascii?q?pKR+NmXcXV1HfyzrIG58SKuwsbyCbtVL6JMptyVXTeu9bUqbSr77vxsVzSfjE3?=
 =?us-ascii?q?FCyzA8cjGgoo/5kABiiGKBMHZzq2LUeMFxxRvF5N3QX+VR3icARCRjjTnXB168?=
 =?us-ascii?q?P8Sm/NmOlpfDtPy+WHylVpFJbSbryoaAvjOh5WJ2GR2/g+yzmtr/HAg4yyD7zd?=
 =?us-ascii?q?pqVSbPrBrmeYnkzae6MeFmfkluGlD87dF3GoV/kos2mZER1mIWhpST/Xobj2jz?=
 =?us-ascii?q?Nc9X1r75bHoIXTQL2cLa4BD52E1/KXKE34L4WW+awsd7Zdm6Y2UW1zk578BLDq?=
 =?us-ascii?q?eU8bNFkTF0olq+sQLef/x9ki0Bxvsp7X4Qm/sJtxY1ziWBHrASGlFVPS/2mBSJ?=
 =?us-ascii?q?9dy+rLhXa3ypcbi/z0d+mdGhDLefogBTQnr5e5EiHTNu4cV7Kl7DzHrz6oT8ct?=
 =?us-ascii?q?nKcd0TrgGUkwvHj+VNLZIxl/kKijB9NWPzo3Il0PI7ggJ03Z6hooeHMWpt8bm9?=
 =?us-ascii?q?Ah5ZMD31eswS9ivsjaZYgsaZwYSvEo99FTUMWZviVeioHy4KtfT7KwaOFyUxqm?=
 =?us-ascii?q?ucGbraBwOe6V1pr3TSE5CwLHGXJWIUzdFjRBmbOUxejxoYXDQ8np4lCA+qwNbt?=
 =?us-ascii?q?f1t+5jAU/lT4sAdDyvp0NxnjVWfSvBynZS0zSJibMRpa9AVC51rOPMya7+JzGT?=
 =?us-ascii?q?xY/5K7oAyMLGybexpHDWUTVkOYAFDjO6Gk5cPc/OiAGuq+M/zObK2MqeNEUveH?=
 =?us-ascii?q?24mv3pF6/zqWNcWPI3piD+A92kVZRnB0AMDZmzQJSywKmCPBdc+bpBGg+iJpqs?=
 =?us-ascii?q?Cz6ujkWAXq5YGXEbtdLc1v+wyqgaeEL+ORhCF5KStB1pMR33DIzqIT3EUViyFo?=
 =?us-ascii?q?eDmgCrAAtS/LTKLNla5bFR8bayVvNMRW66IwxBVCOcneitntzL53kuY1C0tZVV?=
 =?us-ascii?q?zmgsypZdIFI2C+NFPEBUaHLreGJSfMw8H4f6y8U6BQjP5Puh20uDabFVLjPzuZ?=
 =?us-ascii?q?mznoURCvLf9DjCWBMBNCv4G9dw5nCXL/Q9L+dh27LNh3gCUszr0pnXzKL3ATMD?=
 =?us-ascii?q?hmf0NJr72d9idYgvR5G2xc4XtpN+iEmyCF7+bGLpYaq+dkAiNxl+hC+nQ116NV?=
 =?us-ascii?q?7D1YRPxygCbSst9uo1S8nuaT0DZoTBpOpShNhI+QuUViOKPZ9oRPWHre/RIN63?=
 =?us-ascii?q?mQBAoOp9d/FtLvvKVQwMDVlK3vMDdC787U/cwECsnUMs2HNn8hMRvvGDHMDQoF?=
 =?us-ascii?q?TSSkNWfQh0FGlPGS93uVroU1q5T2mZoOTKNbW0IxFv8AFktlG9kCc99LWWYCkK?=
 =?us-ascii?q?WbhcJAxnO7oBDLDJFcv4vHX/6RCPDjISyxgrxNZh9OyrT9e8BbMo7m3UB4Y1pS?=
 =?us-ascii?q?gt+MAEmDc8pKp3hZZxE5pA1o+XN+Q257j1rsdA6pyGIYCri/jEhl2UNFfe0x+W?=
 =?us-ascii?q?K0sB8MLV3QqX51zRA8?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0BqAABsdvpbh0O0hNFjFgUBAQEBAwEBA?=
 =?us-ascii?q?QcDAQEBgVIFAQEBCwGBWoEPgQIniH6PEoINFIh4hHg0iQSBbQYPHQsIAYhaIjU?=
 =?us-ascii?q?IDQEDAQEBAQEBAgETAQEBCA0JCCkjDII2JIJjAQICAQECJFIFAQkBAQohJQMMB?=
 =?us-ascii?q?Q0LMQESBYJRSwGBaQMNCAQBCqc7M4dyDYIKD4JtiRwXgX+BEYIUfoJWOgsDhRW?=
 =?us-ascii?q?CJgKJGQqFdoFFjnYuCYIghFyHCIMgIwpVek2HYYcBLI0XgQqLKwKCCTMaCDCDJ?=
 =?us-ascii?q?wmCHhcSgzgoiis+MwEBgQMBAYxqAQE?=
X-IPAS-Result: =?us-ascii?q?A0BqAABsdvpbh0O0hNFjFgUBAQEBAwEBAQcDAQEBgVIFAQE?=
 =?us-ascii?q?BCwGBWoEPgQIniH6PEoINFIh4hHg0iQSBbQYPHQsIAYhaIjUIDQEDAQEBAQEBA?=
 =?us-ascii?q?gETAQEBCA0JCCkjDII2JIJjAQICAQECJFIFAQkBAQohJQMMBQ0LMQESBYJRSwG?=
 =?us-ascii?q?BaQMNCAQBCqc7M4dyDYIKD4JtiRwXgX+BEYIUfoJWOgsDhRWCJgKJGQqFdoFFj?=
 =?us-ascii?q?nYuCYIghFyHCIMgIwpVek2HYYcBLI0XgQqLKwKCCTMaCDCDJwmCHhcSgzgoiis?=
 =?us-ascii?q?+MwEBgQMBAYxqAQE?=
X-IronPort-AV: E=Sophos;i="5.56,277,1539673200"; 
   d="asc'?scan'208";a="139444593"
X-Amp-Result: UNKNOWN
X-Amp-Original-Verdict: FILE UNKNOWN
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 25 Nov 2018 02:22:35 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727621AbeKYVNR (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Sun, 25 Nov 2018 16:13:17 -0500
Received: from atrey.karlin.mff.cuni.cz ([195.113.26.193]:59678 "EHLO
        atrey.karlin.mff.cuni.cz" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1727182AbeKYVNQ (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sun, 25 Nov 2018 16:13:16 -0500
Received: by atrey.karlin.mff.cuni.cz (Postfix, from userid 512)
        id 82C218092E; Sun, 25 Nov 2018 11:22:25 +0100 (CET)
Date: Sun, 25 Nov 2018 11:22:27 +0100
From: Pavel Machek <pavel@ucw.cz>
To: Nishad Kamdar <nishadkamdar@gmail.com>, lkundrak@v3.sk
Cc: Greg Kroah-Hartman <gregkh@linuxfoundation.org>,
        Jens Frederich <jfrederich@gmail.com>,
        Daniel Drake <dsd@laptop.org>,
        Jon Nettleton <jon.nettleton@gmail.com>,
        devel@driverdev.osuosl.org, linux-kernel@vger.kernel.org
Subject: Re: [PATCH v4] staging: olpc_dcon: olpc_dcon_xo_1.c: Switch to the
 gpio descriptor interface
Message-ID: <20181125102227.GA25471@amd>
References: <20181107124849.GA21899@nishad>
MIME-Version: 1.0
Content-Type: multipart/signed; micalg=pgp-sha1;
        protocol="application/pgp-signature"; boundary="7JfCtLOvnd9MIVvH"
Content-Disposition: inline
In-Reply-To: <20181107124849.GA21899@nishad>
User-Agent: Mutt/1.5.23 (2014-03-12)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org


--7JfCtLOvnd9MIVvH
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
Content-Transfer-Encoding: quoted-printable

Hi!

> Use the gpiod interface instead of the deprecated old non-descriptor
> interface in olpc_dcon_xo_1.c.
>=20
> Signed-off-by: Nishad Kamdar <nishadkamdar@gmail.com>

You may want to cc: lkundrak@v3.sk, he was doing great work on OLPC
lately...

Best regards,
								Pavel

> ---
> Changes in v4:
>  - Move changelog after signed-off line.
> Changes in v3:
>  - Resolve a few compilation errors.
> Changes in v2:
>  - Resolve a few compilation errors.
>  - Add a level of indirection to read and write gpios.
> ---
>  drivers/staging/olpc_dcon/olpc_dcon_xo_1.c | 90 +++++++++++-----------
>  1 file changed, 47 insertions(+), 43 deletions(-)
>=20
> diff --git a/drivers/staging/olpc_dcon/olpc_dcon_xo_1.c b/drivers/staging=
/olpc_dcon/olpc_dcon_xo_1.c
> index ff145d493e1b..80b8d4153414 100644
> --- a/drivers/staging/olpc_dcon/olpc_dcon_xo_1.c
> +++ b/drivers/staging/olpc_dcon/olpc_dcon_xo_1.c
> @@ -11,35 +11,51 @@
>  #define pr_fmt(fmt) KBUILD_MODNAME ": " fmt
> =20
>  #include <linux/cs5535.h>
> -#include <linux/gpio.h>
> +#include <linux/gpio/consumer.h>
>  #include <linux/delay.h>
> +#include <linux/i2c.h>
>  #include <asm/olpc.h>
> =20
>  #include "olpc_dcon.h"
> =20
> +enum dcon_gpios {
> +	OLPC_DCON_STAT0,
> +	OLPC_DCON_STAT1,
> +	OLPC_DCON_IRQ,
> +	OLPC_DCON_LOAD,
> +	OLPC_DCON_BLANK,
> +};
> +
> +struct dcon_gpio {
> +	const char *name;
> +	unsigned long flags;
> +};
> +
> +static const struct dcon_gpio gpios_asis[] =3D {
> +	[OLPC_DCON_STAT0] =3D { .name =3D "dcon_stat0", .flags =3D GPIOD_ASIS },
> +	[OLPC_DCON_STAT1] =3D { .name =3D "dcon_stat1", .flags =3D GPIOD_ASIS },
> +	[OLPC_DCON_IRQ] =3D { .name =3D "dcon_irq", .flags =3D GPIOD_ASIS },
> +	[OLPC_DCON_LOAD] =3D { .name =3D "dcon_load", .flags =3D GPIOD_ASIS },
> +	[OLPC_DCON_BLANK] =3D { .name =3D "dcon_blank", .flags =3D GPIOD_ASIS },
> +};
> +
> +struct gpio_desc *gpios[5];
> +
>  static int dcon_init_xo_1(struct dcon_priv *dcon)
>  {
>  	unsigned char lob;
> -
> -	if (gpio_request(OLPC_GPIO_DCON_STAT0, "OLPC-DCON")) {
> -		pr_err("failed to request STAT0 GPIO\n");
> -		return -EIO;
> -	}
> -	if (gpio_request(OLPC_GPIO_DCON_STAT1, "OLPC-DCON")) {
> -		pr_err("failed to request STAT1 GPIO\n");
> -		goto err_gp_stat1;
> -	}
> -	if (gpio_request(OLPC_GPIO_DCON_IRQ, "OLPC-DCON")) {
> -		pr_err("failed to request IRQ GPIO\n");
> -		goto err_gp_irq;
> -	}
> -	if (gpio_request(OLPC_GPIO_DCON_LOAD, "OLPC-DCON")) {
> -		pr_err("failed to request LOAD GPIO\n");
> -		goto err_gp_load;
> -	}
> -	if (gpio_request(OLPC_GPIO_DCON_BLANK, "OLPC-DCON")) {
> -		pr_err("failed to request BLANK GPIO\n");
> -		goto err_gp_blank;
> +	int ret, i;
> +	struct dcon_gpio *pin =3D &gpios_asis[0];
> +
> +	for (i =3D 0; i < ARRAY_SIZE(gpios_asis); i++) {
> +		gpios[i] =3D devm_gpiod_get(&dcon->client->dev, pin[i].name,
> +					  pin[i].flags);
> +		if (IS_ERR(gpios[i])) {
> +			ret =3D PTR_ERR(gpios[i]);
> +			pr_err("failed to request %s GPIO: %d\n", pin[i].name,
> +			       ret);
> +			return ret;
> +		}
>  	}
> =20
>  	/* Turn off the event enable for GPIO7 just to be safe */
> @@ -61,12 +77,12 @@ static int dcon_init_xo_1(struct dcon_priv *dcon)
>  	dcon->pending_src =3D dcon->curr_src;
> =20
>  	/* Set the directions for the GPIO pins */
> -	gpio_direction_input(OLPC_GPIO_DCON_STAT0);
> -	gpio_direction_input(OLPC_GPIO_DCON_STAT1);
> -	gpio_direction_input(OLPC_GPIO_DCON_IRQ);
> -	gpio_direction_input(OLPC_GPIO_DCON_BLANK);
> -	gpio_direction_output(OLPC_GPIO_DCON_LOAD,
> -			      dcon->curr_src =3D=3D DCON_SOURCE_CPU);
> +	gpiod_direction_input(gpios[OLPC_DCON_STAT0]);
> +	gpiod_direction_input(gpios[OLPC_DCON_STAT1]);
> +	gpiod_direction_input(gpios[OLPC_DCON_IRQ]);
> +	gpiod_direction_input(gpios[OLPC_DCON_BLANK]);
> +	gpiod_direction_output(gpios[OLPC_DCON_LOAD],
> +			       dcon->curr_src =3D=3D DCON_SOURCE_CPU);
> =20
>  	/* Set up the interrupt mappings */
> =20
> @@ -84,7 +100,7 @@ static int dcon_init_xo_1(struct dcon_priv *dcon)
>  	/* Register the interrupt handler */
>  	if (request_irq(DCON_IRQ, &dcon_interrupt, 0, "DCON", dcon)) {
>  		pr_err("failed to request DCON's irq\n");
> -		goto err_req_irq;
> +		return -EIO;
>  	}
> =20
>  	/* Clear INV_EN for GPIO7 (DCONIRQ) */
> @@ -125,18 +141,6 @@ static int dcon_init_xo_1(struct dcon_priv *dcon)
>  	cs5535_gpio_set(OLPC_GPIO_DCON_BLANK, GPIO_EVENTS_ENABLE);
> =20
>  	return 0;
> -
> -err_req_irq:
> -	gpio_free(OLPC_GPIO_DCON_BLANK);
> -err_gp_blank:
> -	gpio_free(OLPC_GPIO_DCON_LOAD);
> -err_gp_load:
> -	gpio_free(OLPC_GPIO_DCON_IRQ);
> -err_gp_irq:
> -	gpio_free(OLPC_GPIO_DCON_STAT1);
> -err_gp_stat1:
> -	gpio_free(OLPC_GPIO_DCON_STAT0);
> -	return -EIO;
>  }
> =20
>  static void dcon_wiggle_xo_1(void)
> @@ -180,13 +184,13 @@ static void dcon_wiggle_xo_1(void)
> =20
>  static void dcon_set_dconload_1(int val)
>  {
> -	gpio_set_value(OLPC_GPIO_DCON_LOAD, val);
> +	gpiod_set_value(gpios[OLPC_DCON_LOAD], val);
>  }
> =20
>  static int dcon_read_status_xo_1(u8 *status)
>  {
> -	*status =3D gpio_get_value(OLPC_GPIO_DCON_STAT0);
> -	*status |=3D gpio_get_value(OLPC_GPIO_DCON_STAT1) << 1;
> +	*status =3D gpiod_get_value(gpios[OLPC_DCON_STAT0]);
> +	*status |=3D gpiod_get_value(gpios[OLPC_DCON_STAT1]) << 1;
> =20
>  	/* Clear the negative edge status for GPIO7 */
>  	cs5535_gpio_set(OLPC_GPIO_DCON_IRQ, GPIO_NEGATIVE_EDGE_STS);

--=20
(english) http://www.livejournal.com/~pavelmachek
(cesky, pictures) http://atrey.karlin.mff.cuni.cz/~pavel/picture/horses/blo=
g.html

--7JfCtLOvnd9MIVvH
Content-Type: application/pgp-signature; name="signature.asc"
Content-Description: Digital signature

-----BEGIN PGP SIGNATURE-----
Version: GnuPG v1

iEYEARECAAYFAlv6d+MACgkQMOfwapXb+vI8vQCfaulEg6M9u3s3r49J+kTsofdu
0awAnjQJ9HWAKKb/JmXZnIl21GY79ZoJ
=iBOB
-----END PGP SIGNATURE-----

--7JfCtLOvnd9MIVvH--
