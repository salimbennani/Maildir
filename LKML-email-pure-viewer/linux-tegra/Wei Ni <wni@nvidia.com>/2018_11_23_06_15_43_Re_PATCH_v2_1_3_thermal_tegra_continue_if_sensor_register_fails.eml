Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 15:31:27 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga004.jf.intel.com (orsmga004.jf.intel.com [10.7.209.38])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 5851058040F;
	Thu, 22 Nov 2018 22:15:54 -0800 (PST)
Received: from orsmga106.jf.intel.com ([10.7.208.65])
  by orsmga004-1.jf.intel.com with ESMTP; 22 Nov 2018 22:15:54 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AcXECzBM12yHIQBisvMAl6mtUPXoX/o7sNwtQ0KIM?=
 =?us-ascii?q?zox0KPn6o8bcNUDSrc9gkEXOFd2Cra4c26yO6+jJYi8p2d65qncMcZhBBVcuqP?=
 =?us-ascii?q?49uEgeOvODElDxN/XwbiY3T4xoXV5h+GynYwAOQJ6tL1LdrWev4jEMBx7xKRR6?=
 =?us-ascii?q?JvjvGo7Vks+7y/2+94fcbglUhzexe69+IAmrpgjNq8cahpdvJLwswRXTuHtIfO?=
 =?us-ascii?q?pWxWJsJV2Nmhv3+9m98p1+/SlOovwt78FPX7n0cKQ+VrxYES8pM3sp683xtBnM?=
 =?us-ascii?q?VhWA630BWWgLiBVIAgzF7BbnXpfttybxq+Rw1DWGMcDwULs5Qiqp4bt1RxD0iS?=
 =?us-ascii?q?cHLz85/3/Risxsl6JQvRatqwViz4LIfI2ZMfxzdb7fc9wHX2pMRttfWTJPAo28?=
 =?us-ascii?q?bIUBAeQOMulaoIn8u1QAogC+BRGuCe701j9FhGX70bEm3+kvEwzL2hErEdIUsH?=
 =?us-ascii?q?TTqdX4LKcdXv60zKLV1TvDbu5d1DDz6YjOcxAsuveMXaxxccXMyEkgDRnJgUmX?=
 =?us-ascii?q?qYzgJj6Y0PkGvWuD7+d4S+6jl2oqpxtsrjWh2MsgkJTFi4EJxlze9Ch0wp45Kc?=
 =?us-ascii?q?CkREJhfNKoDpRduzuHO4dsQs4uW39ktDs7x7Ecp5K3YisHxI46yxLBdvCLaYmF?=
 =?us-ascii?q?7xLlWe2MOzl3nmhld6i6hxuq8Uiv1On8Vs6s3VZUoSpKjMPMumoO1xPN8MiHTO?=
 =?us-ascii?q?Vy/kO71TaIzQDT5flIIUEylaXFN54s2qA8moYXvEjZAyP7llv6gLWLekgn5uSk?=
 =?us-ascii?q?8eXqb7f+qp+ZLYB0iwX+Mqo0msy4BOQ1KgwOX2md+eSh27zv5E75T6tQjv0wjK?=
 =?us-ascii?q?bZtInWJcMVp66/HQBVyJ0u6wiwDzi4ytQUh3oHI0xfeBKBkYfpP0vCIPfiDfew?=
 =?us-ascii?q?m1isiitkx+jaPr39BZXANnzDkLbifblj8UJdxxczwMtb55JVDLEBPf3yVlXwtN?=
 =?us-ascii?q?zeEh82LQi0z/z7B9V604MUQXiPDbOBMKPOrV+I4foiI+mWa48UpDbyMf8l6+Tu?=
 =?us-ascii?q?jX8kg1Ade6ap0IATaHC5GPRmPkqYbWDtgtcHDWcFoA4+QPb2h12FVD5Zf2yyUL?=
 =?us-ascii?q?4k5jEnFIKmCp/ORoKqgLOfxiu7HZpWZmZAClCLCnroc4SEW/ERaCOdOMNhkzoE?=
 =?us-ascii?q?VaS/RI8lzx2hqAj6y79/JOrO5iIYrY7j1MRy5+DLjx4y7jx0D8Oe022XVWF7hG?=
 =?us-ascii?q?EISiQy3KB+p0x911iC3bJ5g/xeCdxc+fdJXh0mOp7byuxwE8ryVR7ZfteVVFam?=
 =?us-ascii?q?Rc2rATIrQdI32dMOZ0d9FM+kjhDMxCeqB74Vl7qWBJ076K7c3n7xJ9pjxHbCzq?=
 =?us-ascii?q?Uuk14mQs5XP228mqF/7xTTB5LOk0iBiqmlb7oc0zDX+GeD12WOulpYXxB2UanC?=
 =?us-ascii?q?WXAfZU7WrdDi60PGTr+uD6knMwRbxc6DLKtKdsPmjVFcSPj/P9TeZnq7m32sCh?=
 =?us-ascii?q?aQ2rOMcI3qdn0A0yrHFkgLjRof/XacOgg4HSeuvWTeASdqFVLuZUPs7OZ/pGm6?=
 =?us-ascii?q?Tk8y0wGFcUlh26Cp9R4SgPyWU+kT0a4cuCc9tzV0G06w387XC9qFoAphYKVcYN?=
 =?us-ascii?q?Mn7Fdbz27ZsBZ9PpihL6BkiV4TaAB3v0Lo1xVqBYRMi8kqrHU2zAVsLaKUyk9O?=
 =?us-ascii?q?dzSd3ZroIL3YNnHy/Ayza67RwlzRytKW9bkA6fsmq1TvphqmFlc//Hp91dlV0H?=
 =?us-ascii?q?yc5ovRAQoWUJLxVFs39hdgq7HbZCk9+53b1Xl2PaaotT/C3sojBPE5xRa4Y9df?=
 =?us-ascii?q?LKSEGRfyEs0HHcShNPYmmlmpbh0eOuBS+7U5P8end/uAxa6qM/xsnDOgjWRb/o?=
 =?us-ascii?q?991liA+DZ7Su7Nx5wF2e2X3hObVzfgi1esqtr3mYFYaj4IBGqw1C/kCJRXZqJs?=
 =?us-ascii?q?Z4YLCH6iLNGtydV6mpHiRWRY9FmlB14d3M+peBySb0Hy3AFK1EQXp2CnljW8zz?=
 =?us-ascii?q?Bujz4pqa+f1jTUw+v+bBoHJnJLRG56gFbsIIi4ldAbUFKzbwg0khuo/kL6x6ld?=
 =?us-ascii?q?pKRiIGjfW0ZIfy7qL258Vqu8rKaNY8lK6JkwqyVYTPy8YUyGSr76uxYa0TnsH3?=
 =?us-ascii?q?FdxDA4cDGmoI75kAZ5iGKeLXZzqmTWecdryBfb5dzcQ+NR3zUcSCl5jznXGkaz?=
 =?us-ascii?q?P92z8dqIkJfDt/i0V3i9WZ1LbSnr0YSAuTO75GJwBh2zhfKzmtzhEQUh1S/71t?=
 =?us-ascii?q?9qVTjHrRrmY4nr0bi6PvxjfkVyGFD87M96EJlkkoQsnJEQxWQahpKN8HoEi2jz?=
 =?us-ascii?q?MM9X2aLjbHUXQz4LzMXY4Azk2E1lM3KIyJj1VnSbwst9eda6Znka1T4678BPEK?=
 =?us-ascii?q?2U9qBLnTNpolqkqgLcef19njYeyfQ08nIbjf8GuBExziqDGLAdBldXPTbjlxmT?=
 =?us-ascii?q?69C+raNXZHugcLSq1Up+m8yhA6+Gog1GRHn5fZIiFzdq7spjKFLMzGHz6ob8dd?=
 =?us-ascii?q?nMatITsweYkhbagOhTNZIxjeEKhSt8NGL5vH0lzfM7jBN00ZG7uoiHN3ti/Kaj?=
 =?us-ascii?q?DhFEMT31YtsZ+ivxgqZGgsaWw4evE416FToRW5voSe+oHCgWtfT6LAuOFDw8qn?=
 =?us-ascii?q?GGGbvQBwOf6UFmr27RHJCvLX2YOH4ZzdB6ThmHOENfmBwUXCk9npMhFACl3snh?=
 =?us-ascii?q?f1li5jwL+l70sBhMyv9rNxniVGfQvhyoZywwSJieKhpW8w5D613UMcyY8uJ8AS?=
 =?us-ascii?q?VY8oe9owyKL2yRfx5IAn0RWkyYG1DjOaGj5NnH8+iFH+q+MuHBYbOUpexFUPeI?=
 =?us-ascii?q?w52v35Bi/zaNMMWPI3ZjA+c62kpFQXB2BcDZly8TRCwQkiLHd9Sbqwuk+i1rss?=
 =?us-ascii?q?C/9+zmWALx6ouOCLtSMtRv9wq1gaeZMO6Qizh2KSxF1pMX3nLIzLkf3FgPiyBh?=
 =?us-ascii?q?bTWtELIAtTLTQ6LUgKNYExkbayZrPstS8608xhVNOdLcit7tzLF4k+U6C01bWl?=
 =?us-ascii?q?3hgM2pYc0KLnq5NFPGAkaLKbuHKSfKw8HxfaOzV7lQgP9IuB23vDaRC1XjMSib?=
 =?us-ascii?q?lzn1SxCvNvlBjD2aPBxboo2ybgxhBnTjTN34bB22K9t3jTwwwb0piXLGL28cMT?=
 =?us-ascii?q?5gc0xTqr2c9z9XgvJ6G2ZZ9HpqMfGEmzqF7+nfMpsXseFkAiJxl+Jb5nQ107pU?=
 =?us-ascii?q?7CFeS/xzlyvftdpuo1CgkumSxTtrShtOqjBXhI2VuUVuI7nW9p5FWSWMwBVYwW?=
 =?us-ascii?q?yWChkO7/9oGNbmvacYntTGkqP+LHFG/sDf9M0bL8zVLsudNzwmKxW/XHaAEAsE?=
 =?us-ascii?q?QCSxJCfFikBclv66+Xicr5x8oZ/pzt5GHrtaUkElU+8XBV5sNMINLY0xXT4+l7?=
 =?us-ascii?q?OfyskS6iztggPWQZBls5GPcPPaVerpKR6fk7hIZhJOyrT9e9dAfrbn0lBvPwEp?=
 =?us-ascii?q?1L/BHFDdCJUU+nVs?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AMAACjmvdbh0O0hNFiHAEBAQQBAQcEA?=
 =?us-ascii?q?QGBUQcBAQsBAYNqJwqDb4gYi36BYC0UlyeBcxQYEwGIUiI0CQ0BAwEBAQEBAQI?=
 =?us-ascii?q?BEwEBAQgNCQgpIwxCARABgWIkAYJiAQIDAQIgBBkBATcBBQkBAQoYAgImAgIDR?=
 =?us-ascii?q?BAGAQwBBQIBAQGDHIICBaY6cHwzgnYBAQWCQ4RQCIELiWKBHBeBQD+BOIJriAK?=
 =?us-ascii?q?CV4kbhgBDM0+OT1UJDZEcBhiJYYcnmDCBRoINcBWDJ4Ibg22KXzMBMYEFAQGEB?=
 =?us-ascii?q?YZ+gR8BAQ?=
X-IPAS-Result: =?us-ascii?q?A0AMAACjmvdbh0O0hNFiHAEBAQQBAQcEAQGBUQcBAQsBAYN?=
 =?us-ascii?q?qJwqDb4gYi36BYC0UlyeBcxQYEwGIUiI0CQ0BAwEBAQEBAQIBEwEBAQgNCQgpI?=
 =?us-ascii?q?wxCARABgWIkAYJiAQIDAQIgBBkBATcBBQkBAQoYAgImAgIDRBAGAQwBBQIBAQG?=
 =?us-ascii?q?DHIICBaY6cHwzgnYBAQWCQ4RQCIELiWKBHBeBQD+BOIJriAKCV4kbhgBDM0+OT?=
 =?us-ascii?q?1UJDZEcBhiJYYcnmDCBRoINcBWDJ4Ibg22KXzMBMYEFAQGEBYZ+gR8BAQ?=
X-IronPort-AV: E=Sophos;i="5.56,268,1539673200"; 
   d="scan'208";a="41265517"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 22 Nov 2018 22:15:52 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2502045AbeKWQ6f (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Fri, 23 Nov 2018 11:58:35 -0500
Received: from hqemgate16.nvidia.com ([216.228.121.65]:5573 "EHLO
        hqemgate16.nvidia.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1729253AbeKWQ6f (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 23 Nov 2018 11:58:35 -0500
Received: from hqpgpgate101.nvidia.com (Not Verified[216.228.121.13]) by hqemgate16.nvidia.com (using TLS: TLSv1.2, DES-CBC3-SHA)
        id <B5bf79b1c0000>; Thu, 22 Nov 2018 22:15:56 -0800
Received: from hqmail.nvidia.com ([172.20.161.6])
  by hqpgpgate101.nvidia.com (PGP Universal service);
  Thu, 22 Nov 2018 22:15:48 -0800
X-PGP-Universal: processed;
        by hqpgpgate101.nvidia.com on Thu, 22 Nov 2018 22:15:48 -0800
Received: from [10.19.225.182] (10.124.1.5) by HQMAIL101.nvidia.com
 (172.20.187.10) with Microsoft SMTP Server (TLS) id 15.0.1395.4; Fri, 23 Nov
 2018 06:15:46 +0000
Subject: Re: [PATCH v2 1/3] thermal: tegra: continue if sensor register fails
To: Daniel Lezcano <daniel.lezcano@linaro.org>,
        <thierry.reding@gmail.com>, <linux-tegra@vger.kernel.org>
CC: <rui.zhang@intel.com>, <edubezval@gmail.com>,
        <linux-kernel@vger.kernel.org>
References: <1542103567-5521-1-git-send-email-wni@nvidia.com>
 <1542103567-5521-2-git-send-email-wni@nvidia.com>
 <d212af68-fd18-74d4-d81c-ed8b3c0f136a@linaro.org>
 <70f08208-d04c-c9a4-07e6-d377c33a9386@nvidia.com>
 <d77fe117-3cde-108f-e1d7-2871f3d4c485@linaro.org>
 <5e09bc13-7880-40f2-3f90-01d2cc3510ba@nvidia.com>
 <299fc8a0-39e4-1bd9-821b-4712a7f25028@linaro.org>
From: Wei Ni <wni@nvidia.com>
Message-ID: <2f5d3135-6a25-82ce-cf3a-d804484644a1@nvidia.com>
Date: Fri, 23 Nov 2018 14:15:43 +0800
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101
 Thunderbird/60.2.1
MIME-Version: 1.0
In-Reply-To: <299fc8a0-39e4-1bd9-821b-4712a7f25028@linaro.org>
X-Originating-IP: [10.124.1.5]
X-ClientProxiedBy: HQMAIL108.nvidia.com (172.18.146.13) To
 HQMAIL101.nvidia.com (172.20.187.10)
Content-Type: text/plain; charset="utf-8"
Content-Language: en-US
Content-Transfer-Encoding: 7bit
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=nvidia.com; s=n1;
        t=1542953757; bh=yp07l0nEX789RDm4w55Eiipzgjwqnbw2WIux1O/A6OY=;
        h=X-PGP-Universal:Subject:To:CC:References:From:Message-ID:Date:
         User-Agent:MIME-Version:In-Reply-To:X-Originating-IP:
         X-ClientProxiedBy:Content-Type:Content-Language:
         Content-Transfer-Encoding;
        b=kAecckbk2w9M2lm+JBh0gD0Ehi/MOceT757KgTh4iQg5D5GcVczOoqN6mR1ugvT5Z
         pFGEcd/JLyzxsNYD1XWwMbXY4Mj/AHpUTCLjiwRTrkGS6UxzDApjIGpW2UTKfEj0MO
         vnOhHrQZvAZQkngCDvslIyZ9lq+ZddBYmknY0nGhZ10g6RMCC7CzsBnKAXQ74t0X3m
         EowMPTjB5WHhkvAZl5RVUdOD2Cwj8ektN8qo2y091tqcpVeV6ahVq2qiaWcv4D3Kkc
         eaVSM9ObOVQtzNGWLZdTsSX8rj/8pNoaNO5Ve2akFsjcO9ZCW4oNlMTcQLYWaW55Lu
         cBIfgIt7+rP5Q==
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org



On 22/11/2018 9:07 PM, Daniel Lezcano wrote:
> On 22/11/2018 08:10, Wei Ni wrote:
>>
>>
>> On 21/11/2018 8:51 PM, Daniel Lezcano wrote:
>>> On 21/11/2018 11:23, Wei Ni wrote:
>>>>
>>>>
>>>> On 21/11/2018 4:55 PM, Daniel Lezcano wrote:
>>>>> On 13/11/2018 11:06, Wei Ni wrote:
>>>>>> Don't bail when a sensor fails to register with the
>>>>>> thermal zone and allow other sensors to register.
>>>>>> This allows other sensors to register with thermal
>>>>>> framework even if one sensor fails registration.
>>>>>
>>>>> I'm not sure if ignoring the error is really safe. Can you describe the
>>>>> real situation you want to overcome ? How do you differentiate critical
>>>>> sensors ?
>>>>
>>>> The driver will always try to register 4 thermal zones, including cpu,
>>>> gpu, mem and pll, but if the dts file doesn't set the corresponding
>>>> sensors, then the register will be failed.
>>>> Normally, the dts file will set all 4 sensors, but there may have some
>>>> platform doesn't support them all. So we post this patch.
>>>
>>> Ignoring errors is not the way to go to support different platforms. Fix
>>> the DT.
>>
>> The issue isn't in DT file. The Tegra soc thermal include 4 sensors:
>> cpu, gpu, mem, pll. But in some platforms, for example, we may only need
>> to support 2 sensors, such as cpu and gpu, so we only configure these
>> two senors in DT file. But the driver will always try to register 4
>> sensors, cpu/gpu/mem/pll, so mem and pll will be registered failed. So
>> in this case we need to ignoring the failure, and continue to enable the
>> driver.
> 
> You can fix this by changing the driver to support the platform and
> register the sensor you are interested in.
> 
> Ignoring errors is not a good idea.

If hit the errors, the driver will print out the warning. In current
code, the driver probe routine will return failure directly, indeed it
didn't do anything either except print out warnings.
I think this error should not block other sensors' registration. Let's
consider this case, we have four sensors, if the one sensor register
failed, then the driver return probe failure, so the drive will not be
enabled, and other sensor can't work either, it mean the device may boot
up without any thermal sensors.
Or if the error is the -ENODEV, that mean the we didn't set
corresponding sensor id in the dt file, so we can continue to register.
If the error is other value, then we can return directly.

Wei.

> 
> 
>>>> BTW, what do you mean "critical sensors"? We will set critical trip temp
>>>> for all sensors.
>>>
>>> I meant sensor for thermal zone getting really high temperature.
>>
>> We doesn't have the critical sensors. We set the critical trip temp for
>> all registered sensors. And these trip temp is set to the Tegra
>> hardware. So it mean if the temperature reached the critical trip point,
>> then the system will be shutdown directly.
>>
>>>
>>>
>>>>>> Signed-off-by: Wei Ni <wni@nvidia.com>
>>>>>> ---
>>>>>>  drivers/thermal/tegra/soctherm.c | 8 +++++---
>>>>>>  1 file changed, 5 insertions(+), 3 deletions(-)
>>>>>>
>>>>>> diff --git a/drivers/thermal/tegra/soctherm.c b/drivers/thermal/tegra/soctherm.c
>>>>>> index ed28110a3535..a824d2e63af3 100644
>>>>>> --- a/drivers/thermal/tegra/soctherm.c
>>>>>> +++ b/drivers/thermal/tegra/soctherm.c
>>>>>> @@ -1370,9 +1370,9 @@ static int tegra_soctherm_probe(struct platform_device *pdev)
>>>>>>  							 &tegra_of_thermal_ops);
>>>>>>  		if (IS_ERR(z)) {
>>>>>>  			err = PTR_ERR(z);
>>>>>> -			dev_err(&pdev->dev, "failed to register sensor: %d\n",
>>>>>> -				err);
>>>>>> -			goto disable_clocks;
>>>>>> +			dev_warn(&pdev->dev, "failed to register sensor %s: %d\n",
>>>>>> +				 soc->ttgs[i]->name, err);
>>>>>> +			continue;
>>>>>>  		}
>>>>>>  
>>>>>>  		zone->tz = z;
>>>>>> @@ -1434,6 +1434,8 @@ static int __maybe_unused soctherm_resume(struct device *dev)
>>>>>>  		struct thermal_zone_device *tz;
>>>>>>  
>>>>>>  		tz = tegra->thermctl_tzs[soc->ttgs[i]->id];
>>>>>> +		if (!tz)
>>>>>> +			continue;
>>>>>>  		err = tegra_soctherm_set_hwtrips(dev, soc->ttgs[i], tz);
>>>>>>  		if (err) {
>>>>>>  			dev_err(&pdev->dev,
>>>>>>
>>>>>
>>>>>
>>>
>>>
> 
> 
