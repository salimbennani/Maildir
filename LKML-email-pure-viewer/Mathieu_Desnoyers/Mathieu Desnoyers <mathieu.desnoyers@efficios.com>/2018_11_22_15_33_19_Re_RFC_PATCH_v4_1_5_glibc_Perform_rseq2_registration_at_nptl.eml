Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 08:29:04 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from FMSMGA003.fm.intel.com (fmsmga003.fm.intel.com [10.253.24.29])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id C4F2358037D;
	Thu, 22 Nov 2018 07:33:26 -0800 (PST)
Received: from fmsmga102.fm.intel.com ([10.1.193.69])
  by FMSMGA003-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 22 Nov 2018 07:33:26 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3Ax9chJBTCxjux8wi3gYCTtXX+6dpsv+yvbD5Q0YIu?=
 =?us-ascii?q?jvd0So/mwa64YRGEt8tkgFKBZ4jH8fUM07OQ7/iwHzRYqb+681k6OKRWUBEEjc?=
 =?us-ascii?q?hE1ycBO+WiTXPBEfjxciYhF95DXlI2t1uyMExSBdqsLwaK+i764jEdAAjwOhRo?=
 =?us-ascii?q?LerpBIHSk9631+ev8JHPfglEnjWwba9xIRmssQndqtQdjJd/JKo21hbHuGZDdf?=
 =?us-ascii?q?5MxWNvK1KTnhL86dm18ZV+7SleuO8v+tBZX6nicKs2UbJXDDI9M2Ao/8LrrgXM?=
 =?us-ascii?q?TRGO5nQHTGoblAdDDhXf4xH7WpfxtTb6tvZ41SKHM8D6Uaw4VDK/5KpwVhTmlD?=
 =?us-ascii?q?kIOCI48GHPi8x/kqRboA66pxdix4LYeZyZOOZicq/Ye94RWGhPUdtLVyFZDI2y?=
 =?us-ascii?q?b5UBAekDMuZWsofyqEcBoxS/BQerGOPv0SdIi33t0K0m0ekuDR3K0RY8E98Mtn?=
 =?us-ascii?q?nfsdX7NL0VUeCw1KTGyi/Mb+9W2Tf89ofIbw0qr/+SUrJrd8rRzkkuGB3fjlWL?=
 =?us-ascii?q?tIfoODaV2f4Rs2ib7upvS/+vh3Q6pA5vuTivwMAsi4nXiYIP0VDJ7jt2wIg7Jd?=
 =?us-ascii?q?25VEF7YNmkEIBKuy6GMIt2R9ovTmd1syg0zb0GvIS0fCkMyJk/2RHfZfKHc4mU?=
 =?us-ascii?q?7RLiU+aROi10i25ieLK6gRu57EuuyvXkW8WqzFpHqjBJnsTCu3wTzRDf98uKRu?=
 =?us-ascii?q?dn8kqg2zuDzx3f5+BGLEwuiKbXNpEszqQtmpccr0jPBDL6lUv1gaKQa04q4PKn?=
 =?us-ascii?q?6/79bbXjvpKcN5F7igX5Mqk2hMy/Dvo3MhIUU2iY5+u8zrvj8lP9QLlQif02iK?=
 =?us-ascii?q?bZvIjbJcQduKG5HxdY3pg/5xu7FTuqzdoVkWcdIF5Yex+Lk5LlNlDMLfzgCPew?=
 =?us-ascii?q?mVWskDNlx/DcOb3hB43ALnzCkLfnYLZ85FdQyAktwtBF4ZJbFLUBLOv0Wk7/st?=
 =?us-ascii?q?zXEAU5Pheqw+boFtp9zJkSWWGRDa+DNqPdr1uI6vgoI+mWa48ZoCz9JOQ95/7y?=
 =?us-ascii?q?kX85nkcQfa2o3ZsUdn+0BPtnI1iCbHrog9cBF3oKvwUkQOzrjl2CTSBcZ3KoU6?=
 =?us-ascii?q?0g4TE7DZqsDZ3fSYC1nLyBwCC7E4VWZm9cC1CMDW3nd4KeV/cMdSKdOMlhkjMf?=
 =?us-ascii?q?WLilSo8h0wyutQDgx7pmKOrU5jMXtZb52Ndp4O3TkAk49SZoAMSFz2GNU2Z0k3?=
 =?us-ascii?q?sKRz8xwq9zu099ylCF0ah+hPxVDthT5/JPUgcnOp/Q1e16C9buWg3feteFUkqp?=
 =?us-ascii?q?QtKjATspVNI+38cOY1phG9Wllh3MxTGqA78Sl7yIHpA06LjT33rqKsZ5ynbG0r?=
 =?us-ascii?q?QhjlY8TstOM22mmrBw9wzJC4HVlEWZkr6gdb4A0y7V6GeD0W2OsVlbUAFqV6XJ?=
 =?us-ascii?q?R3QfZkrMotT/6UPPVLuuCbUhMgtcxs+OMKpKatv1jVpYQPfvIsjRY2W0m22oHx?=
 =?us-ascii?q?aH2quMbJb2e2UaxCjSFVILkx4N8nqcNQgxHCGho3nAAzxoEl7vZ0Ds8ex6qH6g?=
 =?us-ascii?q?Sk80zgeKb1Bu1rav+x4Vg+CcRO0X3r4epCghrDB0Fk6n393KE9qAuxZhfKJEbN?=
 =?us-ascii?q?wg+lhHy3zWuxZ9PpO6KaBinUARcwJsskPq1hV3DJhAkMcwoHMrygpyNbyX0Fdb?=
 =?us-ascii?q?ezyE2pDwP6XdKnPu8xC3d67Wxlbe3c6K+qcO7fQ4rEnjvAGpF0Y473Vryd5V02?=
 =?us-ascii?q?GY5pXLCgoSXon8UkI29xh8urHbbTMx54LS1X1wL6a0tiXO1M4uBOsg0hygZctQ?=
 =?us-ascii?q?MLuYFA/uFM0XH9KhKOg0lFmmcB0FPPpe+7UpP8y7bfSG3q2rPOF+nD+9iWRH4Y?=
 =?us-ascii?q?Z90l+D9iZmS+7I2YoFzO+c3gedSzj8i1KhuNjtmY9YfTESAna/yS/8CY9Re61+?=
 =?us-ascii?q?Z5oEBX2vIs233Np+gZHtVmVc9F6iAVMGxcCodQCTb1z7wQ1fy0AXrWa7liu/yj?=
 =?us-ascii?q?x+iyspobaH3CzS3+TicwIKOnRKRGZ+l1jsO5W7j9cAUEiucQcpjhql6V/myKdB?=
 =?us-ascii?q?oKRwMnfcQV1PfyjwNGxiVqqwtryfY89A8p8osCNXUPiiblCeULLyvxwa0yb7FW?=
 =?us-ascii?q?tE2D87by2quon+nxFiiGOdLWx/rXrDdcFr2Bff4sfRRfpQ3joAWSl5hiPbBlm6?=
 =?us-ascii?q?P9m149qUk43Pvfy5V2KkTpdTazXkzZuctCun4m1nGR+/kOqpmt3kEgg61jX318?=
 =?us-ascii?q?JwWiXLrxb8Y4/r2Lq8Me98ekloBVn869d1G41kk4swgo0Q1mYehpmP4XUHlmLz?=
 =?us-ascii?q?O81B2a3idHoNWSILw9nN7QnlwkJjKWiFx4D4VnWb2cZhY9i6YmUL2iMy9cxKCa?=
 =?us-ascii?q?GU7KBakitxuFa3sQXRYf1llDcH1fQu8GIag/0OuAc1zSWSGLESEVNYPSzxjRuI?=
 =?us-ascii?q?6d++ob5TZGaud7iwyUV/kcqgDLGEvgFTRnL5do0+Ei9368V1KEjM32Hr6oH4ZN?=
 =?us-ascii?q?nQasoethiVkxfDledZMpwwmeQRhSp7J239p2YqxPAhjRxhxpy6uImHK2Nw/KO2?=
 =?us-ascii?q?GBJYNzv1Z98N9THpl6pRgsGW34W3FJV7BjoLRIfoTe6vED8KqfTnMAOOHCc9q3?=
 =?us-ascii?q?iBH7rfABSf6Fxnr3/UF5CrNneXJGQWzNl4RRmdIlBfjx4QXDkggpE5EQWqztT7?=
 =?us-ascii?q?cEhl/jAR+kL4qhxUx+1zLRb/VWPfpBqyZjcwVZiSNx5W7gBE50fIPs2S9ONzHy?=
 =?us-ascii?q?dE/pK/qAyBMHCUZwNNDWsRQEyLG0jjPqWy5dnH6+WYBPCxL/7QbrWVs+BeS+2E?=
 =?us-ascii?q?xZGy0otl4jaMMN+APmJ5Av0/20pDW215GsvDlzUOTSwXizzCb8qBqBig/S13q9?=
 =?us-ascii?q?i18O73VwL3+YuPF7xSPM1v+hCxnKeDLvOQizx/KTpCzZMMwnnIyLcE0V4WiiFu?=
 =?us-ascii?q?cSStELsauS7MSqLQhrFYDxoBZyxvM8tI6ro23hNRNs7DltP1yrl4g+Y1C1hbVF?=
 =?us-ascii?q?zhmcKpZc0QL2G+LlPHA0mLO6qcJT3W2MH6eqe8SbxWjOVJuBy8ozebE0n/Pjud?=
 =?us-ascii?q?kznlTQygMeZJjCuDJhxRpJm9cgpxCWjkVN/pcAC7P8RtjTIowbw4nHfKNW8HPD?=
 =?us-ascii?q?h4ckNNqKCQ7CxCjvV+HWxB8mRqLe2elymF6OnYL44cseF3DSRsi+Ja/HM6xqNJ?=
 =?us-ascii?q?7CFFQfx5gjfdosRyrFGmjOaPzCFqUB5PqjZNmYKKsl9uOaTf9plcR3nE+AgB4n?=
 =?us-ascii?q?mXCxQPv9FlEMHgu7hMytjTk6L+MDdD/MjS/csZBsjULtqIMXshMRXzHj7UAxAI?=
 =?us-ascii?q?TTqqNWHZmkxcn+ue9nyTrpgmtJfsnIACRaNcVFwwRbsmDRFLGNsYIZ5xFgwpkL?=
 =?us-ascii?q?uWloZc62WzrRzcXu1As5zHX+7UCvLqfmW3l75BMj4B3bP5IJlbGoDg3UtzZ0Nh?=
 =?us-ascii?q?1NDPElbQXN1Q5CFsdQkzsUhX61BzQGMy0EPicUWm53pFRq38pQI/lgYrObdlzz?=
 =?us-ascii?q?zr+VpiYwOS/CY=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AgAABfy/Zbh0O0hNFiHQEBBQEHBQGBU?=
 =?us-ascii?q?gcBCwGBMIE5gQInCoNuiHeLIoFoJRSXJoFuMQcMAYhSIjUIDQEDAQEBAQEBAgE?=
 =?us-ascii?q?TAQEBCA0JCCkjDII2JAGCYgECAwECIAQZAQETJAEFCQEBAQEIDgoCAg0ZAgIDV?=
 =?us-ascii?q?AIEEwWDHAGCAQEEqFtwfDOCdgEBBYceCIELin6BVz+BRIJfiAKCV4sThEs0j3I?=
 =?us-ascii?q?HAoIcBI8nkQiZViIDgghNI4M8CYISNYM4inBUgQIDAQEhE4sBAYEeAQE?=
X-IPAS-Result: =?us-ascii?q?A0AgAABfy/Zbh0O0hNFiHQEBBQEHBQGBUgcBCwGBMIE5gQI?=
 =?us-ascii?q?nCoNuiHeLIoFoJRSXJoFuMQcMAYhSIjUIDQEDAQEBAQEBAgETAQEBCA0JCCkjD?=
 =?us-ascii?q?II2JAGCYgECAwECIAQZAQETJAEFCQEBAQEIDgoCAg0ZAgIDVAIEEwWDHAGCAQE?=
 =?us-ascii?q?EqFtwfDOCdgEBBYceCIELin6BVz+BRIJfiAKCV4sThEs0j3IHAoIcBI8nkQiZV?=
 =?us-ascii?q?iIDgghNI4M8CYISNYM4inBUgQIDAQEhE4sBAYEeAQE?=
X-IronPort-AV: E=Sophos;i="5.56,266,1539673200"; 
   d="scan'208";a="53968621"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 22 Nov 2018 07:33:25 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2437774AbeKWCNM (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Thu, 22 Nov 2018 21:13:12 -0500
Received: from mail.efficios.com ([167.114.142.138]:43684 "EHLO
        mail.efficios.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S2437749AbeKWCNM (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 22 Nov 2018 21:13:12 -0500
Received: from localhost (ip6-localhost [IPv6:::1])
        by mail.efficios.com (Postfix) with ESMTP id 18ADB250CD0;
        Thu, 22 Nov 2018 10:33:20 -0500 (EST)
Received: from mail.efficios.com ([IPv6:::1])
        by localhost (mail02.efficios.com [IPv6:::1]) (amavisd-new, port 10032)
        with ESMTP id cgZhkN1M_N7F; Thu, 22 Nov 2018 10:33:19 -0500 (EST)
Received: from localhost (ip6-localhost [IPv6:::1])
        by mail.efficios.com (Postfix) with ESMTP id BEA28250CCB;
        Thu, 22 Nov 2018 10:33:19 -0500 (EST)
DKIM-Filter: OpenDKIM Filter v2.10.3 mail.efficios.com BEA28250CCB
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=efficios.com;
        s=default; t=1542900799;
        bh=iX74avaxkopbTzW8iFc6KzfBB2ZkO1P69rbpcHrgCIU=;
        h=Date:From:To:Message-ID:MIME-Version;
        b=rjlHzJZGqvxHpooCBau9wQ9dZbrMJyqkZ4gv1U9r/DKThVXwSAKeYgXLJSzf+zewZ
         KJjACqU0u2V0iTxGYSRVC9/eilGijS+zhXoTfEUvK4WTAV/KSbKdYQm7YeW00YN/3G
         RMEAyx4FI9+FNCpHtuuE/LAcQY09pSa8ERlIvWAuMbxsiNYWWY/yIvDl1RmFRr6w7u
         HXhT5zy8+yOfOogU4efl//LhpwzglBJtCmbMFmRArxEtPzFIEIpAmczrraX632jfpg
         RLxrKSa127dED8pOBwNZwkR4WcA1UyLsx292qzNjy9fTOKbDCigES1BqOwbleTenSC
         SAQIh7Yg99p3Q==
X-Virus-Scanned: amavisd-new at efficios.com
Received: from mail.efficios.com ([IPv6:::1])
        by localhost (mail02.efficios.com [IPv6:::1]) (amavisd-new, port 10026)
        with ESMTP id xTHlahvGACw5; Thu, 22 Nov 2018 10:33:19 -0500 (EST)
Received: from mail02.efficios.com (mail02.efficios.com [167.114.142.138])
        by mail.efficios.com (Postfix) with ESMTP id A05F9250CB3;
        Thu, 22 Nov 2018 10:33:19 -0500 (EST)
Date: Thu, 22 Nov 2018 10:33:19 -0500 (EST)
From: Mathieu Desnoyers <mathieu.desnoyers@efficios.com>
To: Florian Weimer <fweimer@redhat.com>
Cc: Rich Felker <dalias@libc.org>, carlos <carlos@redhat.com>,
        Joseph Myers <joseph@codesourcery.com>,
        Szabolcs Nagy <szabolcs.nagy@arm.com>,
        libc-alpha <libc-alpha@sourceware.org>,
        Thomas Gleixner <tglx@linutronix.de>,
        Ben Maurer <bmaurer@fb.com>,
        Peter Zijlstra <peterz@infradead.org>,
        "Paul E. McKenney" <paulmck@linux.vnet.ibm.com>,
        Boqun Feng <boqun.feng@gmail.com>,
        Will Deacon <will.deacon@arm.com>,
        Dave Watson <davejwatson@fb.com>, Paul Turner <pjt@google.com>,
        linux-kernel <linux-kernel@vger.kernel.org>,
        linux-api <linux-api@vger.kernel.org>
Message-ID: <1306224240.10055.1542900799576.JavaMail.zimbra@efficios.com>
In-Reply-To: <875zwpyw81.fsf@oldenburg.str.redhat.com>
References: <20181121183936.8176-1-mathieu.desnoyers@efficios.com> <20181122143603.GD23599@brightrain.aerifal.cx> <782067422.9852.1542899056778.JavaMail.zimbra@efficios.com> <87a7m1ywni.fsf@oldenburg.str.redhat.com> <20181122151710.GF23599@brightrain.aerifal.cx> <875zwpyw81.fsf@oldenburg.str.redhat.com>
Subject: Re: [RFC PATCH v4 1/5] glibc: Perform rseq(2) registration at nptl
 init and thread creation
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Transfer-Encoding: 7bit
X-Originating-IP: [167.114.142.138]
X-Mailer: Zimbra 8.8.10_GA_3047 (ZimbraWebClient - FF52 (Linux)/8.8.10_GA_3041)
Thread-Topic: glibc: Perform rseq(2) registration at nptl init and thread creation
Thread-Index: VNsyWedxHflm6QgPfgC12cA12AhZDg==
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

----- On Nov 22, 2018, at 10:21 AM, Florian Weimer fweimer@redhat.com wrote:

> * Rich Felker:
> 
>> On Thu, Nov 22, 2018 at 04:11:45PM +0100, Florian Weimer wrote:
>>> * Mathieu Desnoyers:
>>> 
>>> > Thoughts ?
>>> >
>>> >   /* Unregister rseq TLS from kernel. */
>>> >   if (has_rseq && __rseq_unregister_current_thread ())
>>> >     abort();
>>> >
>>> >   advise_stack_range (pd->stackblock, pd->stackblock_size, (uintptr_t) pd,
>>> >                       pd->guardsize);
>>> >
>>> >   /* If the thread is detached free the TCB.  */
>>> >   if (IS_DETACHED (pd))
>>> >     /* Free the TCB.  */
>>> >     __free_tcb (pd);
>>> 
>>> Considering that we proceed to free the TCB, I really hope that all
>>> signals are blocked at this point.  (I have not checked this, though.)
>>> 
>>> Wouldn't this address your concern about access to the rseq area?
>>
>> I'm not familiar with glibc's logic here, but for other reasons, I
>> don't think freeing it is safe until the kernel task exit futex (set
>> via clone or set_tid_address) has fired. I would guess __free_tcb just
>> sets up for it to be reclaimable when this happens rather than
>> immediately freeing it for reuse.
> 
> Right, but in case of user-supplied stacks, we actually free TLS memory
> at this point, so signals need to be blocked because the TCB is
> (partially) gone after that.

Unfortuntately, disabling signals is not enough.

With rseq registered, the kernel accesses the rseq TLS area when returning to
user-space after _preemption_ of user-space, which can be triggered at any
point by an interrupt or a fault, even if signals are blocked.

So if there are cases where the TLS memory is freed while the thread is still
running, we _need_ to explicitly unregister rseq beforehand.

Thanks,

Mathieu

-- 
Mathieu Desnoyers
EfficiOS Inc.
http://www.efficios.com
