Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 23:33:45 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga008.fm.intel.com (fmsmga008.fm.intel.com [10.253.24.58])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 1946358037D;
	Fri, 23 Nov 2018 02:03:10 -0800 (PST)
Received: from fmsmga101.fm.intel.com ([10.1.193.65])
  by fmsmga008-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 02:03:10 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AgE1LiRUcng/tGkDXmRh4g9aK/yDV8LGtZVwlr6E/?=
 =?us-ascii?q?grcLSJyIuqrYZhCCtadThVPEFb/W9+hDw7KP9fy4CSpYud6oizMrSNR0TRgLiM?=
 =?us-ascii?q?EbzUQLIfWuLgnFFsPsdDEwB89YVVVorDmROElRH9viNRWJ+iXhpTEdFQ/iOgVr?=
 =?us-ascii?q?O+/7BpDdj9it1+C15pbffxhEiCCybL9uLxi6txndutULioZ+N6g9zQfErGFVcO?=
 =?us-ascii?q?pM32NoIlyTnxf45siu+ZNo7jpdtfE8+cNeSKv2Z6s3Q6BWAzQgKGA1+dbktQLf?=
 =?us-ascii?q?QguV53sTSXsZnxxVCAXY9h76X5Pxsizntuph3SSRIMP7QawoVTmk8qxmTgLjhi?=
 =?us-ascii?q?UaOD4j6GzZhMx+grxGrhyiqRxwzJLbb5yXO/VwZaPdZdEXSHFdXspNTSFNHp+w?=
 =?us-ascii?q?YpERA+cHIO1Wr5P9p1wLrRamGwSsBPnvyj5Thn/q2q063eohHh/c3Ac9EdwBqn?=
 =?us-ascii?q?DUrNHoP6oVTe+1zLPIzTTYb/NK3jf95obIfQ47of2WQL1/a87RyU00GgzflFWQ?=
 =?us-ascii?q?rJbpMC+S1uQIqmWW6fdrW+yoi24isQ5xoz6vy98oionXg4IZ0FTE9Tt/zY0oJt?=
 =?us-ascii?q?O4UFZ2bcC4HJZUrS2WKoV7Tt04T211uys21qcKtJ+5cSQS1pgr2hzSZ+aaf4WH?=
 =?us-ascii?q?/h7vTvudLStliH5/er+zmxC/+lW6xOLmTMm7ylNKozJFktbSsnAN0ATe6taISv?=
 =?us-ascii?q?Rj5EetwzWP2B7J6uFCP080kbDXK5k7wr4/jpYTsELDETHqmEjukqOaakEp9vK1?=
 =?us-ascii?q?5+npfLnqvIKQOoxohg3kM6kjmNSzAeEiPQgPW2ib9/681Lrm/UDhRLVKj/s2kr?=
 =?us-ascii?q?TWsZzDJsQUuLS5AwlL3YYn8hq/CDmn0NIGknkdN19FZh2HgJbzO13UI/D3E+2/?=
 =?us-ascii?q?g1Kynzdv3fzGOafhAprVInjZjLjhZap961JbyAcrydBf5pFUBa8bLPP8R0/8r9?=
 =?us-ascii?q?jYDh4/MwypzOfrEtR91oUCWW2RBq+VKr/dsViN5ug3OemDeJcVuCrhK/gi//Pu?=
 =?us-ascii?q?jWU2mV4Bfaaz2psbcnC4Hul8LEWfbnrhmdMBEWYMvgojQ+3mklyCUThPZ3msW6?=
 =?us-ascii?q?Iw/C00CIWjDY3bXICinKSB3DunHp1Rfm1GCFeMHmnye4WHXPcMbiSSIsh6nzwA?=
 =?us-ascii?q?VLihTZIh1B60uA/7zbpnMvTb+ikCuZ3/09h14vXZlQsu+jxsE8Sdz2aNQnlukW?=
 =?us-ascii?q?MTRz8226N/rVZnyliZ06h1mPhYFd1V5/NUXQY2L5/cz+pmC9/sXgLNZMuGSFGj?=
 =?us-ascii?q?Qt++GzE+Usoxw8MSY0Z6A9iijQrM3yywD78RlryEHpo08q3H0nj1JsZ9zWvG1a?=
 =?us-ascii?q?Y7g1knRMtPKXOphqpl+wfPAI7Jll2Tl7y2eqQEwC7N6GCDwHKTs05CTg5/T7/J?=
 =?us-ascii?q?XXAFaUvQttT2+EXCQ7iqCbQkNwtBzdWPKq9Lat3vkFVHS+3vONXYY2KthWiwAQ?=
 =?us-ascii?q?yEya+LbIrvY28dxjnSCFAYkwAP+naLLRUxCT2/o23AFjBuFUjgY0X38eZgrnO2?=
 =?us-ascii?q?VUs0zwCMb0182Lu54B8VhfqAS/wN2rIIojsuqzJxHFylxdLZF8KApxZ9fKVbed?=
 =?us-ascii?q?49/FZH1WfetwxhPpyhL7puhkIEfwRwpUPu0xR3CoNPkcUxqHMqzQxyKb+X0V9b?=
 =?us-ascii?q?djOY24zwNaPTKmXo4B+vbKvW0EnE0NmK4qcP9Og4q1L7sQ6zEkot7Xpm3MdV0n?=
 =?us-ascii?q?eG/ZrKERcdXoj3UkY08Bh6uarXYi0854PSyH1tPrO4sj7E29I1GuQlzgyscMtY?=
 =?us-ascii?q?MKOBDAXyCdEVB9CyKOw2nFikdhIFPP1I+KEoJc+ndvuG17StPOZvhz+miWVH4I?=
 =?us-ascii?q?Zg0kOD7SZ8S+jI34obzPGcxAeISzD8jFK5uMDthY9EfS0SHna4ySX8Ho5RZ7F9?=
 =?us-ascii?q?cpwRCWizJM273NN+iID3W35Z7VKsG0kJ2Mu0dhWMdVz92gtQ2F8ToXymnyu40j?=
 =?us-ascii?q?N1nysorqqZwCzB3eDieAAbNW5MQWlolU3sLpSsj9AGQEioaBAklRuk5Urgx6lX?=
 =?us-ascii?q?vr9/L3TVQUpTeyj2LmdiUra/t7aYYs5P7o8ovjtTUOimfV+aTbv9qQMA0yz/B2?=
 =?us-ascii?q?te2Cw7dzayt5X7hRN6kmGdLHV0rHbDYsF/3xTf5N/dRf5XwDUGQjJ1iT3WBli6?=
 =?us-ascii?q?Itmo8s+Yl5bFsuCiSW2hUodffjXszYOFrCG7/3FlAQWjn/Cvnd3qCQg73jX819?=
 =?us-ascii?q?VwVyXIrRD8b5Lv16S7N+JnY0ZpCEX968p8BoFxjI8wiIsM1ngdg5Wf5WAHnnvr?=
 =?us-ascii?q?MdVHxaL+a2IART0RzN7U+gTl2FBjIWiPx4L2TXidxsphZ9+nYmIZwC497sZKCL?=
 =?us-ascii?q?uK47xAhyd6vl24rQfJa/hngjgd0ecu6GIdg+wRvQotzyadDaoIEUhWIyPsjAiI?=
 =?us-ascii?q?4M6krKpMemmva7ew2VF6ndCgCrGCvw5dVGz4epckAS9/8MF/PEjQ333074HuYM?=
 =?us-ascii?q?PQYs4Lth2IjxfAiPBYKI42lvoPnyZmOHjyvXs4y+4glhxu3Iq3vIyGK2Vr4aK4?=
 =?us-ascii?q?DQRUNjzzZ8MP5D7tibxSkdqR34CqBp9hACkEXIP0TfK0FzIfre/oOByJED04t3?=
 =?us-ascii?q?eXA77fHRKE5UdirnLPFY2rNn6NKHkYy9ViWAeSJEhFjA8IWzU6m4YzFhq2y8z5?=
 =?us-ascii?q?bEd5+jcR60b6qhRWz+JnKQL/Xn3DpAuyaTc0VZufLAdQ7g5Y/EfYKsie7uN1Hy?=
 =?us-ascii?q?FF8Zyttg2NKmqHZwtWCWEFQFCLB1fmPrO2/9nP7/CYBvaiL/vJebiPqeteV+qR?=
 =?us-ascii?q?xZKyyIRm+SyANt6IPnlkAP02wU5DXXF/G8TElDQDUS0XlyTRb8GFoBew4DF4rs?=
 =?us-ascii?q?e68P7zQgLg+ZOPC6dOMdVo4x22gbmMN++ThCZ6KDZUzJAMxWXPyLgQwlESkTxu?=
 =?us-ascii?q?dyK2HLQEtC7NSr/Qm6BNAx4abSNzKNVH76Ym0gZRPs7bj8v/1qRkgf4tF1dFSV?=
 =?us-ascii?q?vhl9mzaswXOG69Lk3IBUaROLSCJD3G2MX3YaK6Sb1Ng+RYrRywuTCHE0D9OjSP?=
 =?us-ascii?q?jSXmVxeqMetUliGUIAReuJ2hchZqEWXjUNPmahihPNBrlzE53b00iW3MNWMHNT?=
 =?us-ascii?q?h8ckVNrqCf7C9Cg/V/HXBB4WRhLeWehymZ6OzYII4MsfR3GiR0i/5a4HMixrpV?=
 =?us-ascii?q?9i5EQvl1mCrUrtF2olCmkvOAyjxoUBdVrjZLhYSLvVhtOKnD95lAX2rE8wwJ7W?=
 =?us-ascii?q?mKFxsKoN5lWZXTvPVIx97A0qL6L21q4c7Zu8AbAo7fLpGpKn0kZDHpAj/PEAwL?=
 =?us-ascii?q?QzOxfU3Wg0gVxPqS7HyOsp80pJX23pYHTrtzXUYwUPgdDxI2T5Q5PJ5rU2Z8wv?=
 =?us-ascii?q?agh8kS6C/moQ=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ADAACVz/dbh0O0hNFiGwEBAQEDAQEBB?=
 =?us-ascii?q?wMBAQGBUQYBAQELAYNrJ4wRX4segg0UlyeBdikTAYhVIjQJDQEDAQEBAQEBAgE?=
 =?us-ascii?q?TAQEBCA0JCCkvgjYigmQBAQEBAgEBAiQTPwUBCQEBChgJJQMMBVwFgxyBeggEA?=
 =?us-ascii?q?agcM4oXjAmBVz+BEYMShEeDbIImAokZh0WPJAcCghwEjwQjgVmFC4okmXaCDU0?=
 =?us-ascii?q?jgzyCJxeOHT4BATGBBQEBiVWCTQEB?=
X-IPAS-Result: =?us-ascii?q?A0ADAACVz/dbh0O0hNFiGwEBAQEDAQEBBwMBAQGBUQYBAQE?=
 =?us-ascii?q?LAYNrJ4wRX4segg0UlyeBdikTAYhVIjQJDQEDAQEBAQEBAgETAQEBCA0JCCkvg?=
 =?us-ascii?q?jYigmQBAQEBAgEBAiQTPwUBCQEBChgJJQMMBVwFgxyBeggEAagcM4oXjAmBVz+?=
 =?us-ascii?q?BEYMShEeDbIImAokZh0WPJAcCghwEjwQjgVmFC4okmXaCDU0jgzyCJxeOHT4BA?=
 =?us-ascii?q?TGBBQEBiVWCTQEB?=
X-IronPort-AV: E=Sophos;i="5.56,269,1539673200"; 
   d="scan'208";a="63668691"
X-Amp-Result: UNKNOWN
X-Amp-Original-Verdict: FILE UNKNOWN
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mga01b.intel.com with ESMTP; 23 Nov 2018 02:03:08 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2503133AbeKWUql (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Fri, 23 Nov 2018 15:46:41 -0500
Received: from usa-sjc-mx-foss1.foss.arm.com ([217.140.101.70]:40710 "EHLO
        foss.arm.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S2393967AbeKWUqk (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 23 Nov 2018 15:46:40 -0500
Received: from usa-sjc-imap-foss1.foss.arm.com (unknown [10.72.51.249])
        by usa-sjc-mx-foss1.foss.arm.com (Postfix) with ESMTP id A21E635CD;
        Fri, 23 Nov 2018 02:03:04 -0800 (PST)
Received: from localhost (e113682-lin.copenhagen.arm.com [10.32.144.41])
        by usa-sjc-imap-foss1.foss.arm.com (Postfix) with ESMTPSA id 12B483F5CF;
        Fri, 23 Nov 2018 02:03:03 -0800 (PST)
Date: Fri, 23 Nov 2018 11:03:02 +0100
From: Christoffer Dall <christoffer.dall@arm.com>
To: peng.hao2@zte.com.cn
Cc: marc.zyngier@arm.com, andre.przywara@arm.com,
        linux-kernel@vger.kernel.org, leif.lindholm@linaro.org,
        ard.bieshseuvel@linaro.org, kvmarm@lists.cs.columbia.edu,
        linux-arm-kernel@lists.infradead.org
Subject: Re: [PATCH] kvm: arm/arm64 : fix vm's hanging at startup time
Message-ID: <20181123100302.GB3331@e113682-lin.lund.arm.com>
References: <20181121110620.GC18678@e113682-lin.lund.arm.com>
 <201811231401560886603@zte.com.cn>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <201811231401560886603@zte.com.cn>
User-Agent: Mutt/1.5.24 (2015-08-30)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Fri, Nov 23, 2018 at 02:01:56PM +0800, peng.hao2@zte.com.cn wrote:
> >Hi,
> >
> >On Wed, Nov 21, 2018 at 04:56:54PM +0800, peng.hao2@zte.com.cn wrote:
> >> >On 19/11/2018 09:10, Mark Rutland wrote:
> >> >> On Sat, Nov 17, 2018 at 10:58:37AM +0800, peng.hao2@zte.com.cn wrote:
> >> >>>> On 16/11/18 00:23, peng.hao2@zte.com.cn wrote:
> >> >>>>>> Hi,
> >> >>>>>>> When virtual machine starts, hang up.
> >> >>>>>>
> >> >>>>>> I take it you mean the *guest* hangs? Because it doesn't get a timer
> >> >>>>>> interrupt?
> >> >>>>>>
> >> >>>>>>> The kernel version of guest
> >> >>>>>>> is 4.16. Host support vgic_v3.
> >> >>>>>>
> >> >>>>>> Your host kernel is something recent, I guess?
> >> >>>>>>
> >> >>>>>>> It was mainly due to the incorrect vgic_irq's(intid=27) group value
> >> >>>>>>> during injection interruption. when kvm_vgic_vcpu_init is called,
> >> >>>>>>> dist is not initialized at this time. Unable to get vgic V3 or V2
> >> >>>>>>> correctly, so group is not set.
> >> >>>>>>
> >> >>>>>> Mmh, that shouldn't happen with (v)GICv3. Do you use QEMU (which
> >> >>>>>> version?) or some other userland tool?
> >> >>>>>>
> >> >>>>>
> >> >>>>> QEMU emulator version 3.0.50 .
> >> >>>>>
> >> >>>>>>> group is setted to 1 when vgic_mmio_write_group is invoked at some
> >> >>>>>>> time.
> >> >>>>>>> when irq->group=0 (intid=27), No ICH_LR_GROUP flag was set and
> >> >>>>>>> interrupt injection failed.
> >> >>>>>>>
> >> >>>>>>> Signed-off-by: Peng Hao <peng.hao2@zte.com.cn>
> >> >>>>>>> ---
> >> >>>>>>>   virt/kvm/arm/vgic/vgic-v3.c | 2 +-
> >> >>>>>>>   1 file changed, 1 insertion(+), 1 deletion(-)
> >> >>>>>>>
> >> >>>>>>> diff --git a/virt/kvm/arm/vgic/vgic-v3.c b/virt/kvm/arm/vgic/vgic-v3.c
> >> >>>>>>> index 9c0dd23..d101000 100644
> >> >>>>>>> --- a/virt/kvm/arm/vgic/vgic-v3.c
> >> >>>>>>> +++ b/virt/kvm/arm/vgic/vgic-v3.c
> >> >>>>>>> @@ -198,7 +198,7 @@ void vgic_v3_populate_lr(struct kvm_vcpu *vcpu,
> >> >>>>>>> struct vgic_irq *irq, int lr) if (vgic_irq_is_mapped_level(irq) &&
> >> >>>>>>> (val & ICH_LR_PENDING_BIT)) irq->line_level = false;
> >> >>>>>>>
> >> >>>>>>> -    if (irq->group)
> >> >>>>>>> +    if (model == KVM_DEV_TYPE_ARM_VGIC_V3)
> >> >>>>>>
> >> >>>>>> This is not the right fix, not only because it basically reverts the
> >> >>>>>> GICv3 part of 87322099052 (KVM: arm/arm64: vgic: Signal IRQs using
> >> >>>>>> their configured group).
> >> >>>>>>
> >> >>>>>> Can you try to work out why kvm_vgic_vcpu_init() is apparently called
> >> >>>>>> before dist->vgic_model is set, also what value it has?
> >> >>>>>> If I understand the code correctly, that shouldn't happen for a GICv3.
> >> >>>>>>
> >> >>>>> Even if the value of  group is correctly assigned in kvm_vgic_vcpu_init, the group is then written 0 through >vgic_mmio_write_group.
> >> >>>>>   If the interrupt comes at this time, the interrupt injection fails.
> >> >>>>
> >> >>>> Does that mean that the guest is configuring its interrupts as Group0?
> >> >>>> That sounds wrong, Linux should configure all it's interrupts as
> >> >>>> non-secure group1.
> >> >>>
> >> >>> no, I think that uefi dose this, not linux.
> >> >>> 1. kvm_vgic_vcpu_init
> >> >>> 2. vgic_create
> >> >>> 3. kvm_vgic_dist_init
> >> >>> 4.vgic_mmio_write_group: uefi as guest, write group=0
> >> >>> 5.vgic_mmio_write_group: linux as guest, write group=1
> >> >>
> >> >> Is this the same issue fixed by EDK2 commit:
> >> >>
> >> >> 66127011a544b90e ("ArmPkg/ArmGicDxe ARM: fix encoding for GICv3 interrupt acknowledge")
> >> >>
> >> >> ... where EDK2 would try to use IAR0 rather than IAR1?
> >> >>
> >> >> The commit messages notes this lead to a boot-time hang.
> >> >
> >> >I managed to trigger an issue with a really old EFI implementation that
> >> >doesn't configure its interrupts as Group1, and yet tries to ACK its
> >> >interrupts using the Group1 accessor. Guess what? It is not going to work.
> >> >
> >> >Commit c7fefb690661f2e38afcb8200bd318ecf38ab961 in the edk2 tree seems
> >> >to be the fix (I only assume it does, I haven't actually checked). A
> >> >recent build, as found in Debian Buster, works perfectly (tested with
> >> >both QEMU v2.12 and tip of tree).
> >> >
> >> >Now, I really don't get what you're saying about Linux not getting
> >> >interrupts. How do you get to booting Linux if EFI is not making any
> >> >forward progress? Are you trying them independently?
> >> >
> >> I start linux with bypassing uefi, the print info is the same.
> >> [507107.748908]  vgic_mmio_write_group:## intid/27 group=0
> >> [507107.752185]  vgic_mmio_write_group:## intid/27 group=0
> >> [507107.899566]  vgic_mmio_write_group:## intid/27 group=1
> >> [507107.907370]  vgic_mmio_write_group:## intid/27 group=1
> >> the command line is like this:
> >> /home/qemu-patch/linshi/qemu/aarch64-softmmu/qemu-system-aarch64  -machine virt-3.1,accel=kvm,usb=off,dump-guest-core=off,gic-version=3  -kernel /home/kernelboot/vmlinuz-4.16.0+ -initrd /home/kernelboot/initramfs-4.16.0+.img -append root=/dev/mapper/cla-root ro crashkernel=auto rd.lvm.lv=cla/root rd.lvm.lv=cla/swap.UTF-8  -drive file=/home/centos74-ph/boot.qcow2,format=qcow2,if=none,id=drive-scsi0-0-0-0 -device scsi-hd,bus=scsi0.0,channel=0,scsi-id=0,lun=0,drive=drive-scsi0-0-0-0,id=scsi0-0-0-0,bootindex=1  -vnc 0.0.0.0:0 -k en-us -device virtio-gpu-pci,id=video0,max_outputs=1,bus=pci.3,addr=0x0 -device pvpanic-mmio -msg >timestamp=on
> >>
> >> This is strange. That's probably the Linux 4.16  kernel setting group to 0, and I'll continue to track in guest.
> >
> >Could you try the following patch:
> >
> >diff --git a/virt/kvm/arm/vgic/vgic-init.c b/virt/kvm/arm/vgic/vgic-init.c
> >index c0c0b88af1d5..6fa858c7a5a6 100644
> >--- a/virt/kvm/arm/vgic/vgic-init.c
> >+++ b/virt/kvm/arm/vgic/vgic-init.c
> >@@ -231,13 +231,6 @@ int kvm_vgic_vcpu_init(struct kvm_vcpu *vcpu)
> >irq->config = VGIC_CONFIG_LEVEL;
> >}
> >-        /*
> >-         * GICv3 can only be created via the KVM_DEVICE_CREATE API and
> >-         * so we always know the emulation type at this point as it's
> >-         * either explicitly configured as GICv3, or explicitly
> >-         * configured as GICv2, or not configured yet which also
> >-         * implies GICv2.
> >-         */
> >if (dist->vgic_model == KVM_DEV_TYPE_ARM_VGIC_V3)
> >irq->group = 1;
> >else
> >@@ -298,6 +291,16 @@ int vgic_init(struct kvm *kvm)
> >if (ret)
> >goto out;
> >+    /* Initialize groups on CPUs created before the VGIC type was known */
> >+    kvm_for_each_vcpu(i, vcpu, kvm) {
> >+        struct vgic_cpu *vgic_cpu = &vcpu->arch.vgic_cpu;
> >+
> >+        for (i = 0; i < VGIC_NR_PRIVATE_IRQS; i++) {
> >+            struct vgic_irq *irq = &vgic_cpu->private_irqs[i];
> >+            irq->group = 1;
> >+        }
> >+    }
> >+
> >if (vgic_has_its(kvm)) {
> >ret = vgic_v4_init(kvm);
> >if (ret)
> >
> Sorry for the late reply. 
> I test the patch and it works. But I think there is randomness here.
> 1.vgic_init:  set intid/27 group=1
> 2.vgic_mmio_write_group:## intid/27 group=0
> 3.!!! receive a  vtimer irq   ----- it may exist.
> 4.vgic_mmio_write_group:## intid/27 group=1

Are these writes from userspace or from the guest?
(I assume they're from the guest.)

> 
> I made an attempt before:

Was this previous experiment using my patch or without my patch?

> 1. kvm_vgic_vcpu_init
>      according to if  kvm_vgic_global_state.type == VGIC_V3, set group=1
> 2.vgic_mmio_write_group:## intid/27 group=0
> 3.!!! receive a  vtimer irq   -----I really receive a vtimer irq, then the guest hangs.
> 

If the guest you're using is flipping the group of the interrupt and yet
enabling the device and interrupt while flipping the group, then it's
not expected to work and it's a guest bug.

My hunch here tells me that my patch is what we need for KVM, and either

  (1) You no longer have a problem but are tracing some guest
      initialization behavior which is fine, or

  (2) You still have a problem because you also have some broken guest
      code (guest UEFI or guest Linux) that also needs fixing.

If you can demonstrate that you still have a problem, with my path
applied to KVM, and with a recent guest Linux and guest UEFI, then I'll
be happy to have another look.  In that case, could you please provide
the exact versions of your guest Linux and UEFI, as well as the QEMU
version and command line.


Thanks,

    Christoffer
