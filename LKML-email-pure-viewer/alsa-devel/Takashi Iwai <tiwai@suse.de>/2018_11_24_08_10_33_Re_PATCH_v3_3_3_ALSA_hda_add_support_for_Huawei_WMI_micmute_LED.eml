Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 25 Nov 2018 14:41:32 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga001.jf.intel.com (orsmga001.jf.intel.com [10.7.209.18])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 4EA6B580460;
	Sat, 24 Nov 2018 00:10:47 -0800 (PST)
Received: from orsmga106.jf.intel.com ([10.7.208.65])
  by orsmga001-1.jf.intel.com with ESMTP; 24 Nov 2018 00:10:47 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3A7d7xXBJfM8yt7s3sDtmcpTZWNBhigK39O0sv0rFi?=
 =?us-ascii?q?tYgUL///rarrMEGX3/hxlliBBdydt6oUzbKO+4nbGkU4qa6bt34DdJEeHzQksu?=
 =?us-ascii?q?4x2zIaPcieFEfgJ+TrZSFpVO5LVVti4m3peRMNQJW2aFLduGC94iAPERvjKwV1?=
 =?us-ascii?q?Ov71GonPhMiryuy+4ZLebxlLiTanfb9+MAi9oBnMuMURnYZsMLs6xAHTontPde?=
 =?us-ascii?q?RWxGdoKkyWkh3h+Mq+/4Nt/jpJtf45+MFOTav1f6IjTbxFFzsmKHw65NfqtRbY?=
 =?us-ascii?q?UwSC4GYXX3gMnRpJBwjF6wz6Xov0vyDnuOdxxDWWMMvrRr0vRz+s87lkRwPpiC?=
 =?us-ascii?q?cfNj427mfXitBrjKlGpB6tvgFzz5LIbI2QMvdxeb7Tfc4BRWpZQMleSzBBDI27?=
 =?us-ascii?q?b4sKFeUBPOBYpJT5q1YBqRayAA+hD/7txDBVnH/7xaM03echHw/YwQIvHdwOv3?=
 =?us-ascii?q?rbo9rpL6cSSeK4wbLUzTnfdf5axSvx5ZLWfh0nvPqCXahwcc3UyUQ3CQ3KlFaQ?=
 =?us-ascii?q?ppb+PzOV1+QGrmuV7uR6WuKulmUqrB1xojmhx8g2i4nEnZkVyk3f9Spn2oo6OM?=
 =?us-ascii?q?O3RVd9bNW5HpVQsCSaOJF3QsMkW2xovCc6yqMYtp65eygK1Y4nxxjFZPyDaYSH?=
 =?us-ascii?q?/hXjVOOJLThkmXJlfrO/iwyu/kmhzOD3S8q60E5SoyZbjtXBsmoB2wHd58SZUP?=
 =?us-ascii?q?dx40Ss1SqV2w3S6OxIOV04mK7bJpI737I9mJoevV7dEiPohEn6lrGae0Ur9+Wu?=
 =?us-ascii?q?9u/peK/ppoWGOI9xkgz+Mrohmsi4AekgLAgOUHaU+f6m2L3g40L5WrNKgeMykq?=
 =?us-ascii?q?XDt5DaP8sbqra4Aw9TzIkj9w6yAym63Nkch3ULMVxIdAydg4T0OFzCPOr0APa9?=
 =?us-ascii?q?jli0lTdk3fHGPrnvApXXKXjDla/sfbJ8605a1QoywslT55FKBbEbJvL8REvxuM?=
 =?us-ascii?q?XfDh43NQy73fznBc5j1oMRR22PGLWVMKDMvl+S4OIgPe2MaJUSuDbnJPgp/+Tu?=
 =?us-ascii?q?gmMhmV8BYamp2oMaaHS5HvRlPUqVe3XtgsoaHGcOvwo+SvHqiVKYXT5SYXayQ7?=
 =?us-ascii?q?wz5jUhBI26CofDQ5ingKad0yejAp1WemdGB0iMEXjydoWER+0DaCWILs9hjzwL?=
 =?us-ascii?q?T76hS4A62BGqtQ/6zadnL+XO9i0Zs5LjyMZ65+nJmR4u8jx0CtyX03uRQGFsgm?=
 =?us-ascii?q?MIWzg20bh9oUx61FiPy6t4g/teFdxV4PNESQM6NZ/az+xnBNH+QAPBftGVSFm4?=
 =?us-ascii?q?RtWqGy0+TtU0w9UWeUZyB82ijgzf3yqtG7IajaeLBJwz8qLfxXTxPdxyy3Td2a?=
 =?us-ascii?q?kljlkmRNZPNGK8iq5+8QjTG5DGk0GDm6m2cqQc2TbH9H2fwmqWoEFYTAlwXL3G?=
 =?us-ascii?q?XX8FYEvat9D55kLYQL+oBrQqKQ9Byc+EKqtXZdzll1RGRPH/ONvAZ2K9gXu/BR?=
 =?us-ascii?q?GNxrmUdorlZ30d3DnBCEgDiw0c4GyJNRYgCSu7o2LRFjpuFUnxbEPq9uV+rHC7?=
 =?us-ascii?q?TkowzwyRa01h1ry1+gMahPCGSvMT2K4EtzklqzluAFm92NfWAcKapwV9ZKVcfc?=
 =?us-ascii?q?894FBf2G3ErQN9IIKvI7pihlEEdQR3pF3h1xNsB4VEkMgqqm4qzQVoJaKZ1lNB?=
 =?us-ascii?q?ay2X3ZTqNrLLLWny+Qila7TK1VHGzNaW5qAP5ewkq1XiuQGpEVYi83Vn0tVPz3?=
 =?us-ascii?q?uQ/JLKDBAWUZLwVEY3+AN3p7XbYik7+oPV2mdgMaiysj/exd0pAPEpxQqnf9da?=
 =?us-ascii?q?KKmEDhP9E9UGB8iyL+wng0KmbhYaM+Fd6qE1P9mqeOCb2KG2JulgmjGmjWNZ4I?=
 =?us-ascii?q?1m1kKM9ix8SvPH3pofwvGY2BeHWCn4jFu7rs/3noVEbykIHmWj0SjkGJJRZqpq?=
 =?us-ascii?q?cIcLFGeiOdG4ys9/hp7tQXFY8lGjCkgC2M+ofxqSclP80RdR1UQRvXyohy+4wy?=
 =?us-ascii?q?ZonDEuq6qVxDbOzPj6dBobJm5LQ3FvjU3tIYeold8aRlWnbw8zmBuj+0n63alb?=
 =?us-ascii?q?qL1jIGbJRUdHYjb5L3tlUqu2rbeCZ89P6JU1sSRYSui8YFaaSqLjrBseyS/sA2?=
 =?us-ascii?q?xexDUjfTGwppr5hwB6iH6aLHtrrHvZeNt8xBfF6NzHWP5R2CELRC15iTnRG1i9?=
 =?us-ascii?q?MMOl/dSSl5ffrO++U3itWYFUcSnu1YmArje05XV2AR2jmPC+gt/nHhIg0S/41N?=
 =?us-ascii?q?lqUj/ErA3mbYno1KS6MORncVduBFLn78p6G4d+kpY/hZ0K2HgagImV8mQDkWvp?=
 =?us-ascii?q?Ldpb3qf+ZmIXRTEX297V/BTl2Ep7I3OJ3Y35UW+RwslgZ9m8eW4W3iM978ZXCK?=
 =?us-ascii?q?ab9rBEnC11okamogLVe/RygjAdyf424n4An+4JoBYtzjmaAr0KHklXJy3smw6I?=
 =?us-ascii?q?79CjtqpXYmmvfKO01Ep/m9ChEb6DrhtdWHb/ZpctAytw4t9jP1LL1X358pvkd8?=
 =?us-ascii?q?XIbdIPqh2UlA/Nj+1UKJIyjPUGnyRmNnzmvX051eE7lwdh0o+gvIiIMGht+KO5?=
 =?us-ascii?q?AhhFNjz6fc8T+zftjbpAkcaSxYygApJhGjATVpvyUf2oCC4StejgNwuWDD08rX?=
 =?us-ascii?q?KbFaDeHACF7kdmsmnPE4uqN3yMIHkZzNNiRASSJUBFgQAUWik6kYA9Fgyw2MPh?=
 =?us-ascii?q?d0J57CgL5lHkshtM1v5oNx7nX2jEvgiobTM0SIWFIBpS8wFP/EPVMc2Y7uJuEC?=
 =?us-ascii?q?BU5JyhrAqRKmOFYwREF30GWkuBB1r7JLmh+cHA8/SEBuq5N/bOY6+BqelAWPeT?=
 =?us-ascii?q?356vzpFq/zWRNsWMI3liCec02lFYUHB9GsTZnSgPSiMNmyLMac6buAmz+iltos?=
 =?us-ascii?q?+j9/TrXRrl5ZGTBLtKLdVv5xe2jL+DNu6XmSZ5MCtY2YkKxXPS07gf21gSiy51?=
 =?us-ascii?q?ejmpELQAszPNTa3Klq9WCR4bdz18NM9S460g2QlNPNbRisnp2b5gkv41F1BFWE?=
 =?us-ascii?q?Thms63ZMwKIGK9NFLdCEaILrSGIjLLzN/tYaOhUr1dl+FUtxy2uTaGHE7vJDWD?=
 =?us-ascii?q?lz/1Vx+xNeFAlj2UPBtbuIulaBZiFXDjTM76ah28KNJ4lyA2zqYuhnzUNW8QKz?=
 =?us-ascii?q?x8c0JWo72U7CNYhOh/GmNb4npkK+mEhziW7+3CJpkKtvtrBzx+l/hG73Qi17tV?=
 =?us-ascii?q?8CZESeRpmCvTq95iuU2pnvOTxTpnThVOrC1GhIaKvUVkJKXY+YNMWXfC/BIR82?=
 =?us-ascii?q?qQDw4GqMdiCt3qo6pQ0MTAlLrvKDde9NLZ5csdCNLSKMKCMXohNwLmGT/UDAQf?=
 =?us-ascii?q?Sz6rOnrSh0hckPGU632UoYI2qpnqmJoSVLBbUEY5Ge8dCkRgT5Q+J8JPVy0plf?=
 =?us-ascii?q?a+hcUI6Hn2+AHYWshelo3MSbSZE6O8BiyeiOx4bhgB2rP5ZaUMP4yzj1BjdVB7?=
 =?us-ascii?q?tJ/XAEeWUd0b8X4pVRM9vEgYqCs2dWY0wU+wL1707Q=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0BAAACtBvlbh0O0hNFjFgYBAQEEAQEHB?=
 =?us-ascii?q?AEBgVQEAQELAYFagQ+BAieaHxRmllaBXywLCAGIWiI3Bg0BAwEBAQEBAQIBEwE?=
 =?us-ascii?q?BAQgNCQgpIwyCNiSCYgEBAQECAQECJBM/BgkBAQoYHBIDDUcGEwUWgjtLAYF5C?=
 =?us-ascii?q?AQBCqdXM4VBhFuMCReBQD+BEYJdNYMQCwOBJYYWAosRlHEJgRGFa4MthwYYgVl?=
 =?us-ascii?q?NhD6CeIcsjUOMSYF3MxoIHBSDJwmCHheDSiiKKz8yAQGBAwEBjB4BAQ?=
X-IPAS-Result: =?us-ascii?q?A0BAAACtBvlbh0O0hNFjFgYBAQEEAQEHBAEBgVQEAQELAYF?=
 =?us-ascii?q?agQ+BAieaHxRmllaBXywLCAGIWiI3Bg0BAwEBAQEBAQIBEwEBAQgNCQgpIwyCN?=
 =?us-ascii?q?iSCYgEBAQECAQECJBM/BgkBAQoYHBIDDUcGEwUWgjtLAYF5CAQBCqdXM4VBhFu?=
 =?us-ascii?q?MCReBQD+BEYJdNYMQCwOBJYYWAosRlHEJgRGFa4MthwYYgVlNhD6CeIcsjUOMS?=
 =?us-ascii?q?YF3MxoIHBSDJwmCHheDSiiKKz8yAQGBAwEBjB4BAQ?=
X-IronPort-AV: E=Sophos;i="5.56,273,1539673200"; 
   d="scan'208";a="41363375"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 24 Nov 2018 00:10:45 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727309AbeKXS6R (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Sat, 24 Nov 2018 13:58:17 -0500
Received: from mx2.suse.de ([195.135.220.15]:58170 "EHLO mx1.suse.de"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S1725902AbeKXS6R (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Sat, 24 Nov 2018 13:58:17 -0500
X-Virus-Scanned: by amavisd-new at test-mx.suse.de
Received: from relay2.suse.de (unknown [195.135.220.254])
        by mx1.suse.de (Postfix) with ESMTP id 645D0ADBF;
        Sat, 24 Nov 2018 08:10:34 +0000 (UTC)
Date: Sat, 24 Nov 2018 09:10:33 +0100
Message-ID: <s5hftvq99qe.wl-tiwai@suse.de>
From: Takashi Iwai <tiwai@suse.de>
To: Pavel Machek <pavel@ucw.cz>
Cc: Andy Shevchenko <andy.shevchenko@gmail.com>,
        Ayman Bagabas <ayman.bagabas@gmail.com>,
        ALSA Development Mailing List <alsa-devel@alsa-project.org>,
        Hui Wang <hui.wang@canonical.com>,
        Andy Shevchenko <andy@infradead.org>,
        Darren Hart <dvhart@infradead.org>,
        Jaroslav Kysela <perex@perex.cz>,
        Kailang Yang <kailang@realtek.com>,
        Linux Kernel Mailing List <linux-kernel@vger.kernel.org>,
        Platform Driver <platform-driver-x86@vger.kernel.org>
Subject: Re: [PATCH v3 3/3] ALSA: hda: add support for Huawei WMI micmute LED
In-Reply-To: <20181123233309.GA4340@amd>
References: <s5hr2fgfcrm.wl-tiwai@suse.de>
        <20181120091039.GA16916@amd>
        <s5hbm6kf6gi.wl-tiwai@suse.de>
        <20181120093610.GF16916@amd>
        <s5h4lccf58f.wl-tiwai@suse.de>
        <20181120115159.GG16916@amd>
        <s5hzhu4c569.wl-tiwai@suse.de>
        <CAHp75VddanEB-7qQutSWkbSZW4srRzGXkigCMxEP7zJ=KC6iKw@mail.gmail.com>
        <20181122131802.GB13339@amd>
        <s5h8t1l5ish.wl-tiwai@suse.de>
        <20181123233309.GA4340@amd>
User-Agent: Wanderlust/2.15.9 (Almost Unreal) SEMI/1.14.6 (Maruoka)
 FLIM/1.14.9 (=?UTF-8?B?R29qxY0=?=) APEL/10.8 Emacs/26
 (x86_64-suse-linux-gnu) MULE/6.0 (HANACHIRUSATO)
MIME-Version: 1.0 (generated by SEMI 1.14.6 - "Maruoka")
Content-Type: text/plain; charset=US-ASCII
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Sat, 24 Nov 2018 00:33:09 +0100,
Pavel Machek wrote:
> 
> Hi!
> 
> > > > > > > > You have general-purpose LED, yet you are treating it as "something
> > > > > > > > special". That means ugly code (quoted above) and lack of flexibility.
> > > > > > > >
> 
> > > I'd prefer this to be normal LED and "mic muted" to become normal
> > > trigger.
> > 
> > But how would you solve the existing problem?
> > 
> > As already mentioned, you'll need to hook the LED trigger and the
> > actual mixer value change.  This is the biggest missing piece, and
> > it's the very reason we have the exported symbol from the platform
> > driver side.
> > 
> > So, if you prefer in that way, please implement that for the existing
> > driver (thinkpad_acpi and dell-laptop) at first.  I'll be really happy
> > to get rid of the present ugly solution!  But it's been there just
> > because it's not so trivial at all.  FWIW, this must be all done
> > inside the kernel; otherwise you'll hit a regression.
> 
> Ok, what about something like this?
> 
> Tested, and it did not work. I guess I hooked it up at the wrong place
> in LED subsystem... or maybe thinkpad x60 is wrong machine to test on.
> 
> Anyway, it looks less ugly than current code in alsa. We should not
> really be using mixer settings to turn LED on and off.
> 
> Plus, it works in similar way triggers and LEDs "usually" do, and has
> all the flexibility.

Yes, thanks, that's something similar as what I had in mind, too.
I guess it's just a matter of thinkpad_acpi side implementation that
differs from your expectation.

However, one remaining problem is that the state will be inconsistent
depending on the driver module order, if we get rid of the dynamic
symbol binding.  Then both modules become completely individual and
thinkpad_acpi can be loaded at anytime later than HD-audio codec.
If a mixer state is already changed before loading thinkpad_acpi, this
event is lost and the state may be different in both sides.

So, we'd need to record the state in the mute-trigger side, and add a
function to return the current state.  Then thinkpad_acpi will query
the state at the initialization time.

Also, we'll need also the normal mute LED in addition to the mic mute
LED, so there need to be two triggers.

In anyway, moving to this direction requires the leds class
implementation for dell-laptop.c as well as the new huawei stuff.  So,
I'd really like to have the "already good working" code before
actually hacking this, so that we can see and track the functional
regression more obviously.

I can start hacking this in the next week.  At least I have a Dell
laptop and I can check the part of the changes locally.

Since the changes will be fairly cross-tree, it's better to have an
immutable branch to start with.  I'd branch off at 4.20-rc3 (or rc4),
apply the current patches, so that it can be merged to all relevant
trees cleanly.

Andy, could you give your sign-off for the platform part of Huawei
bits?


thanks,

Takashi

> 
> Signed-off-by: Pavel Machek <pavel@ucw.cz>
> 
> commit e7d6d170f2f45ea7a42c9ebb31869f440382e3ad
> 
>     leds: ledtrig-sound: provide indication of muted microphone
>     
>     Signed-off-by: Pavel Machek <pavel@ucw.cz>
> 
> diff --git a/drivers/leds/trigger/Makefile b/drivers/leds/trigger/Makefile
> index 9bcb64e..c5ea19e 100644
> --- a/drivers/leds/trigger/Makefile
> +++ b/drivers/leds/trigger/Makefile
> @@ -14,3 +14,4 @@ obj-$(CONFIG_LEDS_TRIGGER_CAMERA)	+= ledtrig-camera.o
>  obj-$(CONFIG_LEDS_TRIGGER_PANIC)	+= ledtrig-panic.o
>  obj-$(CONFIG_LEDS_TRIGGER_NETDEV)	+= ledtrig-netdev.o
>  obj-$(CONFIG_LEDS_TRIGGER_PATTERN)	+= ledtrig-pattern.o
> +obj-y					+= ledtrig-sound.o
> diff --git a/drivers/leds/trigger/ledtrig-sound.c b/drivers/leds/trigger/ledtrig-sound.c
> new file mode 100644
> index 0000000..608df35
> --- /dev/null
> +++ b/drivers/leds/trigger/ledtrig-sound.c
> @@ -0,0 +1,23 @@
> +/* GPLv2+.
> + * Copyright 2018 Pavel Machek <pavel@ucw.cz>
> + */
> +
> +#include <linux/kernel.h>
> +#include <linux/init.h>
> +#include <linux/leds.h>
> +
> +DEFINE_LED_TRIGGER(ledtrig_micmute);
> +
> +void ledtrig_mic_muted(bool muted)
> +{
> +	led_trigger_event(ledtrig_micmute, muted ? LED_FULL : LED_OFF);
> +}
> +EXPORT_SYMBOL(ledtrig_mic_muted);
> +
> +static int __init ledtrig_micmute_init(void)
> +{
> +	led_trigger_register_simple("mic-muted", &ledtrig_micmute);
> +
> +	return 0;
> +}
> +device_initcall(ledtrig_micmute_init);
> diff --git a/include/linux/leds.h b/include/linux/leds.h
> index e4a9a00..c30e1cb 100644
> --- a/include/linux/leds.h
> +++ b/include/linux/leds.h
> @@ -494,6 +494,14 @@ static inline void ledtrig_cpu(enum cpu_led_event evt)
>  }
>  #endif
>  
> +#ifdef CONFIG_LEDS_TRIGGERS
> +extern void ledtrig_mic_muted(bool m);
> +#else
> +static inline void ledtrig_mic_muted(bool m) {}
> +#endif
> +
> +
> +
>  #ifdef CONFIG_LEDS_BRIGHTNESS_HW_CHANGED
>  extern void led_classdev_notify_brightness_hw_changed(
>  	struct led_classdev *led_cdev, enum led_brightness brightness);
> diff --git a/sound/pci/hda/hda_generic.c b/sound/pci/hda/hda_generic.c
> index 276150f..3ec1f61 100644
> --- a/sound/pci/hda/hda_generic.c
> +++ b/sound/pci/hda/hda_generic.c
> @@ -29,6 +29,7 @@
>  #include <linux/string.h>
>  #include <linux/bitops.h>
>  #include <linux/module.h>
> +#include <linux/leds.h>
>  #include <sound/core.h>
>  #include <sound/jack.h>
>  #include <sound/tlv.h>
> @@ -3929,6 +3930,7 @@ static void call_micmute_led_update(struct hda_codec *codec)
>  		val = !spec->micmute_led.capture;
>  		break;
>  	}
> +	ledtrig_mic_muted(!spec->micmute_led.capture);
>  
>  	if (val == spec->micmute_led.led_value)
>  		return;
> diff --git a/sound/pci/hda/thinkpad_helper.c b/sound/pci/hda/thinkpad_helper.c
> index 568575b..f1b2265 100644
> --- a/sound/pci/hda/thinkpad_helper.c
> +++ b/sound/pci/hda/thinkpad_helper.c
> @@ -23,6 +23,8 @@ static void update_tpacpi_mute_led(void *private_data, int enabled)
>  	if (old_vmaster_hook)
>  		old_vmaster_hook(private_data, enabled);
>  
> +	printk("mute led... %d\n", !enabled);
> +
>  	if (led_set_func)
>  		led_set_func(TPACPI_LED_MUTE, !enabled);
>  }
> 
> 
> -- 
> (english) http://www.livejournal.com/~pavelmachek
> (cesky, pictures) http://atrey.karlin.mff.cuni.cz/~pavel/picture/horses/blog.html
> [2 Digital signature <application/pgp-signature (7bit)>]
> 
