Return-Path: <virtualization-bounces@lists.linux-foundation.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 23:32:21 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga002.jf.intel.com (orsmga002.jf.intel.com [10.7.209.21])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 49C8A58037D
	for <like.xu@linux.intel.com>; Fri, 23 Nov 2018 00:05:27 -0800 (PST)
Received: from orsmga102-1.jf.intel.com (HELO mga09.intel.com) ([10.7.208.27])
  by orsmga002-1.jf.intel.com with ESMTP; 23 Nov 2018 00:05:27 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AE1IwoRQkuB/mwQkx26BUw/ctf9psv+yvbD5Q0YIu?=
 =?us-ascii?q?jvd0So/mwa67ZhGFt8tkgFKBZ4jH8fUM07OQ7/iwHzRYqb+681k6OKRWUBEEjc?=
 =?us-ascii?q?hE1ycBO+WiTXPBEfjxciYhF95DXlI2t1uyMExSBdqsLwaK+i764jEdAAjwOhRo?=
 =?us-ascii?q?LerpBIHSk9631+ev8JHPfglEnjWwba9xIRmssQndqtQdjJd/JKo21hbHuGZDdf?=
 =?us-ascii?q?5MxWNvK1KTnhL86dm18ZV+7SleuO8v+tBZX6nicKs2UbJXDDI9M2Ao/8LrrgXM?=
 =?us-ascii?q?TRGO5nQHTGoblAdDDhXf4xH7WpfxtTb6tvZ41SKHM8D6Uaw4VDK/5KptVRTmij?=
 =?us-ascii?q?oINyQh/W/XlMJ+kaxVrhGmqRN9zY7bb5mVOfh8cK7SYN8XS3ZNUdpeWSxaHIyx?=
 =?us-ascii?q?dJcPAugbMOpEtYTxu0UCoB2jDgesHuPvzTpIi2fy06IkyeshFxjK0hYgH9IPtH?=
 =?us-ascii?q?TUrc31NL8MXuuo0aTI1yjDYO9V2Tjj8ojDbxcsofOSUr1qd8rd0FEvFwPEjlWU?=
 =?us-ascii?q?qIzlJyuV2foXv2eA9epgSP6gi205pAFruTWg3N0siozTio0JzVDE8Dx0zYAoLt?=
 =?us-ascii?q?O2T057ZMSrEJpWtyyCM4t2Q8UiQ3xnuSY0zb0GpJi7czUQx5Q7xh7fbPqHf5KP?=
 =?us-ascii?q?4hL5W+acJypzinF9eL+nmhq//lSsxvfiWsWpzVpGtDdJn9jIu3wXyhDf9NCLRu?=
 =?us-ascii?q?Vg8kqjwzqDyg/e5v1eLUwpiabXNoQtz7wsmpcVrE/NBDX5mF/sg6+Tbkgk+van?=
 =?us-ascii?q?6+DgYrj+o5+TLY50igXkPqQqm8y/B/k4MwcAX2ic5OS80qDs8lflQLVLif02lL?=
 =?us-ascii?q?PVsJfAJcQUvqK5AglV3Zg/6xunEjur38gUkWMZIF5YZR6LlZXlNlDKLfziEPuz?=
 =?us-ascii?q?nUygkDJxyPDHOr3hDI/NLn/GkLr5Y7Z96lRcyBYuzd9F45JUC7AAL+jvWk/ws9?=
 =?us-ascii?q?zYCAY1PBezw+b6DtVyyp0RWXmUD6+dMaPSqkOI5vk1L+mIZY8Vviv9Kvc86/7g?=
 =?us-ascii?q?in85hFkdcrSz0psLaXC4GfJmL1+eYXr2jdcNCX0KsRYmTOz2lF2CViZeZ3KzX6?=
 =?us-ascii?q?I/+D43Eo2nDZrYS4CpgbyB2jq7H5JMamBHDFCMDWnnd4GeV/gQbyKSJ5wprzof?=
 =?us-ascii?q?SLL0S5M9zQr880j+yqF7NazQ+ysFpZzkyd557vHSkhd08iZ7SMGU0mWIRmczmX?=
 =?us-ascii?q?sURjgwx+dhoFZh116H0Lpxn/1fE49u4ehUWFI/PJ/Y0+soFdHoRh/IetabQUqn?=
 =?us-ascii?q?RdPjGzwoU98q3/cKYl1hAJOmjxbez2+kBKITm7WXBZsytKXG0C/qOsx/xn3agb?=
 =?us-ascii?q?QnlEQsWcBVNGer1ZJ4ognUAovUu0GYjLqxM6Ad2jPdsWmE0GyCtV1ZVwg2Vr/K?=
 =?us-ascii?q?GTgbZ03LvZHh7ULqUbCjE/IkPxFHxMrELbFFLpXlgEtHT/r/ItnTS3y+ln32Bh?=
 =?us-ascii?q?uSwL6IKo3wdCFVwiTHFFUNlwEB9GqHMg4WAia6v3mYCD1oCEKqbUTx9+V3tHK8?=
 =?us-ascii?q?SAkz1Q7OJ1Ngzaa0/VsZiOK0T/IIwqlCvy46qi4xG06w2ZTREdXE7whmZqJ0Md?=
 =?us-ascii?q?ks/Fpck2XDuEg1O4e8B7pvil4Xb0J8uEa9+Q9wD9BinMEs6UsqzQ5zMbqVmHlb?=
 =?us-ascii?q?ajib0Iq4br/aI2+35BCub6/OwlyY2syL8aQC8twxsVCltwasQBlxu0572sVYhi?=
 =?us-ascii?q?PPrq7BCxAfBMr8?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ALAACUs/dbhwyp04xiHAEBAQQBAQcEA?=
 =?us-ascii?q?QGBUQcBAQsBgmmBKYwRX4sfgyuWHYEkA0cZGAsJg3qEWCI0CQ0BAwEBAQEBAQI?=
 =?us-ascii?q?BEwEBAQoLCQgpIwyCNgUCAxgJglwBAgMBAQEkEwwKHgsDAwECBgEBQAQECAMBI?=
 =?us-ascii?q?wEvBxIFgxwBggEEAQqoGjOKEwWHXoQrghaBEYYtAQSHOQKPXI9gRgcChnyGGIQ?=
 =?us-ascii?q?QI4lPhzmNQ4ptgUZsgSFNI1CCbIInF4hehT4/AQExgQeKK4F3AQE?=
X-IPAS-Result: =?us-ascii?q?A0ALAACUs/dbhwyp04xiHAEBAQQBAQcEAQGBUQcBAQsBgmm?=
 =?us-ascii?q?BKYwRX4sfgyuWHYEkA0cZGAsJg3qEWCI0CQ0BAwEBAQEBAQIBEwEBAQoLCQgpI?=
 =?us-ascii?q?wyCNgUCAxgJglwBAgMBAQEkEwwKHgsDAwECBgEBQAQECAMBIwEvBxIFgxwBggE?=
 =?us-ascii?q?EAQqoGjOKEwWHXoQrghaBEYYtAQSHOQKPXI9gRgcChnyGGIQQI4lPhzmNQ4ptg?=
 =?us-ascii?q?UZsgSFNI1CCbIInF4hehT4/AQExgQeKK4F3AQE?=
X-IronPort-AV: E=Sophos;i="5.56,268,1539673200"; 
   d="scan'208";a="54505404"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from mail.linuxfoundation.org ([140.211.169.12])
  by mtab.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 00:05:26 -0800
Received: from mail.linux-foundation.org (localhost [127.0.0.1])
	by mail.linuxfoundation.org (Postfix) with ESMTP id 0566BC96;
	Thu, 22 Nov 2018 19:39:47 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@mail.linuxfoundation.org
Received: from smtp1.linuxfoundation.org (smtp1.linux-foundation.org
	[172.17.192.35])
	by mail.linuxfoundation.org (Postfix) with ESMTPS id 13BA2C83;
	Thu, 22 Nov 2018 19:39:45 +0000 (UTC)
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
Received: from foss.arm.com (usa-sjc-mx-foss1.foss.arm.com [217.140.101.70])
	by smtp1.linuxfoundation.org (Postfix) with ESMTP id BEC415E2;
	Thu, 22 Nov 2018 19:39:44 +0000 (UTC)
Received: from usa-sjc-imap-foss1.foss.arm.com (unknown [10.72.51.249])
	by usa-sjc-mx-foss1.foss.arm.com (Postfix) with ESMTP id 870382E96;
	Thu, 22 Nov 2018 11:39:44 -0800 (PST)
Received: from ostrya.cambridge.arm.com (ostrya.cambridge.arm.com
	[10.1.196.78])
	by usa-sjc-imap-foss1.foss.arm.com (Postfix) with ESMTPA id 295A73F575; 
	Thu, 22 Nov 2018 11:39:41 -0800 (PST)
From: Jean-Philippe Brucker <jean-philippe.brucker@arm.com>
To: iommu@lists.linux-foundation.org, linux-pci@vger.kernel.org,
	devicetree@vger.kernel.org, virtualization@lists.linux-foundation.org,
	virtio-dev@lists.oasis-open.org, joro@8bytes.org, mst@redhat.com
Subject: [PATCH v5 4/7] PCI: OF: Initialize dev->fwnode appropriately
Date: Thu, 22 Nov 2018 19:37:58 +0000
Message-Id: <20181122193801.50510-5-jean-philippe.brucker@arm.com>
X-Mailer: git-send-email 2.19.1
In-Reply-To: <20181122193801.50510-1-jean-philippe.brucker@arm.com>
References: <20181122193801.50510-1-jean-philippe.brucker@arm.com>
MIME-Version: 1.0
X-Spam-Status: No, score=-6.9 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_HI
	autolearn=ham version=3.3.1
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on
	smtp1.linux-foundation.org
Cc: mark.rutland@arm.com, lorenzo.pieralisi@arm.com,
	tnowicki@caviumnetworks.com, marc.zyngier@arm.com,
	robin.murphy@arm.com, will.deacon@arm.com, eric.auger@redhat.com,
	robh+dt@kernel.org, bhelgaas@google.com, kvmarm@lists.cs.columbia.edu
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.12
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>,
	<mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>,
	<mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Sender: virtualization-bounces@lists.linux-foundation.org
Errors-To: virtualization-bounces@lists.linux-foundation.org

For PCI devices that have an OF node, set the fwnode as well. This way
drivers that rely on fwnode don't need the special case described by
commit f94277af03ea ("of/platform: Initialise dev->fwnode appropriately").

Acked-by: Bjorn Helgaas <bhelgaas@google.com>
Signed-off-by: Jean-Philippe Brucker <jean-philippe.brucker@arm.com>
---
 drivers/pci/of.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/drivers/pci/of.c b/drivers/pci/of.c
index 4c4217d0c3f1..c272ecfcd038 100644
--- a/drivers/pci/of.c
+++ b/drivers/pci/of.c
@@ -21,12 +21,15 @@ void pci_set_of_node(struct pci_dev *dev)
 		return;
 	dev->dev.of_node = of_pci_find_child_device(dev->bus->dev.of_node,
 						    dev->devfn);
+	if (dev->dev.of_node)
+		dev->dev.fwnode = &dev->dev.of_node->fwnode;
 }
 
 void pci_release_of_node(struct pci_dev *dev)
 {
 	of_node_put(dev->dev.of_node);
 	dev->dev.of_node = NULL;
+	dev->dev.fwnode = NULL;
 }
 
 void pci_set_bus_of_node(struct pci_bus *bus)
@@ -35,12 +38,16 @@ void pci_set_bus_of_node(struct pci_bus *bus)
 		bus->dev.of_node = pcibios_get_phb_of_node(bus);
 	else
 		bus->dev.of_node = of_node_get(bus->self->dev.of_node);
+
+	if (bus->dev.of_node)
+		bus->dev.fwnode = &bus->dev.of_node->fwnode;
 }
 
 void pci_release_bus_of_node(struct pci_bus *bus)
 {
 	of_node_put(bus->dev.of_node);
 	bus->dev.of_node = NULL;
+	bus->dev.fwnode = NULL;
 }
 
 struct device_node * __weak pcibios_get_phb_of_node(struct pci_bus *bus)
-- 
2.19.1

_______________________________________________
Virtualization mailing list
Virtualization@lists.linux-foundation.org
https://lists.linuxfoundation.org/mailman/listinfo/virtualization
