Return-Path: <virtualization-bounces@lists.linux-foundation.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 08:31:07 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga004.fm.intel.com (fmsmga004.fm.intel.com [10.253.24.48])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 8D45658037D
	for <like.xu@linux.intel.com>; Thu, 22 Nov 2018 11:40:09 -0800 (PST)
Received: from orsmga106.jf.intel.com ([10.7.208.65])
  by fmsmga004-1.fm.intel.com with ESMTP; 22 Nov 2018 11:40:09 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AnE4rih9Dw+AhXv9uRHKM819IXTAuvvDOBiVQ1KB+?=
 =?us-ascii?q?0OkeIJqq85mqBkHD//Il1AaPAd2Lraocw8Pt8InYEVQa5piAtH1QOLdtbDQizf?=
 =?us-ascii?q?ssogo7HcSeAlf6JvO5JwYzHcBFSUM3tyrjaRsdF8nxfUDdrWOv5jAOBBr/KRB1?=
 =?us-ascii?q?JuPoEYLOksi7ze+/94HQbglSmDaxfa55IQmrownWqsQYm5ZpJLwryhvOrHtIeu?=
 =?us-ascii?q?BWyn1tKFmOgRvy5dq+8YB6/ShItP0v68BPUaPhf6QlVrNYFygpM3o05MLwqxbO?=
 =?us-ascii?q?SxaE62YGXWUXlhpIBBXF7A3/U5zsvCb2qvZx1S+HNsDwULs6Wymt771zRRHoli?=
 =?us-ascii?q?kJKjA3/mLQhMN/lKJWohCvqhNiz4PafI2aKPVwfrjDct4BWWpMXNxcWzBbD4+g?=
 =?us-ascii?q?cYcCCfcKM+ZCr4n6olsDtR+wChe2C+Pp0zNGnH/23aw+0+QgCQHGxBIvFM8TvX?=
 =?us-ascii?q?TOsdX6KKQSXv6vzKLVyjjDbe1Z1i376ITRahAhofCMXbZxccrJ0UkgCRnJgU6K?=
 =?us-ascii?q?qYz4IzyV1foCs3KA4uV6T+KvjnQrpB12ojiq38ohjJTCiIwSylDB7yp5wYA1KM?=
 =?us-ascii?q?W9SEFhYN6kFIJcuDuAN4RqQsMiQn9otzggxrIavp67eTAGyJAmxx7ZdvyGfJGE?=
 =?us-ascii?q?7Qj5VOaUOzt4g2hleL2nixa28EigzPD8V8a60FZNsypFlMTDuWoR1xzS7ciHTO?=
 =?us-ascii?q?Fx/kC72TaAzwzT6PlELlsularGN5EhwaA/loAJvUTFACD2hEP7h7KVeEU84uWk?=
 =?us-ascii?q?9uvqbqn8qpOCKoN4lxvyPrkvl8G7G+g0LxYCU3CF9eih1rDv51D1TbpWgvEsj6?=
 =?us-ascii?q?XVrI3WKd4Zq6KlBQJez5wt5AylDzi81dQVhXkHI0xBeBKAl4XpPkvBIPH8Dful?=
 =?us-ascii?q?h1SskTFrx+3JP73vBZXNM37Dn6r7crZh6k5czwwzwcpY55JOBbENOPPzWknvu9?=
 =?us-ascii?q?zEFhI1LgO5z/r9BNljy48SRHiDDrKYPa7Wq1OE+/wjL/GJZIAPuTb9L/Yl5+Tp?=
 =?us-ascii?q?jX88gVIdY6ip3YELaHClBPtmJ0SZYHv2jdcdEGcKuQw+QPXxh12FTD5TYWq9UL?=
 =?us-ascii?q?wn5jwgDIKmDJzDRpy2gLCb2Ce7H5tWZn1JC1yVH3focJiEW/ERZy2IPs9hkzsE?=
 =?us-ascii?q?Vb67R48mzxGuuxf2y6B7IerM5i0YqZXj2cBx5+3SlhE96yZ4DsuA02yWS2F0n2?=
 =?us-ascii?q?UIRyI53axloEx9zEuD3rZ8g/BCCdNT4PZJAU8HM4XBxbl6F8zqQVCGOdOIU0q9?=
 =?us-ascii?q?BNGnBywhQNUsxdMHf0d6HZOllB+E2iOrB7ockfuMHIA19aTHmGbwPdpgwnLHxq?=
 =?us-ascii?q?A9jl4gEfZJLnCs06t29gzPANzXkl+Fiq+udLYVwC/K8iKZwHOTsVpEeApxSrne?=
 =?us-ascii?q?G3QeYFbG6Nr++0XORqOvDrJhNRFOntWfIKlHYcG8kFNdWf34M87faW/ip2DlBB?=
 =?us-ascii?q?GNw66kaIvxZ35b2CTbFVhBnQcO+3qPKQk5AGGmuW2aRDhvE0//Jlvn8MFgp36h?=
 =?us-ascii?q?CEw51QeHawtmzbXxshIYm/2XRu8J078spigssXN3EUy70taQDMCP40J/fb9AfN?=
 =?us-ascii?q?o54UVOyWPesSR5P4e8NOZmh1gDY0F5uF7o2xxrC4JG188wozdi0gtoNaOflV9M?=
 =?us-ascii?q?aRuc3IvsIfvQI3Lz51Woc6PQnFbE35Le+KAV79xooUT/sRrvEVAttz1iyMV9yX?=
 =?us-ascii?q?aQ5pzWSgEVVMHfSEEyojp3rrefWik844LMzXAkG7OpuTzPwZp9BuYszFO4f9Zb?=
 =?us-ascii?q?MbucGUn4CdARBMW0AOUwnh6iaRdSb7Maz7I9I87zL6jO46WsJus1xD8=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AQAACLBfdbhwyp04xjHAEBAQQBAQcEA?=
 =?us-ascii?q?QGBUQcBAQsBgVqBD4EpjBFfiyGDK5YcgXEWGA0Hg3qEWCI0CQ0BAwEBAQEBAQI?=
 =?us-ascii?q?BEwEBAQoLCQgpIwyCNgUCAxgJgl0CAQMBASQTDAoeCwMDAQIGAkAEBAgDASMBN?=
 =?us-ascii?q?hIFglFLAYIBBAEKqXkzhC0BhW+HXoQrghaBEYYtAQICgT4BAYV5Ao9cj2BGBwK?=
 =?us-ascii?q?GfIYYhBAjgiaHKYc5jUOKbYFGgg1NI1ANE4JMCYIbGoNKhFk7hT4/AQExAQGBB?=
 =?us-ascii?q?YoXR4F3AQE?=
X-IPAS-Result: =?us-ascii?q?A0AQAACLBfdbhwyp04xjHAEBAQQBAQcEAQGBUQcBAQsBgVq?=
 =?us-ascii?q?BD4EpjBFfiyGDK5YcgXEWGA0Hg3qEWCI0CQ0BAwEBAQEBAQIBEwEBAQoLCQgpI?=
 =?us-ascii?q?wyCNgUCAxgJgl0CAQMBASQTDAoeCwMDAQIGAkAEBAgDASMBNhIFglFLAYIBBAE?=
 =?us-ascii?q?KqXkzhC0BhW+HXoQrghaBEYYtAQICgT4BAYV5Ao9cj2BGBwKGfIYYhBAjgiaHK?=
 =?us-ascii?q?Yc5jUOKbYFGgg1NI1ANE4JMCYIbGoNKhFk7hT4/AQExAQGBBYoXR4F3AQE?=
X-IronPort-AV: E=Sophos;i="5.56,266,1539673200"; 
   d="scan'208";a="41225306"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from mail.linuxfoundation.org ([140.211.169.12])
  by mtab.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 22 Nov 2018 11:39:43 -0800
Received: from mail.linux-foundation.org (localhost [127.0.0.1])
	by mail.linuxfoundation.org (Postfix) with ESMTP id 566CFA70;
	Thu, 22 Nov 2018 19:39:33 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@mail.linuxfoundation.org
Received: from smtp1.linuxfoundation.org (smtp1.linux-foundation.org
	[172.17.192.35])
	by mail.linuxfoundation.org (Postfix) with ESMTPS id AAAEE8D4;
	Thu, 22 Nov 2018 19:39:31 +0000 (UTC)
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
Received: from foss.arm.com (usa-sjc-mx-foss1.foss.arm.com [217.140.101.70])
	by smtp1.linuxfoundation.org (Postfix) with ESMTP id 93A686C5;
	Thu, 22 Nov 2018 19:39:30 +0000 (UTC)
Received: from usa-sjc-imap-foss1.foss.arm.com (unknown [10.72.51.249])
	by usa-sjc-mx-foss1.foss.arm.com (Postfix) with ESMTP id 07F2D2E96;
	Thu, 22 Nov 2018 11:39:30 -0800 (PST)
Received: from ostrya.cambridge.arm.com (ostrya.cambridge.arm.com
	[10.1.196.78])
	by usa-sjc-imap-foss1.foss.arm.com (Postfix) with ESMTPA id 9B89B3F575; 
	Thu, 22 Nov 2018 11:39:26 -0800 (PST)
From: Jean-Philippe Brucker <jean-philippe.brucker@arm.com>
To: iommu@lists.linux-foundation.org, linux-pci@vger.kernel.org,
	devicetree@vger.kernel.org, virtualization@lists.linux-foundation.org,
	virtio-dev@lists.oasis-open.org, joro@8bytes.org, mst@redhat.com
Subject: [PATCH v5 0/7] Add virtio-iommu driver
Date: Thu, 22 Nov 2018 19:37:54 +0000
Message-Id: <20181122193801.50510-1-jean-philippe.brucker@arm.com>
X-Mailer: git-send-email 2.19.1
MIME-Version: 1.0
X-Spam-Status: No, score=-6.9 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_HI
	autolearn=ham version=3.3.1
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on
	smtp1.linux-foundation.org
Cc: mark.rutland@arm.com, lorenzo.pieralisi@arm.com,
	tnowicki@caviumnetworks.com, marc.zyngier@arm.com,
	robin.murphy@arm.com, will.deacon@arm.com, eric.auger@redhat.com,
	robh+dt@kernel.org, bhelgaas@google.com, kvmarm@lists.cs.columbia.edu
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.12
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>,
	<mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>,
	<mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Sender: virtualization-bounces@lists.linux-foundation.org
Errors-To: virtualization-bounces@lists.linux-foundation.org

Implement the virtio-iommu driver, following specification v0.9 [1].

Since v4 [2] I fixed the issues reported by Eric, and added Reviewed-by
from Eric and Rob. Thanks!

I changed the specification to fix one inconsistency discussed in v4.
That the device fills the probe buffer with zeroes is now a "SHOULD"
instead of a "MAY", since it's the only way for the driver to know if
the device wrote the status. Existing devices already do this. In
addition the device now needs to fill the three padding bytes at the
tail with zeroes.

You can find Linux driver and kvmtool device on branches
virtio-iommu/v0.9 [3]. I also lightly tested with Eric's latest QEMU
device [4].

[1] Virtio-iommu specification v0.9, sources, pdf and diff from v0.8
    git://linux-arm.org/virtio-iommu.git virtio-iommu/v0.9
    http://jpbrucker.net/virtio-iommu/spec/v0.9/virtio-iommu-v0.9.pdf
    http://jpbrucker.net/virtio-iommu/spec/diffs/virtio-iommu-pdf-diff-v0.8-v0.9.pdf

[2] [PATCH v4 0/7] Add virtio-iommu driver
    https://lists.linuxfoundation.org/pipermail/iommu/2018-November/031074.html

[3] git://linux-arm.org/linux-jpb.git virtio-iommu/v0.9
    git://linux-arm.org/kvmtool-jpb.git virtio-iommu/v0.9

[4] [RFC v9 00/17] VIRTIO-IOMMU device
    https://www.mail-archive.com/qemu-devel@nongnu.org/msg575578.html

Jean-Philippe Brucker (7):
  dt-bindings: virtio-mmio: Add IOMMU description
  dt-bindings: virtio: Add virtio-pci-iommu node
  of: Allow the iommu-map property to omit untranslated devices
  PCI: OF: Initialize dev->fwnode appropriately
  iommu: Add virtio-iommu driver
  iommu/virtio: Add probe request
  iommu/virtio: Add event queue

 .../devicetree/bindings/virtio/iommu.txt      |   66 +
 .../devicetree/bindings/virtio/mmio.txt       |   30 +
 MAINTAINERS                                   |    7 +
 drivers/iommu/Kconfig                         |   11 +
 drivers/iommu/Makefile                        |    1 +
 drivers/iommu/virtio-iommu.c                  | 1157 +++++++++++++++++
 drivers/of/base.c                             |   10 +-
 drivers/pci/of.c                              |    7 +
 include/uapi/linux/virtio_ids.h               |    1 +
 include/uapi/linux/virtio_iommu.h             |  161 +++
 10 files changed, 1448 insertions(+), 3 deletions(-)
 create mode 100644 Documentation/devicetree/bindings/virtio/iommu.txt
 create mode 100644 drivers/iommu/virtio-iommu.c
 create mode 100644 include/uapi/linux/virtio_iommu.h

-- 
2.19.1

_______________________________________________
Virtualization mailing list
Virtualization@lists.linux-foundation.org
https://lists.linuxfoundation.org/mailman/listinfo/virtualization
