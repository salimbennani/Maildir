Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 24 Nov 2018 12:37:56 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga001.fm.intel.com (fmsmga001.fm.intel.com [10.253.24.23])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 1D9CA58037D
	for <like.xu@linux.intel.com>; Fri, 23 Nov 2018 16:18:05 -0800 (PST)
Received: from orsmga106.jf.intel.com ([10.7.208.65])
  by fmsmga001-1.fm.intel.com with ESMTP; 23 Nov 2018 16:18:04 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3A0Ms2bxWIAzKw5jpopxF1GIUGBMfV8LGtZVwlr6E/?=
 =?us-ascii?q?grcLSJyIuqrYbRGBt8tkgFKBZ4jH8fUM07OQ7/iwHzRYqb+681k6OKRWUBEEjc?=
 =?us-ascii?q?hE1ycBO+WiTXPBEfjxciYhF95DXlI2t1uyMExSBdqsLwaK+i764jEdAAjwOhRo?=
 =?us-ascii?q?LerpBIHSk9631+ev8JHPfglEnjWwba9xIRmssQndqtQdjJd/JKo21hbHuGZDdf?=
 =?us-ascii?q?5MxWNvK1KTnhL86dm18ZV+7SleuO8v+tBZX6nicKs2UbJXDDI9M2Ao/8LrrgXM?=
 =?us-ascii?q?TRGO5nQHTGoblAdDDhXf4xH7WpfxtTb6tvZ41SKHM8D6Uaw4VDK/5KpwVhTmlD?=
 =?us-ascii?q?kIOCI48GHPi8x/kqRboA66pxdix4LYeZyZOOZicq/Ye94RWGhPUdtLVyFZDI2y?=
 =?us-ascii?q?b5UBAekPPelXs4byulkBohWjCwm0Bu7hyDBFimL40KEmzeshChrL3BA8E98UrH?=
 =?us-ascii?q?jYsM/4OLkUXOuozKfI1zLDb/ZO1Dvz54bIdxEhofWNXbJ3bMHfyFMjHB7bg1WX?=
 =?us-ascii?q?tYzqJT2Z3fkKvmeH6OpgSfighnU8pAFruDeg3N8shpPOhoIPxVDJ7CN0y5s2K9?=
 =?us-ascii?q?2gUEN3f8KoHZhKuy2HKod7QdkuT39mtSs60LEKpJy2cDAXxJg5xBPTcfyKfoyS?=
 =?us-ascii?q?7h79SOqdOyl0iG9kdb+5mh2861KvyvfmWcmxyFtKrjRKkt3Ltn0V0xzT69OHSu?=
 =?us-ascii?q?dm/ku71jaP0R3T5vtDIUAumqrXM58hwrgumZoPqUnPADP6lUbsgKOLa0kp+fKk?=
 =?us-ascii?q?5/rpb7jmvJOQKo15hhn7Mqs0m8y/Beo4MhIJX2ie4em8zaPs/UjkQLlTk/I5jL?=
 =?us-ascii?q?fZv47eJcgCvaG5BBJV0oA/5BmhFDeq19AYnXgELF1bYh6GgJXpNknKIPD5C/e/?=
 =?us-ascii?q?nlutnC1qx/DAIr3uHJHNImLfn7fmeLZw8EhcyA01zdBQ4ZJUF6sNIPXpWk/+rN?=
 =?us-ascii?q?DYFAM2MxSow+b7D9VwzoceWWOMAqCHKq/TvkKI6/krI+mNYo8VpTn8J+Ik5/7o?=
 =?us-ascii?q?kX82h1sdcbO10psQbXDrVslgOFiTNHrwns8aQyBNugslUPesjlqEXjhOIXGoUO?=
 =?us-ascii?q?U57zA/DYugSoDbWoGqhqfGxSq+A9haa35LDgOxF2z1fdCBUvYIdCXAO8Jkj3kI?=
 =?us-ascii?q?WKasT8o72AizuRTm47xgKOXS52sfr520z8V/5eDYiUQv8ydpBd+WyWCHQjJImT?=
 =?us-ascii?q?YHWjYw07p4p0M72laK1oB3hvVZEZpY4PYafB09MMuW4ul7D9H1Ei2HNvyOVF/s?=
 =?us-ascii?q?CoGtBi04ZtgrytYWJUFnFIPx3Vj4wyO2DupNxPSwD5su//eZhiCpKg=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ACAAAwmPhbhxHrdtBjGgEBAQEBAgEBA?=
 =?us-ascii?q?QEHAgEBAQGBUQUBAQEBCwGBMIJijBFfiyGCDYkMhHiJOIF1EhgUiFoiNAkNAQM?=
 =?us-ascii?q?BAQEBAQECARMBAQEKCwkIGw4jDII2BQIDGgEGglwBAgMBAiQTBgEBBAopAQIDA?=
 =?us-ascii?q?QIGAQEKGAkdCAMBCwUNTwWDHIFqAxUBBKVqgWwzgnYBAQWEeA2CEQiKbYEcEQa?=
 =?us-ascii?q?Bf4QjglaCdYJogiaQEo9ELgcCAo4CgyAjColFhzmOTYljgUaCDX0IgyeCGwwXg?=
 =?us-ascii?q?0qFFIVcVIECBSETiXaBdwEB?=
X-IPAS-Result: =?us-ascii?q?A0ACAAAwmPhbhxHrdtBjGgEBAQEBAgEBAQEHAgEBAQGBUQU?=
 =?us-ascii?q?BAQEBCwGBMIJijBFfiyGCDYkMhHiJOIF1EhgUiFoiNAkNAQMBAQEBAQECARMBA?=
 =?us-ascii?q?QEKCwkIGw4jDII2BQIDGgEGglwBAgMBAiQTBgEBBAopAQIDAQIGAQEKGAkdCAM?=
 =?us-ascii?q?BCwUNTwWDHIFqAxUBBKVqgWwzgnYBAQWEeA2CEQiKbYEcEQaBf4QjglaCdYJog?=
 =?us-ascii?q?iaQEo9ELgcCAo4CgyAjColFhzmOTYljgUaCDX0IgyeCGwwXg0qFFIVcVIECBSE?=
 =?us-ascii?q?TiXaBdwEB?=
X-IronPort-AV: E=Sophos;i="5.56,271,1539673200"; 
   d="scan'208";a="41347207"
X-Amp-Result: UNSCANNABLE
X-Amp-File-Uploaded: False
Unscannable: 2
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 23 Nov 2018 16:18:03 -0800
Received: from localhost ([::1]:54720 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gQLe6-00022e-Uo
	for like.xu@linux.intel.com; Fri, 23 Nov 2018 19:18:02 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:36960)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <cota@braap.org>) id 1gQLdl-0001ua-Oq
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 19:17:42 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <cota@braap.org>) id 1gQLdh-00066M-Bm
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 19:17:41 -0500
Received: from out4-smtp.messagingengine.com ([66.111.4.28]:39383)
	by eggs.gnu.org with esmtps (TLS1.0:DHE_RSA_AES_256_CBC_SHA1:32)
	(Exim 4.71) (envelope-from <cota@braap.org>) id 1gQLdh-0005zF-7h
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 19:17:37 -0500
Received: from compute4.internal (compute4.nyi.internal [10.202.2.44])
	by mailout.nyi.internal (Postfix) with ESMTP id 5A1C621841;
	Fri, 23 Nov 2018 19:17:36 -0500 (EST)
Received: from mailfrontend2 ([10.202.2.163])
	by compute4.internal (MEProxy); Fri, 23 Nov 2018 19:17:36 -0500
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=braap.org; h=
	date:from:to:cc:subject:message-id:references:mime-version
	:content-type:in-reply-to; s=mesmtp; bh=KiidlgDFiqX8wPlXrqesbI8o
	qdg72zwkPhAjTchJP+w=; b=wKvx8vcxFx1cG+hgL0ULlgwK5AaaRAXJ+MZCY7XC
	4OYzTbctUtYhakGfhDIswiWxHL1DQZF/ZAazgbbePue5+13f0ufcICwoIFuHfuk3
	00ygAvx6NGX7HgghTgK0/hLHqwiPAGzp7ARYaK7TZ1sS/XldcL5HeazJzntXrJOh
	CkM=
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=
	messagingengine.com; h=cc:content-type:date:from:in-reply-to
	:message-id:mime-version:references:subject:to:x-me-proxy
	:x-me-proxy:x-me-sender:x-me-sender:x-sasl-enc; s=fm1; bh=Kiidlg
	DFiqX8wPlXrqesbI8oqdg72zwkPhAjTchJP+w=; b=flZXkQZ92qgFBZAPuIPeCf
	eiIURkqB70IL9mDX/ZZhUT6delVM+vYWE7OeX1LLyx1HE6HvjOJuiqwgfB3gH/jq
	ySEZzQh3oPi685Eosu7RDuRA/M9SmVq1MLkw0YnoHifkzkcAKstwrjTsyEVrF1h2
	e03Plzx2odVCXLC39kIaycC9nyzNuIXk7QCzkbJPbyUH1IiiHvL5xqA7gkm0COum
	Dp0mLAVDmR0H0AP/NAXiL3Qbm2sFLHA7cXeVDKmxDOLZ94sfMy3MIL0IH96e0JbQ
	Z7nVOzAiEFUDXKQnzMcyMSvMDuKyRZ+fkQHTihtozfwZ3OUU4YN8R/NIw8e0Blag
	==
X-ME-Sender: <xms:npj4W9ST8FKDqeo8VWNNwtm8Kc9qDvCEMBI0F6oYvaB5TAWv1C8RiA>
X-ME-Proxy: <xmx:npj4W8ycw3K_rZ10aKCmuaOdZPZLm6reI4EshNqh_MjEYccc8oJgpw>
	<xmx:npj4W__fwEbB2U32_Wx5-yb8QiWUVEmT_zFgumd5x8Kt7g2xfApnFg>
	<xmx:npj4W5K_TF2cJ_pRxjSNEWDA-PWiBOLQT6oRGn1M_nc0GLW0py2o6w>
	<xmx:npj4W894swIdyQWPNYU7PGrB8iOL7NJjHqd0AuGd8AtyvDFWoXddsg>
	<xmx:npj4W9ECDbASwCIi1TKsRSP_XUov65XdSQvfVVlKSqBcpvs3s-xSjg>
	<xmx:oJj4WxEAx27ouCnZPgQr9kY5J6kS-5aauAXSJi1sBeqrNUGF4YmJgw>
Received: from localhost (flamenco.cs.columbia.edu [128.59.20.216])
	by mail.messagingengine.com (Postfix) with ESMTPA id 7D2E1102EA;
	Fri, 23 Nov 2018 19:17:34 -0500 (EST)
Date: Fri, 23 Nov 2018 19:17:34 -0500
From: "Emilio G. Cota" <cota@braap.org>
To: guangrong.xiao@gmail.com
Message-ID: <20181124001734.GF17229@flamenco>
References: <20181122072028.22819-1-xiaoguangrong@tencent.com>
	<20181122072028.22819-3-xiaoguangrong@tencent.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20181122072028.22819-3-xiaoguangrong@tencent.com>
User-Agent: Mutt/1.9.4 (2018-02-28)
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 2.2.x-3.x [generic]
	[fuzzy]
X-Received-From: 66.111.4.28
Subject: Re: [Qemu-devel] [PATCH v3 2/5] util: introduce threaded workqueue
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: kvm@vger.kernel.org, mst@redhat.com, mtosatti@redhat.com,
	Xiao Guangrong <xiaoguangrong@tencent.com>, dgilbert@redhat.com,
	peterx@redhat.com, qemu-devel@nongnu.org, quintela@redhat.com,
	wei.w.wang@intel.com, jiang.biao2@zte.com.cn, pbonzini@redhat.com
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

On Thu, Nov 22, 2018 at 15:20:25 +0800, guangrong.xiao@gmail.com wrote:
> +static uint64_t get_free_request_bitmap(Threads *threads, ThreadLocal *thread)
> +{
> +    uint64_t request_fill_bitmap, request_done_bitmap, result_bitmap;
> +
> +    request_fill_bitmap = atomic_rcu_read(&thread->request_fill_bitmap);
> +    request_done_bitmap = atomic_rcu_read(&thread->request_done_bitmap);
> +    bitmap_xor(&result_bitmap, &request_fill_bitmap, &request_done_bitmap,
> +               threads->thread_requests_nr);

This is not wrong, but it's a big ugly. Instead, I would:

- Introduce bitmap_xor_atomic in a previous patch
- Use bitmap_xor_atomic here, getting rid of the rcu reads

Thanks,

		Emilio

