Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 24 Nov 2018 12:37:04 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga006.fm.intel.com (fmsmga006.fm.intel.com [10.253.24.20])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 17F65580460
	for <like.xu@linux.intel.com>; Fri, 23 Nov 2018 10:56:18 -0800 (PST)
Received: from orsmga103.jf.intel.com ([10.7.208.35])
  by fmsmga006-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 10:56:17 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3A6knXdRC4gWjVOXVsO3ckUyQJP3N1i/DPJgcQr6Af?=
 =?us-ascii?q?oPdwSP37p8+wAkXT6L1XgUPTWs2DsrQY07qQ6/iocFdDyK7JiGoFfp1IWk1Nou?=
 =?us-ascii?q?QttCtkPvS4D1bmJuXhdS0wEZcKflZk+3amLRodQ56mNBXdrXKo8DEdBAj0OxZr?=
 =?us-ascii?q?KeTpAI7SiNm82/yv95HJbAhEmDmwbaluIBmqsA7cqtQYjYx+J6gr1xDHuGFIe+?=
 =?us-ascii?q?NYxWNpIVKcgRPx7dqu8ZBg7ipdpesv+9ZPXqvmcas4S6dYDCk9PGAu+MLrrxjD?=
 =?us-ascii?q?QhCR6XYaT24bjwBHAwnB7BH9Q5fxri73vfdz1SWGIcH7S60/VC+85Kl3VhDnlC?=
 =?us-ascii?q?YHNyY48G7JjMxwkLlbqw+lqxBm3oLYfJ2ZOP94c6jAf90VWHBBU95eWCxPAIyy?=
 =?us-ascii?q?b4UBAekfM+lEsof9v1kDoxmxCAWxCu7j1iFHhmTt0K0mz+gsCx3K0BA8E98Mtn?=
 =?us-ascii?q?nfsdX7NL0VUeCw1KTG1yvMb+9I1jfn9YPGdQouoPGRUr1udcrRzVQkGgTdjlqO?=
 =?us-ascii?q?tYzqISmV2v4Is2eB7+tvSPygi2ojqwxqpjivx8EshZPThoIS0FzE8j95wIksKN?=
 =?us-ascii?q?C+VUV1YsakHYNOuy2GNIZ6WN4uT3xrtSog1LELt562cDIXxJkl3xLTdf2Kf5SK?=
 =?us-ascii?q?7x/mWuacIix3iG5gdb+whBu/8Eetx+jiWsWo1VtHqzRJn9fMu30Lyhfd8NKISu?=
 =?us-ascii?q?Fn8UekwTuP1x7c6uVDIU0skarbKoUhwqIrlpYJvkTDGDL2lF/xjK+MeUUo4umo?=
 =?us-ascii?q?6+L5bbX6vpKQKZN4hwLkPqgzh8CyAv40PhYAUmWb4+iwyb/u8VX8QLpQj/02lq?=
 =?us-ascii?q?fZsIrdJcQevqO5GhFa0oM+6xqmEjipzsoYkmcDLF5cYx2HiJXpO1fSL//mFvez?=
 =?us-ascii?q?hFCskDZox//YJLHgDYjNI2DHkLfge7Z99kFdxBAyzdBZ+5JbFLUBLOjvVU/2sd?=
 =?us-ascii?q?zVFRk5Mwuyw+boDtV9y5kSWWWVAq+WKK/Sq0OH5vozI+mQY48YoDL9K/km5/Hw?=
 =?us-ascii?q?l3M4lkIdcLKt3ZsWbnC4A/tnL1+YYXrqntcOD2MKshAiQ+ztjV3RGQNVfGu4Cq?=
 =?us-ascii?q?Ig+ikgWsXhCYbYWpvrhruH0yGmWJpMaSdDA1GIFH7uMIKcR/YLbjnVO8Jkj3kI?=
 =?us-ascii?q?WKasT9wc0wqzvlr/wrtjMu2G4yAdqNfv2cZ446jJmAgv+CdoJ8Ka1W6LUidzhG?=
 =?us-ascii?q?xfXCI83q10vRlgzEye27Nzmf1SGI9v4KZGXwE1OZnawO57FpimVQ/HcduOTlmk?=
 =?us-ascii?q?Q8iOASw4Ud8whdQJZhAuNc+li0X70janGfcwnq2HCZgwuvbE0mT8PYB4wmfK2a?=
 =?us-ascii?q?0lp10nRMJVMiuhnKEppFubPJLAj0jMz/XiTq8bxiOYsT7blWc=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0CtAQACTPhbhxHrdtBjgheBMYJig3mId?=
 =?us-ascii?q?4shgg16lkGBcxQYFIhaIjQJDQEDAQEBAQEBAgETAQEBCgsJCBsOIwyCNgUCAxo?=
 =?us-ascii?q?BBoJbAQEBAQIBAQIgBBkBAQQKKQECAgEBAgYBAQoLDQICIgQCAgMBHhIBBQEcB?=
 =?us-ascii?q?hMFgxyBeggBBJtBPIodcHwzgnYBAQWHFQgSeYp+gVc/gRGCFEk1iAKCV4kBUoF?=
 =?us-ascii?q?AlHEHAoIcBI8PGIFZjy+JbY40DyGBJYINMxowdAaCNYInFxKITIU+QTGBB4oqg?=
 =?us-ascii?q?XcBAQ?=
X-IPAS-Result: =?us-ascii?q?A0CtAQACTPhbhxHrdtBjgheBMYJig3mId4shgg16lkGBcxQ?=
 =?us-ascii?q?YFIhaIjQJDQEDAQEBAQEBAgETAQEBCgsJCBsOIwyCNgUCAxoBBoJbAQEBAQIBA?=
 =?us-ascii?q?QIgBBkBAQQKKQECAgEBAgYBAQoLDQICIgQCAgMBHhIBBQEcBhMFgxyBeggBBJt?=
 =?us-ascii?q?BPIodcHwzgnYBAQWHFQgSeYp+gVc/gRGCFEk1iAKCV4kBUoFAlHEHAoIcBI8PG?=
 =?us-ascii?q?IFZjy+JbY40DyGBJYINMxowdAaCNYInFxKITIU+QTGBB4oqgXcBAQ?=
X-IronPort-AV: E=Sophos;i="5.56,270,1539673200"; 
   d="scan'208";a="53488834"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 23 Nov 2018 10:56:15 -0800
Received: from localhost ([::1]:53961 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gQGch-0000Cu-2o
	for like.xu@linux.intel.com; Fri, 23 Nov 2018 13:56:15 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:41062)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <peter.maydell@linaro.org>) id 1gQGc9-0008IA-Ba
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 13:55:42 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <peter.maydell@linaro.org>) id 1gQGSB-0004tz-4N
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 13:45:24 -0500
Received: from mail-oi1-x235.google.com ([2607:f8b0:4864:20::235]:39033)
	by eggs.gnu.org with esmtps (TLS1.0:RSA_AES_128_CBC_SHA1:16)
	(Exim 4.71) (envelope-from <peter.maydell@linaro.org>)
	id 1gQGSA-0004sB-VI
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 13:45:23 -0500
Received: by mail-oi1-x235.google.com with SMTP id 192-v6so10686575oii.6
	for <qemu-devel@nongnu.org>; Fri, 23 Nov 2018 10:45:22 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=linaro.org; s=google;
	h=mime-version:references:in-reply-to:from:date:message-id:subject:to
	:cc; bh=ewNPkW0vRAGg8olO9/j7Ob48cDnVoZyAoUBHYj0F9NQ=;
	b=djrMWnCYuFg0lULEz4sT1Afi6aMO0/0QUC6Sz+4ydnKIDJhaSn+W/5p6T5hwNSSwzH
	a93+tXCWaUtnvv8aRj3xEYsaf4tZOP5EXxoRRdfzF0/2joDuDDlzzpiMYoD/BV6lxxK9
	QWiQuVh/Z9MfhCVvDFLTZPylAcFtxoB75oyAc=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
	d=1e100.net; s=20161025;
	h=x-gm-message-state:mime-version:references:in-reply-to:from:date
	:message-id:subject:to:cc;
	bh=ewNPkW0vRAGg8olO9/j7Ob48cDnVoZyAoUBHYj0F9NQ=;
	b=cak0bwnjZP33In0MRh+aDzaI39MiayiWjj1xQYGUzUgx7+mSFNOvA7Sg40tyqGscqV
	RzOwVLqb4mgcYgPthUKl/VCrNm0vbSOg5jX64B4Ahxaxbmx87rVo4SWiZtvHUwu7FlSL
	byO09thIoUaR4Hr+8wgopsqLj51cLpSBe/Uh6eGvRzrS35pvd/6J92CNFt+qhMIZnYej
	HaRTT5pERsJauVqMF2VD591CEG+fU4w9dB6DSn8L5whZVS/f/2j2I3gDk+IUpBBqdTCc
	S0rIwfkvieZbS9SghsbJxF41j4+N62r5oAUhZLIUnzD4HeNDp9ElYnuwNI0umXqfP2D4
	aCWQ==
X-Gm-Message-State: AGRZ1gL76r3rW9s58gkGvY0RIKhebn9GrXc0Hr7m0+PqLBTQVfSdcwkF
	Vu18Lqbyo6ogDfkIS+3DWyVVQJltdLfN3ya08EOSmA==
X-Google-Smtp-Source: AJdET5cHMSqiKpOS/aeYMevJGMcmjXWLB8YyjhJmF1M9qlO51T4xc73BohRYWExk1ML7h6fuKEGbQyS808rqFwHoNag=
X-Received: by 2002:aca:2dc9:: with SMTP id t192mr9611836oit.325.1542998722124;
	Fri, 23 Nov 2018 10:45:22 -0800 (PST)
MIME-Version: 1.0
References: <0184EA26B2509940AA629AE1405DD7F201F7BBE8@DGGEMA503-MBX.china.huawei.com>
In-Reply-To: <0184EA26B2509940AA629AE1405DD7F201F7BBE8@DGGEMA503-MBX.china.huawei.com>
From: Peter Maydell <peter.maydell@linaro.org>
Date: Fri, 23 Nov 2018 18:45:09 +0000
Message-ID: <CAFEAcA_abaoxA=myPszVrO59-hSazHAePRJXUCHKSFnoEdsfiw@mail.gmail.com>
To: gengdongjiu <gengdongjiu@huawei.com>
Content-Type: text/plain; charset="UTF-8"
X-detected-operating-system: by eggs.gnu.org: Genre and OS details not
	recognized.
X-Received-From: 2607:f8b0:4864:20::235
Subject: Re: [Qemu-devel] [PATCH RESEND v15 08/10] target-arm: kvm64: inject
 synchronous External Abort
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Eduardo Habkost <ehabkost@redhat.com>, kvm-devel <kvm@vger.kernel.org>,
	"Michael S. Tsirkin" <mst@redhat.com>, Marc Zyngier <marc.zyngier@arm.com>,
	=?UTF-8?B?QWxleCBCZW5uw6ll?= <alex.bennee@linaro.org>,
	Marcelo Tosatti <mtosatti@redhat.com>,
	QEMU Developers <qemu-devel@nongnu.org>,
	Shannon Zhao <shannon.zhaosl@gmail.com>,
	Zheng Xiang <zhengxiang9@huawei.com>, qemu-arm <qemu-arm@nongnu.org>,
	James Morse <james.morse@arm.com>, Paolo Bonzini <pbonzini@redhat.com>,
	Igor Mammedov <imammedo@redhat.com>, Laszlo Ersek <lersek@redhat.com>,
	Richard Henderson <rth@twiddle.net>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

On Wed, 21 Nov 2018 at 14:34, gengdongjiu <gengdongjiu@huawei.com> wrote:
>
> Hi Peter,
>   Thanks for the review and comments.
>
> >
> > On 8 November 2018 at 10:29, Dongjiu Geng <gengdongjiu@huawei.com> wrote:
> > > +bool write_part_cpustate_to_list(ARMCPU *cpu, ptrdiff_t fieldoffset)
> >
> > What is this about? Nothing else in QEMU needs to mess with the cpustate synchronization. My first assumption is that you should not
> > need to do so either.
>
> We should change the guest CP15 ESR_EL1's value, the only method is to change the cpu->cpreg_values[] in QEMU, then QEMU call write_list_to_kvmstate()
> to set the cpu->cpreg_values[] to KVM which include the specified ESR_EL1 value, KVM do world switch, and then set the specified ESR_EL1's value to guest kernel.

Ah, I see. This is a bug in our current handling of the register
state, where we implicitly assume that nothing in QEMU will ever
want to change any system register values. This assumption is
now false -- kvm_arm_handle_debug() broke it -- so we need to
fix the code that does kvm_arch_put_registers(). There is a comment
in the kvm32.c version of that function about this. (The kvm64.c
version has the same assumption but doesn't comment on it.)

We should (ideally) fix this bug in the code that does register
syncing, without requiring places in QEMU that update system
registers to have to manually indicate which registers they have
changed. I'll have a think about how best to do this.

> About the detailed explanation, as shown in [2].
>
> kvm_arm_handle_debug() does not need to do this because QEMU does not need to change CP15 registers, such as ESR_EL1.

kvm_arm_handle_debug does change ESR_EL1: it is injecting an exception
and so should set the exception register. This happens when it
calls the do_interrupt() hook, because arm_cpu_do_interrupt_aarch64()
writes to env->cp15.esr_el[new_el].

I'm not entirely sure why this is working today, in fact.
Alex, did you test whether our debug-exception-injection
reports the correct ESR_EL1 to the guest ?

> > > +/* Inject synchronous external abort */ static void
> > > +kvm_inject_arm_sea(CPUState *c) {
> > > +    ARMCPU *cpu = ARM_CPU(c);
> > > +    CPUARMState *env = &cpu->env;
> > > +    CPUClass *cc = CPU_GET_CLASS(c);
> > > +    uint32_t esr;
> > > +    int ret;
> > > +
> > > +    /* This exception is synchronous data abort */
> > > +    c->exception_index = EXCP_DATA_ABORT;
> > > +    /* Inject the exception to guest EL1 */
> > > +    env->exception.target_el = 1;
> >
> > These comments don't tell us anything that the code does not.
>
>  Thanks, do you mean I need to remove it or add more detailed comments to it?

As a rule of thumb, comments should provide information to
the reader which they wouldn't get if they only had the code.
Comments often answer the "why do we do this" question, or
provide an overall summary of what the code is going to do,
or refer to an external source (a datasheet, an algorithm)
that is necessary to understand the code. It's better to
avoid comments that say "what the code is doing" at a line-by-line
level, because the code itself already answers the "what"
question at that level of detail.

thanks
-- PMM

