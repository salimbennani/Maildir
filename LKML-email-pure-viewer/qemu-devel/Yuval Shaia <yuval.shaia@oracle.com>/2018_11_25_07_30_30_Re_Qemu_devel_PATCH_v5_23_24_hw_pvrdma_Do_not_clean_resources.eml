Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 25 Nov 2018 22:12:33 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga004.fm.intel.com (fmsmga004.fm.intel.com [10.253.24.48])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 1D3BC580478
	for <like.xu@linux.intel.com>; Sat, 24 Nov 2018 23:41:32 -0800 (PST)
Received: from orsmga101.jf.intel.com ([10.7.208.22])
  by fmsmga004-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 24 Nov 2018 23:41:31 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AslwdYR3D1H4lGO9OsmDT+DRfVm0co7zxezQtwd8Z?=
 =?us-ascii?q?sesXKf7xwZ3uMQTl6Ol3ixeRBMOHs6IC07KempujcFRI2YyGvnEGfc4EfD4+ou?=
 =?us-ascii?q?JSoTYdBtWYA1bwNv/gYn9yNs1DUFh44yPzahANS47xaFLIv3K98yMZFAnhOgpp?=
 =?us-ascii?q?POT1HZPZg9iq2+yo9JDffwZFiCChbb9uMR67sRjfus4KjIV4N60/0AHJonxGe+?=
 =?us-ascii?q?RXwWNnO1eelAvi68mz4ZBu7T1et+ou+MBcX6r6eb84TaFDAzQ9L281/szrugLd?=
 =?us-ascii?q?QgaJ+3ART38ZkhtMAwjC8RH6QpL8uTb0u+ZhxCWXO9D9QLYpUjqg8qhrUgflhi?=
 =?us-ascii?q?kHOTAn82/XhMN/g75Grx2jqRNx3pbUbYOXOvdxY6/Qc88WSnRaXstKSyxNHpmx?=
 =?us-ascii?q?Y5cTA+cbI+pVqZT2qVsUrRu5AAmhHOHgyiJWhnDs2a0xzvkvEQHc0wwhBd0FrX?=
 =?us-ascii?q?PZrdXoNKcMS++1yLPEzS7Db/xM2Dfy8pPFchc7of6WQb1wddTexVMzGAPCi1Wd?=
 =?us-ascii?q?sIroNC6W2OQVq2WX8fZsWOG1h2I6tg18oSKjytkih4TJnI4Z11LJ+T1kzIs6ON?=
 =?us-ascii?q?G0UlN3bNGlHZdKqi2WKop7Ttk/T211visx16cItoShfCcQzZQq3x7fZOKDc4iP?=
 =?us-ascii?q?+h/jUOeRISxkhHJ+Yr6/iBCy8VW6xu37TMm0305GritDktbSqnAAzwLf5tSER/?=
 =?us-ascii?q?dn40utxDWC2xrN5uxKIU04j7fXJpw5zr41jJUTsEDDHiHsmEXxia+bblwk9fat?=
 =?us-ascii?q?6+T6e7npu4GTN5FqhQH6K6ghgcu/Afk+MgcSQWeb4uOw1Lni/U36XrpGlPI3kr?=
 =?us-ascii?q?TBvZDeJMQboLO5AgBP3oYi7Ra/Eymp0NACkXYbK1JFfQmKj47uO1HIL/D4C+q/?=
 =?us-ascii?q?j06rkDdxyPDKJqfhDYnVLnjfjLfheq5w60pdyAow099T/Z1VCqwaLfL3W0/xss?=
 =?us-ascii?q?HYDxAjPwy1xebnFMty1ocEVW2TBa+ZNfCajFmT++h6I/WQfJRH/3H5KuM5/Ljo?=
 =?us-ascii?q?ink2n0JberOmmp4eaXS9F/IhJF2FYH3qmZAYHGIX+wYzUuHu22CESiNZMnO7Xq?=
 =?us-ascii?q?Yg4WMiBYe7SIvOWI2pxaaMxTq2BYF+YGdABVaRV3DyeNKfRv0OZSmOd9JniSEO?=
 =?us-ascii?q?TrO7SoUshi2p4Qrz0bFqKqzd4iMVsZjqyd1d6OjalBV0/jtxS4yR1mCRVXAykG?=
 =?us-ascii?q?cFViMz1aZXrkl0y1PF2q99x7RaHMdU+PpPXS8gOJLcxvA8ANf3HkrMdNOAS1uO?=
 =?us-ascii?q?WNiqATgtCNk2xptGalx4Ec+/pgrO0yqjH/kekLnPTIQ+9aTO3n7wD9xwx3bPyO?=
 =?us-ascii?q?8qiFxiCtJCMHDjiqNh+gz7AYnPnEOE0aGweuBUxy7E8WaZi3CHtkBeVxBxTa7F?=
 =?us-ascii?q?dXcFb0DSoJLy4UaGB7SpCaksMSNbxMKCI7cMYdrsyR1XWenqPJLFY2uwkk+3Hx?=
 =?us-ascii?q?+Dwr7KZ43vKEsH2yCIOVUamgRbxnaPNAF2Uja8vWvaSiduHFPmS0T2+OJ6pTWw?=
 =?us-ascii?q?SUpinFLCVFFoy7fgok1dvvebUf5Ghr8=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ABAADbUPpbhxHrdtBhGQEBAQEBAQEBA?=
 =?us-ascii?q?QEBAQcBAQEBAQGBUQQBAQEBAQsBgTCCUBKMEV+LIIINjhWJJ4FuFwEBGBSIWiI?=
 =?us-ascii?q?0CQ0BAwEBAQEBAQIBEwEBAQoLCQgbDiMMgjYFAgMYCYJbAQEBAQIBAQIkEwYBA?=
 =?us-ascii?q?QQKKgIDAQIGAQEKGAkdCAMBCwVKEgWDHIF6CAEDAaRngWwzgnYBAQWBBAGGDgi?=
 =?us-ascii?q?MCYFXP4QjiDOCJoklll8HAoIcBI8EIwqBT4ULiiSYCQIEAgQFAhMBgUaCDTMaB?=
 =?us-ascii?q?B9QgmyCGwwXg0qKHDhwgQeKdIF3AQE?=
X-IPAS-Result: =?us-ascii?q?A0ABAADbUPpbhxHrdtBhGQEBAQEBAQEBAQEBAQcBAQEBAQG?=
 =?us-ascii?q?BUQQBAQEBAQsBgTCCUBKMEV+LIIINjhWJJ4FuFwEBGBSIWiI0CQ0BAwEBAQEBA?=
 =?us-ascii?q?QIBEwEBAQoLCQgbDiMMgjYFAgMYCYJbAQEBAQIBAQIkEwYBAQQKKgIDAQIGAQE?=
 =?us-ascii?q?KGAkdCAMBCwVKEgWDHIF6CAEDAaRngWwzgnYBAQWBBAGGDgiMCYFXP4QjiDOCJ?=
 =?us-ascii?q?oklll8HAoIcBI8EIwqBT4ULiiSYCQIEAgQFAhMBgUaCDTMaBB9QgmyCGwwXg0q?=
 =?us-ascii?q?KHDhwgQeKdIF3AQE?=
X-IronPort-AV: E=Sophos;i="5.56,277,1539673200"; 
   d="scan'208";a="42119185"
X-Amp-Result: UNSCANNABLE
X-Amp-File-Uploaded: False
Unscannable: 2
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 24 Nov 2018 23:41:30 -0800
Received: from localhost ([::1]:58997 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gQp2o-0004W0-90
	for like.xu@linux.intel.com; Sun, 25 Nov 2018 02:41:30 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:46463)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <yuval.shaia@oracle.com>) id 1gQp2P-0004Uf-2i
	for qemu-devel@nongnu.org; Sun, 25 Nov 2018 02:41:05 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <yuval.shaia@oracle.com>) id 1gQp2L-0007dN-A9
	for qemu-devel@nongnu.org; Sun, 25 Nov 2018 02:41:05 -0500
Received: from userp2120.oracle.com ([156.151.31.85]:52826)
	by eggs.gnu.org with esmtps (TLS1.0:RSA_AES_256_CBC_SHA1:32)
	(Exim 4.71) (envelope-from <yuval.shaia@oracle.com>)
	id 1gQp2J-0007aV-Fi
	for qemu-devel@nongnu.org; Sun, 25 Nov 2018 02:40:59 -0500
Received: from pps.filterd (userp2120.oracle.com [127.0.0.1])
	by userp2120.oracle.com (8.16.0.22/8.16.0.22) with SMTP id
	wAP7bh1F180538; Sun, 25 Nov 2018 07:40:57 GMT
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=oracle.com;
	h=date : from : to :
	subject : message-id : references : mime-version : content-type :
	in-reply-to; s=corp-2018-07-02;
	bh=gE//uO85MjqpNkJbwne55fIDAi4zs5l66qxtsTgdyWo=;
	b=zmmQOv7AnM9lrFtYooY21gcFYWMXQ8eBDESBYKQCjDfdfri6ua78Zc6X44l6AyCXOMOu
	eXr+OUIWIpdN0C0TmQW8hZSxAVvdntnGxa4Mg8QfFJGL20zl4/gRl2L0vGwX0Bl8kLMv
	O3gKcMFsPNeo5K2OuzMJECU+G1SfxuIseORspk86gDxJopbi7Y+YNcR1v3p2pf3TI73/
	68MJK2+o6//R9uhor76yQ8E8cnSricqDdtRoqlT3/L89S2EYsKKmzlqs7i39SO+5kBGf
	XIJSkXpJ/FUbRsoNAacvyYmopc7SQytkrV+ZiN2aKKA4kFrNj0ul4YKNOMJ/PieMzchD
	9Q== 
Received: from aserv0021.oracle.com (aserv0021.oracle.com [141.146.126.233])
	by userp2120.oracle.com with ESMTP id 2nxy9qsscc-1
	(version=TLSv1.2 cipher=ECDHE-RSA-AES256-GCM-SHA384 bits=256 verify=OK);
	Sun, 25 Nov 2018 07:40:56 +0000
Received: from userv0121.oracle.com (userv0121.oracle.com [156.151.31.72])
	by aserv0021.oracle.com (8.14.4/8.14.4) with ESMTP id wAP7etB6009800
	(version=TLSv1/SSLv3 cipher=DHE-RSA-AES256-GCM-SHA384 bits=256
	verify=OK); Sun, 25 Nov 2018 07:40:55 GMT
Received: from abhmp0005.oracle.com (abhmp0005.oracle.com [141.146.116.11])
	by userv0121.oracle.com (8.14.4/8.13.8) with ESMTP id wAP7esKw019069;
	Sun, 25 Nov 2018 07:40:54 GMT
Received: from lap1 (/77.138.186.148) by default (Oracle Beehive Gateway v4.0)
	with ESMTP ; Sat, 24 Nov 2018 23:30:36 -0800
Date: Sun, 25 Nov 2018 09:30:30 +0200
From: Yuval Shaia <yuval.shaia@oracle.com>
To: marcel.apfelbaum@gmail.com, dmitry.fleytman@gmail.com, jasowang@redhat.com,
	eblake@redhat.com, armbru@redhat.com, pbonzini@redhat.com,
	qemu-devel@nongnu.org, shamir.rabinovitch@oracle.com,
	cohuck@redhat.com, yuval.shaia@oracle.com
Message-ID: <20181125073030.GB2770@lap1>
References: <20181122121402.13764-1-yuval.shaia@oracle.com>
	<20181122121402.13764-24-yuval.shaia@oracle.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20181122121402.13764-24-yuval.shaia@oracle.com>
User-Agent: Mutt/1.10.1 (2018-07-13)
X-Proofpoint-Virus-Version: vendor=nai engine=5900 definitions=9087
	signatures=668685
X-Proofpoint-Spam-Details: rule=notspam policy=default score=0 suspectscore=2
	malwarescore=0
	phishscore=0 bulkscore=0 spamscore=0 mlxscore=0 mlxlogscore=999
	adultscore=0 classifier=spam adjust=0 reason=mlx scancount=1
	engine=8.0.1-1810050000 definitions=main-1811250066
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 3.x [generic] [fuzzy]
X-Received-From: 156.151.31.85
Subject: Re: [Qemu-devel] [PATCH v5 23/24] hw/pvrdma: Do not clean resources
 on shutdown
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

On Thu, Nov 22, 2018 at 02:14:01PM +0200, Yuval Shaia wrote:
> All resources are already cleaned at rm_fini phase.

Please ignore this patch, i will squash it to patch #5.

> 
> Signed-off-by: Yuval Shaia <yuval.shaia@oracle.com>
> ---
>  hw/rdma/rdma_backend.c | 21 +--------------------
>  1 file changed, 1 insertion(+), 20 deletions(-)
> 
> diff --git a/hw/rdma/rdma_backend.c b/hw/rdma/rdma_backend.c
> index 6a1e39d4c0..8ab25e94b1 100644
> --- a/hw/rdma/rdma_backend.c
> +++ b/hw/rdma/rdma_backend.c
> @@ -1075,28 +1075,9 @@ static int mad_init(RdmaBackendDev *backend_dev, CharBackend *mad_chr_be)
>  
>  static void mad_stop(RdmaBackendDev *backend_dev)
>  {
> -    QObject *o_ctx_id;
> -    unsigned long cqe_ctx_id;
> -    BackendCtx *bctx;
> -
> -    pr_dbg("Closing MAD\n");
> +    pr_dbg("Stopping MAD\n");
>  
>      disable_rdmacm_mux_async(backend_dev);
> -
> -    /* Clear MAD buffers list */
> -    qemu_mutex_lock(&backend_dev->recv_mads_list.lock);
> -    do {
> -        o_ctx_id = qlist_pop(backend_dev->recv_mads_list.list);
> -        if (o_ctx_id) {
> -            cqe_ctx_id = qnum_get_uint(qobject_to(QNum, o_ctx_id));
> -            bctx = rdma_rm_get_cqe_ctx(backend_dev->rdma_dev_res, cqe_ctx_id);
> -            if (bctx) {
> -                rdma_rm_dealloc_cqe_ctx(backend_dev->rdma_dev_res, cqe_ctx_id);
> -                g_free(bctx);
> -            }
> -        }
> -    } while (o_ctx_id);
> -    qemu_mutex_unlock(&backend_dev->recv_mads_list.lock);
>  }
>  
>  static void mad_fini(RdmaBackendDev *backend_dev)
> -- 
> 2.17.2
> 

