Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 08:32:54 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga001.jf.intel.com (orsmga001.jf.intel.com [10.7.209.18])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id C293F580460
	for <like.xu@linux.intel.com>; Thu, 22 Nov 2018 16:21:35 -0800 (PST)
Received: from orsmga102-1.jf.intel.com (HELO mga09.intel.com) ([10.7.208.27])
  by orsmga001-1.jf.intel.com with ESMTP; 22 Nov 2018 16:21:35 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AsMPwUxOIpKdfUL/Xzkcl6mtUPXoX/o7sNwtQ0KIM?=
 =?us-ascii?q?zox0K/z+o8bcNUDSrc9gkEXOFd2Cra4c26yO6+jJYi8p2d65qncMcZhBBVcuqP?=
 =?us-ascii?q?49uEgeOvODElDxN/XwbiY3T4xoXV5h+GynYwAOQJ6tL1LdrWev4jEMBx7xKRR6?=
 =?us-ascii?q?JvjvGo7Vks+7y/2+94fcbglUhzexe69+IAmrpgjNq8cahpdvJLwswRXTuHtIfO?=
 =?us-ascii?q?pWxWJsJV2Nmhv3+9m98p1+/SlOovwt78FPX7n0cKQ+VrxYES8pM3sp683xtBnM?=
 =?us-ascii?q?VhWA630BWWgLiBVIAgzF7BbnXpfttybxq+Rw1DWGMcDwULs5Qiqp4bt1RxD0iS?=
 =?us-ascii?q?cHLz85/3/Risxsl6JQvRatqwViz4LIfI2ZMfxzdb7fc9wHX2pMRshfWSxfDI2/?=
 =?us-ascii?q?YYsAAPYOMvtaoIbzulUOtRmzCwujCe/yxDJEmmH53bYh3uQuDQ3LxhYtE84UvX?=
 =?us-ascii?q?jKqtj+KaccUfqyzKnN1TjNYelZ2Sn86IfVbxsvoPCMUqlrccrWz0kkCgTIgUiK?=
 =?us-ascii?q?poz7PjOay/8As2ea7+V7TuKvjGgnpxtsrTi1wccskpLGiZwPxVDe7yl5wZs6Kc?=
 =?us-ascii?q?eiR05meNOpFoZbuS+dN4tzWMwiQmdotT49yrwHvZ60ZjMFyI89yx7YcfyHfJCE?=
 =?us-ascii?q?7Q/5VOaWOTd3n2xqd6ilhxqo8Eiv1+vxXdS33lZStidJjMXAu3MX2xDO98SKSe?=
 =?us-ascii?q?Fx8lmv1DuPzQzf9+NJLVgqmabHJZMt2KM8mocJvUnBAyP6glj6gamLfUs+4Oeo?=
 =?us-ascii?q?8f7oYrD+q5+cKYB0jgb+P7wqmsy+GuQ4LhMOU3KU+eS6yb3v50r5QK9FjvEuk6?=
 =?us-ascii?q?nZto7VJdgDq6KnHwNY0Zwv5wuiAzqlytgUg3cKIVJfdB6ajYXlI1TOL+r5Dfe7?=
 =?us-ascii?q?jVSsijBrx/XeM734HJrNK2XDnK78crlj9U5T1g4zwclE6JJTF7EBJu78VVHqtN?=
 =?us-ascii?q?DfCh85Mg+0zPj9BNRyy4MTQWaPAq6fMKPPvl6E/OMvI++QZIALvDbxMeQq5/nr?=
 =?us-ascii?q?jXIin18deq+p3ZQRaHClBPhmJF+ZYXX0jtcbDWgKphY+TPDtiFCaVT5TZnWyUL?=
 =?us-ascii?q?wm6jA0FYKrFoPDRoGrgLyc0ya3BJxWZmZaCl+SFXfkbZmLW/AJaHHaH8l6jzZR?=
 =?us-ascii?q?VaS9U5RzklaqtRTm0PxhKezb/DBesojsk9185unWnBd18iRoDsObyCaUQmRp22?=
 =?us-ascii?q?8FWTIyj515ulF3n1KK0KxkhK5BGNlOov9ETAo+cITR1vF3EMzaXAXHcdGUDlG8?=
 =?us-ascii?q?TYK9HDszQ9ktlsIIeFt3AN64jxrOjBatVoQYjbyKBdQM9brbwWn6J44p0G7BzK?=
 =?us-ascii?q?4/nlIOWMZDNWS6wKV48l6AKZTOlhC1nrireewz3STW82HLmWaHokBUeAFxW77C?=
 =?us-ascii?q?WzYTfEzOp9nw/AXDQ/mnFOJ0YUN61ceeJ/4SOZXShlJcSaKmYYyGbg=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AcAABGR/dbhxHrdtBiFgYBAQEEAQEHB?=
 =?us-ascii?q?AEBgVMFAQELAYEwgTmBKYxwjS2ON4kEgXMCDQUYBw2IUiI2Bw0BAwEBAQEBAQI?=
 =?us-ascii?q?BEwEBAQoLCQgpIwyCNgUCAxoBBoJcAQIDAQI9AQEECh4LAQIDAQIGAQEKDgoJG?=
 =?us-ascii?q?gMIAwELBRgxEwUEgxgBggABAQSnE4IfgnYBAQWHDwcIgm2IAIEcF4F/gRGDEoR?=
 =?us-ascii?q?HhhKJIQSWXwmCIIRciigLGF+BR45ikA+IIYFNDIF6MxoIFxk7gmwJghIMFxKBc?=
 =?us-ascii?q?oZahVItMYEEA4oIVoF3AQE?=
X-IPAS-Result: =?us-ascii?q?A0AcAABGR/dbhxHrdtBiFgYBAQEEAQEHBAEBgVMFAQELAYE?=
 =?us-ascii?q?wgTmBKYxwjS2ON4kEgXMCDQUYBw2IUiI2Bw0BAwEBAQEBAQIBEwEBAQoLCQgpI?=
 =?us-ascii?q?wyCNgUCAxoBBoJcAQIDAQI9AQEECh4LAQIDAQIGAQEKDgoJGgMIAwELBRgxEwU?=
 =?us-ascii?q?EgxgBggABAQSnE4IfgnYBAQWHDwcIgm2IAIEcF4F/gRGDEoRHhhKJIQSWXwmCI?=
 =?us-ascii?q?IRciigLGF+BR45ikA+IIYFNDIF6MxoIFxk7gmwJghIMFxKBcoZahVItMYEEA4o?=
 =?us-ascii?q?IVoF3AQE?=
X-IronPort-AV: E=Sophos;i="5.56,267,1539673200"; 
   d="asc'?scan'208";a="54475357"
X-Amp-Result: UNSCANNABLE
X-Amp-File-Uploaded: False
Unscannable: 2
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 22 Nov 2018 16:21:24 -0800
Received: from localhost ([::1]:49874 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gPzDn-0007BY-L9
	for like.xu@linux.intel.com; Thu, 22 Nov 2018 19:21:23 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:48784)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <dgibson@ozlabs.org>) id 1gPzDN-0007AW-Q6
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 19:20:58 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <dgibson@ozlabs.org>) id 1gPzDJ-0007tP-Ge
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 19:20:57 -0500
Received: from ozlabs.org ([203.11.71.1]:53787)
	by eggs.gnu.org with esmtps (TLS1.0:DHE_RSA_AES_256_CBC_SHA1:32)
	(Exim 4.71) (envelope-from <dgibson@ozlabs.org>)
	id 1gPzDH-0007P2-Gg; Thu, 22 Nov 2018 19:20:53 -0500
Received: by ozlabs.org (Postfix, from userid 1007)
	id 431H5n4Wlrz9s3q; Fri, 23 Nov 2018 11:20:45 +1100 (AEDT)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple;
	d=gibson.dropbear.id.au; s=201602; t=1542932445;
	bh=GB6MHna5fVf1I+myOBp8jiFRZi9GNbYjhDLPIZnN9bM=;
	h=Date:From:To:Cc:Subject:References:In-Reply-To:From;
	b=BE7lMT+csJOAUPPhr9vHFP3NoiTrDqIXOF+iOJ+N2McQ0bhANa+GVWQ5SPIZ5Akv2
	v0jgqsi/RGaD4ljVMQb4f9wSUOuS6g5P/Ehd3L4mPiIKzeg27W334xhfPUXVbcgvKT
	IdwBq5FU0iP91S3s4PtqrjmyV9rw4Ntf0qmiESl0=
Date: Fri, 23 Nov 2018 11:19:36 +1100
From: David Gibson <david@gibson.dropbear.id.au>
To: Serhii Popovych <spopovyc@redhat.com>
Message-ID: <20181123001936.GN10448@umbus.fritz.box>
References: <1542892767-37213-1-git-send-email-spopovyc@redhat.com>
MIME-Version: 1.0
Content-Type: multipart/signed; micalg=pgp-sha256;
	protocol="application/pgp-signature"; boundary="nRwNdQxTdQ7rZk9A"
Content-Disposition: inline
In-Reply-To: <1542892767-37213-1-git-send-email-spopovyc@redhat.com>
User-Agent: Mutt/1.10.1 (2018-07-13)
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 2.2.x-3.x [generic]
	[fuzzy]
X-Received-From: 203.11.71.1
Subject: Re: [Qemu-devel] [PATCH for 3.1 v3] spapr: Fix ibm,
 max-associativity-domains property number of nodes
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: lvivier@redhat.com, qemu-ppc@nongnu.org, qemu-devel@nongnu.org
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>


--nRwNdQxTdQ7rZk9A
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
Content-Transfer-Encoding: quoted-printable

On Thu, Nov 22, 2018 at 08:19:27AM -0500, Serhii Popovych wrote:
> Laurent Vivier reported off by one with maximum number of NUMA nodes
> provided by qemu-kvm being less by one than required according to
> description of "ibm,max-associativity-domains" property in LoPAPR.
>=20
> It appears that I incorrectly treated LoPAPR description of this
> property assuming it provides last valid domain (NUMA node here)
> instead of maximum number of domains.
>=20
>   ### Before hot-add
>=20
>   (qemu) info numa
>   3 nodes
>   node 0 cpus: 0
>   node 0 size: 0 MB
>   node 0 plugged: 0 MB
>   node 1 cpus:
>   node 1 size: 1024 MB
>   node 1 plugged: 0 MB
>   node 2 cpus:
>   node 2 size: 0 MB
>   node 2 plugged: 0 MB
>=20
>   $ numactl -H
>   available: 2 nodes (0-1)
>   node 0 cpus: 0
>   node 0 size: 0 MB
>   node 0 free: 0 MB
>   node 1 cpus:
>   node 1 size: 999 MB
>   node 1 free: 658 MB
>   node distances:
>   node   0   1
>     0:  10  40
>     1:  40  10
>=20
>   ### Hot-add
>=20
>   (qemu) object_add memory-backend-ram,id=3Dmem0,size=3D1G
>   (qemu) device_add pc-dimm,id=3Ddimm1,memdev=3Dmem0,node=3D2
>   (qemu) [   87.704898] pseries-hotplug-mem: Attempting to hot-add 4 ...
>   <there is no "Initmem setup node 2 [mem 0xHEX-0xHEX]">
>   [   87.705128] lpar: Attempting to resize HPT to shift 21
>   ... <HPT resize messages>
>=20
>   ### After hot-add
>=20
>   (qemu) info numa
>   3 nodes
>   node 0 cpus: 0
>   node 0 size: 0 MB
>   node 0 plugged: 0 MB
>   node 1 cpus:
>   node 1 size: 1024 MB
>   node 1 plugged: 0 MB
>   node 2 cpus:
>   node 2 size: 1024 MB
>   node 2 plugged: 1024 MB
>=20
>   $ numactl -H
>   available: 2 nodes (0-1)
>   ^^^^^^^^^^^^^^^^^^^^^^^^
>              Still only two nodes (and memory hot-added to node 0 below)
>   node 0 cpus: 0
>   node 0 size: 1024 MB
>   node 0 free: 1021 MB
>   node 1 cpus:
>   node 1 size: 999 MB
>   node 1 free: 658 MB
>   node distances:
>   node   0   1
>     0:  10  40
>     1:  40  10
>=20
> After fix applied numactl(8) reports 3 nodes available and memory
> plugged into node 2 as expected.
>=20
> >From David Gibson:
> ------------------
>   Qemu makes a distinction between "non NUMA" (nb_numa_nodes =3D=3D 0) and
>   "NUMA with one node" (nb_numa_nodes =3D=3D 1).  But from a PAPR guests's
>   point of view these are equivalent.  I don't want to present two
>   different cases to the guest when we don't need to, so even though the
>   guest can handle it, I'd prefer we put a '1' here for both the
>   nb_numa_nodes =3D=3D 0 and nb_numa_nodes =3D=3D 1 case.
>=20
> This consolidates everything discussed previously on mailing list.
>=20
> Fixes: da9f80fbad21 ("spapr: Add ibm,max-associativity-domains property")
> Reported-by: Laurent Vivier <lvivier@redhat.com>
> Signed-off-by: Serhii Popovych <spopovyc@redhat.com>

Applied, thanks.

> ---
>  hw/ppc/spapr.c | 2 +-
>  1 file changed, 1 insertion(+), 1 deletion(-)
>=20
> diff --git a/hw/ppc/spapr.c b/hw/ppc/spapr.c
> index 7afd1a1..2ee7201 100644
> --- a/hw/ppc/spapr.c
> +++ b/hw/ppc/spapr.c
> @@ -1033,7 +1033,7 @@ static void spapr_dt_rtas(sPAPRMachineState *spapr,=
 void *fdt)
>          cpu_to_be32(0),
>          cpu_to_be32(0),
>          cpu_to_be32(0),
> -        cpu_to_be32(nb_numa_nodes ? nb_numa_nodes - 1 : 0),
> +        cpu_to_be32(nb_numa_nodes ? nb_numa_nodes : 1),
>      };
> =20
>      _FDT(rtas =3D fdt_add_subnode(fdt, 0, "rtas"));

--=20
David Gibson			| I'll have my music baroque, and my code
david AT gibson.dropbear.id.au	| minimalist, thank you.  NOT _the_ _other_
				| _way_ _around_!
http://www.ozlabs.org/~dgibson

--nRwNdQxTdQ7rZk9A
Content-Type: application/pgp-signature; name="signature.asc"

-----BEGIN PGP SIGNATURE-----

iQIzBAEBCAAdFiEEdfRlhq5hpmzETofcbDjKyiDZs5IFAlv3R5gACgkQbDjKyiDZ
s5L/Yg/+L4WwwsEk2hvYB9ucEth2XFNeR8nml9RWRKUBQpk28uAMo/6ys8KSV/c8
qG/Yzu86GYcflTxPPGF69MkifxjREbT/P1toANgUEdaIche1kv4iYhckPyAWiroa
EUC+6JJ+RfzTieixRjLEg1etCkYfsq3kbzUNzm+/DwA5p3wOlnMpYjYhXnU56wL7
uV7p1gDgblmHHgOuwlpLaKOBaLTN6KQGm/QDw7qbCawkhNTAm0+/znLwMuxdaWQh
MBg3+sfFjM023tqg7iMKZXjRlnVMriKs5+ZMJllTH0lTme+JaIzRUjCL0g8fjBqB
F9YzQdbzu1h/uGXTI4+XSmS+Wuz2ZrP1/caUQge8/PM/PORk2M67zqB5f7a60i04
8wSIjw3y1t368TMF32JIpnQQ5waEmFeQD+OwTA+KGzFwo5qEMSp/vjsoHJDnQy0K
KQx113Pxk5ngO0WJPqX6mnS+W8u+vjGPhpWki6g8a6LtlOE9BZo33pSHkU8VvL75
QgFp5PpWF5FE04Qylrw3qpWllvilm2HlPFpbruPZZupSra8+ycSyUTcILQJmqhzC
f7JGRiQjQ3a7qYq09VXt1+ch+d2bwwpGOF6yFr1YPqXhQvwxlyQJJPvOSK4xkOOV
AehLrJsC4WedWs1k8378OGv8Gws329wWw1EWU/ztQKMkeqLLTB8=
=0sNh
-----END PGP SIGNATURE-----

--nRwNdQxTdQ7rZk9A--

