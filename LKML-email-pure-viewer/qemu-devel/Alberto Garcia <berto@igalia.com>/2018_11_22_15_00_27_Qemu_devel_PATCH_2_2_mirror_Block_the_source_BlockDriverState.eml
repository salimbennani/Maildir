Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 08:28:46 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga007.fm.intel.com (fmsmga007.fm.intel.com [10.253.24.52])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 1D77258040F
	for <like.xu@linux.intel.com>; Thu, 22 Nov 2018 07:02:10 -0800 (PST)
Received: from fmsmga105.fm.intel.com ([10.1.193.10])
  by fmsmga007-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 22 Nov 2018 07:02:09 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AnaYhXxeG2nKuy++Pd8+mYZ/zlGMj4u6mDksu8pMi?=
 =?us-ascii?q?zoh2WeGdxc26YBKN2/xhgRfzUJnB7Loc0qyK6/CmATRIyK3CmUhKSIZLWR4BhJ?=
 =?us-ascii?q?detC0bK+nBN3fGKuX3ZTcxBsVIWQwt1Xi6NU9IBJS2PAWK8TW94jEIBxrwKxd+?=
 =?us-ascii?q?KPjrFY7OlcS30P2594HObwlSizexfbB/IA+qoQnNq8IbnZZsJqEtxxXTv3BGYf?=
 =?us-ascii?q?5WxWRmJVKSmxbz+MK994N9/ipTpvws6ddOXb31cKokQ7NYCi8mM30u683wqRbD?=
 =?us-ascii?q?VwqP6WACXWgQjxFFHhLK7BD+Xpf2ryv6qu9w0zSUMMHqUbw5Xymp4rx1QxH0li?=
 =?us-ascii?q?gIKz858HnWisNuiqJbvAmhrAF7z4LNfY2ZKOZycqbbcNwdWWRPXthcWzVYDo2+?=
 =?us-ascii?q?coQPFfMNM/tFr4nmv1sBswexBRW1COPrzT9JiGL90ak63ugkFwzJ2xAuEdIQvX?=
 =?us-ascii?q?jNtdn7NrodUfqswKfV0DXDdOtW1inh54jUbxstpe+AUa51fcfX1EIhFR7Kjk+I?=
 =?us-ascii?q?pILlIT2b2OcDvW+Z4OpuV+2vhXMpqxlzrzatycogl4fEip4LxVDf7ih13Jo5KM?=
 =?us-ascii?q?ekRENhfdKoDJ1dvDyaOYtsRcMiRnlltTo+yrIdp5G7ZjQKyJM6zBDecfOHaZSH?=
 =?us-ascii?q?4hP5W+2MJjp3n2xqeKijhxa16kWgy+L8WdOw0FZLtCVJiMXDtncI1xHK7MWMV/?=
 =?us-ascii?q?hz/l+51DqRywze6ftILV0pmafYMZIt3LA9m5oJvUjeHCL6gFj6gauZe0k+5+Sk?=
 =?us-ascii?q?9/jrbq/mq5OBLYN4lAfzObk0lMOlG+Q3KA0OUnCb+eui0L3j+lX0QLFLjv0tjq?=
 =?us-ascii?q?nZq4rWJcsdpq6kGQNV1Zwj6xmnAzen1tQXg2UHIUpbdB6bjIXlIUzCLO37APul?=
 =?us-ascii?q?nVihnjdmy+rbMrDjGpnNK2LMkLblfbZz8U5czw8zwMhG551KD7EBPev/VVLvu9?=
 =?us-ascii?q?zGEBA5NxW4zP3gCNVg0IMRRXyAArSePKPWsF+I5fwgL/ODZY8IoDv9L/kl5/jz?=
 =?us-ascii?q?jX42g1MdfK+p3YcJZ3C8BPhpP0KZYX/3j9cHFmcKuAU+TOr3iFGYVj5TfXmyU7?=
 =?us-ascii?q?om5j4nEIKmEZvDRoe1jbyF3Se7HYNZanpJC1CRCnroc4SEW/ERaCOdOMNhkzoE?=
 =?us-ascii?q?VaS/RI8lzx2hqAj6y780ZtfS4TAS4JL/yMButaqUkRAp6ScyCcOb3GeQCWZukS?=
 =?us-ascii?q?QNTj4y2al55ktl1laE17M/mvFdCJlf6u1EVlQHM4XBxbl/AtH2RgWTZ9qMVROq?=
 =?us-ascii?q?T8urBXQrQ8sszsQSS0B6Hdqkk1bExSX9GKIflbGAGMkp9LnB1WP6Pcd3xiX60/?=
 =?us-ascii?q?w4glw7B8dCK2Cirqh48QfVGsjOiUrKubytcPE12CTA7nuEhUWHpkpZWUYkW6jf?=
 =?us-ascii?q?QXc3Z0TfqdXwoEjFSun9WvwcLgJdxJvaeeNxYdrzgAADG6ru?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0A5AACIxPZbhxHrdtBiHgEGBwaBUQkLA?=
 =?us-ascii?q?YEwKoI4jG+LIlABAQaBEIEfiB6JK4R3gXMUGBSIUiI0CQ0BAwEBAQEBAQIBEwE?=
 =?us-ascii?q?BAQoLCQgpIwyCNgUCAxoHglwDAwECJBkBAQQKKQECAwECBgEBPgoIAwE4GxkFg?=
 =?us-ascii?q?lFLgXUNAQMBqGGBbDOCdgEBBYJDhFwIgi6FMIQrF3iBB4ERM4Iqiw6PG5BpCZE?=
 =?us-ascii?q?vGIlhhycslFKDMoFGgg0zGggbFTuCbIIbDBcSgziKVHCBBAOKXYF3AQE?=
X-IPAS-Result: =?us-ascii?q?A0A5AACIxPZbhxHrdtBiHgEGBwaBUQkLAYEwKoI4jG+LIlA?=
 =?us-ascii?q?BAQaBEIEfiB6JK4R3gXMUGBSIUiI0CQ0BAwEBAQEBAQIBEwEBAQoLCQgpIwyCN?=
 =?us-ascii?q?gUCAxoHglwDAwECJBkBAQQKKQECAwECBgEBPgoIAwE4GxkFglFLgXUNAQMBqGG?=
 =?us-ascii?q?BbDOCdgEBBYJDhFwIgi6FMIQrF3iBB4ERM4Iqiw6PG5BpCZEvGIlhhycslFKDM?=
 =?us-ascii?q?oFGgg0zGggbFTuCbIIbDBcSgziKVHCBBAOKXYF3AQE?=
X-IronPort-AV: E=Sophos;i="5.56,266,1539673200"; 
   d="scan'208";a="139222421"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 22 Nov 2018 07:02:09 -0800
Received: from localhost ([::1]:47263 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gPqUa-0007rN-C5
	for like.xu@linux.intel.com; Thu, 22 Nov 2018 10:02:08 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:57488)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <berto@igalia.com>) id 1gPqTw-0007r5-G4
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 10:01:30 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <berto@igalia.com>) id 1gPqTt-0005Wp-A9
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 10:01:28 -0500
Received: from fanzine.igalia.com ([91.117.99.155]:38856)
	by eggs.gnu.org with esmtps (TLS1.0:RSA_AES_128_CBC_SHA1:16)
	(Exim 4.71) (envelope-from <berto@igalia.com>)
	id 1gPqTs-0004mM-Mb; Thu, 22 Nov 2018 10:01:25 -0500
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed; d=igalia.com;
	s=20170329; 
	h=References:In-Reply-To:References:In-Reply-To:Message-Id:Date:Subject:Cc:To:From;
	bh=31iwRYarufH2iHzqVr0R1FTqnivRr+iZ/RZo4oIgtR0=; 
	b=ZhAgsVlNyX4G7jTtIYWF20wc6Or1nV7cQbrc2q/xwJculyJ/fsBod56ssajx5EpdowWFmg7ZD3OEWljNGfKmIYyy9TxBPPOwjzWVD/w+O0Xl9LqxxypesT7ObWcfA5K7p4mjEq+W63+J//FXYdI8zYeRn55QOiBFX14sZpgR1zYXDy8hHNnLu2pOiRD2THNyr2O6ehPdrreEsyfkFZHiPxbqJP7r5qD7cbDE8h0la20GwXHt7cMZumFER8CUYDsRfsULSoaCjCzU4WXAQjVd5Q90PUOBuna5a4b83quIEpDWg5zsRZUbdWoHY+t6MLvgjtfTQ/dpKPCLeEiiOenvRA==;
Received: from [194.100.51.2] (helo=perseus.local)
	by fanzine.igalia.com with esmtpsa 
	(Cipher TLS1.2:ECDHE_RSA_AES_256_GCM_SHA384:256) (Exim)
	id 1gPqTG-0005he-4R; Thu, 22 Nov 2018 16:00:46 +0100
Received: from berto by perseus.local with local (Exim 4.89)
	(envelope-from <berto@igalia.com>)
	id 1gPqT0-0004yA-Kz; Thu, 22 Nov 2018 17:00:30 +0200
From: Alberto Garcia <berto@igalia.com>
To: qemu-devel@nongnu.org
Date: Thu, 22 Nov 2018 17:00:27 +0200
Message-Id: <04d62642b7f6845c555423ef1c5dce125eef158c.1542898669.git.berto@igalia.com>
X-Mailer: git-send-email 2.11.0
In-Reply-To: <cover.1542898669.git.berto@igalia.com>
References: <cover.1542898669.git.berto@igalia.com>
In-Reply-To: <cover.1542898669.git.berto@igalia.com>
References: <cover.1542898669.git.berto@igalia.com>
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 2.2.x-3.x (no
	timestamps) [generic] [fuzzy]
X-Received-From: 91.117.99.155
Subject: [Qemu-devel] [PATCH 2/2] mirror: Block the source BlockDriverState
 in mirror_start_job()
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Kevin Wolf <kwolf@redhat.com>, Alberto Garcia <berto@igalia.com>,
	qemu-block@nongnu.org, Max Reitz <mreitz@redhat.com>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

The mirror_start_job() function used for the commit-active job blocks
the source, target and all intermediate nodes for the duration of the
job.

   target <- intermediate <- source

Since 4ef85a9c2339 this function creates a dummy mirror_top_bs that
goes on top of the source node, and it is this dummy node that gets
blocked instead. The source node is never blocked or added to the
job's list of nodes.

   target <- intermediate <- source <- mirror_top

At the moment I don't think it is possible to exploit this problem
because any additional job on 'source' would either be forbidden for
other reasons or it would need to involve an additional node that is
blocked, causing an error.

This can be seen in the error messages, however, because they never
refer to the source node being blocked:

  $ qemu-img create -f qcow2 hd0.qcow2 1M
  $ qemu-img create -f qcow2 -b hd0.qcow2 hd1.qcow2
  $ qemu-io -c 'write 0 1M' hd0.qcow2
  $ $QEMU -drive if=none,file=hd1.qcow2,node-name=hd1
  { "execute": "qmp_capabilities" }
  { "execute": "block-commit", "arguments": {"device": "hd1", "speed": 256}}
  { "execute": "block-stream", "arguments": {"device": "hd1"}}
  { "error": {"class": "GenericError",
    "desc": "Node 'hd0' is busy: block device is in use by block job: commit"}}

After this patch the error message refers to 'hd1', as it should.

The expected output of iotest 141 also needs to be updated for the
same reason.

Signed-off-by: Alberto Garcia <berto@igalia.com>
---
 block/mirror.c             | 8 ++++++++
 tests/qemu-iotests/141.out | 4 ++--
 2 files changed, 10 insertions(+), 2 deletions(-)

diff --git a/block/mirror.c b/block/mirror.c
index 664c452f71..467eec9b89 100644
--- a/block/mirror.c
+++ b/block/mirror.c
@@ -1612,6 +1612,14 @@ static void mirror_start_job(const char *job_id, BlockDriverState *bs,
         goto fail;
     }
 
+    ret = block_job_add_bdrv(&s->common, "source", bs, 0,
+                             BLK_PERM_WRITE_UNCHANGED | BLK_PERM_WRITE |
+                             BLK_PERM_CONSISTENT_READ,
+                             errp);
+    if (ret < 0) {
+        goto fail;
+    }
+
     /* Required permissions are already taken with blk_new() */
     block_job_add_bdrv(&s->common, "target", target, 0, BLK_PERM_ALL,
                        &error_abort);
diff --git a/tests/qemu-iotests/141.out b/tests/qemu-iotests/141.out
index f252c86875..41c7291258 100644
--- a/tests/qemu-iotests/141.out
+++ b/tests/qemu-iotests/141.out
@@ -28,7 +28,7 @@ Formatting 'TEST_DIR/o.IMGFMT', fmt=IMGFMT size=1048576 backing_file=TEST_DIR/t.
 {"timestamp": {"seconds":  TIMESTAMP, "microseconds":  TIMESTAMP}, "event": "JOB_STATUS_CHANGE", "data": {"status": "ready", "id": "job0"}}
 {"timestamp": {"seconds":  TIMESTAMP, "microseconds":  TIMESTAMP}, "event": "BLOCK_JOB_READY", "data": {"device": "job0", "len": 0, "offset": 0, "speed": 0, "type": "mirror"}}
 {"return": {}}
-{"error": {"class": "GenericError", "desc": "Node 'drv0' is busy: node is used as backing hd of 'NODE_NAME'"}}
+{"error": {"class": "GenericError", "desc": "Node 'drv0' is busy: block device is in use by block job: mirror"}}
 {"return": {}}
 {"timestamp": {"seconds":  TIMESTAMP, "microseconds":  TIMESTAMP}, "event": "JOB_STATUS_CHANGE", "data": {"status": "waiting", "id": "job0"}}
 {"timestamp": {"seconds":  TIMESTAMP, "microseconds":  TIMESTAMP}, "event": "JOB_STATUS_CHANGE", "data": {"status": "pending", "id": "job0"}}
@@ -45,7 +45,7 @@ Formatting 'TEST_DIR/o.IMGFMT', fmt=IMGFMT size=1048576 backing_file=TEST_DIR/t.
 {"timestamp": {"seconds":  TIMESTAMP, "microseconds":  TIMESTAMP}, "event": "JOB_STATUS_CHANGE", "data": {"status": "ready", "id": "job0"}}
 {"timestamp": {"seconds":  TIMESTAMP, "microseconds":  TIMESTAMP}, "event": "BLOCK_JOB_READY", "data": {"device": "job0", "len": 0, "offset": 0, "speed": 0, "type": "commit"}}
 {"return": {}}
-{"error": {"class": "GenericError", "desc": "Node 'drv0' is busy: node is used as backing hd of 'NODE_NAME'"}}
+{"error": {"class": "GenericError", "desc": "Node 'drv0' is busy: block device is in use by block job: commit"}}
 {"return": {}}
 {"timestamp": {"seconds":  TIMESTAMP, "microseconds":  TIMESTAMP}, "event": "JOB_STATUS_CHANGE", "data": {"status": "waiting", "id": "job0"}}
 {"timestamp": {"seconds":  TIMESTAMP, "microseconds":  TIMESTAMP}, "event": "JOB_STATUS_CHANGE", "data": {"status": "pending", "id": "job0"}}
-- 
2.11.0


