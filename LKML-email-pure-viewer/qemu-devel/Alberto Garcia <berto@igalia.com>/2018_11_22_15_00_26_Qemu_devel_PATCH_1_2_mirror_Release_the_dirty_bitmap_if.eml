Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 08:28:48 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga005.fm.intel.com (fmsmga005.fm.intel.com [10.253.24.32])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 7142E58040F
	for <like.xu@linux.intel.com>; Thu, 22 Nov 2018 07:02:26 -0800 (PST)
Received: from orsmga106.jf.intel.com ([10.7.208.65])
  by fmsmga005-1.fm.intel.com with ESMTP; 22 Nov 2018 07:02:26 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AUy3L3hyiJJj/L2HXCy+O+j09IxM/srCxBDY+r6Qd?=
 =?us-ascii?q?0uoSLPad9pjvdHbS+e9qxAeQG9mDu7Qc06L/iOPJYSQ4+5GPsXQPItRndiQuro?=
 =?us-ascii?q?EopTEmG9OPEkbhLfTnPGQQFcVGU0J5rTngaRAGUMnxaEfPrXKs8DUcBgvwNRZv?=
 =?us-ascii?q?JuTyB4Xek9m72/q99pHPYAhEniaxba9vJxiqsAvdsdUbj5F/Iagr0BvJpXVIe+?=
 =?us-ascii?q?VSxWx2IF+Yggjx6MSt8pN96ipco/0u+dJOXqX8ZKQ4UKdXDC86PGAv5c3krgfM?=
 =?us-ascii?q?QA2S7XYBSGoWkx5IAw/Y7BHmW5r6ryX3uvZh1CScIMb7Vq4/Vyi84Kh3SR/okC?=
 =?us-ascii?q?YHOCA/8GHLkcx7kaZXrAu8qxBj34LYZYeYO/1icK3dY94WXHNNUMRMWCxbG4+y?=
 =?us-ascii?q?cpYPD/EZPelGs4b9u0ICrR+5BQiiGejjzj9Finrw0KI9z+ovER/L0BU5E9wMrX?=
 =?us-ascii?q?vUtsz5OroPUeCu1KnH0ynMb+9L0jv59oTEbhUtrPeRVrxybMXR01EiGQPbgFue?=
 =?us-ascii?q?qoLrODGa1uoPvGiV8uRgTeCihWwopg1srDWj2tkjipLSi44J1lzJ7zl1zZwpKd?=
 =?us-ascii?q?GkTkNwfN6qEIFXtyGfL4Z7XsciTHp2tyYg1r0GvoOwcikQx5Q92xHfauaIeJWP?=
 =?us-ascii?q?7x34SumROyt4hHV+dbK+iBa960ygyuzmWcWuzFlKqS9Fn8DKu3sQ1BLT8tCKRu?=
 =?us-ascii?q?Vh8kqiwzqDyh3f5+JeLUwqm6fWK4QtzqMym5YLrEjOGiD7lF/rgKOKakko4Oil?=
 =?us-ascii?q?5/n9brn4oJKXKpV6hRvkMqs0n8yyGeQ4PRYKX2ic4em80Lzj/VblQLVRlPE2na?=
 =?us-ascii?q?/ZsI3AKcQcvK65DBdZ0ocl6xmhEzeryMoUkWUEIV5fZR6LkovkN0vQLP32Dfqz?=
 =?us-ascii?q?mUmgnTVzy/DDJLLhA5HNLnbZkLfmeLZw81dcxxQ2zdBC/p5bF68OIOztVU/1rd?=
 =?us-ascii?q?DXFRg5MxGyw+n7Ftp9zYQSWWaOAq+aLqzeq1CJ5v83LumIZY8Vviv9Kvc/6/7v?=
 =?us-ascii?q?i385hUESfa2z0ZQLb3C4G+9rI0OeYXrqjdcBF3oKshA5TOzwh12OSSRTaGqqX6?=
 =?us-ascii?q?Ig+jE7D5qrDYPCRoCunrONxii6HoBNa2BCC1CMF2rodoqeV/cNbiKSPtFukjge?=
 =?us-ascii?q?Wbe9TI8h0ELmiQnh1rAyLvbI4jZK8tXn1cNp/KvVkhc98yEyCN6SlGSETmVxl2?=
 =?us-ascii?q?VPQCcq3ad5ugtkx1KelKR1nfFcRuFV/O5DBwIzNJrAyL5jBtXvHw7MYNqNDUyr?=
 =?us-ascii?q?W8irGi0ZSNU3zNkTJUFnFIK5kxrB0iG2VqITjKGBH5cu86jRjET2ct9wzmuD2K?=
 =?us-ascii?q?Q/gl0ORMxJOmu7wKll+Fv9HYnMxmydnauwaaNU8yfX/2aKhT6EsVtEVyZxXqzB?=
 =?us-ascii?q?XHlZbUzT+4eqrnjeRqOjXOx0ejBKztSPf+4VN9A=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AvAADLw/ZbhxHrdtBiHQEBBQEHBQGBU?=
 =?us-ascii?q?QgBCwGBMIJijBBfiyJQAQEGgRCBH4geiSuEd4F1EhgUiFIiNAkNAQMBAQEBAQE?=
 =?us-ascii?q?CARMBAQEKCwkIKSMMgjYFAgMaB4JcAwMBAiQZAQEECikBAgMBAgYBAT4KCAMBO?=
 =?us-ascii?q?BsZBYMcgXUNAQMBqGKBbDOCdgEBBYJDhFwIh16EKxd4gQeBETOCKoYAhQ6gBAm?=
 =?us-ascii?q?RLxiJYYcnLJgEgUaCDTMaCBsVgyeCGzWDOIpUcIEEA4pdgXcBAQ?=
X-IPAS-Result: =?us-ascii?q?A0AvAADLw/ZbhxHrdtBiHQEBBQEHBQGBUQgBCwGBMIJijBB?=
 =?us-ascii?q?fiyJQAQEGgRCBH4geiSuEd4F1EhgUiFIiNAkNAQMBAQEBAQECARMBAQEKCwkIK?=
 =?us-ascii?q?SMMgjYFAgMaB4JcAwMBAiQZAQEECikBAgMBAgYBAT4KCAMBOBsZBYMcgXUNAQM?=
 =?us-ascii?q?BqGKBbDOCdgEBBYJDhFwIh16EKxd4gQeBETOCKoYAhQ6gBAmRLxiJYYcnLJgEg?=
 =?us-ascii?q?UaCDTMaCBsVgyeCGzWDOIpUcIEEA4pdgXcBAQ?=
X-IronPort-AV: E=Sophos;i="5.56,266,1539673200"; 
   d="scan'208";a="41200153"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 22 Nov 2018 07:02:10 -0800
Received: from localhost ([::1]:47264 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gPqUb-0007rO-I4
	for like.xu@linux.intel.com; Thu, 22 Nov 2018 10:02:09 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:57490)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <berto@igalia.com>) id 1gPqTw-0007r6-GF
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 10:01:30 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <berto@igalia.com>) id 1gPqTt-0005Wj-9k
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 10:01:28 -0500
Received: from fanzine.igalia.com ([91.117.99.155]:38857)
	by eggs.gnu.org with esmtps (TLS1.0:RSA_AES_128_CBC_SHA1:16)
	(Exim 4.71) (envelope-from <berto@igalia.com>)
	id 1gPqTs-0004mN-Mc; Thu, 22 Nov 2018 10:01:25 -0500
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed; d=igalia.com;
	s=20170329; 
	h=References:In-Reply-To:References:In-Reply-To:Message-Id:Date:Subject:Cc:To:From;
	bh=U+eIwp+D/PjkeTBI/g0vqKuU53bO1HjyBr/8Mv41PDw=; 
	b=rEP6URLoaxQHd5hszeOljhN3HQnK0q6inuZ5GrOz/q2P8Fg2XdB9DpHsupLAXWPgEuDoEXIpwRrTYNOsPydODfQ/kGZCaRcSErWFZ09So9DzyklE9ex6ExAXnyyXQlSjiMZ9RDbdFpip+DWfMN3P56gPTblcRUWvP/v53GQ+APFEY4okVpIhFX9xSqQ2xwb6+p8ACfFneoNoDTrwXRsLvpnson49f4zqi9M6+zYtINBsAqA/beyOeOl7qQukUH78nppg84/zsF5DSWzLw8z1UDA42Ym4ueFqKXRRIizbQcpULh6OPBStiRP8EXw1PY9ZqVoZ371WQnjxiqssuKM+BQ==;
Received: from [194.100.51.2] (helo=perseus.local)
	by fanzine.igalia.com with esmtpsa 
	(Cipher TLS1.2:ECDHE_RSA_AES_256_GCM_SHA384:256) (Exim)
	id 1gPqTG-0005hd-5L; Thu, 22 Nov 2018 16:00:46 +0100
Received: from berto by perseus.local with local (Exim 4.89)
	(envelope-from <berto@igalia.com>)
	id 1gPqT0-0004y8-K0; Thu, 22 Nov 2018 17:00:30 +0200
From: Alberto Garcia <berto@igalia.com>
To: qemu-devel@nongnu.org
Date: Thu, 22 Nov 2018 17:00:26 +0200
Message-Id: <7562baab810142c29e5a1afb50c65f98bbd98833.1542898669.git.berto@igalia.com>
X-Mailer: git-send-email 2.11.0
In-Reply-To: <cover.1542898669.git.berto@igalia.com>
References: <cover.1542898669.git.berto@igalia.com>
In-Reply-To: <cover.1542898669.git.berto@igalia.com>
References: <cover.1542898669.git.berto@igalia.com>
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 2.2.x-3.x (no
	timestamps) [generic] [fuzzy]
X-Received-From: 91.117.99.155
Subject: [Qemu-devel] [PATCH 1/2] mirror: Release the dirty bitmap if
 mirror_start_job() fails
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Kevin Wolf <kwolf@redhat.com>, Alberto Garcia <berto@igalia.com>,
	qemu-block@nongnu.org, Max Reitz <mreitz@redhat.com>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

At the moment I don't see how to make this function fail after the
dirty bitmap has been created, but if that was possible then we would
hit the assert(QLIST_EMPTY(&bs->dirty_bitmaps)) in bdrv_close().

Signed-off-by: Alberto Garcia <berto@igalia.com>
---
 block/mirror.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/block/mirror.c b/block/mirror.c
index 56d9ef7474..664c452f71 100644
--- a/block/mirror.c
+++ b/block/mirror.c
@@ -1649,6 +1649,9 @@ fail:
         g_free(s->replaces);
         blk_unref(s->target);
         bs_opaque->job = NULL;
+        if (s->dirty_bitmap) {
+            bdrv_release_dirty_bitmap(bs, s->dirty_bitmap);
+        }
         job_early_fail(&s->common.job);
     }
 
-- 
2.11.0


