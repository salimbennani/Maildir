Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 24 Nov 2018 12:35:42 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga004.fm.intel.com (fmsmga004.fm.intel.com [10.253.24.48])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 536E758037D
	for <like.xu@linux.intel.com>; Fri, 23 Nov 2018 07:57:17 -0800 (PST)
Received: from orsmga101.jf.intel.com ([10.7.208.22])
  by fmsmga004-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 07:57:16 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3Au+0GlhYQ28yObvWXaHa1mdH/LSx+4OfEezUN459i?=
 =?us-ascii?q?sYplN5qZrsu+bnLW6fgltlLVR4KTs6sC17KG9fi4EUU7or+5+EgYd5JNUxJXwe?=
 =?us-ascii?q?43pCcHRPC/NEvgMfTxZDY7FskRHHVs/nW8LFQHUJ2mPw6arXK99yMdFQviPgRp?=
 =?us-ascii?q?OOv1BpTSj8Oq3Oyu5pHfeQpFiCa+bL9oMBm6sRjau9ULj4dlNqs/0AbCrGFSe+?=
 =?us-ascii?q?RRy2NoJFaTkAj568yt4pNt8Dletuw4+cJYXqr0Y6o3TbpDDDQ7KG81/9HktQPC?=
 =?us-ascii?q?TQSU+HQRVHgdnwdSDAjE6BH6WYrxsjf/u+Fg1iSWIdH6QLYpUjm58axlVAHnhz?=
 =?us-ascii?q?sGNz4h8WHYlMpwjL5AoBm8oxBz2pPYbJ2JOPZ7eK7WYNEUSndbXstJWSJPAp2y?=
 =?us-ascii?q?YYgBD+UOIelXsovyqFUToxumBwSiBuzixiJGi3Pqw6I6yP8sER3a0AE6A94CrG?=
 =?us-ascii?q?7ZoMvzOawPUe611q7IzTDbYv1Txzj99onIchY8qv+VXr59b83RyU8pFwPClFWb?=
 =?us-ascii?q?tIvoPzCL2eQTsmib6fFtVeGoi2E7rAFxpD6vxsA2ioXTgIIa1EzE+Dx/zY0oJt?=
 =?us-ascii?q?O4UFZ2bcC4HJZTrS2WKpZ6T8A4T212tis3yqcKtYO5cSQSyZkqyATTZvidf4SW?=
 =?us-ascii?q?7R/uUPydLDZ4iX9jZbmxnQy98VK6xe35TsS00EhFri5CktTUsnAN1gfT6tScSv?=
 =?us-ascii?q?dn8Ueh3yuP2xrU6uFeLkA4javbK5g/zb4sjpcfr1jPEyzslEnrkaObdV8o9vam?=
 =?us-ascii?q?5unneLnqu52RO5dxig7kM6QunsK/Af4/MggLR2Wb4Pqz1Lj+/UHgXbpFkOM2nb?=
 =?us-ascii?q?fdsJzDPssbobO5AwlJ3Yk98BazCDOm0NUbnXYZNl5Edw+HgpDtO1HPJvD4EPi+?=
 =?us-ascii?q?j06tkDdt2/DJILnhDo/RIXjElbfsZrB960layAo8y9Bf+ohYCrYbIPL8QkPxrs?=
 =?us-ascii?q?DXDgclMwyoxObqENF91oIdWW2RGKOYP77SvESM5uIuJemMeYAUtCz8K/gj+/7h?=
 =?us-ascii?q?k3s5lUUBcqmu2JtEIE2+BelsdkWFfWL30JBGFWYRohF4Suvsh1ufFzlJaDG3Vq?=
 =?us-ascii?q?M44zg9T4W+EYbEQJvqmbGEwWK3E4NbYjN7DEuRGyLtfoSAR/BecS+XP4ptnyIJ?=
 =?us-ascii?q?Uf27RpY82AqynAn9zbVhM6zT4CJPro/p1tV++7jOkwov/yd/FcWX3jKxSDRPgm?=
 =?us-ascii?q?4GTjkxlI92u1500FqH1aEw1+dXHMZB7ulEeh03OZ7V06pxDNWkCSzbedLca1u4?=
 =?us-ascii?q?Q9PuJn4aSdQ3xMVGN0VwBdSkphPE1C2sBbgP0bqGGMpnoernw3HtKpMlmD7936?=
 =?us-ascii?q?47ggxjG5MXOA=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ACAADYIfhbhxHrdtBjGgEBAQEBAgEBA?=
 =?us-ascii?q?QEHAgEBAQGBUQUBAQEBCwGBMIJijBFfiyGCDXqWQYFxFAEBGBSIWiI0CQ0BAwE?=
 =?us-ascii?q?BAQEBAQIBEwEBAQoLCQgbDiMMgjYFAgMaAQaCXAECAwECNwYBAQQKKQECAwECB?=
 =?us-ascii?q?gEBCg4KCR0IAwELBSABBQEiEwWDHIICAQSbOjyKHYIfgnYBAQWHFQgSiluBHBc?=
 =?us-ascii?q?+gUGBEYJdNYQ4g3uCJosThH+PcgmRJAsYiVGHN5gJBgIJBw8hgSWCDU0uCoMng?=
 =?us-ascii?q?huIRoYXVIECBSETiS9HgXcBAQ?=
X-IPAS-Result: =?us-ascii?q?A0ACAADYIfhbhxHrdtBjGgEBAQEBAgEBAQEHAgEBAQGBUQU?=
 =?us-ascii?q?BAQEBCwGBMIJijBFfiyGCDXqWQYFxFAEBGBSIWiI0CQ0BAwEBAQEBAQIBEwEBA?=
 =?us-ascii?q?QoLCQgbDiMMgjYFAgMaAQaCXAECAwECNwYBAQQKKQECAwECBgEBCg4KCR0IAwE?=
 =?us-ascii?q?LBSABBQEiEwWDHIICAQSbOjyKHYIfgnYBAQWHFQgSiluBHBc+gUGBEYJdNYQ4g?=
 =?us-ascii?q?3uCJosThH+PcgmRJAsYiVGHN5gJBgIJBw8hgSWCDU0uCoMnghuIRoYXVIECBSE?=
 =?us-ascii?q?TiS9HgXcBAQ?=
X-IronPort-AV: E=Sophos;i="5.56,270,1539673200"; 
   d="scan'208";a="42002580"
X-Amp-Result: UNSCANNABLE
X-Amp-File-Uploaded: False
Unscannable: 2
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 23 Nov 2018 07:57:15 -0800
Received: from localhost ([::1]:53190 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gQDpT-0004t8-2l
	for like.xu@linux.intel.com; Fri, 23 Nov 2018 10:57:15 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:40987)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <kevin@koconnor.net>) id 1gQDn6-0003ZL-Oh
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 10:54:49 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <kevin@koconnor.net>) id 1gQDn1-0008SS-Qm
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 10:54:48 -0500
Received: from mail-qk1-x743.google.com ([2607:f8b0:4864:20::743]:41295)
	by eggs.gnu.org with esmtps (TLS1.0:RSA_AES_128_CBC_SHA1:16)
	(Exim 4.71) (envelope-from <kevin@koconnor.net>) id 1gQDn1-0008RZ-Gz
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 10:54:43 -0500
Received: by mail-qk1-x743.google.com with SMTP id 189so8691541qkj.8
	for <qemu-devel@nongnu.org>; Fri, 23 Nov 2018 07:54:43 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=koconnor.net; s=google;
	h=date:from:to:cc:subject:message-id:references:mime-version
	:content-disposition:in-reply-to:user-agent;
	bh=gP7Fb3xAxxs9MCtTVX392aXKEVyCtZVJ6MS8ZYR8yng=;
	b=a5qhkAqcalEUyfEGaIOvtvAl3voVpgS3RZzZ5wO3+hKtqst9ChLxEos3gycN+l/hbF
	4SreIJZUAcLcXKbNli4M3nFQM8i0tOcIAHAcFyggx/kGCKbIqLS62O2A9fc10wFY3wx0
	BvUQvKHI2J9WKxV73KkPLpi887aTBSJym6dD4=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
	d=1e100.net; s=20161025;
	h=x-gm-message-state:date:from:to:cc:subject:message-id:references
	:mime-version:content-disposition:in-reply-to:user-agent;
	bh=gP7Fb3xAxxs9MCtTVX392aXKEVyCtZVJ6MS8ZYR8yng=;
	b=ZH3S/M6iLToqHToluILsREVAy1HTqtuY6ErJh8ebWwdJkYrM7K/TFU3yqcrUfdqoDV
	r7fnRysbqJEbFlTNV3k9Sp8VuBF8gNZDVfdTZi1uMbhYkBp/YYAJerOy60+zQiqY4mT2
	e7awKQan+ADCgksIpT58COk+U1tru3nO78RtvVwU21urCve8741tyte9J8to9vJUa5+G
	yymMY6FFntqLsqbfgKV0Su6zeI2mPPzvaT1kInY8owhofR/ESawPCAhqjijajgMC+Nm+
	D5tjL0wsBlS/a60jJ+1TEfJV/H1Axq+mi5VijE9tX7gP/S3eNf2t8M1l4Oa0K09XliK2
	cffw==
X-Gm-Message-State: AA+aEWZs9LxfWimLsUCB1/1mvWm7cX58e98+ZG/KIt4YGnY4vR9brc/k
	LFmTtry4An17e8I9h97tnMgUYw==
X-Google-Smtp-Source: AFSGD/VyWGThK+di0kXFc3q4mg0jtbiKDzE16wOK90m5xl+YftJmbbm9RUaS/ed5ZOTQ686W/ew6QQ==
X-Received: by 2002:a37:2808:: with SMTP id o8mr14183363qkh.14.1542988482464; 
	Fri, 23 Nov 2018 07:54:42 -0800 (PST)
Received: from localhost ([64.9.249.65]) by smtp.gmail.com with ESMTPSA id
	q5sm36156799qtq.20.2018.11.23.07.54.41
	(version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
	Fri, 23 Nov 2018 07:54:41 -0800 (PST)
Date: Fri, 23 Nov 2018 10:54:40 -0500
From: Kevin O'Connor <kevin@koconnor.net>
To: Stefano Garzarella <sgarzare@redhat.com>
Message-ID: <20181123155440.GA19103@morn.lan>
References: <20181119141543.o6xl4vfptajuksi3@sirius.home.kraxel.org>
	<CAGxU2F4kUD85FMVEAcOpWUAGF98G2KR9O8EVAkzBDmA+DkS2KA@mail.gmail.com>
	<20181120062109.eahirgygm4br3ov7@sirius.home.kraxel.org>
	<CAGxU2F64uK5oygQecZKOPpsyb--Pth9U00P_gghrtYDwQrSGtg@mail.gmail.com>
	<20181120112203.rzhhdl6hhsjf5twt@sirius.home.kraxel.org>
	<CAGxU2F4LNN1UtVJFADxm1V4eBDQ8eGSoAjPXC=X8+zSR4yd9Nw@mail.gmail.com>
	<20181122115135.funmtcql3xhrixi6@sirius.home.kraxel.org>
	<CAGxU2F6462MF00_0dh_6HiFPgVyEpaRTEPJ_0-sUdg8YnhgLcw@mail.gmail.com>
	<20181123062138.rdfaeaqq5uw43ey2@sirius.home.kraxel.org>
	<CAGxU2F5-UUaJbwpKhTY1ZsRWVst=gM79nSjnZtZJVKDpime_Lw@mail.gmail.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <CAGxU2F5-UUaJbwpKhTY1ZsRWVst=gM79nSjnZtZJVKDpime_Lw@mail.gmail.com>
User-Agent: Mutt/1.10.1 (2018-07-13)
X-detected-operating-system: by eggs.gnu.org: Genre and OS details not
	recognized.
X-Received-From: 2607:f8b0:4864:20::743
Subject: Re: [Qemu-devel] SeaBIOS booting time optimization
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Samuel Ortiz <sameo@linux.intel.com>,
	Rob Bradford <robert.bradford@intel.com>,
	Stefan Hajnoczi <stefanha@gmail.com>, seabios@seabios.org,
	qemu-devel@nongnu.org, stephend@silicom-usa.com,
	Gerd Hoffmann <kraxel@redhat.com>, Stefan Hajnoczi <stefanha@redhat.com>,
	Paolo Bonzini <pbonzini@redhat.com>, stefanb@linux.ibm.com
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

On Fri, Nov 23, 2018 at 12:18:13PM +0100, Stefano Garzarella wrote:
> On Fri, Nov 23, 2018 at 7:21 AM Gerd Hoffmann <kraxel@redhat.com> wrote:
> > On Thu, Nov 22, 2018 at 04:13:38PM +0100, Stefano Garzarella wrote:
> > > On Thu, Nov 22, 2018 at 12:51 PM Gerd Hoffmann <kraxel@redhat.com> wrote:
> > > > On Thu, Nov 22, 2018 at 12:08:55PM +0100, Stefano Garzarella wrote:
> > > > > Hi,
> > > > > I continued to investigate how to reduce the boot time with SeaBIOS
> > > > > and QEMU when it used with linuxboot_dma.bin (-kernel parameter).
> > > > > I reached ~12ms with a SeaBIOS configuration (attached) where I
> > > > > disabled debug output, all Hardware support (except SMM & MTRRs) and I
> > > > > applied a small patch to disable VGA setup and console (attached).
> > > >
> > > > Is there any difference to "qemu -vga none" ?
> > >
> > > Using both (qemu -vga none, and my patch) we are around 10.8 ms.
> > > Note: using only the patch, Linux is still able to initialize and use the VGA.
> >
> > But do you want linux use the vga console if you care about boot times?
> > I'd expect virtio-console would be fastest in that case.
> 
> I agree with you, but if we will implement a QEMU fastboot feature in
> SeaBIOS, we are sure that it works with Linux kernel if someone uses
> "qemu -kernel" and wants also use a VGA.

It should be possible to use "-device VGA,romfile=" to enable VGA
without an optionrom.

> > > - QEMU -vga none + SeaBIOS config (CONFIG_DEBUG_LEVEL=0, disable all
> > > HW support except
> > > SMM & MTRRs) + Stephen's TPM patch
> > >  qemu_init_end: 43.675803
> > >  fw_start: 43.865178 (+0.189375)
> > >  fw_do_boot: 58.093161 (+14.227983)
> > >  linux_start_boot: 59.490308 (+1.397147)
> > >  linux_start_user: 556.782354 (+497.292046)
> > >
> > > - QEMU -vga none + SeaBIOS config (CONFIG_DEBUG_LEVEL=0, disable all
> > > HW support except
> > > SMM & MTRRs, CONFIG_DISABLE_VGA=y) + Stephen's TPM patch
> > >  qemu_init_end: 42.387412
> > >  fw_start: 42.579257 (+0.191845)
> > >  fw_do_boot: 53.381517 (+10.802260)
> > >  linux_start_boot: 54.848643 (+1.467126)
> > >  linux_start_user: 498.517050 (+443.668407)
> >
> > Interesting that CONFIG_DISABLE_VGA=y makes a noticable difference even
> > without vga hardware being preset.  And not only in seabios but also for
> > the linux kernel.
> >
> > Do you know why?
> 
> In SeaBIOS I think the reasons are:
> - vgarom_setup() scan all PCI devices to find a VGA
> - enable_vga_console() invokes an int10 without check if there is a
> VGA (maybe here we can add a check)

Where is CONFIG_DISABLE_VGA set - it's not a standard SeaBIOS config
option?

In my experience, the only meaningful delays are the result of
accessing hardware.  Neither of the above two items would result in
additional hardware accesses, so I don't think they would be the cause
of an additional delay.

-Kevin

