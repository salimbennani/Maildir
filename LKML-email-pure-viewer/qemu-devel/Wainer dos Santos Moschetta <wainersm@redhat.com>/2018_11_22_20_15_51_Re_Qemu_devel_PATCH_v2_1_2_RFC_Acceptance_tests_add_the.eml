Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 08:31:59 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga004.jf.intel.com (orsmga004.jf.intel.com [10.7.209.38])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id CF9E8580460
	for <like.xu@linux.intel.com>; Thu, 22 Nov 2018 12:16:34 -0800 (PST)
Received: from fmsmga104.fm.intel.com ([10.1.193.100])
  by orsmga004-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 22 Nov 2018 12:16:34 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AFLMKzxxWa+I79OfXCy+O+j09IxM/srCxBDY+r6Qd?=
 =?us-ascii?q?0uoVL/ad9pjvdHbS+e9qxAeQG9mDu7Qc06L/iOPJYSQ4+5GPsXQPItRndiQuro?=
 =?us-ascii?q?EopTEmG9OPEkbhLfTnPGQQFcVGU0J5rTngaRAGUMnxaEfPrXKs8DUcBgvwNRZv?=
 =?us-ascii?q?JuTyB4Xek9m72/q99pHPYAhEniaxba9vJxiqsAvdsdUbj5F/Iagr0BvJpXVIe+?=
 =?us-ascii?q?VSxWx2IF+Yggjx6MSt8pN96ipco/0u+dJOXqX8ZKQ4UKdXDC86PGAv5c3krgfM?=
 =?us-ascii?q?QA2S7XYBSGoWkx5IAw/Y7BHmW5r6ryX3uvZh1CScIMb7Vq4/Vyi84Kh3SR/okC?=
 =?us-ascii?q?YHOCA/8GHLkcx7kaZXrAu8qxBj34LYZYeYP+d8cKzAZ9MXXXRPXshRWSJCDI2z?=
 =?us-ascii?q?YYQAAOgdMuhXsof9v1kDoxmxCAWxCu7j1iFHhmTt0K0myuQsCx3K0BAuEt8Mtn?=
 =?us-ascii?q?nfsdX7NL0VUeCw1KTHzS/Mb/JQ2Tjj8ojDbw0uofaXXbltbMTe008vFx/CjlWL?=
 =?us-ascii?q?tIfrODSV1v8RvGib8eVgSf6vhHQ6oAx2rDmg3MYsio/XiYIP0VDE8D50wJwrKt?=
 =?us-ascii?q?KlSE50e8KkHIFMuCGdMot7W8UvSHxrtiYi0rAKp4K3cSsQxJg62hLSaOaLf5aG?=
 =?us-ascii?q?7x/jTuqdPDV1iGp7dL6jgxu+61Wsx+PiWsWuzVpHrSRInsPSun0O0RHY99KJRe?=
 =?us-ascii?q?Fn/ki73DaCzwDT5f9AIUAzjafbL58hwqUslpoIq0jDESn2mFjsgK+RbEUk9fCk?=
 =?us-ascii?q?6+XhYrr4up+RL5F4hh39P6g0h8CzHOc1PhIQU2WV+emwzqDv8E/hTLVPlPI2k6?=
 =?us-ascii?q?3ZsJ7AJcQco660GxZV3Zgm6xaiFjupzcoXnWcZI1JBYR6IlI/pO0zIIP/kE/i/?=
 =?us-ascii?q?mFOgkDNqx/DFILLtGJrMLmXbnbflfLZ97VNcyQUpwdBe4ZJUFq8OIPbpVkDts9?=
 =?us-ascii?q?zYCwQ0Mwqzw+bhB9V90J4eVXiIAq+DP6PeqUWI6f43I+mQeI8Vvy7wK/wk5/7t?=
 =?us-ascii?q?k3A1g1AcfbSy0JsTaXC4GOlmIkqDbXrthNcBDXkFvg4kQOP2j12CVG0bWnCpQq?=
 =?us-ascii?q?hp5i0nEJn0SsDHR5uxm/qH2yG0GIAQYXpJTVWFEHPtfoPDXO8QaSWUOYh4nzkZ?=
 =?us-ascii?q?ELSsVYIlhiyorxLwnr9uL+7I/X8BuJf+kdR4+eDX0As/7CF5FNi11WaLQGdp2G?=
 =?us-ascii?q?QSSGgtwap9rEdhn0qFyrVymPdCFNZetM9OByw+OJTR1aRADMv7ElbKZNCSQX68?=
 =?us-ascii?q?T9mmCC13RdU0lZtGekt4BpCugw7O2wKsBLkakaHNA4Y7oYzG2H2kGM98zXvcnK?=
 =?us-ascii?q?UmlBEdS81TMnbuo6lk/AjeG5LA2xGGnqeseL4H2QbX+WuDxHbIt0ZdBl0jGZ7Z?=
 =?us-ascii?q?VGwSMxOF5e/y4VnPGvr3Uewq?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ACAAAQDfdbhxHrdtBjGgEBAQEBAgEBA?=
 =?us-ascii?q?QEHAgEBAQGBUgQBAQEBCwGBMIE5gRYTg3mId4shgg2XOoFzFBgDEYRAhBIiNQg?=
 =?us-ascii?q?NAQMBAQEBAQECARMBAQEKCwkIKS+CNgUCAxoBBoJbAQEBAQIBAQIgBBEOCikDA?=
 =?us-ascii?q?wECBgEBCAIOCgICIgQCAgMBUwYBDAYCAQEBgxwBgXkIAQSNHJtQfDOFQIRdgQu?=
 =?us-ascii?q?KfheBf4ERJ4JrhH6DBIJXAqACCYY9P4otBhiCJocrhEWCcpgwgUgCgglNIxWDJ?=
 =?us-ascii?q?wmCR44iKTGBBxyKQoF3AQE?=
X-IPAS-Result: =?us-ascii?q?A0ACAAAQDfdbhxHrdtBjGgEBAQEBAgEBAQEHAgEBAQGBUgQ?=
 =?us-ascii?q?BAQEBCwGBMIE5gRYTg3mId4shgg2XOoFzFBgDEYRAhBIiNQgNAQMBAQEBAQECA?=
 =?us-ascii?q?RMBAQEKCwkIKS+CNgUCAxoBBoJbAQEBAQIBAQIgBBEOCikDAwECBgEBCAIOCgI?=
 =?us-ascii?q?CIgQCAgMBUwYBDAYCAQEBgxwBgXkIAQSNHJtQfDOFQIRdgQuKfheBf4ERJ4Jrh?=
 =?us-ascii?q?H6DBIJXAqACCYY9P4otBhiCJocrhEWCcpgwgUgCgglNIxWDJwmCR44iKTGBBxy?=
 =?us-ascii?q?KQoF3AQE?=
X-IronPort-AV: E=Sophos;i="5.56,266,1539673200"; 
   d="scan'208";a="52316759"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 22 Nov 2018 12:16:33 -0800
Received: from localhost ([::1]:49181 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gPvOr-000349-54
	for like.xu@linux.intel.com; Thu, 22 Nov 2018 15:16:33 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:57155)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <wainersm@redhat.com>) id 1gPvOO-0002zk-Q2
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 15:16:05 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <wainersm@redhat.com>) id 1gPvOK-0002Qn-Rw
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 15:16:04 -0500
Received: from mx1.redhat.com ([209.132.183.28]:36710)
	by eggs.gnu.org with esmtps (TLS1.0:DHE_RSA_AES_256_CBC_SHA1:32)
	(Exim 4.71) (envelope-from <wainersm@redhat.com>) id 1gPvOK-0002Oe-Kd
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 15:16:00 -0500
Received: from smtp.corp.redhat.com (int-mx05.intmail.prod.int.phx2.redhat.com
	[10.5.11.15])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by mx1.redhat.com (Postfix) with ESMTPS id ACADDC057F36;
	Thu, 22 Nov 2018 20:15:58 +0000 (UTC)
Received: from localhost.localdomain (ovpn-121-45.rdu2.redhat.com
	[10.10.121.45])
	by smtp.corp.redhat.com (Postfix) with ESMTP id A10205D76C;
	Thu, 22 Nov 2018 20:15:53 +0000 (UTC)
To: Cleber Rosa <crosa@redhat.com>, qemu-devel@nongnu.org
References: <20181121214818.22874-1-crosa@redhat.com>
	<20181121214818.22874-2-crosa@redhat.com>
From: Wainer dos Santos Moschetta <wainersm@redhat.com>
Message-ID: <d67d31c9-06fe-1f06-66e0-bc6678212ccd@redhat.com>
Date: Thu, 22 Nov 2018 18:15:51 -0200
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101
	Thunderbird/52.5.2
MIME-Version: 1.0
In-Reply-To: <20181121214818.22874-2-crosa@redhat.com>
Content-Type: text/plain; charset=utf-8; format=flowed
Content-Language: en-US
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.15
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
	(mx1.redhat.com [10.5.110.32]);
	Thu, 22 Nov 2018 20:15:58 +0000 (UTC)
Content-Transfer-Encoding: quoted-printable
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 2.2.x-3.x [generic]
	[fuzzy]
X-Received-From: 209.132.183.28
Subject: Re: [Qemu-devel] [PATCH v2 1/2] RFC: Acceptance tests: add the
 build directory to the system PATH
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Samuel Ortiz <sameo@linux.intel.com>,
	=?UTF-8?Q?Philippe_Mathieu-Daud=c3=a9?= <philmd@redhat.com>,
	Eduardo Habkost <ehabkost@redhat.com>, Caio Carrara <ccarrara@redhat.com>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>


On 11/21/2018 07:48 PM, Cleber Rosa wrote:
> So that when binaries such as qemu-img are searched for, those in the
> build tree will be favored.  As a clarification, SRC_ROOT_DIR is
> dependent on the location from where tests are executed, so they are
> equal to the build directory if one is being used.

On avocado's job.log file I can see the full path of the qemu-img which=20
was called, but I wonder if it wouldn't be better to log that=20
information somewhere more explicitly. It wouldn't prevent this patch=20
from being merged though, it's just an improvement suggestion.

>
> The original motivation is that Avocado libraries such as
> avocado.utils.vmimage.get() may use the matching binaries, but it may
> also apply to any other binary that test code may eventually attempt
> to execute.
>
> Other competing alternatives would be a more explicit path or binary
> registration mechanism, in which we tell the libraries such as
> avocado.utils.vmimage, the binaries to use in advance.  I think the
> model proposed here is simpler though, and is not inconsistent with
> the general approach of favoring the built binaries, and falling back
> to binaries available in the system.  I'd love to have comments on
> that, though.

IMHO it makes sense to pick the built binaries, falling back to system's=20
otherwise. Keep it simple (and consistent) unless we eventually need=20
something robust, I would go for that approach here.

>
> Signed-off-by: Cleber Rosa <crosa@redhat.com>
> ---
>   tests/acceptance/avocado_qemu/__init__.py | 9 +++++++++
>   1 file changed, 9 insertions(+)
>
> diff --git a/tests/acceptance/avocado_qemu/__init__.py b/tests/acceptan=
ce/avocado_qemu/__init__.py
> index 1e54fd5932..3d5190cbab 100644
> --- a/tests/acceptance/avocado_qemu/__init__.py
> +++ b/tests/acceptance/avocado_qemu/__init__.py
> @@ -49,6 +49,15 @@ class Test(avocado.Test):
>               self.cancel("No QEMU binary defined or found in the sourc=
e tree")
>           self.vm =3D QEMUMachine(self.qemu_bin)
>  =20
> +        # RFC: avocado.utils.vmimage.get() uses qemu-img, from the
> +        # system's PATH, to create a snapshot.  This is a transparent,
> +        # but implicit way of making sure it finds the qemu-img that
> +        # matches the code being tested (as tests it indirectly too).
> +        # As for the cleanup, given that in the Avocado test execution
> +        # model every test is started in a different process, no
> +        # cleanup is needed.
> +        os.environ['PATH'] =3D '%s:%s' % (SRC_ROOT_DIR, os.environ['PA=
TH'])
> +
>       def tearDown(self):
>           if self.vm is not None:
>               self.vm.shutdown()

The boot Linux test (added on patch 02) exits with error when I ran=20
'make check-acceptance'. I am using Fedora 29 x86_64 which don't have=20
qemu-img installed system-wide. See below:

------
# make check-acceptance
 =C2=A0 AVOCADO tests/acceptance
make: *** [/root/qemu/tests/Makefile.include:940: check-acceptance] Error=
 9
# cat tests/results/latest/results.tap
1..8
not ok 1 /root/qemu/tests/acceptance/boot_linux.py:BootLinux.test
# grep -e 'ERROR.*CmdNotFoundError' tests/results/latest/job.log
2018-11-22 14:51:30,540 stacktrace=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0 L0=
047 ERROR|=C2=A0=C2=A0=C2=A0=C2=A0 raise=20
CmdNotFoundError(cmd, path_paths)
2018-11-22 14:51:30,540 stacktrace=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0 L0=
047 ERROR|=20
avocado.utils.path.CmdNotFoundError: Command 'qemu-img' could not be=20
found in any of the PATH dirs: ['/usr/local/bin', '/bin', '/root/bin',=20
'/sbin', '/usr/libexec', '/usr/local/sbin', '/root/qemu', '/usr/bin',=20
'/usr/sbin']
2018-11-22 14:51:30,572 test=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=
=A0=C2=A0=C2=A0=C2=A0=C2=A0 L0984 ERROR|=20
avocado.utils.path.CmdNotFoundError: Command 'qemu-img' could not be=20
found in any of the PATH dirs: ['/usr/local/bin', '/bin', '/root/bin',=20
'/sbin', '/usr/libexec', '/usr/local/sbin', '/root/qemu', '/usr/bin',=20
'/usr/sbin']
2018-11-22 14:51:30,572 test=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=A0=C2=
=A0=C2=A0=C2=A0=C2=A0=C2=A0 L0999 ERROR| ERROR=20
1-/root/qemu/tests/acceptance/boot_linux.py:BootLinux.test ->=20
CmdNotFoundError: Command 'qemu-img' could not be found in any of the=20
PATH dirs: ['/usr/local/bin', '/bin', '/root/bin', '/sbin',=20
'/usr/libexec', '/usr/local/sbin', '/root/qemu', '/usr/bin', '/usr/sbin']
------

The same test finished successfully when I ran with 'avocado run (...)'=20
though.

- Wainer


