Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 25 Nov 2018 14:43:14 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga005.jf.intel.com (orsmga005.jf.intel.com [10.7.209.41])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 63CC258037D
	for <like.xu@linux.intel.com>; Sat, 24 Nov 2018 17:26:03 -0800 (PST)
Received: from orsmga102-1.jf.intel.com (HELO mga09.intel.com) ([10.7.208.27])
  by orsmga005-1.jf.intel.com with ESMTP; 24 Nov 2018 17:26:03 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AQ7jAehCG5T8BNsFKIQNNUyQJP3N1i/DPJgcQr6Af?=
 =?us-ascii?q?oPdwSPXzpsbcNUDSrc9gkEXOFd2Cra4c26yO6+jJYi8p2d65qncMcZhBBVcuqP?=
 =?us-ascii?q?49uEgeOvODElDxN/XwbiY3T4xoXV5h+GynYwAOQJ6tL1LdrWev4jEMBx7xKRR6?=
 =?us-ascii?q?JvjvGo7Vks+7y/2+94fcbglUhzexe69+IAmrpgjNq8cahpdvJLwswRXTuHtIfO?=
 =?us-ascii?q?pWxWJsJV2Nmhv3+9m98p1+/SlOovwt78FPX7n0cKQ+VrxYES8pM3sp683xtBnM?=
 =?us-ascii?q?VhWA630BWWgLiBVIAgzF7BbnXpfttybxq+Rw1DWGMcDwULs5Qiqp4bt1RxD0iS?=
 =?us-ascii?q?cHLz85/3/Risxsl6JQvRatqwViz4LIfI2ZMfxzdb7fc9wHX2pMRshfWSxfDI2/?=
 =?us-ascii?q?YYsAAPYOMvtaoIbzulUOtRmzCwujCe/yxDJEmmH53bYh3uQ9DQ3LxhAsE84UvX?=
 =?us-ascii?q?jKqtj+KaccUfqyzKnN1TjPYfxY2TL86IjMcxAhpuyHU7NqfcHM10QvEB/FgU+e?=
 =?us-ascii?q?pYf4OD6ayuMNs3SB4Od7Tu2vkXQopBtpojS1wccskIbJi5sTx1vZ9it52J44Kc?=
 =?us-ascii?q?OkREN4e9KoDYZcuiKAO4doTM4vQ3tktDs4x7EepJK3YisHxI4nyhPbcfCLbZSE?=
 =?us-ascii?q?7gj9WOqMIDp1gm9udqiliBao60egz/XxVsmq31ZOqSpIit3MtnEW1xzP8ciLUP?=
 =?us-ascii?q?R9/kG82TqV0ADT8O5ELVg1lardNZEh3qY9moQPvUnABCP6hVj6gayMekk69OWl?=
 =?us-ascii?q?6/7rbqjkq5OEMo97kAD+MqAgmsylBuQ4NxADX3GF9uS5yb3v5FD2T6tUjvIolq?=
 =?us-ascii?q?nVqYvVJcMGpq6/HwBazJ0j5xG7Dzen09QXg2MLLV1YeB+fi4jpOlfOIO33DPul?=
 =?us-ascii?q?glSslitryO7CPrH7HprNKX3DnaznfbZ67U5cxwwzzc1F65JTELEBL+r/WlXtu9?=
 =?us-ascii?q?zAEh85Lwu0zv7jCNV81YMRR3iDA6CEMK7JtV+I5+QvI/SDZYMPuTb9LeQl6ODq?=
 =?us-ascii?q?jXMjhVAdeqypjtMqbmulFKFmP1mBeiirxdMACnsR+Aw5SuPslRuFSzEUYn+zW6?=
 =?us-ascii?q?c14HY8EJ6nCoHYAZmghaHE0CqlE5kFW2ZdF1rZFH7pc5mDCe4BbT/XLsJ/nzhB?=
 =?us-ascii?q?T7W4VoI6yTmoswn1zachKfDbrTYFv5Du38Qg+uvIiBsp/iZ1BcnO72bYZmV5nX?=
 =?us-ascii?q?gBQTM/xuhaqFZ+zUmC2uAsivhVFsda4f9ASEE/c5vVzuhSBNX7WwaHddCMHgWI?=
 =?us-ascii?q?WNKjVHscS9M1wthGTAA1MNK+h1qLiyGtH7Y9naaCDYRy9bjTiSuib/1hwmrLgf?=
 =?us-ascii?q?Fyx2ItRdFCYCj/3vZy?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ABAADX+flbhxHrdtBiGgEBAQEBAgEBA?=
 =?us-ascii?q?QEHAgEBAQGBUQUBAQEBCwGBMIJijBFfiyGCDY4EiTiBbhkYFIhaIjQJDQEDAQE?=
 =?us-ascii?q?BAQEBAgETAQEBCgsJCBsOIwyCNgUCAxoBBoJcAQIDAQI3BgEBBAopAQIDAQIGA?=
 =?us-ascii?q?QEKGAkdCAMBCwVJGIMcggIBBKNGgh+CdgEBBYcVCIptgRwRBoF/g241iDOCJok?=
 =?us-ascii?q?BhxGPcgcCApEiIwqJRYc5mDCBRoINfQiDJ4Ibg22FFIVcVIECBSETijOBdwEB?=
X-IPAS-Result: =?us-ascii?q?A0ABAADX+flbhxHrdtBiGgEBAQEBAgEBAQEHAgEBAQGBUQU?=
 =?us-ascii?q?BAQEBCwGBMIJijBFfiyGCDY4EiTiBbhkYFIhaIjQJDQEDAQEBAQEBAgETAQEBC?=
 =?us-ascii?q?gsJCBsOIwyCNgUCAxoBBoJcAQIDAQI3BgEBBAopAQIDAQIGAQEKGAkdCAMBCwV?=
 =?us-ascii?q?JGIMcggIBBKNGgh+CdgEBBYcVCIptgRwRBoF/g241iDOCJokBhxGPcgcCApEiI?=
 =?us-ascii?q?wqJRYc5mDCBRoINfQiDJ4Ibg22FFIVcVIECBSETijOBdwEB?=
X-IronPort-AV: E=Sophos;i="5.56,276,1539673200"; 
   d="scan'208";a="54662635"
X-Amp-Result: UNSCANNABLE
X-Amp-File-Uploaded: False
Unscannable: 2
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 24 Nov 2018 17:26:01 -0800
Received: from localhost ([::1]:58350 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gQjBQ-0002Tl-8B
	for like.xu@linux.intel.com; Sat, 24 Nov 2018 20:26:00 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:47146)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <cota@braap.org>) id 1gQjAy-0002Sa-Q1
	for qemu-devel@nongnu.org; Sat, 24 Nov 2018 20:25:33 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <cota@braap.org>) id 1gQjAv-0006X5-N5
	for qemu-devel@nongnu.org; Sat, 24 Nov 2018 20:25:32 -0500
Received: from wout2-smtp.messagingengine.com ([64.147.123.25]:37943)
	by eggs.gnu.org with esmtps (TLS1.0:DHE_RSA_AES_256_CBC_SHA1:32)
	(Exim 4.71) (envelope-from <cota@braap.org>) id 1gQjAv-0006Vh-AO
	for qemu-devel@nongnu.org; Sat, 24 Nov 2018 20:25:29 -0500
Received: from compute4.internal (compute4.nyi.internal [10.202.2.44])
	by mailout.west.internal (Postfix) with ESMTP id 6B3A3CE5;
	Sat, 24 Nov 2018 20:25:27 -0500 (EST)
Received: from mailfrontend2 ([10.202.2.163])
	by compute4.internal (MEProxy); Sat, 24 Nov 2018 20:25:27 -0500
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=braap.org; h=
	date:from:to:cc:subject:message-id:references:mime-version
	:content-type:in-reply-to; s=mesmtp; bh=d35OWlcgaK0zjpKFmRkLc0B1
	+5luTVQpaAOGvbMGBQ8=; b=1ulKsDFdgZtr2oKJIljAlBcLYzasFigVYilM0Y0t
	7kBzz7mewpjiOOL2qdWKKw6yYPFTcrA7edxFzw6gNMwRY/8jELFUlMfLwe/LKn9j
	qp9dryrAl3QzwpmHMy1cxavvbefeKAdbvLlEBE7sYD9Kg/vs3Bwo8R15cKZMyi89
	iB4=
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=
	messagingengine.com; h=cc:content-type:date:from:in-reply-to
	:message-id:mime-version:references:subject:to:x-me-proxy
	:x-me-proxy:x-me-sender:x-me-sender:x-sasl-enc; s=fm1; bh=d35OWl
	cgaK0zjpKFmRkLc0B1+5luTVQpaAOGvbMGBQ8=; b=HWolvX2lc62azLNq89+5ra
	jjmi3q3oai45+akpIzCYAYKdERQd5dtMSEkeQ0YhmjMsbw1sRrU3Bux0nm+mlptj
	1XLkF8PJnTE7NpVK8KtmrmF2ojE0hTzi0Bc0483dWmoZrRbpBO4KZ0VA7QrlzpsB
	AiCkmXi+c3hA/drfxC5NSVnCF1ImB+RujnPCuIkNTG1SUqhvPjplSCBBi7g01NWQ
	H+3eN2KhS9KT8UFQ+NFP7ayhTJoGzFuLdKtXaJQU6stVFt9PABx0gsbscKM/MHkP
	rOebmnhbD1yIrt2x3kVjYaqA+e2bqV5x7viFHTK4UTkBulIxH8nB2axeTD16qrXQ
	==
X-ME-Sender: <xms:Bvr5W94DuuoYWBkhhljf8yqVUHdeIdic45pD3HRSRSV85ial79tjdw>
X-ME-Proxy: <xmx:Bvr5W_L5CvWBtfCzhEm4M2jYWyy3Os7MxJMjgM5fFIdLRwU0mGJ1Qg>
	<xmx:Bvr5W2UoMXfJIb18L0LU-I_y6Kzz0yu0heAjUNolTXT97LmlOrHc8Q>
	<xmx:Bvr5Wz0NrzhgkYlL_i4R_dbN3uSJla5ZKXAWnsb2iaiaftbXWP-BDw>
	<xmx:Bvr5Wy11cQXLNkaRLkPZhMsBowO_t84NWgxZ9Z8cMJGCX0vF_fmGxw>
	<xmx:Bvr5Wzhjgp6UbWIx1dFaBJGG69YVaQyQB_bp_x02541G6TgdkHqdww>
	<xmx:B_r5W72S3Pget6ZG_F_F-lTCBoZXu-owrdPyMUlyc0ufWT951f3SmQ>
Received: from localhost (flamenco.cs.columbia.edu [128.59.20.216])
	by mail.messagingengine.com (Postfix) with ESMTPA id 8200A102E8;
	Sat, 24 Nov 2018 20:25:26 -0500 (EST)
Date: Sat, 24 Nov 2018 20:25:25 -0500
From: "Emilio G. Cota" <cota@braap.org>
To: Aleksandar Markovic <aleksandar.m.mail@gmail.com>
Message-ID: <20181125012525.GA22864@flamenco>
References: <20181124235553.17371-1-cota@braap.org>
	<20181124235553.17371-8-cota@braap.org>
	<CAL1e-=gL0s2-zLgBYQrW1=VSOB=LepzDgDS08P7qGNAiOynsyg@mail.gmail.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <CAL1e-=gL0s2-zLgBYQrW1=VSOB=LepzDgDS08P7qGNAiOynsyg@mail.gmail.com>
User-Agent: Mutt/1.9.4 (2018-02-28)
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 2.2.x-3.x [generic]
	[fuzzy]
X-Received-From: 64.147.123.25
Subject: Re: [Qemu-devel] [PATCH v6 07/13] fpu: introduce hardfloat
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Alex =?iso-8859-1?Q?Benn=E9e?= <alex.bennee@linaro.org>,
	Richard Henderson <richard.henderson@linaro.org>, qemu-devel@nongnu.org
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

On Sun, Nov 25, 2018 at 01:25:25 +0100, Aleksandar Markovic wrote:
> > Note: some architectures (at least PPC, there might be others) clear
> > the status flags passed to softfloat before most FP operations. This
> > precludes the use of hardfloat, so to avoid introducing a performance
> > regression for those targets, we add a flag to disable hardfloat.
> > In the long run though it would be good to fix the targets so that
> > at least the inexact flag passed to softfloat is indeed sticky.
> 
> Can you elaborate more on this paragraph?

Sure. We only use hardfloat when the inexact flag is already
set. If it isn't, we defer to softfloat. This is done for two
reasons:

- Computing the inexact flag requires duplicating
  most of what softfloat does, so it's not worth doing. Note
  that clearing and reading the host's fp flags is even
  slower, so that's not an option.

- The inexact flag is raised *very* frequently. The flag
  remains set (in the guest) unless guest code explicitly
  clears it, which few guest workloads do.

It therefore makes sense for hardfloat to only kick in once
the inexact flag has already been set.

Most targets directly keep the guest's FP flags in the same
struct (float_status) that is passed to softfloat ops.
PPC, however, keeps the state of the guest FP flags in one
place, and passes a pristine float_status to softfloat code
every time it calls it. Thus, given that hardfloat is
entirely implemented in softfloat.c, PPC targets cannot
currently take advantage of it.

Changing this in the PPC target is not impossible, but it will
require additional work that I'm not doing in this series, hence
my note. So for now, PPC targets just have hardfloat disabled
at compile time, which avoids adding overhead for a feature
that they cannot use.

Let me know if anything is unclear. Cheers,

		Emilio

