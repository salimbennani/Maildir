Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 26 Nov 2018 08:52:59 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga004.jf.intel.com (orsmga004.jf.intel.com [10.7.209.38])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id D6EEF5802E4
	for <like.xu@linux.intel.com>; Sun, 25 Nov 2018 16:30:34 -0800 (PST)
Received: from fmsmga103.fm.intel.com ([10.1.193.90])
  by orsmga004-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 25 Nov 2018 16:30:34 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3A/ptjSRVM+RIwLidMbIdq8F5kHcDV8LGtZVwlr6E/?=
 =?us-ascii?q?grcLSJyIuqrYZRSGu6dThVPEFb/W9+hDw7KP9fy4CSpYud6oizMrSNR0TRgLiM?=
 =?us-ascii?q?EbzUQLIfWuLgnFFsPsdDEwB89YVVVorDmROElRH9viNRWJ+iXhpTEdFQ/iOgVr?=
 =?us-ascii?q?O+/7BpDdj9it1+C15pbffxhEiCCybL9uLxi6txndutULioZ+N6g9zQfErGFVcO?=
 =?us-ascii?q?pM32NoIlyTnxf45siu+ZNo7jpdtfE8+cNeSKv2Z6s3Q6BWAzQgKGA1+dbktQLf?=
 =?us-ascii?q?QguV53sTSXsZnxxVCAXY9h76X5Pxsizntuph3SSRIMP7QawoVTmk8qxmUwHjhj?=
 =?us-ascii?q?sZODEl8WHXks1wg7xdoBK9vBx03orYbJiIOPZiYq/ReNUXTndDUMlMTSxMGo2y?=
 =?us-ascii?q?YYsRAeQCM+ZXoJXyqEYMohSwGAesHOHixD1Hi3Pr06A2z/ouERrd0Qw8A94Dqm?=
 =?us-ascii?q?jYoMnvOasMV+2+0anGzS/Eb/NTwTrx5ofGchUgofGIXLJwdtfax0g1GwjYkFiQ?=
 =?us-ascii?q?rpDlMCmb2u8QtGWU8+1gVf61hGM8sA5xuCKgyd00ioXTgYIV0F/E+Dx/zY0oK9?=
 =?us-ascii?q?O4T0t7bsSlEJtWryyaNo52Qsw/Q2Fyoio11roGuZu9cSMXy5on3wbSZ+Kbf4WL?=
 =?us-ascii?q?+B7vSfudLDRiiH57dr+yhwy+/VWix+HkS8W4zlVHojBFn9TIrHwByQDf5tKZRv?=
 =?us-ascii?q?dg/0qs3yuE2RrJ5eFeO080kLLWK54/zb40kZoeqUDDHi7tmEXql6+abEok+u61?=
 =?us-ascii?q?6+j9ZbXmvJCcO5d1igH4LKsuhtSyDfokPgUNRWSX5Pmw2b758UHnTrhHjuc6nr?=
 =?us-ascii?q?TbvZzCIMQUvK+5Awtb0oY57Ba/Ci+r0M0GknkCMVJJYQ+IgJb3O17QJPD0FOyw?=
 =?us-ascii?q?g1OxkDdt2//JIKbhDpLJLnjCk7fuY6xx6kFByAcrydBf5pRUCqwOIf7pW0/xss?=
 =?us-ascii?q?DYAQE9MwCu3+nnD9B925gYWWKIBK+ZP6XSsUKS6uIoOemMa5cZuCzhJPg9+/7u?=
 =?us-ascii?q?kXg5lEcZfamo3psYdmq0H/t7I0iCZXrsg9EBEXoFvwYkTezqjkGCXiBXZ3qoQ6?=
 =?us-ascii?q?084TQ7W8qbC5zeTNWtnKCZx3X8WZlXfXxdTFaLF3juasODQfhLbSuTJspolHsD?=
 =?us-ascii?q?TaSgTIk6kgijsRK/x7d5I+6HxysDqJi20dF04/HUxwg/8CExA8mD3mXIVWxtg2?=
 =?us-ascii?q?4TWxcw26Zwp1E7zU2MhrNlif5VHsAG+vVSTw0hPoTdxeEpN9enYAPKft6TRB6G?=
 =?us-ascii?q?T9OqDCsqSdR5l8UPaEZ0Adnkjh3F0yewGLgTv7iKApUu9eTbxXendOhnzHOTno?=
 =?us-ascii?q?Qkjl0nRYNgcyWNgbJ2vUCHDInVmm2Tja+jbeIbxiGbpzTL9naHoEwNCF04aq7C?=
 =?us-ascii?q?R31KIxKO9dk=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ACAABFPvtbhxHrdtBhGQEBAQEBAQEBA?=
 =?us-ascii?q?QEBAQcBAQEBAQGBUgMBAQEBAQsBgTCBOYEpjHCLH4INjgSJOIFuGRgHDYhaIjU?=
 =?us-ascii?q?IDQEDAQEBAQEBAgETAQEBCgsJCBsOIwyCNgUCAxoBBoJcAQIDAQI3BgEBBAopA?=
 =?us-ascii?q?QIDAQIGAQEKGAkdCAMBCwVJEwWDHAGCAQEEpCiCH4J2AQEFgTABhWEDBYptgRw?=
 =?us-ascii?q?RBoF/hCOIM4ImkBKPcgcCApEiIwqJRYc5jRcsK4pCgUgDggh9CIMnghuDbYUUh?=
 =?us-ascii?q?VxUgQIFIROJZoF3AQE?=
X-IPAS-Result: =?us-ascii?q?A0ACAABFPvtbhxHrdtBhGQEBAQEBAQEBAQEBAQcBAQEBAQG?=
 =?us-ascii?q?BUgMBAQEBAQsBgTCBOYEpjHCLH4INjgSJOIFuGRgHDYhaIjUIDQEDAQEBAQEBA?=
 =?us-ascii?q?gETAQEBCgsJCBsOIwyCNgUCAxoBBoJcAQIDAQI3BgEBBAopAQIDAQIGAQEKGAk?=
 =?us-ascii?q?dCAMBCwVJEwWDHAGCAQEEpCiCH4J2AQEFgTABhWEDBYptgRwRBoF/hCOIM4Imk?=
 =?us-ascii?q?BKPcgcCApEiIwqJRYc5jRcsK4pCgUgDggh9CIMnghuDbYUUhVxUgQIFIROJZoF?=
 =?us-ascii?q?3AQE?=
X-IronPort-AV: E=Sophos;i="5.56,280,1539673200"; 
   d="scan'208";a="53252573"
X-Amp-Result: UNKNOWN
X-Amp-Original-Verdict: FILE UNKNOWN
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 25 Nov 2018 16:30:33 -0800
Received: from localhost ([::1]:33617 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gR4nJ-000275-6s
	for like.xu@linux.intel.com; Sun, 25 Nov 2018 19:30:33 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:35345)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <cota@braap.org>) id 1gR4n5-00026p-6W
	for qemu-devel@nongnu.org; Sun, 25 Nov 2018 19:30:19 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <cota@braap.org>) id 1gR4n1-0005ad-VD
	for qemu-devel@nongnu.org; Sun, 25 Nov 2018 19:30:19 -0500
Received: from out4-smtp.messagingengine.com ([66.111.4.28]:44659)
	by eggs.gnu.org with esmtps (TLS1.0:DHE_RSA_AES_256_CBC_SHA1:32)
	(Exim 4.71) (envelope-from <cota@braap.org>) id 1gR4n1-0005a6-Lv
	for qemu-devel@nongnu.org; Sun, 25 Nov 2018 19:30:15 -0500
Received: from compute4.internal (compute4.nyi.internal [10.202.2.44])
	by mailout.nyi.internal (Postfix) with ESMTP id 66A7521BD6;
	Sun, 25 Nov 2018 19:30:13 -0500 (EST)
Received: from mailfrontend1 ([10.202.2.162])
	by compute4.internal (MEProxy); Sun, 25 Nov 2018 19:30:13 -0500
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=braap.org; h=
	date:from:to:cc:subject:message-id:references:mime-version
	:content-type:in-reply-to; s=mesmtp; bh=Tauvhl86VpcwLU5U/l6uhYyR
	3bF0zJgWktAvyWRyuFs=; b=V7l0S2jznrHwwDq3+wS8BGvOhv7S5fjIcqnAqwu1
	UJO4sH1LvL9fyRdiuDMlt5pOT+SENTBg9AXxjJASA/q0c8owI+baoT6oUz9EhsvE
	Du/1I/HCgo+7L0cTxHkm8GDI/wG/m9qcI5DihpKqAzSgHfvq75RgTJTguknPv66x
	0Xs=
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=
	messagingengine.com; h=cc:content-type:date:from:in-reply-to
	:message-id:mime-version:references:subject:to:x-me-proxy
	:x-me-proxy:x-me-sender:x-me-sender:x-sasl-enc; s=fm1; bh=Tauvhl
	86VpcwLU5U/l6uhYyR3bF0zJgWktAvyWRyuFs=; b=U84xMfiDzQfR6wndlJ/QCj
	+kTAzkcA32CtVCitLeQviX9IF5oySFx3TA0NAfYD7KaslP2occ1SZ1HvNPjF9tny
	ilRekv4gRKraHgqjRIoThMOv3CB9Ok9EcMY1i59/3BXKz9TZeqvpz8V2ZJuHRIkt
	HntDlLHohPzRN9FZgiVYOhQtdcqm2oiyjGd88pBEgbg2qmdzbX3VclozOMO1h4AC
	KL+4d2HXcDZTjfBS3xnzEmg6mtJgKXRHiQu9La0R7gTDG1yO9pckiVk4MaP3AA+J
	22M99B/MEaZA3AL2BxiKOCBOUd2bDSC7ze4KjVELyANfFqKxLQaHrTF6zmIgDyiw
	==
X-ME-Sender: <xms:lD77WxLJoHGxcCmybB8oI0LzRTXK7UmsrB_eHpQsYgBVIo1RnzIqlA>
X-ME-Proxy: <xmx:lD77W_HTMeN0Qpsbgjp7xBEMBDKjrlvKnz8M4Le8hmUbWCEEWtWCtw>
	<xmx:lD77W-uN76iaS3JgVyEyg-g-VjZLwKmp9ymCg9zkjTdBIQ5PwG5w5Q>
	<xmx:lD77W7vpiJl0sKjyjTHgs58pLRaQYShco7iEuX3PkEuIiA-VI7QPFw>
	<xmx:lD77W3npF4uEKAWEtSqtAHAJYaoUNZqtUFUuJhBTvdXZ-561XLEwlg>
	<xmx:lD77W-JiVjOtHfIknL0-lUhQl3jpcPsy2cYuF7zUrWuIzH7IIq7Abg>
	<xmx:lT77WweGzC7MqdIb8rgti7L5ViHo4XPFx5ix7OQISpqMpWorCYXcLw>
Received: from localhost (flamenco.cs.columbia.edu [128.59.20.216])
	by mail.messagingengine.com (Postfix) with ESMTPA id EFE8AE473B;
	Sun, 25 Nov 2018 19:30:11 -0500 (EST)
Date: Sun, 25 Nov 2018 19:30:11 -0500
From: "Emilio G. Cota" <cota@braap.org>
To: Richard Henderson <richard.henderson@linaro.org>
Message-ID: <20181126003011.GA12936@flamenco>
References: <20181123144558.5048-1-richard.henderson@linaro.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20181123144558.5048-1-richard.henderson@linaro.org>
User-Agent: Mutt/1.9.4 (2018-02-28)
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 2.2.x-3.x [generic]
	[fuzzy]
X-Received-From: 66.111.4.28
Subject: Re: [Qemu-devel] [PATCH for-4.0 v2 00/37] tcg: Assorted cleanups
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Alistair.Francis@wdc.com, qemu-devel@nongnu.org
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

On Fri, Nov 23, 2018 at 15:45:21 +0100, Richard Henderson wrote:
> This includes everything queued so far -- softmmu out-of-line
> patches

Reviewed-by: Emilio G. Cota <cota@braap.org>
for patches 1-9.

I am sad to report that on a Skylake host, this series gives
a ~10% average slowdown for x86_64-softmmu SPEC06int
(I'm reporting speedup, so <1 means slowdown):
  https://imgur.com/a/25iu8Yl

Turns out that despite the higher icache hit, the IPC
ends up being lower. For instance, here are perf counts when
running hmmer x3 right after booting up (bootup is included
in the counts, but hmmer is run 3 times in a row):

- Before:
   249,392,070,159      cycles
   781,327,593,681      instructions              #    3.13  insn per cycle
    85,914,418,873      branches
       242,572,820      branch-misses             #    0.28% of all branches
     1,567,954,032      L1-icache-load-misses

      70.559864567 seconds time elapsed

- After:
   277,806,651,701      cycles
   813,619,725,225      instructions              #    2.93  insn per cycle
   132,453,633,831      branches
       306,969,989      branch-misses             #    0.23% of all branches
     1,250,619,057      L1-icache-load-misses

      78.420517079 seconds time elapsed

On the bright side, in an older system (Sandy Bridge), I get
a fairly neutral average perf impact, with some workloads
speeding up and others slowing down:
  https://imgur.com/a/AokDbkm
(Note that v1 of this series gave an overall slowdown, so that's
progress.)

Given the above, perhaps the best way forward is to add a
configure flag to disable OOL thunks, unless you have any
further optimizations coming up.

Thanks,

		Emilio

