Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 24 Nov 2018 12:37:51 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga007.fm.intel.com (fmsmga007.fm.intel.com [10.253.24.52])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id EDF9258037D
	for <like.xu@linux.intel.com>; Fri, 23 Nov 2018 15:49:15 -0800 (PST)
Received: from fmsmga102.fm.intel.com ([10.1.193.69])
  by fmsmga007-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 15:49:15 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AP9bnfBWZn+w6lq379/3OV51dYI/V8LGtZVwlr6E/?=
 =?us-ascii?q?grcLSJyIuqrYbROHt8tkgFKBZ4jH8fUM07OQ7/iwHzRYqb+681k6OKRWUBEEjc?=
 =?us-ascii?q?hE1ycBO+WiTXPBEfjxciYhF95DXlI2t1uyMExSBdqsLwaK+i764jEdAAjwOhRo?=
 =?us-ascii?q?LerpBIHSk9631+ev8JHPfglEnjWwba9xIRmssQndqtQdjJd/JKo21hbHuGZDdf?=
 =?us-ascii?q?5MxWNvK1KTnhL86dm18ZV+7SleuO8v+tBZX6nicKs2UbJXDDI9M2Ao/8LrrgXM?=
 =?us-ascii?q?TRGO5nQHTGoblAdDDhXf4xH7WpfxtTb6tvZ41SKHM8D6Uaw4VDK/5KpwVhTmlD?=
 =?us-ascii?q?kIOCI48GHPi8x/kqRboA66pxdix4LYeZyZOOZicq/Ye94RWGhPUdtLVyFZDI2y?=
 =?us-ascii?q?b5UBAekPPelXs4byulQAohmwCgexHOPiyD1Gi3Dr0aA0z+guDxrG0Rc8H98Nqn?=
 =?us-ascii?q?nYsMn5Ob0PXe2z0aLGzS/Db/RT2Trl5oTGfRUhofCIXbJxdsra1EghGxnYhViO?=
 =?us-ascii?q?rozlIyma2uoQuGWc8+VgUv6vhHQ8pg5quDig3N0jipHTioIS0FDE+jx0zYAoLt?=
 =?us-ascii?q?O7UE52ecCoHIdTui2AKod6X8AvT3t2tCs0yrAKo4O3cSoSxJg62RLSaOaLfoiM?=
 =?us-ascii?q?7x75SuqdPS10iGx4dL++gRu57FKuxffmVsau1VZHtipFncfItnAKzxHT7smHSu?=
 =?us-ascii?q?Bh/ke6wzqP2AbT6vxeLUAzj6rbJIYtwr82lpUNrUTOBjH6lFn1gaOMa0ko5+ul?=
 =?us-ascii?q?5/75brjoppKQLZJ4hwPmPqQrgMO/AOA4MgYUX2ic/OSxzKTj8lP8QLVXl/E5j7?=
 =?us-ascii?q?fWsI7EKsQfv6K2GAhV0psl6xmjETimy9MUnX0GLFJGZh2LlYfoO0zWLfD8DPe/?=
 =?us-ascii?q?hUmskThxy/DHOL3hHovCLnzZnLj9erZ97lVRyAw0zdBZ6JJUDKwBLOj0Wk/ru9?=
 =?us-ascii?q?zUFgU5PBCsw+b7FNV90ZsTWWaOAq+aLqzeq1CJ5v80LumIZY8Vviv9Kvc/6/7v?=
 =?us-ascii?q?i385hUESfa2z0ZQLb3C4G6cuHkOCfHC5gssdCXxY+U06Tff2kxuEVjhcYWv0WL?=
 =?us-ascii?q?gzoTQyCYajBIGEQZixgbuHx2CiE5hLI2xLFF2IQkrubJiODvIFaSaOJZ14nzkZ?=
 =?us-ascii?q?ELSsVYIlkAujrRL30KZPKO3S9SsF85X5249u+ufRmBouoCFyFNmXyGqXTmt5zV?=
 =?us-ascii?q?8PEhYy0bA3i0F7zNaOmfxxh/FIU9Ze4fVEXy8+NJjV1es8DMr9DFHvZNCMHRyL?=
 =?us-ascii?q?R9SiADZ5YZR56NgSagw1T96lkhnr1TCjCqdTkKaEUs9nupnA1mT8cp4ug03N07?=
 =?us-ascii?q?Ms2hx/GpNC?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ACAADMkfhbhxHrdtBjGgEBAQEBAgEBA?=
 =?us-ascii?q?QEHAgEBAQGBUQUBAQEBCwGBMIJijBFfiyGCDY4EiTiBbhkYFIhaIjQJDQEDAQE?=
 =?us-ascii?q?BAQEBAgETAQEBCgsJCBsOIwyCNgUCAxoBBoJbAQEBAQIBAQIkCwENAQEECikBA?=
 =?us-ascii?q?gMBAgYBAQoYCR0IAwELBUkTBYMcgXoIAQSldYFsM4J2AQEFhxYIim2BHBEGgX+?=
 =?us-ascii?q?DbjWIM4ImkBKPcgcCApEiIwqJRYc5mDCBRoINfQiDJ4IbDBeDSoUUhVxUgQIFI?=
 =?us-ascii?q?ROJdoF3AQE?=
X-IPAS-Result: =?us-ascii?q?A0ACAADMkfhbhxHrdtBjGgEBAQEBAgEBAQEHAgEBAQGBUQU?=
 =?us-ascii?q?BAQEBCwGBMIJijBFfiyGCDY4EiTiBbhkYFIhaIjQJDQEDAQEBAQEBAgETAQEBC?=
 =?us-ascii?q?gsJCBsOIwyCNgUCAxoBBoJbAQEBAQIBAQIkCwENAQEECikBAgMBAgYBAQoYCR0?=
 =?us-ascii?q?IAwELBUkTBYMcgXoIAQSldYFsM4J2AQEFhxYIim2BHBEGgX+DbjWIM4ImkBKPc?=
 =?us-ascii?q?gcCApEiIwqJRYc5mDCBRoINfQiDJ4IbDBeDSoUUhVxUgQIFIROJdoF3AQE?=
X-IronPort-AV: E=Sophos;i="5.56,271,1539673200"; 
   d="scan'208";a="54104655"
X-Amp-Result: UNKNOWN
X-Amp-Original-Verdict: FILE UNKNOWN
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 23 Nov 2018 15:49:08 -0800
Received: from localhost ([::1]:54639 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gQLC9-0000Pt-G7
	for like.xu@linux.intel.com; Fri, 23 Nov 2018 18:49:09 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:56653)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <cota@braap.org>) id 1gQLBm-0000Po-HP
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 18:48:47 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <cota@braap.org>) id 1gQLBj-00048t-Db
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 18:48:46 -0500
Received: from out4-smtp.messagingengine.com ([66.111.4.28]:37231)
	by eggs.gnu.org with esmtps (TLS1.0:DHE_RSA_AES_256_CBC_SHA1:32)
	(Exim 4.71) (envelope-from <cota@braap.org>) id 1gQLBj-00048b-40
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 18:48:43 -0500
Received: from compute4.internal (compute4.nyi.internal [10.202.2.44])
	by mailout.nyi.internal (Postfix) with ESMTP id 8B44421F67;
	Fri, 23 Nov 2018 18:48:42 -0500 (EST)
Received: from mailfrontend2 ([10.202.2.163])
	by compute4.internal (MEProxy); Fri, 23 Nov 2018 18:48:42 -0500
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=braap.org; h=
	date:from:to:cc:subject:message-id:references:mime-version
	:content-type:content-transfer-encoding:in-reply-to; s=mesmtp;
	bh=vmmsTpi69DAdxKU80+ad1Tt87qQp9Srpumop3c97JJo=; b=lGasDJWcDzML
	gtD/BkwiSAwusUzBLBwR/Wwhy5V6z3/AwqzBhFkCHY6OxyGtg3wBI2Ji8+dRNtwL
	VgbcW5tedbMVzscWBUZkrdKbxbgzlL9kHprnajRhe5OSEwbu86gtygfTBu3jY+af
	pmJ20qv+EMljz+CK69ImrjHwTTVPM2U=
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=
	messagingengine.com; h=cc:content-transfer-encoding:content-type
	:date:from:in-reply-to:message-id:mime-version:references
	:subject:to:x-me-proxy:x-me-proxy:x-me-sender:x-me-sender
	:x-sasl-enc; s=fm1; bh=vmmsTpi69DAdxKU80+ad1Tt87qQp9Srpumop3c97J
	Jo=; b=eJLxAodBxNsHcxsDdCCRKzATX23GRGdEtnhw9slQOc3OtZnR1u6jKO/WX
	NzDeHFfz7kLLmQ4wDHBYzgD8k9evssjn8/Dnxcrsk7Gpa+66ZPzFh/HG+gYoJF6K
	JbPGEZxFl1jVM+PrGXxTiGe+Ig/3zqI5UF9PIaww5XkVrj7Ync2CnKrF+4wmQ9ZB
	9gPMdlVCQy5m0+w+6ZqYFVsfYzAAKqC+GPkS5UFTt2Z+Bx9mrktF7ETkJqYDnTjd
	klDaO1MCpK78o2b6y/vwLhvAl34QwYl3NZQwga1H1J/Dng6mEbwIGQsLGG31j58M
	UXKXICZ/QYXOcWUkPZ5o2ODQzh1Mg==
X-ME-Sender: <xms:2ZH4W7cWu5dYlCWvSRRBErIFfVveKMKqjFEW4i1zQMMXNJnqr3KS1Q>
X-ME-Proxy: <xmx:2ZH4W_OGHeOMhrDUuw2adeifrCVzAS_s13G4E7XE6fS2iJLQ7sq0IQ>
	<xmx:2ZH4W8nnnPgyQ8wnNv3Ea2rhnkksU37_Ft-w0CVKAguDVFx6tUNkiQ>
	<xmx:2ZH4WzMMrgcU2s9Sb_gigKD_wzZbI6v4fd0WqKU4BzH2EK7LLIGxgw>
	<xmx:2ZH4W2pRhI9_G-MEZWsCiGekoDU0n6xEgqpAjN_bEd_TedpJmQlavA>
	<xmx:2ZH4WyN7uelvzwYbSDUs5vh2gn5z_H7I6M0T7Wrq7Z_SJOJnitwSLw>
	<xmx:2pH4W4vXv2t6TmQmpO8wV787X_QKeIOalcuwpqtpBFxJkBTSxwAEiQ>
Received: from localhost (flamenco.cs.columbia.edu [128.59.20.216])
	by mail.messagingengine.com (Postfix) with ESMTPA id 16256102A0;
	Fri, 23 Nov 2018 18:48:41 -0500 (EST)
Date: Fri, 23 Nov 2018 18:48:40 -0500
From: "Emilio G. Cota" <cota@braap.org>
To: Alex =?iso-8859-1?Q?Benn=E9e?= <alex.bennee@linaro.org>
Message-ID: <20181123234840.GA17229@flamenco>
References: <20181025172057.20414-1-cota@braap.org>
	<20181025172057.20414-23-cota@braap.org>
	<87mupzhg82.fsf@linaro.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <87mupzhg82.fsf@linaro.org>
User-Agent: Mutt/1.9.4 (2018-02-28)
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 2.2.x-3.x [generic]
	[fuzzy]
X-Received-From: 66.111.4.28
Subject: Re: [Qemu-devel] [RFC 22/48] cpu: hook plugin vcpu events
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Stefan Hajnoczi <stefanha@gmail.com>,
	Peter Maydell <peter.maydell@linaro.org>, qemu-devel@nongnu.org,
	Pavel Dovgalyuk <Pavel.Dovgaluk@ispras.ru>,
	=?iso-8859-1?Q?Llu=EDs?= Vilanova <vilanova@ac.upc.edu>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

On Fri, Nov 23, 2018 at 17:10:53 +0000, Alex Bennée wrote:
> Emilio G. Cota <cota@braap.org> writes:
(snip)
> > @@ -1322,12 +1323,21 @@ static void qemu_tcg_rr_wait_io_event(CPUState *cpu)
> >
> >  static void qemu_wait_io_event(CPUState *cpu)
> >  {
> > +    bool asleep = false;
> > +
> 
> slept?

Changed to slept, thanks.

> >      g_assert(cpu_mutex_locked(cpu));
> >      g_assert(!qemu_mutex_iothread_locked());
> >
> >      while (cpu_thread_is_idle(cpu)) {
> > +        if (!asleep) {
> > +            asleep = true;
> > +            qemu_plugin_vcpu_idle_cb(cpu);
> > +        }
> >          qemu_cond_wait(&cpu->halt_cond, &cpu->lock);
> >      }
> > +    if (asleep) {
> > +        qemu_plugin_vcpu_resume_cb(cpu);
> > +    }
> 
> I wonder if having two hooks is too much? What might a plugin want to do
> before we go into idle sleep?
> 
> It feels like we are exposing too much of the guts of TCG to the plugin
> here as wait_io could be for any number of internal reasons other than
> the actual emulation blocking for IO through a WFI or something. If a
> plugin really wants to track such things shouldn't it be hooking to the
> guest sleep points?
> 
> If idle sleeps really are that important maybe we could just report our
> sleep time on resume - so a single hook but passing a bit more
> information?

I don't have all the use cases for this figured out. For now I'm using
this in plugins as a way to know when a vCPU is for sure idle, which
is used in memory reclamation schemes such as RCU.

What are the "guest sleep points" you mention? Are they target-agnostic?

Thanks,

		Emilio

