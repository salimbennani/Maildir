Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 24 Nov 2018 12:37:47 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga002.fm.intel.com (fmsmga002.fm.intel.com [10.253.24.26])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id A03D1580460
	for <like.xu@linux.intel.com>; Fri, 23 Nov 2018 15:15:54 -0800 (PST)
Received: from orsmga101.jf.intel.com ([10.7.208.22])
  by fmsmga002-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 15:15:54 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3A1vwi9xCQOwReqkkFK/dxUyQJP3N1i/DPJgcQr6Af?=
 =?us-ascii?q?oPdwSPX8p8bcNUDSrc9gkEXOFd2Cra4c26yO6+jJYi8p2d65qncMcZhBBVcuqP?=
 =?us-ascii?q?49uEgeOvODElDxN/XwbiY3T4xoXV5h+GynYwAOQJ6tL1LdrWev4jEMBx7xKRR6?=
 =?us-ascii?q?JvjvGo7Vks+7y/2+94fcbglUhzexe69+IAmrpgjNq8cahpdvJLwswRXTuHtIfO?=
 =?us-ascii?q?pWxWJsJV2Nmhv3+9m98p1+/SlOovwt78FPX7n0cKQ+VrxYES8pM3sp683xtBnM?=
 =?us-ascii?q?VhWA630BWWgLiBVIAgzF7BbnXpfttybxq+Rw1DWGMcDwULs5Qiqp4bt1RxD0iS?=
 =?us-ascii?q?cHLz85/3/Risxsl6JQvRatqwViz4LIfI2ZMfxzdb7fc9wHX2pMRshfWSxfDI2/?=
 =?us-ascii?q?YYsAAPYOMvtXoYb/qVQAsAO+CAuuCu7g1zNFiGP60rMh0+k6DQHL3xYtE84SvH?=
 =?us-ascii?q?nOsdn4MroZX+CvzKnPyDXOd/1a1zj46IjJdhAhoPaMVq9xf8bL1EIiCQTFjkmK?=
 =?us-ascii?q?poDrIjiY0fgCs2+H7+V6Tu+gkHQnpBtrrTi33MssjZPJho0Mx13C6C53w541KM?=
 =?us-ascii?q?WmREJnYtOoCoZcuzyZOodsXM8vTWFltDwnxrAEoZK3YTYGxZc9yxPfb/GLaZaE?=
 =?us-ascii?q?7g75WOqPPDt1hXRoc6+liRmo60iv0Oj8W9G00FlUqipFlcHBtnQM1xzI9siHUe?=
 =?us-ascii?q?Fx/kin2TaSzQzT7ftEIU8smaraLZ4u3KIwm4INvUjfHSL6glj6gLKVe0k+5OSl?=
 =?us-ascii?q?5eTqbq/7qpKeL4N0jxvxMqUqmsyxG+Q4NQ0OUnCC+eui0b3j4FT1T6hUgf0ojK?=
 =?us-ascii?q?bZtInWKt8cpq6kBQ9azpgs6w24Azei0dQYnmcIIEhKeRKal4XpP1DOIPblDfaw?=
 =?us-ascii?q?mViskTFrx+zYMb3lGJnCMn/DkLL6cLZ77E5czgUzzdZC555ODbEBOv3zVlfrtN?=
 =?us-ascii?q?PEFh85LxC0w+H/BdV514MeWnyADrWWMaPPqlKI4uMvI++RZI4aojr9Kv4l5+Lw?=
 =?us-ascii?q?gn89g1MSYa6p3Z5EIE2+BelsdkWFfWL30JBGFWYRohF4Suvsh1ufFzlJaDG3Vq?=
 =?us-ascii?q?M44zg9T4W+EYbEQJvqmbGEwWK3E4NbYjN7DEuRGyLtfoSAR/BecS+XP4ptnyIJ?=
 =?us-ascii?q?Uf27RpY82AqynAn9zbVhM6zT4CJPro/p1tV++7jOkwov/yd/FcWX3jKxSDRdmm?=
 =?us-ascii?q?4YDxU72qb+rAQpw1OOwe5yjvpeGNF74/JPWx09c5nGwLopJcr1X1eLU9KITFeh?=
 =?us-ascii?q?CvrgSRo2Utt7i4sFZFp0M9+4hxnbmS2wDOlGxPSwGJUo//eEjDDKLMFnxiODjf?=
 =?us-ascii?q?F5gg=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ACAABBifhbhxHrdtBjGgEBAQEBAgEBA?=
 =?us-ascii?q?QEHAgEBAQGBUQUBAQEBCwGBMIJijBFfiyGCDY4DiTiBcRYYFIhaIjQJDQEDAQE?=
 =?us-ascii?q?BAQEBAgETAQEBCgsJCBsOIwyCNgUCAxoBBoJbAQEBAQIBAQIvAQ0BAQQKKQECA?=
 =?us-ascii?q?gEBAgYBAQoYCR0IAwELBUkTBYMcgXoIAQSlfIIfgnYBAQWHFgiKbYEcEQaBf4Q?=
 =?us-ascii?q?jiDOCJokThn+PHVUHAgKRIiMKiUWHOSyYBIFGgg19CIMnghsMF4NKhRSFXFSBA?=
 =?us-ascii?q?gUhE4l2gXcBAQ?=
X-IPAS-Result: =?us-ascii?q?A0ACAABBifhbhxHrdtBjGgEBAQEBAgEBAQEHAgEBAQGBUQU?=
 =?us-ascii?q?BAQEBCwGBMIJijBFfiyGCDY4DiTiBcRYYFIhaIjQJDQEDAQEBAQEBAgETAQEBC?=
 =?us-ascii?q?gsJCBsOIwyCNgUCAxoBBoJbAQEBAQIBAQIvAQ0BAQQKKQECAgEBAgYBAQoYCR0?=
 =?us-ascii?q?IAwELBUkTBYMcgXoIAQSlfIIfgnYBAQWHFgiKbYEcEQaBf4QjiDOCJokThn+PH?=
 =?us-ascii?q?VUHAgKRIiMKiUWHOSyYBIFGgg19CIMnghsMF4NKhRSFXFSBAgUhE4l2gXcBAQ?=
X-IronPort-AV: E=Sophos;i="5.56,271,1539673200"; 
   d="scan'208";a="42034683"
X-Amp-Result: UNSCANNABLE
X-Amp-File-Uploaded: False
Unscannable: 2
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 23 Nov 2018 15:15:53 -0800
Received: from localhost ([::1]:54566 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gQKfw-0005oP-PJ
	for like.xu@linux.intel.com; Fri, 23 Nov 2018 18:15:52 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:49362)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <cota@braap.org>) id 1gQKfg-0005oG-CY
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 18:15:37 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <cota@braap.org>) id 1gQKfb-0003MC-Cd
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 18:15:36 -0500
Received: from out4-smtp.messagingengine.com ([66.111.4.28]:35213)
	by eggs.gnu.org with esmtps (TLS1.0:DHE_RSA_AES_256_CBC_SHA1:32)
	(Exim 4.71) (envelope-from <cota@braap.org>) id 1gQKfb-0003Km-28
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 18:15:31 -0500
Received: from compute4.internal (compute4.nyi.internal [10.202.2.44])
	by mailout.nyi.internal (Postfix) with ESMTP id 3DA1B220CF;
	Fri, 23 Nov 2018 18:15:30 -0500 (EST)
Received: from mailfrontend2 ([10.202.2.163])
	by compute4.internal (MEProxy); Fri, 23 Nov 2018 18:15:30 -0500
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=braap.org; h=
	date:from:to:cc:subject:message-id:references:mime-version
	:content-type:content-transfer-encoding:in-reply-to; s=mesmtp;
	bh=gA8ruK+4MEnn9rCC4+8mULz7mED7949XeJjJziFBI38=; b=LuzLpoc15XjG
	5143ccUraVT8MFlFlQOpagp/af+H5DXWwkltqtgf3wFUq5Sn+hJHWVSSDg66OF1c
	kEALeJMOLtTuH2yRYt67Gw3IOWCR/XqQOM9sZFh5AJ1m3dllS+MQw/CtpZGaA7v2
	pcTeY+LP4EWXPz5n3nusU5lRWG8BZKY=
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=
	messagingengine.com; h=cc:content-transfer-encoding:content-type
	:date:from:in-reply-to:message-id:mime-version:references
	:subject:to:x-me-proxy:x-me-proxy:x-me-sender:x-me-sender
	:x-sasl-enc; s=fm1; bh=gA8ruK+4MEnn9rCC4+8mULz7mED7949XeJjJziFBI
	38=; b=pRDthyhrKwcEWX5S7fRLxnIAat9vU0GPSclMDu5PBvA0ouRrMhOPC2FtZ
	/US8GcrEirIMkDs/HNw0wj5jM7dkd0wFHyv4wsF7QJm0vi8FLe7oUggS1j4w+tcr
	UuRRUkiN2+f7Jeu7bvz4vmtbk/XXRL3g9VHaw1FPXmIwC2/KCohl4zpn5fGlYbhP
	DUvZIsxDkG/NFlnm5pCCnWjRIbHY5f/XylTKenvLwhwTN5rPwWCMXEqYtAiJS3Ty
	pNhLB41AgNXjjz+3wwWk9KeUnrkkOmbg02NjJP8LjcoNhzXiRQJcErKVkB3cAMAu
	/IE+QAPaAqq9GKGu8aWFDJStynDUQ==
X-ME-Sender: <xms:EIr4W6ju4Au5I63OYMLDEQ4vvbhgVpZU6xaundzukR067DYvvmYCBQ>
X-ME-Proxy: <xmx:EIr4Wyd_PTX8MHayGBy6R8mT_4nP6Grwm1RvRshAqIZQ4flB7aAtpw>
	<xmx:EIr4WxrD-MXyKLnl-W9CIgpoutc3CEjxbSHrg7NbM54oMWZcduwViQ>
	<xmx:EIr4W4SNMwWbax8vrpRyEFCb1p1mj3mdg8DBwCcM4fRNgE0E8BzdJg>
	<xmx:EIr4Ww5CO7q0WZHIIKAIizBbj9q-oQfPLU7QJdaRenTFlD8F7k8Phw>
	<xmx:EIr4W8NaKSSQCcnfVva8fAMKrC2_Oh8JXjg4hkc_H0hs1wZbUBq3Eg>
	<xmx:Eor4Wwjs_sb3AI0m1OuCeVT-VOYT3rJC3FnqlbJb2XE3dK4x_I25dg>
Received: from localhost (flamenco.cs.columbia.edu [128.59.20.216])
	by mail.messagingengine.com (Postfix) with ESMTPA id 9D4CF102DE;
	Fri, 23 Nov 2018 18:15:28 -0500 (EST)
Date: Fri, 23 Nov 2018 18:15:28 -0500
From: "Emilio G. Cota" <cota@braap.org>
To: Alex =?iso-8859-1?Q?Benn=E9e?= <alex.bennee@linaro.org>
Message-ID: <20181123231528.GA13782@flamenco>
References: <20181025172057.20414-1-cota@braap.org>
	<20181025172057.20414-20-cota@braap.org>
	<87r2fbhgok.fsf@linaro.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=iso-8859-1
Content-Disposition: inline
Content-Transfer-Encoding: 8bit
In-Reply-To: <87r2fbhgok.fsf@linaro.org>
User-Agent: Mutt/1.9.4 (2018-02-28)
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 2.2.x-3.x [generic]
	[fuzzy]
X-Received-From: 66.111.4.28
Subject: Re: [Qemu-devel] [RFC 19/48] translate-all: notify plugin code of
 tb_flush
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Stefan Hajnoczi <stefanha@gmail.com>,
	Peter Maydell <peter.maydell@linaro.org>, qemu-devel@nongnu.org,
	Pavel Dovgalyuk <Pavel.Dovgaluk@ispras.ru>,
	=?iso-8859-1?Q?Llu=EDs?= Vilanova <vilanova@ac.upc.edu>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

On Fri, Nov 23, 2018 at 17:00:59 +0000, Alex Bennée wrote:
> 
> Emilio G. Cota <cota@braap.org> writes:
> 
> > Signed-off-by: Emilio G. Cota <cota@braap.org>
> > ---
> >  accel/tcg/translate-all.c | 6 ++++++
> >  1 file changed, 6 insertions(+)
> >
> > diff --git a/accel/tcg/translate-all.c b/accel/tcg/translate-all.c
> > index 3423cf74db..1690e3fd5b 100644
> > --- a/accel/tcg/translate-all.c
> > +++ b/accel/tcg/translate-all.c
> > @@ -1233,6 +1233,8 @@ static gboolean tb_host_size_iter(gpointer key, gpointer value, gpointer data)
> >  /* flush all the translation blocks */
> >  void do_tb_flush(CPUState *cpu, run_on_cpu_data tb_flush_count)
> >  {
> > +    bool did_flush = false;
> > +
> >      mmap_lock();
> >      /* If it is already been done on request of another CPU,
> >       * just retry.
> > @@ -1240,6 +1242,7 @@ void do_tb_flush(CPUState *cpu, run_on_cpu_data tb_flush_count)
> >      if (tb_ctx.tb_flush_count != tb_flush_count.host_int) {
> >          goto done;
> >      }
> > +    did_flush = true;
> >
> >      if (DEBUG_TB_FLUSH_GATE) {
> >          size_t nb_tbs = tcg_nb_tbs();
> > @@ -1265,6 +1268,9 @@ void do_tb_flush(CPUState *cpu, run_on_cpu_data tb_flush_count)
> >
> >  done:
> >      mmap_unlock();
> > +    if (did_flush) {
> > +        qemu_plugin_flush_cb();
> > +    }
> 
> Are we introducing a race here?

A race, how? We're in an async safe environment here, i.e. no other
vCPU is running.

> What is the purpose of letting the plugin know a flush has occurred?

Plugins might allocate per-TB data that then they get passed each
time the TB is executed (via the *userdata pointer). For example,
in a simulator we'd allocate a per-TB struct that describes the
guest instructions, after having disassembled them at translate time.

It is therefore useful for plugins to know when all TB's have been
flushed, so that they can then free that per-TB data.

> It shouldn't have any knowledge of the details of liveliness of the
> translated code and if it still exits or not. If all it wants to do is
> look at the counts then I think we can provide a simpler less abuse-able
> way to do this.

I'm confused. What does "look at the counts" mean here?

To reiterate, plugins should have a way to know when a TB doesn't
exist any longer, so that they can reclaim memory.

Thanks,

		Emilio

