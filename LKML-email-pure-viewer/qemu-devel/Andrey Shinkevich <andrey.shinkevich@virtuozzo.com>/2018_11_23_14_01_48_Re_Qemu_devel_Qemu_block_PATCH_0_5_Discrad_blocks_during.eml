Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 23:35:39 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga003.jf.intel.com (orsmga003.jf.intel.com [10.7.209.27])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 850615803EB
	for <like.xu@linux.intel.com>; Fri, 23 Nov 2018 06:02:34 -0800 (PST)
Received: from orsmga103.jf.intel.com ([10.7.208.35])
  by orsmga003-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 06:02:34 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AE6vg2hGq9gduX2fVCDV+6Z1GYnF86YWxBRYc798d?=
 =?us-ascii?q?s5kLTJ76p8u5bnLW6fgltlLVR4KTs6sC17KG9fi4EUU7or+5+EgYd5JNUxJXwe?=
 =?us-ascii?q?43pCcHRPC/NEvgMfTxZDY7FskRHHVs/nW8LFQHUJ2mPw6arXK99yMdFQviPgRp?=
 =?us-ascii?q?OOv1BpTSj8Oq3Oyu5pHfeQpFiCa+bL9oMBm6sRjau9ULj4dlNqs/0AbCrGFSe+?=
 =?us-ascii?q?RRy2NoJFaTkAj568yt4pNt8Dletuw4+cJYXqr0Y6o3TbpDDDQ7KG81/9HktQPC?=
 =?us-ascii?q?TQSU+HQRVHgdnwdSDAjE6BH6WYrxsjf/u+Fg1iSWIdH6QLYpUjm58axlVAHnhz?=
 =?us-ascii?q?sGNz4h8WHYlMpwjL5AoBm8oxBz2pPYbJ2JOPZ7eK7WYNEUSndbXstJVyJPHJ+8?=
 =?us-ascii?q?YYUMAeoPP+lYrpXyqVQBohWjHQmhBuHhxzBVinL4waE1zf8hHBra3Aw5Bd8CrG?=
 =?us-ascii?q?jYoMn1OaoUTOu7zLPIzTLGb/5OxTr97pXHcgo/rvCMQLl+bMrRyUgpFwPGkFqQ?=
 =?us-ascii?q?t43lMC+V1u8QtGWU9exgWv+1i2E5qwB9uCOvxsctionPhYIa1E7E9SRlz4Y1Pt?=
 =?us-ascii?q?C4Vk97YcS4EJtNsCGbNop3QsQ4T250vyY6z6QLtJimdyYJ0JQq3wDTZ+CEfoSS?=
 =?us-ascii?q?/x7vSeWcLS1miH9reL+znQu+/Eq4xuHhVcS50ExGojRLn9XRrHwByRPe5tSdRv?=
 =?us-ascii?q?Z95kuh1yiA2gPP5uxBJE07jrbXJp8vz7M1lZccr1nPETTzlUrojqKaaFko9+21?=
 =?us-ascii?q?5Ov5bLjpuJmRPJJuhA7kKKQhgMm/DPw4MgcQW2ib/vyx1Lni/U3iXLVKlec6kq?=
 =?us-ascii?q?bfsJDHP8gbobS5AwBN3oYi7RawESum3cwGkXUbL19JYg+Lg5XqNl3UPvz1A/ey?=
 =?us-ascii?q?j06xnDpp3/zGO6fuApTJLnjNirfherN95lZFyAUtyNBf+otYBawfL/LtREDxsM?=
 =?us-ascii?q?XUAQQ+MwypxeboFMty1pgZVWKLA6+ZM73dvUWH5+IyO+SMYI4VuDDgK/kq/fLu?=
 =?us-ascii?q?jHk5mUMDcqmtx5cYdHe4HvF9LkWfZnrshNgBEWEXvgYkS+zqklKCXSZJZ3muR6?=
 =?us-ascii?q?I8+i07CIW+AIfHR4Ctg6KO0D20H51LfW1GDlGMEXH1d4SLQfsMaSSSItN/nTwA?=
 =?us-ascii?q?T7SuV4gh1RT9/DL80Kdte+rI5jUD59Wk0Nlu+/aVkxY0+jppScOH3CaIRmBwm2?=
 =?us-ascii?q?oOADguwKF4p1c601qGzO10juJVEY9u4ehUWFI/PJ/Y0+soEt33R0fNc8mETBO8?=
 =?us-ascii?q?T8y7DCotZtQ2xdAIfgB6Adr1lQ3J3SehH+oIkaeWDoc/6KPW0ivNIJNFxmrLzu?=
 =?us-ascii?q?EClVQjWsIHYXWlnKN67wH7HYPFk0yF0a2tcPJP8jTK8TKqy2aUsVAQaw5xV6bI?=
 =?us-ascii?q?Q3EUZgOCpNL1/E7TCaSuCLIkPxVAws6qNKpQdsDun0dBAvzkPYKNMCqKh26sCE?=
 =?us-ascii?q?PQlfu3Z43wdjBYhX2FBQ=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0DPAQDrB/hbhxHrdtBjg0hQgVwEMgqHN?=
 =?us-ascii?q?gOFLYpXSoFgCCWXT4FdFQEYFIRAhBgiOBIBAwEBAQEBAQIBEwEBAQoLCQgpIwy?=
 =?us-ascii?q?CNgUCAxoBBoJcAQIDAQI9AQEECiIHAQIDAQIGAQEBAQgOCiYIAwEuJQIEGIMcg?=
 =?us-ascii?q?gIBAgEBnAQCigeCH4J2AQEFgkOEUQiMCYFXP4E4DIJfhEYBN4VbiROCAIolikw?=
 =?us-ascii?q?HAoIcBI8JHoFZhQuDI4cBlXCCGQIEAgQFAg0BAQWBXYF2cIM8glCDOIpScoEHI?=
 =?us-ascii?q?YkzVlgBgR4BAQ?=
X-IPAS-Result: =?us-ascii?q?A0DPAQDrB/hbhxHrdtBjg0hQgVwEMgqHNgOFLYpXSoFgCCW?=
 =?us-ascii?q?XT4FdFQEYFIRAhBgiOBIBAwEBAQEBAQIBEwEBAQoLCQgpIwyCNgUCAxoBBoJcA?=
 =?us-ascii?q?QIDAQI9AQEECiIHAQIDAQIGAQEBAQgOCiYIAwEuJQIEGIMcggIBAgEBnAQCige?=
 =?us-ascii?q?CH4J2AQEFgkOEUQiMCYFXP4E4DIJfhEYBN4VbiROCAIolikwHAoIcBI8JHoFZh?=
 =?us-ascii?q?QuDI4cBlXCCGQIEAgQFAg0BAQWBXYF2cIM8glCDOIpScoEHIYkzVlgBgR4BAQ?=
X-IronPort-AV: E=Sophos;i="5.56,270,1539673200"; 
   d="scan'208";a="53459990"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 23 Nov 2018 06:02:33 -0800
Received: from localhost ([::1]:52511 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gQC2T-0001Fy-41
	for like.xu@linux.intel.com; Fri, 23 Nov 2018 09:02:33 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:58407)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <andrey.shinkevich@virtuozzo.com>) id 1gQC23-0001EX-ON
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 09:02:15 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <andrey.shinkevich@virtuozzo.com>) id 1gQC20-0002Ix-G7
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 09:02:07 -0500
Received: from mail-eopbgr60135.outbound.protection.outlook.com
	([40.107.6.135]:49632
	helo=EUR04-DB3-obe.outbound.protection.outlook.com)
	by eggs.gnu.org with esmtps (TLS1.0:RSA_AES_256_CBC_SHA1:32)
	(Exim 4.71) (envelope-from <andrey.shinkevich@virtuozzo.com>)
	id 1gQC1n-0001zw-T1; Fri, 23 Nov 2018 09:01:52 -0500
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=virtuozzo.com;
	s=selector1;
	h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
	bh=zdVinpGHMwgIPGddi8qd0imsU600b90A7tpcsY/JeF8=;
	b=Auj599DIANhft+DnhFE1aW9YGwYTKF8lcnyKZy9g+sK/YQR6eNEz3h9d96X/ABKtsYfC8J33bwc7Le3+kwJwjihUOSBiukr7Im8icxhknNQLs4Cpj5+S9cHijUjsNhl1gr9S/LqdFgylKOLt+xeEU6V78ir/akIbsmko3fPKTeQ=
Received: from AM6PR08MB3493.eurprd08.prod.outlook.com (20.177.114.158) by
	AM6PR08MB3094.eurprd08.prod.outlook.com (52.135.163.155) with Microsoft
	SMTP
	Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
	15.20.1339.28; Fri, 23 Nov 2018 14:01:48 +0000
Received: from AM6PR08MB3493.eurprd08.prod.outlook.com
	([fe80::b063:8e1b:e720:de3e]) by
	AM6PR08MB3493.eurprd08.prod.outlook.com
	([fe80::b063:8e1b:e720:de3e%3]) with mapi id 15.20.1339.030;
	Fri, 23 Nov 2018 14:01:48 +0000
From: Andrey Shinkevich <andrey.shinkevich@virtuozzo.com>
To: Peter Krempa <pkrempa@redhat.com>
Thread-Topic: [Qemu-block] [PATCH 0/5] Discrad blocks during block-stream
	operation
Thread-Index: AQHUgpPv7syGfIh6pUCQxbYyrdjiZKVc+9+AgABpHIA=
Date: Fri, 23 Nov 2018 14:01:48 +0000
Message-ID: <916286cc-2067-6227-b08f-d1e227eb230e@virtuozzo.com>
References: <1542912487-279165-1-git-send-email-andrey.shinkevich@virtuozzo.com>
	<20181123074533.GC7812@andariel.pipo.sk>
In-Reply-To: <20181123074533.GC7812@andariel.pipo.sk>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-clientproxiedby: HE1PR0502CA0021.eurprd05.prod.outlook.com
	(2603:10a6:3:e3::31) To AM6PR08MB3493.eurprd08.prod.outlook.com
	(2603:10a6:20b:4a::30)
authentication-results: spf=none (sender IP is )
	smtp.mailfrom=andrey.shinkevich@virtuozzo.com; 
x-ms-exchange-messagesentrepresentingtype: 1
x-originating-ip: [185.231.240.5]
x-ms-publictraffictype: Email
x-microsoft-exchange-diagnostics: 1; AM6PR08MB3094;
	20:G8chEGdK2eph4YzSek+Tq5uiJtFRIHScswxQFbgEytTFp3smUNICgG1rXFiXQDgblLz3XvwNuyD6TT+5Lh0IA5rgX/+ELZb+xNCacojTrHy92PrNV2+JqQ128ehb80sspsZPQXb5nLXoPAEdGjl4/Cau4v3i2zGHpL3ayTSPC8M=
x-ms-office365-filtering-correlation-id: b2016f7e-28fa-43ea-9ca6-08d6514c35e7
x-microsoft-antispam: BCL:0; PCL:0;
	RULEID:(2390098)(7020095)(4652040)(8989299)(4534185)(4627221)(201703031133081)(201702281549075)(8990200)(5600074)(711020)(2017052603328)(7153060)(7193020);
	SRVR:AM6PR08MB3094; 
x-ms-traffictypediagnostic: AM6PR08MB3094:
x-microsoft-antispam-prvs: <AM6PR08MB3094456F34E79090E9D71FC1F4D40@AM6PR08MB3094.eurprd08.prod.outlook.com>
x-ms-exchange-senderadcheck: 1
x-exchange-antispam-report-cfa-test: BCL:0; PCL:0;
	RULEID:(6040522)(2401047)(5005006)(8121501046)(3231442)(944501410)(52105112)(3002001)(93006095)(93001095)(10201501046)(148016)(149066)(150057)(6041310)(20161123560045)(20161123558120)(20161123562045)(201703131423095)(201702281528075)(20161123555045)(201703061421075)(201703061406153)(20161123564045)(201708071742011)(7699051)(76991095);
	SRVR:AM6PR08MB3094; BCL:0; PCL:0; RULEID:; SRVR:AM6PR08MB3094; 
x-forefront-prvs: 086597191B
x-forefront-antispam-report: SFV:NSPM;
	SFS:(10019020)(376002)(136003)(366004)(346002)(396003)(39850400004)(53754006)(199004)(189003)(97736004)(5660300001)(345774005)(229853002)(6436002)(6486002)(6916009)(305945005)(7736002)(6246003)(53936002)(6512007)(478600001)(413944005)(2900100001)(4326008)(106356001)(25786009)(105586002)(36756003)(31686004)(66066001)(14454004)(6116002)(3846002)(316002)(486006)(44832011)(52116002)(446003)(53546011)(11346002)(2616005)(476003)(8936002)(68736007)(99286004)(81156014)(54906003)(8676002)(81166006)(256004)(102836004)(86362001)(76176011)(6506007)(31696002)(71190400001)(71200400001)(386003)(186003)(14444005)(2906002)(26005);
	DIR:OUT; SFP:1102; SCL:1; SRVR:AM6PR08MB3094;
	H:AM6PR08MB3493.eurprd08.prod.outlook.com; FPR:; SPF:None;
	LANG:en; PTR:InfoNoRecords; A:1; MX:1; 
x-microsoft-antispam-message-info: ftR7uypRnvte2xblx2XVZHM9hjfYS9XPhio7GTsrUflsx9hZDI3MljWKgMXI9Px99PHFBaFStjf6U+Y/HpfP56t+y3QZA3aUgROxwjUVIap/8dKnPZG61fwjw0SaUOLKxsaSRA+m8tsgALOWZH8OkNGU9mj1v05FxFz0G46dtWyIj6/b2/1Y4iAwpTk63fpDy/oq2QA2kZizCWKUiWC55lN9UeqfOCHuNQVm+1ULEIAYZewP6Qp2elBgcCr4XxezbK02TX2jhEydRn5sIQvPkk0QP0B+JPF09rW/PppNUMG9jUHfVeoZZUIOL0yvePcAd38pJq8mmwuhMV9K0f+9OAch4jPr/NN8EiNiesiE5i8=
spamdiagnosticoutput: 1:99
spamdiagnosticmetadata: NSPM
Content-Type: text/plain; charset="Windows-1252"
Content-ID: <B4C3DCA3D3FDD44D937965495281E6CD@eurprd08.prod.outlook.com>
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-OriginatorOrg: virtuozzo.com
X-MS-Exchange-CrossTenant-Network-Message-Id: b2016f7e-28fa-43ea-9ca6-08d6514c35e7
X-MS-Exchange-CrossTenant-originalarrivaltime: 23 Nov 2018 14:01:48.6052 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 0bc7f26d-0264-416e-a6fc-8352af79c58f
X-MS-Exchange-Transport-CrossTenantHeadersStamped: AM6PR08MB3094
X-detected-operating-system: by eggs.gnu.org: Windows 7 or 8 [fuzzy]
X-Received-From: 40.107.6.135
Subject: Re: [Qemu-devel] [Qemu-block] [PATCH 0/5] Discrad blocks during
 block-stream operation
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: "kwolf@redhat.com" <kwolf@redhat.com>,
	Vladimir Sementsov-Ogievskiy <vsementsov@virtuozzo.com>,
	Denis Lunev <den@virtuozzo.com>,
	"qemu-block@nongnu.org" <qemu-block@nongnu.org>,
	"jcody@redhat.com" <jcody@redhat.com>,
	"qemu-devel@nongnu.org" <qemu-devel@nongnu.org>,
	"armbru@redhat.com" <armbru@redhat.com>,
	"mreitz@redhat.com" <mreitz@redhat.com>,
	"dgilbert@redhat.com" <dgilbert@redhat.com>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

Dear Peter,

Thank you for your response.

The 'discard' option is useful when pulling a huge file. That will save=20
a disk

space significantly.

The 'commit' operation would be useful as well but it is harder to implemen=
t

due to concurrent writes of a guest. Which command to use, 'pull' or=20
'commit',

depends on an image to merge that can incur the performance issue.

Currently, the 'discard' option works for streaming into the active=20
layer only.

There is a serious trouble with the child's WRITE permission while streamin=
g

into an inactive layer. Once resolved, it will work right away with the=20
current

version. So, the existent child permission mechanism is a headache we kindl=
y

ask all of you to advise how to cope with it. Please refer to the=20
descriptions and

comments in the patch files for details.

Kindly,

Andrey Shinkevich



On 23.11.2018 10:45, Peter Krempa wrote:
> On Thu, Nov 22, 2018 at 21:48:02 +0300, Andrey Shinkevich wrote:
>> Hello everyone!
>>
>> The given feature discards blocks with copy-on-read operation while the
>> streaming process runs. Adding the 'discard' argument to the QMP block-s=
tream
>> command allows dropping a block in the backing chain after it has been c=
opied
>> to the active layer. That will elude the block duplication in the interm=
ediate
>> backing file. It saves the disk space while external snapshots are being
>> merged.
> So you specifically want to merge the snapshot by pulling rather than
> commiting? Do you have any specific reasons for that? I'm curious
> because I plan to finally finish external snapshots in libvirt.
>
> Allowing to pull into intermediate layers will be (or is?) very welcome
> by libvirt since I plan to do external snapshot deletion/merging and
> that will be greatly simplified by pulling.
>
> On the other hand libvirt will not be able to always use 'discard' as
> libvirt's API allows creating alternate histories for a VM and in such
> case when merging a snapshot at a branching point we'll need to pull it
> into multiple images. The 'discard' optimization can then be used only
> with the last branch.
>
> Libvirt's reasons for using 'block-stream' are mostly as it corresponds
> to the operations necessary for not messing up the relationship between
> the snapshot and which files on disk belong to it.


