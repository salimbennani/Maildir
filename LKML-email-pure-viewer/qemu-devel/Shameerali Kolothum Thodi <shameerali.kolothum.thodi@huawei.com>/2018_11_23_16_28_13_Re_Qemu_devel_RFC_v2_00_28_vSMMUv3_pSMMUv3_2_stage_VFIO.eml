Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 24 Nov 2018 12:35:55 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga006.fm.intel.com (fmsmga006.fm.intel.com [10.253.24.20])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 2B6AE580460
	for <like.xu@linux.intel.com>; Fri, 23 Nov 2018 08:29:15 -0800 (PST)
Received: from fmsmga105.fm.intel.com ([10.1.193.10])
  by fmsmga006-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 08:29:14 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3A8/BYGRM0FzjyBVziwKYl6mtUPXoX/o7sNwtQ0KIM?=
 =?us-ascii?q?zox0K///rsbcNUDSrc9gkEXOFd2Cra4c26yO6+jJYi8p2d65qncMcZhBBVcuqP?=
 =?us-ascii?q?49uEgeOvODElDxN/XwbiY3T4xoXV5h+GynYwAOQJ6tL1LdrWev4jEMBx7xKRR6?=
 =?us-ascii?q?JvjvGo7Vks+7y/2+94fcbglUhzexe69+IAmrpgjNq8cahpdvJLwswRXTuHtIfO?=
 =?us-ascii?q?pWxWJsJV2Nmhv3+9m98p1+/SlOovwt78FPX7n0cKQ+VrxYES8pM3sp683xtBnM?=
 =?us-ascii?q?VhWA630BWWgLiBVIAgzF7BbnXpfttybxq+Rw1DWGMcDwULs5Qiqp4bt1RxD0iS?=
 =?us-ascii?q?cHLz85/3/Risxsl6JQvRatqwViz4LIfI2ZMfxzdb7fc9wHX2pMRsZfWTJdAo2y?=
 =?us-ascii?q?bIUPAegOPedEoIfyqFQAsAO+CAuuCu7g1zNFiGP60rMh0+k6DQHGxQgtE84SvH?=
 =?us-ascii?q?jIstn4MroZX+CvzKnPyDXOd+5Y2Tfn54jNbB8uv+uMUqh0ccrQ1EIhEgTFjlGX?=
 =?us-ascii?q?qYz5PzOVy+ENuHWF4epgUuKglm8noBx2rzi0xscjkIzJiZwLxVDe7yp5xIc1Kc?=
 =?us-ascii?q?e7SE58Zd6kF4dQtyGHN4tzWM8iX2FouCEnxb0HopO7fDUKx44pxhHBavyLaZSH?=
 =?us-ascii?q?4hXmVOuIJzpzmXxreLW6hxmo8EigzPXxVs230FZPqipJiN7MtmoC1xDL5ciHS+?=
 =?us-ascii?q?d9/ke82TmUzQzc9uZEIUUymKHGKJAh2qY9moQPvUnABCP6hVj6gayMekk69OWl?=
 =?us-ascii?q?6/7rbqjkq5OEKoN4lhvyProylsChG+g0LBYCUmqB9eii2rDu/1X1TKhLg/AyiK?=
 =?us-ascii?q?XVrpDXKMsBqqKkGQNY0Icu5hCiBDm8ytsYh2MILFdddRKHkYfpP1bOLej8Dfe+?=
 =?us-ascii?q?mFSsjCxry+rJPr3nH5XBNH/DkK3ufbpl6k5czhQ8zcxH6p5KFr0MI+j/VlLsuN?=
 =?us-ascii?q?HbFBM1LQK5zub9BNlg1I4SQWePDbWYMKPWv1+I/OUvI+yUaY8Mpjn9LuUl6+fz?=
 =?us-ascii?q?gnAnh18SY62p0YIMZ3C/A/RmJVmWbmT3gtsGFWcKvwk+Q/LwhFyNTD5ef3KyX6?=
 =?us-ascii?q?M65jEmB4OqF4bDRoaxgLOf2Ce3BIFZZmdDCl2XF3focIOEW/gKaCKPOMNhlSYE?=
 =?us-ascii?q?Vbe5R487yR6urBP6y6ZgLufM/i0YtJHj28Zv6+zciBE/7jh0D8Wb02GQQGB4hG?=
 =?us-ascii?q?IIRzkq3K9hpUxx0EuM0a99g68QKNpI+vkcUhsmLYWOiKt+CsvuQUTHedGGTkvg?=
 =?us-ascii?q?Rc+pRjQ4T9Y0ytlJZF5hGtKklVfa0i+3RrMYibGPV6Ey6b/Win34JsJhzCTf2a?=
 =?us-ascii?q?w8ylUrXMZLcHern7Ny7BT7AYnPnEOE0aGwevMHwSTP+WyfmHeIp1xSSwVqUK/I?=
 =?us-ascii?q?DkwYM2bMrN+xz17NQqXmXbk9MwAHwNONJ7FicNDljVxaAvzkPYKaKyi8gWa7Qx?=
 =?us-ascii?q?+Vyb6WKpLwfE0S2SzcDA4PlAVZtSKLLwk1QC68rG/ESiR0EnrgZkrt9a91r3bt?=
 =?us-ascii?q?Cgd+1gyPcght2qS4/jYTgvqTTe5V2agL8m91sjhxAROx0szbD/KGoAxuergaZs?=
 =?us-ascii?q?kythMPn3vUshE4N4alB6ZlgFEYbkJwpUykn0FuB4Bd1MEwqVssywx9L7/e10lO?=
 =?us-ascii?q?IXfQl4j9JrDNbGz77Ryib6r+3lDY2cyRvKAV575w/03uoAyzUE8r4nlq191913?=
 =?us-ascii?q?qa74/NSg0IXsSifFww8k1Bp7jfbyQn7ofVnV5rNa6osiLHk+4pA+ckgkK7f95a?=
 =?us-ascii?q?Pa6eHQvzVc4dA8+yKPEv3USpaR4FFOBP/bE5PoWtcP7Qi/3jB/ppgD/z1TcP24?=
 =?us-ascii?q?t6yE/ZsnMkEuM=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AvAABKKvhbhxHrdtBjHAEBAQQBAQcEA?=
 =?us-ascii?q?QGBUQcBAQsBgTCBOYEpCowHX4shKYFkeogRgVmMV4FzFBgLCYRAAoQYIjQJDQE?=
 =?us-ascii?q?DAQEBAQEBAgETAQEBCgsJCBsOIwyCNgUCAxoBBoJbAQEBAQIBAQIkEwwKJAUDA?=
 =?us-ascii?q?gEBAgMDAQEBAQgRBAEBCxQIAQcDAR0RFAkIAgQBEgUDgxkBgWkDDQgBAwEKqAE?=
 =?us-ascii?q?zhAIBKgGDRg2CGYIuiVt6gRyBEAFGgTdgNYJWLBkCAoFfJoMPgiYCiR+BcoQIh?=
 =?us-ascii?q?h2KHi4HAoMQg2yHCINDgVmFC4okiW2DVoEKhjGDMoFGgg1NI4M8CRaCCBeDSoU?=
 =?us-ascii?q?UQXyDSwE1QTEBAQ9zAw6KHFiBHwEB?=
X-IPAS-Result: =?us-ascii?q?A0AvAABKKvhbhxHrdtBjHAEBAQQBAQcEAQGBUQcBAQsBgTC?=
 =?us-ascii?q?BOYEpCowHX4shKYFkeogRgVmMV4FzFBgLCYRAAoQYIjQJDQEDAQEBAQEBAgETA?=
 =?us-ascii?q?QEBCgsJCBsOIwyCNgUCAxoBBoJbAQEBAQIBAQIkEwwKJAUDAgEBAgMDAQEBAQg?=
 =?us-ascii?q?RBAEBCxQIAQcDAR0RFAkIAgQBEgUDgxkBgWkDDQgBAwEKqAEzhAIBKgGDRg2CG?=
 =?us-ascii?q?YIuiVt6gRyBEAFGgTdgNYJWLBkCAoFfJoMPgiYCiR+BcoQIhh2KHi4HAoMQg2y?=
 =?us-ascii?q?HCINDgVmFC4okiW2DVoEKhjGDMoFGgg1NI4M8CRaCCBeDSoUUQXyDSwE1QTEBA?=
 =?us-ascii?q?Q9zAw6KHFiBHwEB?=
X-IronPort-AV: E=Sophos;i="5.56,270,1539673200"; 
   d="scan'208";a="139334955"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 23 Nov 2018 08:29:13 -0800
Received: from localhost ([::1]:53326 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gQEKO-0002iQ-V9
	for like.xu@linux.intel.com; Fri, 23 Nov 2018 11:29:12 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:52452)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <shameerali.kolothum.thodi@huawei.com>)
	id 1gQEJz-0002fd-Fo
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 11:28:50 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <shameerali.kolothum.thodi@huawei.com>)
	id 1gQEJv-0006Hk-He
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 11:28:45 -0500
Received: from lhrrgout.huawei.com ([185.176.76.210]:28190 helo=huawei.com)
	by eggs.gnu.org with esmtps (TLS1.0:DHE_RSA_AES_256_CBC_SHA1:32)
	(Exim 4.71) (envelope-from <shameerali.kolothum.thodi@huawei.com>)
	id 1gQEJp-0005e3-CO; Fri, 23 Nov 2018 11:28:37 -0500
Received: from lhreml704-cah.china.huawei.com (unknown [172.18.7.108])
	by Forcepoint Email with ESMTP id A1A77C351B3FC;
	Fri, 23 Nov 2018 16:28:19 +0000 (GMT)
Received: from FRAEMA701-CHM.china.huawei.com (10.206.14.50) by
	lhreml704-cah.china.huawei.com (10.201.108.45) with Microsoft SMTP
	Server (TLS) id 14.3.408.0; Fri, 23 Nov 2018 16:28:21 +0000
Received: from FRAEML521-MBX.china.huawei.com ([169.254.1.76]) by
	FRAEMA701-CHM.china.huawei.com ([169.254.1.146]) with mapi id
	14.03.0415.000; Fri, 23 Nov 2018 17:28:14 +0100
From: Shameerali Kolothum Thodi <shameerali.kolothum.thodi@huawei.com>
To: Eric Auger <eric.auger@redhat.com>, "eric.auger.pro@gmail.com"
	<eric.auger.pro@gmail.com>,
	"qemu-devel@nongnu.org" <qemu-devel@nongnu.org>, 
	"qemu-arm@nongnu.org" <qemu-arm@nongnu.org>, "peter.maydell@linaro.org"
	<peter.maydell@linaro.org>
Thread-Topic: [Qemu-devel] [RFC v2 00/28] vSMMUv3/pSMMUv3 2 stage VFIO
	integration
Thread-Index: AQHUUYPza2cioTCQCU2bQm3noOvi76Vd5o2g
Date: Fri, 23 Nov 2018 16:28:13 +0000
Message-ID: <5FC3163CFD30C246ABAA99954A238FA8387E9A0C@FRAEML521-MBX.china.huawei.com>
References: <20180921081819.9203-1-eric.auger@redhat.com>
In-Reply-To: <20180921081819.9203-1-eric.auger@redhat.com>
Accept-Language: en-GB, en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-originating-ip: [10.202.227.237]
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-CFilter-Loop: Reflected
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 3.x [fuzzy]
X-Received-From: 185.176.76.210
Subject: Re: [Qemu-devel] [RFC v2 00/28] vSMMUv3/pSMMUv3 2 stage VFIO
 integration
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: "yi.l.liu@intel.com" <yi.l.liu@intel.com>,
	"cdall@kernel.org" <cdall@kernel.org>, "mst@redhat.com" <mst@redhat.com>,
	"jean-philippe.brucker@arm.com" <jean-philippe.brucker@arm.com>,
	Linuxarm <linuxarm@huawei.com>, "peterx@redhat.com" <peterx@redhat.com>,
	"alex.williamson@redhat.com" <alex.williamson@redhat.com>,
	"xuwei \(O\)" <xuwei5@huawei.com>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>



> -----Original Message-----
> From: Qemu-devel [mailto:qemu-devel-
> bounces+shameerali.kolothum.thodi=3Dhuawei.com@nongnu.org] On Behalf Of
> Eric Auger
> Sent: 21 September 2018 09:18
> To: eric.auger.pro@gmail.com; eric.auger@redhat.com; qemu-
> devel@nongnu.org; qemu-arm@nongnu.org; peter.maydell@linaro.org
> Cc: yi.l.liu@intel.com; cdall@kernel.org; mst@redhat.com; jean-
> philippe.brucker@arm.com; peterx@redhat.com; alex.williamson@redhat.com
> Subject: [Qemu-devel] [RFC v2 00/28] vSMMUv3/pSMMUv3 2 stage VFIO
> integration
>=20

[...]

> This series can be found at:
> https://github.com/eauger/qemu/tree/v3.0.0_2stage-rfc-v2
>=20
> Testing:
> - For testing use my kernel branch
>   https://github.com/eauger/linux/tree/v4.19-rc4-2stage-rfc-v2 [1]
> - Tested on Qualcomm HW with 1/2 assigned e1000e NICs. Hotplug
>   was also tested OK.
> - Known limitation:
>   - currently sending an NH_ASID command instead of NH_VA
>     upon guest NH_VA. This may cause important perf downgrade.
>     Propagating NH_VA does not work at the moment.

Hi Eric,

I had a  go with this RFC on one of our platform and noted that when the Gu=
est=20
boots with ACPI , the ping doesn't work with the assigned ixgbevf NIC thoug=
h=20
the network device gets detected and added to the iommu group.=20

It's all fine when I boot the Guest with DT. Have you tested this with ACPI=
 yet or
am I missing anything obvious here?

Please let me know.

Thanks,
Shameer
=20
> References:
> - [1] [RFC v2 00/20] SMMUv3 Nested Stage Setup
>   (https://lkml.org/lkml/2018/9/18/1087)
>   The User API still is unstable and under discussion.
>=20
> History:
> v1 -> v2:
> - Fixed dual assignment (asid now correctly propagated on TLB invalidatio=
ns)
> - Integrated fault reporting
>=20
> Next Steps:
> - Mature the user API with people involved in SVA work (KVM forum may be =
a
>   good opportunity to meet)
> - Submit the IOMMU cfg notifier changes and some VFIO changes separately,
> to
>   progress independently on the kernel dependency
>=20
> Eric Auger (28):
>   hw/arm/smmu-common: Fix the name of the iommu memory regions
>   hw/arm/smmuv3: fix eventq recording and IRQ triggerring
>   update-linux-headers: Import iommu.h
>   linux-headers: Partial header update
>   memory: add IOMMU_ATTR_VFIO_NESTED IOMMU memory region attribute
>   hw/arm/smmuv3: Implement get_attr API to report
> IOMMU_ATTR_VFIO_NESTED
>   hw/vfio/common: Refactor container initialization
>   hw/vfio/common: Force nested if iommu requires it
>   memory: Introduce IOMMUIOLTBNotifier
>   memory: rename memory_region notify_iommu, notify_one
>   memory: Add IOMMUConfigNotifier
>   memory: Add arch_id in IOTLBEntry
>   hw/arm/smmuv3: Store s1ctrptr in translation config data
>   hw/arm/smmuv3: Implement dummy replay
>   hw/arm/smmuv3: Notify on config changes
>   hw/arm/smmuv3: Fill the IOTLBEntry arch_id on NH_VA invalidation
>   hw/vfio/common: Introduce vfio_alloc_guest_iommu helper
>   hw/vfio/common: Introduce vfio_dma_(un)map_ram_section helpers
>   hw/vfio/common: Register specific nested mode notifiers and
>     memory_listener
>   hw/vfio/common: Register MAP notifier for MSI binding
>   target/arm/kvm: Notifies IOMMU on MSI stage 1 binding
>   vfio/pci: Always set up MSI route before enabling vectors
>   hw/arm/smmuv3: Remove warning about unsupported MAP notifiers
>   memory: Introduce IOMMU_NOTIFIER_INIT_CFG IOMMU Config Notifier
>   memory: Introduce IOMMU Memory Region inject_faults API
>   hw/vfio/common: Handle fault_handler
>   hw/arm/smmuv3: Init fault handling
>   hw/arm/smmuv3: Implement fault injection
>=20
>  exec.c                          |  12 +-
>  hw/arm/smmu-common.c            |  12 +-
>  hw/arm/smmuv3-internal.h        |  26 +-
>  hw/arm/smmuv3.c                 | 189 +++++++--
>  hw/i386/intel_iommu.c           |  16 +-
>  hw/misc/tz-mpc.c                |   8 +-
>  hw/ppc/spapr_iommu.c            |   2 +-
>  hw/s390x/s390-pci-inst.c        |   4 +-
>  hw/vfio/common.c                | 666 ++++++++++++++++++++++++--------
>  hw/vfio/pci.c                   |   1 +
>  hw/vfio/trace-events            |   4 +-
>  hw/virtio/vhost.c               |  12 +-
>  include/exec/memory.h           | 140 +++++--
>  include/hw/arm/smmu-common.h    |   1 +
>  include/hw/vfio/vfio-common.h   |   1 +
>  linux-headers/linux/iommu.h     | 237 ++++++++++++
>  linux-headers/linux/vfio.h      |  48 +++
>  memory.c                        |  66 +++-
>  scripts/update-linux-headers.sh |   2 +-
>  target/arm/kvm.c                |  46 +--
>  20 files changed, 1206 insertions(+), 287 deletions(-)
>  create mode 100644 linux-headers/linux/iommu.h
>=20
> --
> 2.17.1
>=20


