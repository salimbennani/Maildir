Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 26 Nov 2018 08:51:48 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga006.fm.intel.com (fmsmga006.fm.intel.com [10.253.24.20])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 7E8EC5803C2
	for <like.xu@linux.intel.com>; Sun, 25 Nov 2018 12:44:23 -0800 (PST)
Received: from orsmga103.jf.intel.com ([10.7.208.35])
  by fmsmga006-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 25 Nov 2018 12:44:23 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3A4k6WBBMwSKNlQHmxN5El6mtUPXoX/o7sNwtQ0KIM?=
 =?us-ascii?q?zox0K/z7p8bcNUDSrc9gkEXOFd2Cra4c26yO6+jJYi8p2d65qncMcZhBBVcuqP?=
 =?us-ascii?q?49uEgeOvODElDxN/XwbiY3T4xoXV5h+GynYwAOQJ6tL1LdrWev4jEMBx7xKRR6?=
 =?us-ascii?q?JvjvGo7Vks+7y/2+94fcbglUhzexe69+IAmrpgjNq8cahpdvJLwswRXTuHtIfO?=
 =?us-ascii?q?pWxWJsJV2Nmhv3+9m98p1+/SlOovwt78FPX7n0cKQ+VrxYES8pM3sp683xtBnM?=
 =?us-ascii?q?VhWA630BWWgLiBVIAgzF7BbnXpfttybxq+Rw1DWGMcDwULs5Qiqp4bt1RxD0iS?=
 =?us-ascii?q?cHLz85/3/Risxsl6JQvRatqwViz4LIfI2ZMfxzdb7fc9wHX2pMRsleVyJDDY28?=
 =?us-ascii?q?YYUBDPQPMvpFoYnlpVYArxSzCRSiCe/z1DBInWT73bEm3+k7DQ3KwBAsEtAIvX?=
 =?us-ascii?q?/JrNv1LqASUeWtwafS0zrDc+1Z2S3g44bPaB8goeyDUqx0ccrV1EIiEBvFgUuM?=
 =?us-ascii?q?qYP7JTOZzOENvHKb7uV9S+2vj2onphp1ojiuwMcjkJPJhoUPxlDD7yV5z584KN?=
 =?us-ascii?q?ulQ0B4ed6pCIVcuz2ZOodsX88uXmJltDwkxrAIuZO3ZjUGxZY/yxLBavGLb4qF?=
 =?us-ascii?q?7xftVOuSOjh0mHdodb28ihuz/kWtz/PwWtWx3VtPoCdInNjBu3YQ3BLJ8MeHUO?=
 =?us-ascii?q?Fy/kK51DaPyQ/T7uZELFgwlaraMJ4h3qUwmoAcsUTFAy/6gkL2jLWZdkk8++io?=
 =?us-ascii?q?7froYqn+q5OCK4N5iRvyPrkzlsG8G+g0LAYDUmiB9eih1rDv5Uj5T69Ljv0ynK?=
 =?us-ascii?q?nZqpfaJcEDq66gHQBV15sj5w+iADi4ztQXg30HIEtedxKAkojpPU3BL+7jDfu4?=
 =?us-ascii?q?h1SskTRryO7cMrzuH5XANnzDkLbnfbZg5E9Q0gszzdZD551KDrENOu78Wkj0tN?=
 =?us-ascii?q?HDCB85NAq0w+nhCNVgzI8eXniPAqCBPKPIrVCI/v4vI/WLZIINvDb9Kvsl6OD0?=
 =?us-ascii?q?gX42hF8QZq2p3ZoRaHClEfVqOUSZYXzwgtgfFWcGpBYxTOvviA7KbDhIenznX7?=
 =?us-ascii?q?4g/ippT8WiDJzfXcarh7qO2jr9GYdZIWVPC1SJGHGvcJ2YWvAKc2WLL8p81zAJ?=
 =?us-ascii?q?S7WlGLInzgyk4Qrzyr57KbjN9ygF8J7uytVxovfejAw/7iBcCcOb3GeQCWZukT?=
 =?us-ascii?q?QTWjU00atj9FF70UqJyqNigvZVRuBUstxESAtyFZnSwelzDda6DgHbd8eETH68?=
 =?us-ascii?q?T9mmCC13RdU0lYwgeUF4Tu2vkh3Zlw+jErMYk7jDUIQ57q/GmX34Nspwz3Lu0K?=
 =?us-ascii?q?gnhkMhBMxVOjv11eZE6wHPCtuRwA2inKGwePFZhXaV+Q=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AkAADOCPtbhxHrdtBhHgEGBwaBUQkLA?=
 =?us-ascii?q?YEwKoI4g3mId4sfgg2XPIFxFhgUiFoiNAkNAQMBAQEBAQECARMBAQEKCwkIGw4?=
 =?us-ascii?q?jDII2BQIDGgEGglwBAgMBAiAdAQEECikBAgMBAgYBAQoLAwoCAiIEAgIDAR4SA?=
 =?us-ascii?q?QUBHAYTBQOCTkuCAgEEmh88ih1wgS+CdgEBBYcSCBJ5in6BVz+DbgcuiAKCV4k?=
 =?us-ascii?q?BUpYxBwKCHASPDxiBWY8viW2ONA8hgSWCDTMaMHQGgjWCG4kBhT5BMYEHilOBd?=
 =?us-ascii?q?wEB?=
X-IPAS-Result: =?us-ascii?q?A0AkAADOCPtbhxHrdtBhHgEGBwaBUQkLAYEwKoI4g3mId4s?=
 =?us-ascii?q?fgg2XPIFxFhgUiFoiNAkNAQMBAQEBAQECARMBAQEKCwkIGw4jDII2BQIDGgEGg?=
 =?us-ascii?q?lwBAgMBAiAdAQEECikBAgMBAgYBAQoLAwoCAiIEAgIDAR4SAQUBHAYTBQOCTku?=
 =?us-ascii?q?CAgEEmh88ih1wgS+CdgEBBYcSCBJ5in6BVz+DbgcuiAKCV4kBUpYxBwKCHASPD?=
 =?us-ascii?q?xiBWY8viW2ONA8hgSWCDTMaMHQGgjWCG4kBhT5BMYEHilOBdwEB?=
X-IronPort-AV: E=Sophos;i="5.56,279,1539673200"; 
   d="scan'208";a="53616342"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 25 Nov 2018 12:44:22 -0800
Received: from localhost ([::1]:32929 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gR1GP-0006Be-IL
	for like.xu@linux.intel.com; Sun, 25 Nov 2018 15:44:21 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:36930)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <peter.maydell@linaro.org>) id 1gR1G6-0006BM-G0
	for qemu-devel@nongnu.org; Sun, 25 Nov 2018 15:44:03 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <peter.maydell@linaro.org>) id 1gR1G5-000700-MW
	for qemu-devel@nongnu.org; Sun, 25 Nov 2018 15:44:02 -0500
Received: from mail-ot1-x336.google.com ([2607:f8b0:4864:20::336]:42840)
	by eggs.gnu.org with esmtps (TLS1.0:RSA_AES_128_CBC_SHA1:16)
	(Exim 4.71) (envelope-from <peter.maydell@linaro.org>)
	id 1gR1G5-0006zb-IC
	for qemu-devel@nongnu.org; Sun, 25 Nov 2018 15:44:01 -0500
Received: by mail-ot1-x336.google.com with SMTP id v23so9355840otk.9
	for <qemu-devel@nongnu.org>; Sun, 25 Nov 2018 12:44:01 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=linaro.org; s=google;
	h=mime-version:references:in-reply-to:from:date:message-id:subject:to
	:cc; bh=oGMva9Oi88Cy6BD77QhL/o9kzXZoxe5ZiLbw1mUg1ng=;
	b=YLUiH4Lu3d0q086dD6ujTfAmxpWKCML8VHPqLuaWGfLchX7WOlD1NnucahjVL2USG2
	TTb8O7y/VSa/Z4zaWeuB1Xe61vDVyXXbN0yMZQypknprMWdxN/m1G5qCqbwC/1s9ZeK/
	wJe4kVJPjDzJa7yIlBBSVj+lWcQU6s6KJ2oyc=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
	d=1e100.net; s=20161025;
	h=x-gm-message-state:mime-version:references:in-reply-to:from:date
	:message-id:subject:to:cc;
	bh=oGMva9Oi88Cy6BD77QhL/o9kzXZoxe5ZiLbw1mUg1ng=;
	b=mjnqzMrbGsXUhs5FhRm54kWXS8n8KdQrxA/NkaCJUvxTmhxi9d/ToGes78xKQjlrK2
	h/ddGo/2YVi0YT0cWS6/2iZPMIHMasYU0ThLOkUmvPVeITkN/XTKmV8Fq8nVC9brRhnf
	iSXNJr5EnozN5hWnF/TQEAbioF3AgjGT09qHUtKhF4ZddlRwtu34dxNNkOdNKyOp6XrQ
	mwHHm7arMCEfDVEt5AksENPSjRGZWZtOq2tattz+1rsq7e2AdEjswoiED4OYHW+3G/Cd
	YWayrmONgKJEatyWzSmk/ph2lSVkyMGoOBVOXbl7FIh0Sgm21DxbKVSCvm/AXw4yEoG/
	JjUA==
X-Gm-Message-State: AA+aEWbR1JP8mYMAwVGsLaIOE/bh61pSTold6Tn4uBKnZZnN5jGRYapt
	yAXV8QDR95R90bdJb1QsNkYpW3idDQqWpCo01pbdLw==
X-Google-Smtp-Source: AFSGD/X4Fg5r1ynridsz37VUzyfjH1PVQXd6DIAlkee54Ab2+AssyHY0BCCEH6Sh6KYrOMVBvN5Jrv/n7ixnrsUsT4k=
X-Received: by 2002:a9d:5617:: with SMTP id e23mr12615968oti.151.1543178640476;
	Sun, 25 Nov 2018 12:44:00 -0800 (PST)
MIME-Version: 1.0
References: <D965412A-A975-4660-BEC5-6FBF34E35C45@gmail.com>
	<CAFEAcA983Q16B8y1j3msg31BtM5LXhUcB5ouyg6Dp1y-aUaDpw@mail.gmail.com>
	<CAFEAcA8WMh8AnD8X5eMz7YX_c5z0Aw8_ydZ-0poY5Sv9mnxUHw@mail.gmail.com>
	<20181122073202.zafys4gyewgjpgko@sirius.home.kraxel.org>
In-Reply-To: <20181122073202.zafys4gyewgjpgko@sirius.home.kraxel.org>
From: Peter Maydell <peter.maydell@linaro.org>
Date: Sun, 25 Nov 2018 20:43:48 +0000
Message-ID: <CAFEAcA-NAbimZZ8=URgUb5hFe7LG72DRM05SwecARtJUcWL1zA@mail.gmail.com>
To: Gerd Hoffmann <kraxel@redhat.com>
Content-Type: text/plain; charset="UTF-8"
X-detected-operating-system: by eggs.gnu.org: Genre and OS details not
	recognized.
X-Received-From: 2607:f8b0:4864:20::336
Subject: Re: [Qemu-devel] [PATCH] Fix for crashes and non-responsive UI on
 macOS Mojave
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Berkus Decker <berkus@gmail.com>, QEMU Developers <qemu-devel@nongnu.org>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

On Thu, 22 Nov 2018 at 07:32, Gerd Hoffmann <kraxel@redhat.com> wrote:
>
>   Hi,
>
> > Something somewhere in this call chain should have taken
> > the iothread lock, I assume, but I'm not sure where.
> >
> > Gerd -- what are the rules of the UI subsystem regarding
> > multiple threads, and what threads are allowed to call
> > UI functions like qemu_input_event_send_key_qcode(),
> > from which threads, and whether they need to eg hold
> > the iothread lock when they do so? There's no
> > documentation on these functions in include/ui/input.h.
>
> UI event handling code typically runs in iothread context.  So, yes,
> when calling qemu_input_* the UI code holds the iothread lock.
>
> > (To fix a problem on OSX Mojave this patchset has moved
> > which thread the UI executes on, so it is now always
> > the main thread and not the thread which calls
> > the QemuDisplay 'init' callback. That seems to break
> > an implicit assumption in the UI layer.)
>
> Hmm, I guess the options are (a) grab the iothread lock before calling
> input layer functions, or (b) queue the event and schedule a bottom half
> which processes the queue (which will then be called from iothread
> context, with the lock already taken).

I was thinking about this today, and I realized that if
we just make the OSX UI thread code grab the iothread lock,
then there is a potential deadlock with the changes (also
in this patchset) which defer the DisplayChangeListener
update/switch/refresh operations to the UI thread. The
current patchset has those be synchronous deferrals, so
you could get a deadlock if the UI thread is waiting
for the iothread lock, but the code in the UI midlayer
is holding the iothread lock and waiting for a DCL
operation to be run on the main thread.

What are the required semantics for update/switch/refresh?
These don't seem to be documented. Can we validly make
those be asychronous, or does the midlayer require that
the operation has completed and been reflected onscreen
before the update/switch/refresh callback returns ?

If those have to be synchronous, then we'll need to do
something more complicated (eg the queuing of events
that you suggest), which I'd prefer it if we can avoid,
because that implies memory allocation or a fixed
length queue (plus some fairly significant restructuring
of the cocoa frontend).

thanks
-- PMM

