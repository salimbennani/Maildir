Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 24 Nov 2018 12:36:56 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga004.jf.intel.com (orsmga004.jf.intel.com [10.7.209.38])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id B56F8580460
	for <like.xu@linux.intel.com>; Fri, 23 Nov 2018 10:35:13 -0800 (PST)
Received: from orsmga106.jf.intel.com ([10.7.208.65])
  by orsmga004-1.jf.intel.com with ESMTP; 23 Nov 2018 10:35:13 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3Adi7clBZZE/ImCz+jcM8btmD/LSx+4OfEezUN459i?=
 =?us-ascii?q?sYplN5qZpsy6Yh7h7PlgxGXEQZ/co6odzbaO4+a4ASQp2tWoiDg6aptCVhsI24?=
 =?us-ascii?q?09vjcLJ4q7M3D9N+PgdCcgHc5PBxdP9nC/NlVJSo6lPwWB6nK94iQPFRrhKAF7?=
 =?us-ascii?q?Ovr6GpLIj8Swyuu+54Dfbx9HiTahYr5+Ngm6oRnMvcQKnIVuLbo8xAHUqXVSYe?=
 =?us-ascii?q?RWwm1oJVOXnxni48q74YBu/SdNtf8/7sBMSar1cbg2QrxeFzQmLns65Nb3uhnZ?=
 =?us-ascii?q?TAuA/WUTX2MLmRdVGQfF7RX6XpDssivms+d2xSeXMdHqQb0yRD+v9LlgRgP2hy?=
 =?us-ascii?q?gbNj456GDXhdJ2jKJHuxKquhhzz5fJbI2JKPZye6XQds4YS2VcRMZcTyNOAo2+?=
 =?us-ascii?q?YIUPAeQPPvhWoJXyqVUTtRuzBwuiCezyxjJGmnP5w7Y63v89EQHfxgEsA84CvG?=
 =?us-ascii?q?jWodjzKawcUfq1zK7NzTjbdf1Zxyv955bSchs8pv+DR7JxftfPxkkrEwPOk1Kd?=
 =?us-ascii?q?qZT7MDOJyOsNqXKX7+96WuOvlmEotQVxojy0y8coi4nJgJgaykrD9Sljx4Y1P9?=
 =?us-ascii?q?K4RVd9bNW5E5VQrzmXO5VqTs4hWW1kpTs2x74ctZKlciUHyI4rywPdZvCfbYSF?=
 =?us-ascii?q?4w7vWeSULDd2h39qY66zihO9/EWjy+DxWcy53EhWoidAl9TAqH8A2wHV58OaUP?=
 =?us-ascii?q?Vy5F2h1iyK1w3L6uFLP0Q0la3DJp4lw74wjYYTsV/ZEi/5nkX2kbWadkI++uin?=
 =?us-ascii?q?8+jnY7PmqYGAN4JslA3yLqcjltaiDeglMQUCRXaX9Oq82bH54EH0Qq1Gjvgsna?=
 =?us-ascii?q?nYtJDaK94bpqm8AwJNy4Ys9RO/Dyq/3NsFg3YHMkxKeBaeg4fyPFHOPfb4Auuh?=
 =?us-ascii?q?jFS3lztrw/HGPr7/DZnXIXnDja/sfbJ8605a1QoywspT55NSCrEdPv3zXlX9u8?=
 =?us-ascii?q?DfDh88KAG0xeHnCNNy1oMYRGKDGKiZMLndsVOQ/OIgP/GMZJMJuDb6M/Ul4//u?=
 =?us-ascii?q?jXwnllMHcqipwIAaaHS5HvRgPkWYbmDggtYHEWcWoAU+SPbmh0GFUT5WND6PWb?=
 =?us-ascii?q?kh7GQ7FJ6+FtWEAYSsm6CamiG8GJJQeyZBEF/LFH7pc4CNXbALcD6TJcl61SUJ?=
 =?us-ascii?q?UKXkR4I/2BX9iQnh1rAyK+PV/jEf54vu0cUw6+DNmBV37zFtEsmGz0mLSGd7mH?=
 =?us-ascii?q?5OQCU5i7tiq05wwUvWzK5jnvZDHsZS7f4abgBvGJLBxvZ2DJjSUwjCecyVAAKr?=
 =?us-ascii?q?QtysAjYqUvorztMOalo7ENKn2EPtxS2vVocYi7GRTLk9467R23y5c95w13vckq?=
 =?us-ascii?q?wonlUrRs9nMWygj7R4sQ/JCNiawA2ii6+2ePFEj2b2/2CZwD/L5RkAXQ=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0BNAAATR/hbhxHrdtBjHgEGBwaBUwcLA?=
 =?us-ascii?q?YEwgmKDeYh3iyGCDZc7gXEWGBSIWiI2Bw0BAwEBAQEBAQIBEwEBAQoLCQgbDiM?=
 =?us-ascii?q?MgjYFAgMaAQaCXAECAwECIAQZAQEECikBAgMBAgYBAQoLAwoCAiIEAgIDAR4SA?=
 =?us-ascii?q?QUBHAYTBYMcggIBBJtCPIodcHwzgnYBAQWHFQgSeYp+gVc/hCOIAoJXiSGBcpR?=
 =?us-ascii?q?xBwKCHASPDxiBWYULiiSYIQ8hgSwGggAzGjBDMQaCNYIbCwEXiF6FPkExgQeKK?=
 =?us-ascii?q?oF3AQE?=
X-IPAS-Result: =?us-ascii?q?A0BNAAATR/hbhxHrdtBjHgEGBwaBUwcLAYEwgmKDeYh3iyG?=
 =?us-ascii?q?CDZc7gXEWGBSIWiI2Bw0BAwEBAQEBAQIBEwEBAQoLCQgbDiMMgjYFAgMaAQaCX?=
 =?us-ascii?q?AECAwECIAQZAQEECikBAgMBAgYBAQoLAwoCAiIEAgIDAR4SAQUBHAYTBYMcggI?=
 =?us-ascii?q?BBJtCPIodcHwzgnYBAQWHFQgSeYp+gVc/hCOIAoJXiSGBcpRxBwKCHASPDxiBW?=
 =?us-ascii?q?YULiiSYIQ8hgSwGggAzGjBDMQaCNYIbCwEXiF6FPkExgQeKKoF3AQE?=
X-IronPort-AV: E=Sophos;i="5.56,270,1539673200"; 
   d="scan'208";a="41327886"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 23 Nov 2018 10:34:13 -0800
Received: from localhost ([::1]:53885 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gQGHM-0006QB-7j
	for like.xu@linux.intel.com; Fri, 23 Nov 2018 13:34:12 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:34683)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <peter.maydell@linaro.org>) id 1gQGDF-0003sR-MI
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 13:29:59 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <peter.maydell@linaro.org>) id 1gQFyT-000624-1m
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 13:14:42 -0500
Received: from mail-oi1-x241.google.com ([2607:f8b0:4864:20::241]:40332)
	by eggs.gnu.org with esmtps (TLS1.0:RSA_AES_128_CBC_SHA1:16)
	(Exim 4.71) (envelope-from <peter.maydell@linaro.org>)
	id 1gQFyS-000613-Ju
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 13:14:40 -0500
Received: by mail-oi1-x241.google.com with SMTP id t204so10611674oie.7
	for <qemu-devel@nongnu.org>; Fri, 23 Nov 2018 10:14:40 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=linaro.org; s=google;
	h=mime-version:references:in-reply-to:from:date:message-id:subject:to
	:cc:content-transfer-encoding;
	bh=1y9e5ZjQ7O8xxZch0LhsdPe7o2TB3d5w12yeOqfiRhY=;
	b=RBCD68bk3hWi8okXohGl+w9Oz8XqvymfhZMIrJtWHGjTTWep1Ujq0n2pRldmjoidRf
	u8Pr6WadXf1eBs9sQOnj5NMM89IKn/Q6VJTcrE5HGSwkCoT3P1BnBJujo+lG8p1xnO67
	WNEFmbDSwDT/xcbPigbFmLf2VWItHxKqKclwE=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
	d=1e100.net; s=20161025;
	h=x-gm-message-state:mime-version:references:in-reply-to:from:date
	:message-id:subject:to:cc:content-transfer-encoding;
	bh=1y9e5ZjQ7O8xxZch0LhsdPe7o2TB3d5w12yeOqfiRhY=;
	b=kZH8WKZa/JNmSJ85tCZqo0k7zZ98dW9ARLKRsCBsS5fiv58l32Q14aNrzKuDpaXJzx
	7q5qG94eSKQFU06l4+QWBQZTlq/Pw2P7/WNUFCzyr1SkoPYbycxC6dhJgMc4YxiXVbGO
	YeJedaLJ4viAahn3FR9DcrRLHHy10TO7h2XImYngiSRsNyTdy2xEOJzwO8NntEcZ9/Qc
	qcyHeObmYyfDsiSkRtOOt0XwGOuLAj/NZzmxOkndWoW93f25nnSbC3D1h0qmYBOJXER3
	xImX+agQV32UtptrIWQwdwt8w+ZT7Kwy6z56mbn9NcR5B/lOe65gM031LbFLJu/6orX4
	zEyQ==
X-Gm-Message-State: AGRZ1gKhqAw3/zzuYmbez+X67JloEwql6WUQSVu10j9BG+r4OgWfsthB
	gFlmRtMKWDDC+WAQIixthJgv6J0htnYO9nCF27ahsQ==
X-Google-Smtp-Source: AJdET5fW2W7TEWr3CVlLTtix1RutVuPPHduxxTJbGHtOjClE1Y+tyBcGJYujPzgO6etkXnQfzT9dUh0KEmbB3JeRhS8=
X-Received: by 2002:aca:fd12:: with SMTP id
	b18-v6mr9559437oii.337.1542996879845; 
	Fri, 23 Nov 2018 10:14:39 -0800 (PST)
MIME-Version: 1.0
References: <20181123091729.29921-1-luc.michel@greensocs.com>
	<20181123091729.29921-2-luc.michel@greensocs.com>
	<20181123181059.GN18284@habkost.net>
In-Reply-To: <20181123181059.GN18284@habkost.net>
From: Peter Maydell <peter.maydell@linaro.org>
Date: Fri, 23 Nov 2018 18:14:28 +0000
Message-ID: <CAFEAcA_8jJz5dE7XP4R=LjEC5WzP3jzutg=YqiYjJVwZZz+jvQ@mail.gmail.com>
To: Eduardo Habkost <ehabkost@redhat.com>
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable
X-detected-operating-system: by eggs.gnu.org: Genre and OS details not
	recognized.
X-Received-From: 2607:f8b0:4864:20::241
Subject: Re: [Qemu-devel] [PATCH v7 01/16] hw/cpu: introduce CPU clusters
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Alistair Francis <alistair@alistair23.me>,
	Mark Burton <mark.burton@greensocs.com>,
	QEMU Developers <qemu-devel@nongnu.org>,
	=?UTF-8?Q?Philippe_Mathieu=2DDaud=C3=A9?= <f4bug@amsat.org>,
	Sai Pavan Boddu <saipava@xilinx.com>, Edgar Iglesias <edgari@xilinx.com>,
	qemu-arm <qemu-arm@nongnu.org>, Luc Michel <luc.michel@greensocs.com>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

On Fri, 23 Nov 2018 at 18:11, Eduardo Habkost <ehabkost@redhat.com> wrote:
> On Fri, Nov 23, 2018 at 10:17:14AM +0100, Luc Michel wrote:
> > This commit adds the cpu-cluster type. It aims at gathering CPUs from
> > the same cluster in a machine.
> >
> > For now it only has a `cluster-id` property.
> >
> > Signed-off-by: Luc Michel <luc.michel@greensocs.com>
> > Reviewed-by: Alistair Francis <alistair.francis@wdc.com>
> > Reviewed-by: Philippe Mathieu-Daud=C3=A9 <philmd@redhat.com>
> > Tested-by: Philippe Mathieu-Daud=C3=A9 <philmd@redhat.com>
> > Reviewed-by: Edgar E. Iglesias <edgar.iglesias@xilinx.com>
> [...]
> > +static void cpu_cluster_init(Object *obj)
> > +{
> > +    static uint32_t cluster_id_auto_increment;
> > +    CPUClusterState *cluster =3D CPU_CLUSTER(obj);
> > +
> > +    cluster->cluster_id =3D cluster_id_auto_increment++;
>
> I see that you implemented this after a suggestion from Philippe,
> but I'm worried about this kind of side-effect on object/device
> code.  I'm afraid this will bite us back in the future.  We were
> bitten by problems caused by automatic cpu_index assignment on
> CPU instance_init, and we took a while to fix that.
>
> If you really want to do this and assign cluster_id
> automatically, please do it on realize, where it won't have
> unexpected side-effects after a simple `qom-list-properties` QMP
> command.
>
> I would also add a huge warning above the cluster_id field
> declaration, mentioning that the field is not supposed to be used
> for anything except debugging.  I think there's a large risk of
> people trying to reuse the field incorrectly, just like cpu_index
> was reused for multiple (conflicting) purposes in the past.

One thing I would like to do with this new "cpu cluster"
concept is to use it to handle a problem we have at the
moment with TCG, where we assume all CPUs have the same
view of physical memory (and so if CPU A executes from physical
address X it can share translated code with CPU B executing
from physical address X). The idea is that we should include
the CPU cluster number in the TCG hash key that we use to
look up cached translation blocks, so that only CPUs in
the same cluster (assumed to have the same view of memory
and to be identical) share TBs.

If we don't have a unique integer key for the cluster, what
should we use instead ?

thanks
-- PMM

