Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 24 Nov 2018 12:37:03 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga002.jf.intel.com (orsmga002.jf.intel.com [10.7.209.21])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id DE4CF580460
	for <like.xu@linux.intel.com>; Fri, 23 Nov 2018 10:55:54 -0800 (PST)
Received: from fmsmga104.fm.intel.com ([10.1.193.100])
  by orsmga002-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 10:55:54 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AtCI0/B3WZaUjihpCsmDT+DRfVm0co7zxezQtwd8Z?=
 =?us-ascii?q?sesWKvjxwZ3uMQTl6Ol3ixeRBMOHs6IC07KempujcFRI2YyGvnEGfc4EfD4+ou?=
 =?us-ascii?q?JSoTYdBtWYA1bwNv/gYn9yNs1DUFh44yPzahANS47xaFLIv3K98yMZFAnhOgpp?=
 =?us-ascii?q?POT1HZPZg9iq2+yo9JDffwZFiCChbb9uMR67sRjfus4KjIV4N60/0AHJonxGe+?=
 =?us-ascii?q?RXwWNnO1eelAvi68mz4ZBu7T1et+ou+MBcX6r6eb84TaFDAzQ9L281/szrugLd?=
 =?us-ascii?q?QgaJ+3ART38ZkhtMAwjC8RH6QpL8uTb0u+ZhxCWXO9D9QKsqUjq+8ahkVB7oiD?=
 =?us-ascii?q?8GNzEn9mHXltdwh79frB64uhBz35LYbISTOfFjfK3SYMkaSHJOUcZfVSNPAo2y?=
 =?us-ascii?q?YYgRAeUdIOhYt4vwqVkBoBejCwSgGP3gyiRTi3/qwaE3yfgtHR3a0AEiGd8FrX?=
 =?us-ascii?q?TarM/yNKcXSe271rfHzSndYPNMxDzz75LHcxA8rv6SWbJwddfaxE43FwzbklWf?=
 =?us-ascii?q?t5blMymQ1usXs2mU8vRvVeari2M8rwFxoz6vyd02ionOnI4VzUrE9SpgzYszON?=
 =?us-ascii?q?a2S1Z7bMa6HJdMtCyWLZZ6Tt4hTm1ypio3xL0LtYSmcCUI0Jgr2R/SZ+CFfoWN?=
 =?us-ascii?q?7BLuV/2eLSt9iX9qe7+yhhm//E2+xuHgU8S51UhGoyVLn9TKq3sDzQbc6tKdRf?=
 =?us-ascii?q?t45kqh2SiA1wTU6uxcJUA0lLHbK4I6wrIqmZoTt1nDEjXxmEXsg6+abkQk+u62?=
 =?us-ascii?q?5OT7erjquIOQOoxuhg3jL6gjmdazDfo2PwUORWSX5Oax2KXm/ULjQbVKivM2kr?=
 =?us-ascii?q?PesJDfPckbv7C2AwpI0oo69hmwESmm38ocnXUeN11Ffw+Hj471NF7QO/D0CvO/?=
 =?us-ascii?q?g1WvkDh13fzHMaDhD43JLnjClrfhYLl851RdyAo10dBQ+ZZUBqsdL/L0X0/8r9?=
 =?us-ascii?q?rYDhg/Mwy7xebnFc9x1oQEWWKAGqOZKr/dsUeU5uIzJOmBfIsVuDf+K/c7/fLv?=
 =?us-ascii?q?gmI5lEQZfamo25sXdX+5Eu5nI0WffXrjnNMBHX0WsQo5Sey5wGCESiNZMnauQ7?=
 =?us-ascii?q?ontHZ8DIO9EZyFQIerj7qcmiChEdpTb2FCD1mKVnDwa4SDXexLcS+XP4ptnyIJ?=
 =?us-ascii?q?UeucTZQ830SrvQ7+1701N+fR52gUuIzu0J1v6vTOmAou3TpzCcubzieKVW4jhX?=
 =?us-ascii?q?4CRTI9wPVip1dgwEyIy6lyjq9kEol+6+5ASAs9fb7Vxe99EMy6Dg/Bd92KT026?=
 =?us-ascii?q?as+rDTE4UpQ6xNpYMGhnHND3th3f0jDiJrYEm7GPANRg6q/A0mK3Is9sx3vC0I?=
 =?us-ascii?q?Eljl8vWMwJMnep0P0svzPPDpLExh3K352hcr4RiWuUrD+O?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0A2AABvTPhbhxHrdtBjHgEGBwaBUggLA?=
 =?us-ascii?q?YEwgmKDeYh3iyGCDZc7gW4ZGBSIWiI1CA0BAwEBAQEBAQIBEwEBAQoLCQgbDiM?=
 =?us-ascii?q?MgjYFAgMaAQaCWwEBAQECAQECIB0BAQQKKQECAgEBAgYBAQoLAwoCAiIEAgIDA?=
 =?us-ascii?q?R4SAQUBHAYTBYMcgXoIAQSbQTyKHXCBL4J2AQEFhxUIEnmKfoFXP4ERgxKIAoJ?=
 =?us-ascii?q?XiSGBcpRxBwKCHASPDxiRCJghDyGBJgGCCzMaMHQGgjWCGwsYiF6FPkExgQeKK?=
 =?us-ascii?q?oF3AQE?=
X-IPAS-Result: =?us-ascii?q?A0A2AABvTPhbhxHrdtBjHgEGBwaBUggLAYEwgmKDeYh3iyG?=
 =?us-ascii?q?CDZc7gW4ZGBSIWiI1CA0BAwEBAQEBAQIBEwEBAQoLCQgbDiMMgjYFAgMaAQaCW?=
 =?us-ascii?q?wEBAQECAQECIB0BAQQKKQECAgEBAgYBAQoLAwoCAiIEAgIDAR4SAQUBHAYTBYM?=
 =?us-ascii?q?cgXoIAQSbQTyKHXCBL4J2AQEFhxUIEnmKfoFXP4ERgxKIAoJXiSGBcpRxBwKCH?=
 =?us-ascii?q?ASPDxiRCJghDyGBJgGCCzMaMHQGgjWCGwsYiF6FPkExgQeKKoF3AQE?=
X-IronPort-AV: E=Sophos;i="5.56,270,1539673200"; 
   d="scan'208";a="52415066"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 23 Nov 2018 10:55:53 -0800
Received: from localhost ([::1]:53953 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gQGcK-0008KW-Qx
	for like.xu@linux.intel.com; Fri, 23 Nov 2018 13:55:52 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:41062)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <peter.maydell@linaro.org>) id 1gQGbo-0008IA-Gy
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 13:55:21 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <peter.maydell@linaro.org>) id 1gQGZr-0005Hw-4Q
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 13:53:19 -0500
Received: from mail-oi1-x243.google.com ([2607:f8b0:4864:20::243]:39121)
	by eggs.gnu.org with esmtps (TLS1.0:RSA_AES_128_CBC_SHA1:16)
	(Exim 4.71) (envelope-from <peter.maydell@linaro.org>)
	id 1gQGZq-0005FR-W3
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 13:53:19 -0500
Received: by mail-oi1-x243.google.com with SMTP id 192-v6so10701693oii.6
	for <qemu-devel@nongnu.org>; Fri, 23 Nov 2018 10:53:18 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=linaro.org; s=google;
	h=mime-version:references:in-reply-to:from:date:message-id:subject:to
	:cc; bh=Qye4iIQ/v893zVtWM2g4aKXe4cHElY7mrFQwkilI4Qs=;
	b=hfVT7buZH2JKAIJXEt/RaQVJAdK3tBJ3whZCFc/EuHQr2Im0tZLbMAf5xBhsFuiNoh
	gMtiWkEB3hPUidg+cvXZmlNrRFPV5grTj1ygYOvg5eXMgOKcGdaR2lOdH3cetTBQ/6lO
	wIjuQI8Zx2ZG3yNnAYP0Mj5g7s+zFTZq/z5zo=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
	d=1e100.net; s=20161025;
	h=x-gm-message-state:mime-version:references:in-reply-to:from:date
	:message-id:subject:to:cc;
	bh=Qye4iIQ/v893zVtWM2g4aKXe4cHElY7mrFQwkilI4Qs=;
	b=tn/QGdAQcIvQiWiulSz2y+AxexwI3/9kQnq4ZupLcadLIue+xvUXA2Hpb8sfs3CyA/
	Ed7o5baWzyPvjA5d/C2jJSgq2ZyqOy6Hr1PwXMlLCMTy2Jd8hzicLe9YQOISXOL3wr6U
	i8MqP3AWlaHWX6YEqiOckc+BP6RVFtsaXjWK6f9lFuvhJkLpxMhRsko8zVxjEhvhyRSw
	kl20CA3ovvAZ5fN869pem2vHt3yCB+5A80U0pkeU5hPOFpI0esBGGHkziTvfXY3P78kf
	CA1X16ri5ZV8psMtIwvIGp/U1QZb63p64keufcETJ8xfEU+d6KagaUUEc8VgytlCKTmP
	8kKA==
X-Gm-Message-State: AGRZ1gIZEmeFUn6gsC9oqn5Afw/Z8A3gkVc5XaX7cL1Ha2MBHzcEorua
	E/9qdEuG9K4iCklq2uKStsf28k/DXKxzSocHqidKbg==
X-Google-Smtp-Source: AJdET5fFQHy7PR6d7+iscRAYYu15ie8bTJtBCK0gVziswHr3Fi14dKk7FSTJfSsHnfsAqr6Y7sAHM8NBeL/ENosjBeM=
X-Received: by 2002:aca:fd12:: with SMTP id
	b18-v6mr9628302oii.337.1542999198406; 
	Fri, 23 Nov 2018 10:53:18 -0800 (PST)
MIME-Version: 1.0
References: <20181123091729.29921-1-luc.michel@greensocs.com>
	<20181123091729.29921-2-luc.michel@greensocs.com>
	<20181123181059.GN18284@habkost.net>
	<CAFEAcA_8jJz5dE7XP4R=LjEC5WzP3jzutg=YqiYjJVwZZz+jvQ@mail.gmail.com>
	<20181123182415.GP18284@habkost.net>
In-Reply-To: <20181123182415.GP18284@habkost.net>
From: Peter Maydell <peter.maydell@linaro.org>
Date: Fri, 23 Nov 2018 18:53:07 +0000
Message-ID: <CAFEAcA-WwupF9Lm85+S4YSq1f5Y0AjEOtG0Uzh=7pDVdF0w38A@mail.gmail.com>
To: Eduardo Habkost <ehabkost@redhat.com>
Content-Type: text/plain; charset="UTF-8"
X-detected-operating-system: by eggs.gnu.org: Genre and OS details not
	recognized.
X-Received-From: 2607:f8b0:4864:20::243
Subject: Re: [Qemu-devel] [PATCH v7 01/16] hw/cpu: introduce CPU clusters
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Alistair Francis <alistair@alistair23.me>,
	Mark Burton <mark.burton@greensocs.com>,
	QEMU Developers <qemu-devel@nongnu.org>,
	=?UTF-8?Q?Philippe_Mathieu=2DDaud=C3=A9?= <f4bug@amsat.org>,
	Sai Pavan Boddu <saipava@xilinx.com>, Edgar Iglesias <edgari@xilinx.com>,
	qemu-arm <qemu-arm@nongnu.org>, Luc Michel <luc.michel@greensocs.com>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

On Fri, 23 Nov 2018 at 18:24, Eduardo Habkost <ehabkost@redhat.com> wrote:
>
> On Fri, Nov 23, 2018 at 06:14:28PM +0000, Peter Maydell wrote:
> > One thing I would like to do with this new "cpu cluster"
> > concept is to use it to handle a problem we have at the
> > moment with TCG, where we assume all CPUs have the same
> > view of physical memory (and so if CPU A executes from physical
> > address X it can share translated code with CPU B executing
> > from physical address X). The idea is that we should include
> > the CPU cluster number in the TCG hash key that we use to
> > look up cached translation blocks, so that only CPUs in
> > the same cluster (assumed to have the same view of memory
> > and to be identical) share TBs.
> >
> > If we don't have a unique integer key for the cluster, what
> > should we use instead ?
>
> This sounds like a reasonable use of cluster_id as implemented in
> this patch.  The ID would be only used internally and not exposed
> to the outside, right?

It would be internal to QEMU (not exposed to the guest or
to the user), yes.

> I'm more worried about cases where we could end up exposing the
> ID in an external interface (either to guests, or through QMP or
> the command-line).  This happened to cpu_index and we took a long
> time to fix the mess.

I see, thanks.

My other question about this code was a slightly different one -- are
we guaranteed to be holding the iothread lock when we create
new QOM objects? (ie that we won't have races between two threads
which both try to create new objects and increment the variable)

thanks
-- PMM

