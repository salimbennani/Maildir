Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 23:36:38 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga002.fm.intel.com (fmsmga002.fm.intel.com [10.253.24.26])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id B214858037D
	for <like.xu@linux.intel.com>; Fri, 23 Nov 2018 07:16:48 -0800 (PST)
Received: from orsmga101.jf.intel.com ([10.7.208.22])
  by fmsmga002-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 07:16:48 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AqdjZkR+B7roV6/9uRHKM819IXTAuvvDOBiVQ1KB2?=
 =?us-ascii?q?1uscTK2v8tzYMVDF4r011RmVBdWds6oMotGVmpioYXYH75eFvSJKW713fDhBt/?=
 =?us-ascii?q?8rmRc9CtWOE0zxIa2iRSU7GMNfSA0tpCnjYgBaF8nkelLdvGC54yIMFRXjLwp1?=
 =?us-ascii?q?Ifn+FpLPg8it2O2+557ebx9UiDahfLh/MAi4oQLNu8cMnIBsMLwxyhzHontJf+?=
 =?us-ascii?q?RZ22ZlLk+Nkhj/+8m94odt/zxftPw9+cFAV776f7kjQrxDEDsmKWE169b1uhTF?=
 =?us-ascii?q?UACC+2ETUmQSkhpPHgjF8BT3VYr/vyfmquZw3jSRMMvrRr42RDui9b9mRh/2hi?=
 =?us-ascii?q?kJNDA392PYisJtgqJDoh+vpRNyz5PabY2JKvV+ZbjQcc8GSWdbQspcTTBNDp+6?=
 =?us-ascii?q?YoASD+QBJ+FYr4zlqlUSrBuxGQmsC/n1yjBVm3T437M10+I8Hg7YxgwgBNUOsH?=
 =?us-ascii?q?LJp9jyLqcSUPy6zKnSwjXZcvxawzf955bOch88v/6MR6lwcc3XyUQ0EwPFj1OQ?=
 =?us-ascii?q?ppb/PzOSzOgNtHKb7+V5WO+plmUpqBlxryCxysswiYTFnJ8Zxk3H+Clj3oo4K9?=
 =?us-ascii?q?21RFRmbdOmCJdcqiWXOotsTs4gQWxkojg2x7IHtJKhfCUG1JIqzAPFZfOdaYiH?=
 =?us-ascii?q?+BfjWf6RIThmgHJlf6qyhxKz8Ui71u38TdO40FlMripYiNXMsWoN1xPL5siGTP?=
 =?us-ascii?q?ty4Fuh1C6R2wzP6exIO104mbfYJpI73LI9mJoevV7eEiL0gEn2ibWZdkQg+uim?=
 =?us-ascii?q?8eTnZbDmq4eFN4BqjwH+L70ildGhDuQmLAcOW3GX9v+71L3++032XKtFjuYxnq?=
 =?us-ascii?q?ndsZDaJtoUqrS2Ag9Iyosj7xe/DzG70NUXh3UHLVRFeA6ZgIjtIV3BPPf4DfKk?=
 =?us-ascii?q?jlSqlzdrwf/GPrv8ApnXKXjDirjhca5n60FA0Aoz0cxf55VMB7EFIfLzWVH+uM?=
 =?us-ascii?q?bXDx8kKAG0x+fnCNNg1oIRQ26PA6mZML/Mvl+M/O4gP+6MZIpG8Av7MOUvsv7y?=
 =?us-ascii?q?kWciyxhaeaiywYBRbne+EfJ7ZUKDbj3pi9YFFG4M+Q0mUO3tjkbFSDNWejO+Ur?=
 =?us-ascii?q?wx4mIGDpm7B9LGT4GpnLvTxSq+A9haa35LDhWWHG71ep6Yc/ELbi2UP4lmiDNT?=
 =?us-ascii?q?TqWrSYIqyUSzshTnwaFsNOve934kssf62d1oouHeixw23TpzCcubzieKVW4nsH?=
 =?us-ascii?q?kPQmoM3at/qFZxgneO16R1medfE5QH/fJCUg4gOdjcwup2BsrpXQTpetaPQUyh?=
 =?us-ascii?q?BNK8DmdiHZoK39YSbhMlSJ2ZhRfZ0n/yDg=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AtAACiGPhbhxHrdtBjHgEGBwaBUQkLA?=
 =?us-ascii?q?YEwgmKMcIshgweRSoR3gXEUAQEYFIhaIjQJDQEDAQEBAQEBAgETAQEBCgsJCBs?=
 =?us-ascii?q?OIwyCNgUCAxgJglwDAwECPQEBBAopAQIDAQIGAQE+CggDATABBQEcGQWDHIICA?=
 =?us-ascii?q?QMBm0Y8ih2CH4J2AQEFgkOEUQgSh0yDD4EcgVc/gRCCXoYAhQ6JJZZfBwKCHAS?=
 =?us-ascii?q?PBAsYiVGHNyyXXQYCCQcPIYElgg1NMIMvghsMFxKITIU/cYEHiiqBdwEB?=
X-IPAS-Result: =?us-ascii?q?A0AtAACiGPhbhxHrdtBjHgEGBwaBUQkLAYEwgmKMcIshgwe?=
 =?us-ascii?q?RSoR3gXEUAQEYFIhaIjQJDQEDAQEBAQEBAgETAQEBCgsJCBsOIwyCNgUCAxgJg?=
 =?us-ascii?q?lwDAwECPQEBBAopAQIDAQIGAQE+CggDATABBQEcGQWDHIICAQMBm0Y8ih2CH4J?=
 =?us-ascii?q?2AQEFgkOEUQgSh0yDD4EcgVc/gRCCXoYAhQ6JJZZfBwKCHASPBAsYiVGHNyyXX?=
 =?us-ascii?q?QYCCQcPIYElgg1NMIMvghsMFxKITIU/cYEHiiqBdwEB?=
X-IronPort-AV: E=Sophos;i="5.56,270,1539673200"; 
   d="scan'208";a="41998947"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 23 Nov 2018 07:16:47 -0800
Received: from localhost ([::1]:52938 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gQDCI-00040O-Ra
	for like.xu@linux.intel.com; Fri, 23 Nov 2018 10:16:46 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:44272)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <richard.henderson@linaro.org>) id 1gQCj6-0000Hj-RR
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 09:46:39 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <richard.henderson@linaro.org>) id 1gQCj4-0003lo-Su
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 09:46:35 -0500
Received: from mail-wr1-x441.google.com ([2a00:1450:4864:20::441]:32861)
	by eggs.gnu.org with esmtps (TLS1.0:RSA_AES_128_CBC_SHA1:16)
	(Exim 4.71) (envelope-from <richard.henderson@linaro.org>)
	id 1gQCj4-0003iu-Ki
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 09:46:34 -0500
Received: by mail-wr1-x441.google.com with SMTP id c14so6956475wrr.0
	for <qemu-devel@nongnu.org>; Fri, 23 Nov 2018 06:46:33 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=linaro.org; s=google;
	h=from:to:cc:subject:date:message-id:in-reply-to:references;
	bh=ftMZ3fz35dYKoMc8uTCKp7fh8kUWUt+B2yZR69ArZfM=;
	b=C0BGPmG6ZXBTup7b6ZlFpG2gESXyr8l9FLstYIP3caLxWVWfHSORxi2HxlHukoBBPZ
	nO9PZm+GlHFTkbaHzi8H8/xDaOY9kzlCpZeARg4JlNQHG5VQHEvBD75FWesXxJHMYb3a
	AXjqKLRSMpONusJU1PlZXBwcvMeQXeyqkj3YM=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
	d=1e100.net; s=20161025;
	h=x-gm-message-state:from:to:cc:subject:date:message-id:in-reply-to
	:references;
	bh=ftMZ3fz35dYKoMc8uTCKp7fh8kUWUt+B2yZR69ArZfM=;
	b=kL+YF60s8HhqVFVG63A2xMq+tr/dQQrYgBVZBiUu+u9EWaCOt3GIUtpKxTwz63FmzJ
	gABFqo7O80sffTFIBCsdnTHtzG1PPgGs8Bb86bZBHNMtfos30WlbI+iSMqLO7TtOKhBX
	q/ti3oPKeqgpBfuZ05wKPTo/fnuNI6P2YadgG11q1vsi+x/0EPNwxo3bcYBiPQ2DzD1G
	xCUfhBi+LaaEUxZTCihQWYKLMSalO15/fwiMl+Oin3UdPPxNlVg03xXbi5mL8veu6w08
	S6t1mJFKrpHe2N3VCsOOC51liXqgEIWvi15ejHg61hV2KioP+4yP1uhxqhNw/vBn+1G3
	BZCQ==
X-Gm-Message-State: AA+aEWYPCssV25770aJmpPDqwYYisVAh4aWHAg5DNTPe1PsiAX/a/9xg
	d82rkg0srbh1Oz1eXywG2wtRiT+jRT2J4g==
X-Google-Smtp-Source: AFSGD/W1PBlUOD1EbxlwkuznlBgjop3RHaDn2aSx9eWUCUZ97gcn811ZzkpcDxcA8v2D0BIV0tuCRQ==
X-Received: by 2002:adf:c888:: with SMTP id k8mr15339977wrh.6.1542984392410;
	Fri, 23 Nov 2018 06:46:32 -0800 (PST)
Received: from cloudburst.twiddle.net ([195.77.246.50])
	by smtp.gmail.com with ESMTPSA id
	p74sm10339630wmd.29.2018.11.23.06.46.31
	(version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
	Fri, 23 Nov 2018 06:46:31 -0800 (PST)
From: Richard Henderson <richard.henderson@linaro.org>
To: qemu-devel@nongnu.org
Date: Fri, 23 Nov 2018 15:45:54 +0100
Message-Id: <20181123144558.5048-34-richard.henderson@linaro.org>
X-Mailer: git-send-email 2.17.2
In-Reply-To: <20181123144558.5048-1-richard.henderson@linaro.org>
References: <20181123144558.5048-1-richard.henderson@linaro.org>
X-detected-operating-system: by eggs.gnu.org: Genre and OS details not
	recognized.
X-Received-From: 2a00:1450:4864:20::441
Subject: [Qemu-devel] [PATCH for-4.0 v2 33/37] tcg/i386: Propagate is64 to
 tcg_out_qemu_ld_direct
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Alistair.Francis@wdc.com
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

This can save a few rex prefixes for qemu_ld_i32.

Signed-off-by: Richard Henderson <richard.henderson@linaro.org>
---
 tcg/i386/tcg-target.inc.c | 24 +++++++++++++-----------
 1 file changed, 13 insertions(+), 11 deletions(-)

diff --git a/tcg/i386/tcg-target.inc.c b/tcg/i386/tcg-target.inc.c
index 76235e90c9..5cad31cfe5 100644
--- a/tcg/i386/tcg-target.inc.c
+++ b/tcg/i386/tcg-target.inc.c
@@ -1815,10 +1815,11 @@ static inline void setup_guest_base_seg(void) { }
 
 static void tcg_out_qemu_ld_direct(TCGContext *s, TCGReg datalo, TCGReg datahi,
                                    TCGReg base, int index, intptr_t ofs,
-                                   int seg, TCGMemOp memop)
+                                   int seg, bool is64, TCGMemOp memop)
 {
     bool use_bswap = memop & MO_BSWAP;
     bool use_movbe = false;
+    int rexw = is64 * P_REXW;
     int movop = OPC_MOVL_GvEv;
 
     /*
@@ -1843,7 +1844,7 @@ static void tcg_out_qemu_ld_direct(TCGContext *s, TCGReg datalo, TCGReg datahi,
                                  base, index, 0, ofs);
         break;
     case MO_SB:
-        tcg_out_modrm_sib_offset(s, OPC_MOVSBL + P_REXW + seg, datalo,
+        tcg_out_modrm_sib_offset(s, OPC_MOVSBL + rexw + seg, datalo,
                                  base, index, 0, ofs);
         break;
     case MO_UW:
@@ -1871,14 +1872,15 @@ static void tcg_out_qemu_ld_direct(TCGContext *s, TCGReg datalo, TCGReg datahi,
         if (use_movbe) {
             tcg_out_modrm_sib_offset(s, OPC_MOVBE_GyMy + P_DATA16 + seg,
                                      datalo, base, index, 0, ofs);
-            tcg_out_ext16s(s, datalo, datalo, P_REXW);
-        } else {
-            tcg_out_modrm_sib_offset(s, OPC_MOVSWL + P_REXW + seg,
+            tcg_out_ext16s(s, datalo, datalo, rexw);
+        } else if (use_bswap) {
+            tcg_out_modrm_sib_offset(s, OPC_MOVSWL + seg,
+                                     datalo, base, index, 0, ofs);
+            tcg_out_rolw_8(s, datalo);
+            tcg_out_ext16s(s, datalo, datalo, rexw);
+        } else {
+            tcg_out_modrm_sib_offset(s, OPC_MOVSWL + rexw + seg,
                                      datalo, base, index, 0, ofs);
-            if (use_bswap) {
-                tcg_out_rolw_8(s, datalo);
-                tcg_out_ext16s(s, datalo, datalo, P_REXW);
-            }
         }
         break;
     case MO_UL:
@@ -2004,7 +2006,7 @@ static void tcg_out_qemu_ld(TCGContext *s, const TCGArg *args, bool is64)
         }
 
         tcg_out_qemu_ld_direct(s, datalo, datahi,
-                               base, index, offset, seg, opc);
+                               base, index, offset, seg, is64, opc);
     }
 #endif
 }
@@ -2202,7 +2204,7 @@ static tcg_insn_unit *tcg_out_qemu_ldst_ool(TCGContext *s, bool is_ld,
 
     /* TLB Hit.  */
     if (is_ld) {
-        tcg_out_qemu_ld_direct(s, datalo, datahi, base, -1, 0, 0, opc);
+        tcg_out_qemu_ld_direct(s, datalo, datahi, base, -1, 0, 0, is_64, opc);
     } else {
         tcg_out_qemu_st_direct(s, datalo, datahi, base, 0, 0, opc);
     }
-- 
2.17.2


