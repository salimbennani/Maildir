Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 08:28:53 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga001.fm.intel.com (fmsmga001.fm.intel.com [10.253.24.23])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 1E8AF58040F
	for <like.xu@linux.intel.com>; Thu, 22 Nov 2018 07:14:20 -0800 (PST)
Received: from fmsmga103.fm.intel.com ([10.1.193.90])
  by fmsmga001-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 22 Nov 2018 07:14:20 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3ASLhMBBVlQRz+NHYrHol1+mdJIUrV8LGtZVwlr6E/?=
 =?us-ascii?q?grcLSJyIuqrYbRyFt8tkgFKBZ4jH8fUM07OQ7/iwHzRYqb+681k6OKRWUBEEjc?=
 =?us-ascii?q?hE1ycBO+WiTXPBEfjxciYhF95DXlI2t1uyMExSBdqsLwaK+i764jEdAAjwOhRo?=
 =?us-ascii?q?LerpBIHSk9631+ev8JHPfglEnjWwba9xIRmssQndqtQdjJd/JKo21hbHuGZDdf?=
 =?us-ascii?q?5MxWNvK1KTnhL86dm18ZV+7SleuO8v+tBZX6nicKs2UbJXDDI9M2Ao/8LrrgXM?=
 =?us-ascii?q?TRGO5nQHTGoblAdDDhXf4xH7WpfxtTb6tvZ41SKHM8D6Uaw4VDK/5KpwVhTmlD?=
 =?us-ascii?q?kIOCI48GHPi8x/kqRboA66pxdix4LYeZyZOOZicq/Ye94RWGhPUdtLVyFZDYy8?=
 =?us-ascii?q?YYkAAeoPM+hbsYfyu0YArQO8CAeuC+7j1zFFimPo0q0hyOkhDR3K0RY8E94SrH?=
 =?us-ascii?q?jZrtP4P7oSX+Cvy6nIyC3OYe5K2Tjj5ojHaBYhofaRVrxxa8XR00guGBnfjlqO?=
 =?us-ascii?q?rYzlOyma3fkKvmiA4OpvT/ivim89pAFrvDei3d0shZfUiYIV0F/E6T91z5oyJd?=
 =?us-ascii?q?29UUN2Z8OvHphItyyCKYd6XsAvT3t1tConybAKo4C3cSYKxZg92hLSaeSLf5aU?=
 =?us-ascii?q?7h/nTuqcIjd1iGh4dL++hhu+60mtx+z6W8KpylhFtDBFncPJtn0V1xzc9MyHSv?=
 =?us-ascii?q?xl80el2DaPzBzT6vpeLUA7k6rbNoQtwrkqlpocqUjDHyn2l1vqjKKOaEko5uul?=
 =?us-ascii?q?5/76brn7pZKQLZF4hw/+P6g0h8CyA/w0Mg0UUGia/eS82qfj/Ur8QLhSl/05jK?=
 =?us-ascii?q?zZsI3DKcsGuKG5HRFa0oI65xmkCDemzdIYkmUZI1Jefx6Hi4npO1LQL/ziAva/?=
 =?us-ascii?q?nkyhkDNqx/DAI73gDY/BLnnFkLf9Y7l971RQxxY0zdBa/J9UDLYBIPT8Wk/3qd?=
 =?us-ascii?q?zUFBg5Mxa7w+r/EtVyypseWX6TAq+eKK7StV6I5uExLOWWa44VpS3wK/wk5/7o?=
 =?us-ascii?q?kH84lkURfaiv3ZsLdn+4Gu5qLFmeYXrp0Z88F3wXtF8+UPDykw/FFjpSfGqpGa?=
 =?us-ascii?q?Q74D49FcShF4iEQ4mshLmI2mC8BoFXYWZdTUmBFGqte4iaVvNfVSSJP8U0lzUF?=
 =?us-ascii?q?UaSmGZYs0AzruALkxr4iNOfN5yADqbrl09564fCVkgs9oidpBcaQ2H3YUmdvg2?=
 =?us-ascii?q?kTTCU31q0snUso5VqZ3eBYhPJWENVV4bsdUR0zJZPY5/Z3B9D7RkTKedLfG3i8?=
 =?us-ascii?q?RdDzOi08QNs3xJchalxvEs+vihTKl36xDLYPhbWRCbQu/67c1mS3LMF4nSWVnJ?=
 =?us-ascii?q?I9hkUrF5McfVatgbRyok2KX9bE?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AlAADdxvZbhxHrdtBiHgEGBwaBUQkLA?=
 =?us-ascii?q?YEwgk8Tg3iId4sigg16iB6OIoFxFhgUiFIiNAkNAQMBAQEBAQECARMBAQEKCwk?=
 =?us-ascii?q?IKS+CNgUCAxoBBoJbAQEBAQIBAQIgIwopAwMBAgYBAQoLAwoCAiIEAgIDAR4SA?=
 =?us-ascii?q?QUBHAYTBYMcgXUFCAEEngk8iw2BL4okEnmKfheBQD+BEYJdNYgCglcCixGUcQm?=
 =?us-ascii?q?RLxiRCJghDyGBJYINcBVsBoI1kFtAMYEHil2BdwEB?=
X-IPAS-Result: =?us-ascii?q?A0AlAADdxvZbhxHrdtBiHgEGBwaBUQkLAYEwgk8Tg3iId4s?=
 =?us-ascii?q?igg16iB6OIoFxFhgUiFIiNAkNAQMBAQEBAQECARMBAQEKCwkIKS+CNgUCAxoBB?=
 =?us-ascii?q?oJbAQEBAQIBAQIgIwopAwMBAgYBAQoLAwoCAiIEAgIDAR4SAQUBHAYTBYMcgXU?=
 =?us-ascii?q?FCAEEngk8iw2BL4okEnmKfheBQD+BEYJdNYgCglcCixGUcQmRLxiRCJghDyGBJ?=
 =?us-ascii?q?YINcBVsBoI1kFtAMYEHil2BdwEB?=
X-IronPort-AV: E=Sophos;i="5.56,266,1539673200"; 
   d="scan'208";a="52987287"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 22 Nov 2018 07:14:18 -0800
Received: from localhost ([::1]:47307 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gPqgL-0005Dl-VK
	for like.xu@linux.intel.com; Thu, 22 Nov 2018 10:14:17 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:33265)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <sgarzare@redhat.com>) id 1gPqg4-0005DW-TA
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 10:14:02 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <sgarzare@redhat.com>) id 1gPqfz-0002eH-U8
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 10:14:00 -0500
Received: from mail-io1-f66.google.com ([209.85.166.66]:35553)
	by eggs.gnu.org with esmtps (TLS1.0:RSA_AES_128_CBC_SHA1:16)
	(Exim 4.71) (envelope-from <sgarzare@redhat.com>) id 1gPqfx-0002Zj-Uz
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 10:13:54 -0500
Received: by mail-io1-f66.google.com with SMTP id u19so6853067ioc.2
	for <qemu-devel@nongnu.org>; Thu, 22 Nov 2018 07:13:52 -0800 (PST)
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
	d=1e100.net; s=20161025;
	h=x-gm-message-state:mime-version:references:in-reply-to:from:date
	:message-id:subject:to:cc;
	bh=6S67m301aIuDydvrJrZHgOvyzi3xOm/4Ifgj1nEzyZM=;
	b=Vrh+qt4uwuk65WG/j3R99qCTUCjqAHUx1VFID2wU4JiGtMBs3wyONluEjDq9jYGdbk
	ic9nlVHicbGLqlaDS3YY5AU+EV/pr9vMPlOhwuPIaHyKPps8uEyhvgBAnYkEeCd+DNRc
	ZQ3vlS2cgBRrPgjWE/Yd8sfKg8Xz0wuCPSKCiVGwWoBp1ZbQYwPWVw443/VBxJ+3okY/
	APtHs/+jKd4aHN/Yt62b/qnr96VMQBJjmNg+EwnpT1ZK8RsrCROjP1a7JL7ydhvdZHTe
	g/UO6rlPakcBMIkhisGhDhGGLcRnB1GOdAG40m12Yg3xtacxnBcvIpvhIj58vAoUcxxx
	1Y6w==
X-Gm-Message-State: AA+aEWYdVmKmBXoTDg+1RNagek9uaUttFkMjlUI7dk66QGuW9cubf5GV
	1XDUS9r7SZzWjk49w3M4QL2iuGN2GqIm2T2egFSQsQ==
X-Google-Smtp-Source: AFSGD/WPepiy7+LLfuLPd6EYj5Bwye9XEiuaS9sDDo6NarRh/BGfreSeIerHZg2JRoEazzLusGMPS/bL7gd1FqTdBdQ=
X-Received: by 2002:a6b:ac44:: with SMTP id
	v65-v6mr7742270ioe.189.1542899631879; 
	Thu, 22 Nov 2018 07:13:51 -0800 (PST)
MIME-Version: 1.0
References: <CAGxU2F658=XjoHnF6Qq5FqBZAE68BBtMFt-6HcKp_PVxTynOnw@mail.gmail.com>
	<20181119084855.uyira2lpu73mu2fo@sirius.home.kraxel.org>
	<CAGxU2F4O4aKzrJky7EFeWaHFuBKPwi_Z-j7G7m+ENRojVG_5vA@mail.gmail.com>
	<20181119130713.GB6443@stefanha-x1.localdomain>
	<20181119141543.o6xl4vfptajuksi3@sirius.home.kraxel.org>
	<CAGxU2F4kUD85FMVEAcOpWUAGF98G2KR9O8EVAkzBDmA+DkS2KA@mail.gmail.com>
	<20181120062109.eahirgygm4br3ov7@sirius.home.kraxel.org>
	<CAGxU2F64uK5oygQecZKOPpsyb--Pth9U00P_gghrtYDwQrSGtg@mail.gmail.com>
	<20181120112203.rzhhdl6hhsjf5twt@sirius.home.kraxel.org>
	<CAGxU2F4LNN1UtVJFADxm1V4eBDQ8eGSoAjPXC=X8+zSR4yd9Nw@mail.gmail.com>
	<20181122115135.funmtcql3xhrixi6@sirius.home.kraxel.org>
In-Reply-To: <20181122115135.funmtcql3xhrixi6@sirius.home.kraxel.org>
From: Stefano Garzarella <sgarzare@redhat.com>
Date: Thu, 22 Nov 2018 16:13:38 +0100
Message-ID: <CAGxU2F6462MF00_0dh_6HiFPgVyEpaRTEPJ_0-sUdg8YnhgLcw@mail.gmail.com>
To: Gerd Hoffmann <kraxel@redhat.com>
Content-Type: text/plain; charset="UTF-8"
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 2.2.x-3.x [generic]
	[fuzzy]
X-Received-From: 209.85.166.66
Subject: Re: [Qemu-devel] SeaBIOS booting time optimization
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Samuel Ortiz <sameo@linux.intel.com>,
	Rob Bradford <robert.bradford@intel.com>,
	Stefan Hajnoczi <stefanha@gmail.com>, seabios@seabios.org,
	qemu-devel@nongnu.org, Kevin OConnor <kevin@koconnor.net>,
	stephend@silicom-usa.com, Stefan Hajnoczi <stefanha@redhat.com>,
	Paolo Bonzini <pbonzini@redhat.com>, stefanb@linux.ibm.com
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

On Thu, Nov 22, 2018 at 12:51 PM Gerd Hoffmann <kraxel@redhat.com> wrote:
>
> On Thu, Nov 22, 2018 at 12:08:55PM +0100, Stefano Garzarella wrote:
> > Hi,
> > I continued to investigate how to reduce the boot time with SeaBIOS
> > and QEMU when it used with linuxboot_dma.bin (-kernel parameter).
> > I reached ~12ms with a SeaBIOS configuration (attached) where I
> > disabled debug output, all Hardware support (except SMM & MTRRs) and I
> > applied a small patch to disable VGA setup and console (attached).
>
> Is there any difference to "qemu -vga none" ?

Using both (qemu -vga none, and my patch) we are around 10.8 ms.
Note: using only the patch, Linux is still able to initialize and use the VGA.

- QEMU -vga none + SeaBIOS config (CONFIG_DEBUG_LEVEL=0, disable all
HW support except
SMM & MTRRs) + Stephen's TPM patch
 qemu_init_end: 43.675803
 fw_start: 43.865178 (+0.189375)
 fw_do_boot: 58.093161 (+14.227983)
 linux_start_boot: 59.490308 (+1.397147)
 linux_start_user: 556.782354 (+497.292046)

- QEMU -vga none + SeaBIOS config (CONFIG_DEBUG_LEVEL=0, disable all
HW support except
SMM & MTRRs, CONFIG_DISABLE_VGA=y) + Stephen's TPM patch
 qemu_init_end: 42.387412
 fw_start: 42.579257 (+0.191845)
 fw_do_boot: 53.381517 (+10.802260)
 linux_start_boot: 54.848643 (+1.467126)
 linux_start_user: 498.517050 (+443.668407)

>
> > Samuel, I put also the total time to userspace (linux_start_user)
> > adding a probe in the kernel_init() and when I disabled the VGA in the
> > SeaBIOS I noticed also a speed up in the kernel boot phase.
>
> Might come from linux 16bit boot code scanning vgabios for available
> video modes (for vga=<mode> cmdline arg).
>
> > Another approach that I tried, obtaining similar results, is to
> > recognize the linuxboot_dma.bin at runtime, then skip
> > device_hardware_setup(), enable_vga_console(), and vgarom_setup().
>
> Hmm, tricky.
>"
> linuxboot_dma.bin just registers a boot entry, so with "qemu -kernel
> -boot menu=on" you can still get a boot menu, and the direkt kernel boot
> is one menu item there.  So you can't know for sure whenever a direct
> kernel boot will happen or not.
>
> So, I think at minimum we should make this depend on both linuxboot_dma
> and boot menu disabled.

You are right! I'll prepare a patch adding the check of boot menu.

Thanks,
Stefano

>
> cheers,
>   Gerd
>


--
Stefano Garzarella
Red Hat

