Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 12:22:58 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga001.jf.intel.com (orsmga001.jf.intel.com [10.7.209.18])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 5E771580460
	for <like.xu@linux.intel.com>; Thu, 22 Nov 2018 19:20:36 -0800 (PST)
Received: from orsmga106.jf.intel.com ([10.7.208.65])
  by orsmga001-1.jf.intel.com with ESMTP; 22 Nov 2018 19:20:36 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AON7TYRVUQ3l3YDTDzHnV9VlSLHbV8LGtZVwlr6E/?=
 =?us-ascii?q?grcLSJyIuqrYbRyAt8tkgFKBZ4jH8fUM07OQ7/iwHzRYqb+681k6OKRWUBEEjc?=
 =?us-ascii?q?hE1ycBO+WiTXPBEfjxciYhF95DXlI2t1uyMExSBdqsLwaK+i764jEdAAjwOhRo?=
 =?us-ascii?q?LerpBIHSk9631+ev8JHPfglEnjWwba9xIRmssQndqtQdjJd/JKo21hbHuGZDdf?=
 =?us-ascii?q?5MxWNvK1KTnhL86dm18ZV+7SleuO8v+tBZX6nicKs2UbJXDDI9M2Ao/8LrrgXM?=
 =?us-ascii?q?TRGO5nQHTGoblAdDDhXf4xH7WpfxtTb6tvZ41SKHM8D6Uaw4VDK/5KpwVhTmlD?=
 =?us-ascii?q?kIOCI48GHPi8x/kqRboA66pxdix4LYeZyZOOZicq/Ye94RWGhPUdtLVyFZHI28?=
 =?us-ascii?q?YYsBAekPM+lWoIbypUcBoxSjCwm0Bu7hyDBFimL40KEmzeshChrL3BAiEt8UrH?=
 =?us-ascii?q?jYsNv4OaUUXOuozKfI1zLDb/ZO1Df48ofIdREgoPGRVr93dMre004vFgLFjlWX?=
 =?us-ascii?q?r4zlMDOU1uUWvmeH6upgTvmvh3Q7pAFxozivwN0jiozOho0Oy1DE8Tt2zJwpKt?=
 =?us-ascii?q?2/TU52eNipG4ZTuSGCL4Z6XN8uTmJytCon17ELuoS3cDYExZkn3RLTdv6Kf5CW?=
 =?us-ascii?q?7h79SeqdOyp0iXBkdb6lhhu/8FKsx+7hWsSyzV1EtDBKksPWuXAIzxHT6taISv?=
 =?us-ascii?q?96/kq53TaP1hvT6v1fIUwumqrbLYMhzqQ3lpoJvkTPBi72mEPog6+Kbkgo5PSk?=
 =?us-ascii?q?5uf9brn7u5ORNJV4hh/wP6kugMCzHOY1PhALX2eB+OS80LPj/Vf+QLVPlvA2i7?=
 =?us-ascii?q?fWsJXHJcgCu6G2HRFV3Zgn6xqmFDim18kYnX8bI11bYxKLiIzpO1DNIP/mF/u+?=
 =?us-ascii?q?jEmsnS9vx/DHOL3hH5rMImLCkLfnYbZy9UpcxBAvwtBY4pJZEbcBIPX1Wk/+st?=
 =?us-ascii?q?zYEwU1Mwuuw+boENl9zJ8RWXqTAq+FN6PfqVuI5uMsI+aSfoMUtyv9JuMh5/7v?=
 =?us-ascii?q?i385hFAccbOo3ZsRdHC3APBmL1+Fbnrrh9dSWVoMpRc0Gez2lEWZA3kUY3epQ7?=
 =?us-ascii?q?l64DY9B4S7S4DZSceoib2F2S69WZpOemFBDEvLCHrtasCIVukBbHGvJNR8mGkB?=
 =?us-ascii?q?XLmlV4hzzByrqUr2xqRqKq/O9zQFuIn//N5y4eLViFc17zMjFNmX0WyGUzRpmH?=
 =?us-ascii?q?gVTSQ9xqF1rB9BzQKu3bVxmfBfXfxa7fBOSRtyYZPcxuZ5DMvuchjMcteAVBCt?=
 =?us-ascii?q?RdDwUh8rSddkxtYJcVc1T9CriQLD2CylEr49nLmQH9o/8qPa1n32Lcd5xjDN06?=
 =?us-ascii?q?x33ApueddGKWDz3v03zAPUHYOc1hzBz6s=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AnAACgcfdbhxHrdtBiHgEGBwaBUQkLA?=
 =?us-ascii?q?YEwgTyBJoN5iHeNCCWSRIR3gXMUGBSIUiI0CQ0BAwEBAQEBAQIBEwEBAQoLCQg?=
 =?us-ascii?q?pL4I2BQIDGgEGglsBAQEBAgEBAiAEEQ4KEBkDAgEBAgYBAQoOCgICIgQCAgMBU?=
 =?us-ascii?q?wYNBgIBAQGDHIF1BQcBAQSnPnwzhUCEWYELgSOJWxeBP0CBEScMgl+IAoJXAok?=
 =?us-ascii?q?ZCoV2QzNPhFiKTAmDCIchhwAGGIlhhyeYMIFGgg1wgzyCJxcSjhdlgQeKXoF3A?=
 =?us-ascii?q?QE?=
X-IPAS-Result: =?us-ascii?q?A0AnAACgcfdbhxHrdtBiHgEGBwaBUQkLAYEwgTyBJoN5iHe?=
 =?us-ascii?q?NCCWSRIR3gXMUGBSIUiI0CQ0BAwEBAQEBAQIBEwEBAQoLCQgpL4I2BQIDGgEGg?=
 =?us-ascii?q?lsBAQEBAgEBAiAEEQ4KEBkDAgEBAgYBAQoOCgICIgQCAgMBUwYNBgIBAQGDHIF?=
 =?us-ascii?q?1BQcBAQSnPnwzhUCEWYELgSOJWxeBP0CBEScMgl+IAoJXAokZCoV2QzNPhFiKT?=
 =?us-ascii?q?AmDCIchhwAGGIlhhyeYMIFGgg1wgzyCJxcSjhdlgQeKXoF3AQE?=
X-IronPort-AV: E=Sophos;i="5.56,268,1539673200"; 
   d="scan'208";a="41256143"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 22 Nov 2018 19:20:17 -0800
Received: from localhost ([::1]:50199 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gQ20v-0003F6-4s
	for like.xu@linux.intel.com; Thu, 22 Nov 2018 22:20:17 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:60225)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <maozhongyi@cmss.chinamobile.com>) id 1gQ20a-0003Dz-8c
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 22:19:59 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <maozhongyi@cmss.chinamobile.com>) id 1gQ1rm-000563-Ur
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 22:10:54 -0500
Received: from cmccmta3.chinamobile.com ([221.176.66.81]:21650)
	by eggs.gnu.org with esmtp (Exim 4.71)
	(envelope-from <maozhongyi@cmss.chinamobile.com>) id 1gQ1rm-0004m4-8S
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 22:10:50 -0500
Received: from spf.mail.chinamobile.com (unknown[172.16.121.5]) by
	rmmx-syy-dmz-app09-12009 (RichMail) with SMTP id
	2ee95bf76fb1d81-efe25; Fri, 23 Nov 2018 11:10:41 +0800 (CST)
X-RM-TRANSID: 2ee95bf76fb1d81-efe25
X-RM-TagInfo: emlType=0                                       
X-RM-SPAM-FLAG: 00000000
Received: from [172.20.21.154] (unknown[112.25.154.149])
	by rmsmtp-syy-appsvr03-12003 (RichMail) with SMTP id
	2ee35bf76fafaee-81444; Fri, 23 Nov 2018 11:10:41 +0800 (CST)
X-RM-TRANSID: 2ee35bf76fafaee-81444
To: Eduardo Habkost <ehabkost@redhat.com>
References: <20181119120820.29878-1-maozhongyi@cmss.chinamobile.com>
	<20181119120820.29878-23-maozhongyi@cmss.chinamobile.com>
	<20181119233139.GO3807@habkost.net>
From: maozy <maozhongyi@cmss.chinamobile.com>
Message-ID: <bb601691-a96d-8968-bb5b-0b15757285f6@cmss.chinamobile.com>
Date: Fri, 23 Nov 2018 11:10:40 +0800
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101
	Thunderbird/60.0
MIME-Version: 1.0
In-Reply-To: <20181119233139.GO3807@habkost.net>
Content-Type: text/plain; charset=utf-8; format=flowed
Content-Language: en-US
Content-Transfer-Encoding: 7bit
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 3.x [fuzzy]
X-Received-From: 221.176.66.81
Subject: Re: [Qemu-devel] [PATCH 22/22] core/sysbus: remove the
 SysBusDeviceClass::initpath
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: peter.maydell@linaro.org, thuth@redhat.com, richard.henderson@linaro.org,
	qemu-devel@nongnu.org, armbru@redhat.com,
	alistair.francis@wdc.com, pbonzini@redhat.com,
	Zhang Shengju <zhangshengju@cmss.chinamobile.com>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

Hi, Eduardo

On 11/20/18 7:31 AM, Eduardo Habkost wrote:
> On Mon, Nov 19, 2018 at 08:08:20PM +0800, Mao Zhongyi wrote:
>> Currently, all sysbus devices have been converted to realize(),
>> so remove this path.
>>
>> Cc: ehabkost@redhat.com
>> Cc: thuth@redhat.com
>> Cc: pbonzini@redhat.com
>> Cc: armbru@redhat.com
>> Cc: peter.maydell@linaro.org
>> Cc: richard.henderson@linaro.org
>> Cc: alistair.francis@wdc.com
>>
>> Signed-off-by: Mao Zhongyi <maozhongyi@cmss.chinamobile.com>
>> Signed-off-by: Zhang Shengju <zhangshengju@cmss.chinamobile.com>
>> ---
>>   hw/core/sysbus.c    | 15 ---------------
>>   include/hw/sysbus.h |  3 ---
>>   2 files changed, 18 deletions(-)
>>
>> diff --git a/hw/core/sysbus.c b/hw/core/sysbus.c
>> index 7ac36ad3e7..030ad426c1 100644
>> --- a/hw/core/sysbus.c
>> +++ b/hw/core/sysbus.c
>> @@ -201,20 +201,6 @@ void sysbus_init_ioports(SysBusDevice *dev, uint32_t ioport, uint32_t size)
>>       }
>>   }
>>   
>> -/* TODO remove once all sysbus devices have been converted to realize */
>> -static void sysbus_realize(DeviceState *dev, Error **errp)
>> -{
>> -    SysBusDevice *sd = SYS_BUS_DEVICE(dev);
>> -    SysBusDeviceClass *sbc = SYS_BUS_DEVICE_GET_CLASS(sd);
>> -
>> -    if (!sbc->init) {
>> -        return;
>> -    }
>> -    if (sbc->init(sd) < 0) {
>> -        error_setg(errp, "Device initialization failed");
>> -    }
>> -}
> 
> Nice.  :)
> 
> 
>> -
>>   DeviceState *sysbus_create_varargs(const char *name,
>>                                      hwaddr addr, ...)
>>   {
>> @@ -327,7 +313,6 @@ MemoryRegion *sysbus_address_space(SysBusDevice *dev)
>>   static void sysbus_device_class_init(ObjectClass *klass, void *data)
>>   {
>>       DeviceClass *k = DEVICE_CLASS(klass);
>> -    k->realize = sysbus_realize;
> 
> Have you ensured this won't break any subclasses that
> saved the original realize function on a parent_realize field?

Thanks for the catch.

> Now they will have parent_realize set to NULL.

In order to void the subclasses whose parent_realize field is
set to NULL, the k->realize function must be retained even
though it doesn't do anything practical. Just like this:


-/* TODO remove once all sysbus devices have been converted to realize*/
  static void sysbus_realize(DeviceState *dev, Error **errp)
  {
-    SysBusDevice *sd = SYS_BUS_DEVICE(dev);
-    SysBusDeviceClass *sbc = SYS_BUS_DEVICE_GET_CLASS(sd);
-
-    if (!sbc->init) {
-        return;
-    }
-    if (sbc->init(sd) < 0) {
-        error_setg(errp, "Device initialization failed");
-    }
  }

it doesn't look elegant, but I didn't think of a better way, if you
can give me some hints, I really appreciate it. :)

Thanks,
Mao


> 
> Most of them use device_class_set_parent_realize() to implement
> that.
> 
>>       k->bus_type = TYPE_SYSTEM_BUS;
>>       /*
>>        * device_add plugs devices into a suitable bus.  For "real" buses,
>> diff --git a/include/hw/sysbus.h b/include/hw/sysbus.h
>> index 0b59a3b8d6..1aedcf05c9 100644
>> --- a/include/hw/sysbus.h
>> +++ b/include/hw/sysbus.h
>> @@ -38,9 +38,6 @@ typedef struct SysBusDevice SysBusDevice;
>>   typedef struct SysBusDeviceClass {
>>       /*< private >*/
>>       DeviceClass parent_class;
>> -    /*< public >*/
>> -
>> -    int (*init)(SysBusDevice *dev);
>>   
>>       /*
>>        * Let the sysbus device format its own non-PIO, non-MMIO unit address.
>> -- 
>> 2.17.1
>>
>>
>>
> 



