Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 22 Nov 2018 22:27:33 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga008.jf.intel.com (orsmga008.jf.intel.com [10.7.209.65])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 86C2558037D
	for <like.xu@linux.intel.com>; Thu, 22 Nov 2018 06:16:57 -0800 (PST)
Received: from orsmga106.jf.intel.com ([10.7.208.65])
  by orsmga008-1.jf.intel.com with ESMTP; 22 Nov 2018 06:16:57 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3A01dpVBVbe2LLQnMlQm9k9kYwS3fV8LGtZVwlr6E/?=
 =?us-ascii?q?grcLSJyIuqrYbBOEt8tkgFKBZ4jH8fUM07OQ7/iwHzRYqb+681k6OKRWUBEEjc?=
 =?us-ascii?q?hE1ycBO+WiTXPBEfjxciYhF95DXlI2t1uyMExSBdqsLwaK+i764jEdAAjwOhRo?=
 =?us-ascii?q?LerpBIHSk9631+ev8JHPfglEnjWwba9xIRmssQndqtQdjJd/JKo21hbHuGZDdf?=
 =?us-ascii?q?5MxWNvK1KTnhL86dm18ZV+7SleuO8v+tBZX6nicKs2UbJXDDI9M2Ao/8LrrgXM?=
 =?us-ascii?q?TRGO5nQHTGoblAdDDhXf4xH7WpfxtTb6tvZ41SKHM8D6Uaw4VDK/5KptVRTmij?=
 =?us-ascii?q?oINyQh/W/XlMJ+gqFVrxCvpxJi247ZYoObOfVjcq7TYd8VW3FBU91NWyBdGI6w?=
 =?us-ascii?q?c5cDA/YdMetesoLzp0EOrRy7BQS0CuLg1DBJhmLt0K0gzesuDAHG0xY8H94UrH?=
 =?us-ascii?q?vUq9D1OaEPWu621KnF1SvPY+9V1Dvn9YTEbxMsreuSUb9+ccfd01QjGgHdglmO?=
 =?us-ascii?q?tYDoOymZ2vkDvmSF9eZsSOGihmA9pw1voTWiwNonhJPTiYIP0F/E8D10wIYrKt?=
 =?us-ascii?q?28T052edqkEJpLtyGGLIt6WMwiQ2d1uCogzb0Go5G7cDALyJQh2RHfd+SKf5aU?=
 =?us-ascii?q?7h/gTuqdPCp0iXF/dL6hiRu/8VKsxvD+W8Ws1VZFtCtFkt3CtnAX0BzT79CKSu?=
 =?us-ascii?q?Jj8UekxDaDzh3c5f9aIU8qkarXMoUuwrktlpoVrUvMADT2lELyjK+XdUUr5PKk?=
 =?us-ascii?q?6uv6Yrj+op+cNol0ihzxM6g0m8y/B/g4PRYKX2SB5eu807jj8Fb/QLVNiP02na?=
 =?us-ascii?q?/ZsI3AKcQcvK65DBdZ0pw/5BanEzemzNMYkGEDLFJEexKIkZLlOl7TIP3jCfe/?=
 =?us-ascii?q?glKskCpkxvzcP73hBInNIWbHkLv7Ybl97Etcm0IOy8tC7cdUFq0ZO6C0HUvwr8?=
 =?us-ascii?q?DDSBk+NQOy3qDgEto604ofXWeGBOieKL/TtlmTofsiJvTJaIILtTKuFv4++vS7?=
 =?us-ascii?q?iHY4nUMaL7Ck2IZSZH2mE/AjOUiAfHf3nv8HFmEFuBd4S/bl30afWzxebGrnQq?=
 =?us-ascii?q?Qn+zsgA5inB4qQeof4grWa2ziyGJJ+fG1KClmQV3zvcsHMQvoJdWeeL9FslhQC?=
 =?us-ascii?q?Ur6uTZJn0guh5yHgzL8yMefE5wUCuJ7j3cQz7OrWxkJ6ziB9E8nIizLFdGpzhG?=
 =?us-ascii?q?5dHzI=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AYAAAwufZbhxHrdtBiHQEBBQEHBQGBU?=
 =?us-ascii?q?QgBCwGBMIJijBBfiyKCDZc6gXMUGBSIUiI0CQ0BAwEBAQEBAQIBEwEBAQoLCQg?=
 =?us-ascii?q?pL4I2BQIDGAmCXAMDAQIkHwopAwMBAgYBAR8pCAMBUwcSBYMcggIBBKplM4h6g?=
 =?us-ascii?q?SyJRYJEF4F/jnwCkBCPcgmRLwIWiVGHN5gwgUaCDXCDPIInF446IzGBBxyKQYF?=
 =?us-ascii?q?3AQE?=
X-IPAS-Result: =?us-ascii?q?A0AYAAAwufZbhxHrdtBiHQEBBQEHBQGBUQgBCwGBMIJijBB?=
 =?us-ascii?q?fiyKCDZc6gXMUGBSIUiI0CQ0BAwEBAQEBAQIBEwEBAQoLCQgpL4I2BQIDGAmCX?=
 =?us-ascii?q?AMDAQIkHwopAwMBAgYBAR8pCAMBUwcSBYMcggIBBKplM4h6gSyJRYJEF4F/jnw?=
 =?us-ascii?q?CkBCPcgmRLwIWiVGHN5gwgUaCDXCDPIInF446IzGBBxyKQYF3AQE?=
X-IronPort-AV: E=Sophos;i="5.56,266,1539673200"; 
   d="scan'208";a="41196284"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 22 Nov 2018 06:16:56 -0800
Received: from localhost ([::1]:46939 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gPpmq-0003z9-5q
	for like.xu@linux.intel.com; Thu, 22 Nov 2018 09:16:56 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:36987)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <wexu@redhat.com>) id 1gPph5-0007DL-Vb
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 09:11:01 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <wexu@redhat.com>) id 1gPph3-00010z-T5
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 09:10:59 -0500
Received: from mx1.redhat.com ([209.132.183.28]:52320)
	by eggs.gnu.org with esmtps (TLS1.0:DHE_RSA_AES_256_CBC_SHA1:32)
	(Exim 4.71) (envelope-from <wexu@redhat.com>) id 1gPph3-0000w4-JT
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 09:10:57 -0500
Received: from smtp.corp.redhat.com (int-mx01.intmail.prod.int.phx2.redhat.com
	[10.5.11.11])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by mx1.redhat.com (Postfix) with ESMTPS id D1CC03164688;
	Thu, 22 Nov 2018 14:10:56 +0000 (UTC)
Received: from dell-per430-12.lab.eng.pek2.redhat.com
	(dell-per430-12.lab.eng.pek2.redhat.com [10.73.196.55])
	by smtp.corp.redhat.com (Postfix) with ESMTP id 063F08FC00;
	Thu, 22 Nov 2018 14:10:52 +0000 (UTC)
From: wexu@redhat.com
To: jasowang@redhat.com,
	qemu-devel@nongnu.org
Date: Thu, 22 Nov 2018 09:06:18 -0500
Message-Id: <1542895581-10721-14-git-send-email-wexu@redhat.com>
In-Reply-To: <1542895581-10721-1-git-send-email-wexu@redhat.com>
References: <1542895581-10721-1-git-send-email-wexu@redhat.com>
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.11
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
	(mx1.redhat.com [10.5.110.41]);
	Thu, 22 Nov 2018 14:10:56 +0000 (UTC)
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 2.2.x-3.x [generic]
	[fuzzy]
X-Received-From: 209.132.183.28
Subject: [Qemu-devel] [PATCH v1 13/16] virtio: add vhost-net migration of
 packed ring
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: maxime.coquelin@redhat.com, jfreimann@redhat.com, wexu@redhat.com,
	tiwei.bie@intel.com, mst@redhat.com
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

From: Wei Xu <wexu@redhat.com>

tweaked vhost-net code to test migration.

@@ -1414,64 +1430,20 @@ long vhost_vring_ioctl(struct vhost_dev
            r = -EFAULT;
            break;
        }
+               vq->last_avail_idx = s.num & 0x7FFF;
+               /* Forget the cached index value. */
+               vq->avail_idx = vq->last_avail_idx;
+               if (vhost_has_feature(vq, VIRTIO_F_RING_PACKED)) {
+                       vq->last_avail_wrap_counter = !!(s.num & 0x8000);
+                       vq->avail_wrap_counter = vq->last_avail_wrap_counter;
+
+                       vq->last_used_idx = (s.num & 0x7fFF0000) >> 16;
+                       vq->last_used_wrap_counter = !!(s.num & 0x80000000);
+               }
+               break;
+       case VHOST_GET_VRING_BASE:
+               s.index = idx;
+                s.num = vq->last_avail_idx;
+               if (vhost_has_feature(vq, VIRTIO_F_RING_PACKED)) {
+                       s.num |= vq->last_avail_wrap_counter << 15;
+                       s.num |= vq->last_used_idx << 16;
+                       s.num |= vq->last_used_wrap_counter << 31;
+               }
+               if (copy_to_user(argp, &s, sizeof(s)))
+                       r = -EFAULT;
+               break;

Signed-off-by: Wei Xu <wexu@redhat.com>
---
 hw/virtio/virtio.c         | 35 ++++++++++++++++++++++++++++++-----
 include/hw/virtio/virtio.h |  4 ++--
 2 files changed, 32 insertions(+), 7 deletions(-)

diff --git a/hw/virtio/virtio.c b/hw/virtio/virtio.c
index 64d5c04..7487d3d 100644
--- a/hw/virtio/virtio.c
+++ b/hw/virtio/virtio.c
@@ -2963,19 +2963,40 @@ hwaddr virtio_queue_get_used_size(VirtIODevice *vdev, int n)
     }
 }
 
-uint16_t virtio_queue_get_last_avail_idx(VirtIODevice *vdev, int n)
+int virtio_queue_get_last_avail_idx(VirtIODevice *vdev, int n)
 {
-    return vdev->vq[n].last_avail_idx;
+    int idx;
+
+    if (virtio_host_has_feature(vdev, VIRTIO_F_RING_PACKED)) {
+        idx = vdev->vq[n].last_avail_idx;
+        idx |= ((int)vdev->vq[n].avail_wrap_counter) << 15;
+        idx |= (vdev->vq[n].used_idx) << 16;
+        idx |= ((int)vdev->vq[n].used_wrap_counter) << 31;
+    } else {
+        idx = (int)vdev->vq[n].last_avail_idx;
+    }
+    return idx;
 }
 
-void virtio_queue_set_last_avail_idx(VirtIODevice *vdev, int n, uint16_t idx)
+void virtio_queue_set_last_avail_idx(VirtIODevice *vdev, int n, int idx)
 {
-    vdev->vq[n].last_avail_idx = idx;
-    vdev->vq[n].shadow_avail_idx = idx;
+    if (virtio_vdev_has_feature(vdev, VIRTIO_F_RING_PACKED)) {
+        vdev->vq[n].last_avail_idx = idx & 0x7fff;
+        vdev->vq[n].avail_wrap_counter = !!(idx & 0x8000);
+        vdev->vq[n].used_idx = (idx & 0x7fff0000) >> 16;
+        vdev->vq[n].used_wrap_counter = !!(idx & 0x80000000);
+    } else {
+        vdev->vq[n].last_avail_idx = idx;
+        vdev->vq[n].shadow_avail_idx = idx;
+    }
 }
 
 void virtio_queue_restore_last_avail_idx(VirtIODevice *vdev, int n)
 {
+    if (virtio_vdev_has_feature(vdev, VIRTIO_F_RING_PACKED)) {
+        return;
+    }
+
     rcu_read_lock();
     if (vdev->vq[n].vring.desc) {
         vdev->vq[n].last_avail_idx = vring_used_idx(&vdev->vq[n]);
@@ -2986,6 +3007,10 @@ void virtio_queue_restore_last_avail_idx(VirtIODevice *vdev, int n)
 
 void virtio_queue_update_used_idx(VirtIODevice *vdev, int n)
 {
+    if (virtio_vdev_has_feature(vdev, VIRTIO_F_RING_PACKED)) {
+        return;
+    }
+
     rcu_read_lock();
     if (vdev->vq[n].vring.desc) {
         vdev->vq[n].used_idx = vring_used_idx(&vdev->vq[n]);
diff --git a/include/hw/virtio/virtio.h b/include/hw/virtio/virtio.h
index 9c1fa07..a6fdf3f 100644
--- a/include/hw/virtio/virtio.h
+++ b/include/hw/virtio/virtio.h
@@ -272,8 +272,8 @@ hwaddr virtio_queue_get_used_addr(VirtIODevice *vdev, int n);
 hwaddr virtio_queue_get_desc_size(VirtIODevice *vdev, int n);
 hwaddr virtio_queue_get_avail_size(VirtIODevice *vdev, int n);
 hwaddr virtio_queue_get_used_size(VirtIODevice *vdev, int n);
-uint16_t virtio_queue_get_last_avail_idx(VirtIODevice *vdev, int n);
-void virtio_queue_set_last_avail_idx(VirtIODevice *vdev, int n, uint16_t idx);
+int virtio_queue_get_last_avail_idx(VirtIODevice *vdev, int n);
+void virtio_queue_set_last_avail_idx(VirtIODevice *vdev, int n, int idx);
 void virtio_queue_restore_last_avail_idx(VirtIODevice *vdev, int n);
 void virtio_queue_invalidate_signalled_used(VirtIODevice *vdev, int n);
 void virtio_queue_update_used_idx(VirtIODevice *vdev, int n);
-- 
1.8.3.1


