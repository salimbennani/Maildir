Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 08:30:10 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from FMSMGA003.fm.intel.com (fmsmga003.fm.intel.com [10.253.24.29])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id E4AC458037D
	for <like.xu@linux.intel.com>; Thu, 22 Nov 2018 09:16:14 -0800 (PST)
Received: from fmsmga104.fm.intel.com ([10.1.193.100])
  by FMSMGA003-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 22 Nov 2018 09:16:14 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AlHTJmB1WzWHjDfQNsmDT+DRfVm0co7zxezQtwd8Z?=
 =?us-ascii?q?seMRLvad9pjvdHbS+e9qxAeQG9mDu7Qc06L/iOPJYSQ4+5GPsXQPItRndiQuro?=
 =?us-ascii?q?EopTEmG9OPEkbhLfTnPGQQFcVGU0J5rTngaRAGUMnxaEfPrXKs8DUcBgvwNRZv?=
 =?us-ascii?q?JuTyB4Xek9m72/q99pHPYAhEniaxba9vJxiqsAvdsdUbj5F/Iagr0BvJpXVIe+?=
 =?us-ascii?q?VSxWx2IF+Yggjx6MSt8pN96ipco/0u+dJOXqX8ZKQ4UKdXDC86PGAv5c3krgfM?=
 =?us-ascii?q?QA2S7XYBSGoWkx5IAw/Y7BHmW5r6ryX3uvZh1CScIMb7Vq4/Vyi84Kh3SR/okC?=
 =?us-ascii?q?YHOCA/8GHLkcx7kaZXrAu8qxBj34LYZYeYP+d8cKzAZ9MXXWRBUchRWSJfAIyy?=
 =?us-ascii?q?YYgBAOUdMuhXsof9v1kDoxmxCAWxCu7j1iFHhmTt0K0myuQsCx3K0BA6Et8Mtn?=
 =?us-ascii?q?nfsdX7NL0VUeCw1KTF0THDYO1Z2Dzg9YXHbBYhofeWWr1ubMHczlMgFwfbgVSf?=
 =?us-ascii?q?s4DqJC2a1uILs2eF8eVtTuavi28hqw5ruDivwd0gio7ThoIa013J8zhyzoUtJd?=
 =?us-ascii?q?CgVkJ3fd2pHIFNuy2HNIZ6WN0uTm9otSog17ELu4a3cSsXxJg92hLTdf+Kf5KV?=
 =?us-ascii?q?7h/gVOudOzl1iX1jdbminRi961Kgxff5VsSs0FZFsC5Fkt7Uu3AJ1hzT8dSHSu?=
 =?us-ascii?q?Bn8keu3zaPyhrf6uZeIUA7jabbKpghzaAslpcLr0jPAiz7lF/rgKOLdUgo4Pak?=
 =?us-ascii?q?5urnb7n8u5ORNZd4igTkPaQvnsy/D/44Mg8LX2WD4OSzyrjj/VDgTLpXkPI2jL?=
 =?us-ascii?q?fWsJTDKcsAoa65HglV3Zo95BakCDum1NUYnXoZI15fdxOHkpDkO1XPIPD+EPe+?=
 =?us-ascii?q?jE6gkDZtx/DaILLhBo/BIWTEkLfkZrt97UlcyAw8zdBZ+pJYELYBIOj8WkPprt?=
 =?us-ascii?q?zXEgc5MxCow+bgENh90oIeWWGRDaODP6LSrESF5uYuI+mKeY8UtyzxK/kj5/7y?=
 =?us-ascii?q?k3A5nUURcrWu3ZsSOziFGO97KRCZfWb0mYVGVmMLpRYlCurtjlKETHhUfXn1Wq?=
 =?us-ascii?q?s94jQyDsWhFZvCQYa2x6WM2Tr+EpBIa2QVN1aXDH29coyFX+sLOjufJ9IknjEa?=
 =?us-ascii?q?WLzkUYI4yBy1qCf8zLxoKPeS/TcX4on+3tp47PGGiBcp6DZvBN6c2Wzec2Yh1E?=
 =?us-ascii?q?4NRjs32+hQ5wRWzUuKm+AsiPtEHPRZ/fpASkE9L5GKnMJgDNWncwbMbp+jRVCg?=
 =?us-ascii?q?w9juVTg1Q8J3ydIIZUtwM9GjiBnZ2GytGbBDxO/DP4A97q+Jhyu5HM160XuTkf?=
 =?us-ascii?q?B511Q=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AYAAD24vZbhxHrdtBiHgEGBwaBUQkLA?=
 =?us-ascii?q?YEwgmKDeIh3iyKCDZc6gXEUAQEYFIRAhBIiNAkNAQMBAQEBAQECARMBAQEKCwk?=
 =?us-ascii?q?IKSMMgjYFAgMaAQaCXAECAgEBAiAdAQEECikBAgIBAQIGAQEKGgIFHQQCAgMBC?=
 =?us-ascii?q?wEkAQUBARsGEwWDHIF6CAEDAZ1/PIodcIEvgnYBAQWCQ4NSgQUIEhBpiWKBHII?=
 =?us-ascii?q?WgwGBIoR+gwSCV4klll8HApEvGIlRhzcsl10GAgkHDyGBJYINM0qDL4IbiQGFP?=
 =?us-ascii?q?nKBB4oJKymBdwEB?=
X-IPAS-Result: =?us-ascii?q?A0AYAAD24vZbhxHrdtBiHgEGBwaBUQkLAYEwgmKDeIh3iyK?=
 =?us-ascii?q?CDZc6gXEUAQEYFIRAhBIiNAkNAQMBAQEBAQECARMBAQEKCwkIKSMMgjYFAgMaA?=
 =?us-ascii?q?QaCXAECAgEBAiAdAQEECikBAgIBAQIGAQEKGgIFHQQCAgMBCwEkAQUBARsGEwW?=
 =?us-ascii?q?DHIF6CAEDAZ1/PIodcIEvgnYBAQWCQ4NSgQUIEhBpiWKBHIIWgwGBIoR+gwSCV?=
 =?us-ascii?q?4klll8HApEvGIlRhzcsl10GAgkHDyGBJYINM0qDL4IbiQGFPnKBB4oJKymBdwE?=
 =?us-ascii?q?B?=
X-IronPort-AV: E=Sophos;i="5.56,266,1539673200"; 
   d="scan'208";a="52305200"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 22 Nov 2018 09:16:14 -0800
Received: from localhost ([::1]:48037 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gPsaL-0004HJ-5q
	for like.xu@linux.intel.com; Thu, 22 Nov 2018 12:16:13 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:48169)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <alex.bennee@linaro.org>) id 1gPsZg-0004A8-6m
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 12:15:35 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <alex.bennee@linaro.org>) id 1gPsZY-0004aY-F9
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 12:15:30 -0500
Received: from mail-wm1-x32b.google.com ([2a00:1450:4864:20::32b]:33578)
	by eggs.gnu.org with esmtps (TLS1.0:RSA_AES_128_CBC_SHA1:16)
	(Exim 4.71) (envelope-from <alex.bennee@linaro.org>)
	id 1gPsZY-0004YT-6P
	for qemu-devel@nongnu.org; Thu, 22 Nov 2018 12:15:24 -0500
Received: by mail-wm1-x32b.google.com with SMTP id 79so9980310wmo.0
	for <qemu-devel@nongnu.org>; Thu, 22 Nov 2018 09:15:23 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=linaro.org; s=google;
	h=references:user-agent:from:to:cc:subject:in-reply-to:date
	:message-id:mime-version:content-transfer-encoding;
	bh=YbvK4mp3kcFj3x2ZhuDGxE6VcVcuY7PeLNDD6iO36ZQ=;
	b=WmkjWLztOSVuRkYGmgujIvXlJ4MTcRvOnPKu39IzblfRbuP/FtsCteh3iSDLGj41i+
	1Vai/Zq/Yg/Itplk1Zm2XaGj6d5D9Zly4J1gCOk7OjQoxQb8dDD4tH68Sy8HhgPbVWFj
	64XDIz87Zk/OpCTRCFZt1XCMpa3vV34P4SICc=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
	d=1e100.net; s=20161025;
	h=x-gm-message-state:references:user-agent:from:to:cc:subject
	:in-reply-to:date:message-id:mime-version:content-transfer-encoding;
	bh=YbvK4mp3kcFj3x2ZhuDGxE6VcVcuY7PeLNDD6iO36ZQ=;
	b=i138KwyHfZ6NE3q4+8PHnKQPgcREIHGWA0TiwlF9EOFnodGLWCZnBy5XVKa4eE7VFU
	vculbsWLhd6oCY6TIoA+FYXvF7t8z7kO+KeUOaOVZ7s6DOeHNLwMEKJfyF6UwDBTk7Qk
	mu9CHRBPFnqTRQS8LwXptm+MCZJr+yH6NORQm6UULYMYctkpG3RHp93/cj0jAFiddJ6+
	Jm0j+WdgJFlGleIq0FEE7y/dbiEo7KiKMM4JCSVbXh7y1f9YSDxyWXK4QyDtGHoKASTO
	2hVd0kwJ+3WgpMZpWs3VSkQTLhWfVhUJ9l5MjjQDx0+bFGf92rPCZc6xFlPuvMwPjGUd
	KrUA==
X-Gm-Message-State: AGRZ1gITG2YLUD52EChPOBX3mX+f467kGOFeRzyHvDaNaO1mCOus/E1R
	t+XXVSYPd/GKwxzwbBhdMe3bYw==
X-Google-Smtp-Source: AJdET5dqkZhojOqEiU8A2+Z+j72pb/64B+lFoK4Dey6KL+vzhLI7l/1rE4EBdjmnD1LEc8/H79+OtQ==
X-Received: by 2002:a1c:20cb:: with SMTP id g194mr10222803wmg.77.1542906921986;
	Thu, 22 Nov 2018 09:15:21 -0800 (PST)
Received: from zen.linaro.local ([81.128.185.34])
	by smtp.gmail.com with ESMTPSA id
	66-v6sm4758835wmp.28.2018.11.22.09.15.21
	(version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
	Thu, 22 Nov 2018 09:15:21 -0800 (PST)
Received: from zen (localhost [127.0.0.1])
	by zen.linaro.local (Postfix) with ESMTPS id 6621E3E016E;
	Thu, 22 Nov 2018 17:15:20 +0000 (GMT)
References: <20181025172057.20414-1-cota@braap.org>
	<20181025172057.20414-14-cota@braap.org>
User-agent: mu4e 1.1.0; emacs 26.1.90
From: Alex =?utf-8?Q?Benn=C3=A9e?= <alex.bennee@linaro.org>
To: "Emilio G. Cota" <cota@braap.org>
In-reply-to: <20181025172057.20414-14-cota@braap.org>
Date: Thu, 22 Nov 2018 17:15:20 +0000
Message-ID: <87zhu1ghjr.fsf@linaro.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Transfer-Encoding: quoted-printable
X-detected-operating-system: by eggs.gnu.org: Genre and OS details not
	recognized.
X-Received-From: 2a00:1450:4864:20::32b
Subject: Re: [Qemu-devel] [RFC 13/48] xxhash: add qemu_xxhash8
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Stefan Hajnoczi <stefanha@gmail.com>,
	Peter Maydell <peter.maydell@linaro.org>, qemu-devel@nongnu.org,
	Pavel Dovgalyuk <Pavel.Dovgaluk@ispras.ru>,
	=?utf-8?Q?Llu=C3=ADs?= Vilanova <vilanova@ac.upc.edu>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>


Emilio G. Cota <cota@braap.org> writes:

> It will be used for TB hashing soon.
>
> Signed-off-by: Emilio G. Cota <cota@braap.org>
> ---
>  include/qemu/xxhash.h | 40 +++++++++++++++++++++++++++-------------
>  1 file changed, 27 insertions(+), 13 deletions(-)
>
> diff --git a/include/qemu/xxhash.h b/include/qemu/xxhash.h
> index fe35dde328..450427eeaa 100644
> --- a/include/qemu/xxhash.h
> +++ b/include/qemu/xxhash.h
> @@ -49,7 +49,8 @@
>   * contiguous in memory.
>   */
>  static inline uint32_t
> -qemu_xxhash7(uint64_t ab, uint64_t cd, uint32_t e, uint32_t f, uint32_t =
g)
> +qemu_xxhash8(uint64_t ab, uint64_t cd, uint32_t e, uint32_t f, uint32_t =
g,
> +             uint32_t h)

As we've expanded to bigger and bigger hashes why are everything after
cd passed as 32 bit values? Isn't this just generating extra register
pressure or is the compiler smart enough to figure it out?

>  {
>      uint32_t v1 =3D QEMU_XXHASH_SEED + PRIME32_1 + PRIME32_2;
>      uint32_t v2 =3D QEMU_XXHASH_SEED + PRIME32_2;
> @@ -77,17 +78,24 @@ qemu_xxhash7(uint64_t ab, uint64_t cd, uint32_t e, ui=
nt32_t f, uint32_t g)
>      v4 =3D rol32(v4, 13);
>      v4 *=3D PRIME32_1;
>
> -    h32 =3D rol32(v1, 1) + rol32(v2, 7) + rol32(v3, 12) + rol32(v4, 18);
> -    h32 +=3D 28;
> +    v1 +=3D e * PRIME32_2;
> +    v1 =3D rol32(v1, 13);
> +    v1 *=3D PRIME32_1;
>
> -    h32 +=3D e * PRIME32_3;
> -    h32  =3D rol32(h32, 17) * PRIME32_4;
> +    v2 +=3D f * PRIME32_2;
> +    v2 =3D rol32(v2, 13);
> +    v2 *=3D PRIME32_1;
> +
> +    v3 +=3D g * PRIME32_2;
> +    v3 =3D rol32(v3, 13);
> +    v3 *=3D PRIME32_1;
>
> -    h32 +=3D f * PRIME32_3;
> -    h32  =3D rol32(h32, 17) * PRIME32_4;
> +    v4 +=3D h * PRIME32_2;
> +    v4 =3D rol32(v4, 13);
> +    v4 *=3D PRIME32_1;
>
> -    h32 +=3D g * PRIME32_3;
> -    h32  =3D rol32(h32, 17) * PRIME32_4;
> +    h32 =3D rol32(v1, 1) + rol32(v2, 7) + rol32(v3, 12) + rol32(v4, 18);
> +    h32 +=3D 32;

How do we validate we haven't broken the distribution of the original
xxhash as we've extended it?

>
>      h32 ^=3D h32 >> 15;
>      h32 *=3D PRIME32_2;
> @@ -100,23 +108,29 @@ qemu_xxhash7(uint64_t ab, uint64_t cd, uint32_t e, =
uint32_t f, uint32_t g)
>
>  static inline uint32_t qemu_xxhash2(uint64_t ab)
>  {
> -    return qemu_xxhash7(ab, 0, 0, 0, 0);
> +    return qemu_xxhash8(ab, 0, 0, 0, 0, 0);
>  }
>
>  static inline uint32_t qemu_xxhash4(uint64_t ab, uint64_t cd)
>  {
> -    return qemu_xxhash7(ab, cd, 0, 0, 0);
> +    return qemu_xxhash8(ab, cd, 0, 0, 0, 0);
>  }
>
>  static inline uint32_t qemu_xxhash5(uint64_t ab, uint64_t cd, uint32_t e)
>  {
> -    return qemu_xxhash7(ab, cd, e, 0, 0);
> +    return qemu_xxhash8(ab, cd, e, 0, 0, 0);
>  }
>
>  static inline uint32_t qemu_xxhash6(uint64_t ab, uint64_t cd, uint32_t e,
>                                      uint32_t f)
>  {
> -    return qemu_xxhash7(ab, cd, e, f, 0);
> +    return qemu_xxhash8(ab, cd, e, f, 0, 0);
> +}
> +
> +static inline uint32_t qemu_xxhash7(uint64_t ab, uint64_t cd, uint32_t e,
> +                                    uint32_t f, uint32_t g)
> +{
> +    return qemu_xxhash8(ab, cd, e, f, g, 0);
>  }
>
>  #endif /* QEMU_XXHASH_H */


--
Alex Benn=C3=A9e

