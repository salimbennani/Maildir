Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 24 Nov 2018 12:36:25 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga006.jf.intel.com (orsmga006.jf.intel.com [10.7.209.51])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 3026058037D
	for <like.xu@linux.intel.com>; Fri, 23 Nov 2018 09:12:58 -0800 (PST)
Received: from fmsmga102.fm.intel.com ([10.1.193.69])
  by orsmga006-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 09:12:58 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AHyouzhabQrfutaFwomoCSa7/LSx+4OfEezUN459i?=
 =?us-ascii?q?sYplN5qZrsu+bnLW6fgltlLVR4KTs6sC17KG9fi4EUU7or+5+EgYd5JNUxJXwe?=
 =?us-ascii?q?43pCcHRPC/NEvgMfTxZDY7FskRHHVs/nW8LFQHUJ2mPw6arXK99yMdFQviPgRp?=
 =?us-ascii?q?OOv1BpTSj8Oq3Oyu5pHfeQpFiCa+bL9oMBm6sRjau9ULj4dlNqs/0AbCrGFSe+?=
 =?us-ascii?q?RRy2NoJFaTkAj568yt4pNt8Dletuw4+cJYXqr0Y6o3TbpDDDQ7KG81/9HktQPC?=
 =?us-ascii?q?TQSU+HQRVHgdnwdSDAjE6BH6WYrxsjf/u+Fg1iSWIdH6QLYpUjm58axlVAHnhz?=
 =?us-ascii?q?sGNz4h8WHYlMpwjL5AoBm8oxBz2pPYbJ2JOPZ7eK7WYNEUSndbXstJWSxODIOy?=
 =?us-ascii?q?YZUNAOQPPuhXoJXyqVQToxumBwSiBuzixiJGi3Pqw6I6yP8sER3f3AE6A94CrG?=
 =?us-ascii?q?7ZodfzOawPUe611q7IzTDbYv5K3Tfy9ofJeQ08rP6SW7Jwd9DWxlcyHA7ClFqQ?=
 =?us-ascii?q?rZLqPjyP2usWrWeb6exgWvyxhGM8rwFxoz6vyd02ionOnI4VzUrE9SpgzYszON?=
 =?us-ascii?q?a2S1Z7bMa6HJdMtCyWLZZ6Tt4hTm1ypio3xL0LtYSmcCUI0JgqxAPTZ+aaf4SW?=
 =?us-ascii?q?4R/vTvudLDR4iX5/dr+yiBC/+lW6xOLmTMm7ylNKozJFktbSsnAN0ATe6syGSv?=
 =?us-ascii?q?tm4kehwiyD1w/V6uFZO0w0krDbK5E5zr4xkJocr1jDEzfolEnqj6KabFgo9vWr?=
 =?us-ascii?q?5uj9fLnrqJ+RO5Vphgz8Kqgun9awAeU8MggARWib/uG82aX6/ULnRbVKk+Q6nb?=
 =?us-ascii?q?THv5DEO8sbore1DBRS0oY+7RawEymp0M8fkXkDLVJFewyIg5LmOlHTOP34Cfa/?=
 =?us-ascii?q?g1KxkDZk3fzGP7vhAonTIXjHirvuYbF960tHxQo1ytBf4Z1UCrccIP7pXU/xrt?=
 =?us-ascii?q?PYAgcjMwOo2+bnFMl91oQGVGKLA6+ZM73dvUWH5+IyOOSMYI4VuDDgK/kq/fLu?=
 =?us-ascii?q?jHk5mUMDcqmtx5cYdHe4HvE1a3ifemfm19cdDX8R7E15SO3xlEbEVzlVaHCvGa?=
 =?us-ascii?q?Um6XY+AYOiCI7FAYe1nL2G2jz8B5BTeyVKB06BFSTVcZ6ZUaIJYSOWPsgzizEB?=
 =?us-ascii?q?SP2tRpEs0VS0uRbnxqF7BuzT/CIeqNTkztci/PDZlxw56WlpCd+A2XqGVWB+kz?=
 =?us-ascii?q?A0QGp88aV+pU16gnjFmYN/n/USXYhY4O9Aeg0gPJfEietgBIahdBjGe4KgTFu2?=
 =?us-ascii?q?Cv+rBzewQ5plytsDcwB3FtOkgx3r2yusCqUS0buRC8pnoernw3HtKpMlmD7936?=
 =?us-ascii?q?47ggxjG5MXOA=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AiAAC6M/hbhxHrdtBjHgEGBwaBUQkLA?=
 =?us-ascii?q?YEwJYI9g3mId4shgg2XO4FxFAEBGBSEQIQaIjQJDQEDAQEBAQEBAgETAQEBCgs?=
 =?us-ascii?q?JCBsOIwyCNgUCAxoBBoJcAQICAQECIAQZAQEECikBAgIBAQIGAQEKGgIFHQQCA?=
 =?us-ascii?q?gMBCwEkAQUBARsGEwWDHIF6CAEDAZs+PIodcHwzgnYBAQWCQ4NNgQUIEhBpiWK?=
 =?us-ascii?q?BHIIWgRGBcIEihH6DBIJXoAQHApEvGIlRhzeUfoMLBgIJBw8hgSWCDTNKgy+CG?=
 =?us-ascii?q?wwXiF6FPnKBB4oqgXcBAQ?=
X-IPAS-Result: =?us-ascii?q?A0AiAAC6M/hbhxHrdtBjHgEGBwaBUQkLAYEwJYI9g3mId4s?=
 =?us-ascii?q?hgg2XO4FxFAEBGBSEQIQaIjQJDQEDAQEBAQEBAgETAQEBCgsJCBsOIwyCNgUCA?=
 =?us-ascii?q?xoBBoJcAQICAQECIAQZAQEECikBAgIBAQIGAQEKGgIFHQQCAgMBCwEkAQUBARs?=
 =?us-ascii?q?GEwWDHIF6CAEDAZs+PIodcHwzgnYBAQWCQ4NNgQUIEhBpiWKBHIIWgRGBcIEih?=
 =?us-ascii?q?H6DBIJXoAQHApEvGIlRhzeUfoMLBgIJBw8hgSWCDTNKgy+CGwwXiF6FPnKBB4o?=
 =?us-ascii?q?qgXcBAQ?=
X-IronPort-AV: E=Sophos;i="5.56,270,1539673200"; 
   d="scan'208";a="54080762"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 23 Nov 2018 09:12:57 -0800
Received: from localhost ([::1]:53622 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gQF0i-0000a8-3l
	for like.xu@linux.intel.com; Fri, 23 Nov 2018 12:12:56 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:40227)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <alex.bennee@linaro.org>) id 1gQEyq-0006mI-1A
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 12:11:00 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <alex.bennee@linaro.org>) id 1gQEym-00009o-Vp
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 12:11:00 -0500
Received: from mail-wr1-x441.google.com ([2a00:1450:4864:20::441]:35833)
	by eggs.gnu.org with esmtps (TLS1.0:RSA_AES_128_CBC_SHA1:16)
	(Exim 4.71) (envelope-from <alex.bennee@linaro.org>)
	id 1gQEym-00007Q-Pw
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 12:10:56 -0500
Received: by mail-wr1-x441.google.com with SMTP id 96so13031034wrb.2
	for <qemu-devel@nongnu.org>; Fri, 23 Nov 2018 09:10:56 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=linaro.org; s=google;
	h=references:user-agent:from:to:cc:subject:in-reply-to:date
	:message-id:mime-version:content-transfer-encoding;
	bh=ZbkECHJKCP4Fw5oyYh6CyZcKY+vm02McwyxbPQ28f8U=;
	b=hTeeuRGazizoKm34oxb8dJHeRXGIhAc6jKf5OmoIKnHz4OxGUwcnCrhg3DgFq1RIO9
	m3uPYfNRtk4b7WRJpqG9m6VPkekePonqppt85AMpJRYa85m66QfPKJnknBOsn93KAiFh
	dtEUstD7YzN4uHtJtn7cBtoBBHO/kEm/zFw4o=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
	d=1e100.net; s=20161025;
	h=x-gm-message-state:references:user-agent:from:to:cc:subject
	:in-reply-to:date:message-id:mime-version:content-transfer-encoding;
	bh=ZbkECHJKCP4Fw5oyYh6CyZcKY+vm02McwyxbPQ28f8U=;
	b=XxWbfijIpbwwdh3IvUWB/VupYg6fE3E6xFEto+/hqDf6MHSlk1oZWfPvOOL/I1Rnq6
	vE6uFcl6IvFj1m9nZ+y+O3F/w7l8ej2PSNaBhTOZXU1X/yio+hDzRu8xLYOyUQS8wQvm
	0BENT1P61uZ/ZYd86nmWwAzLrdcP7tOOIhuomP/OKO7n5ao/I8YPNlfDa5PiehowpvEk
	5ZfmnjF8m4SnRkZ7f7RiNDBz3TEbwgAtEQV8mT8SxznQiWQxDDdp1LAhHV9POfXMz5LL
	lmapQ1v+9amOFcQ8T6ynzK7zjnRpAUIe7qoICuwekLg2smxExc0/cXm0JGomFfgr9hoB
	DPFg==
X-Gm-Message-State: AA+aEWYpY2q/6Qb1k5rqHsD7R2ng4oeK31A1WI3c1vhfrbLd6GWvexk3
	qRenVdEEdhWGSj5GwbGrtCm9YQ==
X-Google-Smtp-Source: AFSGD/XbyXrCt3yhY1T0QET041w1ukULGzZL7SXBx6hTzLdPK4sPGpPtn+OGIvfmupLBlE9rt2i0wg==
X-Received: by 2002:adf:be0f:: with SMTP id n15mr15267047wrh.267.1542993055209;
	Fri, 23 Nov 2018 09:10:55 -0800 (PST)
Received: from zen.linaro.local ([81.128.185.34])
	by smtp.gmail.com with ESMTPSA id
	x79sm17677747wmd.42.2018.11.23.09.10.54
	(version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
	Fri, 23 Nov 2018 09:10:54 -0800 (PST)
Received: from zen (localhost [127.0.0.1])
	by zen.linaro.local (Postfix) with ESMTPS id 096833E00A7;
	Fri, 23 Nov 2018 17:10:54 +0000 (GMT)
References: <20181025172057.20414-1-cota@braap.org>
	<20181025172057.20414-23-cota@braap.org>
User-agent: mu4e 1.1.0; emacs 26.1.90
From: Alex =?utf-8?Q?Benn=C3=A9e?= <alex.bennee@linaro.org>
To: "Emilio G. Cota" <cota@braap.org>
In-reply-to: <20181025172057.20414-23-cota@braap.org>
Date: Fri, 23 Nov 2018 17:10:53 +0000
Message-ID: <87mupzhg82.fsf@linaro.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=utf-8
Content-Transfer-Encoding: quoted-printable
X-detected-operating-system: by eggs.gnu.org: Genre and OS details not
	recognized.
X-Received-From: 2a00:1450:4864:20::441
Subject: Re: [Qemu-devel] [RFC 22/48] cpu: hook plugin vcpu events
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Stefan Hajnoczi <stefanha@gmail.com>,
	Peter Maydell <peter.maydell@linaro.org>, qemu-devel@nongnu.org,
	Pavel Dovgalyuk <Pavel.Dovgaluk@ispras.ru>,
	=?utf-8?Q?Llu=C3=ADs?= Vilanova <vilanova@ac.upc.edu>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>


Emilio G. Cota <cota@braap.org> writes:

> Signed-off-by: Emilio G. Cota <cota@braap.org>
> ---
>  cpus.c    | 10 ++++++++++
>  exec.c    |  2 ++
>  qom/cpu.c |  2 ++
>  3 files changed, 14 insertions(+)
>
> diff --git a/cpus.c b/cpus.c
> index 28e39f045a..3efe89354d 100644
> --- a/cpus.c
> +++ b/cpus.c
> @@ -43,6 +43,7 @@
>  #include "exec/exec-all.h"
>
>  #include "qemu/thread.h"
> +#include "qemu/plugin.h"
>  #include "sysemu/cpus.h"
>  #include "sysemu/qtest.h"
>  #include "qemu/main-loop.h"
> @@ -1322,12 +1323,21 @@ static void qemu_tcg_rr_wait_io_event(CPUState *c=
pu)
>
>  static void qemu_wait_io_event(CPUState *cpu)
>  {
> +    bool asleep =3D false;
> +

slept?

>      g_assert(cpu_mutex_locked(cpu));
>      g_assert(!qemu_mutex_iothread_locked());
>
>      while (cpu_thread_is_idle(cpu)) {
> +        if (!asleep) {
> +            asleep =3D true;
> +            qemu_plugin_vcpu_idle_cb(cpu);
> +        }
>          qemu_cond_wait(&cpu->halt_cond, &cpu->lock);
>      }
> +    if (asleep) {
> +        qemu_plugin_vcpu_resume_cb(cpu);
> +    }

I wonder if having two hooks is too much? What might a plugin want to do
before we go into idle sleep?

It feels like we are exposing too much of the guts of TCG to the plugin
here as wait_io could be for any number of internal reasons other than
the actual emulation blocking for IO through a WFI or something. If a
plugin really wants to track such things shouldn't it be hooking to the
guest sleep points?

If idle sleeps really are that important maybe we could just report our
sleep time on resume - so a single hook but passing a bit more
information?

>
>  #ifdef _WIN32
>      /* Eat dummy APC queued by qemu_cpu_kick_thread.  */
> diff --git a/exec.c b/exec.c
> index cd171adb93..71fc76f55e 100644
> --- a/exec.c
> +++ b/exec.c
> @@ -967,6 +967,8 @@ void cpu_exec_realizefn(CPUState *cpu, Error **errp)
>      }
>      tlb_init(cpu);
>
> +    qemu_plugin_vcpu_init_hook(cpu);
> +
>  #ifndef CONFIG_USER_ONLY
>      if (qdev_get_vmsd(DEVICE(cpu)) =3D=3D NULL) {
>          vmstate_register(NULL, cpu->cpu_index, &vmstate_cpu_common, cpu);
> diff --git a/qom/cpu.c b/qom/cpu.c
> index d1e6ecae03..062817c03b 100644
> --- a/qom/cpu.c
> +++ b/qom/cpu.c
> @@ -32,6 +32,7 @@
>  #include "hw/boards.h"
>  #include "hw/qdev-properties.h"
>  #include "trace-root.h"
> +#include "qemu/plugin.h"
>
>  CPUInterruptHandler cpu_interrupt_handler;
>
> @@ -353,6 +354,7 @@ static void cpu_common_unrealizefn(DeviceState *dev, =
Error **errp)
>      CPUState *cpu =3D CPU(dev);
>      /* NOTE: latest generic point before the cpu is fully unrealized */
>      trace_fini_vcpu(cpu);
> +    qemu_plugin_vcpu_exit_hook(cpu);
>      cpu_exec_unrealizefn(cpu);
>  }


--
Alex Benn=C3=A9e

