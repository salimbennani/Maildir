Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 23:36:01 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga001.jf.intel.com (orsmga001.jf.intel.com [10.7.209.18])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 703B85803EB
	for <like.xu@linux.intel.com>; Fri, 23 Nov 2018 06:27:36 -0800 (PST)
Received: from orsmga101.jf.intel.com ([10.7.208.22])
  by orsmga001-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 06:27:36 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AbEYY0hVbp2PUGfuVd0aQ082uORXV8LGtZVwlr6E/?=
 =?us-ascii?q?grcLSJyIuqrYbRyCt8tkgFKBZ4jH8fUM07OQ7/iwHzRYqb+681k6OKRWUBEEjc?=
 =?us-ascii?q?hE1ycBO+WiTXPBEfjxciYhF95DXlI2t1uyMExSBdqsLwaK+i764jEdAAjwOhRo?=
 =?us-ascii?q?LerpBIHSk9631+ev8JHPfglEnjWwba9xIRmssQndqtQdjJd/JKo21hbHuGZDdf?=
 =?us-ascii?q?5MxWNvK1KTnhL86dm18ZV+7SleuO8v+tBZX6nicKs2UbJXDDI9M2Ao/8LrrgXM?=
 =?us-ascii?q?TRGO5nQHTGoblAdDDhXf4xH7WpfxtTb6tvZ41SKHM8D6Uaw4VDK/5KpwVhTmlD?=
 =?us-ascii?q?kIOCI48GHPi8x/kqRboA66pxdix4LYeZyZOOZicq/Ye94RWGhPUdtLVyFZDI2y?=
 =?us-ascii?q?b5UBAekDMuZWoIbyu1QAowamBQSuBu3ixSJEi3Hq0aIkyOQsCh3G3BUuEt4SrH?=
 =?us-ascii?q?jYsNf4OaEPWu611qnIyjDDYutV1zfy74jIaA0qr/aWUrJ1dMre11QgFwTbjl6N?=
 =?us-ascii?q?roHlPjaV2f4Is2ie8eVvSOWvhnU9qw5vvzevxt0jipXTio0JzVDE8Dx0zYAoLt?=
 =?us-ascii?q?O7UE52ecCoHIdTui2AKod6X8AvT3t2tCs0yrAKo4O3cSoSxJg52xLSb+aLf5WG?=
 =?us-ascii?q?7x79TuqdPDR1iXx/dL6hhBu/91WrxPfmWcmuyllKqzJIktnSuXAJ0Bze8syHSv?=
 =?us-ascii?q?pm/ke9wjaDzQ/T6udZIUwukqrbMZEhzqYxlpoVr0vDAjf7lFvqgKKVbEko5/Wk?=
 =?us-ascii?q?5uf9brn4qJKRN5V4hhz8P6g2n8ywG+U4MgwAX2iB/uS80aXu/VTnT7VPk/06i7?=
 =?us-ascii?q?TWv47EJcsFoq61GhRa0oE+6xa5Ezipzs8YkX4DLFJEexKIkZLlOl7TIP3gCfe/?=
 =?us-ascii?q?glKskCpkxvzcP73hBInNIWbHkLv7Ybl97EtcxRE1zdBY4ZJUBbcBIO/pVk/2rt?=
 =?us-ascii?q?zYAQc1MxaozOb/FNV9yoQeVHqLAq+YM6Pdr0WE5+0yI+SXYI8VuTD9K+Uq5vL0?=
 =?us-ascii?q?jH85n0Mdcret3ZcNdH+4GfFmcA2kZ2HxiIIBDXsSpVh5C+jrk0GZFzhUYXm0Qu?=
 =?us-ascii?q?Q7/D58DYunCYLKQMeqmKCA2yGgWYRbY30DBl2SHHO7SoOfRv1ZbSuTJtNmwCUJ?=
 =?us-ascii?q?UKXkR4I/2BXrrgLj1rd8MsLS/SsXs4+l08J6sPbOnxM//iAhEsKGzmuWRHt1lG?=
 =?us-ascii?q?5bezhj+allqglUzFuZUOBcnuZVHMEbs/ZASAwzM5LGwqp+Fsr/Ux/pZNqFSF+6?=
 =?us-ascii?q?BN6hBGdiYMg2xoovbEFnU/CrixXO0y20S+sUkrWOAZE49YrG0nTxLto7wHHDgv?=
 =?us-ascii?q?pyx2I6S9dCYDX1zpV08BLeUsuQyx2U?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0BZAADlDPhbhxHrdtBjHQEBBQEHBQGBV?=
 =?us-ascii?q?AUBCwGBMIJPE4N5iHeLIYINiRmQExYYFIRAhBoiNwYNAQMBAQEBAQECARMBAQE?=
 =?us-ascii?q?KCwkIKS+CNgUCAxoBBoJcAQICAQECIAQfCikDAgEBAgYBAQoaAgUdBAICAwELS?=
 =?us-ascii?q?AYTBYMcgXUFCAEEpxh8M4VAhFmBC4p+F4FAP4ERgxKCEIJugwSCVwKLEYQIkGk?=
 =?us-ascii?q?JiAKJIgsYgVmHeIc3LJgEgVyBd00jFYMngicXEo4LQDGBBxyKDoF3AQE?=
X-IPAS-Result: =?us-ascii?q?A0BZAADlDPhbhxHrdtBjHQEBBQEHBQGBVAUBCwGBMIJPE4N?=
 =?us-ascii?q?5iHeLIYINiRmQExYYFIRAhBoiNwYNAQMBAQEBAQECARMBAQEKCwkIKS+CNgUCA?=
 =?us-ascii?q?xoBBoJcAQICAQECIAQfCikDAgEBAgYBAQoaAgUdBAICAwELSAYTBYMcgXUFCAE?=
 =?us-ascii?q?Epxh8M4VAhFmBC4p+F4FAP4ERgxKCEIJugwSCVwKLEYQIkGkJiAKJIgsYgVmHe?=
 =?us-ascii?q?Ic3LJgEgVyBd00jFYMngicXEo4LQDGBBxyKDoF3AQE?=
X-IronPort-AV: E=Sophos;i="5.56,270,1539673200"; 
   d="scan'208";a="41994307"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 23 Nov 2018 06:27:35 -0800
Received: from localhost ([::1]:52637 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gQCQg-0008BC-Oa
	for like.xu@linux.intel.com; Fri, 23 Nov 2018 09:27:34 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:38279)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <imammedo@redhat.com>) id 1gQCQK-00089u-PF
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 09:27:13 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <imammedo@redhat.com>) id 1gQCQK-0001Kc-1r
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 09:27:12 -0500
Received: from mx1.redhat.com ([209.132.183.28]:59538)
	by eggs.gnu.org with esmtps (TLS1.0:DHE_RSA_AES_256_CBC_SHA1:32)
	(Exim 4.71) (envelope-from <imammedo@redhat.com>)
	id 1gQCQI-0001Fa-1Q; Fri, 23 Nov 2018 09:27:10 -0500
Received: from smtp.corp.redhat.com (int-mx07.intmail.prod.int.phx2.redhat.com
	[10.5.11.22])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by mx1.redhat.com (Postfix) with ESMTPS id 2F402C0587DF;
	Fri, 23 Nov 2018 14:27:09 +0000 (UTC)
Received: from localhost (unknown [10.43.2.182])
	by smtp.corp.redhat.com (Postfix) with ESMTP id 87B9C1054FD8;
	Fri, 23 Nov 2018 14:26:59 +0000 (UTC)
Date: Fri, 23 Nov 2018 15:26:58 +0100
From: Igor Mammedov <imammedo@redhat.com>
To: =?UTF-8?B?TWFyYy1BbmRyw6k=?= Lureau <marcandre.lureau@redhat.com>
Message-ID: <20181123152658.76547154@redhat.com>
In-Reply-To: <20181107123652.23417-9-marcandre.lureau@redhat.com>
References: <20181107123652.23417-1-marcandre.lureau@redhat.com>
	<20181107123652.23417-9-marcandre.lureau@redhat.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: quoted-printable
X-Scanned-By: MIMEDefang 2.84 on 10.5.11.22
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
	(mx1.redhat.com [10.5.110.32]);
	Fri, 23 Nov 2018 14:27:09 +0000 (UTC)
X-detected-operating-system: by eggs.gnu.org: GNU/Linux 2.2.x-3.x [generic]
	[fuzzy]
X-Received-From: 209.132.183.28
Subject: Re: [Qemu-devel] [PATCH for-3.2 v3 08/14] qdev-props: convert
 global_props to GArray
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Peter Maydell <peter.maydell@linaro.org>,
	Stefano Stabellini <sstabellini@kernel.org>,
	Eduardo Habkost <ehabkost@redhat.com>,
	Corey Minyard <minyard@acm.org>, Amit Shah <amit@kernel.org>,
	=?UTF-8?B?SGVydsOp?= Poussineau <hpoussin@reactos.org>,
	"Michael S. Tsirkin" <mst@redhat.com>,
	Mark Cave-Ayland <mark.cave-ayland@ilande.co.uk>,
	qemu-devel@nongnu.org, dgilbert@redhat.com, qemu-arm@nongnu.org,
	qemu-ppc@nongnu.org, xen-devel@lists.xenproject.org,
	Anthony Perard <anthony.perard@citrix.com>,
	Paolo Bonzini <pbonzini@redhat.com>, Stefan Berger <stefanb@linux.ibm.com>,
	Andreas =?UTF-8?B?RsOkcmJlcg==?= <afaerber@suse.de>,
	Artyom Tarasenko <atar4qemu@gmail.com>, Richard Henderson <rth@twiddle.net>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

On Wed,  7 Nov 2018 16:36:46 +0400
Marc-Andr=C3=A9 Lureau <marcandre.lureau@redhat.com> wrote:

> A step towards being able to call object_apply_global_props().
it also makes code more uniform as we don't have to deal with type
inform of GList.

maybe move it at the beginning of series and include accel part as well?

otherwise looks good



> Signed-off-by: Marc-Andr=C3=A9 Lureau <marcandre.lureau@redhat.com>
> ---
>  hw/core/qdev-properties.c | 29 ++++++++++++++++++++---------
>  1 file changed, 20 insertions(+), 9 deletions(-)
>=20
> diff --git a/hw/core/qdev-properties.c b/hw/core/qdev-properties.c
> index 43c30a57f4..353e67c05a 100644
> --- a/hw/core/qdev-properties.c
> +++ b/hw/core/qdev-properties.c
> @@ -1173,22 +1173,32 @@ void qdev_prop_set_ptr(DeviceState *dev, const ch=
ar *name, void *value)
>      *ptr =3D value;
>  }
> =20
> -static GList *global_props;
> +static GArray *global_props(void)
> +{
> +    static GArray *gp;
> +
> +    if (!gp) {
> +        gp =3D g_array_new(false, false, sizeof(GlobalProperty *));
> +    }
> +
> +    return gp;
> +}
> =20
>  void qdev_prop_register_global(GlobalProperty *prop)
>  {
> -    global_props =3D g_list_append(global_props, prop);
> +    g_array_append_val(global_props(), prop);
>  }
> =20
>  int qdev_prop_check_globals(void)
>  {
> -    GList *l;
> -    int ret =3D 0;
> +    int i, ret =3D 0;
> =20
> -    for (l =3D global_props; l; l =3D l->next) {
> -        GlobalProperty *prop =3D l->data;
> +    for (i =3D 0; i < global_props()->len; i++) {
> +        GlobalProperty *prop;
>          ObjectClass *oc;
>          DeviceClass *dc;
> +
> +        prop =3D g_array_index(global_props(), GlobalProperty *, i);
>          if (prop->used) {
>              continue;
>          }
> @@ -1213,12 +1223,13 @@ int qdev_prop_check_globals(void)
> =20
>  void qdev_prop_set_globals(DeviceState *dev)
>  {
> -    GList *l;
> +    int i;
> =20
> -    for (l =3D global_props; l; l =3D l->next) {
> -        GlobalProperty *prop =3D l->data;
> +    for (i =3D 0; i < global_props()->len; i++) {
> +        GlobalProperty *prop;
>          Error *err =3D NULL;
> =20
> +        prop =3D g_array_index(global_props(), GlobalProperty *, i);
>          if (object_dynamic_cast(OBJECT(dev), prop->driver) =3D=3D NULL) {
>              continue;
>          }


