Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 24 Nov 2018 12:36:03 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga008.fm.intel.com (fmsmga008.fm.intel.com [10.253.24.58])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id AC743580460
	for <like.xu@linux.intel.com>; Fri, 23 Nov 2018 08:42:44 -0800 (PST)
Received: from fmsmga105.fm.intel.com ([10.1.193.10])
  by fmsmga008-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 08:42:44 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3ALyhTUh1DlxLog3nXsmDT+DRfVm0co7zxezQtwd8Z?=
 =?us-ascii?q?sesWLv/xwZ3uMQTl6Ol3ixeRBMOHs6IC07KempujcFRI2YyGvnEGfc4EfD4+ou?=
 =?us-ascii?q?JSoTYdBtWYA1bwNv/gYn9yNs1DUFh44yPzahANS47xaFLIv3K98yMZFAnhOgpp?=
 =?us-ascii?q?POT1HZPZg9iq2+yo9JDffwZFiCChbb9uMR67sRjfus4KjIV4N60/0AHJonxGe+?=
 =?us-ascii?q?RXwWNnO1eelAvi68mz4ZBu7T1et+ou+MBcX6r6eb84TaFDAzQ9L281/szrugLd?=
 =?us-ascii?q?QgaJ+3ART38ZkhtMAwjC8RH6QpL8uTb0u+ZhxCWXO9D9QKsqUjq+8ahkVB7oiD?=
 =?us-ascii?q?8GNzEn9mHXltdwh79frB64uhBz35LYbISTOfFjfK3SYMkaSHJPUMhRSSJPAY28?=
 =?us-ascii?q?YIQTAOUcP+lXoZTzp0MMoBW8CgSgGe3ixiNWiX/txqA6z/gtHBva0AA8Bd8Crn?=
 =?us-ascii?q?LZp8j1OqcIVuC1ybHFwTvMYfxL1jfy8pLIeQ0ur/2WQLl+csXRyU0xGAPej1Wf?=
 =?us-ascii?q?s5flMz2I3ekKrWeU8uVgWvi1i2I9qgFxrTyvydk3ionInI0V0UvJ9Sp8wIkvJN?=
 =?us-ascii?q?24TFR3bsKjEJtVriyXMZZ9TM0lQ2Ftoik6y7sGtIamcCQUypkr3QLTZ+abf4SS?=
 =?us-ascii?q?/x7uUvuaLzRghH99Zr6zmxW//VK9xuHhVcS4ykhGoyRFn9XWq3wA1QTf58uaRv?=
 =?us-ascii?q?dn4Eus1yuD2xrN5uxKP0w4j7fXJpA9zrM2i5Edq17MHjXsl0XzlKKWdlsr+uyv?=
 =?us-ascii?q?6+n/ZrXmp4ScN5Nvig3kPaQunNG/Df4/MggUUGiX4eW81Lv98k3lWLhGkOE6n6?=
 =?us-ascii?q?rDvJzHOMgWpbS1DxFb34sj8RqzEjWr3MwdnXYdLVJFfByHj5LuO1HLOP34FOmw?=
 =?us-ascii?q?g1GxkDty2v/JIKPhDYvJLnTai7jheqt960hAxwUt1tBT4JZUCrACIP3tQEPwu8?=
 =?us-ascii?q?HYAwc9Mwy1xebnFdp82pkfWWKJHq+WLqfSvUWU6eIoJumBf4kVuDH7K/gq4f7u?=
 =?us-ascii?q?kGU1mVgHfammxZcXcmy3Hux6I0WFZnrhmtMBEWYJvgUgVuDrh0CCXCVXZ3azWa?=
 =?us-ascii?q?I8+z46BJinDYfFWoCinriB0D2nEZ1RY2AVQm2KCmriIoWYR+8XOmXVJs56jidC?=
 =?us-ascii?q?U7+nRIk8kxa0u0j/wrtjK+PSvSoAqZPk0sMy/uDWiFQ++CJ5C5eg1XqQRTRxl2?=
 =?us-ascii?q?IMWzhkxa16vAlxx0mO1e1ijuVFGMdPz/VOVAg8KNjb1eMtEM34WA/KYoKUTk27?=
 =?us-ascii?q?SM6tGzA7Q4ENxIoLaUd5EtHq2hXe3yOvBrYZoLaKAJUw2qfR2WT2PYB2zHOQh4?=
 =?us-ascii?q?c7iFxzCOZDOmS8zoM5vyncA4PSkkyC3e7+eKgT1TSL9WiHwHGPtVpwXwt5UKGD?=
 =?us-ascii?q?VncaMBiF5e/l71/PGuf9QY8sNRFMnIvbcvNH?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AWAACrLPhbhxHrdtBjGgEBAQEBAgEBA?=
 =?us-ascii?q?QEHAgEBAQGBUQUBAQEBCwEBgS+BOYEpjBFfimw1gg2Ce4cPg3mGI4MVgXMSAQE?=
 =?us-ascii?q?YAxGDa4RqBSI0CQ0BAwEBAQEBAQIBEwEBAQoLCQgbDiMMQgEQAYFiBQIDGgEGg?=
 =?us-ascii?q?lsBAQEBAgEBAjcGAQUGBAwdAQIBAgECBgEBBQUTBQkTCggDAQsFDwIPAQUBAiA?=
 =?us-ascii?q?KCQVhgjsBgWgBAw0DBQEDAZtIPIwfBQEXgncFgQAxAYJ8ChknDVqBNwIGEopbg?=
 =?us-ascii?q?RyBVz+BEYJkLoRshW0CiREICoFuhU2DcYszBwIChnqKKCMKgU+FC4JthzeCeY1?=
 =?us-ascii?q?Jh0cGAgkHDyGBJV+BLnCDPAmCEgkag0qKU3EBgQMDDgODHIZ9gXcBAQ?=
X-IPAS-Result: =?us-ascii?q?A0AWAACrLPhbhxHrdtBjGgEBAQEBAgEBAQEHAgEBAQGBUQU?=
 =?us-ascii?q?BAQEBCwEBgS+BOYEpjBFfimw1gg2Ce4cPg3mGI4MVgXMSAQEYAxGDa4RqBSI0C?=
 =?us-ascii?q?Q0BAwEBAQEBAQIBEwEBAQoLCQgbDiMMQgEQAYFiBQIDGgEGglsBAQEBAgEBAjc?=
 =?us-ascii?q?GAQUGBAwdAQIBAgECBgEBBQUTBQkTCggDAQsFDwIPAQUBAiAKCQVhgjsBgWgBA?=
 =?us-ascii?q?w0DBQEDAZtIPIwfBQEXgncFgQAxAYJ8ChknDVqBNwIGEopbgRyBVz+BEYJkLoR?=
 =?us-ascii?q?shW0CiREICoFuhU2DcYszBwIChnqKKCMKgU+FC4JthzeCeY1Jh0cGAgkHDyGBJ?=
 =?us-ascii?q?V+BLnCDPAmCEgkag0qKU3EBgQMDDgODHIZ9gXcBAQ?=
X-IronPort-AV: E=Sophos;i="5.56,270,1539673200"; 
   d="scan'208";a="139336093"
X-Amp-Result: UNKNOWN
X-Amp-Original-Verdict: FILE UNKNOWN
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 23 Nov 2018 08:42:43 -0800
Received: from localhost ([::1]:53398 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gQEXS-0003Ug-Nc
	for like.xu@linux.intel.com; Fri, 23 Nov 2018 11:42:42 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:59198)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <edgar.iglesias@gmail.com>) id 1gQEX0-0003Rz-IM
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 11:42:15 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <edgar.iglesias@gmail.com>) id 1gQEWy-0000Jh-K8
	for qemu-devel@nongnu.org; Fri, 23 Nov 2018 11:42:14 -0500
Received: from mail-lf1-x143.google.com ([2a00:1450:4864:20::143]:42538)
	by eggs.gnu.org with esmtps (TLS1.0:RSA_AES_128_CBC_SHA1:16)
	(Exim 4.71) (envelope-from <edgar.iglesias@gmail.com>)
	id 1gQEWd-00074Z-G0; Fri, 23 Nov 2018 11:41:51 -0500
Received: by mail-lf1-x143.google.com with SMTP id l10so9105613lfh.9;
	Fri, 23 Nov 2018 08:41:50 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20161025;
	h=date:from:to:cc:subject:message-id:references:mime-version
	:content-disposition:in-reply-to:user-agent;
	bh=C89qSZmOxWH68BGqLGN0vCimXgyHf7mdNB8tka18RAY=;
	b=WNG9h+e75nR1A4UcgLeOmPDLXJTiYY6MxQ7gt6mUbv6CsoZLW0laLRlZ+bUcsejCTI
	ykSQ8kmGpcH6Qls5q6ARHk/fgA4ufHPRJ4ID6/otiDjAXMUDVDAylCE+uvflhqBpJNwl
	nJYFUsfeXa67M3Mlu6bDw9fWE7+BURJ2xpQJbSZlPUnK6D9R4lVtxu5eajNyns6Ju4wI
	pCIfeMWnviXHUv3tn5P9LsD8lX9EFIhsy7vBhqQTUOkJdLkfZMFceTKlHBGPMwIbQS+K
	5nTdfTKvDuq68Gy0yLpqhlXULvDgwJRuqPC3uH8ONDOzAEPguGYxwCKvaPIIej2JUYEF
	K58A==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
	d=1e100.net; s=20161025;
	h=x-gm-message-state:date:from:to:cc:subject:message-id:references
	:mime-version:content-disposition:in-reply-to:user-agent;
	bh=C89qSZmOxWH68BGqLGN0vCimXgyHf7mdNB8tka18RAY=;
	b=ah1bnWuX0hE/XLG/KrpA3OdMYAr1zwlw3Tezxs0/5mvIEwl3Ay9ZEtH3QwKTf6cFdu
	0gnVIcckb8e69ung9KFvvGVP3xB63V6BD9TOQb1KmeYxpQhcUY228Kk814BP5Pm8GS3a
	eMZOudXEjHtwVqs1TU5/AHaVC0wEHMRihlQMKgC063pSSGANm0b4aw8DHIZeZIIyoNts
	9YRJqRiJYtyD/VXv6eefXUHU9XRX7y2VAM7Z03uRVqkX0w85W5Nka84WsnP7kimdCZGi
	0W5WyliBVQ6LNAszqTDIjWWP74fqR1KER0o2ekuNzjt8lkf+s6XmbJu9Uf/DQ2JgEv9G
	6Xaw==
X-Gm-Message-State: AGRZ1gKk6+zBXbzjSVXiMwKk7t5dmaH8598QSwA1Q6xkQX2lfdYTI9qm
	TCh8QDrWZhC11T6ahGBzkSk=
X-Google-Smtp-Source: AJdET5f2C9Ptlq4/yO3yxxseORUzsXQYkcMSpgW+vk/KRqUfcI1AOqv6SA9zVj99ZmIUUZGjPlUZYw==
X-Received: by 2002:a19:4e59:: with SMTP id c86mr10215149lfb.132.1542991309044;
	Fri, 23 Nov 2018 08:41:49 -0800 (PST)
Received: from gmail.com (81-231-232-130-no39.tbcn.telia.com. [81.231.232.130])
	by smtp.gmail.com with ESMTPSA id
	d24-v6sm3620618ljg.2.2018.11.23.08.41.48
	(version=TLS1_2 cipher=ECDHE-RSA-CHACHA20-POLY1305 bits=256/256);
	Fri, 23 Nov 2018 08:41:48 -0800 (PST)
Date: Fri, 23 Nov 2018 17:41:47 +0100
From: "Edgar E. Iglesias" <edgar.iglesias@gmail.com>
To: mbilal <muhammad_bilal@mentor.com>
Message-ID: <20181123164147.GL1148@toto>
References: <e8dae726-8853-4e44-1eb8-b9cfb0bc44f2@mentor.com>
	<CAFEAcA_EM39P8HFoC=B=XP3Ax8NgNSotn=wMJJsG05P8Ywdruw@mail.gmail.com>
	<abd7b108-4d21-9c1c-16d3-6d31d47f74eb@mentor.com>
	<20181123132017.GJ1148@toto>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20181123132017.GJ1148@toto>
User-Agent: Mutt/1.9.4 (2018-02-28)
X-detected-operating-system: by eggs.gnu.org: Genre and OS details not
	recognized.
X-Received-From: 2a00:1450:4864:20::143
Subject: Re: [Qemu-devel] [Qemu-discuss] How to select specific qemu net
 'nic' device
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Peter Maydell <peter.maydell@linaro.org>, jasowang@redhat.com,
	Alistair Francis <alistair@alistair23.me>,
	QEMU Developers <qemu-devel@nongnu.org>,
	qemu-discuss <qemu-discuss@nongnu.org>, qemu-arm <qemu-arm@nongnu.org>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

On Fri, Nov 23, 2018 at 02:20:17PM +0100, Edgar E. Iglesias wrote:
> On Fri, Nov 23, 2018 at 02:59:32PM +0500, mbilal wrote:
> > Hi,
> > 
> > Thanks for reply.
> > 
> > According to your suggestion I've tested with 3.1 rc2 release and problem is
> > still exist in this release also.
> > 
> > Here is my reproducible scenario.
> 
> 
> Thanks,
> 
> I've had a look and the assert looks bogus to me.
> We shouldn't be asserting on RX descriptor setups when the receiver is disabled.
> 
> I'll send a patch in a moment.
> 
> Best regards,
> Edgar

+ Jason

Hi,

I've sent a patch to fix te GEM model.
The assert in the GEM model was wrong IMO but I also think the net layer
is behaving a bit suspicious in this case. The qemu_flush_or_purge_queued_packets()
path is delivering queued packets to a net model without checking can_receive().
Without digging too much into the details my gut feeling is that the net layer
shouldn't be doing this. I may be missing something though.

Here's the backtrace:
(gdb) bt
#0  0x00007ffff39e0e97 in raise () from /lib/x86_64-linux-gnu/libc.so.6
#1  0x00007ffff39e2801 in abort () from /lib/x86_64-linux-gnu/libc.so.6
#2  0x00007ffff39d239a in ?? () from /lib/x86_64-linux-gnu/libc.so.6
#3  0x00007ffff39d2412 in __assert_fail () from /lib/x86_64-linux-gnu/libc.so.6
#4  0x0000555555b47de6 in gem_receive (nc=<optimized out>, 
    buf=<optimized out>, size=346)
    at /home/edgar/src/c/qemu/qemu/hw/net/cadence_gem.c:982
#5  0x0000555555bf033d in nc_sendv_compat (flags=<optimized out>, iovcnt=1, 
    iov=0x7fffffffd620, nc=0x555556edd360)
    at /home/edgar/src/c/qemu/qemu/net/net.c:701
#6  qemu_deliver_packet_iov (sender=<optimized out>, flags=<optimized out>, 
    iov=0x7fffffffd620, iovcnt=1, opaque=0x555556edd360)
    at /home/edgar/src/c/qemu/qemu/net/net.c:733
#7  0x0000555555bf2a85 in qemu_net_queue_deliver (size=<optimized out>, 
    data=<optimized out>, flags=<optimized out>, sender=<optimized out>, 
    queue=0x555556edd4e0) at /home/edgar/src/c/qemu/qemu/net/queue.c:164
#8  qemu_net_queue_flush (queue=0x555556edd4e0)
    at /home/edgar/src/c/qemu/qemu/net/queue.c:261
#9  0x0000555555bf0d3c in qemu_flush_or_purge_queued_packets (
    nc=0x555556edd360, purge=<optimized out>)
    at /home/edgar/src/c/qemu/qemu/net/net.c:607
#10 0x0000555555bf0dd9 in net_vm_change_state_handler (opaque=<optimized out>, 
    running=0, state=<optimized out>)
    at /home/edgar/src/c/qemu/qemu/net/net.c:1423
#11 0x0000555555a641c7 in vm_state_notify (running=running@entry=0, 
    state=state@entry=RUN_STATE_SHUTDOWN)
    at /home/edgar/src/c/qemu/qemu/vl.c:1562
#12 0x0000555555889b0a in do_vm_stop (state=RUN_STATE_SHUTDOWN, 
    send_stop=<optimized out>) at /home/edgar/src/c/qemu/qemu/cpus.c:1074
#13 0x0000555555844200 in main (argc=<optimized out>, argv=<optimized out>, 
    envp=<optimized out>) at /home/edgar/src/c/qemu/qemu/vl.c:4648
(gdb) q


Cheers,
Edgar


> 
> 
> 
> > 
> > QEMU launching
> > --------------
> > 
> > ./qemu-system-aarch64 -M xlnx-zcu102 -m 1G -kernel /dev/null -S -s  -net nic
> > -net nic -net nic -net nic -net user,hostfwd=tcp::8080-:8080 -smp 1 -serial
> > stdio -serial /dev/null
> > 
> > gdb session
> > ------------
> > 
> > (gdb) file zcu102_net_uni.out
> > Reading symbols from zcu102_net_uni.out...done.
> > (gdb) tar rem :1234
> > Remote debugging using :1234
> > _ld_text_start () at os/arch/armv8/common/arch_asm.S:381
> > 381	    MOV     X14, X0
> > (gdb) load
> > Loading section .text, size 0x59c0c lma 0x0
> > Loading section .rodata, size 0x2bbc lma 0x59c0c
> > Loading section .rtl.data, size 0x770 lma 0x5c7c8
> > Loading section .data, size 0x4dc lma 0x5cf54
> > Start address 0x0, load size 381972
> > Transfer rate: 23313 KB/sec, 2021 bytes/write.
> > (gdb) c
> > Continuing.
> > ^C
> > 
> > 
> > So any breakpoint or Ctrl-C asserts the QEMU.
> > 
> > qemu-system-aarch64: qemu-3.1.0-rc2/hw/net/cadence_gem.c:982: gem_receive:
> > Assertion `!first_desc' failed.
> > 
> > 
> > Our networking demo application running fine unless you interrupt the GDB
> > (either with breakpoints or interrupt signal).
> > You can see following message on QEMU console which is the indication of
> > demo is fine (it also well tested on actual hardware)
> > 
> > Open the following Nucleus node address in your web browser:
> >     http://127.0.0.1:8080/
> > 
> > 
> > I'm attaching demo application binary.
> > 
> > 
> > 
> > 
> > Thanks for care about this issue,
> > -Bilal
> > 
> > 
> > 
> > On 11/23/2018 01:59 PM, Peter Maydell wrote:
> > > On 23 November 2018 at 04:13, mbilal <muhammad_bilal@mentor.com> wrote:
> > > > Hi,
> > > > 
> > > > I'm using qemu emulation for xilinx zcu102 platform, this board have four
> > > > networking GEM0, GEM1, GEM2 and GEM3 devices.
> > > > 
> > > > To run network demo on this board *only* require GEM3 device to be configure
> > > > while other GEM devices don't need to be configure, that's why u-boot and
> > > > other RTOS only configure GEM3 device.
> > > > 
> > > > 
> > > > QEMU is enabling these GEM devices  with networking '-net nic' option and
> > > > QEMU consider first '-net nic' option for GEM0 and second '-net nic' option
> > > > for GEM1 and so on. that's why if need to enable GEM3 network device we must
> > > > need to give following full command line options
> > > > 
> > > > -net nic -net nic -net nic -net nic -net user, ...
> > > > 
> > > > In this way all four GEM devices would be enable but first three GEM0-GEM2
> > > > devices are un-configured and useless. In our case QEMU is being *crashed*
> > > > due to trying to use these un-configured GEM devices to o send/receive GDB
> > > > breakoint/interrupt cause. IIUC QEMU uses first device in the -nic loop
> > > > i.e
> > > > 
> > > > qemu-system-aarch64: hw/net/cadence_gem.c:921: gem_receive: Assertion
> > > > `!first_desc' failed.
> > > 
> > > If QEMU asserts like this, this is a bug in QEMU. I've cc'd
> > > the maintainers of the Xilinx board.
> > > 
> > > Could you provide a complete set of instructions to reproduce
> > > this bug, please ? (full command line, guest image, etc)
> > > 
> > > Could you also tell us which version of QEMU you are using?
> > > If possible, try with the current git master or
> > > with the 3.1 rc2 release candidate we've just put out, to
> > > see if it's already been fixed.
> > > 
> > > thanks
> > > -- PMM
> > > 
> 
> 

