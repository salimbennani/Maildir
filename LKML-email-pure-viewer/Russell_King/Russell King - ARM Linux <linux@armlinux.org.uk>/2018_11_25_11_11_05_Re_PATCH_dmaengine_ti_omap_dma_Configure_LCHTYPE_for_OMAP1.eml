Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 25 Nov 2018 22:13:02 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga006.jf.intel.com (orsmga006.jf.intel.com [10.7.209.51])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 1F6DA5802E4;
	Sun, 25 Nov 2018 03:11:37 -0800 (PST)
Received: from fmsmga102.fm.intel.com ([10.1.193.69])
  by orsmga006-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 25 Nov 2018 03:11:35 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3A8KMkFRP6RcAdWa7YC8sl6mtUPXoX/o7sNwtQ0KIM?=
 =?us-ascii?q?zox0KPr/p8bcNUDSrc9gkEXOFd2Cra4c26yO6+jJYi8p2d65qncMcZhBBVcuqP?=
 =?us-ascii?q?49uEgeOvODElDxN/XwbiY3T4xoXV5h+GynYwAOQJ6tL1LdrWev4jEMBx7xKRR6?=
 =?us-ascii?q?JvjvGo7Vks+7y/2+94fcbglUhzexe69+IAmrpgjNq8cahpdvJLwswRXTuHtIfO?=
 =?us-ascii?q?pWxWJsJV2Nmhv3+9m98p1+/SlOovwt78FPX7n0cKQ+VrxYES8pM3sp683xtBnM?=
 =?us-ascii?q?VhWA630BWWgLiBVIAgzF7BbnXpfttybxq+Rw1DWGMcDwULs5Qiqp4bt1RxD0iS?=
 =?us-ascii?q?cHLz85/3/Risxsl6JQvRatqwViz4LIfI2ZMfxzdb7fc9wHX2pMRshfWSxfDI2h?=
 =?us-ascii?q?bIUPAeUOMvpFoIb/qVQOtgO+CAu3CePz1jNEmmP60bEg3ug/FwzNwQwuH8gJsH?=
 =?us-ascii?q?TRtNj7KLoSUfuuzKbWyTXDa+5d1zL86IjOfRAqvOiAVq9sfMTNzkckCgXLjlSW?=
 =?us-ascii?q?qYz4MDKey+MAs2ya7+pmSOKuhHUqpBtrojiqwscsi4/Jhp8ay1ze8iV52ok1Kc?=
 =?us-ascii?q?elSE54eNOpFoZbuS+dN4tzWMwiQmdotT4gxb0cvJ67eCkKyJI6xx/QcfCHdJKI?=
 =?us-ascii?q?4h35WOaMIjd0nGlleKqhiBms7Eeg1vPzVtKo0FpQqCpKjMXMumgI1xPJ8MiIVu?=
 =?us-ascii?q?Fx/kan2TaB0ADe7PxPL0MslafDNZIt3ro9moAOvUnNACP6glj6gayKekk+++Wl?=
 =?us-ascii?q?6fzrbqv6qpOAKoN5jw7zPbkhl8G8BOk3KBUBUmiF9em52rDv41H1TKhPg/Eoj6?=
 =?us-ascii?q?XUv5XXJcoGqa63DQ9Y14gj5AiiAzu61dkVkncHIVFEdR+BkoPnIUvBIOriAve6?=
 =?us-ascii?q?m1mskClkx/TBPrD5HJXNIWbMkK37cbZ+9UFc0gwzws5b555ODbEBOv3zVlfwtN?=
 =?us-ascii?q?zeEBA5LxS5z/j7BNh5zI8SRGyCDrGDPK/PslKE+vgjLuiOaYMNvTbyMfkl5/rg?=
 =?us-ascii?q?jX8jnl8deLGk3Z8WaHC+A/RnLFyVYXnyjdcbF2cFoA4+QPXtiFyMVz5ceWyyUr?=
 =?us-ascii?q?ki5jE0Fo2mF53PRoOzj7yb2ie0AJlWanpBClCWHnfkb5+EVOsUaCKOPs9hlSQJ?=
 =?us-ascii?q?VbygS48iyx6irgD7y6d8I+rQ+y0Ys4/j1ddv6+3SkxEy6SJ7D8CH326RSGF0m3?=
 =?us-ascii?q?sCRyUq06BnvUx91lCD3LB4g/NCFNxT++lGUgAgOZ7c0ux1EdbyWg3ac9eNSVam?=
 =?us-ascii?q?RMimAD4rQtIwxd8Of1hyG9G4gh/f2CqqBqcfl6aXC5ws7qLcw3/xKt5/y3bByq?=
 =?us-ascii?q?YtlVomQsxJNW2gga5y7AzTB4/Pk0WEmKemb6Uc3CjR9GidyWqCpl1XUAl1Ua/d?=
 =?us-ascii?q?R3AQelPWrcjl5kPFV7KhE68nMgtGyc6BMKdKcMfmjVddSffnOdTeZX+xmmiqCR?=
 =?us-ascii?q?aJwLOMcJTle2EH0CrBD0gElhgZ/WyaOggmGiehv2XeASRtFV31ZUPg6+1+qHKh?=
 =?us-ascii?q?QU8ywAGHdElh17uz+h4Iiv2QUfIT3rQYuCg/rzV4Bkqy39XTC9CYvQpuYL1cYc?=
 =?us-ascii?q?8h4FdAzW/WqhZyPoK+IKx4hl4RaQJ3v1jw2BVxDYlAlcsqrHYuzAdpLaKY0VVB?=
 =?us-ascii?q?dy6X3JzqO73XLHXy8w6ra6LMxl7e19OW8L8V6Psks1XjoB2pFk06/np6ydZVzW?=
 =?us-ascii?q?WT6o/KDAUIV5LxSVg49x5hqrHeYyk94Z7U1HJ2Pam1tD/Cx8wmBO8/xhm8eNdf?=
 =?us-ascii?q?NbuOFBXuHM0CG8iuNOsqlkC1bhIFOeBS87I0P8OmdvecxK6nJuFgnCiijWRG5o?=
 =?us-ascii?q?B93VmB9y59Su7OwpYEzOuU3gqBVzfgklihttr7lpxDZTEXBmC/0zTrBJZNZq1u?=
 =?us-ascii?q?eoYGEX2hI8mpydRxmZHsW2RU+0W+B1wbwsCpfxmSb1vj3QBL0UQXoHqnmTa3zj?=
 =?us-ascii?q?BukjEpqLaf0zLKw+j4aBUHPWtLTnF4jVjwOYi0k8waXE+wYgkpiRup/1r1y7Ja?=
 =?us-ascii?q?paR/NWbTR0hIcjPyL2FjVKuwq7WDb9RO6JMurSVYTuC8bUqGRb76phsQyznjEH?=
 =?us-ascii?q?dGxDAnazGqvY30nwZ7iG2BNnlztmfWecZqyRfZ+tPcX/9R0iMaSyZijTnYG0az?=
 =?us-ascii?q?P8Ou/dWSjJrDtuG+V2S8VpxcayXrzIWAtDel6m1uGxGwg/ezmtj/GwggzSD7z8?=
 =?us-ascii?q?VqVTnPrBvkYojr1r62MOJ9cklzGV/87dF3GoV/kos2mZER1mIWhpST/Xobj2jz?=
 =?us-ascii?q?Nc9X1r75bHoIXTQL2cLa4BD52E1/KXKE34D5WW+HwstiZNm6ZXka2jkn4MBJC6?=
 =?us-ascii?q?eU7bpEkjVzolejqQLRYP59nioSyPc06X4ahf0JtxQpzimHHr8SGkxYNzT2lxuU?=
 =?us-ascii?q?99C+sLlXZGG3fLmwzkV+msqtDLODogFaQ3v5fpYiHSlt7sRwKl7M0Xvz6p36d9?=
 =?us-ascii?q?nUd94cqhqUkxLYhehPNJ0xjuYKhTZgOW/lvn0q0e87gQZu3ZGnpoeHLWpt8bm9?=
 =?us-ascii?q?Ah5ZMD31eswS9ivsjaZYgsaZwYSvEo99FTUMWZviVeioHy4KtfT7KwaOFyUxqn?=
 =?us-ascii?q?KaGbrcBwCT8klnoGzUE5C3KX6XPmIWwst4RBmSP0FfhAEUXDMnnp82DAyqxcrh?=
 =?us-ascii?q?cFtn6TAV/FL3thxMyudwPRnlTmjfvBuoaiszSJWHMBpW6QRC613UMMOE6OJzAj?=
 =?us-ascii?q?pY/oagrAGWLmybZgJIDXwGW0CeBlDjOKWu6sfE8+SCGuW+KP7Oa62UqeNCT/eI?=
 =?us-ascii?q?2Y6v0ox+8jmXLMqPOX1iD+Ah1kpHQHB0AMDZmzQJSywKmCPBdc+bpBGg+iJpqs?=
 =?us-ascii?q?Cz6ujkWAXq5YGXEbtdLc1v+wyqgaeEL+OQhjx2KTNG2ZMX33PI1KIT3F0PiyFt?=
 =?us-ascii?q?ajmtF64PtTXWQaLUm69XCQMbaixpOMtJ6aI8whdCOcrBhtzp0b54i+Y/C01ZWl?=
 =?us-ascii?q?z5hsGpecsKLnm9NVPAGUaLLamGKifNw83teqO8TrtQjOpPuh20uDabFVLjPzuZ?=
 =?us-ascii?q?mznoURCvLf9DjCWBMBNCv4G9dw5nCXL/Q9L+dh27LNh3gCU2wbIqh3PKNm0cMT?=
 =?us-ascii?q?lmf0NOtL2Q6ixYjetlG2xc9XpoNu2Emyef7+nFJZcaq/prAiJol+1E5HQ20ada?=
 =?us-ascii?q?7CZBRPZtgivdssZuo026kumI0jdoSgdOpS1RhI2VvURuI6HZ9phbVHbA/RIN63?=
 =?us-ascii?q?iQChsQq9tkDN3vp75fytzVmK3vLzdC9sre/dEACMjMNMKHLH0hPAL1GD7VCQsJ?=
 =?us-ascii?q?VyKkOXvDiExdjv6S8GaYrpw7qpjqhZoPRaVXVF0zFvMGFEtlGMYOL4twXjMhib?=
 =?us-ascii?q?SbltIH5WKirBnNQ8VXppDGWeiUAfXqKTaZi6FLZhoIwbziK4QTOZb220hjall8?=
 =?us-ascii?q?gYTLFFDcXdFLoi19cAA0pF9B/2R5Tm02iArZbVaR53kCXdq1mBI5kAZ4KbAx8z?=
 =?us-ascii?q?H9y14rIV/LqCZ2m040z4bLmzeUJQTsN7y9WYUeKCvyuAB0errBZk5RbAuvjQQw?=
 =?us-ascii?q?MDbCWqJ5hqFlcWFtlR+avoFAX+NfG/4XKCQMzO2aMq17mW9XrT+qkAoevbPI?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0BuAAArgvpbh0O0hNFjGwEBAQEDAQEBB?=
 =?us-ascii?q?wMBAQGBZYExgTmBAieEW5M1gg0UmRsUGAsIAYhaIjgSAQMBAQEBAQECARMBAQE?=
 =?us-ascii?q?IDQkIKSMMgjYkAYJiAQIDAQIkEwYBATcBBQkBAQoYCSUDDAUoIQoJBYMcAYIBA?=
 =?us-ascii?q?QMBCqVegWwzgnYBAQWHEwiMCRc+gUGBEYMSgxALBBiHIokhlmMJhnyKKAsYgVm?=
 =?us-ascii?q?ILocBLI0Xim2BXYF2MxoILASDJwkKgW0bCRqGI4UhglhAMoEFAQGMagEB?=
X-IPAS-Result: =?us-ascii?q?A0BuAAArgvpbh0O0hNFjGwEBAQEDAQEBBwMBAQGBZYExgTm?=
 =?us-ascii?q?BAieEW5M1gg0UmRsUGAsIAYhaIjgSAQMBAQEBAQECARMBAQEIDQkIKSMMgjYkA?=
 =?us-ascii?q?YJiAQIDAQIkEwYBATcBBQkBAQoYCSUDDAUoIQoJBYMcAYIBAQMBCqVegWwzgnY?=
 =?us-ascii?q?BAQWHEwiMCRc+gUGBEYMSgxALBBiHIokhlmMJhnyKKAsYgVmILocBLI0Xim2BX?=
 =?us-ascii?q?YF2MxoILASDJwkKgW0bCRqGI4UhglhAMoEFAQGMagEB?=
X-IronPort-AV: E=Sophos;i="5.56,277,1539673200"; 
   d="scan'208";a="54191799"
X-Amp-Result: UNKNOWN
X-Amp-Original-Verdict: FILE UNKNOWN
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 25 Nov 2018 03:11:34 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1726127AbeKYWCW (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Sun, 25 Nov 2018 17:02:22 -0500
Received: from pandora.armlinux.org.uk ([78.32.30.218]:53160 "EHLO
        pandora.armlinux.org.uk" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1725957AbeKYWCW (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sun, 25 Nov 2018 17:02:22 -0500
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
        d=armlinux.org.uk; s=pandora-2014; h=Sender:In-Reply-To:Content-Type:
        MIME-Version:References:Message-ID:Subject:Cc:To:From:Date:Reply-To:
        Content-Transfer-Encoding:Content-ID:Content-Description:Resent-Date:
        Resent-From:Resent-Sender:Resent-To:Resent-Cc:Resent-Message-ID:List-Id:
        List-Help:List-Unsubscribe:List-Subscribe:List-Post:List-Owner:List-Archive;
         bh=g0CVPf0k1C//M4r6yRI+gNC+GvlY5j6fGOTkbI0mmQs=; b=KqZUqbq7NTfoDNWMiZrSzUhZl
        ai1NH7E6YoQhdJnhffas5HFlAT47yPy0bV7iTSdDvN0ojRfa/F437TPq8Hw+hseRfrwn1mlmAZ3NC
        cYP4S8ft4kU7TCuuRGpmR8lYBXaXUyHt+Z3ABNARucJ9NoMO4fANC06HePqYrhUwjCYhE=;
Received: from n2100.armlinux.org.uk ([2001:4d48:ad52:3201:214:fdff:fe10:4f86]:43389)
        by pandora.armlinux.org.uk with esmtpsa (TLSv1.2:ECDHE-RSA-AES128-GCM-SHA256:128)
        (Exim 4.90_1)
        (envelope-from <linux@armlinux.org.uk>)
        id 1gQsJq-0003S4-Dt; Sun, 25 Nov 2018 11:11:18 +0000
Received: from linux by n2100.armlinux.org.uk with local (Exim 4.90_1)
        (envelope-from <linux@n2100.armlinux.org.uk>)
        id 1gQsJi-0007Ni-Sw; Sun, 25 Nov 2018 11:11:11 +0000
Date: Sun, 25 Nov 2018 11:11:05 +0000
From: Russell King - ARM Linux <linux@armlinux.org.uk>
To: Tony Lindgren <tony@atomide.com>
Cc: Aaro Koskinen <aaro.koskinen@iki.fi>,
        Peter Ujfalusi <peter.ujfalusi@ti.com>, vkoul@kernel.org,
        dan.j.williams@intel.com, dmaengine@vger.kernel.org,
        linux-kernel@vger.kernel.org, linux-omap@vger.kernel.org
Subject: Re: [PATCH] dmaengine: ti: omap-dma: Configure LCH_TYPE for OMAP1
Message-ID: <20181125111105.GT6920@n2100.armlinux.org.uk>
References: <20181119104040.12885-1-peter.ujfalusi@ti.com>
 <20181119184649.GE16897@darkstar.musicnaut.iki.fi>
 <6af8c6e7-bf5c-5555-161b-5d3fb7ecae43@ti.com>
 <20181120210406.GB24888@darkstar.musicnaut.iki.fi>
 <20181122102948.GN6920@n2100.armlinux.org.uk>
 <20181122151236.GA9611@n2100.armlinux.org.uk>
 <6ed280af-edb6-4be7-82f4-7fc00378103e@ti.com>
 <20181123185215.GH12912@darkstar.musicnaut.iki.fi>
 <20181124200942.GS6920@n2100.armlinux.org.uk>
 <20181125010717.GJ53235@atomide.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20181125010717.GJ53235@atomide.com>
User-Agent: Mutt/1.5.23 (2014-03-12)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Sat, Nov 24, 2018 at 05:07:17PM -0800, Tony Lindgren wrote:
> * Russell King - ARM Linux <linux@armlinux.org.uk> [181124 20:10]:
> > On Fri, Nov 23, 2018 at 08:52:15PM +0200, Aaro Koskinen wrote:
> > > Hi,
> > > 
> > > On Fri, Nov 23, 2018 at 02:35:04PM +0200, Peter Ujfalusi wrote:
> > > > On 22/11/2018 17.12, Russell King - ARM Linux wrote:
> > > > > I'm also not sure about this:
> > > > > 
> > > > >         if (cpu_is_omap15xx())
> > > > >                 end++;
> > > > > 
> > > > > in dma_dest_len() - is that missing from the omap-dma driver?  It looks
> > > > > like a work-around for some problem on OMAP15xx, but I can't make sense
> > > > > about why it's in the UDC driver rather than the legacy DMA driver.
> > > > 
> > > > afaik no other legacy drivers were doing similar thing, this must be
> > > > something which is needed for the omap_udc driver to fix up something?
> > > 
> > > Here's the patch that added it: https://marc.info/?l=linux-omap&m=119634396324221&w=2
> > > 
> > > "Make DMA-OUT behave on the 1510 ... the 1510 CPC register was just
> > > off-by-one with respect to the 1611 CDAC"
> > 
> > ... which suggests that's a problem with the CPC register itself, and
> > we should fix that in the DMAengine driver rather than the USB gadget
> > driver.
> > 
> > Tony, any input on this?
> 
> Yeah that sounds like some hardware work-around for 15xx as described
> in the DMA_DEST_LAST macro reading CSAC on 15xx instead of CDAC. Seems
> like it should be done in the dmaengine driver.. My guess is that other
> dma users never needed to read CSAC register?

Hmm, reading the OMAP1510 TRM for the CPC register, it seems that
omap-dma won't handle this particularly well.  The fact that the
register only updates after the last request in an element or frame
means that if we try to use this value as the current source /
destination address before the first transfer, it can be wildly
wrong.

Saving the current value at the beginning of a request, and detecting
if it's changed (like omap_udc) isn't going to work well in the
generic case.  If, say, the register happens to contain 0x0004, and
our next transfer is using 32-bit elements in element sync mode
starting at address with lsb 16 bits as 0, it would mean we'd see
0x0004 in this register after the _second_ element has been
transferred, and we'd assume that the register hasn't yet changed -
but we would have in reality transferred two elements.

However, omap-dma.c zeros the CPC register before each transfer,
which is interesting, because in one place the OMAP1510 TRM says
that the CPC register is read/write, but in the actual description
of this register, it says it's read-only.

What it also means is that, in such a case, after the 2nd element has
been transferred, where the register contains 0x0004, the address
we'd be looking for (to calculate the residual) should be 0x0008,
not 0x0005, so we actually need to be adding the number of bytes
according to element size.

Looking at omap-dma.c, someone has added support for the residue
granularity:

        if (__dma_omap15xx(od->plat->dma_attr))
                od->ddev.residue_granularity =
                                DMA_RESIDUE_GRANULARITY_DESCRIPTOR;
        else
                od->ddev.residue_granularity = DMA_RESIDUE_GRANULARITY_BURST;

If OMAP15xx is truely descriptor granularity, then we can't use
omap-dma for omap_udc, because omap_udc needs to know exactly
how many bytes were transferred.

So... hmm, OMAP15xx DMA looks like a complete mess, and the only
way to know what would and wouldn't work is to actually have the
hardware.

I think we're better off leaving omap-udc well alone, and if it's
now broken with DMA, then that's unfortunate - it would require
someone with the hardware to diagnose the problem and fix it.  I
think trying to convert it to dmaengine would be risking way more
problems than its worth.

-- 
RMK's Patch system: http://www.armlinux.org.uk/developer/patches/
FTTC broadband for 0.8mile line in suburbia: sync at 12.1Mbps down 622kbps up
According to speedtest.net: 11.9Mbps down 500kbps up
