Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 23:34:20 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga007.jf.intel.com (orsmga007.jf.intel.com [10.7.209.58])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 846C758037D;
	Fri, 23 Nov 2018 03:02:25 -0800 (PST)
Received: from orsmga103.jf.intel.com ([10.7.208.35])
  by orsmga007-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 03:02:25 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3A5THMbhFNqNPmGyVvC1uLp51GYnF86YWxBRYc798d?=
 =?us-ascii?q?s5kLTJ75osq8bnLW6fgltlLVR4KTs6sC17KG9fi4EUU7or+5+EgYd5JNUxJXwe?=
 =?us-ascii?q?43pCcHRPC/NEvgMfTxZDY7FskRHHVs/nW8LFQHUJ2mPw6arXK99yMdFQviPgRp?=
 =?us-ascii?q?OOv1BpTSj8Oq3Oyu5pHfeQpFiCa+bL9oMBm6sRjau9ULj4dlNqs/0AbCrGFSe+?=
 =?us-ascii?q?RRy2NoJFaTkAj568yt4pNt8Dletuw4+cJYXqr0Y6o3TbpDDDQ7KG81/9HktQPC?=
 =?us-ascii?q?TQSU+HQRVHgdnwdSDAjE6BH6WYrxsjf/u+Fg1iSWIdH6QLYpUjm58axlVAHnhz?=
 =?us-ascii?q?sGNz4h8WHYlMpwjL5AoBm8oxBz2pPYbJ2JOPZ7eK7WYNEUSndbXstJWSJPAp2y?=
 =?us-ascii?q?YZYMAeoPMulXs5TyqFkAohulHQmhBvjiyiNUinPqwaE2z/4sHR/A0Qc9H9wOqn?=
 =?us-ascii?q?PUrNDtOakOTOC117LIwivHb/NSxDzz7YnIchYuofqRRL57bNbcx1UoGQjYiFuQ?=
 =?us-ascii?q?qIrlPy6a1+8QtGWb6+tgVeSyi28osAx+uCKvxsIoionIgIIV11/F+T9+wIYvKt?=
 =?us-ascii?q?20UlN7Yd29HZZWqiqUOYx2QsY4TGFpviY30qcJuYS+fCgOyZQnwQPfavOdf4iP?=
 =?us-ascii?q?+BLjW/ydISp7hH59Y7K/nwi9/la9xe3gSMa0y0pKojBDktbSqnAA0QHY5MufSv?=
 =?us-ascii?q?Zl4EutxTKC2xrO5uxKP0w4j7fXJp09zrIql5ces1zPEy31lUnsgqKaaF8o9+a0?=
 =?us-ascii?q?5+j9fLnqu5yROolpgQ/kKKsugNawAeEgPwgOQWeb/eO82aX9/U32XrpKlOc6kq?=
 =?us-ascii?q?rHv5DAI8QUuKq5DxVS0oY55BazFzam0NIGknkbNF9JZg6LgozzN13TLv30E+2z?=
 =?us-ascii?q?j0mvnTt33fzLP7/sDo3ILnfZkbfhebh961RbyAo21d1f45NUCrccIPP8Q0Pxt8?=
 =?us-ascii?q?LXDgU/MwOqx+brEdJ9140YWW2RGK+UK73SsVCW6eI1OeWMZ5EauCz7K/c74/7i?=
 =?us-ascii?q?l3g5mUUSfaWxx5sYdGi4Huh6I0WeeXfshtYBEWQUsQYkQ+3qlUaPUTpSZ3a0Qq?=
 =?us-ascii?q?I96Ss3CIOgDYffWI+thKaN0zu8Hp1TfmpGEEyDEW/0d4WYXPcBcCKSLdVgkjwY?=
 =?us-ascii?q?T7ehTJUt1RGztADgzbpnIfHZ+ikZtZLlydh06PfflRA09TxoEcud13uBQH1znm?=
 =?us-ascii?q?MNXzU2xrxwoVRhylef1qh1m/5YFdtN6P9TUQc6Mpjcz+p9C93pXgLBf9GJSEup?=
 =?us-ascii?q?Q9m8ADExSM4xzMEKY0pnB9qiiRXD1TKwA7AJj7yLGIA08qXE0nfrPMZ9y3HG1K?=
 =?us-ascii?q?o7g1k8WMRPN3arhqp+9wjVGo7InF+Vl6esdaQAwiHN8H2PwnaJvEFdSARwS7nK?=
 =?us-ascii?q?XWgDZkvKqtT0/kDCQKWoCbg9NgtByNSNKq1FatDyiVVGRfHjOMnRYm6rmmewAw?=
 =?us-ascii?q?qIya2IbIbwZ2od2yDdAlAekw8P5XaGKRQ+BiC5rm3DFjNuC0zgb1ns8eZkrnO7?=
 =?us-ascii?q?VVE7zweNY01l1Lq1/xoViOeYS/MS2LIEpSggpy91HFa7w9LZFd6AqxB9c6VbZN?=
 =?us-ascii?q?M3+E1H2n7BtwxhIpygKLhviUMEfARpoUzizRV3BZ9GkcgxsnwqyhF/KaaZ0FNH?=
 =?us-ascii?q?ajOZ0or8OrzRKmnu4h+vb7Ta1U3Z0NaT4q0P8ug3q03/vAG1EUov62ln09hQ03?=
 =?us-ascii?q?ub+pXKDAoTXYjtUkot8Bh6vbXaYig754PbznBsNai0sjnf29MmHuclyxCgf8tB?=
 =?us-ascii?q?P6OADgP9D8oaB822Iuwwh1epdg4EPPxV9KMsJcymc+WJ2aG1M+dghj6plnlH75?=
 =?us-ascii?q?1n3UKK9Cp8TfDI0o0Bw/GZ2AuHSjj9gE2gssDxhYBLezUSEnCjxijjAY5bfrdy?=
 =?us-ascii?q?cpoTCWeyP823wc1zhp7wW3JC6FGvHVIH2M+zdhqUYFzwxglQ1UURoXy6liq01T?=
 =?us-ascii?q?10kzc1rqWB2CzC2fjtdB0COmRTXmltkU/sIZSoj9AdREWodQkpmwe/6kbg2qdb?=
 =?us-ascii?q?o75zL2/NTkdSfij6Nn1tXbG0trWffcFP8pQosSNMXeS4YFCaTKP9ohQA3yPiGW?=
 =?us-ascii?q?te2C40dzWwtprlmBx6jXqXLGxvo3rBZcFw2RDf6cTcRP5QxDYHRDN0iSLKBli6?=
 =?us-ascii?q?JNSp+dSUl5HesuGxTW6hV5tTcTX1woOErie0+WpqARinlfCphtLnCRQ60TP819?=
 =?us-ascii?q?RyVyXHtgz8Yoro16S9K+5nZVNnBFz/68p7HIFxjI0wiYoU2XgbgJWV4HUGnX3y?=
 =?us-ascii?q?MdVdxaLxcn4NSSQXzN7S5QjvwFdjIW6Rx4LlSnWdxdNsZtmgbWMRwC497cFKCK?=
 =?us-ascii?q?GP4bxAnCt1pEe4rA3Lbfh8mDcd1eUh6HoAj+4Vvwotyz2XAqoOEklAISzsixOI?=
 =?us-ascii?q?4si9rKpNZWaja7iw1FdkktCnA7GPuQVcWHf/epc/Ei589MR/MFTQ0HLt7oHoYs?=
 =?us-ascii?q?XfbdUWtheMiRfPk/BVKI4tlvoNnSdnPGP9vX4/xOIhgx1hw4q6vJSZJGV35622?=
 =?us-ascii?q?HARYNjLuasMX+zHti7ten8mM04CuGJVhBisEXJ/yQf20FzISsOztNxySHz0ktn?=
 =?us-ascii?q?ebBb3fEBeD6EdhqnLDCZGqOGuRJHkE1tViXxidKVdbgAAVWjU6g5E4GhqrxMzn?=
 =?us-ascii?q?bEd2+DQR6kTkpRtLz+JiLwP/XXvHpAe0djc0T4CSIwFM4QFF40fVLNaS7uZuHy?=
 =?us-ascii?q?xD+p2hrQqNKnGUZghSDGEJXFCECE7nPrW0+dbA9O2YDPKkL/TSebWOtfBeV/CQ?=
 =?us-ascii?q?yJKtyIRm+iiDNt6VMnl+FfE72VdDXXNkG8TfgToPUDcalybMb86duRe99Td7rs?=
 =?us-ascii?q?G58PT3Rg3v4ZGDBKdVMdVq4xq2m7uMN/aMhCZlLjZVzpMNxXjVyLgGwV4dkSdu?=
 =?us-ascii?q?eyO2EbQHsy7NQ7ndmqtWDx4ddiNyO9FE76M63glRJ8Hbjsn52aJ/jv4wE11FT0?=
 =?us-ascii?q?Dumtm1ZcwWJGGwLFPHC1iKNLSFJj3Lwtv7YaCmSb1Xg+VbqQewuSuAE0L4OjSD?=
 =?us-ascii?q?lj/pVw2gMO1WjSGbOgBet5+5chp3FWfjS9fmYAWhMNBrlT023aE0hnTSOGEGLD?=
 =?us-ascii?q?hzaFlNoaOQ7C9ChvV/GndM7n5kLemChiaY4PPUKpcQsft3HCt0k/hW72g9y7tQ?=
 =?us-ascii?q?9CtEXuB6mDPOrt5ypFGrivWPyjtiUBZUtjlHnp6EvUV8NqXf7ZRAXXfE/BQQ7W?=
 =?us-ascii?q?SfERgKpt1lCsHxtKBU0NTAiKXzKDJa+dLO4cQcH9TUKN6AMHc5MRvmAjjUDA4E?=
 =?us-ascii?q?TT6tLW7ehkxdn+uU9n2atZU6rpnsmJwTSr5UTlA1F/UaClh7E9wGOpt4QjQkkb?=
 =?us-ascii?q?vIxPIPsFi5oQPeDP9ds5zKUrrGA/L1Lx7Jh6hYagBOxqn3e9c9LIr+jnZ/cUJ3?=
 =?us-ascii?q?mICCOEvWUpgI6gRbS0cQoUNQ4DAqSmw1xlLNYxmo5H4VCO7ymQQ5zBZ9N7d+vA?=
 =?us-ascii?q?zw6ks6cwKZ7BA7l1M8zJC82Wic?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0CaAAB/3fdbh0O0hNFjGwEBAQEDAQEBB?=
 =?us-ascii?q?wMBAQGBZYExJYEUgQInBJgKgg0UmRgWGAsIAYhWIjgSAQMBAQEBAQECARMBAQE?=
 =?us-ascii?q?IDQkIKSMMgjYkAYJiAQIDAQIkEwYBATcBBQkBAQoOCgklAwwFKCEYFoMGAYIBA?=
 =?us-ascii?q?QMBCqYegWwzgnYBAQWHEgiMCRc+gUGBEYMSgxCHSZ8vVQmRJAsYkQgsmASBXYF?=
 =?us-ascii?q?2MxoILASDJwmCEgkai0SCWEAygQUBAYwhAQE?=
X-IPAS-Result: =?us-ascii?q?A0CaAAB/3fdbh0O0hNFjGwEBAQEDAQEBBwMBAQGBZYExJYE?=
 =?us-ascii?q?UgQInBJgKgg0UmRgWGAsIAYhWIjgSAQMBAQEBAQECARMBAQEIDQkIKSMMgjYkA?=
 =?us-ascii?q?YJiAQIDAQIkEwYBATcBBQkBAQoOCgklAwwFKCEYFoMGAYIBAQMBCqYegWwzgnY?=
 =?us-ascii?q?BAQWHEgiMCRc+gUGBEYMSgxCHSZ8vVQmRJAsYkQgsmASBXYF2MxoILASDJwmCE?=
 =?us-ascii?q?gkai0SCWEAygQUBAYwhAQE?=
X-IronPort-AV: E=Sophos;i="5.56,269,1539673200"; 
   d="scan'208";a="53445158"
X-Amp-Result: UNSCANNABLE
X-Amp-File-Uploaded: False
Unscannable: 2
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 23 Nov 2018 03:02:22 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2503594AbeKWVqB (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Fri, 23 Nov 2018 16:46:01 -0500
Received: from pandora.armlinux.org.uk ([78.32.30.218]:50016 "EHLO
        pandora.armlinux.org.uk" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S2409527AbeKWVqB (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 23 Nov 2018 16:46:01 -0500
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
        d=armlinux.org.uk; s=pandora-2014; h=Sender:In-Reply-To:Content-Type:
        MIME-Version:References:Message-ID:Subject:Cc:To:From:Date:Reply-To:
        Content-Transfer-Encoding:Content-ID:Content-Description:Resent-Date:
        Resent-From:Resent-Sender:Resent-To:Resent-Cc:Resent-Message-ID:List-Id:
        List-Help:List-Unsubscribe:List-Subscribe:List-Post:List-Owner:List-Archive;
         bh=89SqnHUBJVH4SSnKUE4heYWz1CsGLkG6HBlKxGrfh/A=; b=KVJNTbQS2hUtz95SILo5ri8mn
        iYpIGO/Ejif/JzFxeVJbC82mrI9oMsim9ui/yoP02AMLqmPd8Z7xQWSEhWMQ8JRSEirpOdKrfXzbR
        WPcxmHRXCL6bWt+MzQ39fOf3akIOAhjvrP6adMyIfW2qYUkicay8b1g46hKF7415dbOa8=;
Received: from n2100.armlinux.org.uk ([fd8f:7570:feb6:1:214:fdff:fe10:4f86]:48266)
        by pandora.armlinux.org.uk with esmtpsa (TLSv1.2:ECDHE-RSA-AES128-GCM-SHA256:128)
        (Exim 4.90_1)
        (envelope-from <linux@armlinux.org.uk>)
        id 1gQ9Dl-0007YV-NJ; Fri, 23 Nov 2018 11:02:02 +0000
Received: from linux by n2100.armlinux.org.uk with local (Exim 4.90_1)
        (envelope-from <linux@n2100.armlinux.org.uk>)
        id 1gQ9Dh-0005kq-Ow; Fri, 23 Nov 2018 11:01:57 +0000
Date: Fri, 23 Nov 2018 11:01:55 +0000
From: Russell King - ARM Linux <linux@armlinux.org.uk>
To: Joerg Roedel <joro@8bytes.org>
Cc: Robin Murphy <robin.murphy@arm.com>,
        Linus Torvalds <torvalds@linux-foundation.org>,
        Christoph Hellwig <hch@lst.de>, linux-arch@vger.kernel.org,
        linux-alpha@vger.kernel.org, linux-ia64@vger.kernel.org,
        linux-parisc@vger.kernel.org,
        David Woodhouse <dwmw2@infradead.org>,
        the arch/x86 maintainers <x86@kernel.org>,
        Linux List Kernel Mailing <linux-kernel@vger.kernel.org>,
        iommu@lists.linux-foundation.org, jdmason@kudzu.us,
        xen-devel@lists.xenproject.org,
        linux-arm-kernel@lists.infradead.org, m.szyprowski@samsung.com
Subject: Re: remove the ->mapping_error method from dma_map_ops V2
Message-ID: <20181123110155.GR30658@n2100.armlinux.org.uk>
References: <20181122140320.24080-1-hch@lst.de>
 <CAHk-=wh=_T=A53+o4zLNbKio43LGqVDb0KCbWPDvAg54bRDmWw@mail.gmail.com>
 <20181122170715.GI30658@n2100.armlinux.org.uk>
 <CAHk-=wgfGzXuDAKFQPdzMib3QCRHfSTsy5=gLU-WCoya+Ym+1A@mail.gmail.com>
 <11829e3c-7302-f821-cf5c-863e5267a17b@arm.com>
 <20181123104918.GE1586@8bytes.org>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20181123104918.GE1586@8bytes.org>
User-Agent: Mutt/1.5.23 (2014-03-12)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Fri, Nov 23, 2018 at 11:49:18AM +0100, Joerg Roedel wrote:
> On Thu, Nov 22, 2018 at 05:52:15PM +0000, Robin Murphy wrote:
> > Unfortunately, with things like the top-down IOVA allocator, and 32-bit
> > systems in general, "the top 4095" values may well still be valid addresses
> > - we're relying on a 1-byte mapping of the very top byte of memory/IOVA
> > space being sufficiently ridiculous that no real code would ever do that,
> > but even a 4-byte mapping of the top 4 bytes is within the realms of the
> > plausible (I've definitely seen the USB layer make 8-byte mappings from any
> > old offset within a page, for example).
> 
> But we can easily work around that by reserving the top 4k of the first
> 4GB of IOVA address space in the allocator, no? Then these values are
> never returned as valid DMA handles.

Yuck.  So, if we have a 4GB non-PAE 32-bit system, or a PAE system
where we have valid memory across the 4GB boundary and no IOMMU,
we have to reserve the top 4K page in the first 4GB of RAM?

Linus' IS_DMA_ERR() solution is way more preferable, but unfortunately
it still falls short, because it knocks out the top 4K of every DMA
capable bus.

A DMA capable bus may involve some translation of the address (eg, by
simple offsetting) which means that we'd need to potentially knock out
multiple pages from the page allocator for each of those pages that
correspond to the top 4K of any DMA capable bus.  Knowing that at the
right time at boot will be fun!  It also sounds wasteful to me.

Rather than inventing magic cookies like this, I'd much rather we
sanitised the API so that we have functions that return success or
an error code, rather than trying to shoe-horn some kind of magic
error codes into dma_addr_t and subtly break systems in the process.

-- 
RMK's Patch system: http://www.armlinux.org.uk/developer/patches/
FTTC broadband for 0.8mile line in suburbia: sync at 12.1Mbps down 622kbps up
According to speedtest.net: 11.9Mbps down 500kbps up
