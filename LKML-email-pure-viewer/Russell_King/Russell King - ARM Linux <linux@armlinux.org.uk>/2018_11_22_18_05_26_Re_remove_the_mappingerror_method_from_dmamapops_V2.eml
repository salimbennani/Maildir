Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 08:30:40 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga002.fm.intel.com (fmsmga002.fm.intel.com [10.253.24.26])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 3F93C58037D;
	Thu, 22 Nov 2018 10:05:44 -0800 (PST)
Received: from fmsmga103.fm.intel.com ([10.1.193.90])
  by fmsmga002-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 22 Nov 2018 10:05:43 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AW1k8ohUKFcRF490hulfrLBYlm4TV8LGtZVwlr6E/?=
 =?us-ascii?q?grcLSJyIuqrYZhKEuadThVPEFb/W9+hDw7KP9fy4CSpYud6oizMrSNR0TRgLiM?=
 =?us-ascii?q?EbzUQLIfWuLgnFFsPsdDEwB89YVVVorDmROElRH9viNRWJ+iXhpTEdFQ/iOgVr?=
 =?us-ascii?q?O+/7BpDdj9it1+C15pbffxhEiCCybL9uLxi6txndutULioZ+N6g9zQfErGFVcO?=
 =?us-ascii?q?pM32NoIlyTnxf45siu+ZNo7jpdtfE8+cNeSKv2Z6s3Q6BWAzQgKGA1+dbktQLf?=
 =?us-ascii?q?QguV53sTSXsZnxxVCAXY9h76X5Pxsizntuph3SSRIMP7QawoVTmk8qxmUwHjhj?=
 =?us-ascii?q?sZODEl8WHXks1wg7xdoBK9vBx03orYbJiIOPZiYq/ReNUXTndDUMlMTSxMGo2y?=
 =?us-ascii?q?YYsRAeQcPuhYoYbyqEcTohS8CwasH/vvxz1Ti3/qwaE2z/gtHR3c0QA+Gd8FrX?=
 =?us-ascii?q?TarM/yNKcXSe270LTIzS7Yb/xI3Tf97JXDfBUgofGKUrJ7bNPdwlQzGg3ZiVub?=
 =?us-ascii?q?tIrrPzKT1uQQvGmQ8u1tVeaui24htgFwrSOiyd02ionMgoIVy1bE9Th2wYovIt?=
 =?us-ascii?q?24UkF7bcS5EJtTriyXMZZ9TM0lQ2Ftoik6y7sGtIahcygQzZQnwx/fa/qac4mH?=
 =?us-ascii?q?+B7jU/yRIThiiHJ4e7Kznw2y8VC+xeLiS8a0zEhFrjFZktXWsHACyQDT586aQf?=
 =?us-ascii?q?V+5keswSiD2xzX5+1ePEw5m7TXJ4Q8zrMzipYfq0XOEy3ulEnokKOaalgo9+2n?=
 =?us-ascii?q?5uv6bbjrpZqROJVphQz+LKgjn8KyDfokPgQTWmWX5/mw2bLm8E33XbpKgPM2n6?=
 =?us-ascii?q?zXsJ/EOMgXuqu0DgBb0osg6huyCSqt3s4CknkdNl1FfQqKj4j3NFHKJ/D1Fem/?=
 =?us-ascii?q?g1uynzdx3fzGPaPuAo/LLnfdlLftZ7F961RTyAYrzNBf4YxbCq0ZLf7tRkP8sM?=
 =?us-ascii?q?bUAgI3PgCq2errFdZw2p8EVW+OAKKVKKbSvkWJ5uIrLemMfogVuDPlJvgh5v7u?=
 =?us-ascii?q?i2I5mFAEcamqw5QXcna4EepiI0mAZnrtjNEBHnkQvgclUuzqh0ONUSRJa3axQa?=
 =?us-ascii?q?08/Dc7B5yiDYvZQYCtmrOB0D+hHpJKfmBGFkyMEXDweoWAWvcMazydLtVukzwZ?=
 =?us-ascii?q?TrWhT44h1ReztA710bZnL+zU+jEGupLnztR6++rTlRQq/zxuE8udy32NT31znm?=
 =?us-ascii?q?4QRz85xqF/oVBnxVeEy6R4g+FYGsZV5/NGSQo6MZ/cz+pnC9H9QA7Bf9GJSEq4?=
 =?us-ascii?q?TdWiGz0+UtUxw9oWaUZnB9qilgzD3zatA7INlbyLA4I7/rjf33j2IcZ9zXHG2b?=
 =?us-ascii?q?Ilj1knRMtPKGKnirR+9wjVG47GjUGZm7y2eqQb2S7H7H2DwnaWvEFETA5wVr3I?=
 =?us-ascii?q?UmoEZkvWqtT55VnOT6W0BrQlKQZBzc+CKq1Xatzml1lGRfHjOMjAbGK1gWu/GR?=
 =?us-ascii?q?GIxraUZorwZ2odxDndCFQDkw0L/naJLw4+Cj2lo2LfFjNuE13vbljo8el/rnO7?=
 =?us-ascii?q?U0A1wxuLb01ny7q65BoVieaARPMU27IOoD0hpClsHFahw9LWDMKNqBd7c6VCf9?=
 =?us-ascii?q?wx+ldH2njftwxmIJOgKaduhlodcwRyu0PjzBF3CoRGkcg3o3Im1gtyKaSE0Fxf?=
 =?us-ascii?q?czOUx4z/OrrSKmPq5hCgd7bW2k3C0NaR4qoA9e43q0v9sw2zFkot6XNn08JL3H?=
 =?us-ascii?q?ua/ZjKCAsSUZTsUkc47RR6prfaYjUj6IPQz3FjLa60sjra0dIzGOQl0gqgf8tY?=
 =?us-ascii?q?MK6cCA/yEsgaB8+yKOwqm1mldA4EMPpV9K4uO8Omdv2G2KGwMeZknTKmi3lH4Y?=
 =?us-ascii?q?9n3kKN8Sp8VvDH35Ifz/6E2QuHUi/2jE29vcDvhYBEeTYSE3KlxijgGoFQabN9?=
 =?us-ascii?q?fIYRBWi1Ps24289xh5juW35f6l6uHFcG2M6veRqPYF3xxwxQ1UILoXO5nSu01S?=
 =?us-ascii?q?B7kzYsrqCHxizB3/zidAYbOm5MXGRjjUrsLZKogNwAXUmobxImlB2q5Uvhw6hb?=
 =?us-ascii?q?paJ/L3TcQEtSfij2KX1iXbW0traYf8FP75Youz1NUOugeVCaVqL9oxwC3iP5Hm?=
 =?us-ascii?q?tR2Co0dyu3tZX+hRB6jnySLGxyrHbAZc5/3xPf68HCSv5L2ToGQjJ1iT3WBli6?=
 =?us-ascii?q?Itmo8s+Yl5bFsuCiSW2hUodffjXszYOFrCG7/3FlAQWjn/Cvnd3qCQg70S7h29?=
 =?us-ascii?q?hqTynItwv8Yo/w2qS+MOJneFRoBVDm58p7HIF+jpU/hJUK1XcGgZWV+GINkX3v?=
 =?us-ascii?q?PtVDxaL+cH0NSCYJw9HP+gjl205jLnWTy4LiTHqdwchhZ9i8YmwI3CIw9MRKCK?=
 =?us-ascii?q?aS7LxZkip5uFu4rQTNYfdjmjcR0+ch6Hkfg+sRogoi0j2dAqwOHUlfJSHtlw6H?=
 =?us-ascii?q?79ekoKVVZWavd6O91E5/ndCnEbGDrRtQWHf/epc+AyBw6t9zP07L0H328ovkYs?=
 =?us-ascii?q?XfbcoPth2IlBfNl+tVJ4gwlvYQhSpnJHjyvXsqy+MgiRxu3Je6vJWIKml3/aK5?=
 =?us-ascii?q?BAJYOSPxZ88J5j7tiqNelN6M34+zBpVhBikLXJzwQPKtETIStu7oOxyAETIisX?=
 =?us-ascii?q?ebBaTQHRWE50h4tXLPHIumN3WWJHkf0NVjSwORJE1ZgAAIQjo6moQ1GRytxMzk?=
 =?us-ascii?q?aE15/Cwe5kbkqhtQzeJlLwX/UmDapAuyazY7Up6fLAdN7gFZ5kfYKsie7uN1Hy?=
 =?us-ascii?q?FF8Zyttg2NKmqHZwtWCWEFQFCLB1fmPrO2/9nP7/CYBvaiL/vJebiBsvZRV/CM?=
 =?us-ascii?q?xZKyyIdm+yuMO96LPnljCf07x0VCUWp4G8TfhzUAVSgXmzjRYM6coRe24jd3od?=
 =?us-ascii?q?yn8PT3RALv4pOCC7lIPtVq5R+2mr2PN/KKiCZ6NDZY1Y4MxXnSx7gEx1MSjyBu?=
 =?us-ascii?q?dz+wEbUPryLNTaTQmrNJAB4fcS98KMxI76ck1AlXJcHbks/11qJ/jvMtC1ZFUk?=
 =?us-ascii?q?Hhmti0ZcMQJWGxLkjHBEGNNLSJPjDLx8D3YaWhSbxflulUthuwuSqFHE/nJDiM?=
 =?us-ascii?q?iz7pVxW3O+FWkC6bJABeuJ26cht1CWjsUtPmah64MN92lzE2wqc0hnTFNWECKz?=
 =?us-ascii?q?h8blhNo6aU7SNZhPV/BmNA4mBkLemChyaW8e3YJowKvvtsByR+j/ha72giy7tJ?=
 =?us-ascii?q?8CFEQ+R4lzHPrtF1uVGpjOmOxiBjUBpPsTtLgIOLvUN/OaTW7JVAWHDE/A4T4m?=
 =?us-ascii?q?WUERgFu9xlCtj3saBK1tfPjL7zKCtF89/M4cscBs3UJNibP3Y7LRXpGCDbDA0e?=
 =?us-ascii?q?QD6vNGHfgVFdkf6I+n2UqJg6tobjmJ4URrBHU1w1E+sQCl55E9waPJd3QjQknK?=
 =?us-ascii?q?abjcES43q+qRjRRMNCsZHGVvKdG/PvKDmCgLlAZhsIx674LIsJOo363Uxidkd1?=
 =?us-ascii?q?nIDQF0XMWtBNp34pUghhhERL7WM2cmopxUvhZhjltGMUD+C9mhItog9/Z/k9sT?=
 =?us-ascii?q?nr/lE7L0bLoy12l1M+z4bLmzeUJQTsN7y9WYUeKCvyuAB0errBZk5RbAuvjQQw?=
 =?us-ascii?q?MDbCWqJ5hqFlcWFtlR+avoFAX+NfG/4XKCQMzO2aMq17mW9XrT+qkAoevbPI?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ACAACp7vZbh0O0hNFiGgEBAQEBAgEBA?=
 =?us-ascii?q?QEHAgEBAQGBUgQBAQEBCwGBMIE5gQInmBGCDRRmlkCBcRYYCwgBiFIiNQgNAQM?=
 =?us-ascii?q?BAQEBAQECARMBAQEIDQkIKSMMgjYkAYJiAQIDAQIkEwYBASUSAQUJAQEKGAklA?=
 =?us-ascii?q?wwFKCETBYMcAYIBAQMBCqgzgWwzgnYBAQWHGgiMCRc+gUGBEYJdNYMQh0mJNJZ?=
 =?us-ascii?q?QCZEkCxiRCCyYBIFHAYILMxoILASDJwmCEgwXi0SCWEAygQUBAYxUAQE?=
X-IPAS-Result: =?us-ascii?q?A0ACAACp7vZbh0O0hNFiGgEBAQEBAgEBAQEHAgEBAQGBUgQ?=
 =?us-ascii?q?BAQEBCwGBMIE5gQInmBGCDRRmlkCBcRYYCwgBiFIiNQgNAQMBAQEBAQECARMBA?=
 =?us-ascii?q?QEIDQkIKSMMgjYkAYJiAQIDAQIkEwYBASUSAQUJAQEKGAklAwwFKCETBYMcAYI?=
 =?us-ascii?q?BAQMBCqgzgWwzgnYBAQWHGgiMCRc+gUGBEYJdNYMQh0mJNJZQCZEkCxiRCCyYB?=
 =?us-ascii?q?IFHAYILMxoILASDJwmCEgwXi0SCWEAygQUBAYxUAQE?=
X-IronPort-AV: E=Sophos;i="5.56,266,1539673200"; 
   d="scan'208";a="53003143"
X-Amp-Result: UNKNOWN
X-Amp-Original-Verdict: FILE UNKNOWN
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 22 Nov 2018 10:05:42 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2437884AbeKWEqH (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Thu, 22 Nov 2018 23:46:07 -0500
Received: from pandora.armlinux.org.uk ([78.32.30.218]:38586 "EHLO
        pandora.armlinux.org.uk" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1732278AbeKWEqH (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 22 Nov 2018 23:46:07 -0500
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
        d=armlinux.org.uk; s=pandora-2014; h=Sender:In-Reply-To:Content-Type:
        MIME-Version:References:Message-ID:Subject:Cc:To:From:Date:Reply-To:
        Content-Transfer-Encoding:Content-ID:Content-Description:Resent-Date:
        Resent-From:Resent-Sender:Resent-To:Resent-Cc:Resent-Message-ID:List-Id:
        List-Help:List-Unsubscribe:List-Subscribe:List-Post:List-Owner:List-Archive;
         bh=N4CV8ysM1JNoWjV3SiM6rmjmtwJouHiteGJ0+jJ/54c=; b=PZ4hq4h1B0TRfePfQtDBNFoa0
        SMzuGYNOVNxZfLYs2Yxum8f/zfTnfCGvqNFNEkUckQrTyZ9VnGeZR25qXlbkJ1OMM//oQu0E2jduc
        iuE4fveWoQSvJ2FkhFpPDXtxRbm5LLUVadUIuCDhqqDHRSxzQOZIdJ29sL1phZkuYeAJY=;
Received: from n2100.armlinux.org.uk ([2001:4d48:ad52:3201:214:fdff:fe10:4f86]:54339)
        by pandora.armlinux.org.uk with esmtpsa (TLSv1.2:ECDHE-RSA-AES128-GCM-SHA256:128)
        (Exim 4.90_1)
        (envelope-from <linux@armlinux.org.uk>)
        id 1gPtM3-0003NI-RV; Thu, 22 Nov 2018 18:05:32 +0000
Received: from linux by n2100.armlinux.org.uk with local (Exim 4.90_1)
        (envelope-from <linux@n2100.armlinux.org.uk>)
        id 1gPtM0-0004NA-Fv; Thu, 22 Nov 2018 18:05:28 +0000
Date: Thu, 22 Nov 2018 18:05:26 +0000
From: Russell King - ARM Linux <linux@armlinux.org.uk>
To: Linus Torvalds <torvalds@linux-foundation.org>
Cc: robin.murphy@arm.com, linux-arch@vger.kernel.org,
        linux-ia64@vger.kernel.org, linux-parisc@vger.kernel.org,
        joro@8bytes.org, the arch/x86 maintainers <x86@kernel.org>,
        Linux List Kernel Mailing <linux-kernel@vger.kernel.org>,
        iommu@lists.linux-foundation.org, linux-alpha@vger.kernel.org,
        xen-devel@lists.xenproject.org, jdmason@kudzu.us,
        David Woodhouse <dwmw2@infradead.org>,
        Christoph Hellwig <hch@lst.de>,
        linux-arm-kernel@lists.infradead.org, m.szyprowski@samsung.com
Subject: Re: remove the ->mapping_error method from dma_map_ops V2
Message-ID: <20181122180526.GL30658@n2100.armlinux.org.uk>
References: <20181122140320.24080-1-hch@lst.de>
 <CAHk-=wh=_T=A53+o4zLNbKio43LGqVDb0KCbWPDvAg54bRDmWw@mail.gmail.com>
 <20181122170715.GI30658@n2100.armlinux.org.uk>
 <CAHk-=wgfGzXuDAKFQPdzMib3QCRHfSTsy5=gLU-WCoya+Ym+1A@mail.gmail.com>
 <11829e3c-7302-f821-cf5c-863e5267a17b@arm.com>
 <CAHk-=whxf0zqutExPr_j1A625Z3gcL6k_ABzKo1BtzN4F93hkA@mail.gmail.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <CAHk-=whxf0zqutExPr_j1A625Z3gcL6k_ABzKo1BtzN4F93hkA@mail.gmail.com>
User-Agent: Mutt/1.5.23 (2014-03-12)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Thu, Nov 22, 2018 at 09:55:25AM -0800, Linus Torvalds wrote:
> On Thu, Nov 22, 2018 at 9:52 AM Robin Murphy <robin.murphy@arm.com> wrote:
> >
> > Unfortunately, with things like the top-down IOVA allocator, and 32-bit
> > systems in general, "the top 4095" values may well still be valid
> > addresses -
> 
> Ugh.
> 
> > The only immediate benefit I can see is that we could distinguish cases
> > like the first which can never possibly succeed, and thus callers could
> > actually give up instead of doing what various subsystems currently do
> > and retry the exact same mapping indefinitely on the apparent assumption
> > that errors must be transient.
> 
> No, the big immediate benefit of allowing "return -EINVAL" etc is
> simply legibility and error avoidance.
> 
> It's basically how pretty much all the rest of the kernel returns
> errors, so not only is it very obvious, it's also what people do
> without even thinking.. So it would be good to work.

An alternative idea would be to migrate away from the
dma_map_single() and dma_map_page() interfaces that return a
dma_addr_t, and instead have them return an error code or zero
on success.

I've thought for some time that our DMA interfaces aren't particularly
friendly, especially after we had the stuff with PCI DMA which migrated
its way into the DMA API:

DEFINE_DMA_UNMAP_ADDR
DEFINE_DMA_UNMAP_LEN
dma_unmap_*

When coupled that with the requirement that dma_unmap_*() should be
called with the same parameters as dma_map_*(), I wonder why we never
did:

struct dma_map_state {
	dma_addr_t dma_addr;
	whatever's needed;
}

int dma_map_single(struct device *dev, struct dma_map_state *state,
		   void *cpu, size_t len, enum dma_data_direction dir);
void dma_unmap_single(struct device *dev, struct dma_map_state *state);

note the simpler unmap API, which inherently guarantees that the
parameters to the map could be carried over to the unmap - without
our many driver authors having to think about it.

That also paves the way for dma_map_single() to return an error code
or zero.

However, I fear that boat sailed long ago - but maybe its worth
thinking along these lines if we want to sanitise the API now?

-- 
RMK's Patch system: http://www.armlinux.org.uk/developer/patches/
FTTC broadband for 0.8mile line in suburbia: sync at 12.1Mbps down 622kbps up
According to speedtest.net: 11.9Mbps down 500kbps up
