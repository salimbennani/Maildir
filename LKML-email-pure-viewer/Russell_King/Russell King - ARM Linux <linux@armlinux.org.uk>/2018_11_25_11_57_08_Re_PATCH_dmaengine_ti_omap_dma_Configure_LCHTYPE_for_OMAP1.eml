Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 25 Nov 2018 22:13:23 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga002.jf.intel.com (orsmga002.jf.intel.com [10.7.209.21])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id AE7905802E4;
	Sun, 25 Nov 2018 03:57:37 -0800 (PST)
Received: from orsmga103.jf.intel.com ([10.7.208.35])
  by orsmga002-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 25 Nov 2018 03:57:37 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AvrWl7B/lxHqURv9uRHKM819IXTAuvvDOBiVQ1KB9?=
 =?us-ascii?q?1e4WIJqq85mqBkHD//Il1AaPAd2Lraocw8Pt8InYEVQa5piAtH1QOLdtbDQizf?=
 =?us-ascii?q?ssogo7HcSeAlf6JvO5JwYzHcBFSUM3tyrjaRsdF8nxfUDdrWOv5jAOBBr/KRB1?=
 =?us-ascii?q?JuPoEYLOksi7ze+/94HQbglSmDaxfa55IQmrownWqsQYm5ZpJLwryhvOrHtIeu?=
 =?us-ascii?q?BWyn1tKFmOgRvy5dq+8YB6/ShItP0v68BPUaPhf6QlVrNYFygpM3o05MLwqxbO?=
 =?us-ascii?q?SxaE62YGXWUXlhpIBBXF7A3/U5zsvCb2qvZx1S+HNsDtU7s6RSqt4LtqSB/wiS?=
 =?us-ascii?q?cIKTg58H3MisdtiK5XuQ+tqwBjz4LRZoyeKfhwcb7Hfd4CS2RPXthfWTFCDIOy?=
 =?us-ascii?q?YIQAE/cOMuRWoInmv1sDrwCzBRWwCO/z1jNEmmX70bM83u88EQ/GxgsgH9cWvX?=
 =?us-ascii?q?rIsdX1L7wSXv6xzKnM0D7NavJW2THy6IPVaxwqvO2BU653f8HMz0cvFgXFjkif?=
 =?us-ascii?q?qIf4OD6V0uUNs26G7+tvTu+gkXQnqwR1ojiuwMcsl4bIipgSylDe+iV12ps1Jd?=
 =?us-ascii?q?6hRUN9fNWqHpxQtySAOIt3RMMvW3tnuDw/yr0CuJ67ejUKyZs9yx7YcfyHfJKE?=
 =?us-ascii?q?4g/gVOqJOjd4nGxqd6yiiBau70eg0fH8WtOy0FlUsipJitzMuWoX1xPP8MSHS/?=
 =?us-ascii?q?19/kmm2TuJygvd6flELFgqmabHL5Mt2KM8m5QNvUjZAyP7m1n6gLWXe0gm4uSk?=
 =?us-ascii?q?9fjrbqn7qpKZOIJ7lw7zP6crl8OlHOs1MhYCUm2V9OiiyLHv4Ej0TKtXgvA5l6?=
 =?us-ascii?q?TZvo3VJcoVpqO8DQ9azJsv5wq6Ajqp3tQVnngKIVRYcxydlYfpIUvBIPXgAPe/?=
 =?us-ascii?q?nVuslDBryujYPr3uHJrNNGLPkLT/crZn7U5T1g4zwcpY55JOBbENOPPzWknvu9?=
 =?us-ascii?q?zEFhI1LRC4zuL9BNlg2I4SR3iDDrKaPa/Oq1OF5+AiL/GJZIAPuTb9L/Yl5+Tp?=
 =?us-ascii?q?jX88gVIdeaip3Z0KaHG3B/hmIFuWYWDqgtgfFWcGpw0+TeLsiFKcSz5efGiyX6?=
 =?us-ascii?q?0i6TEhEo6mDpnMRpqrgLOf2Ce3BJpWZnpJClyUC3fna52EW+sQaCKVOsJhlj0E?=
 =?us-ascii?q?Vbu/RIM72hCuqRT3y75mLurS5y0Zuojv1Nlz5+3Pix4y8SZ4ANia02GIV2t0hH?=
 =?us-ascii?q?8HRycq3KBjpkxw0leD3rJ5g/xED9NT4OlFUgcnNZHGyex6BMv/WgbAftePVVan?=
 =?us-ascii?q?Tc+qATA3TtIt3dAOZ1xxFMmljhDGxyCqGaMal6SXBJwo9aLRx3rxJ8FjxHrc16?=
 =?us-ascii?q?khiF8mQs1INWC9gq5/9g7TB5PGkkmDlqaqc7gc0zDJ9GuZ0WWOu0RYWhZqUarZ?=
 =?us-ascii?q?RXAfelfWrdPh60zYVL+uCbMnMghbxc6YMKRKaMbkjVFHRPflJdTfbHi9m2a2BR?=
 =?us-ascii?q?aU2LyMaJDmdHka3CXYEEIEiRwc/W6aNQgiASesu2HeAyZoFV71Z0Ps8PNxqHW0?=
 =?us-ascii?q?TkIvywGKbkth16e6+xIPhPycTe8T0awAuCs7tzp0G1O91crMC9WcvwphYLlcYd?=
 =?us-ascii?q?Ql7Vhaz23ZqRJyMoagL694gF4eaBp4v0Xp2xVzCYVAlMwqoWguzApzL6KYzVxA?=
 =?us-ascii?q?eymZ3ZD2Jr3YNG3y8AqzZK7R31HUyMyW9bsX6PQkt1XjuxmkGVc4/HV5zdZZyX?=
 =?us-ascii?q?uc6Y/MDAoJT53xVF069xx7p7Hcfyk86JnY1XxqMamorDDC38glC/ciyhalZ91f?=
 =?us-ascii?q?Kr+LFBfuE80GAMijMPAqm1msbhIDIOBS9K41M9m6d/ec366rJuJgnDOgjWRI+4?=
 =?us-ascii?q?191kOM9yxhSu/HxZoFwveY3heZWDf4lluursf3mYVcbzEIAmW/0TTkBJJWZqBq?=
 =?us-ascii?q?Z4kLDXmhIsKpydR+nZLiQGNY+0O5CFMA28+pfgSSYkf53Q1R00QXvHOmlTG5zz?=
 =?us-ascii?q?xyjzEmsK6f0DbSzOTlcRoNInRLS3V6jVfwPYi0iMgXXUi1bwQziBSp/0f7x6hB?=
 =?us-ascii?q?q6R5IGneWkNIfynwL2F/Xaq8rLuCY8hT6Jw2tSVbSvizYVefSrTluRsVzzvjH3?=
 =?us-ascii?q?dCxDA8bzyqoJT5kABgh2KHMXlzq2DVecduyhfF5dzQXOJe0SACRCZllzbXHF+8?=
 =?us-ascii?q?P9+y8NWQlpfDtP2+Vm27Wp1Sdynr0Z2PtC+h6WJ2Bh2/mui5msf7HggizS/7y9?=
 =?us-ascii?q?5qWD3IrRb9eIXq1762Mfl6fkluH1L878t6Godjkoo/np0Q2H4ahomL8noDi2v8?=
 =?us-ascii?q?LdJb2afmZnoXWTEL28LV4BTi2EB7LHKG3Zj5VnaewstmfdW6eXkZ2iE+78BLDq?=
 =?us-ascii?q?eb8rpEkDBxolq5qwLRfPd8ki0cyfso9H4VneUJtBAxwSWaB7AYBVNYMjD0lxSU?=
 =?us-ascii?q?89C+q71aZWa1fri3zkZ+n9GhDLeZrwFYWXb5fIoiHCBq4sV+NlLMzGP86oX+dN?=
 =?us-ascii?q?bMatITswWekw3cgOhNNJIxiv0KiDJkOW3nvH0p0e47jQF00pG8s4iKMGFt/KO/?=
 =?us-ascii?q?Ah5FOTz5fcIT+jfxjalAmsaaxZygHpJkGj8TRpvnUeqoEC4OtfTgLwuOFTw8qn?=
 =?us-ascii?q?SBFrbFEw6Q9lxmr27RHJCxLH6YOmMZzdp5SRmZJUxfhh0UXTogkp44EACq2NLu?=
 =?us-ascii?q?cENj6j8N4V74rwNGyvh0OBnnTmffuACoZy8oSJiYKRpa9ABD6F3TMcyD9eJzBC?=
 =?us-ascii?q?BY84alrAyMLGybegtJAXsIWkyCG1DsIL2u6cPc/OifA+q0N+HObqmWqexCS/eI?=
 =?us-ascii?q?woqi3ZB88DaLMsWPI2NuD/km2kdYWXB5GsLZmygASiANliLNadKbqwm4+iFtss?=
 =?us-ascii?q?+/9/HrUhr15YSTE7tSLclv+xeujKeBLeGQgTh2KS1C2pMQ33PIy6Uf3F0PiyFo?=
 =?us-ascii?q?bTatCq8NtSrMTKLWh69WAAQXayJ1NMtU8a082hNBNtLcitPwzrR4lOI6C09ZVV?=
 =?us-ascii?q?z9ncGkfcwLI2agNFPeGUaELrKGKSfQw8HwZ6O8RqZdjOFVtx22pDaaHFXvPjWF?=
 =?us-ascii?q?lzn1SR+vNftAgz2cPBxboIu9aApiCXD/TNL6bR22KN93giM3wb03hXPKNHQQMT?=
 =?us-ascii?q?tmc0NKob2f8zlYguhkG2Fa6nplLO+EmzuW7uXCK5YWt+drDTpwl+5A/Hs6zL5V?=
 =?us-ascii?q?5jleRPNpgCvSssJuo1a+n+aV1zpoSwBOpShLhY6RuUViOL7U9p1BWXbC4RIM4n?=
 =?us-ascii?q?+cCxUMp9t5FNLvv7pcxcTIlKL2MD1C6c7b/dMAB8jIL8KKKGYhMRvsGDLOEAQJ?=
 =?us-ascii?q?VyKkNWHBiExbi/yS8nyVrp4nqpnjgpYOS7lbVEArGfMeEEhqANsCIJJvVDM+jb?=
 =?us-ascii?q?GblNII5Wa5rBTJRMRVpJbHVveTAfXpMDmYjLlEaAEOwbP3NokTMoz720p/alh1?=
 =?us-ascii?q?hojKGkzQXcxTrS1ldAM7vEJN8H0tBlE0jn7ibBLlxH4VGfGukxh+3hd5Z/UF/S?=
 =?us-ascii?q?vr5lY7KxzBoy5mw2crntCwuy2KazP1KO+TXIdZQ2+8nnIUerf6RRtlJVm2nEp5?=
 =?us-ascii?q?JB/NXbdVjr19ZSZskgCapJgZSq0UdrFNfBJFnaLfXP4vy1kJ73z/nUI=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0BPAACKjfpbh0O0hNFjHAEBAQQBAQcEA?=
 =?us-ascii?q?QGBVAQBAQsBgTCBOYECJ4RbkzWCDRSIeJAjFBgLCAGIWiI3Bg0BAwEBAQEBAQI?=
 =?us-ascii?q?BEwEBAQgNCQgpIwyCNiQBgmIBAgMBAiQTBgEBNwEFCQEBChQECSUDDAUNGyEKC?=
 =?us-ascii?q?QWDHAGBaQMVAQMBCqVXgWwzgnYBAQWEdQ2CEQiMCRc+gUGBEYMSglY6CwQYhHy?=
 =?us-ascii?q?CJokTDpY1LgmGfIcIgyALGIFZiC6HASyNF4EKiWOBXIF3MxoILASDJwkKgW0bC?=
 =?us-ascii?q?RqGI4UhglhAMoEFAQGMagEB?=
X-IPAS-Result: =?us-ascii?q?A0BPAACKjfpbh0O0hNFjHAEBAQQBAQcEAQGBVAQBAQsBgTC?=
 =?us-ascii?q?BOYECJ4RbkzWCDRSIeJAjFBgLCAGIWiI3Bg0BAwEBAQEBAQIBEwEBAQgNCQgpI?=
 =?us-ascii?q?wyCNiQBgmIBAgMBAiQTBgEBNwEFCQEBChQECSUDDAUNGyEKCQWDHAGBaQMVAQM?=
 =?us-ascii?q?BCqVXgWwzgnYBAQWEdQ2CEQiMCRc+gUGBEYMSglY6CwQYhHyCJokTDpY1LgmGf?=
 =?us-ascii?q?IcIgyALGIFZiC6HASyNF4EKiWOBXIF3MxoILASDJwkKgW0bCRqGI4UhglhAMoE?=
 =?us-ascii?q?FAQGMagEB?=
X-IronPort-AV: E=Sophos;i="5.56,277,1539673200"; 
   d="scan'208";a="53589804"
X-Amp-Result: UNSCANNABLE
X-Amp-File-Uploaded: False
Unscannable: 2
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 25 Nov 2018 03:57:35 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1726098AbeKYWs2 (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Sun, 25 Nov 2018 17:48:28 -0500
Received: from pandora.armlinux.org.uk ([78.32.30.218]:53668 "EHLO
        pandora.armlinux.org.uk" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1726023AbeKYWs2 (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sun, 25 Nov 2018 17:48:28 -0500
DKIM-Signature: v=1; a=rsa-sha256; q=dns/txt; c=relaxed/relaxed;
        d=armlinux.org.uk; s=pandora-2014; h=Sender:In-Reply-To:Content-Type:
        MIME-Version:References:Message-ID:Subject:Cc:To:From:Date:Reply-To:
        Content-Transfer-Encoding:Content-ID:Content-Description:Resent-Date:
        Resent-From:Resent-Sender:Resent-To:Resent-Cc:Resent-Message-ID:List-Id:
        List-Help:List-Unsubscribe:List-Subscribe:List-Post:List-Owner:List-Archive;
         bh=BmHVmUH0NvoDAS4ecEKcpyEUAeUvaMI02S+JU15xPiQ=; b=TbZTrKDWz463mJ+YS/RTYklLC
        YyoNHYTiA2rD/+b6td5y88ShAE/C1ZiAz1pB18/prfEs/xlh2/LnRmxxQ13H+OeXvNKuZYLuiIofY
        fE1mBRZWHg82cORXkt0cFoX1QEYlEm0xtJpoad3ohmhIH3XPLn/Pu4Zg+l6TU13VVa598=;
Received: from n2100.armlinux.org.uk ([2001:4d48:ad52:3201:214:fdff:fe10:4f86]:43926)
        by pandora.armlinux.org.uk with esmtpsa (TLSv1.2:ECDHE-RSA-AES128-GCM-SHA256:128)
        (Exim 4.90_1)
        (envelope-from <linux@armlinux.org.uk>)
        id 1gQt2P-0003cJ-Bq; Sun, 25 Nov 2018 11:57:21 +0000
Received: from linux by n2100.armlinux.org.uk with local (Exim 4.90_1)
        (envelope-from <linux@n2100.armlinux.org.uk>)
        id 1gQt2G-0007pe-TL; Sun, 25 Nov 2018 11:57:14 +0000
Date: Sun, 25 Nov 2018 11:57:08 +0000
From: Russell King - ARM Linux <linux@armlinux.org.uk>
To: Tony Lindgren <tony@atomide.com>
Cc: Aaro Koskinen <aaro.koskinen@iki.fi>,
        Peter Ujfalusi <peter.ujfalusi@ti.com>, vkoul@kernel.org,
        dan.j.williams@intel.com, dmaengine@vger.kernel.org,
        linux-kernel@vger.kernel.org, linux-omap@vger.kernel.org
Subject: Re: [PATCH] dmaengine: ti: omap-dma: Configure LCH_TYPE for OMAP1
Message-ID: <20181125115707.GA29909@n2100.armlinux.org.uk>
References: <20181119184649.GE16897@darkstar.musicnaut.iki.fi>
 <6af8c6e7-bf5c-5555-161b-5d3fb7ecae43@ti.com>
 <20181120210406.GB24888@darkstar.musicnaut.iki.fi>
 <20181122102948.GN6920@n2100.armlinux.org.uk>
 <20181122151236.GA9611@n2100.armlinux.org.uk>
 <6ed280af-edb6-4be7-82f4-7fc00378103e@ti.com>
 <20181123185215.GH12912@darkstar.musicnaut.iki.fi>
 <20181124200942.GS6920@n2100.armlinux.org.uk>
 <20181125010717.GJ53235@atomide.com>
 <20181125111105.GT6920@n2100.armlinux.org.uk>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20181125111105.GT6920@n2100.armlinux.org.uk>
User-Agent: Mutt/1.5.23 (2014-03-12)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Sun, Nov 25, 2018 at 11:11:05AM +0000, Russell King - ARM Linux wrote:
> On Sat, Nov 24, 2018 at 05:07:17PM -0800, Tony Lindgren wrote:
> > * Russell King - ARM Linux <linux@armlinux.org.uk> [181124 20:10]:
> > > On Fri, Nov 23, 2018 at 08:52:15PM +0200, Aaro Koskinen wrote:
> > > > Hi,
> > > > 
> > > > On Fri, Nov 23, 2018 at 02:35:04PM +0200, Peter Ujfalusi wrote:
> > > > > On 22/11/2018 17.12, Russell King - ARM Linux wrote:
> > > > > > I'm also not sure about this:
> > > > > > 
> > > > > >         if (cpu_is_omap15xx())
> > > > > >                 end++;
> > > > > > 
> > > > > > in dma_dest_len() - is that missing from the omap-dma driver?  It looks
> > > > > > like a work-around for some problem on OMAP15xx, but I can't make sense
> > > > > > about why it's in the UDC driver rather than the legacy DMA driver.
> > > > > 
> > > > > afaik no other legacy drivers were doing similar thing, this must be
> > > > > something which is needed for the omap_udc driver to fix up something?
> > > > 
> > > > Here's the patch that added it: https://marc.info/?l=linux-omap&m=119634396324221&w=2
> > > > 
> > > > "Make DMA-OUT behave on the 1510 ... the 1510 CPC register was just
> > > > off-by-one with respect to the 1611 CDAC"
> > > 
> > > ... which suggests that's a problem with the CPC register itself, and
> > > we should fix that in the DMAengine driver rather than the USB gadget
> > > driver.
> > > 
> > > Tony, any input on this?
> > 
> > Yeah that sounds like some hardware work-around for 15xx as described
> > in the DMA_DEST_LAST macro reading CSAC on 15xx instead of CDAC. Seems
> > like it should be done in the dmaengine driver.. My guess is that other
> > dma users never needed to read CSAC register?
> 
> Hmm, reading the OMAP1510 TRM for the CPC register, it seems that
> omap-dma won't handle this particularly well.  The fact that the
> register only updates after the last request in an element or frame
> means that if we try to use this value as the current source /
> destination address before the first transfer, it can be wildly
> wrong.
> 
> Saving the current value at the beginning of a request, and detecting
> if it's changed (like omap_udc) isn't going to work well in the
> generic case.  If, say, the register happens to contain 0x0004, and
> our next transfer is using 32-bit elements in element sync mode
> starting at address with lsb 16 bits as 0, it would mean we'd see
> 0x0004 in this register after the _second_ element has been
> transferred, and we'd assume that the register hasn't yet changed -
> but we would have in reality transferred two elements.
> 
> However, omap-dma.c zeros the CPC register before each transfer,
> which is interesting, because in one place the OMAP1510 TRM says
> that the CPC register is read/write, but in the actual description
> of this register, it says it's read-only.
> 
> What it also means is that, in such a case, after the 2nd element has
> been transferred, where the register contains 0x0004, the address
> we'd be looking for (to calculate the residual) should be 0x0008,
> not 0x0005, so we actually need to be adding the number of bytes
> according to element size.
> 
> Looking at omap-dma.c, someone has added support for the residue
> granularity:
> 
>         if (__dma_omap15xx(od->plat->dma_attr))
>                 od->ddev.residue_granularity =
>                                 DMA_RESIDUE_GRANULARITY_DESCRIPTOR;
>         else
>                 od->ddev.residue_granularity = DMA_RESIDUE_GRANULARITY_BURST;

I'll point out that this was introduced by:

commit c9bd0946da243a8eb86b44ff613e2c813f9b683b
Author: Janusz Krzysztofik <jmkrzyszt@gmail.com>
Date:   Tue Jun 5 18:59:57 2018 +0200

    dmaengine: ti: omap-dma: Fix OMAP1510 incorrect residue_granularity
...
    It was verified already before that omap_get_dma_src_pos() from
    arch/arm/plat-omap/dma.c didn't work correctly for OMAP1510 - see
    commit 1bdd7419910c ("ASoC: OMAP: fix OMAP1510 broken PCM pointer
    callback") for details.  Apparently the same applies to its successor,
    omap_dma_get_src_pos() from drivers/dma/ti/omap-dma.c.

So, this now presents us with bigger problems - if we fix it now for
omap_udc, should the above commit be reverted, and if we do revert
the above commit, will it regress OMAP1510 audio.

The intention of omap-dma was always to report an accurate residue.

-- 
RMK's Patch system: http://www.armlinux.org.uk/developer/patches/
FTTC broadband for 0.8mile line in suburbia: sync at 12.1Mbps down 622kbps up
According to speedtest.net: 11.9Mbps down 500kbps up
