Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by i7-8700 with POP3-SSL;
  17 Dec 2018 14:06:25 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga006.fm.intel.com (fmsmga006.fm.intel.com [10.253.24.20])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 26C5D5805FC;
	Sun, 16 Dec 2018 18:55:19 -0800 (PST)
Received: from orsmga102-1.jf.intel.com (HELO mga09.intel.com) ([10.7.208.27])
  by fmsmga006-1.fm.intel.com with ESMTP; 16 Dec 2018 18:55:18 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AOFVSgxdayZPyt/D39XRXhZLqlGMj4u6mDksu8pMi?=
 =?us-ascii?q?zoh2WeGdxc68ZRaN2/xhgRfzUJnB7Loc0qyK6/CmATRIyK3CmUhKSIZLWR4BhJ?=
 =?us-ascii?q?detC0bK+nBN3fGKuX3ZTcxBsVIWQwt1Xi6NU9IBJS2PAWK8TW94jEIBxrwKxd+?=
 =?us-ascii?q?KPjrFY7OlcS30P2594HObwlSizexfbB/IA+qoQnNq8IbnZZsJqEtxxXTv3BGYf?=
 =?us-ascii?q?5WxWRmJVKSmxbz+MK994N9/ipTpvws6ddOXb31cKokQ7NYCi8mM30u683wqRbD?=
 =?us-ascii?q?VwqP6WACXWgQjxFFHhLK7BD+Xpf2ryv6qu9w0zSUMMHqUbw5Xymp4rx1QxH0li?=
 =?us-ascii?q?gIKz858HnWisNuiqJbvAmhrAF7z4LNfY2ZKOZycqbbcNgHR2ROQ9xRWjRODYOy?=
 =?us-ascii?q?bYQBD+QPM+VFoYfju1QAogC+BRGuCe701j9In2X70bEm3+g9EwzL2hErEdIUsH?=
 =?us-ascii?q?TTqdX4LKAcXvquzKbSzTXDbulW2TDg44fKaB8hpOuDUq9qfsHMzkQuFxnKjlCK?=
 =?us-ascii?q?poP4JTyZzOENvHKA7+V6VeKvinQnqwZqrzi0wccjlojJhoUTyl/a+iR53Jw5Ks?=
 =?us-ascii?q?G/SE5+eNOpFoZbuS+dN4tzWMwiQmdotT4+yr0FvJ67eDIGyJM9xx7Qc/CHaJCI?=
 =?us-ascii?q?4hPlVOaQPTh4n2hpeLShiBau6USgyfPzVtOy0FlUqipJiN7MtmoC1xDL5ciHS+?=
 =?us-ascii?q?d9/ke82TmUzQzc9uZEIUUsmarcNp4h3rowlp0UsUTABCP5hEL2jKqQe045+eao?=
 =?us-ascii?q?8/zqbqv6qpKYLYN4lw/zPro0lsCiAuk0LhICUmmZ9OikyrHv4Un0TK9Jg/A2iK?=
 =?us-ascii?q?XVro3WKMYBqqO5HwNY1Jso5QylADe8ytsYmGEKLFJbdxKDiIjkI0/OIP/mAvel?=
 =?us-ascii?q?mViskylkx+rAPrL/BpXBNH/DkK3ufbpl6k5czhQ8zcxH6p5KFr0MJOj/VlL/ud?=
 =?us-ascii?q?DGFBM1Lg+5z/r9BNh81I4SQWePDbWYMKPWv1+I/OUvI+yUaY8RuTb9LeUl5vH3?=
 =?us-ascii?q?gX86h1AdZ6+p0oUTaHyhGfRnLUOZbmT2gtoaD2cKsRQxTPbwhF2BTzFTfXCyUL?=
 =?us-ascii?q?w45j0hD4KmF4jDSpi3gLOdxCe7AoFWZmdeB1CIEHfodJuLV+0DaSKPOcJhlj0E?=
 =?us-ascii?q?Vb68S44uzx2utQn6y6Z5IerQ4CEXqZXj1N1t7e3JiR4y7SB0D9ia02yVT2F7hG?=
 =?us-ascii?q?IIRyMs06B4u0B9ykqD3rJ+g/xXDtFT4/JJUgEnNZ/T1eB6CtbyWh7fcdeNUlqp?=
 =?us-ascii?q?XtKmATQpRNIr39AOe1p9G8mljh3b3SqqBKEam6aIBJwz9KLc2X/xKt15y3bH0q?=
 =?us-ascii?q?khklYnTtFONW2gmq5w6QzTC5TVnEWekqagbb4c0zLV9Gef0WqOu1lVXxRrUaXF?=
 =?us-ascii?q?WnAfZVHarc7j6UPAVLKuDbUnMg1cyc+NMKdKa9vpjUlYS/fnItjRf2Wxm2KoDx?=
 =?us-ascii?q?aS2ryMdJbqe3ka3CjFC0gLiQYT8WyCNQg/HCihpW3eASdqFVLuZUPs7OZ/pGm6?=
 =?us-ascii?q?Tk8y0wGFcUlh26Cp9R4SgPyWU+kT0a4cuCc9tzV0G06w0M/MBNqeuQVtZqVcbs?=
 =?us-ascii?q?k74Fdcy23ZsQtxPpijL6Bngl4TaAB3v0Lo1xVqBYRMi8kqrHU2zAVsLaKUyk9O?=
 =?us-ascii?q?dzSd3ZroIL3YNnHy/Ayza67RwlzRzcyZ+rkR5/giq1XspgepFlE8/HVhyNRV13?=
 =?us-ascii?q?qc5pPXDAsdS57xU0A39wRkqLHeeCUy+4TU1Xh0O6murjDCw84pBPciyhu4Y9df?=
 =?us-ascii?q?MaaEFAjuE80aB8miMvAql0KubhIeOOBS9ag0P8y9evuC2a6rOvtgnT28gWRG5o?=
 =?us-ascii?q?B9zlyD9y5mRuHU2JYFxumS3hGbWDfkkFehrsf3lJheajEWAGW+xjbrBY5LaqJp?=
 =?us-ascii?q?YIYEFH2hI8u0xtV5mZ7gQHpY9F+lB1Mb186lYxuSb1rh3QJO0UQbu2ComSy9zz?=
 =?us-ascii?q?ZsiTEmsrKf3DDSw+TlbBcGOnNLSHN+glv2IIm0j8oVXE6nbwUykBul5ED6x7VU?=
 =?us-ascii?q?pahlLmnTR1tIcDbyL214TqSwsb+CadZV6Jw0qSVXTPi8YVeCR77nohsVzznsH3?=
 =?us-ascii?q?FDyzA8bT2qvIv2nwZ7iG6EMHl8tn7ZdtxuyhfF49zcQ+Vc3j4HRCl+lDnWCUKw?=
 =?us-ascii?q?P9iv/dWIiZjDtvqyWH6mVp1WaSPr15+PtDOn5W12Bh2yh/Cymtz9HQk6yyP7zM?=
 =?us-ascii?q?RqVSPToRb4Y4nr0bm6MO19cklpAl/899R1GoVknoQsg5EQ3GAQho+J8nofjWfz?=
 =?us-ascii?q?LdJb1Lr8bHUXXz4LwN3V4A//1E14NH2JxIH5VnSbwsR/Ydm3eWcW2iM778BXB6?=
 =?us-ascii?q?aY9r1EnS1polWmqQLde+RynjAYyfE28n4Vn/kJuBYxziWaGr0THVNXPSv2mxSK?=
 =?us-ascii?q?7tC+qr5aZGKucbi2yUp/ksqtDLCEogFARnn5fo0uEjN37sV6KFjMymH86pn4eN?=
 =?us-ascii?q?nMatIerh6UnA3Bj+RPKJIxi+AFhSxoOW/muX0lyug7jQFh3J2gvYiHLXlt87y9?=
 =?us-ascii?q?AhJCKjL1YMYT8Cn3jalChsaWw5yvHpJ5FzUOXZvoTuinHCgctPv5LAaODCMzqm?=
 =?us-ascii?q?2AFrXBBw+f51xrr3bOE5CtKnGWK2MVzdRkRBmBOkNfhBoYUyk9np48Dgqq3tDu?=
 =?us-ascii?q?cF9l5jAN4V71sgdMyuVtNxXlU2bQvgGoaiovSJiELRpb9QVC50bTMcyD4eN/BS?=
 =?us-ascii?q?BY/pu9rAOTLmyXfRhHDWYMWkacHVDsIqGu5cXc8+ifHuexNOHBYbKKqexDTfuI?=
 =?us-ascii?q?wY+v35Bi/zaNMMWPI3ZjA+c62kpFQXB2BcDZly8TRCwQkiLHd9Sbqwuk+i1rss?=
 =?us-ascii?q?C/9+zmWAD16ouKFbRSKs9j+wysjaeAKu6Qhzt5KTBC2ZMX3nLIzLkf3FgPiyBh?=
 =?us-ascii?q?bTWtELIAtTLTQ6LUgKNYExkbayZrPstS8608xhVNOdLcit7t1r94ieM1C05YVV?=
 =?us-ascii?q?P7nMGlf9cKI2a7NFPIH0uLMLWGJTvWw8D4e6+8SLtQjPlKuB20ozqUD0jjPjGb?=
 =?us-ascii?q?nTnzSx+vKf1MjD2cPBFGuIGybBdtCWvgTNLncBG7M8V3jTo5wbIqnHPKKHUcPC?=
 =?us-ascii?q?N4c0NMqL2Q8CxZju9+G2xH8npqM+2ElzyF4OnfL5YcqeFrDThsl+JG/HQ6zKNY?=
 =?us-ascii?q?4ztZRPNugivdsN5vr0uikumO0TdnVBtOqjBWhIOEp0liOKPZ9oVeVnbA5h4C8W?=
 =?us-ascii?q?KQCxESrdt/FtLvo7xQysTIlK/rNDdC8tfU8dEACMTONM2HMGQuMRzyFT7QDQsF?=
 =?us-ascii?q?SyOrNG7Fi0xclvGS6mOarpwgppfwn5oOT6dRVEYpGfMCFkRlANsCLY93Xzw+l7?=
 =?us-ascii?q?6bic8I5XymoxjQRMVVpJbHVv2JDPXrKTaZi6REZhQSzbP5K4QTKpP020h4ZlZm?=
 =?us-ascii?q?m4TKHhmYYdcYhCRtZxF8iUBM7DAqSGQ22l7NdAay6WUeU/Wzm0hlpBF5ZLEI/S?=
 =?us-ascii?q?zl41YtIRL7rS45nEB5zcTshDmdeXj0Jby5XYBMDALvsEMwNZX2UxozZgq3yx83?=
 =?us-ascii?q?fAzYTq5c2uMzPVtgjxXR7N4WQaZR?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AYAABQDxdch0O0hNFjHgEGBwaBUQkLA?=
 =?us-ascii?q?YJpgQIng3yUDoINFIkBjkOBcywLCAGEQIMHIjQJDQEDAQEBAQEBAgETAQEBCgs?=
 =?us-ascii?q?JCCkjDII2JAGCYQEBAQECAQECIB0BATcBBAEJAQEKCwMKAgImAgIDHgEGDAEFA?=
 =?us-ascii?q?RwGEwUWgwcBgWgDDQcBBQqaXTyKIHCBL4J2AQEFgTABg0UNghQDBYELiheBHII?=
 =?us-ascii?q?WgRGCFH6CVy4ZAQEBgWCDCIJXiVIYgU6FFFKEbIpiLwcChw2GLXCDMBhffoUci?=
 =?us-ascii?q?lmOMoESihEwgSVFgUkzGiOBAQaCAQEzH4F8g22EWTuFTjEyAYEEAQGNbwEB?=
X-IPAS-Result: =?us-ascii?q?A0AYAABQDxdch0O0hNFjHgEGBwaBUQkLAYJpgQIng3yUDoI?=
 =?us-ascii?q?NFIkBjkOBcywLCAGEQIMHIjQJDQEDAQEBAQEBAgETAQEBCgsJCCkjDII2JAGCY?=
 =?us-ascii?q?QEBAQECAQECIB0BATcBBAEJAQEKCwMKAgImAgIDHgEGDAEFARwGEwUWgwcBgWg?=
 =?us-ascii?q?DDQcBBQqaXTyKIHCBL4J2AQEFgTABg0UNghQDBYELiheBHIIWgRGCFH6CVy4ZA?=
 =?us-ascii?q?QEBgWCDCIJXiVIYgU6FFFKEbIpiLwcChw2GLXCDMBhffoUcilmOMoESihEwgSV?=
 =?us-ascii?q?FgUkzGiOBAQaCAQEzH4F8g22EWTuFTjEyAYEEAQGNbwEB?=
X-IronPort-AV: E=Sophos;i="5.56,363,1539673200"; 
   d="scan'208";a="57723588"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 16 Dec 2018 18:55:16 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1731302AbeLQCzO (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Sun, 16 Dec 2018 21:55:14 -0500
Received: from conssluserg-06.nifty.com ([210.131.2.91]:33958 "EHLO
        conssluserg-06.nifty.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1726371AbeLQCzO (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sun, 16 Dec 2018 21:55:14 -0500
Received: from mail-vs1-f50.google.com (mail-vs1-f50.google.com [209.85.217.50]) (authenticated)
        by conssluserg-06.nifty.com with ESMTP id wBH2snIu005059;
        Mon, 17 Dec 2018 11:54:50 +0900
DKIM-Filter: OpenDKIM Filter v2.10.3 conssluserg-06.nifty.com wBH2snIu005059
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=nifty.com;
        s=dec2015msa; t=1545015290;
        bh=+JKSoqXY85tbeID02A1AeqtBbFAekyYod20Z97xBY9U=;
        h=References:In-Reply-To:From:Date:Subject:To:Cc:From;
        b=LSxLpHG+Ol8A5gRpXHG6ro6Ra2Vpo5vYhv27hgQYEQ+iZ3KNMkAAkRd9INiFlTZVN
         RMBFD4S0YxLlLHcs5SyGbkkAR19sZ95PHvThXTPhx49CG1iHGnHVQLxHypOAbnDqPw
         5kxF4B1LfxyQgyZH353j3cCeqCaz7zdBD3OWuK5mNH+hMotL3qdI664O1D1qyjuQ30
         PXjkDPyr6MBOgntOftCc6+rhloCYLEPXLWJoV1wMKrlpShQlr5X6CqCHsG/JcCO6u7
         gLW4olQ9GXiXAi+94uMLxqeu+W2NUVJ3K6tA+uTB8wkn6bHL6BSVWhlHRL0MMohiC3
         tIpFFnBvrAnEg==
X-Nifty-SrcIP: [209.85.217.50]
Received: by mail-vs1-f50.google.com with SMTP id p74so6835741vsc.0;
        Sun, 16 Dec 2018 18:54:50 -0800 (PST)
X-Gm-Message-State: AA+aEWahBr7Y0f835ItkvkUstbJbcqzGXotNKJPuWXjUTilfRhCPuIfv
        MyMjAGtY8FX6xNGWhBo20f7GsyAqIdyLFAcFD24=
X-Google-Smtp-Source: AFSGD/VPXNyHJAyNhPdf4EDDBav+5Ol0Sg8QqPNrViJS5HiAwy52e+0jvHiwe7TxgTqWj7G8VooaXhs5xlSaoyRz8oI=
X-Received: by 2002:a67:485:: with SMTP id 127mr5672003vse.54.1545015289055;
 Sun, 16 Dec 2018 18:54:49 -0800 (PST)
MIME-Version: 1.0
References: <1544928632-9717-1-git-send-email-yamada.masahiro@socionext.com> <9691ECB6-D659-4E88-B8AF-4947B9431AF1@vmware.com>
In-Reply-To: <9691ECB6-D659-4E88-B8AF-4947B9431AF1@vmware.com>
From: Masahiro Yamada <yamada.masahiro@socionext.com>
Date: Mon, 17 Dec 2018 11:54:13 +0900
X-Gmail-Original-Message-ID: <CAK7LNARcSYvc-3xhdwFMk=q20LYW2i1ahscofYsYka2hg0Oszw@mail.gmail.com>
Message-ID: <CAK7LNARcSYvc-3xhdwFMk=q20LYW2i1ahscofYsYka2hg0Oszw@mail.gmail.com>
Subject: Re: [PATCH v2] x86, kbuild: revert macrofying inline assembly code
To: Nadav Amit <namit@vmware.com>
Cc: X86 ML <x86@kernel.org>, Thomas Gleixner <tglx@linutronix.de>,
        Ingo Molnar <mingo@redhat.com>, Borislav Petkov <bp@alien8.de>,
        "H . Peter Anvin" <hpa@zytor.com>,
        Richard Biener <rguenther@suse.de>,
        Segher Boessenkool <segher@kernel.crashing.org>,
        linux-arch <linux-arch@vger.kernel.org>,
        Arnd Bergmann <arnd@arndb.de>,
        Luc Van Oostenryck <luc.vanoostenryck@gmail.com>,
        Linux Kernel Mailing List <linux-kernel@vger.kernel.org>,
        "virtualization@lists.linux-foundation.org" 
        <virtualization@lists.linux-foundation.org>,
        Michal Marek <michal.lkml@markovi.net>,
        "linux-sparse@vger.kernel.org" <linux-sparse@vger.kernel.org>,
        Alok Kataria <akataria@vmware.com>,
        Juergen Gross <jgross@suse.com>,
        "linux-kbuild@vger.kernel.org" <linux-kbuild@vger.kernel.org>
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Sun, Dec 16, 2018 at 12:29 PM Nadav Amit <namit@vmware.com> wrote:
>
> > On Dec 15, 2018, at 6:50 PM, Masahiro Yamada <yamada.masahiro@socionext=
.com> wrote:
> >
> > Revert the following 9 commits:
> >
> > [1] 5bdcd510c2ac ("x86/jump-labels: Macrofy inline assembly code to
> >    work around GCC inlining bugs")
> >
> >    This was partially reverted because it made good cleanups
> >    irrespective of the inlining issue; the error message is still
> >    unneeded, and the conversion to STATIC_BRANCH_{NOP,JUMP} should
> >    be kept.
> >
> > [2] d5a581d84ae6 ("x86/cpufeature: Macrofy inline assembly code to
> >    work around GCC inlining bugs")
> >
> > [3] 0474d5d9d2f7 ("x86/extable: Macrofy inline assembly code to work
> >    around GCC inlining bugs")
> >
> > [4] 494b5168f2de ("x86/paravirt: Work around GCC inlining bugs when
> >    compiling paravirt ops")
> >
> > [5] f81f8ad56fd1 ("x86/bug: Macrofy the BUG table section handling,
> >    to work around GCC inlining bugs")
> >
> > [6] 77f48ec28e4c ("x86/alternatives: Macrofy lock prefixes to work
> >   around GCC inlining bugs")
> >
> > [7] 9e1725b41059 ("x86/refcount: Work around GCC inlining bug")
> >
> >    Resolved conflicts in arch/x86/include/asm/refcount.h caused by
> >    288e4521f0f6 ("x86/asm: 'Simplify' GEN_*_RMWcc() macros").
> >
> > [8] c06c4d809051 ("x86/objtool: Use asm macros to work around GCC
> >    inlining bugs")
> >
> > [9] 77b0bf55bc67 ("kbuild/Makefile: Prepare for using macros in inline
> >    assembly code to work around asm() related GCC inlining bugs")
> >
> > A few days after those commits applied, discussion started to solve
> > the issue more elegantly with the help of compiler:
> >
> >  https://na01.safelinks.protection.outlook.com/?url=3Dhttps%3A%2F%2Flkm=
l.org%2Flkml%2F2018%2F10%2F7%2F92&amp;data=3D02%7C01%7Cnamit%40vmware.com%7=
Ce893ce88065e4c59236308d663019424%7Cb39138ca3cee4b4aa4d6cd83d9dd62f0%7C0%7C=
0%7C636805255787607178&amp;sdata=3DmiiUndmPfGNKvrzD5mttC1%2Bn6rNaoIFebjZOAk=
Br24Y%3D&amp;reserved=3D0
> >
> > The new syntax "asm inline" was implemented by Segher Boessenkool, and
> > now queued up for GCC 9. (People were positive even for back-porting it
> > to older compilers).
> >
> > Since the in-kernel workarounds merged, some issues have been reported:
> > breakage of building with distcc/icecc, breakage of distro packages for
> > module building. (More fundamentally, we cannot build external modules
> > after 'make clean'.)
> >
> > I do not want to mess up the build system any more.
> >
> > Given that this issue will be solved in a cleaner way sooner or later,
> > let's revert the in-kernel workarounds, and wait for GCC 9.
> >
> > Reported-by: Logan Gunthorpe <logang@deltatee.com> # distcc
> > Reported-by: Sedat Dilek <sedat.dilek@gmail.com> # deb/rpm package
>
> It is customary to cc those who report an issue.

OK.

> The distcc issue has already been resolved both in distcc

Precisely, the fix-up was submitted,
but not pulled yet as of writing.
https://github.com/distcc/distcc/pull/313


> and in the patches
> I=E2=80=99ve sent: https://lkml.org/lkml/2018/11/15/467 .

I was scared by this ugly fix-up, so I rejected it.



> So I cannot understand why
> it is mentioned as a motivation.
>
> It sounds that the external modules can easily be resolved. Can you pleas=
e
> provide a link for the bug report?


https://www.spinics.net/lists/linux-kbuild/msg20037.html

We can fix it under circumstances "we can do anything"
although I am scared by endless Makefile hacks.



> Please regard my comments regarding v1.

I will try my best, although I felt some of your requests were too much.
I am not an x86 developer.


I posted this so people can play with 'asm inline'
https://lore.kernel.org/patchwork/patch/1024590/

You can confirm vmlinux size is increased,
and some symbols disappears.



> I must admit that I=E2=80=99m very surprised
> that you don=E2=80=99t like the patches since you ack=E2=80=99d the origi=
nal patch-set


I think ack and "I like it" are different.

There are situations where we had to accept something reluctantly.


Without my ack, your patch series would not have been
merged via x86 tree.

There was no other solution at that time.
Also, I could not predict potential problems, which turned out later.

So I let it go.

It would have been better if
the following discussion had stared earlier.
https://lkml.org/lkml/2018/10/7/92


Now, we got a much cleaner solution.

I believe we should replace the workarounds with it.



> (and
> actually assisted me in changing the Makefile).

You were clearly breaking the build system.
So, I provided a less ugly solution.

Again, the in-kernel hack was the only solution at that time,
but the situation has changed then.



--=20
Best Regards
Masahiro Yamada
