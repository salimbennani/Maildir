Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 24 Nov 2018 12:35:53 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga006.jf.intel.com (orsmga006.jf.intel.com [10.7.209.51])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id BE48B58037D;
	Fri, 23 Nov 2018 08:27:17 -0800 (PST)
Received: from orsmga102-1.jf.intel.com (HELO mga09.intel.com) ([10.7.208.27])
  by orsmga006-1.jf.intel.com with ESMTP; 23 Nov 2018 08:27:17 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AxlFzTRRWArOmuy2NfbCrBI8Rcdpsv+yvbD5Q0YIu?=
 =?us-ascii?q?jvd0So/mwa64YxyEt8tkgFKBZ4jH8fUM07OQ7/iwHzRYqb+681k6OKRWUBEEjc?=
 =?us-ascii?q?hE1ycBO+WiTXPBEfjxciYhF95DXlI2t1uyMExSBdqsLwaK+i764jEdAAjwOhRo?=
 =?us-ascii?q?LerpBIHSk9631+ev8JHPfglEnjWwba9xIRmssQndqtQdjJd/JKo21hbHuGZDdf?=
 =?us-ascii?q?5MxWNvK1KTnhL86dm18ZV+7SleuO8v+tBZX6nicKs2UbJXDDI9M2Ao/8LrrgXM?=
 =?us-ascii?q?TRGO5nQHTGoblAdDDhXf4xH7WpfxtTb6tvZ41SKHM8D6Uaw4VDK/5KpwVhTmlD?=
 =?us-ascii?q?kIOCI48GHPi8x/kqRboA66pxdix4LYeZyZOOZicq/Ye94RWGhPUdtLVyFZAo2y?=
 =?us-ascii?q?cZYBD/YPM+hbronyu1QAohSlBQm0Bu7i0SNIhmbs0KEmz+gtDRzK0Qo9FNwOqn?=
 =?us-ascii?q?TUq9D1Ob8cXe6ozanIyzrDb/NO1Tzg9YbHaBYhruySUr1uacrdx1QkGgTYgFqK?=
 =?us-ascii?q?r4zqIi2a2foVs2SB8uRgVOSvi2EnqwxquDevw9ojhpPViYISz1DJ7CN0y5s2K9?=
 =?us-ascii?q?2gUEN3f8KoHZ9Kuy2HOYZ6XNkuT3xrtSom0LELuJy2cDAXxJkmxxPTceKLf5SH?=
 =?us-ascii?q?7x75SeqcITZ1iGh7dL+/mhq+6UagxfP/W8Wo1VtHqzdKn93WuX8R0hHe7sqKRu?=
 =?us-ascii?q?dm8UqkwjmP2Rrc5+5BLEwpkafWKIIuz7gtnZQJq0vDBDX5mEDuga+WaEok/u+o?=
 =?us-ascii?q?5vz5YrXpuJCcLZV4igLgPaQ0nMywH+A4PhIJX2iB9uSwzLzj/UvnT7VWlvA6jL?=
 =?us-ascii?q?XVvZTAKcgGqKO1HRVZ3psg5hqjFTur0dYVkWECLF1feRKHi4bpO0vJIPD9Ffq/?=
 =?us-ascii?q?h1WskDF2x/HJJ7HhAYvCLmLFkLj/ebZx8klcyQQ1zd9B/ZJZEa8BIP3tVU/rrt?=
 =?us-ascii?q?DYDQE2Mxayw+n5DNVxzIQeWXiAAqOBKqPdrUeI5v4zI+mLfIIVvDf9K/s76PL0?=
 =?us-ascii?q?gn45hEQQfa2o3ZsRdXC5Ee5qI0SfYXrwnNgBFX0GsRY5TOzvkFeCSyJcZ26uX6?=
 =?us-ascii?q?Ig4TE2EIKmAp3CRoCxmrOB2z23Hp1LZm9cDFCMHmzld4GFW/cKdSKTLdVtkj0C?=
 =?us-ascii?q?Vbi9VYAh0QuiuxP9y7piNuDU4DEXtYr/1Nhp4O3ejRMy9TtqAMiH0GGNSGd0nm?=
 =?us-ascii?q?UPRzIt2KB/oEp9ykqM0KRigvxYE8BT6O1NUgsgKZHcyOl6AcjoWg3dZteJVEqm?=
 =?us-ascii?q?QtK+DD4rVdIxw9gOY0VnF9W4lB/D3TGnA7sUl7yNGZw1/bjQ33n3J8Zh1XnG0L?=
 =?us-ascii?q?MtgEUhQstKLWemnLJw9xDPB47VlEWUj6Wqer4a3CLX8GeDzHCBvEdXUANrVaXF?=
 =?us-ascii?q?XHYfZlbZrNjj50PCSaOuBqojMgdb1cGCLa5KYMXzjVpaXPfjJMjeY2WplmitHx?=
 =?us-ascii?q?mI2K2DYJDqe2oH2iXdE1YLkwYU8XaCNgg+AyOhrnnaDDxvE1Lvfkzt/fN/qHO9?=
 =?us-ascii?q?Uk870QWKY1d92Lqy/x4fneacRO8L3rIYpCchrC15E0un0NLIFdWMvQphc79aYd?=
 =?us-ascii?q?Mm/lhH03nUtwh8PpymMqBjiUQScwVxv0PyyRp3Dp9MntQtrHMv1AByM76X0Etd?=
 =?us-ascii?q?dzOE2pD9IqHXKmj3/BCod67W2lHf3MyK+qsV7/Q4sVHjvACvFkot6Hhn19hV03?=
 =?us-ascii?q?2B5pTFFgYSUJTxUlop+Bh+vb3Vfi4954bM3312Laa0qiPC284uBOY90Bmge8lQ?=
 =?us-ascii?q?MayaGw7yCcEVHNWuJ/EwlFivbRIEO/5S+bUwP8OncfuGxaGqMPxhnDKgkWRI/o?=
 =?us-ascii?q?R93liQ+Cp7T+7Cx4wFzO2A3gubSzf8i0+ss8DqmYxeeT4eBGu+ySj+C45Xaa1/?=
 =?us-ascii?q?ZoILCWaoI82qydRynZ/tW3hE9FG9A1MKwtOmeR2Xb1blxw1fyVwXoWC7mSu/1z?=
 =?us-ascii?q?F0iTApobaF0yzU3uvicwALOmhVS2l4jFfgOJS7gMoeXEe1cQcpjhyl5UDhyqhf?=
 =?us-ascii?q?paR/KXTTQEhScyj3KWFiTrW/tr6Yb8FT75MotD1dUP6gblCCVr79vxwa3jvjHm?=
 =?us-ascii?q?tf3jw6dyumuo7knxx8k2+dKHdzrHzEecB/3xvf5drcReJP0ToCXiV3lT7XBl2k?=
 =?us-ascii?q?Ndmz4dqUj4vDsvy5V2+5VJ1cazPrzYCDtCu8/2FqGgewn/Owmt3mFwg1zyn72s?=
 =?us-ascii?q?JuVSXJqhb8f4bq2767MeJhYklnGlv859BmFYF5l4s6nIsQ1mQChpWJ4XoHln/+?=
 =?us-ascii?q?MNVB1qL5dnYNRz8Lw9jO7Qjh2U1jKG+Jxo3jWnWcxMthe8e1YmcM1i0h6MBKDb?=
 =?us-ascii?q?+e7KZYkittvlq4sQXRbOB+njgHyPsi8n4ag/wTtworwSWQGbQSHUhePSzxmBWE?=
 =?us-ascii?q?9dG+rKNLZGmxdbi8zlZxndekDLuauAFTRG75eos+HS939sh/NVPM0H7p5Y3+dt?=
 =?us-ascii?q?jfc8kTtgGKnBfalOdaNogxlvURiCpjOGL9u2AlyuEhgRxv25G6oJaIK2F38K2l?=
 =?us-ascii?q?BR5YMyX/Z9kP9TH1kaZegsGW0pizHpVmHzUHRprpQuiuEDIPrvTnLAeOHSY4qn?=
 =?us-ascii?q?eaH7rfAACe5F1nr3LJD5CkKXWXKGMFwtVlQRmXPFZfjxwMXDUmgp45ERiny9f7?=
 =?us-ascii?q?f0d+4jAR+0T0qh9Ryu9zMxn/U2HfpBqnazsuSZifKgZW4R9G50vPLcOe6edzFT?=
 =?us-ascii?q?lC/pK9tAyNNnCbZwNQAGELQEOEAk7sPqK06dnc6eSYBfe+L/jTYbWIs+NeTOyF?=
 =?us-ascii?q?xZau0otg4jaNOd+DPnhkD/0nxEVDWWp1FNjemzUKUyYXjT7Cb9aHpBeg/S16ts?=
 =?us-ascii?q?C+8PP2WAL2+IuAEb1SPc90+xCxh6eDOPWdhCJ4KTZey5MNymXEyLkZ3F4OlS5u?=
 =?us-ascii?q?cyOhHqgHtS7IVKjQgLNYDwYHayNvM8tF96I80RdMOc7YidP116R0jv0vC1dCWl?=
 =?us-ascii?q?zuhNupZdERI2ymMFPHBUCLNKmJJDHRwsH3Z7+8RqNUjOlOqxKwvjObGVf5Pjuf?=
 =?us-ascii?q?jznpSwyvMeZUgS6BIRxRo5u9fQhtCGT5SNLmawa2MNt2jT0w3L01iWnGNW8aMT?=
 =?us-ascii?q?hgbUxNqqec4j9fgvV6A2ZB9GZqLfGYmyaF6OnVMooWsfpuAihui+1W+mg1y7tL?=
 =?us-ascii?q?4yFCX/F1nCrSrthzo1CpiOWPyzxnUAZQpTZPno6EoUJiOaDB/JlaRXnE5A4N7X?=
 =?us-ascii?q?mXCxkSp9pqENvvu6VRytjJjK3yKTdC/MjS/csTHMXULMOHMHw8MRvmAjLUDQ0F?=
 =?us-ascii?q?TSK1OmHbnUBSjPaS9njG5qQ9/9LvkZtISrJdWxo7G/UVIk9sGtsEIZx+WnUvlr?=
 =?us-ascii?q?vRxJoL7Hv4rBTXS4NUs5bIfvmbB/LpKT2Qif9PYB5ehfuyKI0PNozywApke1xz?=
 =?us-ascii?q?mqzLHVbdWZZGpSgrJlsxqVlN8XFlCGsi3kvjQgKr/HIXU/Wzm0hywkFxe+ki9z?=
 =?us-ascii?q?fE51YxO0rEozY2nEAtmNLjxzeLf3S5eKiqUI5VCwLwtk4sIp38XgB5ZBGzmkoi?=
 =?us-ascii?q?My3LEfYZxb9hc317zRLHs7NRFvNGC65JehkdwbeQffpimQBYqyO61Qpa/uHtF5?=
 =?us-ascii?q?Rvjk0pfISqonYG3BhsOpp9b6jRIrdZi1tdnKSDuge22e0rhgwTPUAA9CWVYiFC?=
 =?us-ascii?q?8BgMN787N2+r8/Zq5AiqhTROYi4PWuAsr/Ys8Vkybbeu1SXlhvR4K0a+N6jXFK?=
 =?us-ascii?q?qft2XNjYTAFmg50E8FmlEDxrlw3scLek+YEUsoye3CRFwyKcPeJFQNPIJp/3/J?=
 =?us-ascii?q?cHPL6L2VzA=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AXAAAQKvhbh0O0hNFjHgEGBwaBUQkLA?=
 =?us-ascii?q?YEwUIFcBAsnCoc2A5AESoIhlycUgRADTBMBGBMBiFoiNAkNAQMBAQEBAQECARM?=
 =?us-ascii?q?BAQEIDQkIKSMMgjYkAYJpAiQZAQEdGgEFCQIBAR0xAy8nBAENBQWDHIFqAxUBA?=
 =?us-ascii?q?gKcFgKKB4FsM4J2AQEFgQQBAYNxGIIGCIwJgVg+gRGHeAGFcolWhgeQJwMEAgK?=
 =?us-ascii?q?RLxaRCJgJAgQCBAUCDQEBBYFGgg1wgzyCGwwXg0qKHAE1QTGBBQEBIYkzKYEFA?=
 =?us-ascii?q?YEeAQE?=
X-IPAS-Result: =?us-ascii?q?A0AXAAAQKvhbh0O0hNFjHgEGBwaBUQkLAYEwUIFcBAsnCoc?=
 =?us-ascii?q?2A5AESoIhlycUgRADTBMBGBMBiFoiNAkNAQMBAQEBAQECARMBAQEIDQkIKSMMg?=
 =?us-ascii?q?jYkAYJpAiQZAQEdGgEFCQIBAR0xAy8nBAENBQWDHIFqAxUBAgKcFgKKB4FsM4J?=
 =?us-ascii?q?2AQEFgQQBAYNxGIIGCIwJgVg+gRGHeAGFcolWhgeQJwMEAgKRLxaRCJgJAgQCB?=
 =?us-ascii?q?AUCDQEBBYFGgg1wgzyCGwwXg0qKHAE1QTGBBQEBIYkzKYEFAYEeAQE?=
X-IronPort-AV: E=Sophos;i="5.56,270,1539673200"; 
   d="scan'208";a="54552612"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 23 Nov 2018 08:27:09 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2395242AbeKXDI7 (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Fri, 23 Nov 2018 22:08:59 -0500
Received: from mail-eopbgr710047.outbound.protection.outlook.com ([40.107.71.47]:24832
        "EHLO NAM05-BY2-obe.outbound.protection.outlook.com"
        rhost-flags-OK-OK-OK-FAIL) by vger.kernel.org with ESMTP
        id S2387726AbeKXDI7 (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 23 Nov 2018 22:08:59 -0500
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
 d=amdcloud.onmicrosoft.com; s=selector1-amd-com;
 h=From:Date:Subject:Message-ID:Content-Type:MIME-Version:X-MS-Exchange-SenderADCheck;
 bh=zFy5n2KubtmuDRKM8Wm3Ep4rDOXgAa5duvB/uLpHvUQ=;
 b=C8xInlZQFrcI04sGXNVs29ng9BUIARzff8c+ccLwAig0IX+x3sxgsFuzUpwtmHitxUAy9l4Ko4/2Z7vevG62UKsAgFlFnA0I6sOwly6oTsgYn7UhrNa2FfrnWunnx+YyBs78j0zhDlTlmgQuNmTG0QzvtM8JdfzuCVbBmqNu0+I=
Received: from BN6PR12MB1649.namprd12.prod.outlook.com (10.172.19.12) by
 BN6PR12MB1441.namprd12.prod.outlook.com (10.172.24.18) with Microsoft SMTP
 Server (version=TLS1_2, cipher=TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384) id
 15.20.1361.16; Fri, 23 Nov 2018 16:24:02 +0000
Received: from BN6PR12MB1649.namprd12.prod.outlook.com
 ([fe80::d9ac:970b:bfa4:198c]) by BN6PR12MB1649.namprd12.prod.outlook.com
 ([fe80::d9ac:970b:bfa4:198c%8]) with mapi id 15.20.1361.018; Fri, 23 Nov 2018
 16:24:02 +0000
From: "Singh, Sandeep" <Sandeep.Singh@amd.com>
To: "kai.heng.feng@canonical.com" <kai.heng.feng@canonical.com>,
        "mathias.nyman@intel.com" <mathias.nyman@intel.com>,
        "gregkh@linuxfoundation.org" <gregkh@linuxfoundation.org>,
        "linux-usb@vger.kernel.org" <linux-usb@vger.kernel.org>,
        "linux-kernel@vger.kernel.org" <linux-kernel@vger.kernel.org>
CC: "Singh, Sandeep" <Sandeep.Singh@amd.com>,
        "S-k, Shyam-sundar" <Shyam-sundar.S-k@amd.com>,
        "Singh, Sandeep" <Sandeep.Singh@amd.com>,
        "Shah, Nehal-bakulchandra" <Nehal-bakulchandra.Shah@amd.com>
Subject: [PATCH v3] xhci: workaround CSS timeout on AMD SNPS 3.0 xHC
Thread-Topic: [PATCH v3] xhci: workaround CSS timeout on AMD SNPS 3.0 xHC
Thread-Index: AQHUg0jxA72p3dlY80KgoZFXRNjAJg==
Date: Fri, 23 Nov 2018 16:24:01 +0000
Message-ID: <1542990218-30495-1-git-send-email-Sandeep.Singh@amd.com>
Accept-Language: en-US
Content-Language: en-US
X-MS-Has-Attach: 
X-MS-TNEF-Correlator: 
x-clientproxiedby: BMXPR01CA0046.INDPRD01.PROD.OUTLOOK.COM
 (2603:1096:b00:c::32) To BN6PR12MB1649.namprd12.prod.outlook.com
 (2603:10b6:405:6::12)
authentication-results: spf=none (sender IP is )
 smtp.mailfrom=Sandeep.Singh@amd.com; 
x-ms-exchange-messagesentrepresentingtype: 1
x-originating-ip: [165.204.156.251]
x-ms-publictraffictype: Email
x-microsoft-exchange-diagnostics: 1;BN6PR12MB1441;20:2OJFIHSi7r03Yvjlr/8ZjtVwJ/czpCLByGWIq65RnM4CPvFRZU0DmC09gRDDQOxm0gjCO/XCvk6JnDIzrjw1unXBjsrrwozsiRfrlP8bzUS8b1OSrUCt0M0PRBXHpU2sVk3QP/UflNNHH45/2pSlxmGqZVDOWncVaL0K7W69dCleP05MSIEmITEUFUKTMfOxLs4ci/RpIY3v0v3iGbA0fjoOU1PvjiIXMKF1mx1tp6/tkeFu8lLw5A9uxACU9XU6
x-ms-office365-filtering-correlation-id: 9a98f075-3106-4c8e-7812-08d651601413
x-ms-office365-filtering-ht: Tenant
x-microsoft-antispam: BCL:0;PCL:0;RULEID:(2390098)(7020095)(4652040)(8989299)(4534185)(4627221)(201703031133081)(201702281549075)(8990200)(5600074)(711020)(4618075)(2017052603328)(7153060)(7193020);SRVR:BN6PR12MB1441;
x-ms-traffictypediagnostic: BN6PR12MB1441:
x-microsoft-antispam-prvs: <BN6PR12MB144172DDE64D2F26C1229AF0E0D40@BN6PR12MB1441.namprd12.prod.outlook.com>
x-ms-exchange-senderadcheck: 1
x-exchange-antispam-report-cfa-test: BCL:0;PCL:0;RULEID:(8211001083)(6040522)(2401047)(5005006)(8121501046)(3231442)(944501410)(52105112)(3002001)(10201501046)(93006095)(93001095)(6055026)(148016)(149066)(150057)(6041310)(20161123558120)(201703131423095)(201702281528075)(20161123555045)(201703061421075)(201703061406153)(20161123560045)(20161123564045)(20161123562045)(201708071742011)(7699051)(76991095);SRVR:BN6PR12MB1441;BCL:0;PCL:0;RULEID:;SRVR:BN6PR12MB1441;
x-forefront-prvs: 086597191B
x-forefront-antispam-report: SFV:NSPM;SFS:(10009020)(979002)(39860400002)(136003)(346002)(396003)(376002)(366004)(189003)(199004)(25786009)(478600001)(66066001)(72206003)(6116002)(99286004)(3846002)(2906002)(2501003)(97736004)(105586002)(106356001)(4326008)(8936002)(14454004)(53936002)(6512007)(8676002)(81156014)(81166006)(2616005)(102836004)(217873002)(6506007)(386003)(7736002)(86362001)(71190400001)(71200400001)(6486002)(186003)(2201001)(2900100001)(26005)(305945005)(6436002)(68736007)(5660300001)(256004)(36756003)(52116002)(476003)(486006)(110136005)(14444005)(54906003)(316002)(969003)(989001)(999001)(1009001)(1019001);DIR:OUT;SFP:1101;SCL:1;SRVR:BN6PR12MB1441;H:BN6PR12MB1649.namprd12.prod.outlook.com;FPR:;SPF:None;LANG:en;PTR:InfoNoRecords;MX:1;A:1;
x-microsoft-antispam-message-info: t9V308JlMIy/WC5+LoUnVEqd9ch+qVmFbVuX7Y/R/z8VdXd6+cs4zglJFOPYsSxdt440Yx2sSU3P2a3aGZaoGKGfwGPf/k915x2Kc5GtGnDJomQQXAbjTaHgJG7sZYjdtX8b8MlxBFexCicKyAG9bN3V1I8eCZZJFwRLy4Hz98COZ90hc1UmosDz2xpFk1IroKlrm4J+05xjloO3nNq8JTKBiPzytm90f78PrjIRQpfTuzjfV3ydtNfBJHZ6RPvBn0Q0Oz6deCnFj6Kbf0VA/TgUH/3jNW2ep9KCANrO7S/TuMQv1RL5CMyNhvmK1apd1Wx2lebsDdUpehyEIaNpEKRFZf2tfmMLEdDWd0S3gPI=
spamdiagnosticoutput: 1:99
spamdiagnosticmetadata: NSPM
Content-Type: text/plain; charset="iso-8859-1"
Content-Transfer-Encoding: quoted-printable
MIME-Version: 1.0
X-OriginatorOrg: amd.com
X-MS-Exchange-CrossTenant-Network-Message-Id: 9a98f075-3106-4c8e-7812-08d651601413
X-MS-Exchange-CrossTenant-originalarrivaltime: 23 Nov 2018 16:24:02.0503
 (UTC)
X-MS-Exchange-CrossTenant-fromentityheader: Hosted
X-MS-Exchange-CrossTenant-id: 3dd8961f-e488-4e60-8e11-a82d994e183d
X-MS-Exchange-Transport-CrossTenantHeadersStamped: BN6PR12MB1441
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

From: Sandeep Singh <sandeep.singh@amd.com>

Occasionally AMD SNPS 3.0 xHC does not respond to
CSS when set, also it does not flag anything on SRE and HCE
to point the internal xHC errors on USBSTS register. This stalls
the entire system wide suspend and there is no point in stalling
just because of xHC CSS is not responding.

To work around this problem, if the xHC does not flag
anything on SRE and HCE, we can skip the CSS
timeout and allow the system to continue the suspend. Once the
system resume happens we can internally reset the controller
using XHCI_RESET_ON_RESUME quirk

Signed-off-by: Shyam Sundar S K <Shyam-sundar.S-k@amd.com>
Signed-off-by: Sandeep Singh <Sandeep.Singh@amd.com>
cc: Nehal Shah <Nehal-bakulchandra.Shah@amd.com>
---
Changes since v1:

-> New Variable based decision making when SNPS issue happens hence=20
-> quirk interdependency removed.
-> Removed STS conditional check in suspend function.

Changes since v2:
-> Updated quirk bit as per Kai-heng comment.

 drivers/usb/host/xhci-pci.c |  4 ++++
 drivers/usb/host/xhci.c     | 26 ++++++++++++++++++++++----
 drivers/usb/host/xhci.h     |  3 +++
 3 files changed, 29 insertions(+), 4 deletions(-)

diff --git a/drivers/usb/host/xhci-pci.c b/drivers/usb/host/xhci-pci.c
index a951526..a9ec705 100644
--- a/drivers/usb/host/xhci-pci.c
+++ b/drivers/usb/host/xhci-pci.c
@@ -139,6 +139,10 @@ static void xhci_pci_quirks(struct device *dev, struct=
 xhci_hcd *xhci)
 		 pdev->device =3D=3D 0x43bb))
 		xhci->quirks |=3D XHCI_SUSPEND_DELAY;
=20
+	if (pdev->vendor =3D=3D PCI_VENDOR_ID_AMD &&
+	    (pdev->device =3D=3D 0x15e0 || pdev->device =3D=3D 0x15e1))
+		xhci->quirks |=3D XHCI_SNPS_BROKEN_SUSPEND;
+
 	if (pdev->vendor =3D=3D PCI_VENDOR_ID_AMD)
 		xhci->quirks |=3D XHCI_TRUST_TX_LENGTH;
=20
diff --git a/drivers/usb/host/xhci.c b/drivers/usb/host/xhci.c
index c928dbb..c20b85e 100644
--- a/drivers/usb/host/xhci.c
+++ b/drivers/usb/host/xhci.c
@@ -968,6 +968,7 @@ int xhci_suspend(struct xhci_hcd *xhci, bool do_wakeup)
 	unsigned int		delay =3D XHCI_MAX_HALT_USEC;
 	struct usb_hcd		*hcd =3D xhci_to_hcd(xhci);
 	u32			command;
+	u32			res;
=20
 	if (!hcd->state)
 		return 0;
@@ -1021,11 +1022,28 @@ int xhci_suspend(struct xhci_hcd *xhci, bool do_wak=
eup)
 	command =3D readl(&xhci->op_regs->command);
 	command |=3D CMD_CSS;
 	writel(command, &xhci->op_regs->command);
+	xhci->broken_suspend =3D 0;
 	if (xhci_handshake(&xhci->op_regs->status,
 				STS_SAVE, 0, 10 * 1000)) {
-		xhci_warn(xhci, "WARN: xHC save state timeout\n");
-		spin_unlock_irq(&xhci->lock);
-		return -ETIMEDOUT;
+	/*
+	 * AMD SNPS xHC 3.0 occasionally does not clear the
+	 * SSS bit of USBSTS and when driver tries to poll
+	 * to see if the xHC clears BIT(8) which never happens
+	 * and driver assumes that controller is not responding
+	 * and times out. To workaround this, its good to check
+	 * if SRE and HCE bits are not set (as per xhci
+	 * Section 5.4.2) and bypass the timeout.
+	 */
+		res =3D readl(&xhci->op_regs->status);
+		if ((xhci->quirks & XHCI_SNPS_BROKEN_SUSPEND) &&
+		    (((res & STS_SRE) =3D=3D 0) &&
+				((res & STS_HCE) =3D=3D 0))) {
+			xhci->broken_suspend =3D 1;
+		} else {
+			xhci_warn(xhci, "WARN: xHC save state timeout\n");
+			spin_unlock_irq(&xhci->lock);
+			return -ETIMEDOUT;
+		}
 	}
 	spin_unlock_irq(&xhci->lock);
=20
@@ -1078,7 +1096,7 @@ int xhci_resume(struct xhci_hcd *xhci, bool hibernate=
d)
 	set_bit(HCD_FLAG_HW_ACCESSIBLE, &xhci->shared_hcd->flags);
=20
 	spin_lock_irq(&xhci->lock);
-	if (xhci->quirks & XHCI_RESET_ON_RESUME)
+	if ((xhci->quirks & XHCI_RESET_ON_RESUME) || xhci->broken_suspend)
 		hibernated =3D true;
=20
 	if (!hibernated) {
diff --git a/drivers/usb/host/xhci.h b/drivers/usb/host/xhci.h
index 260b259..c3515ba 100644
--- a/drivers/usb/host/xhci.h
+++ b/drivers/usb/host/xhci.h
@@ -1850,6 +1850,7 @@ struct xhci_hcd {
 #define XHCI_ZERO_64B_REGS	BIT_ULL(32)
 #define XHCI_DEFAULT_PM_RUNTIME_ALLOW	BIT_ULL(33)
 #define XHCI_RESET_PLL_ON_DISCONNECT	BIT_ULL(34)
+#define XHCI_SNPS_BROKEN_SUSPEND    BIT_ULL(35)
=20
 	unsigned int		num_active_eps;
 	unsigned int		limit_active_eps;
@@ -1879,6 +1880,8 @@ struct xhci_hcd {
 	void			*dbc;
 	/* platform-specific data -- must come last */
 	unsigned long		priv[0] __aligned(sizeof(s64));
+	/* Broken Suspend flag for SNPS Suspend resume issue */
+	u8			broken_suspend;
 };
=20
 /* Platform specific overrides to generic XHCI hc_driver ops */
--=20
2.7.4

