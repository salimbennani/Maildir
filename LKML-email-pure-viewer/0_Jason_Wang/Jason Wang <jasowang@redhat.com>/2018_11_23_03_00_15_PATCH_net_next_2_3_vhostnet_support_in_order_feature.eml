Return-Path: <virtualization-bounces@lists.linux-foundation.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 12:22:55 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga004.jf.intel.com (orsmga004.jf.intel.com [10.7.209.38])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id D4DD8580460
	for <like.xu@linux.intel.com>; Thu, 22 Nov 2018 19:01:51 -0800 (PST)
Received: from orsmga101.jf.intel.com ([10.7.208.22])
  by orsmga004-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 22 Nov 2018 19:01:51 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AeLasIRW5ZeIqg5bBKAri+UKoEZTV8LGtZVwlr6E/?=
 =?us-ascii?q?grcLSJyIuqrYZRWDuadThVPEFb/W9+hDw7KP9fy4CSpYud6oizMrSNR0TRgLiM?=
 =?us-ascii?q?EbzUQLIfWuLgnFFsPsdDEwB89YVVVorDmROElRH9viNRWJ+iXhpTEdFQ/iOgVr?=
 =?us-ascii?q?O+/7BpDdj9it1+C15pbffxhEiCCybL9uLxi6txndutULioZ+N6g9zQfErGFVcO?=
 =?us-ascii?q?pM32NoIlyTnxf45siu+ZNo7jpdtfE8+cNeSKv2Z6s3Q6BWAzQgKGA1+dbktQLf?=
 =?us-ascii?q?QguV53sTSXsZnxxVCAXY9h76X5Pxsizntuph3SSRIMP7QawoVTmk8qxmTgLjhi?=
 =?us-ascii?q?UaOD4j6GzZitJ+gr9VrhyipRN/zZbUbYOXOvdxY6/Qc88WSmVdUcheTCxOHJix?=
 =?us-ascii?q?b5cNAucbIepUs5Xxq0UIoBCjBQesHuTvyjpQi3Hyx6I6yOMhEQfb1wMgBd0Otn?=
 =?us-ascii?q?vUp8jyOacQS++1167IzDvZYPNQ1jfw85LIfQ48rvGMR71wbdDdxlUoFwPAl1id?=
 =?us-ascii?q?r5HuMT2S1uQIqWeb7uxgWPqri24mrQFxvzeuxskrionUgIIa10rL9Tl4wIYyI9?=
 =?us-ascii?q?20Ukl7YcSrEJZWqiqUNJN2T9s/T2xnpCo20KMKtYOmcCQQ1ZgqxhrSZ+aaf4SW?=
 =?us-ascii?q?+h7vSvqdLDNiiH54dr+zmQy+/VWjx+DyTMW4zlVHoyxYmdfWrH8NzQbc6s2fR/?=
 =?us-ascii?q?t94Eih3TGP2hjW6u5eIEA0kbDXK5ogwr42i5oSvkrDHijrmEXwkaCZbFkk+umv?=
 =?us-ascii?q?6+TheLnmoYWcN4BshgH/NKQhhNC/DPwlPgUBQ2SX4/qw2KD+8UHjXblHj/k7nr?=
 =?us-ascii?q?PEvJzEPcgbo7S2Aw5R0oYt8Ra/CDKm3cwGnXkGNlJFZA+HgJLtO1HPIfH3F+u/?=
 =?us-ascii?q?g1WrkDdt3vzJJbrhAojLLnffjrjhZq1w60pdyAoo0dBf/IhYCrUAIPL1R0/wu8?=
 =?us-ascii?q?XUDhE+MwypxeboFc9y1p8fWWKIBK+VKqTSsUWH5u43OemDeJcVuCrhK/gi//Pu?=
 =?us-ascii?q?iX45mVwDcqWz0poXdWu1HvBnI0WffHrtjc0NEWYMvgoiUuPqjEeOXiJUZ3a3DO?=
 =?us-ascii?q?oB4ComAtemEZvbXdLqx7iAxzugWJlXYH1WBFeRF3vha4SDXbELci3VJ8ZgljkN?=
 =?us-ascii?q?U/+mU5Mg0he18xH70aZ6J+7V6CQEtJXlh+Vz/PDZwBQ79DhoCJaD0nuRUmhwn3?=
 =?us-ascii?q?EBWz4x2uVlrFVgx0yf+ax5mOBDU9hS4e5ZFwk9KJjQxvB7DNa0XRjOKcyUQlSr?=
 =?us-ascii?q?ScnzHDcqU9gqyMUPaUsuJ9L3iwvf9zCnD78ci/qAA5lwuqDVxH/uLsBy42zL2K?=
 =?us-ascii?q?kokx8tRc4LfW64g4Zh+AXJQY3EiUOUk+Ctb6tYlDDM7nuexG6PrkhEUQl2eaHE?=
 =?us-ascii?q?RmwEIE/Xq8npo03FUrmiAKgmNQ0HztSNbuNMZ8HlgEtuWvjuIpLdbni3lmP2Ag?=
 =?us-ascii?q?yHgvuIbYz3ayAe0T/bBUwsjQ8e5zCFOBI4CyPnpHjRXxJ0Ele6QUr39u82l3q9?=
 =?us-ascii?q?QQdgzQiRaFJo0bWd4BMZhfWADfgU2+RX628atzxoEQPljJrtAN2aql85cQ=3D?=
 =?us-ascii?q?=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AQAABlbfdbhwyp04xiHAEBAQQBAQcEA?=
 =?us-ascii?q?QGBUQcBAQsBgmmBFxKMEV+OS5YdgXAXGAsJg3qEWCI0CQ0BAwEBAQEBAQIBEwE?=
 =?us-ascii?q?BAQoLCQgpIwyCNgUCAxgJglwBAgMBAQEkEwwKHg4DAQIGAQFABAQIAwEjAS8HE?=
 =?us-ascii?q?gWDHAGCAQUKqDszihQFjAkXgUA/hz4BBIc5Ao9cM48tRgmGfIMtgmuEEAsYiU8?=
 =?us-ascii?q?ChzcshBWJAoptgUaCDTMaCBsVO4JsgicXiF6FSzIBATGBI4pCgXcBAQ?=
X-IPAS-Result: =?us-ascii?q?A0AQAABlbfdbhwyp04xiHAEBAQQBAQcEAQGBUQcBAQsBgmm?=
 =?us-ascii?q?BFxKMEV+OS5YdgXAXGAsJg3qEWCI0CQ0BAwEBAQEBAQIBEwEBAQoLCQgpIwyCN?=
 =?us-ascii?q?gUCAxgJglwBAgMBAQEkEwwKHg4DAQIGAQFABAQIAwEjAS8HEgWDHAGCAQUKqDs?=
 =?us-ascii?q?zihQFjAkXgUA/hz4BBIc5Ao9cM48tRgmGfIMtgmuEEAsYiU8ChzcshBWJAoptg?=
 =?us-ascii?q?UaCDTMaCBsVO4JsgicXiF6FSzIBATGBI4pCgXcBAQ?=
X-IronPort-AV: E=Sophos;i="5.56,268,1539673200"; 
   d="scan'208";a="41941974"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from mail.linuxfoundation.org ([140.211.169.12])
  by mtab.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 22 Nov 2018 19:01:40 -0800
Received: from mail.linux-foundation.org (localhost [127.0.0.1])
	by mail.linuxfoundation.org (Postfix) with ESMTP id 21DA4117D;
	Fri, 23 Nov 2018 03:00:54 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@mail.linuxfoundation.org
Received: from smtp1.linuxfoundation.org (smtp1.linux-foundation.org
	[172.17.192.35])
	by mail.linuxfoundation.org (Postfix) with ESMTPS id 26D7E1166
	for <virtualization@lists.linux-foundation.org>;
	Fri, 23 Nov 2018 03:00:50 +0000 (UTC)
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
	by smtp1.linuxfoundation.org (Postfix) with ESMTPS id CBF38771
	for <virtualization@lists.linux-foundation.org>;
	Fri, 23 Nov 2018 03:00:49 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx04.intmail.prod.int.phx2.redhat.com
	[10.5.11.14])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by mx1.redhat.com (Postfix) with ESMTPS id 376413084218;
	Fri, 23 Nov 2018 03:00:49 +0000 (UTC)
Received: from jason-ThinkPad-T450s.redhat.com (ovpn-12-159.pek2.redhat.com
	[10.72.12.159])
	by smtp.corp.redhat.com (Postfix) with ESMTP id 678CA2A2E6;
	Fri, 23 Nov 2018 03:00:42 +0000 (UTC)
From: Jason Wang <jasowang@redhat.com>
To: mst@redhat.com, jasowang@redhat.com, kvm@vger.kernel.org,
	virtualization@lists.linux-foundation.org, netdev@vger.kernel.org,
	linux-kernel@vger.kernel.org
Subject: [PATCH net-next 2/3] vhost_net: support in order feature
Date: Fri, 23 Nov 2018 11:00:15 +0800
Message-Id: <20181123030016.4924-3-jasowang@redhat.com>
In-Reply-To: <20181123030016.4924-1-jasowang@redhat.com>
References: <20181123030016.4924-1-jasowang@redhat.com>
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.14
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
	(mx1.redhat.com [10.5.110.40]);
	Fri, 23 Nov 2018 03:00:49 +0000 (UTC)
X-Spam-Status: No, score=-6.9 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_HI
	autolearn=ham version=3.3.1
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on
	smtp1.linux-foundation.org
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.12
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>,
	<mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>,
	<mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
MIME-Version: 1.0
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Sender: virtualization-bounces@lists.linux-foundation.org
Errors-To: virtualization-bounces@lists.linux-foundation.org

This makes vhost_net to support in order feature. This is as simple as
use datacopy path when it was negotiated. An alternative is not to
advertise in order when zerocopy is enabled which tends to be
suboptimal consider zerocopy may suffer from e.g HOL issues.

Signed-off-by: Jason Wang <jasowang@redhat.com>
---
 drivers/vhost/net.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/drivers/vhost/net.c b/drivers/vhost/net.c
index d919284f103b..bdf5de5a7eb2 100644
--- a/drivers/vhost/net.c
+++ b/drivers/vhost/net.c
@@ -74,7 +74,8 @@ enum {
 	VHOST_NET_FEATURES = VHOST_FEATURES |
 			 (1ULL << VHOST_NET_F_VIRTIO_NET_HDR) |
 			 (1ULL << VIRTIO_NET_F_MRG_RXBUF) |
-			 (1ULL << VIRTIO_F_IOMMU_PLATFORM)
+			 (1ULL << VIRTIO_F_IOMMU_PLATFORM) |
+	                 (1ULL << VIRTIO_F_IN_ORDER)
 };
 
 enum {
@@ -971,7 +972,8 @@ static void handle_tx(struct vhost_net *net)
 	vhost_disable_notify(&net->dev, vq);
 	vhost_net_disable_vq(net, vq);
 
-	if (vhost_sock_zcopy(sock))
+	if (vhost_sock_zcopy(sock) &&
+	    !vhost_has_feature(vq, VIRTIO_F_IN_ORDER))
 		handle_tx_zerocopy(net, sock);
 	else
 		handle_tx_copy(net, sock);
-- 
2.17.1

_______________________________________________
Virtualization mailing list
Virtualization@lists.linux-foundation.org
https://lists.linuxfoundation.org/mailman/listinfo/virtualization
