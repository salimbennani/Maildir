Return-Path: <virtualization-bounces@lists.linux-foundation.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 12:22:54 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga004.fm.intel.com (fmsmga004.fm.intel.com [10.253.24.48])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 985FB580460
	for <like.xu@linux.intel.com>; Thu, 22 Nov 2018 19:01:17 -0800 (PST)
Received: from orsmga103.jf.intel.com ([10.7.208.35])
  by fmsmga004-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 22 Nov 2018 19:01:17 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AnPN4ahLiy/B1/NvkfNmcpTZWNBhigK39O0sv0rFi?=
 =?us-ascii?q?tYgXK/j/rarrMEGX3/hxlliBBdydt6oUzbKO+4nbGkU4qa6bt34DdJEeHzQksu?=
 =?us-ascii?q?4x2zIaPcieFEfgJ+TrZSFpVO5LVVti4m3peRMNQJW2aFLduGC94iAPERvjKwV1?=
 =?us-ascii?q?Ov71GonPhMiryuy+4ZLebxlLiTanfb9+MAi9oBnMuMURnYZsMLs6xAHTontPde?=
 =?us-ascii?q?RWxGdoKkyWkh3h+Mq+/4Nt/jpJtf45+MFOTav1f6IjTbxFFzsmKHw65NfqtRbY?=
 =?us-ascii?q?UwSC4GYXX3gMnRpJBwjF6wz6Xov0vyDnuOdxxDWWMMvrRr0yRD+s7bpkSAXwhS?=
 =?us-ascii?q?kHKTA37W/ZhM9yg6JVuBKspR5xzoHJbIybKPZxcb/Sc9wBRWVfRctRSy5MD5mg?=
 =?us-ascii?q?Y4cTE+YNI+BVpJT9qVsUqhu+ABGhCuf1xT9TgX/227Ax3OQ7HgHA0wwrAtUDsH?=
 =?us-ascii?q?bOo9XuM6cTX/q6zK/HzTjYdfNZxyry6IjSfRA9u/2DQbVwcc/IxEQpCgjLgFKQ?=
 =?us-ascii?q?qYn/MDOU0OQAq2yb7+tmVeKyhG8npQZxoiWpxsgxkIbJmoMVylfC9Sljx4Y1P9?=
 =?us-ascii?q?K4RUhmatCnCJtdrzyWOoRqTs84XW1kpTs2xqcbtZO6eCUG0okrywDHZ/CZb4SF?=
 =?us-ascii?q?5gjvWPufLDtmnn5pZbGyihio/US+yeDxUNS/3kxQoSpfiNbMs2gA1xzN5ciDTf?=
 =?us-ascii?q?tw5kKh1iyO1wDX8O1EJUE0lazGK58uzL4wkYcTsULeESDshEX2jaiWdkM+9uiv?=
 =?us-ascii?q?8eTnba3qpp6aN4BqlgHzKrkil8OjDegiLAQCQnWX9f6h2LDi+UD1WqhGguMunq?=
 =?us-ascii?q?ncqp/aJMAbpqCjAw9S14Yu8wi/Dza80NQEgHkINlZFeBOGjofzJ1HOIff4DfGm?=
 =?us-ascii?q?j1u3lzdr2vbGMaH/DZXWNXXDlLbhfa1h605H0gYzydFf55RJCrAOOf7zVEjxtM?=
 =?us-ascii?q?HeDhAkKQO03+fnCNJ71o8EXmKPGKCZPLvIsVCU/uIvP/WMZIgNtTb5Kvgl5ODh?=
 =?us-ascii?q?gWU2mF8AZqSp2ZoXaHalHvVpOUmZYHzsgssfHmcOpAYxUOvqiFjRGQNVfGu4Cq?=
 =?us-ascii?q?Ig+ikgWsXhCYbYWpvrhL2HwTe1GYBQamlaC1eKV3DyeMKBUvYIbSuUZch5jj0D?=
 =?us-ascii?q?U6PmVY47yQynsA7owqZmKeyHxysDqJi20dF04/HUxw8z7yBpBsCcwWiRTmZy23?=
 =?us-ascii?q?kFXiI7x7xXpU1m1kzF1al+nuwdG9tO4f9ATgY9M9jb1eMtEM34WA/KYoKUTk27?=
 =?us-ascii?q?SM6tGzA7Q4ENxIoLeFpVAdiujhnfmSGtBvtdlbWQA4M99K30xXX9J89hjX3B0e?=
 =?us-ascii?q?1pjEcjatVAOHfghaNl8QXXQYnTnAHRiaewabkV2C/f/XuCymymuEBDTBU2VaTD?=
 =?us-ascii?q?QGBaaEzLq9jw+kLFSfmpE7tjeg1M1cKPNINUZdDzy1ZLXvHuPJLZeW3102OxAw?=
 =?us-ascii?q?uYg7CBdoznf00D0yjHTksJiQYe+TCBLwdtKD2mpjf8BSdpExrQakXjub18oWi8?=
 =?us-ascii?q?UUYywCmQYkFh3qbz8RkQ06/PA8gP164J7X9y4w5/G0ywiorb?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0DQAQDwbPdbhwyp04xiHQEBBQEHBQGBZ?=
 =?us-ascii?q?YJqgRcSjHCOS5gOFhgLCYN6hFgiOBIBAwEBAQEBAQIBEwEBAQoLCQgpIwyCNgU?=
 =?us-ascii?q?CAxgJglwBAgMBAQEkEwwKHg4DAQIGAQFABAQIAwEjAS8HEgWDHAGCAQUKqDozi?=
 =?us-ascii?q?hQFjAkXgUA/hz4BBIc5AokZhkMzT45eRgmGfIMtgmuEEAsYgVmHdgI2hwEsjRe?=
 =?us-ascii?q?KbYFdgXYzGggbFTuCbIschUsyAQExgSOKQoF3AQE?=
X-IPAS-Result: =?us-ascii?q?A0DQAQDwbPdbhwyp04xiHQEBBQEHBQGBZYJqgRcSjHCOS5g?=
 =?us-ascii?q?OFhgLCYN6hFgiOBIBAwEBAQEBAQIBEwEBAQoLCQgpIwyCNgUCAxgJglwBAgMBA?=
 =?us-ascii?q?QEkEwwKHg4DAQIGAQFABAQIAwEjAS8HEgWDHAGCAQUKqDozihQFjAkXgUA/hz4?=
 =?us-ascii?q?BBIc5AokZhkMzT45eRgmGfIMtgmuEEAsYgVmHdgI2hwEsjReKbYFdgXYzGggbF?=
 =?us-ascii?q?TuCbIschUsyAQExgSOKQoF3AQE?=
X-IronPort-AV: E=Sophos;i="5.56,268,1539673200"; 
   d="scan'208";a="53413252"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from mail.linuxfoundation.org ([140.211.169.12])
  by mtab.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 22 Nov 2018 19:01:16 -0800
Received: from mail.linux-foundation.org (localhost [127.0.0.1])
	by mail.linuxfoundation.org (Postfix) with ESMTP id 82B631183;
	Fri, 23 Nov 2018 03:00:54 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@mail.linuxfoundation.org
Received: from smtp1.linuxfoundation.org (smtp1.linux-foundation.org
	[172.17.192.35])
	by mail.linuxfoundation.org (Postfix) with ESMTPS id 2F3921176
	for <virtualization@lists.linux-foundation.org>;
	Fri, 23 Nov 2018 03:00:53 +0000 (UTC)
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
	by smtp1.linuxfoundation.org (Postfix) with ESMTPS id C2398808
	for <virtualization@lists.linux-foundation.org>;
	Fri, 23 Nov 2018 03:00:52 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx04.intmail.prod.int.phx2.redhat.com
	[10.5.11.14])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by mx1.redhat.com (Postfix) with ESMTPS id 3F3F6C0524E1;
	Fri, 23 Nov 2018 03:00:52 +0000 (UTC)
Received: from jason-ThinkPad-T450s.redhat.com (ovpn-12-159.pek2.redhat.com
	[10.72.12.159])
	by smtp.corp.redhat.com (Postfix) with ESMTP id C14595DDFE;
	Fri, 23 Nov 2018 03:00:49 +0000 (UTC)
From: Jason Wang <jasowang@redhat.com>
To: mst@redhat.com, jasowang@redhat.com, kvm@vger.kernel.org,
	virtualization@lists.linux-foundation.org, netdev@vger.kernel.org,
	linux-kernel@vger.kernel.org
Subject: [PATCH net-next 3/3] vhost: don't touch avail ring if in_order is
	negotiated
Date: Fri, 23 Nov 2018 11:00:16 +0800
Message-Id: <20181123030016.4924-4-jasowang@redhat.com>
In-Reply-To: <20181123030016.4924-1-jasowang@redhat.com>
References: <20181123030016.4924-1-jasowang@redhat.com>
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.14
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
	(mx1.redhat.com [10.5.110.31]);
	Fri, 23 Nov 2018 03:00:52 +0000 (UTC)
X-Spam-Status: No, score=-6.9 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_HI
	autolearn=ham version=3.3.1
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on
	smtp1.linux-foundation.org
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.12
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>,
	<mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>,
	<mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
MIME-Version: 1.0
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Sender: virtualization-bounces@lists.linux-foundation.org
Errors-To: virtualization-bounces@lists.linux-foundation.org

Device use descriptors table in order, so there's no need to read
index from available ring. This eliminate the cache contention on
avail ring completely.

Virito-user + vhost_kernel + XDP_DROP gives about ~10% improvement on
TX from 4.8Mpps to 5.3Mpps on Intel(R) Core(TM) i7-5600U CPU @
2.60GHz.

Signed-off-by: Jason Wang <jasowang@redhat.com>
---
 drivers/vhost/vhost.c | 19 ++++++++++++-------
 1 file changed, 12 insertions(+), 7 deletions(-)

diff --git a/drivers/vhost/vhost.c b/drivers/vhost/vhost.c
index 3a5f81a66d34..c8be151bc897 100644
--- a/drivers/vhost/vhost.c
+++ b/drivers/vhost/vhost.c
@@ -2002,6 +2002,7 @@ int vhost_get_vq_desc(struct vhost_virtqueue *vq,
 	__virtio16 avail_idx;
 	__virtio16 ring_head;
 	int ret, access;
+	bool in_order = vhost_has_feature(vq, VIRTIO_F_IN_ORDER);
 
 	/* Check it isn't doing very strange things with descriptor numbers. */
 	last_avail_idx = vq->last_avail_idx;
@@ -2034,15 +2035,19 @@ int vhost_get_vq_desc(struct vhost_virtqueue *vq,
 
 	/* Grab the next descriptor number they're advertising, and increment
 	 * the index we've seen. */
-	if (unlikely(vhost_get_avail(vq, ring_head,
-		     &vq->avail->ring[last_avail_idx & (vq->num - 1)]))) {
-		vq_err(vq, "Failed to read head: idx %d address %p\n",
-		       last_avail_idx,
-		       &vq->avail->ring[last_avail_idx % vq->num]);
-		return -EFAULT;
+	if (!in_order) {
+		if (unlikely(vhost_get_avail(vq, ring_head,
+		    &vq->avail->ring[last_avail_idx & (vq->num - 1)]))) {
+			vq_err(vq, "Failed to read head: idx %d address %p\n",
+				last_avail_idx,
+				&vq->avail->ring[last_avail_idx % vq->num]);
+			return -EFAULT;
+		}
+		head = vhost16_to_cpu(vq, ring_head);
+	} else {
+		head = last_avail_idx & (vq->num - 1);
 	}
 
-	head = vhost16_to_cpu(vq, ring_head);
 
 	/* If their number is silly, that's an error. */
 	if (unlikely(head >= vq->num)) {
-- 
2.17.1

_______________________________________________
Virtualization mailing list
Virtualization@lists.linux-foundation.org
https://lists.linuxfoundation.org/mailman/listinfo/virtualization
