Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 23:32:56 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga007.fm.intel.com (fmsmga007.fm.intel.com [10.253.24.52])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 5DCEA58037D;
	Fri, 23 Nov 2018 01:25:17 -0800 (PST)
Received: from fmsmga101.fm.intel.com ([10.1.193.65])
  by fmsmga007-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 01:25:16 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AbaMFFRWIjWSpK+sSvC4fnKu1uzLV8LGtZVwlr6E/?=
 =?us-ascii?q?grcLSJyIuqrYZhGGuKdThVPEFb/W9+hDw7KP9fy4CSpYud6oizMrSNR0TRgLiM?=
 =?us-ascii?q?EbzUQLIfWuLgnFFsPsdDEwB89YVVVorDmROElRH9viNRWJ+iXhpTEdFQ/iOgVr?=
 =?us-ascii?q?O+/7BpDdj9it1+C15pbffxhEiCCybL9uLxi6txndutULioZ+N6g9zQfErGFVcO?=
 =?us-ascii?q?pM32NoIlyTnxf45siu+ZNo7jpdtfE8+cNeSKv2Z6s3Q6BWAzQgKGA1+dbktQLf?=
 =?us-ascii?q?QguV53sTSXsZnxxVCAXY9h76X5Pxsizntuph3SSRIMP7QawoVTmk8qxmUwHjhj?=
 =?us-ascii?q?sZODEl8WHXks1wg7xdoBK9vBx03orYbJiIOPZiYq/ReNUXTndDUMlMTSxMGp6y?=
 =?us-ascii?q?YZUPAeQCM+hXoYbyqFkBoxSiCwmsH/vvxz1Ti3/q36A3yfgtHR3I0QEiGd8FrX?=
 =?us-ascii?q?TarM/yNKcXSe27y7PHzS/dYPNVxDzz9YnJcxA5ofGWWrJxf9HRyUouFwjYiViQ?=
 =?us-ascii?q?rJbpPyiU1+UNq2ib9e1gVOy0i24kqgF8uSOvyd0pionSm4IVzF/E+T9lz4YyIN?=
 =?us-ascii?q?21UUh2asOnHptIryyWKZd6T8c4T211tis21KcKtYO4cSQW0pgqxhzSZ+Saf4SU?=
 =?us-ascii?q?4x/vTvudLSp5iX5/Zb6yiBS//VKux+HgUMS/zUxEoTBfktbWs3AAzxzT5daDSv?=
 =?us-ascii?q?t65kqhxzmP2B7J6u1eIkA7i7DbK5g/zb40jJYTtl7DHiDulEX3iq+ZaFkk9/C2?=
 =?us-ascii?q?5+j7ZrjqvIKQOoFqhg3kL6gjmdCzDf45PwUMR2Sb/P6z1Lzn/U33WrVKifg2n7?=
 =?us-ascii?q?HdsJDbI8Qbu6G4DxZW0ok98Ra/CSmp0NABkXkAIlNFfgyIj5LyNlHQL/D3E+2/?=
 =?us-ascii?q?j06vkDh13fDGOKPuApHXInjEirfhcq5x61RAxwor0dBf+5VUB6kFIPLyWU/+qs?=
 =?us-ascii?q?bUDxAkMwGvx+bnCdN91p4RWG6VA6+ZNr/SvkGM5u41P+aMY4oVsi7nK/c5//7u?=
 =?us-ascii?q?kWM5mVgFcKmpx5QXaWy4Ee5hI0mDYXrsn80OEWEFvgclSOzqiVuCUSNcZnqoXq?=
 =?us-ascii?q?I84C07B5yiDYvZWo+th7mB1j+hHpJKfmBGFkyMEXDweoWGXPcDdjieIsxmkjwC?=
 =?us-ascii?q?U7ihTJQs1RWvtA/81rpmIfDY+iwetZL/ytd14/ffmg019TxxF86dyX2CT3lonm?=
 =?us-ascii?q?MUQD87xLpwoVd9yleE0qh0meZYGsZR5/5SVgc6NJjcz/F1CtzoWwLBeMuJR0ii?=
 =?us-ascii?q?Qtm8HT4xSdcxyccUY0lhA9WikgzD3y2yDr8WjbOLAoY48qbd33frIcZ9xG3L1K?=
 =?us-ascii?q?0gj1kgX8tOOneqhq959wjPGYHJl1+VmLqtdaQZxCTN7nuMzXKSvEFEVw59SbjK?=
 =?us-ascii?q?UmoBZkTIt9j55lnNT7m1Cbs5NAtNzsqCKqhPat3tllhGQPbjONLDY2O+gWuwBB?=
 =?us-ascii?q?CIxq+SY4ruYWkSwCLdCE0cmQAJ4XmGLRQ+Bjumo2/GETNhD0zvbF32/el+sny7?=
 =?us-ascii?q?SFQ0wB+Mb0B607q1+xgVheGTSv8J37IEvjshpCtwHFqnw93WDN+ArRJ7fKpAed?=
 =?us-ascii?q?M9/EtH1WXBugxhP5ygKqdihkIecwV3pU/uyw97CoJakcgurXMqygVyJLmc0FNA?=
 =?us-ascii?q?cTOYwJ/xNqfWKmn04BCgdarW1kvC39aR/6cF8O44pEn7vAG1Ckoi9G1q3MNR03?=
 =?us-ascii?q?SC6ZTFEgoTXYjqXUYq6hd1vbfaYio654PKznBsNai0sjnf29MmHuclyxCgf8tB?=
 =?us-ascii?q?P6OADgP9D8oaB822Iuwwh1epdg4EPPxV9KMsP8KmauGK17KxMOdhnDKpl2JH4I?=
 =?us-ascii?q?9m30KI9ip8TPPI3pkfz/GZ2AuHSynzjFO7vs/rnoBEYCkYHnCjxij8GI5Reqpy?=
 =?us-ascii?q?cJ4RCWevP8K43M9+iIPqW3JC8l6sGUkG2M6wdRWOdVP92RBf2loNoXygnyu11D?=
 =?us-ascii?q?h0kzAvrqqC0y3C2eXidBwbOmFVQGlul0vjIY+xj9oCRkincxAplAe55Ub936Va?=
 =?us-ascii?q?pKV/I3PTQEtSZCj2MmdiX7C0trqDZc5P9ZwpvT9WUOS6fVCVVLr9rwEG3CPkGm?=
 =?us-ascii?q?tU3Co7eC2yupXlgxx6j3qQLHRpo3rDesFwxhDf6MbHRfFL3ToGRyh4iT/JCVi6?=
 =?us-ascii?q?JNSp+dSUl5HesuGxTW6hV5tTcTX1woOErie0+WpqARinlfCphtLnCRQ60TP819?=
 =?us-ascii?q?RyVSTHthH8bpPp16S7N+JqZU1oBF7668pnFYByiIowhJcM2XcEgpWZ52YIkWD2?=
 =?us-ascii?q?Md9Dw6LxcGINRSIXw97S+AXl21dsLnOTy4L5S3WS2M1hZ9ahb2MS2yI96d1KCa?=
 =?us-ascii?q?iO4LxFmyt1vkS3rQbLbfdhmTcdzOMk6GQGjOERpAot0iKdD6gXHUlZPizjjQ6E?=
 =?us-ascii?q?7t6go6VMeGagb6Kw21FgktC7A7GPuQVcWHf/epc/Ei589MR/MFTQ0HLt7oHoYs?=
 =?us-ascii?q?XfbdUWtheMiRfPk/BVKI4tlvoNnSdnJWX9vXg/x+86lxNu24y6vJOcK2Vs56+5?=
 =?us-ascii?q?Bh9YNjvoZ8Ic4D3tjKBentqI0ICrBJluBjILXJ7wR/KyDD0SrejnNxqJEDAksX?=
 =?us-ascii?q?iUA73fHQuC6Et8q3LPDoumN3WWJHkf0NVjSwORJE1ZgAAIQjo6moQ1GRytxMzk?=
 =?us-ascii?q?aE15/Cwe5kbkqhtQzeJlLxv/XX3apAi2cTc4UoSfIABV7gFf5EfVLMqe4fhoHy?=
 =?us-ascii?q?xD+p2hrQqNKnGUZghSDGEJXFCECE7nPrW0+dbA9O2YDPKkL/TSebWOtfBeV/CQ?=
 =?us-ascii?q?yJOv1Ytm4i+MNtiVMXlkFfE7wU1DXXZ2G8nCnzUPSioXlz/CbsKBpRe8/DF3od?=
 =?us-ascii?q?678PjxRA3v4o6PAaNIMdpz4xC2nbuDN+mIiSZ5NzlY15AMxXzJyLQF314SkSZu?=
 =?us-ascii?q?dzazHrQaqC7NV7ndmqtWDx4ddiNyO9FE76M63glRJ8Hbjsn52aJ/jv4wE11FT0?=
 =?us-ascii?q?Dumtm1ZcwWJGGwLEnIBFuQO7ScOzLKw9v7Yae9SbBLiOVUthuwuSuUEkP5PzSD?=
 =?us-ascii?q?kSXpWA6rMe1WkC6bOxlespmnchlxEWjjUM7mahqjPd9rjD02xKc4iW/QOWEAMT?=
 =?us-ascii?q?hzbUVNo6aU7SNZhPV/BmNA4mBkLemChyaW8e3YJowKvvtsByR+j/ha72giy7tJ?=
 =?us-ascii?q?8CFEQ+R4mSvIod5oplGmk++PxSJmURpOsDlLgo2LsF5mOaXY8JlARHnF8AgM7W?=
 =?us-ascii?q?WWFxQFud9lBsfztKBXz9ic3J70fRxC+sjQ8NBUJMXZMMuXeC4qMhfkADfEJAwd?=
 =?us-ascii?q?QDiwMnzFjEEbm/CI7GCO6JM9r86o0JAUTbhdVVEdFf4ADElhWtsYL8RZRDQhxJ?=
 =?us-ascii?q?uSlsMLrUGsvQHLQ9pBvZGPAvfUGuf+MCyekqJHZjMTyLbjMIIccIb83hoxORFB?=
 =?us-ascii?q?gI3WFh+IDph2qSp7Y1px+R0V/Q=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AYAAB0xvdbh0O0hNFiHgEGBwaBUggLA?=
 =?us-ascii?q?YNrJ4N5lBWBYC0Ugy6TeYFxLhMBiFQiNQgNAQMBAQEBAQECARMBAQEIDQkIKSM?=
 =?us-ascii?q?MgjYkAYJiAQIDAQIgBBkBAR4ZAQUJAQEKDgoCAiYCAgNEEAYBDAYCAQEBgxyCA?=
 =?us-ascii?q?QEFpjRwfDOCdgEBBYJDhE8IgQuJYoEcgVc/gREngmuER4M7gleHV4dEQ5AmBwK?=
 =?us-ascii?q?RKR6JYYcnkU+IKQKCCXCDPIIbg22KU3GBBQEBiVWCTQEB?=
X-IPAS-Result: =?us-ascii?q?A0AYAAB0xvdbh0O0hNFiHgEGBwaBUggLAYNrJ4N5lBWBYC0?=
 =?us-ascii?q?Ugy6TeYFxLhMBiFQiNQgNAQMBAQEBAQECARMBAQEIDQkIKSMMgjYkAYJiAQIDA?=
 =?us-ascii?q?QIgBBkBAR4ZAQUJAQEKDgoCAiYCAgNEEAYBDAYCAQEBgxyCAQEFpjRwfDOCdgE?=
 =?us-ascii?q?BBYJDhE8IgQuJYoEcgVc/gREngmuER4M7gleHV4dEQ5AmBwKRKR6JYYcnkU+IK?=
 =?us-ascii?q?QKCCXCDPIIbg22KU3GBBQEBiVWCTQEB?=
X-IronPort-AV: E=Sophos;i="5.56,269,1539673200"; 
   d="scan'208";a="63665623"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mga01b.intel.com with ESMTP; 23 Nov 2018 01:25:15 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2408912AbeKWUIi (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Fri, 23 Nov 2018 15:08:38 -0500
Received: from mailout2.w1.samsung.com ([210.118.77.12]:39334 "EHLO
        mailout2.w1.samsung.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S2390457AbeKWUIi (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 23 Nov 2018 15:08:38 -0500
Received: from eucas1p2.samsung.com (unknown [182.198.249.207])
        by mailout2.w1.samsung.com (KnoxPortal) with ESMTP id 20181123092510euoutp023a8fc60f0b49b647af83357db0d8dac0~ptpfgqwxR0407704077euoutp02H
        for <linux-kernel@vger.kernel.org>; Fri, 23 Nov 2018 09:25:10 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout2.w1.samsung.com 20181123092510euoutp023a8fc60f0b49b647af83357db0d8dac0~ptpfgqwxR0407704077euoutp02H
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1542965110;
        bh=xnIiNwoExWqbDIFPzNeTIRq4lPS4ObQxd7JM1Vz7SFk=;
        h=Subject:To:Cc:From:Date:In-Reply-To:References:From;
        b=VWcX0WWNL6zoT6Hxk1RKxZChrHgfsuyLF0ox42sOWXxJjAOROF5ACuY1Lp4mCDBiy
         7+pEXD5ISj3Qbl+iJ2w2s9mVycs3SJRSvbFUOuOzaR2wWidjrlDVosOoAOcZ4/jmju
         vGJFt31qjyJXhRkvwW7f8h5jmnz4ak5+jwc98wtU=
Received: from eusmges3new.samsung.com (unknown [203.254.199.245]) by
        eucas1p1.samsung.com (KnoxPortal) with ESMTP id
        20181123092510eucas1p142b7e7ff7c8dc71f5c0942a963650df4~ptpezT9740792607926eucas1p1o;
        Fri, 23 Nov 2018 09:25:10 +0000 (GMT)
Received: from eucas1p1.samsung.com ( [182.198.249.206]) by
        eusmges3new.samsung.com (EUCPMTA) with SMTP id 7D.71.04806.577C7FB5; Fri, 23
        Nov 2018 09:25:09 +0000 (GMT)
Received: from eusmtrp1.samsung.com (unknown [182.198.249.138]) by
        eucas1p1.samsung.com (KnoxPortal) with ESMTPA id
        20181123092509eucas1p1cf47e0ae03129b806e0358ca15c9fb86~ptpeEpyik0780607806eucas1p1l;
        Fri, 23 Nov 2018 09:25:09 +0000 (GMT)
Received: from eusmgms1.samsung.com (unknown [182.198.249.179]) by
        eusmtrp1.samsung.com (KnoxPortal) with ESMTP id
        20181123092508eusmtrp1a18176fa8c1b3f2fc36a7c2454475cc9~ptpd0zTV10152301523eusmtrp1H;
        Fri, 23 Nov 2018 09:25:08 +0000 (GMT)
X-AuditID: cbfec7f5-34dff700000012c6-48-5bf7c775d02b
Received: from eusmtip1.samsung.com ( [203.254.199.221]) by
        eusmgms1.samsung.com (EUCPMTA) with SMTP id 57.F5.04284.477C7FB5; Fri, 23
        Nov 2018 09:25:08 +0000 (GMT)
Received: from [106.116.147.30] (unknown [106.116.147.30]) by
        eusmtip1.samsung.com (KnoxPortal) with ESMTPA id
        20181123092508eusmtip1330270818c022152afa48ad8d413a4b4~ptpdgqHKb1462014620eusmtip1H;
        Fri, 23 Nov 2018 09:25:08 +0000 (GMT)
Subject: Re: [PATCH 3/3] gpio: Add reference counting for non-exclusive
 GPIOs
To: Charles Keepax <ckeepax@opensource.cirrus.com>, broonie@kernel.org
Cc: linus.walleij@linaro.org, lgirdwood@gmail.com,
        linux-kernel@vger.kernel.org, patches@opensource.cirrus.com
From: Marek Szyprowski <m.szyprowski@samsung.com>
Message-ID: <56d4a613-21a6-7a51-a9ef-a8e010a6945a@samsung.com>
Date: Fri, 23 Nov 2018 10:25:08 +0100
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:60.0) Gecko/20100101
        Thunderbird/60.3.1
MIME-Version: 1.0
In-Reply-To: <20181122173015.23905-3-ckeepax@opensource.cirrus.com>
Content-Transfer-Encoding: 7bit
Content-Language: en-US
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFlrKKsWRmVeSWpSXmKPExsWy7djPc7qlx79HG3yeq2sx9eETNosrrZsY
        Lb5d6WCymPJnOZPF5V1z2Cw+v9/P6sDmsXPWXXaPTas62TzuXNvD5jF9zn9Gj8+b5AJYo7hs
        UlJzMstSi/TtErgytu/+y1ZwQaji2A3FBsbHfF2MnBwSAiYSe07/YgSxhQRWMEo0Ho7vYuQC
        sr8wSpy/18UC4XxmlPi6cwETTMe6W3+hEssZJR51L2GFcN4zSjQ9a2EFqRIW8JfYP+MFG4gt
        IuAm8fr+GmYQm1mgQOJb7xMwm03AUKLrbRdYDa+AncS7pc/YQWwWAVWJ+z+/sYDYogIxEsdW
        3mCEqBGUODnzCVicU8BZ4k//CkaImfIS29/OgZovLnHryXwmkIMkBFaxS7yf9xTqbBeJCxf/
        sUDYwhKvjm9hh7BlJE5P7mGBaGhmlGifMYsdwulhlNg6ZwcbRJW1xOHjF4Fe4wBaoSmxfpc+
        RNhRYt7FLUwgYQkBPokbbwUhjuCTmLRtOjNEmFeio00IolpNYtbxdXBrD164xDyBUWkWktdm
        IXlnFpJ3ZiHsXcDIsopRPLW0ODc9tdg4L7Vcrzgxt7g0L10vOT93EyMw8Zz+d/zrDsZ9f5IO
        MQpwMCrx8G7Y+C1aiDWxrLgy9xCjBAezkghvk+L3aCHelMTKqtSi/Pii0pzU4kOM0hwsSuK8
        1QwPooUE0hNLUrNTUwtSi2CyTBycUg2MDEKNC5v2di46WLVxYodfycvPJZ82fM9ys0vI3sbu
        d/RgktQT0aqJ2uVhG9Jd5rD2JoX4KSa8j/5whqVj1jPmg6LCkRuap/95X5l5t2Pt2aX7w/vc
        5pfWlgfpXdXiF5eXuHrtUb3W+TkHhet+f6t333d0405r7bU/Lt/aIPHvgZvxs59eTmevKLEU
        ZyQaajEXFScCAMZgEH44AwAA
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFtrOIsWRmVeSWpSXmKPExsVy+t/xu7olx79HG6z/Z2kx9eETNosrrZsY
        Lb5d6WCymPJnOZPF5V1z2Cw+v9/P6sDmsXPWXXaPTas62TzuXNvD5jF9zn9Gj8+b5AJYo/Rs
        ivJLS1IVMvKLS2yVog0tjPQMLS30jEws9QyNzWOtjEyV9O1sUlJzMstSi/TtEvQytu/+y1Zw
        Qaji2A3FBsbHfF2MnBwSAiYS6279Zeli5OIQEljKKHF4zUN2iISMxMlpDawQtrDEn2tdbBBF
        bxklpj75x9jFyMEhLOArsfFbNkiNiICbxOv7a5hBbGaBAomTLXfZIerPM0pMaNoBNpRNwFCi
        6y3IIE4OXgE7iXdLn4HFWQRUJe7//MYCYosKxEh0Xp8HVSMocXLmE7A4p4CzxJ/+FYwQC9Ql
        /sy7BLVMXmL72zlQtrjErSfzmSYwCs1C0j4LScssJC2zkLQsYGRZxSiSWlqcm55bbKhXnJhb
        XJqXrpecn7uJERhp24793LyD8dLG4EOMAhyMSjy8GzZ+ixZiTSwrrsw9xCjBwawkwtuk+D1a
        iDclsbIqtSg/vqg0J7X4EKMp0HMTmaVEk/OBSSCvJN7Q1NDcwtLQ3Njc2MxCSZz3vEFllJBA
        emJJanZqakFqEUwfEwenVAOjbXH27Dkd6zO+3Y/myvq3JfaDmvwuDv1LYRH7p99oU2Kw3rYq
        Nv2//L7SjccE9Fc8ORL0W7E87/vuihjdbymS55/FpjUlfnB4w9h5lF+rNynI/He3zOLAKd0L
        JZKFkzdPLy+r3rDEZJvbrqkdy0pv50+b+aBBI+DBB4lC5s0CJ4LLuMQm/TulxFKckWioxVxU
        nAgAAKRVQsoCAAA=
X-CMS-MailID: 20181123092509eucas1p1cf47e0ae03129b806e0358ca15c9fb86
X-Msg-Generator: CA
Content-Type: text/plain; charset="utf-8"
X-RootMTR: 20181122173053epcas5p1a9b2170d5755bcb31d50d493c6618d25
X-EPHeader: CA
CMS-TYPE: 201P
X-CMS-RootMailID: 20181122173053epcas5p1a9b2170d5755bcb31d50d493c6618d25
References: <20181122173015.23905-1-ckeepax@opensource.cirrus.com>
        <CGME20181122173053epcas5p1a9b2170d5755bcb31d50d493c6618d25@epcas5p1.samsung.com>
        <20181122173015.23905-3-ckeepax@opensource.cirrus.com>
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Hi Charles,

On 2018-11-22 18:30, Charles Keepax wrote:
> Currently, a GPIO can be requested multiple times when the
> NONEXCLUSIVE flag is set, however it must still be freed a single
> time. This makes client code rather complex, since multiple drivers
> may request the GPIO but only a single one can free it. Rather than
> manually handling this in each driver add some basic reference
> counting into the core.  Currently, this is fairly primitive but
> so is the support for the NONEXCLUSIVE flag and the implementation
> covers those use-cases.
>
> Reported-by: Marek Szyprowski <m.szyprowski@samsung.com>
> Signed-off-by: Charles Keepax <ckeepax@opensource.cirrus.com>
Tested-by: Marek Szyprowski <m.szyprowski@samsung.com>
> ---
>  drivers/gpio/gpiolib.c | 13 ++++++++++++-
>  drivers/gpio/gpiolib.h |  2 ++
>  2 files changed, 14 insertions(+), 1 deletion(-)
>
> diff --git a/drivers/gpio/gpiolib.c b/drivers/gpio/gpiolib.c
> index 230e41562462b..42ba86fb495a5 100644
> --- a/drivers/gpio/gpiolib.c
> +++ b/drivers/gpio/gpiolib.c
> @@ -2407,6 +2407,13 @@ static bool gpiod_free_commit(struct gpio_desc *desc)
>  
>  	might_sleep();
>  
> +	if (desc->n_users > 1) {
> +		desc->n_users--;
> +		return true;
> +	} else {
> +		desc->n_users = 0;
> +	}
> +
>  	gpiod_unexport(desc);
>  
>  	spin_lock_irqsave(&gpio_lock, flags);
> @@ -4142,7 +4149,8 @@ struct gpio_desc *__must_check gpiod_get_index(struct device *dev,
>  			 */
>  			dev_info(dev, "nonexclusive access to GPIO for %s\n",
>  				 con_id ? con_id : devname);
> -			return desc;
> +
> +			goto done;
>  		} else {
>  			return ERR_PTR(status);
>  		}
> @@ -4155,6 +4163,9 @@ struct gpio_desc *__must_check gpiod_get_index(struct device *dev,
>  		return ERR_PTR(status);
>  	}
>  
> +done:
> +	desc->n_users++;
> +
>  	return desc;
>  }
>  EXPORT_SYMBOL_GPL(gpiod_get_index);
> diff --git a/drivers/gpio/gpiolib.h b/drivers/gpio/gpiolib.h
> index 087d865286a0c..f96eda90281a3 100644
> --- a/drivers/gpio/gpiolib.h
> +++ b/drivers/gpio/gpiolib.h
> @@ -230,6 +230,8 @@ struct gpio_desc {
>  	const char		*label;
>  	/* Name of the GPIO */
>  	const char		*name;
> +
> +	unsigned int		n_users;
>  };
>  
>  int gpiod_request(struct gpio_desc *desc, const char *label);

Best regards
-- 
Marek Szyprowski, PhD
Samsung R&D Institute Poland

