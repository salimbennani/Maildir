Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 23:32:55 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga003.jf.intel.com (orsmga003.jf.intel.com [10.7.209.27])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 8109F58040F;
	Fri, 23 Nov 2018 01:24:55 -0800 (PST)
Received: from orsmga101.jf.intel.com ([10.7.208.22])
  by orsmga003-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 01:24:55 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AU9jRYByKA0Hll/3XCy+O+j09IxM/srCxBDY+r6Qd?=
 =?us-ascii?q?0e8XL/ad9pjvdHbS+e9qxAeQG9mDu7Qc06L/iOPJYSQ4+5GPsXQPItRndiQuro?=
 =?us-ascii?q?EopTEmG9OPEkbhLfTnPGQQFcVGU0J5rTngaRAGUMnxaEfPrXKs8DUcBgvwNRZv?=
 =?us-ascii?q?JuTyB4Xek9m72/q99pHPYAhEniaxba9vJxiqsAvdsdUbj5F/Iagr0BvJpXVIe+?=
 =?us-ascii?q?VSxWx2IF+Yggjx6MSt8pN96ipco/0u+dJOXqX8ZKQ4UKdXDC86PGAv5c3krgfM?=
 =?us-ascii?q?QA2S7XYBSGoWkx5IAw/Y7BHmW5r6ryX3uvZh1CScIMb7Vq4/Vyi84Kh3SR/okC?=
 =?us-ascii?q?YHOCA/8GHLkcx7kaZXrAu8qxBj34LYZYeYP+d8cKzAZ9MXXXdPUNhRWSJCDI2z?=
 =?us-ascii?q?YYQAAOgOM+lEoYn9vEMOoBmlCAmwBu7i0CNEimP40KA41ekqDAHI3BYnH9ILqH?=
 =?us-ascii?q?naq8/6NL0MXuC20aLG0DTCbvNO2Tfn74jJfAshofKNXbltdsfRzFMjFxjEj1SQ?=
 =?us-ascii?q?sYzlJTSV1+oWs2iY7uptTvmvhHQiqwFqvzivwMgshpPViYISz1DJ7CN0y5s2K9?=
 =?us-ascii?q?2gUEN3f8KoHZ9Kuy2HOYZ6XNkuT3xrtSom0LELuJy2cDAXxJg7xhPTceGLf5WJ?=
 =?us-ascii?q?7x75SeqcLjV1iGhrdb6jgRu57FKuxffmVsau1VZHtipFncfItnAKzxHT9MeHRe?=
 =?us-ascii?q?Vn/ku72jaAyRrT6udaLkAwj6bbLIQhwrEompoSt0TMADP2lV3ogKOKckgo4PWk?=
 =?us-ascii?q?5ur5brn8u5ORNJN4hhv/P6ksgsC/BP43MgkKX2iV4+S807jj8FX9QLVLiP02j6?=
 =?us-ascii?q?bYvInZJcsFvK65BRFa0oI65xa4ATam1soXnWMcIVJbdxKIkZLpN0vNIP/mF/e/?=
 =?us-ascii?q?hUqjkDNxy/DBJL3hDY3BLmLfn7f5YbZ990lcxRI3zdBe5JJbFKsNIf3uWkLqsN?=
 =?us-ascii?q?zYDxk5MxG7wur9CdV90J8eVnyLAqODLKzStlqI7Po1I+aQfI8VpCr9K/896v7u?=
 =?us-ascii?q?l3A5mEMdcrOu3ZcNaHC4A+5pI0OWYXf3htcBEGEKvhcxTeDwiV2CVyJTaGi2X6?=
 =?us-ascii?q?4m+j47D4emB5/ZRo+xmLyBwDu7HppOa2BEDVCDD23kd4aDW/cKbiKSJdRskjgF?=
 =?us-ascii?q?VbinVo8g2guitA78y7p7MOXU/jcUuo7k1Nhw/+fTjw099SRoD8SB1GGAV3t7nn?=
 =?us-ascii?q?gIRz8x36Bzu1Z9xU2B0aVjh/xYFNpT5+5GUwsgNJ7cyfB6BM72Wg7bYtiJT1Om?=
 =?us-ascii?q?SM28AT4tVtIx38MOY0FlFtWhlB/D2TCmA7sUl7ORApw0/bnR33zwJ8Z71nbH27?=
 =?us-ascii?q?Mtj1ggQstTK2KmgrRz+BTUB47Mi0+ZjbqldbwA3C7R82eO1XeBs1tGUAFuS6nF?=
 =?us-ascii?q?XWoQZk3Nrdvn4EPOSLuuCbciMgtF0sOCLqpKatv0jVRJXvvjOdLeY36vlGe0Hx?=
 =?us-ascii?q?qH2rSMbI/ycWUHwCrdEFQEkxwU/XueKAcxHDmhrHzEADxuD13vZVjs/vd4qH6g?=
 =?us-ascii?q?Sk80zgeKb1Bu1rav+x4Vg+CcRO0X3r4epCghrDB0Fk6n393KE9qAuxZhfKJEbN?=
 =?us-ascii?q?Mh4VdH0GXZtxB9Pp2gNaximkQScwNtv0Pq1hV3DIpAnNMurHMrygpyNK2Z3ElA?=
 =?us-ascii?q?dzOewZD/JLnXJnPu8xCobq7cwkve38qO+qcT9PQ4rE3usxutFkU8/HRozdlU32?=
 =?us-ascii?q?GH6ZXXEQUdS5TxUkUw9xhkvLzaZig954XJ1XxjK6W0sznC2843C+sh0BqvY9Bf?=
 =?us-ascii?q?MKacHg/oD8IaH9SuKPAtm1WxbhMEIfpe+7IuM8Knd/uJwqirPOl7kTKijGRH5p?=
 =?us-ascii?q?19002W+yp9TO7Iw4gKw/WC0gSbUDf8iU+rstrrloBceTESAm2/xDD+BI5QeqJ9?=
 =?us-ascii?q?Z5wLBnqpI8GtwNVxmYTtW39B+FG/HVwG3NKmdgSIb1z62w1dzkAXoX2hmSulwD?=
 =?us-ascii?q?14iTAprqyD3CPQx+TubgYIOmlORGN6l1fjPZC0j8wGXEivdwUolBql6Vz6xqRB?=
 =?us-ascii?q?v6R/Mm/TTFxMfyj3KWFiT6SxuqCDY85J9JMnryFXXP6gblCdT773uwEa3D/7H2?=
 =?us-ascii?q?tC2DA7cCmnupfjkBxgi2KdL3FzoGDCec5qxhff593cRfhP0ToAXyR4jTjXBl6h?=
 =?us-ascii?q?P9im59mUlpHDsvygWGKlTJFcbS7rzYaYviuh+WJqGQG/n+y0mtD/EQk1yyj728?=
 =?us-ascii?q?NoVSXJqhbxeY3r16W8MeJ6cUhkHl7868xmGo5glos8no0f2X8fhp+N53oIjX/z?=
 =?us-ascii?q?MclH2aL5dHcNRiQEw9/P7AjlxU1sNHSJx43iW3WZw8thYcS6Y2wM1iI86cBKFL?=
 =?us-ascii?q?mb7LhekSRppVq4qBrbYeJhkTcF1fsu9HkajvkMuAoszSWSGKoeHEdGMiz3ixSH?=
 =?us-ascii?q?8cq+o75Ja2a1fri9z05+ndGnDLGfrQBQQnf5epE+HSBu6sVzKk7D0Hr26ov8Yt?=
 =?us-ascii?q?nfccoTtgGIkxfHl+VVNJUxlv8QiStmI239u2Aly/UgjRxvxpy6uImHK2Nw/KO2?=
 =?us-ascii?q?GBJYNzv1Z98N9THpl6pRgsGW34W3FJV7BjoLRIfoTe6vED8KrvvoLQGOEDkhqn?=
 =?us-ascii?q?uBHbrfABSS6ENnr3LJDpCqOGubJHgfzdV+WhadIFZTjxwTXDU/hpQ5DBylxNT9?=
 =?us-ascii?q?cEdl4TAc/lz4pQFJyu12LBnzSHvfqB2rajcpS5ifMRxW4RtZ50rONcye7+RzHz?=
 =?us-ascii?q?xX/5G7rQyNLHCbaBpMDW0TRkOEAFXjNKG05dbc6+iYGva+L/zWbLSOruxeSu6I?=
 =?us-ascii?q?xY+13Ytg5TqMLcKPPn9tD/Ag3kpDXHZ5G9nWmjkVSiwXkT7NYNCfpBum5iJ3qc?=
 =?us-ascii?q?W/+uzxWA3z/YuPF6dSMdJ39hC2n6iDNu2QhCV4KTpC1ZMM33jIyLcB014IliFu?=
 =?us-ascii?q?bCKgEbABtS7LUaLRlbVbDx8dayNvKsRI67gw0RVKOc7ektn1zKJ3juYpC1dZUl?=
 =?us-ascii?q?zsgtumZdERLGGnKlzGBFyHNLCHJTDQx8H3YKW8SaBfjelOth2wvyqbHFHnPjiZ?=
 =?us-ascii?q?izbpUBWvO/lWjC6HJBxepJ29chF1BGj/TdLmbwe3P8NtgTIqwb07mHXKOHUYMT?=
 =?us-ascii?q?h9dUNNs7KR4TlZgvV5B2xO8H5lIfOYlCae6unSMowWvudzAiRoi+Ja52w3yrtP?=
 =?us-ascii?q?4yFCQfx1mS3SocZvolGmiOaPzDVnXQFKqjZKgoKLoEpjNb/Y9plGRXbL4hYN4X?=
 =?us-ascii?q?+MBBQNots2QuHo7otQw8LLmbm7CzpP69vEtZ8XBMXZMMuXGH05PBzyHyPOBwZD?=
 =?us-ascii?q?Rj+xL3zEwUdalafWvnePqZ88q5XEm5cUTLJfElsvGaA0EENgSfkLOpp0Fgg2gK?=
 =?us-ascii?q?aBi9ET5nv2+ByXX9dLporASemRAN30ITOCkL9LIRAPxOWrfswoKoTn1hk6ORFB?=
 =?us-ascii?q?l4PQFh+VBIgVrw=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0APAACuxvdbh0O0hNFiHgEGBwaBUQkLA?=
 =?us-ascii?q?YNrJ4N5lBWBYC0Ugy6TeYFxLhMBiFQiNAkNAQMBAQEBAQECARMBAQEIDQkIKSM?=
 =?us-ascii?q?MgjYkAYJiAQIDAQIgBBkBAR4ZAQUJAQEKDgoCAiYCAgNEEAYBDAYCAQEBgxyCA?=
 =?us-ascii?q?QEFpjRwfDOCdgEBBYJDhE8IgQuJYoEcgVc/gREngj0ugUEBhkCCV4dXiAeQJgc?=
 =?us-ascii?q?CkSkegVmICIcniW2HYogngg1wUIJsghsMDAuDSopTcYEFAQGMIgEB?=
X-IPAS-Result: =?us-ascii?q?A0APAACuxvdbh0O0hNFiHgEGBwaBUQkLAYNrJ4N5lBWBYC0?=
 =?us-ascii?q?Ugy6TeYFxLhMBiFQiNAkNAQMBAQEBAQECARMBAQEIDQkIKSMMgjYkAYJiAQIDA?=
 =?us-ascii?q?QIgBBkBAR4ZAQUJAQEKDgoCAiYCAgNEEAYBDAYCAQEBgxyCAQEFpjRwfDOCdgE?=
 =?us-ascii?q?BBYJDhE8IgQuJYoEcgVc/gREngj0ugUEBhkCCV4dXiAeQJgcCkSkegVmICIcni?=
 =?us-ascii?q?W2HYogngg1wUIJsghsMDAuDSopTcYEFAQGMIgEB?=
X-IronPort-AV: E=Sophos;i="5.56,269,1539673200"; 
   d="scan'208";a="41967610"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 23 Nov 2018 01:24:53 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2408901AbeKWUIQ (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Fri, 23 Nov 2018 15:08:16 -0500
Received: from mailout2.w1.samsung.com ([210.118.77.12]:39210 "EHLO
        mailout2.w1.samsung.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S2390458AbeKWUIP (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 23 Nov 2018 15:08:15 -0500
Received: from eucas1p2.samsung.com (unknown [182.198.249.207])
        by mailout2.w1.samsung.com (KnoxPortal) with ESMTP id 20181123092449euoutp026ce0d745b58871e77f9f7f8fd0e7110d~ptpLeP9g70403804038euoutp02I
        for <linux-kernel@vger.kernel.org>; Fri, 23 Nov 2018 09:24:49 +0000 (GMT)
DKIM-Filter: OpenDKIM Filter v2.11.0 mailout2.w1.samsung.com 20181123092449euoutp026ce0d745b58871e77f9f7f8fd0e7110d~ptpLeP9g70403804038euoutp02I
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=samsung.com;
        s=mail20170921; t=1542965089;
        bh=DkonihV2hXgvtMc9ttfHltxahVM4WMfqTstWPra7mIc=;
        h=Subject:To:Cc:From:Date:In-Reply-To:References:From;
        b=aO8w5D0NSDcml6NCY6sDzh2DEN1H9yMZDqfRamPXlKQbXd3ye9fuA0ivVUjg79M5v
         sJtlEGT6LmMv7wK68bLjivcSf3zd4ZJ2FDZPVdD9/cd93m0O5z9/ZOKcWG/efFZPQc
         yYVqZeRDM8u0bblmLwbirvkDsJL8wqnJEOx/+CC8=
Received: from eusmges1new.samsung.com (unknown [203.254.199.242]) by
        eucas1p1.samsung.com (KnoxPortal) with ESMTP id
        20181123092448eucas1p1efb2f8d9bdb33e6ee51afcfa11092768~ptpKz4fJp0777607776eucas1p1K;
        Fri, 23 Nov 2018 09:24:48 +0000 (GMT)
Received: from eucas1p1.samsung.com ( [182.198.249.206]) by
        eusmges1new.samsung.com (EUCPMTA) with SMTP id 35.56.04441.067C7FB5; Fri, 23
        Nov 2018 09:24:48 +0000 (GMT)
Received: from eusmtrp1.samsung.com (unknown [182.198.249.138]) by
        eucas1p2.samsung.com (KnoxPortal) with ESMTPA id
        20181123092447eucas1p21bfca1eb072bec871b8ace1c9ae61bc1~ptpKBU0A31468414684eucas1p2a;
        Fri, 23 Nov 2018 09:24:47 +0000 (GMT)
Received: from eusmgms1.samsung.com (unknown [182.198.249.179]) by
        eusmtrp1.samsung.com (KnoxPortal) with ESMTP id
        20181123092447eusmtrp1828e224fcc3c21d01e49d4e37011ff33~ptpJxOZCV0122901229eusmtrp18;
        Fri, 23 Nov 2018 09:24:47 +0000 (GMT)
X-AuditID: cbfec7f2-5e3ff70000001159-c5-5bf7c760eef6
Received: from eusmtip1.samsung.com ( [203.254.199.221]) by
        eusmgms1.samsung.com (EUCPMTA) with SMTP id 49.E5.04284.F57C7FB5; Fri, 23
        Nov 2018 09:24:47 +0000 (GMT)
Received: from [106.116.147.30] (unknown [106.116.147.30]) by
        eusmtip1.samsung.com (KnoxPortal) with ESMTPA id
        20181123092447eusmtip1c53997817a243eb912e4b12bd5207f9a~ptpJcaKK21537715377eusmtip1C;
        Fri, 23 Nov 2018 09:24:47 +0000 (GMT)
Subject: Re: [PATCH 2/3] regulator: Only free GPIOs if the core requested
 them
To: Charles Keepax <ckeepax@opensource.cirrus.com>, broonie@kernel.org
Cc: linus.walleij@linaro.org, lgirdwood@gmail.com,
        linux-kernel@vger.kernel.org, patches@opensource.cirrus.com
From: Marek Szyprowski <m.szyprowski@samsung.com>
Message-ID: <0716cd43-2f2d-cac9-5bb7-dffcbd3a4795@samsung.com>
Date: Fri, 23 Nov 2018 10:24:46 +0100
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64; rv:60.0) Gecko/20100101
        Thunderbird/60.3.1
MIME-Version: 1.0
In-Reply-To: <20181122173015.23905-2-ckeepax@opensource.cirrus.com>
Content-Transfer-Encoding: 7bit
Content-Language: en-US
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFlrGKsWRmVeSWpSXmKPExsWy7djPc7oJx79HGyzaJGAx9eETNosrrZsY
        Lb5d6WCymPJnOZPF5V1z2Cw+v9/P6sDmsXPWXXaPTas62TzuXNvD5jF9zn9Gj8+b5AJYo7hs
        UlJzMstSi/TtErgyzr3Yy1qwVaii9+kV5gbGXXxdjJwcEgImEvcau9m6GLk4hARWMEocXbmK
        DSQhJPCFUeLhF22IxGdGiee71jHBdKx6fACqYzmjxOMTL6Gc94wSU1f+YAapEhYIkJi5Zgc7
        iC0i4Cbx+v4asDizQIHEt94nYDabgKFE19susHW8AnYS295+B7NZBFQlvn+fCWaLCsRIHFt5
        gxGiRlDi5MwnLCA2p4CzxL6NRxghZspLbH87B2q+uMStJ/OZQA6SEFjFLrF04imos10k+nZs
        ZoGwhSVeHd/CDmHLSJye3MMC0dDMKNE+YxY7hNPDKLF1zg42iCpricPHL7J2MXIArdCUWL9L
        HyLsKHHzeQ8zSFhCgE/ixltBiCP4JCZtmw4V5pXoaBOCqFaTmHV8HdzagxcuMU9gVJqF5LVZ
        SN6ZheSdWQh7FzCyrGIUTy0tzk1PLTbMSy3XK07MLS7NS9dLzs/dxAhMPaf/Hf+0g/HrpaRD
        jAIcjEo8vBs2fosWYk0sK67MPcQowcGsJMLbpPg9Wog3JbGyKrUoP76oNCe1+BCjNAeLkjhv
        NcODaCGB9MSS1OzU1ILUIpgsEwenVANj67QV3cffGqUu7K3x6JrEZrn+pBafh6R4r5FxeFFF
        EFNG340OiQUW09ivTOUvmymr2+n4R3vF4scigWLi96R/+NYxtl66svX1euPzXlXy57b+j+qZ
        v++HJuOO9S+7V0Wvu3zltsucqN7dfbxTuFJcfq7ZdOnEip9pqza/c2ULn9y3znFf7OrJSizF
        GYmGWsxFxYkAz4ITGjkDAAA=
X-Brightmail-Tracker: H4sIAAAAAAAAA+NgFtrBIsWRmVeSWpSXmKPExsVy+t/xu7rxx79HG/Q+krCY+vAJm8WV1k2M
        Ft+udDBZTPmznMni8q45bBaf3+9ndWDz2DnrLrvHplWdbB53ru1h85g+5z+jx+dNcgGsUXo2
        RfmlJakKGfnFJbZK0YYWRnqGlhZ6RiaWeobG5rFWRqZK+nY2Kak5mWWpRfp2CXoZ517sZS3Y
        KlTR+/QKcwPjLr4uRk4OCQETiVWPD7B1MXJxCAksZZTo/nqEESIhI3FyWgMrhC0s8edaF1TR
        W0aJ/3f62bsYOTiEBfwkLt3hBakREXCTeH1/DTOIzSxQIHGy5S47RP15RolT86+DJdgEDCW6
        3oIM4uTgFbCT2Pb2O5jNIqAq8f37TDBbVCBGovP6PKgaQYmTM5+wgNicAs4S+zZCHMcsoC7x
        Z94lqGXyEtvfzoGyxSVuPZnPNIFRaBaS9llIWmYhaZmFpGUBI8sqRpHU0uLc9NxiQ73ixNzi
        0rx0veT83E2MwFjbduzn5h2MlzYGH2IU4GBU4uHdsPFbtBBrYllxZe4hRgkOZiUR3ibF79FC
        vCmJlVWpRfnxRaU5qcWHGE2BnpvILCWanA9MA3kl8YamhuYWlobmxubGZhZK4rznDSqjhATS
        E0tSs1NTC1KLYPqYODilGhgTt9uuSkt9vXLe9aOl2vMlWUIVJXdKN8UIX1rqnC5yeFVu2XKO
        fVOPOJo99bxT5OhRFzTBZcm3ipOSH4Nv+XJ/4Bd4vMF535lOvbjd09Y2P48OMJV2Y8lg5+ON
        +MN+99Eenke1224ck1UMMHPRiCvd4Lp3ytrfd1gWaP20Z8q5NOHFtG2HFB4psRRnJBpqMRcV
        JwIAJo12n8sCAAA=
X-CMS-MailID: 20181123092447eucas1p21bfca1eb072bec871b8ace1c9ae61bc1
X-Msg-Generator: CA
Content-Type: text/plain; charset="utf-8"
X-RootMTR: 20181122173037epcas1p2f0b7577cd0babcc6fc42bdc305c58376
X-EPHeader: CA
CMS-TYPE: 201P
X-CMS-RootMailID: 20181122173037epcas1p2f0b7577cd0babcc6fc42bdc305c58376
References: <20181122173015.23905-1-ckeepax@opensource.cirrus.com>
        <CGME20181122173037epcas1p2f0b7577cd0babcc6fc42bdc305c58376@epcas1p2.samsung.com>
        <20181122173015.23905-2-ckeepax@opensource.cirrus.com>
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Hi Charles,

On 2018-11-22 18:30, Charles Keepax wrote:
> Currently, the regulator core will take ownership of any GPIO passed
> into it. Makes end driver code fairly error prone as the normal devm_
> patterns of allocation don't work. Update the regulator core to only
> free the GPIO if it requested it, this allows the drivers to manage the
> GPIO lifetime as they normally would.
>
> Reported-by: Marek Szyprowski <m.szyprowski@samsung.com>
> Signed-off-by: Charles Keepax <ckeepax@opensource.cirrus.com>

Tested-by: Marek Szyprowski <m.szyprowski@samsung.com>

> ---
>  drivers/regulator/core.c | 19 +++++++++++--------
>  1 file changed, 11 insertions(+), 8 deletions(-)
>
> diff --git a/drivers/regulator/core.c b/drivers/regulator/core.c
> index dbe2f2e6e6254..9da7d27c7145e 100644
> --- a/drivers/regulator/core.c
> +++ b/drivers/regulator/core.c
> @@ -83,6 +83,7 @@ struct regulator_enable_gpio {
>  	u32 enable_count;	/* a number of enabled shared GPIO */
>  	u32 request_count;	/* a number of requested shared GPIO */
>  	unsigned int ena_gpio_invert:1;
> +	unsigned int locally_requested:1;
>  };
>  
>  /*
> @@ -2233,19 +2234,20 @@ static int regulator_ena_gpio_request(struct regulator_dev *rdev,
>  		}
>  	}
>  
> +	pin = kzalloc(sizeof(struct regulator_enable_gpio), GFP_KERNEL);
> +	if (pin == NULL)
> +		return -ENOMEM;
> +
>  	if (!config->ena_gpiod) {
>  		ret = gpio_request_one(config->ena_gpio,
>  				       GPIOF_DIR_OUT | config->ena_gpio_flags,
>  				       rdev_get_name(rdev));
> -		if (ret)
> +		if (ret) {
> +			kfree(pin);
>  			return ret;
> -	}
> +		}
>  
> -	pin = kzalloc(sizeof(struct regulator_enable_gpio), GFP_KERNEL);
> -	if (pin == NULL) {
> -		if (!config->ena_gpiod)
> -			gpio_free(config->ena_gpio);
> -		return -ENOMEM;
> +		pin->locally_requested = 1;
>  	}
>  
>  	pin->gpiod = gpiod;
> @@ -2270,7 +2272,8 @@ static void regulator_ena_gpio_free(struct regulator_dev *rdev)
>  		if (pin->gpiod == rdev->ena_pin->gpiod) {
>  			if (pin->request_count <= 1) {
>  				pin->request_count = 0;
> -				gpiod_put(pin->gpiod);
> +				if (pin->locally_requested)
> +					gpiod_put(pin->gpiod);
>  				list_del(&pin->list);
>  				kfree(pin);
>  				rdev->ena_pin = NULL;

Best regards
-- 
Marek Szyprowski, PhD
Samsung R&D Institute Poland

