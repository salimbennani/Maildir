Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 25 Nov 2018 14:42:27 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga005.fm.intel.com (fmsmga005.fm.intel.com [10.253.24.32])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id E99E358037D;
	Sat, 24 Nov 2018 09:24:09 -0800 (PST)
Received: from fmsmga101.fm.intel.com ([10.1.193.65])
  by fmsmga005-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 24 Nov 2018 09:24:09 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AFkpiCheTn6HiB9+HOi+BPHFslGMj4u6mDksu8pMi?=
 =?us-ascii?q?zoh2WeGdxc6/bRKN2/xhgRfzUJnB7Loc0qyK6/CmATRIyK3CmUhKSIZLWR4BhJ?=
 =?us-ascii?q?detC0bK+nBN3fGKuX3ZTcxBsVIWQwt1Xi6NU9IBJS2PAWK8TW94jEIBxrwKxd+?=
 =?us-ascii?q?KPjrFY7OlcS30P2594HObwlSizexfbB/IA+qoQnNq8IbnZZsJqEtxxXTv3BGYf?=
 =?us-ascii?q?5WxWRmJVKSmxbz+MK994N9/ipTpvws6ddOXb31cKokQ7NYCi8mM30u683wqRbD?=
 =?us-ascii?q?VwqP6WACXWgQjxFFHhLK7BD+Xpf2ryv6qu9w0zSUMMHqUbw5Xymp4rx1QxH0li?=
 =?us-ascii?q?gIKz858HnWisNuiqJbvAmhrAF7z4LNfY2ZKOZycqbbcNwdWGRBQ91RVzRfDYyg?=
 =?us-ascii?q?c4sBAe0BPeNCoIn8oVsFsB+yCAaoCe/qzDJDm3340rAg0+k5Hg7G0g4vEdIAvn?=
 =?us-ascii?q?rXsdv7KrsdUfutzKTK1jjDc+9a1C3h5ITUbhwso/eBVq9wf8rLzkkvEhvIgVWR?=
 =?us-ascii?q?qYzhOzOayOENuHWG4OV+SOmilnQnqxxwojitwMcnl47Eh4wUylDA8SV23oM1Ks?=
 =?us-ascii?q?CmR0Fge96kDZpQtyOcN4dsQcMtXXtouCAkxb0CopO7cy0Kx44mxx7bcfCIb4+I?=
 =?us-ascii?q?4hf6WeuXPDx2inVleLeliBaz90it0vfzVtGs0FZRtipFlcXMumoR2BzU78iKTO?=
 =?us-ascii?q?Z28ES52TuXyQzf9uVJLVopmafVNZIt2KM8m5kPvUjZHyL7ml36gLGKekgg4OSl?=
 =?us-ascii?q?6OTqbq/4qpOANIJ4kADzP6Yol8eiG+o3KBIOUHKe+emk1L3s40n5QLJSg/0ona?=
 =?us-ascii?q?nWroraKd4YpqGnGQ9V1Jgs6xKlAzehytQYkmELLFNDeB2Zk4jkI0/CLOz8APul?=
 =?us-ascii?q?nlihnilny+rbMrDiHpnBNHnOnbX5cbZ48UFcyQ4zzd5F55JTD7EMOPbzWk73tN?=
 =?us-ascii?q?zFAR41Kg+0zPj9CNV7yIweXXuDAqiXMaPUr1CI/PkiI/eDZIALojbxMfsl6OD0?=
 =?us-ascii?q?jX8/h1AdebOl3ZwNaHC3BvhmOVmWYWLwgtcdFmcHpg4+TO3piFKcSzJSaGuyUr?=
 =?us-ascii?q?k45jE6DoKmEIjCSpqsgLyHwCe0AJlWanpaBVCLFHfib5+EVOsUaCKOPs9hlSQJ?=
 =?us-ascii?q?Vbi7RI8gyRGhrgj6x6BnLurJ4CIYs53j2cNx5+3SkxEy6DN1A96c02GLU2F7gG?=
 =?us-ascii?q?cISyUq06B4pEx30k2D3rRgg/xECdxT4OtEUgU9NZHC1eB6CNfyWgTHfteOU1um?=
 =?us-ascii?q?RtSmATcsTtM+2dMOYkB9G8m8gRDHxSalH7gVl7mTDpwu7q3cx2TxJ9p6y3vezq?=
 =?us-ascii?q?YhlFkmQsxMNWG8nK5w7QrTCpXNk0WYkaaqaKsd0DTM9GeF0WqBokVYXBRsXqXC?=
 =?us-ascii?q?WHAVflHWosjh5kPeU7+uDqwqMghbxs6EMKdKbtzpgk9ARPfsI9neZ2Oxm2GtBR?=
 =?us-ascii?q?eH3L+MbYzqe3kD0yXZEkQLjwcT/XOePwgkGiihu37eDCBpFV/3fkzj6/d+p22h?=
 =?us-ascii?q?Qk801Q6KaVZh2KSz+hISgfycSPYT3rYftSclqjV0Gku93t3MB9qBoQphYLtTYd?=
 =?us-ascii?q?cn7Fhb0mLZshR3Poa8IKB6ml4ebwN3slvz2BptFIVPj9ImrHMwwwp0MqKXzlVB?=
 =?us-ascii?q?eiic3ZDxPL3XN2bz8Aqua67QxlHRztKW9r0T5/Q/rlXppBupGVY683V7z9lV1G?=
 =?us-ascii?q?OR5onLDAoXVpLxTkY39hhgq7HGeCU94JnU1XltMamyvT/PwNYpBOojyha9cNZT?=
 =?us-ascii?q?KqKEFAnuE8IEA8iiMvAlm1+sbhgcJuBd6LY0P9+6d/uBwKOkJuJgkyypjGtZ4I?=
 =?us-ascii?q?FxyFmD9zdhReHS2ZYFwPaY3hWcWjf4jVehtN33mI9eaTETGGq/1TbrBIpLaqJu?=
 =?us-ascii?q?eoYLDH+kI9erydVmm57tR3lY+UajBlMbwsOmZQCebl393QJK00QXrmeqmS+5zz?=
 =?us-ascii?q?xyjjEoobCT3C3Iw+T+ahUHPnRHS3VljVfpOYK0lcwVXFC0bwg1kxuo/Vz6x6lH?=
 =?us-ascii?q?q6tlNWncXEBIczLwL258SKuwt6OObNJV55MsrCpYTv68YVecSrPmpxsa0iXjH3?=
 =?us-ascii?q?ZRxTwhdjGqvIn5kAJ+iG6HMHlzq3/Zc9lqxRjD/NzcWeJR3j0eSSh4iDnbHFi9?=
 =?us-ascii?q?M8Oy/dWJkZfOqeS+V2OnVp1Ofijn14KAtC2n5WJ0BR2zhey8mtriEQIiyy/0y8?=
 =?us-ascii?q?FqVTnUrBb7eoTr1b61MfhkfklrA1/w8dF6FZt9koszhZEQ32YVhpOO8HoDkGfz?=
 =?us-ascii?q?N8hb2K3kYHoMQz4L38Da4Az/1EJ/KXKJwprzVm+Bzct5e9m6fmQW1zo97s9QD6?=
 =?us-ascii?q?eY9r5EnSpzolejqQLRYP59nioSyPc06X4ahf0JtxQpzimHHr8SGkxYNzT2lxuU?=
 =?us-ascii?q?99C+sLlXZGG3fLizzkV+nMqtDLGfog5GXnb5dYwvHStx7sV5LVLN32f/6oDieN?=
 =?us-ascii?q?nMc90TsgeYnAvHj+hQMJgxjOYFhTJ7OWLhun0o0+s7jR1t3Z6gpoSGJXti/Lml?=
 =?us-ascii?q?AhFGLD36fN0c+ivijatFmsaW3oavHohuGzkRXZvoS+6oHywWtfj9KwmOFzg8oG?=
 =?us-ascii?q?+BGbXDBQ+f9Ftmr3XXHpC3MHGXIWMVzNR4SxmbOUxfmxsUXDQhk549FwCqwtHh?=
 =?us-ascii?q?cUhj6jAQ4F74tgVDyuZyOxbjVWffoR+iai0oR5iHMBpW8gZC6l/OPsOE6eJzGz?=
 =?us-ascii?q?xY8oelrAyQMWGbYwVIDWcUWk2LHVzjP7+u5cXe/OicHOaxM/zOYbCWo+xES/iI?=
 =?us-ascii?q?3Y6v0pdh/zuUNMWAJHxiAOMg2kZZQXB1AcfZmygMSywKkSLCddWbqQy4+i12qM?=
 =?us-ascii?q?C/7fvqVBju5YuJF7tdL9Fv9wqqjqeEMu6anDx5JipA1pMQ2X/Iz6AS3V4ViyFz?=
 =?us-ascii?q?bjmtDK4PtSjXQKLLna9XCREbZjh3NMtJ6aI8wwZMNdTaitPzyr53kPo1B01ZWl?=
 =?us-ascii?q?zmn8GjfdYKLH2lNFPbGEaLM6yLJT3VzMH2YqO8SrxQgP9Xtx2qvjabHFHsPi6e?=
 =?us-ascii?q?lznyTB2vNeBMjCeGPB1Roo29cxBtCXT9Q9LicBG0LNh3jTguy70umnzKLXIcMS?=
 =?us-ascii?q?R7c05VtLKQ8DhXgu9hFG1B9HZlKeiElj2d7+nZLJYWrPRqDj51l+Jc/HQ11b9V?=
 =?us-ascii?q?4DtYS/xynSvYtsRurE2+kumT1jpnVwJDqipKhIKOp0ltJb/V+YVAWXna+hIA9m?=
 =?us-ascii?q?GQCxUMp9t4BdzjoaFQyt7TlK3tLDdO6c7b/cwZB8LMMsKILGIhMQb1GD7TFAYE?=
 =?us-ascii?q?TSSkNWfah0xclvGd7nyUrpggpZjql5oDUbtbVF0zFvMHBUVpBt0CIJFrXjw6lb?=
 =?us-ascii?q?6XltIH5X27rEqZeMIPpYHVXPWOQqWxdWnB0bVPOxVXz72lId0abtHx81dzeFpz?=
 =?us-ascii?q?mIDHAQzZRchWuip9awY1pANG930tYHc03hfaawep7XpbGfP8tAQriwl4KbAy9T?=
 =?us-ascii?q?Po7lI7K1DQuSoylg8ylM/jjDS5fzv4LaP2VoZTXXmn/3MtO4/2Fl4mJTa5mlZp?=
 =?us-ascii?q?YXKZHr8=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0CBAADbh/lbh0O0hNFjEwEBCQEGBwaBV?=
 =?us-ascii?q?AYLAYJpgQIng3mDe5IrFIl3jyQsCwgBiFoiNwYNAQMBAQEBAQECARMBAQEIDQk?=
 =?us-ascii?q?IKSMMgjYkgmMBAgMBAiAdARsdAQMCCQEBBQULDQICJgICAx8BEQEFARwZBYMcA?=
 =?us-ascii?q?YFoAQMVBQqbBjyLDYESBQEXgncFhDAKGScNWoE3AgEFEnmKfoIWgRGDEoMbBBi?=
 =?us-ascii?q?ES4JXAosRhAh3j3IHAoZ8ijMYgVmFCwWKHyyNF4peMIE7VoEhTSOBAYI7E4IID?=
 =?us-ascii?q?BeDSopwITMBgQQBAYwMAQE?=
X-IPAS-Result: =?us-ascii?q?A0CBAADbh/lbh0O0hNFjEwEBCQEGBwaBVAYLAYJpgQIng3m?=
 =?us-ascii?q?De5IrFIl3jyQsCwgBiFoiNwYNAQMBAQEBAQECARMBAQEIDQkIKSMMgjYkgmMBA?=
 =?us-ascii?q?gMBAiAdARsdAQMCCQEBBQULDQICJgICAx8BEQEFARwZBYMcAYFoAQMVBQqbBjy?=
 =?us-ascii?q?LDYESBQEXgncFhDAKGScNWoE3AgEFEnmKfoIWgRGDEoMbBBiES4JXAosRhAh3j?=
 =?us-ascii?q?3IHAoZ8ijMYgVmFCwWKHyyNF4peMIE7VoEhTSOBAYI7E4IIDBeDSopwITMBgQQ?=
 =?us-ascii?q?BAYwMAQE?=
X-IronPort-AV: E=Sophos;i="5.56,273,1539673200"; 
   d="scan'208";a="63784226"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mga01b.intel.com with ESMTP; 24 Nov 2018 09:24:08 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1726390AbeKYEJx (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Sat, 24 Nov 2018 23:09:53 -0500
Received: from mail-ed1-f67.google.com ([209.85.208.67]:43490 "EHLO
        mail-ed1-f67.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1725880AbeKYEJx (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sat, 24 Nov 2018 23:09:53 -0500
Received: by mail-ed1-f67.google.com with SMTP id f4so12511331edq.10;
        Sat, 24 Nov 2018 09:20:59 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=mime-version:references:in-reply-to:from:date:message-id:subject:to
         :cc;
        bh=7yxJ1FEF1VkyZypHsW/pLv5gAAgZ8QcaOz5xRC5xtlU=;
        b=I3jfoGXEHZlnJCUPTg65wtIz+8bgcZOwrukipXkJaCjUJQsUcwEkGYvNl/P2BAxxCk
         z7ifmsqMRNLGCLeOOMGnr1izLdLTdPmgZ20+3uhSx1N8upvkwQoZZE3MropfTRtA0Z/Q
         66YeslrjsbGf8uBgUwpbDTOLrD3v2udlRirsQ7puyLkhilCeKb6eOo1wnx6+8ymInECB
         b8WxIIxS/8Ht7bkOs104unIypSGQK6uBPk8wIRItOXx1LjyW4Rk4EzrYsCci0jY8tHkw
         P+IZt6JVcRHqrSb/0/D52fBhJDotxEj0SX3+S/EnTetiwqYxP0Y549L1RCHeASUmIbwu
         hqHg==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:mime-version:references:in-reply-to:from:date
         :message-id:subject:to:cc;
        bh=7yxJ1FEF1VkyZypHsW/pLv5gAAgZ8QcaOz5xRC5xtlU=;
        b=lmjq6ZnoH/v4o2e/jqUgg7/hRdqh8f6/sXOan9TvzJs2SZf9pNm9CP3+2X0bhLfKkd
         48OKnnH14L+/gS24nyNm8TrXLDSJqL3Ug0/NrVMzQs/cZUE2ZOdy0nTtGPfWv41tZfN5
         /ohro3sSk7OzCceFZwIxYsw+7NJq1T8Ep5iYc9BK7APQBAJOW3Sg10xm7MHuBn31rXpv
         KOxErYUOm4GRLrO7KaFaNHsXzgh+u+nSHUtfGz8Gtz8NrE+Umypm3wVocD3OIPO5ZHvx
         5htegYKKkhbWRoDu5UdXstYjy7uL/uVM8lMJdZ0pyjYm8fw/D8GC3KBYov7EQDUfIoEa
         y/1Q==
X-Gm-Message-State: AA+aEWbauO1it49prMdtRWxoGZSIulBf9MfriidE92Z4Rr5MSwjkd1wR
        uLRu/dYTGj+7anFK8IzDZUtm29KXNFtIuk2FUpc=
X-Google-Smtp-Source: AFSGD/UGnzJ5ZgcArIzzYD0OrNd9djgboR8nlu4raZXc3J90fTftBNOGfA6wy0fX3n+EDrsuKRLEDwtBkRG/GsViFkw=
X-Received: by 2002:a50:ae8f:: with SMTP id e15mr17621641edd.250.1543080058809;
 Sat, 24 Nov 2018 09:20:58 -0800 (PST)
MIME-Version: 1.0
References: <00000000000085abf7057b44ad08@google.com>
In-Reply-To: <00000000000085abf7057b44ad08@google.com>
From: Willem de Bruijn <willemdebruijn.kernel@gmail.com>
Date: Sat, 24 Nov 2018 12:20:22 -0500
Message-ID: <CAF=yD-K0HwAbSK93b1aU0xjyepzoaiP2_qZ3L1nyEJAsbZqi-Q@mail.gmail.com>
Subject: Re: invalid opcode in ip_do_fragment
To: syzbot+865704dc4f7ff5d1a04b@syzkaller.appspotmail.com
Cc: David Miller <davem@davemloft.net>,
        Alexey Kuznetsov <kuznet@ms2.inr.ac.ru>,
        LKML <linux-kernel@vger.kernel.org>,
        Network Development <netdev@vger.kernel.org>,
        syzkaller-bugs@googlegroups.com,
        Hideaki YOSHIFUJI <yoshfuji@linux-ipv6.org>,
        Daniel Borkmann <daniel@iogearbox.net>,
        Alexei Starovoitov <ast@kernel.org>,
        John Fastabend <john.fastabend@gmail.com>
Content-Type: text/plain; charset="UTF-8"
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Sat, Nov 24, 2018 at 2:11 AM syzbot
<syzbot+865704dc4f7ff5d1a04b@syzkaller.appspotmail.com> wrote:
>
> Hello,
>
> syzbot found the following crash on:
>
> HEAD commit:    92b419289cee Merge tag 'riscv-for-linus-4.20-rc4' of git:/..
> git tree:       upstream
> console output: https://syzkaller.appspot.com/x/log.txt?x=12243093400000
> kernel config:  https://syzkaller.appspot.com/x/.config?x=73e2bc0cb6463446
> dashboard link: https://syzkaller.appspot.com/bug?extid=865704dc4f7ff5d1a04b
> compiler:       gcc (GCC) 8.0.1 20180413 (experimental)
>
> Unfortunately, I don't have any reproducer for this crash yet.
>
> IMPORTANT: if you fix the bug, please add the following tag to the commit:
> Reported-by: syzbot+865704dc4f7ff5d1a04b@syzkaller.appspotmail.com
>
> invalid opcode: 0000 [#1] PREEMPT SMP KASAN
> CPU: 0 PID: 21078 Comm: syz-executor1 Not tainted 4.20.0-rc3+ #344
> Hardware name: Google Google Compute Engine/Google Compute Engine, BIOS
> Google 01/01/2011
> RIP: 0010:ip_do_fragment+0x2447/0x2ad0 net/ipv4/ip_output.c:776
> Code: ff 48 89 cf e8 2a 36 23 fb e9 dc ea ff ff 48 89 df e8 5d 36 23 fb e9
> 02 e7 ff ff e8 b3 36 23 fb e9 97 e6 ff ff e8 29 e7 df fa <0f> 0b 4c 89 f7
> e8 ff 35 23 fb e9 2f e6 ff ff 4c 89 e7 e8 f2 35 23
> RSP: 0018:ffff88818232e7b8 EFLAGS: 00010246
> RAX: 0000000000040000 RBX: ffff8881d3af0800 RCX: ffffc9000c0db000
> RDX: 0000000000040000 RSI: ffffffff869fa3c7 RDI: 0000000000000005
> RBP: ffff88818232e990 R08: ffff88816ba06580 R09: ffffed10342f86ca
> R10: ffffed10342f86cc R11: ffff8881a17c3663 R12: ffff8881d3af08c4
> R13: 00000000fffffff2 R14: ffff8881d3af08d0 R15: dffffc0000000000
> FS:  00007fa003fcd700(0000) GS:ffff8881dae00000(0000) knlGS:0000000000000000
> CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
> CR2: 00000000004ccd10 CR3: 0000000199f89000 CR4: 00000000001426f0
> DR0: 0000000000000000 DR1: 0000000000000000 DR2: 0000000000000000
> DR3: 0000000000000000 DR6: 00000000fffe0ff0 DR7: 0000000000000400
> Call Trace:
>   ip_fragment.constprop.50+0x179/0x240 net/ipv4/ip_output.c:549
>   ip_finish_output+0x6b4/0xfa0 net/ipv4/ip_output.c:315
>   NF_HOOK_COND include/linux/netfilter.h:278 [inline]
>   ip_output+0x21d/0x8d0 net/ipv4/ip_output.c:405
>   dst_output include/net/dst.h:444 [inline]
>   ip_local_out+0xc5/0x1b0 net/ipv4/ip_output.c:124
>   iptunnel_xmit+0x63b/0x9c0 net/ipv4/ip_tunnel_core.c:91
>   ip_tunnel_xmit+0x15b8/0x3c04 net/ipv4/ip_tunnel.c:787
>   __gre_xmit+0x5e1/0x980 net/ipv4/ip_gre.c:451
>   ipgre_xmit+0x3e7/0xba0 net/ipv4/ip_gre.c:705
>   __netdev_start_xmit include/linux/netdevice.h:4356 [inline]
>   netdev_start_xmit include/linux/netdevice.h:4365 [inline]
>   xmit_one net/core/dev.c:3252 [inline]
>   dev_hard_start_xmit+0x295/0xc80 net/core/dev.c:3268
>   __dev_queue_xmit+0x2f71/0x3ad0 net/core/dev.c:3838
>   dev_queue_xmit+0x17/0x20 net/core/dev.c:3871
>   __bpf_tx_skb net/core/filter.c:2017 [inline]
>   __bpf_redirect_common net/core/filter.c:2055 [inline]
>   __bpf_redirect+0x5cf/0xb20 net/core/filter.c:2062
>   ____bpf_clone_redirect net/core/filter.c:2095 [inline]
>   bpf_clone_redirect+0x2f6/0x490 net/core/filter.c:2067
>   bpf_prog_bebbfe2050753572+0x7dd/0x1000

The syzbot dashboard has a longer trace, when looking at the log. This
includes a bpf program and probably bpf_prog_test_run.

ip_output.c +776 is a BUG at this commit

                /*
                 *      Copy a block of the IP datagram.
                 */
                if (skb_copy_bits(skb, ptr, skb_transport_header(skb2), len))
                        BUG();

Perhaps the BPF program managed to modify the packet in a way that
changed its length.

Either way, a bad packet in the egress path seems like a recoverable
bug that probably should not result in BUG().
