Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 25 Nov 2018 14:43:27 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga006.fm.intel.com (fmsmga006.fm.intel.com [10.253.24.20])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 426D1580478;
	Sat, 24 Nov 2018 20:25:56 -0800 (PST)
Received: from orsmga101.jf.intel.com ([10.7.208.22])
  by fmsmga006-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 24 Nov 2018 20:25:55 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AIJ3QqxT3JDOwMzvg8StqbTGmSNpsv+yvbD5Q0YIu?=
 =?us-ascii?q?jvd0So/mwa64YRCAt8tkgFKBZ4jH8fUM07OQ7/iwHzRYqb+681k6OKRWUBEEjc?=
 =?us-ascii?q?hE1ycBO+WiTXPBEfjxciYhF95DXlI2t1uyMExSBdqsLwaK+i764jEdAAjwOhRo?=
 =?us-ascii?q?LerpBIHSk9631+ev8JHPfglEnjWwba9xIRmssQndqtQdjJd/JKo21hbHuGZDdf?=
 =?us-ascii?q?5MxWNvK1KTnhL86dm18ZV+7SleuO8v+tBZX6nicKs2UbJXDDI9M2Ao/8LrrgXM?=
 =?us-ascii?q?TRGO5nQHTGoblAdDDhXf4xH7WpfxtTb6tvZ41SKHM8D6Uaw4VDK/5KpwVhTmlD?=
 =?us-ascii?q?kIOCI48GHPi8x/kqRboA66pxdix4LYeZyZOOZicq/Ye94RWGhPUdtLVyFZDYy8?=
 =?us-ascii?q?YYkAAeoPM+hbsofzuUcBoxSlBQm0Bu7i0SNIhmbs0KEmz+gtDQPL0Qo9FNwOqn?=
 =?us-ascii?q?TUq9D1Ob8SX+Cv1qbIyzbDZO5Q1zjj9ofDbxcsoe2NXbJ2ccvd00cuFwLDjlqN?=
 =?us-ascii?q?qI3kPiiY1usIs2eB7upgUfijhHIgqwF0uzWiwNonhIfOhoIQ0F/E9CN5zZ4pJd?=
 =?us-ascii?q?y2SU57fcKkH4VKty2AK4R2RcYiT3lsuCY7zL0Jo4S7fC8QxJQg3R7fZOSLc4aS?=
 =?us-ascii?q?7R3/SumeOjB4hHVmeL6lmxmy9k2gx+vhXce3yFZHtjRJnsXIu3wXyhDe5NaLRu?=
 =?us-ascii?q?Fg8kqixTqDzQHe5+NcLUwqiabWL4Qtz70wm5YJrEjOHy77lF/rgKKSd0gp/PWj?=
 =?us-ascii?q?5f79bbX8vJCcMpd5igHgPaQqncyyGfo4MgcQUGiB4+i816Ps/Vf/QLpUiv06iK?=
 =?us-ascii?q?7ZsIrVJcgDp665BRFa0po75hqhEzur1M4UkWQJIV5bYh6LkovkN03ULP35D/qz?=
 =?us-ascii?q?m1Gsny1qx/DCML3hGJLNLn3bnbflfLZ97VNcyQUqwdBc+Z1UELcBL+z3WkPos9?=
 =?us-ascii?q?zZABk5PBKuw+v8FtV92Z0RWXiVDq+aLqzSq1mI6fwrI+WWY48Vojn9J+A/5/Hy?=
 =?us-ascii?q?lX85hUMdfa6x0JsTaXC4HeppL1+WYHrxmdoBFWYKvgwjTO3lklGCUDhTZ2qsUK?=
 =?us-ascii?q?I4/D00FIWmDYLbTIC3nLOBxDu7HoFRZm1eClCDC3bod5meVPcLci6SItJhnSYC?=
 =?us-ascii?q?VbiuUIIh0RCutAnny7toNObU+ysYtY7929hx/eHciRYy9TlsBcSHz26NV310nn?=
 =?us-ascii?q?8PRzIu3qB/plJyxk2A0ah/hfxYE9tT6uhNUgc7M57c0uN7B8rzWgLHYteGVlKm?=
 =?us-ascii?q?Ts+6DjE2S9I728UObFplG9W+khDD2DKnDKUOl7yLA5w08bjQ32LrKMZ/0HvG0K?=
 =?us-ascii?q?ghj187QspAL2Gmh6h/9xTNCI7NiUmWi6GqdaEE1i7X6GiD1XaOvF1fUANoUqXK?=
 =?us-ascii?q?R3YfalHSrdT4/EzCSbCuBK8jMgtAz86CN6RLZsfojVVAWPfsJtDeb3itlGe3AB?=
 =?us-ascii?q?aC3qmMY5bye2UBwCXdD1AJnB0J8naYKwcyHCehrHjYDDx1C13vZUTg8e19qHO+?=
 =?us-ascii?q?Sk851AWKb0xn17qo9R8Zn/2cS/UP3r0avCctsSl7HFG439jOEdqPuxJhfLlAYd?=
 =?us-ascii?q?M6+FpIyHjWtxJjMZC6L6BtnFgecx9psEPozBh3DoRAkc43rHIl1gZyKKSY0E9f?=
 =?us-ascii?q?eDOcx5z/JrrXKmzq9hC1d6HWwk3e0MqR+qoX9PQ4qlDjvAa1Fkoi83RrycVV32?=
 =?us-ascii?q?Gb5pXQCAoSUJTxUkks+hh+prHaZDQ95ozO2X1tN6m0riHN29YzCOQ5zRages9V?=
 =?us-ascii?q?MLmYGw/qD80aG8+uJfQwlFitcB0FM/5d9a4uM8y9avuJxbSkPOBjnDKhk2RK+4?=
 =?us-ascii?q?R90kOK9yphRe/ExZcFw/eE3gSZUzfwlkuussfymYpcfzEdAnK/yTT4BI5WfqBz?=
 =?us-ascii?q?fZsLBX2yLMGtx9R+h4TiW3hX9FO4A1MG2cmpeQedblDn3A1Q01gXrmKjmSei0z?=
 =?us-ascii?q?N0lDQppLKF3CPS2+TiaAYHOmlTSWl4jFfjPZK7j8oHU0ivdQQpkgWq5Vz7x6RC?=
 =?us-ascii?q?uKtwNW3TTlpWcCjsKGFiVLC9tr6DY85J9ZMpvj9bUOW6YVCGVLH9pwEW3D/kH2?=
 =?us-ascii?q?tb3Do7bS2luo3lnxxmj2KQNHZyrHvDdcBw3xvf/8HcRfhK0zoCRSl4jyTXB1em?=
 =?us-ascii?q?M9mo+9WUi4nMsuSkW229UZ1TdDHhzZmcuyuj+W1qHRq/kuixmtL9Cwg60iz719?=
 =?us-ascii?q?5wWSXTthn8YYrr16W8Me15eEllH1v868t8GoFjnYo8npAQ2X4GhpqL+XoLi3v8?=
 =?us-ascii?q?MdJe2ajmdnoCWSYLw8LJ4AjiwEBiLmiGx4XjWnWfw8thYcK3YmcX2iI78sBLB7?=
 =?us-ascii?q?2Y7L1CnStpvFW4qRjdbuR6njcY0fEu8mIVg/kVuAoxySWQGrMSElNZPSD2lxSI?=
 =?us-ascii?q?8sqxrKNYZGu0dbiw1Ux+nc2uDb2YowFcXmr5dYkmHSNq8sp/N1fM2mXp6o74YN?=
 =?us-ascii?q?nQcc4TthqMnhfFjuhVK4g+muAEhCV5ImL9oWMqy/QgghNwx5G6s5OKK2Fs/KK/?=
 =?us-ascii?q?Hx5ZOSf5Z8IV+jHxk6lemtya0JyoHpVkAj8LRofnTeq0EDIOsvTqLxqOEDo5qn?=
 =?us-ascii?q?uBGLvQBwmf6Fp9r3LUEpCmLHWXJHgfzdV/SxiRPk1fgAYIXDokmp41DBylxMvk?=
 =?us-ascii?q?cE1h/DAe+kb4qgdQyuJvLxTwSX3QpACsajcpUpSfKAdW4xpG50fUN8ye8+1yEz?=
 =?us-ascii?q?tZ/p2nsAyCNGibax5UAmEOX0yOH0rjMaW25dnc7+iYAfKzL/nUbrWLt+NeTO2E?=
 =?us-ascii?q?xY613otl4jaMNdiPPn94AP0gwUdDWXF5G8LEmzQAUSAXliTNb9KFqxe44CF4ss?=
 =?us-ascii?q?e/8PHzUgL1+YSPE6dSMclo+x2ugaaDMPOQhD9kKTlC0JMA32TIyL8Z3F4dkCxu?=
 =?us-ascii?q?czitEbIdtS/CVq7Qm6lXDwIFZCN3LsdH86U83gxVM87Bltz1zqJ4juIyC1pdVV?=
 =?us-ascii?q?zuhMCpZc8JI2G8Ll/HB1yLNLOJJTLV2cH3fLi8RKZUjOVVsR2wpDmaH1XiPjSF?=
 =?us-ascii?q?iznmSRSvPftQgyGcORxUoJu9fQp1CWj/UNLmbQW2P8VqjTIt2707mHPLOXQYMT?=
 =?us-ascii?q?h9aE5NqryQ7SVFgvRwAWBB73xlLfWalCad9eXXNpEWsf5zCCRui+1a+Gg6y6dS?=
 =?us-ascii?q?7CxcWPx1mS7SosRyrF28juaPyiRoUBxVpzZPhYKLu1hiOKrD+plBX3bE4AwC7W?=
 =?us-ascii?q?GKBxsWoNtlD8Xlu7pMxdjXiKLzNDBC/srU/MQGAcjULcOHMHw5PhvoGD7bFg0F?=
 =?us-ascii?q?TTGwOGHbhkxdluyS93KPopg7rJjshIQBSrtBWFMpEfMaDxctINtXDJ5xXz4g2Z?=
 =?us-ascii?q?qWnsUB4332+BXYQsRXutbDW+CZCPPoADKYi7BeYF0P27yufqoJMYiu9VZrbFoy?=
 =?us-ascii?q?uInHUx7MXNZc5DJgaAMmsm1C9XF/Sis43EezOVDl22MaCfPhxk1+sQB5e+l4sW?=
 =?us-ascii?q?60u1o=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AmAABBI/pbh0O0hNFjHgEGBwaBUQkLA?=
 =?us-ascii?q?YFagQ+BAieDeYN7kBxSBoE1AhKJBo4igXMsBwwBgUuCdYQaIjQJDQEDAQEBAQE?=
 =?us-ascii?q?BAgETAQEBCA0JCCkjDII2JAGCYgECAwECIB0BGx0BAwIJAQEFBQsNAgImAgIDH?=
 =?us-ascii?q?gEBEQEFARwGEwUEgk1LAYFoAQMIDQUKmT48iw2BCQkFAReCdwWELAoZJw1agTc?=
 =?us-ascii?q?CBhJ5in6BD4EHhCOCVjoLAgKBX4MEglcCh1CBSYZ2T452LgcChhthhwiDKxiBW?=
 =?us-ascii?q?U2HYYcBLI0XgQqJVDCBJYINMxojgQGCOwmCEgwXg0qFFIVLMjOBBQEBjF4BAQ?=
X-IPAS-Result: =?us-ascii?q?A0AmAABBI/pbh0O0hNFjHgEGBwaBUQkLAYFagQ+BAieDeYN?=
 =?us-ascii?q?7kBxSBoE1AhKJBo4igXMsBwwBgUuCdYQaIjQJDQEDAQEBAQEBAgETAQEBCA0JC?=
 =?us-ascii?q?CkjDII2JAGCYgECAwECIB0BGx0BAwIJAQEFBQsNAgImAgIDHgEBEQEFARwGEwU?=
 =?us-ascii?q?Egk1LAYFoAQMIDQUKmT48iw2BCQkFAReCdwWELAoZJw1agTcCBhJ5in6BD4EHh?=
 =?us-ascii?q?COCVjoLAgKBX4MEglcCh1CBSYZ2T452LgcChhthhwiDKxiBWU2HYYcBLI0XgQq?=
 =?us-ascii?q?JVDCBJYINMxojgQGCOwmCEgwXg0qFFIVLMjOBBQEBjF4BAQ?=
X-IronPort-AV: E=Sophos;i="5.56,276,1539673200"; 
   d="scan'208";a="42113878"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 24 Nov 2018 20:25:53 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727182AbeKYPPw (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Sun, 25 Nov 2018 10:15:52 -0500
Received: from mail-it1-f196.google.com ([209.85.166.196]:36873 "EHLO
        mail-it1-f196.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1726632AbeKYPPv (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sun, 25 Nov 2018 10:15:51 -0500
Received: by mail-it1-f196.google.com with SMTP id b5so22822265iti.2
        for <linux-kernel@vger.kernel.org>; Sat, 24 Nov 2018 20:25:42 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=mime-version:references:in-reply-to:from:date:message-id:subject:to
         :cc:content-transfer-encoding;
        bh=fxXrpp+yc0FG1OiTCtn6SzOotBaCFMqh0aS8DWag1Ao=;
        b=kFhWyV56pwpPQg29uIADxvbU6pWWQUJGsbG3JOSZsDEYVzGwKueJH+dEbatPzFg5YE
         VTiC6GNeZ0gkNqXQvYzpeaaET6nG8BKIxGX/IPSy1sK/NTXjqSVpFP1E962HBBKHgbpd
         gYtJPnWkvb6L/+uJfeQ/wFA5mDKVUkqTD3C00CGvA6Q5w88UMmQCXUUR2fnXWRquFkgO
         mWl5HmLJEb1qzRSsIgDon/AFXwpKORn5hfKPoI44z+5IRptIQB9YgVFFrzwIEkAISQfo
         ICxuvYDS8/CTK8jySlTkIZHrywvpEEgDhO2kwAYoFquaits0UhFX7a/pduQhJp4j5yFR
         XaPA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:mime-version:references:in-reply-to:from:date
         :message-id:subject:to:cc:content-transfer-encoding;
        bh=fxXrpp+yc0FG1OiTCtn6SzOotBaCFMqh0aS8DWag1Ao=;
        b=UExLXTA8GPAbt5FmD6CZnydOv0BNHP3BjVHYilEdBrqacqc4I7wEBqgnInC2Go/9I5
         0Nfrb6TPij22wwQsSPZMZwp+Lhsi9DyJcRHQkfnF8ZE523YA/Lw3WyYgC/eaOkhSWfGF
         mu0ARgYmuuj1VdWWgpbSmt52Q4ukU+ovWGwjRsbdB2sHEF4JJ3f4oSlccoIfepdLOj2U
         mW3QHw9R2t6uWVGUkcdnW2A4r8flTiXKt09bxtfHBGIjsQ6dN0wLK8uSKQNd7td8yq1q
         4LrPU8rWf0ZAXXbSA9zHMlsEMnq3/Mvmyjj6jrixfXqWJvjuqXDjKUDnhOriayNSMl9/
         DnMA==
X-Gm-Message-State: AGRZ1gLI5ubuwpYrV9cqfdj+Jx1S5LPZdd9ujfpGUIDbp8+bzkqIgU5r
        IjMIrVSyUXQQFKmC7HQzFPEQXUoQNJZ2ZZDhnizoKGkj3s0=
X-Google-Smtp-Source: AFSGD/XMVkjYJFHaitvF57TxsabADevw8sY6RjtXr0xm0I580GMl8JaRNLb8Y6gIWkjfM31tRc+HP0yLgRzWDdoOiNc=
X-Received: by 2002:a24:648f:: with SMTP id t137mr18054741itc.95.1543119941672;
 Sat, 24 Nov 2018 20:25:41 -0800 (PST)
MIME-Version: 1.0
References: <20181122152331.25739-1-tiny.windzz@gmail.com> <CAEExFWt45G5hyAEZvaAW--ZANnTqmi7-i473jRfFLD0Wacp6-w@mail.gmail.com>
 <97b95b60-8420-bad9-4d2c-6baee749b90f@linaro.org>
In-Reply-To: <97b95b60-8420-bad9-4d2c-6baee749b90f@linaro.org>
From: Frank Lee <tiny.windzz@gmail.com>
Date: Sun, 25 Nov 2018 12:25:19 +0800
Message-ID: <CAEExFWsdEQCC--E5o5uKuT6nNK_TeqmVu-F1g7Bv_+FO7OkjjQ@mail.gmail.com>
Subject: Re: [PATCH] clocksource/drivers/integrator-ap: add missing of_node_put()
To: Daniel Lezcano <daniel.lezcano@linaro.org>
Cc: tglx@linutronix.de, linux-kernel@vger.kernel.org
Content-Type: text/plain; charset="UTF-8"
Content-Transfer-Encoding: quoted-printable
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Sun, Nov 25, 2018 at 3:49 AM Daniel Lezcano
<daniel.lezcano@linaro.org> wrote:
>
> On 24/11/2018 15:58, Frank Lee wrote:
> > On Thu, Nov 22, 2018 at 11:23 PM Yangtao Li <tiny.windzz@gmail.com> wro=
te:
> >>
> >> of_find_node_by_path() acquires a reference to the node
> >> returned by it and that reference needs to be dropped by its caller.
> >> integrator_ap_timer_init_of() doesn't do that, so fix it.
> >>
> >> Signed-off-by: Yangtao Li <tiny.windzz@gmail.com>
> >> ---
> >>  drivers/clocksource/timer-integrator-ap.c | 20 ++++++++++++++------
> >>  1 file changed, 14 insertions(+), 6 deletions(-)
> >>
> >> diff --git a/drivers/clocksource/timer-integrator-ap.c b/drivers/clock=
source/timer-integrator-ap.c
> >> index 76e526f58620..1f04069470bb 100644
> >> --- a/drivers/clocksource/timer-integrator-ap.c
> >> +++ b/drivers/clocksource/timer-integrator-ap.c
> >> @@ -177,7 +177,7 @@ static int __init integrator_ap_timer_init_of(stru=
ct device_node *node)
> >>  {
> >>         const char *path;
> >>         void __iomem *base;
> >> -       int err;
> >> +       int err,rc =3D 0;
> >>         int irq;
> >>         struct clk *clk;
> >>         unsigned long rate;
> >> @@ -210,26 +210,34 @@ static int __init integrator_ap_timer_init_of(st=
ruct device_node *node)
> >>                                 "arm,timer-secondary", &path);
> >>         if (err) {
> >>                 pr_warn("Failed to read property\n");
> >> -               return err;
> >> +               rc =3D err;
> >> +               goto out_put_pri_node;
> >>         }
> >>
> >>
> >>         sec_node =3D of_find_node_by_path(path);
> >>
> >> -       if (node =3D=3D pri_node)
> >> +       if (node =3D=3D pri_node){
> >>                 /* The primary timer lacks IRQ, use as clocksource */
> >> -               return integrator_clocksource_init(rate, base);
> >> +               rc =3D integrator_clocksource_init(rate, base);
> >> +               goto out;
> >> +       }
> >>
> >>         if (node =3D=3D sec_node) {
> >>                 /* The secondary timer will drive the clock event */
> >>                 irq =3D irq_of_parse_and_map(node, 0);
> >> -               return integrator_clockevent_init(rate, base, irq);
> >> +               rc =3D integrator_clockevent_init(rate, base, irq);
> >> +               goto out;
> >>         }
> >>
> >>         pr_info("Timer @%p unused\n", base);
> >>         clk_disable_unprepare(clk);
> >> +out:
> >> +       of_node_put(sec_node);
> >> +out_put_pri_node:
> >> +       of_node_put(pri_node);
> >>
> >> -       return 0;
> >> +       return rc;
> >>  }
> >>
> >>  TIMER_OF_DECLARE(integrator_ap_timer, "arm,integrator-timer",
> >> --
> >> 2.17.0
> >>
> > Hi Daniel=EF=BC=9A
> >
> > How about this?
>
> Hi,
>
> I think there is a simpler fix. The pri_node and the sec_node are used
> as an identifier to compare against the current node, we can directly
> drop the refcount after getting the node from path as it is not used as
> pointer. In addition, a single variable is needed, so we end up with a
> fix like that.
>
>         alias_node =3D of_find_node_by_path(path);
>         of_node_put(alias_node);
>         if (node =3D=3D alias_node)
>                 return integrator_clocksource_init(rate, base);

Daniel,

OK,I will simplify it like you said.Although I think of_node_put
should be called
after we don't use node.

MBR=EF=BC=8C
Yangtao
>
>
>
> >
> > Thanks=EF=BC=8C
> > Yangtao
> >
>
>
> --
>  <http://www.linaro.org/> Linaro.org =E2=94=82 Open source software for A=
RM SoCs
>
> Follow Linaro:  <http://www.facebook.com/pages/Linaro> Facebook |
> <http://twitter.com/#!/linaroorg> Twitter |
> <http://www.linaro.org/linaro-blog/> Blog
>
