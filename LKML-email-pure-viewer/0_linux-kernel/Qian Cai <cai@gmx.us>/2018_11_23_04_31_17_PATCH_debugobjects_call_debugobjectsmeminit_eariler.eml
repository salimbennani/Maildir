Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 13:08:05 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga002.jf.intel.com (orsmga002.jf.intel.com [10.7.209.21])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 9A1FE58040F;
	Thu, 22 Nov 2018 20:33:28 -0800 (PST)
Received: from orsmga101.jf.intel.com ([10.7.208.22])
  by orsmga002-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 22 Nov 2018 20:33:28 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AyapGDhPG7WclWcdJx8ol6mtUPXoX/o7sNwtQ0KIM?=
 =?us-ascii?q?zox0KP/8rsbcNUDSrc9gkEXOFd2Cra4c26yO6+jJYi8p2d65qncMcZhBBVcuqP?=
 =?us-ascii?q?49uEgeOvODElDxN/XwbiY3T4xoXV5h+GynYwAOQJ6tL1LdrWev4jEMBx7xKRR6?=
 =?us-ascii?q?JvjvGo7Vks+7y/2+94fcbglUhzexe69+IAmrpgjNq8cahpdvJLwswRXTuHtIfO?=
 =?us-ascii?q?pWxWJsJV2Nmhv3+9m98p1+/SlOovwt78FPX7n0cKQ+VrxYES8pM3sp683xtBnM?=
 =?us-ascii?q?VhWA630BWWgLiBVIAgzF7BbnXpfttybxq+Rw1DWGMcDwULs5Xymp4aV2Rx/ykC?=
 =?us-ascii?q?oJNyA3/nzZhMJzi6xUohyhpwdnw4PWe4yZKOZyc7nBcd4AWWZNQsBcXDFBDIOm?=
 =?us-ascii?q?aIsPCvIMM/1Zr4bnoVsFsAWzChOtBOjyzTJHmmX53awh3uQuFAHH0xYsH88VsH?=
 =?us-ascii?q?nNqtj+KaQcUfitwaXW0TnOa+la1Srz5YTWaBwtvPKBUa5qfcfQy0QjDwfIg1aK?=
 =?us-ascii?q?pYD4Ij+Y1f4Bv3aY4uZ6SO6jl2AqpgdsqTa13MgskJPGhocNx1DE6yp5xIE1KM?=
 =?us-ascii?q?WmSE50f9GkCoFctyKEOItsRMMtXWVotDw9yr0ctp63ZCkKyJI5yB7Dc/GLbZSE?=
 =?us-ascii?q?7xb5WOqMLzp0mmhpdK+8ihqu60Sty+/xWtGx0FlQrypFltfMtmoK1xzW8sWHTv?=
 =?us-ascii?q?p9/kG82TeAzgzT6f9LIVoylaXFL54t27kwl5QVsUvdBC/7g1v2jKCIeUU+4OSo?=
 =?us-ascii?q?6ProYq/gppCCM494kAb+Mr4hmsCnG+Q3LhAOX3SH+eS7zLDj+Uz5QLZUgfEsna?=
 =?us-ascii?q?jZrYvXJcAapq6/Hg9U3Zwv6xe5Dze6ztsYmWMLI05CeBKCl4LpIU3BIOjkDfej?=
 =?us-ascii?q?hFShiDdryOrHPr39GJrNKWLPkLf8fbln7U5cxxE+zdRe55JSF7EAL+j/Wk73tN?=
 =?us-ascii?q?zEEBA5Nxa4zPrgCNV4zokeQ36AAreFMKPOtl+F/uAvI+6Sa4MPuzb9LP4l5/jp?=
 =?us-ascii?q?jXIinV8dfK+p3YYYaXyiH/RmJVmZbmTogtsbDWgKuQ8+RvTwiFKeST5Te2qyX6?=
 =?us-ascii?q?Uk6z4hE4KmDYDDRoO3jLybxii7HIZbZmRHClCKDHfpeJ+IW/YKaCKOPMBhliYI?=
 =?us-ascii?q?WqSmS48kzRuurhP1y6J7LurI/S0VrZHj28Jz5+HJkREy9CZ7D8KS02yWS2F0n2?=
 =?us-ascii?q?UIRyI53axloEx9zEuD3rZ8g/BCCdNT4PZJWB8gNZHA1+x6F8zyWgXZc9iUUlmm?=
 =?us-ascii?q?XMupDSsxTt0rxd8OeFhyG9OlghDH3CqqBrsVmqePBJw19KLcwnfwK9x8y3bAyK?=
 =?us-ascii?q?kukV0mTtFTOm2hg6517xLTCJLRk0WFi6aqcrwR0zPX+2ed02WCpkFYXxR2UaXe?=
 =?us-ascii?q?Q38fYFDbrdD45kPEUr+vBq4rMgpHyc6eNKRKbsflgklBRPfmIN7eeX6+m3+sBR?=
 =?us-ascii?q?aUwbOBdJbqe2QY3CXaFEgEkwAS8WyaNQQkASehuWbeDD1oFVLgeE7s9eh+qHWm?=
 =?us-ascii?q?Tk471Q2Kbkth16ar9R4Rn/CTV/QT3rccsic7tzp0BEq9387RC9eYvQVheLtTYN?=
 =?us-ascii?q?wj71ZHz27WrBF9MYG6IKBkhV4edBp3sljq1xV2DIVAjMcroGkrzAp0NaKXzldB?=
 =?us-ascii?q?eymE0pD3P73dMnPy8wy3a67KxlHe186b+6cS6Pgit1rvpgCoFko4/HVh3NlYyH?=
 =?us-ascii?q?+c5pTMDAoPXpP9SEc39x5mp77EZikx/Z/b1XppMaOsqD/Nx8opBPc5yhanZ9pf?=
 =?us-ascii?q?KqKEGxPoHM0AGseuL/Ymm163YRIePeBe7bI7MNmid/SbxqGrJuFgnDS9gGRD4Y?=
 =?us-ascii?q?B91F+M9iVmRu7J2ZYF3++X3g+dWzjgi1eht9j9mZpYajEKAmq/1S/kCZZRZ61z?=
 =?us-ascii?q?Z4oKCX2iI9aqxtV4nJPtX39Y9Fi+B1IJwsOpeBySb0Dj0g1Uz0gYvXunmS6gxT?=
 =?us-ascii?q?xujz4ptraf3DDJw+n6dhoIIHRLRGphjVfrO4S0lMoVXEurbwgokhuq+0D6yrNf?=
 =?us-ascii?q?pKR+KWnTXEhJczL3L2FkTqu/qL6Cb9RT55MvtCVdSP68bkyCSr7hvxsa1DvuHm?=
 =?us-ascii?q?tEyzA8bT2quJT5nxphhWKZLXZzqmfZeM5qyRfe4tzcWeBe3j4cSCZkjjnXA0C2?=
 =?us-ascii?q?P8O18tWMi5fDrue+WnqiVpJJcCnn14OAtDah6m1sDh2yhPSzmtzhEQgn3i73zd?=
 =?us-ascii?q?hqVSPUrBniZonnzbi1MeVifkNwHl/z99J6Gp1ikos3nJwQ3HkahpaP8nYdn2b8?=
 =?us-ascii?q?L85b2b7gY3oXXjEE3cTV4Af+1U1nL3KJwZ/5V3qHzstgYdm6fn0Z2iYn489WD6?=
 =?us-ascii?q?eU6aROnTFprVqgsQLRff99ky8Byfsp7X4WmeAItxArziWAGbASBkhYMDfolxSJ?=
 =?us-ascii?q?6dC+sapWaHyucbi2yEpxg9ShAKuerQFbXXbzYo0iEjNo7sVjLFLM12X+5Zr+d9?=
 =?us-ascii?q?nXadITqweYkxPdj+VOLJIxl/wKhTdoOG7nvH0lzfI7ggJq3Z2goIeHLGBt9rqj?=
 =?us-ascii?q?AhFELj31e98T+jb1gKZchMmW2p6gHo57FjUXRpfoTu+oEDEPtfThLQmOCyYxqn?=
 =?us-ascii?q?OaGbrZAA+e511qr3PJE5C3KX6XIGMVwsllRBmYPEZfmhwbXC0mnp4lEQCn3Mzg?=
 =?us-ascii?q?cEBk5jAI+173sB1MxvhzNxn4VGffqxylajM1SJiZMRpX4RtO50bTMcyC8O1zGz?=
 =?us-ascii?q?tU8YGmrAyIMmabfRhHDXkVWkyYAFDuJrmu6sfB8+ibBeq+LuHCYbaUqexZWPeH?=
 =?us-ascii?q?24iv0pZ9/zuXMsWPP39iD+A020ZZXHB5HdjZlCsLSyANiy3NaMubrg+m+iJrts?=
 =?us-ascii?q?C/7OjrWAX36ISVFrtdKs9v9A62gKuZM+6QhT10KTJZ1pMK2H/Jx6IT3F8UiyFy?=
 =?us-ascii?q?aTatFa4MujLKTKLVgqVXFQIUaztvNMtU6KIxxhVNOc/eit/vyrF0lOI6C1dbWl?=
 =?us-ascii?q?zngcypYc0KI2egNFLIHkqLNbKGJSHVzMHze6+zVbpQjOBMvR2qpTmbC1PjPiiE?=
 =?us-ascii?q?lzTxVxGgK+dMjCSaPBxYoI68cxZtBnLlTNLpcRC7NN53jTsrwbw7nH/KNGgcMS?=
 =?us-ascii?q?RifENJtLGf8SRYgvAsU1BGu3NmNeysnyef8vmdJJELt/diHiVzkaRd+nt+g6da?=
 =?us-ascii?q?6DFsQP1zhTfIqdhvsxeqn7qh0D1iBSNPozADr4uK9RFpMKTx+ZxQH2vfqkFepV?=
 =?us-ascii?q?6MAggH8oM2QubkvLpdn4DC?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0A1AgBegvdbh0O0hNFiHgEGBwaBZYFbg?=
 =?us-ascii?q?hEnmjGJCIkohmosEwGIUiI4EgEDAQEBAQEBAgETAQEBCA0JCCkvgjYigmUDAwE?=
 =?us-ascii?q?CJFIGCQEBUANUBxIFgxyBaQEDFQQBnCmMCTOHKAGCcIdehCsXgX+GeYgDAolRh?=
 =?us-ascii?q?j+PHVUJgSmPeyORBwEsmWGBdjMaCC0DgyeCJxd/AQ6NLCIygQUBAYxVAQE?=
X-IPAS-Result: =?us-ascii?q?A0A1AgBegvdbh0O0hNFiHgEGBwaBZYFbghEnmjGJCIkohmo?=
 =?us-ascii?q?sEwGIUiI4EgEDAQEBAQEBAgETAQEBCA0JCCkvgjYigmUDAwECJFIGCQEBUANUB?=
 =?us-ascii?q?xIFgxyBaQEDFQQBnCmMCTOHKAGCcIdehCsXgX+GeYgDAolRhj+PHVUJgSmPeyO?=
 =?us-ascii?q?RBwEsmWGBdjMaCC0DgyeCJxd/AQ6NLCIygQUBAYxVAQE?=
X-IronPort-AV: E=Sophos;i="5.56,268,1539673200"; 
   d="scan'208";a="41946394"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 22 Nov 2018 20:33:27 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2408109AbeKWPPr (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Fri, 23 Nov 2018 10:15:47 -0500
Received: from mout.gmx.net ([212.227.17.20]:34241 "EHLO mout.gmx.net"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S2408098AbeKWPPr (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 23 Nov 2018 10:15:47 -0500
Received: from ovpn-120-115.rdu2.redhat.com ([98.118.28.103]) by mail.gmx.com
 (mrgmx103 [212.227.17.174]) with ESMTPSA (Nemesis) id
 0Le69A-1fegAs15qO-00ps1s; Fri, 23 Nov 2018 05:32:06 +0100
From: Qian Cai <cai@gmx.us>
To: akpm@linux-foundation.org, tglx@linutronix.de
Cc: longman@redhat.com, yang.shi@linux.alibaba.com, arnd@arndb.de,
        linux-kernel@vger.kernel.org, Qian Cai <cai@gmx.us>
Subject: [PATCH] debugobjects: call debug_objects_mem_init eariler
Date: Thu, 22 Nov 2018 23:31:17 -0500
Message-Id: <20181123043117.992-1-cai@gmx.us>
X-Mailer: git-send-email 2.17.2 (Apple Git-113)
In-Reply-To: <alpine.DEB.2.21.1811222238270.1665@nanos.tec.linutronix.de>
References: <alpine.DEB.2.21.1811222238270.1665@nanos.tec.linutronix.de>
X-Provags-ID: V03:K1:97D6UMF4SK1zOYYcu1s5MuZmo99JJhw17VJKV1+S5Lqbo4X1dcB
 O7xfVNnQ9/v9nzZjZE9jB9Unkwxaa6Z96szUtOvQSvix1nDUrzp9yxTenwAjM/cqvgL1MME
 w7aPcYu5OG0WgWqYImToC4Fe5Sh6FOigriI6L6ac9ov0PBcSNUmLlL107gsoNynf5du/Wfv
 uaGHVcfoDGPdVU1PN2S6w==
X-Spam-Flag: NO
X-UI-Out-Filterresults: notjunk:1;V03:K0:9ua/C7gP87Q=:4a6Pd3gYSS4rckr6POZkQU
 cmpw6XGO6q7wzzsmscHT7vcrkrZjFcSBruYUdtG+X7amXyq25QCOJWGEqCusBTq2XNquZ8k2T
 Hdyu1Kv67o6I3Ki7dcuQAIOQro9xlV2SsQaIpddxEKyXgqPj+xmJ+VzOspF3XujE/w9nZ1Do/
 cLJLWkU0ZFGjwvhmWEM/XbOOtfcWxOXlFLMW0+D/qeqhRtFcE4joAa/Z8Xj0KuNfxW+mZP0z0
 lSxoRzRNvPg53E+7T2uSA2S6JY633uAOW2HwqsxmMhvSFWlCfKVqxgdrVtlaaI4ccLJnj4T/M
 4aYx0pyxj4xOMb8FhRFdpaWJLgUzehdC7GjrBs50hvJ/PRNgdsw9UpSHNkTsrPLSs19pZbjKl
 O63niBpCm6rRf5SCOPUs0GPrXSXx5l1eOAijIh0V+lksyy6SAtRGHntgds526UTohQkoKBbpm
 n5gxttZmfe9Qa/Xbt69XGTF+RpRfvdTUlOJiRsxoXk/AhKBgk3rnELNbDk1jBK8HLhpf50/r2
 CBhTzTPwov2B9ZXtXK9fRVduGVq78MarD17b51O/NkOPel+grKWJnyisaDMc1+ZIc+igMHH1k
 EdY+irGoZmlZpDcdMixo08pBVgea0vzAW6sWXwu/hfJOPqxjEpClGddu60L5P9vj78K15+fPr
 l7IImnosfhNsCPX4nhQ9Evq/qn6y3dBi181fRuih3rRSaWhoXbArG8X5zlCnT/zt9UoX5KmNt
 rxBLINg1H5+13Az2kF2xIBaeaTmvpD/UXpydRBoI+DQIGC4mbT7y2rafH0pkVlhAagFH0iQHZ
 0kpJZQ15dDyfusbRLkSBZ3rDQqR4xHMKMidH+PWqsbA2tdLnMZZVTDguN+ctLq2Y23iUHPR0Y
 E2r10LvolDdKdpFROPkpDaw76YbBhwEPmHuu21DsU=
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

The current value of the early boot static pool size, 1024 is not big
enough for systems with large number of CPUs with timer or/and workqueue
objects selected. As the results, systems have 60+ CPUs with both timer
and workqueue objects enabled could trigger "ODEBUG: Out of memory.
ODEBUG disabled".

Some debug objects are allocated during the early boot. Enabling some
options like timers or workqueue objects may increase the size required
significantly with large number of CPUs. For example,

CONFIG_DEBUG_OBJECTS_TIMERS:
No. CPUs x 2 (worker pool) objects:
start_kernel
  workqueue_init_early
    init_worker_pool
      init_timer_key
        debug_object_init

No. CPUs objects (CONFIG_HIGH_RES_TIMERS):
sched_init
  hrtick_rq_init
    hrtimer_init

CONFIG_DEBUG_OBJECTS_WORK:
No. CPUs x 6 (workqueue) objects:
workqueue_init_early
  alloc_workqueue
    __alloc_workqueue_key
      alloc_and_link_pwqs
        init_pwq

Also, plus No. CPUs objects:
perf_event_init
  __init_srcu_struct
    init_srcu_struct_fields
      init_srcu_struct_nodes
        __init_work

However, none of the things are actually used or required beofre
debug_objects_mem_init() is invoked.

According to tglx,
"the reason why the call is at this place in start_kernel() is
historical. It's because back in the days when debugobjects were added
the memory allocator was enabled way later than today. So we can just
move the debug_objects_mem_init() call right before sched_init()."

Afterwards, when calling debug_objects_mem_init(), interrupts have
already been disabled and lockdep_init() will only be called later, so
no need to worry about interrupts in
debug_objects_replace_static_objects().

Suggested-by: Thomas Gleixner <tglx@linutronix.de>
Signed-off-by: Qian Cai <cai@gmx.us>
---
 init/main.c        | 3 ++-
 lib/debugobjects.c | 8 --------
 2 files changed, 2 insertions(+), 9 deletions(-)

diff --git a/init/main.c b/init/main.c
index ee147103ba1b..f2c35dc50851 100644
--- a/init/main.c
+++ b/init/main.c
@@ -600,6 +600,8 @@ asmlinkage __visible void __init start_kernel(void)
 	/* trace_printk can be enabled here */
 	early_trace_init();
 
+	debug_objects_mem_init();
+
 	/*
 	 * Set up the scheduler prior starting any interrupts (such as the
 	 * timer interrupt). Full topology setup happens at smp_init()
@@ -697,7 +699,6 @@ asmlinkage __visible void __init start_kernel(void)
 #endif
 	page_ext_init();
 	kmemleak_init();
-	debug_objects_mem_init();
 	setup_per_cpu_pageset();
 	numa_policy_init();
 	acpi_early_init();
diff --git a/lib/debugobjects.c b/lib/debugobjects.c
index 70935ed91125..cc5818ced652 100644
--- a/lib/debugobjects.c
+++ b/lib/debugobjects.c
@@ -1132,13 +1132,6 @@ static int __init debug_objects_replace_static_objects(void)
 		hlist_add_head(&obj->node, &objects);
 	}
 
-	/*
-	 * When debug_objects_mem_init() is called we know that only
-	 * one CPU is up, so disabling interrupts is enough
-	 * protection. This avoids the lockdep hell of lock ordering.
-	 */
-	local_irq_disable();
-
 	/* Remove the statically allocated objects from the pool */
 	hlist_for_each_entry_safe(obj, tmp, &obj_pool, node)
 		hlist_del(&obj->node);
@@ -1158,7 +1151,6 @@ static int __init debug_objects_replace_static_objects(void)
 			cnt++;
 		}
 	}
-	local_irq_enable();
 
 	pr_debug("%d of %d active objects replaced\n",
 		 cnt, obj_pool_used);
-- 
2.17.2 (Apple Git-113)

