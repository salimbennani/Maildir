Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 26 Nov 2018 08:51:49 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga007.jf.intel.com (orsmga007.jf.intel.com [10.7.209.58])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 287F75803C2;
	Sun, 25 Nov 2018 12:48:36 -0800 (PST)
Received: from fmsmga105.fm.intel.com ([10.1.193.10])
  by orsmga007-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 25 Nov 2018 12:48:35 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AVcxFBh26MHNG/O7EsmDT+DRfVm0co7zxezQtwd8Z?=
 =?us-ascii?q?segVLfrxwZ3uMQTl6Ol3ixeRBMOHs6IC07KempujcFRI2YyGvnEGfc4EfD4+ou?=
 =?us-ascii?q?JSoTYdBtWYA1bwNv/gYn9yNs1DUFh44yPzahANS47xaFLIv3K98yMZFAnhOgpp?=
 =?us-ascii?q?POT1HZPZg9iq2+yo9JDffwZFiCChbb9uMR67sRjfus4KjIV4N60/0AHJonxGe+?=
 =?us-ascii?q?RXwWNnO1eelAvi68mz4ZBu7T1et+ou+MBcX6r6eb84TaFDAzQ9L281/szrugLd?=
 =?us-ascii?q?QgaJ+3ART38ZkhtMAwjC8RH6QpL8uTb0u+ZhxCWXO9D9QLYpUjqg8qhrUgflhj?=
 =?us-ascii?q?oZOT438G/ZicJ+g6xUrx2juxNxzJXUYJmXOfdlYqPQf8kXSXZdUstfVSFMBJ63?=
 =?us-ascii?q?YYsVD+oGOOZVt5Lzp1oUohu4GAKhGvngyj5VjXLxwaI1yeUhHBrJ3AwlENMCqm?=
 =?us-ascii?q?nUrM7sOaoUTOu7z7HIwC3dY/9K3Trx8pXEfx4/rf2WQL59ctbdxVMuGg7Hllmd?=
 =?us-ascii?q?rY/oMymI2ugQsGWX9fRsWOG1h2I6tw18rD6izdo2hIbTnIIa0FXE+D15wIkrId?=
 =?us-ascii?q?24T1Z2YcCrEJROrSGWLYh2Td04Q2Fupik6zqcKuZmhfCgF0JgnxhjfZOKbc4WQ?=
 =?us-ascii?q?/B7vSOKcLS1liH9rZr6znQu+/Eu8xuHmV8S50k5Gri9fndnNsnAN2QbT6s+CSv?=
 =?us-ascii?q?Zl+keh2DCP1x3c6+1dIkA7i7DbK5g/zb40j5YTtkrCHinol0Xsl6KWaEok9fay?=
 =?us-ascii?q?6+j9YbXpuIWcN4lqhQH6KKgunda/AesgPggUQ2eb4fi81KHk/UDhRLVKj/42nb?=
 =?us-ascii?q?fDvJHVOMQWvaq5Aw5T0oY+5BezFTam0NIEnXYZKFJJYg6Ij4/sO1vWOvD3Ee+/?=
 =?us-ascii?q?g0iwkDds3/3GPqfuApTRLnfZl7ftZ7Z961NGxwo1wtBS/JZUCrAHIPLuVU79rt?=
 =?us-ascii?q?3YDhklMwOqx+brEsly1oQbWWiXGK+WLLvSsUOU5uIoO+SMZogVtyjnJ/gm4P7u?=
 =?us-ascii?q?i3k5mVgGcKmt3JsXbm24H/t8L0WYZ3rsnskOEWMQsgUiS+zqjUWIUSRPaHaqQ6?=
 =?us-ascii?q?I8+jY7BZq8AofYRoCth7+B0D2hHpJMZGBLEVSMEXbud4WZVPYAciOSIsl9kjMa?=
 =?us-ascii?q?UbitUZMu1RartAXi0bpoMvLU+jEEtZLkzNV15PfclRco+TxwDsSSyWeNT25vk2?=
 =?us-ascii?q?MMRj822r1/oENnxleC16h4n+JXFdhJ6/xVVQc6MIbWz/ZmBNDqRgLBYtCJRU67?=
 =?us-ascii?q?Tdq8HzE+UMg9w98UbEZ7ANWtkBbD0y2uA78WkryLAIc58qbd33j3OsZ8xGzK1K?=
 =?us-ascii?q?gnj1k6XMRPMXeqibJ49wjWH4TJiVmWl762daQA2y7A7HqMwnCQvE5GSgJwUb/K?=
 =?us-ascii?q?XXYEZkTIq9T0/UfCT76oCbQ6PQpN08+CKq1WatL3iVVKXuvsONPbY2ipgWe/GQ?=
 =?us-ascii?q?6Ixq+QbIrtY2gdwCTdCE0DkwAP/XaHNRIyBju7r2LZFjxuEVPvY0Xj8eRlrHO7?=
 =?us-ascii?q?T0k0zxyFbkF71rq1/AIViuKYS/8Jwr0EvyIhoS1uHFmhx9LWF8aApw15capGZd?=
 =?us-ascii?q?My/lhG2nzZtgBnJZOgMr1tiUQYcwR0uEPuyQ56CoFBkcgssXMrwxB+KaOe0FNd?=
 =?us-ascii?q?aTyY2Yr8NaHQKmn35BqvcbLZ2knC0NaK/acC8PQ5q0j5sA61DEYj8nVn3MNT03?=
 =?us-ascii?q?uT/ZjKCAsSUZTsUkc47RR6prfaYjUj6IPQz3FjLa60sjra0dIzGOQl0gqgf8tY?=
 =?us-ascii?q?MK6cDg/yEtEVCNK0KOM3nFildBQEM/5I9K41Js+pa+GJ2Kq2M+l+hjKmimJH7Z?=
 =?us-ascii?q?t50kKN8Sp8V+HJ04wEw/GewguISTP8gE29vcDwnIBOfSsSEXanySj4GI5RYbV/?=
 =?us-ascii?q?fIYKCWu0I8y73M5+h4PrW3ND8F6jBlUG2NKmeBaIblz92xFQ2loToXC9hSS4yD?=
 =?us-ascii?q?l0mSkzrqWDxCzO3/jidB0fN25JXmZil1TsIYuzj9wAR0indQsplBik5Ub82adb?=
 =?us-ascii?q?or9yL23SQUdOYij3IHtuUqq2trqefcFP7IkkvjlQUOS5eVqaUKLyowMG0yP/GG?=
 =?us-ascii?q?tT3DA6eCutupnjnRx6iWSdIW13rHrYf8Fw2Bje6MbdRf5XwjoJWi14hSPLCVi7?=
 =?us-ascii?q?Otmj5c+UmIvbsuCiS2KhUYVecSrxwoOBrie75XBqDge5n/C8gdDnFQk60Snm19?=
 =?us-ascii?q?hlTynIrRD8YpX12KS+K+5oYk5oBFrk4cpgBo5+ipcwhI0X2XUCg5WV/HkHnn3p?=
 =?us-ascii?q?PdRVx63+d2YNSiARw9HO/gflwkJjI2mNx4L4UHWd38Rga8O7YmMQxiIy8cRKBL?=
 =?us-ascii?q?2I47xDmCt/ukC4oh7JYfhhgjcdzuMj6GIdg+EMogYszz+SArYPHUlDJizslg+F?=
 =?us-ascii?q?79S/rKVReWaufqK81Et4ndC9Er6CphtQV2r+epcnBSVw9NlwMErQ0H3v7YHpYM?=
 =?us-ascii?q?LfYsgUth2QjhfMlexVKI8qm/oOhCpnP3/9vHI/x+46ixxuwY+1vIydJ2px+6K5?=
 =?us-ascii?q?BwZSNifpaMML5jHtkaFek96U34+1G5VuBC4LUIH0Tf6yEzISqPfnNxuIEDImsX?=
 =?us-ascii?q?eWAr7fHQ6Z6Ed7oHPDCZGrN3eLJHYHydVuXgWSJEtagAoMRjU1goY5Fhy2xMzm?=
 =?us-ascii?q?aEp45jcR5kPhqhtR0O1oMQPzUnzYpAeuZTc5U5yfLBtQ7gFf6EbZK82e7uRvHy?=
 =?us-ascii?q?5G+p2tthCCKmueZw5QF2EGRlSEB0z/Prmp/dTA8/aXBuu9L/vNYLWCs+9eV+2P?=
 =?us-ascii?q?xZKgzIRm5SuMNt6UM3lmDv073FdDXH9jF8TYnTUPVzIYlybXY8GHoxe8/zV9rt?=
 =?us-ascii?q?qj//TzRALv+YyPBqNIPtVy4B+2m7mMNu6KiCZ9KDZVzZcMxX7OyLgC018ekSBu?=
 =?us-ascii?q?dz+xEbsesS7BVr7fmqhSDxQDcSN8KNNI774g3glKIcPbltL11rtigvEpEVtKSV?=
 =?us-ascii?q?zhld+vZcERJ2G9NVXHBFuENbicJD3Lxd33br24SbFKkOpUsBiwsy6BE0D/JjSD?=
 =?us-ascii?q?iyXpVxe3POBMli6bOhleuIC7chl1CGnjTMjpahu0MNJsiT02wLs0hm7FNGIGMD?=
 =?us-ascii?q?h8dV9NoaOU7S9Cnvp/HGlBvTJZKry4myGc5vKQBZIbsOttDz48w/5V5GQSz7pT?=
 =?us-ascii?q?8T1eQ/p0iG3eo4g9jUuhl7y2yzNhGDFHq34fj4uKlUpnKePE7c8TCj7/4BsR4D?=
 =?us-ascii?q?DIWFwxrNx/B4i3tg=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AlAwBDCftbh0O0hNFhHgEGBwaBZYNsh?=
 =?us-ascii?q?CCDe5AbgWAIJRSJCZBRAYhaIjgSAQMBAQEBAQECARMBAQEIDQkIKS+CNiKCZQE?=
 =?us-ascii?q?CAwECIBVBBgkBAQoOCgICJgICA1QGDQgBAQGDHIFpARgEAZpbiw2BL4VAgWYBg?=
 =?us-ascii?q?nCBC4p+F4F/gTgMgl+EaoMYglcCiH9Shgs0jx1VCYEpkAAekQiaDYF2MxoILQM?=
 =?us-ascii?q?7gm2CJheOOiKBNwEBiX6CSQMBAQ?=
X-IPAS-Result: =?us-ascii?q?A0AlAwBDCftbh0O0hNFhHgEGBwaBZYNshCCDe5AbgWAIJRS?=
 =?us-ascii?q?JCZBRAYhaIjgSAQMBAQEBAQECARMBAQEIDQkIKS+CNiKCZQECAwECIBVBBgkBA?=
 =?us-ascii?q?QoOCgICJgICA1QGDQgBAQGDHIFpARgEAZpbiw2BL4VAgWYBgnCBC4p+F4F/gTg?=
 =?us-ascii?q?Mgl+EaoMYglcCiH9Shgs0jx1VCYEpkAAekQiaDYF2MxoILQM7gm2CJheOOiKBN?=
 =?us-ascii?q?wEBiX6CSQMBAQ?=
X-IronPort-AV: E=Sophos;i="5.56,279,1539673200"; 
   d="scan'208";a="139476277"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 25 Nov 2018 12:48:33 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1726494AbeKZHkY (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Mon, 26 Nov 2018 02:40:24 -0500
Received: from mout.gmx.net ([212.227.15.15]:48859 "EHLO mout.gmx.net"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1725863AbeKZHkY (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Mon, 26 Nov 2018 02:40:24 -0500
Received: from ovpn-120-100.rdu2.redhat.com ([98.118.28.103]) by mail.gmx.com
 (mrgmx001 [212.227.17.184]) with ESMTPSA (Nemesis) id
 0M5Lqx-1fU7JQ1Kpz-00zYgR; Sun, 25 Nov 2018 21:48:15 +0100
Subject: Re: [PATCH v4] debugobjects: scale the static pool size
To: Thomas Gleixner <tglx@linutronix.de>
Cc: akpm@linux-foundation.org, longman@redhat.com,
        yang.shi@linux.alibaba.com, arnd@arndb.de,
        linux-kernel@vger.kernel.org
References: <20181120232810.2503-1-cai@gmx.us>
 <20181121021157.3061-1-cai@gmx.us>
 <alpine.DEB.2.21.1811222238270.1665@nanos.tec.linutronix.de>
From: Qian Cai <cai@gmx.us>
Message-ID: <245eeb16-e953-9375-5c54-4b9396959340@gmx.us>
Date: Sun, 25 Nov 2018 15:48:13 -0500
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:60.0)
 Gecko/20100101 Thunderbird/60.3.1
MIME-Version: 1.0
In-Reply-To: <alpine.DEB.2.21.1811222238270.1665@nanos.tec.linutronix.de>
Content-Type: text/plain; charset=utf-8; format=flowed
Content-Language: en-US
Content-Transfer-Encoding: 7bit
X-Provags-ID: V03:K1:SEL+UXnHw2VDWwDEgB0D7BcMlGccy9qfMkVjMzI6IVVdvOd28XC
 uP8ST2Wq1FCBKgA9M+1qwY1CriHXjl4rk8LszTrF6JOuPN+QmnyW6vyG8dkQD/vw8rNhSMV
 +aVw87R+fc0Z6cA4c3BZLmgR2TJ76R+8wLh5ZSupSeKDGk0WaVPyUfqTxwryqnyTTCeOmzA
 4RJEXs0eHsFbEESUHUvOQ==
X-Spam-Flag: NO
X-UI-Out-Filterresults: notjunk:1;V03:K0:Lwth3Ax1+1s=:XzQHit2dqoV3pl0cAtjrCN
 J2aMqSRjrg2I9BrkLTqm1v0lMLHVK71QtsZT3s1zSonORj3ZoE9PiN2I8r0voCl0L7upsdM1C
 lxm4hpsr4zeNlVrz7RP5+CLV9nHb4Me0OMnhnqcnEbCYxYQ1coua2T4aPuHcuoEoEkv0ogqwv
 oLsEXYSyBGChO/dIJYSS5a2biNNT9HZWoSdpRVWitaCke2lUxL3m3G0KsO0ZGWpxH5tfw6mOF
 kyNcltZuukGUqb9CAlQwKSt5uLZ4562mi2xGeW3jtfzdF0YCSh3QbXtHbAWzaet6HnjUh0pJk
 6G40ksUV2WQpBOMOYBb8rVTkW/Kjer3Qf1dzrpfB99d2PWM226/F2tEfCFnyjnjUMUAsFQq3x
 +4ZuizVsIw8YBpgzlTKVAJOFZTABeyrjwNkc0ANY54DtsnZ9g1PbNaRKCkId6Wq+VEHRw56kN
 08kYG3Jy09998M8YYL7+KcHjdZb8V6FR+mnUHECuqSyPjQ5NH1L9RpZG3LjvW2Bfqg7G+R0iP
 zkBbd9U3CAYtCYO8w2d6kfaCpSTKSar/RaFxS6JNz50bZ/deZUlKMxwl+wPvM1V4iQ7Ialtif
 1BOyH2xN3DTQcF+RDCqhc3W2HnxcchKx1fys6ZkJY1mi6mfSLjO6upTp3NwCiO6fhxOcbg8ZF
 nY2ljbcXz29E1qcwWE5dF++XITxT+bwNHR8ehccslJuID6m34qH0u7OMoT09Asoy++6tWW4uG
 9BcEY4iqy+LRaRT0ENB64g53eBGV2b7GkmEUdLYTSjcVgYxo8y+0KQ09Z+A8JjBSLDii+yuj+
 K5ZvNHysfow2pREjn6SW4J5bSMULztKASNw7N6/Bo1YcG4XlXpGnAXUGnDmpxyIZtnfK/M906
 0DjAUrLSzLt2rMSl7nj3V09kZSxFhQQecT0ZC5OlY=
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org



On 11/22/18 4:56 PM, Thomas Gleixner wrote:
> On Tue, 20 Nov 2018, Qian Cai wrote:
> 
> Looking deeper at that.
> 
>> diff --git a/lib/debugobjects.c b/lib/debugobjects.c
>> index 70935ed91125..140571aa483c 100644
>> --- a/lib/debugobjects.c
>> +++ b/lib/debugobjects.c
>> @@ -23,9 +23,81 @@
>>   #define ODEBUG_HASH_BITS	14
>>   #define ODEBUG_HASH_SIZE	(1 << ODEBUG_HASH_BITS)
>>   
>> -#define ODEBUG_POOL_SIZE	1024
>> +#define ODEBUG_DEFAULT_POOL	512
>>   #define ODEBUG_POOL_MIN_LEVEL	256
>>   
>> +/*
>> + * Some debug objects are allocated during the early boot. Enabling some options
>> + * like timers or workqueue objects may increase the size required significantly
>> + * with large number of CPUs. For example (as today, 20 Nov. 2018),
>> + *
>> + * No. CPUs x 2 (worker pool) objects:
>> + *
>> + * start_kernel
>> + *   workqueue_init_early
>> + *     init_worker_pool
>> + *       init_timer_key
>> + *         debug_object_init
>> + *
>> + * No. CPUs objects (CONFIG_HIGH_RES_TIMERS):
>> + *
>> + * sched_init
>> + *   hrtick_rq_init
>> + *     hrtimer_init
>> + *
>> + * CONFIG_DEBUG_OBJECTS_WORK:
>> + * No. CPUs x 6 (workqueue) objects:
>> + *
>> + * workqueue_init_early
>> + *   alloc_workqueue
>> + *     __alloc_workqueue_key
>> + *       alloc_and_link_pwqs
>> + *         init_pwq
>> + *
>> + * Also, plus No. CPUs objects:
>> + *
>> + * perf_event_init
>> + *    __init_srcu_struct
>> + *      init_srcu_struct_fields
>> + *        init_srcu_struct_nodes
>> + *          __init_work
> 
> None of the things are actually used or required _BEFORE_
> debug_objects_mem_init() is invoked.
> 
> The reason why the call is at this place in start_kernel() is
> historical. It's because back in the days when debugobjects were added the
> memory allocator was enabled way later than today. So we can just move the
> debug_objects_mem_init() call right before sched_init() I think.
> 
>> + * Increase the number a bit more in case the implmentatins are changed in the
>> + * future, as it is better to avoid OOM than spending a bit more kernel memory
>> + * that will/can be freed.
>> + *
>> + * With all debug objects config options selected except the workqueue and the
>> + * timers, kernel reports,
>> + * 64-CPU:  ODEBUG: 4 of 4 active objects replaced
>> + * 256-CPU: ODEBUG: 4 of 4 active objects replaced
>> + *
>> + * all the options except the workqueue:
>> + * 64-CPU:  ODEBUG: 466 of 466 active objects replaced
>> + * 256-CPU: ODEBUG: 1810 of 1810 active objects replaced
>> + *
>> + * all the options except the timers:
>> + * 64-CPU:  ODEBUG: 652 of 652 active objects replaced
>> + * 256-CPU: ODEBUG: 2572 of 2572 active objects replaced
>> + *
>> + * all the options:
>> + * 64-CPU:  ODEBUG: 1114 of 1114 active objects replaced
>> + * 256-CPU: ODEBUG: 4378 of 4378 active objects replaced
>> + */
>> +#ifdef CONFIG_DEBUG_OBJECTS_WORK
>> +#define ODEBUG_WORK_PCPU_CNT	10
>> +#else
>> +#define ODEBUG_WORK_PCPU_CNT	0
>> +#endif /* CONFIG_DEBUG_OBJECTS_WORK */
>> +
>> +#ifdef CONFIG_DEBUG_OBJECTS_TIMERS
>> +#define ODEBUG_TIMERS_PCPU_CNT	10
>> +#else
>> +#define ODEBUG_TIMERS_PCPU_CNT	0
>> +#endif /* CONFIG_DEBUG_OBJECTS_TIMERS */
> 
> Btw, the scaling here is way off.
> 
>> +#define ODEBUG_POOL_SIZE	(ODEBUG_DEFAULT_POOL + CONFIG_NR_CPUS * \
>> +				(ODEBUG_TIMERS_PCPU_CNT + ODEBUG_WORK_PCPU_CNT))
> 
> CONFIG_NR_CPUS	Pool size		Storage size
> 
> 256		256512			4M
> 		
> According to your list above it uses 4378 object for 256 CPUs. That's off
> by an factor of ~58.
> 

Hmm, it is not clear to me why this is off and where did the pool size 256512 
come from.

CONFIG_NR_CPUS: 256
Pool size: 1024 + 256 * (10 + 10) = 6144

Am I missing anything?
