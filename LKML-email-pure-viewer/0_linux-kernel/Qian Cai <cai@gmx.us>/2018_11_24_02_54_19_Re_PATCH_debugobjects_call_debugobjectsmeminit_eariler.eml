Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 24 Nov 2018 12:38:13 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga007.jf.intel.com (orsmga007.jf.intel.com [10.7.209.58])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 9E250580460;
	Fri, 23 Nov 2018 18:54:44 -0800 (PST)
Received: from orsmga101.jf.intel.com ([10.7.208.22])
  by orsmga007-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 18:54:44 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AMBRmXxEyen3u+v1k5wINQZ1GYnF86YWxBRYc798d?=
 =?us-ascii?q?s5kLTJ75o829bnLW6fgltlLVR4KTs6sC17KG9fi4EUU7or+5+EgYd5JNUxJXwe?=
 =?us-ascii?q?43pCcHRPC/NEvgMfTxZDY7FskRHHVs/nW8LFQHUJ2mPw6arXK99yMdFQviPgRp?=
 =?us-ascii?q?OOv1BpTSj8Oq3Oyu5pHfeQpFiCa+bL9oMBm6sRjau9ULj4dlNqs/0AbCrGFSe+?=
 =?us-ascii?q?RRy2NoJFaTkAj568yt4pNt8Dletuw4+cJYXqr0Y6o3TbpDDDQ7KG81/9HktQPC?=
 =?us-ascii?q?TQSU+HQRVHgdnwdSDAjE6BH6WYrxsjf/u+Fg1iSWIdH6QLYpUjm58axlVAHnhz?=
 =?us-ascii?q?sGNz4h8WHYlMpwjL5AoBm8oxBz2pPYbJ2JOPZ7eK7WYNEUSndbXstJSyNODZ6y?=
 =?us-ascii?q?YYsNAOQPMuhWrIf9qUUJoxulHQmhBvjiyiNKiH/zwaE60/gtHR/A0Qc9H9wOqn?=
 =?us-ascii?q?PUrNDtOakJUOC61q/IxijdYvxM2Df29Y/FfQw7rvGNRr9wfs/RyEY1GwPYlVWd?=
 =?us-ascii?q?sIroNC6W2OQVq2WX8fZsWOa1h2I6pQx9vCKjytovh4XVnI4Yy1LJ+T19zYs2P9?=
 =?us-ascii?q?G0VVN3bN2+HJdOtCyWLZZ6Tt8sTmxupS000KcJuYShcygP0JknxwDQa/iAc4WQ?=
 =?us-ascii?q?/BLjW/ieIS1iiHJmZr2/nRCy/lakyuHmUcm0yllKojJEktnKqH8NywTe5tabRv?=
 =?us-ascii?q?Z55EutxDiC2x7J5u1ZIk04ibDXJp8jz7Iok5ocq0XDHiv4mEXsi6+Wc10p+uyp?=
 =?us-ascii?q?6+Thf7XnqYaQN4xqhQHkNKQhhMi/Df0/MgkAWWiU5/682ab9/U32XrpKlOc6kq?=
 =?us-ascii?q?rHv5DAI8QUuKq5DxVS0oY55BazFy2m38gAnXkbMFJFfwqKj4zoO1HNPv/0F/i+?=
 =?us-ascii?q?g0m3nTdvxvDGOKDhA5rXInjClrfhYahy60pGxAUvytBf4opeCqsdL/LrRk/xqN?=
 =?us-ascii?q?vYAwc5MwOuwubnFM9y1oQEVWKPH6+WKqXSsVCT6+IrIumMYpIVuTnnJ/gk4f7u?=
 =?us-ascii?q?kWE2mVsHcaa12psXbWiyHu56LEWBfXrsntABHH8Ivgo5UuPmkl6CUTlVZ3a0WK?=
 =?us-ascii?q?Ix/TU7CIOgDYfeSYGhmr2B3CGnHpJIYmBKEEyDEXDtd4+cQfcDdDqSItN9kjwD?=
 =?us-ascii?q?TbWuUZQh1RGptA/50bZnNPDb+i8DuJLn1dh14fDTlB4o+Tx1CcSdz3+CT2Vukm?=
 =?us-ascii?q?wUQD822bh1oVZhxVebzah4n/tYGMRQ5/xTVAc2L5rcz+1gBND0VQLMZdOJSFeg?=
 =?us-ascii?q?QtW7DjA9VNMxw9kSY0ljH9WulAzM3y2vA7UNjbyEGIQ08r7A33j2P8ty1mzJ1L?=
 =?us-ascii?q?c/gFU8QstAL2umhrVh+AjVAILJl0aZl6OudakH2C7N9WGDzXeBvU1CUQ5wV7nF?=
 =?us-ascii?q?Um4bZkfMsdv54UbCRae0Cbs7KgtB1dKCKqxSZ9L0l1pGWunsNM7eY22rnWewHg?=
 =?us-ascii?q?iHxrWXYYruemUd2jjdCUcenwAS+3aGKRYxBiO7r23CCzxuEErlY1nw/ulmtHO7?=
 =?us-ascii?q?Ukg0whmWb01g0rq1/QIVhfycSv8JwrIIoiAhqy9wHFa82dLWBMGNpw5gfKVafN?=
 =?us-ascii?q?M8701L1WPftwxhIJOgK7puiUIZcwRyp0nuzQl4Cp1ckcg2q3Mn1BB9KaaG31JO?=
 =?us-ascii?q?aTyZ3Yr8NabKKmbv5h+vba3W2lbA0NuN/qcP6fI4q0jsvQ2zF0oi9Wln3MdR03?=
 =?us-ascii?q?eG+prKCw8SW4rrUkkr7xh6u63aYi4l6oLUyH1gK7W7viXD2tIpHuQlzBmgcsxb?=
 =?us-ascii?q?MKOFEg/yDsIbC9KvKOwsh1imcBYEMPpO+64zOsOsb+GG17KzPOZ8gDKminxK4J?=
 =?us-ascii?q?p80k2Q7SV8UPPH35Efz/GewASHTTb8gE69vc/tnYBLeC8dHnC4ySjiH4NRYqxy?=
 =?us-ascii?q?fYAWCWahOcG3x9N+h4LzVH5c7lKsG1QG2MqxcxqIc1P9xRFQ1VgQoXG/mSq4zi?=
 =?us-ascii?q?Z4kjEzoqqEwSzOxf/vdB4GOm5NWWljgk3gIYmyj9AGQkeoaxIlmwei5Ub/36Jb?=
 =?us-ascii?q?vrhwL3HPQUdUeCj7N2NiXbGqtrqBYM5P74kksT5NX+S/YlCaS7j9rAUc0y74G2?=
 =?us-ascii?q?texTY7dyylu5njnhx6jn6dI2h3rHbDZc5wwhLf7sTGRfFNxjoGWDV4iT7PC1m8?=
 =?us-ascii?q?Jdap+s+Yl5XCsuC4TG+hUpxTcS/2zYKPrie75GtqAQGhkPC3gNHoDQ860Srj3d?=
 =?us-ascii?q?lwSSrItAr8YpXs16miMuJoZEhoCEX868pnAI5+lIQwiYoU2XgbgJWV4HUGnX3y?=
 =?us-ascii?q?MdVdxaLxcn4NSSQXzN7S5QjvwFdjIW6Rx4LlSnWdxdNsZ9y7YmMVwC0x9c5LB7?=
 =?us-ascii?q?mP7LxYgyR1uEG3ohzLYfhyhTodzfou6HgHg+AGogYtzyOdAqwMEklcJyDjixOI?=
 =?us-ascii?q?79WmpqVNeGmvaaSw1FZ5nd25ELGCpQRcVGz4e5g4Gy9w895/MEnN0HDo7oHked?=
 =?us-ascii?q?/Qbc8ctxGOkhfAifRVJ4w1lvYQmSVnPmf9t2U/y+EnlRxuwY26vI+fJmp25q25?=
 =?us-ascii?q?BRpYNiDva8MX5zHglqJenseQ34CyEZRtADQLXJ30Tf22FDIer+joNwGLEDcksH?=
 =?us-ascii?q?eUBaLfHROD6Edht3/PEYqkN3SJK3kC19liWAORJE9CgAAXQTU6mIQ2Fhuxyczl?=
 =?us-ascii?q?cUd54C0R51HiphtNzOJoKwfwUmPFqAi0bTc0TYCVLABK4QFa+0fVLcue4/pzHi?=
 =?us-ascii?q?Ff452htRGNJXadZwhSFmEJXUqEB1/4M7mq5NnA9fWYB+WkI/vPZ7WOtfJRV/OS?=
 =?us-ascii?q?yZ2z1Ytm+i6GNt+TMXl6E/07xk1DUGh5G8vHmjUPSC8XlyPXY86Yvhe8/SJ3od?=
 =?us-ascii?q?6l8PT2QwLi/o+PC7pUMdVy9BG6m6aDN+iMhClnLTZUzI8DxXjNyLIHxl4dlzlu?=
 =?us-ascii?q?dyWxEbQHrSPCVr/QlbRNDxEFayJ/Ls9I76Mn0wlJOM7bjM7117Figv40DVdFSU?=
 =?us-ascii?q?LumsWzacMWJGG9MUvNBFyXO7SeOT3L38b3bLugSb1RieVYrQG/tSyHHE/jIDuD?=
 =?us-ascii?q?kSLkVxSuMeFKkSGaMwZSuIC7chZxF2fjSMjqZQG8MN9ylTc226E7hmvWNW4ANj?=
 =?us-ascii?q?hxa0NMoaeW7SNdg/V/HXRO73tlLeaenSaZ4PLVKpIXsfttHyR1mPhW4HU8y7tJ?=
 =?us-ascii?q?8i5EQOZ5lzfVrt5r8Bmalbyzyj1iWQEGhTJGhZKNsF8qbbnW8oloXXfC4Q4X6m?=
 =?us-ascii?q?ORG1IGqo02JMfovvVpy9HJ3In6KX8W+NvV1cQZF47JM5TUYzIaLRP1FWuMX0M+?=
 =?us-ascii?q?RjmxODSa3hQFnQ=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0A5BgD+vPhbh0O0hNFjHAEBAQQBAQcEA?=
 =?us-ascii?q?QGBZYFbgRJ/J5gRgWglFIkJiSiGaC4TAYhaIjgSAQMBAQEBAQECARMBAQEIDQk?=
 =?us-ascii?q?IKS+CNiQBgmEBAQEBAgEBAiQMBz8FAQkBAQoOCi4DVAYTBYMcgWkBEAgEAZs8j?=
 =?us-ascii?q?AkzhyoBgnCMCReBf4E4DBOCTIgzgiYCiVGGP49yCYEpkBgGgVmFC4J9hycslQK?=
 =?us-ascii?q?EX4F2MxoILQNlAYJBPoFpF38BDo0sIjKBBQEBjCEBAQ?=
X-IPAS-Result: =?us-ascii?q?A0A5BgD+vPhbh0O0hNFjHAEBAQQBAQcEAQGBZYFbgRJ/J5g?=
 =?us-ascii?q?RgWglFIkJiSiGaC4TAYhaIjgSAQMBAQEBAQECARMBAQEIDQkIKS+CNiQBgmEBA?=
 =?us-ascii?q?QEBAgEBAiQMBz8FAQkBAQoOCi4DVAYTBYMcgWkBEAgEAZs8jAkzhyoBgnCMCRe?=
 =?us-ascii?q?Bf4E4DBOCTIgzgiYCiVGGP49yCYEpkBgGgVmFC4J9hycslQKEX4F2MxoILQNlA?=
 =?us-ascii?q?YJBPoFpF38BDo0sIjKBBQEBjCEBAQ?=
X-IronPort-AV: E=Sophos;i="5.56,272,1539673200"; 
   d="scan'208";a="42043106"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 23 Nov 2018 18:54:43 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1730014AbeKXNlT convert rfc822-to-8bit (ORCPT
        <rfc822;like.xu@linux.intel.com> + 23 others);
        Sat, 24 Nov 2018 08:41:19 -0500
Received: from mout.gmx.net ([212.227.17.20]:45423 "EHLO mout.gmx.net"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1729519AbeKXNlT (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Sat, 24 Nov 2018 08:41:19 -0500
Received: from [192.168.1.153] ([98.118.28.103]) by mail.gmx.com (mrgmx103
 [212.227.17.174]) with ESMTPSA (Nemesis) id 0Mbx62-1gAVMO3PSo-00JLW9; Sat, 24
 Nov 2018 03:54:23 +0100
Content-Type: text/plain;
        charset=us-ascii
Mime-Version: 1.0 (Mac OS X Mail 12.1 \(3445.101.1\))
Subject: Re: [PATCH] debugobjects: call debug_objects_mem_init eariler
From: Qian Cai <cai@gmx.us>
In-Reply-To: <alpine.DEB.2.21.1811232244140.1684@nanos.tec.linutronix.de>
Date: Fri, 23 Nov 2018 21:54:19 -0500
Cc: Waiman Long <longman@redhat.com>,
        Andrew Morton <akpm@linux-foundation.org>,
        Yang Shi <yang.shi@linux.alibaba.com>, arnd@arndb.de,
        linux kernel <linux-kernel@vger.kernel.org>
Content-Transfer-Encoding: 8BIT
Message-Id: <EDC1847C-1525-445C-AAFE-F07049C66565@gmx.us>
References: <alpine.DEB.2.21.1811222238270.1665@nanos.tec.linutronix.de>
 <20181123043117.992-1-cai@gmx.us>
 <dfa544fc-18d8-f1bf-fadf-46fdbda8d624@redhat.com>
 <alpine.DEB.2.21.1811232244140.1684@nanos.tec.linutronix.de>
To: Thomas Gleixner <tglx@linutronix.de>
X-Mailer: Apple Mail (2.3445.101.1)
X-Provags-ID: V03:K1:PZ/0F0wjN6pTDNwn1q1umgu0XVUwbcpTAu1ot28AQB8idd6Ay9I
 KQqwVK4ug5vzfe96sSd1ZN+cDCs54/S/rWtBLDOIRrNVOBfHdLDECE27ckHEwsWSQ4+ajh9
 IMh1wOZkwObM95hmGQs7SeWcxZ6Nh4Qa6gWBdyP+ElEbyKH3C9jpZrxJdQAiGkZ8jeo7rhU
 TxinzY8Gf35ieLqEkzmSw==
X-Spam-Flag: NO
X-UI-Out-Filterresults: notjunk:1;V03:K0:OFv+dldDL0w=:OwnloPHs5nMSgAycyNlkDB
 SSwIqMvXKHKcjce22TYgTIjc4IHwtz/82B+mYWm4qLv41Rq3d45BX5dHgr8uS8AOZxTCfGUtG
 mdlF4cwhJJMlQLrKoLbcGDbEcBg67YJEWCHWEs1pJUb7u0vRLr2KuclhwWslCoErTMN8kgqQS
 vqPtredrjXk/ReswmMSKKpwUt684OugQFY5yeHjsNN1QVIhklf7GjDdrx3m+WXo/6Le26oUi3
 WLa3IIo+RWQ0Hkri2JTBUK5sfbA1/SI7bqUwAiFixC/AQ7sNZVAif5+zDjrCNyxE6HdURI4bU
 V1aOpukELuheoJgwsuGV57YEY75wgduICy5L5N46v+GKYWxl4z1E0b3SnkQhJrC6P0M857koS
 0iFTMlbmvWMQsNTmM69RfP/FhNPOjfJ/i08nIaDRvABLskmo9fV6k7aYma2VdMKdQi6DtGnT0
 2OnM0xwXhifw3OPPA3U5YaaIiIeH6j8OzLUtQUe/5kGH2NlDB/2FbT5NFApnBgIiWrpAzZ8la
 JrGG57N3jwgBvM/WDilkDgqBnKVhhddQyy6Bz5wRFphoZ+qNWmyJQ2ZFyCeoZAWrxPFCphWHR
 5sFb9+BUdMzejty4/dLk3CPChr9nGSOS7bxq7e0OPj/jZzfyWRgaJjqO2DKkVQ08vbuV7xklz
 aBE+6ClRJDG5BGi7DEW7Pf7GCnPZ1y5hcpRNXBP0pZs4Npp9hQMJBRTtKO4d3aKT9Z+s+448R
 3U/gP1ajoEXzei1tqb5rr7AIw1ZbSFmJcmhOzVYDbUbxsDs6ICMwcTe2XMT+NYf/puNQP+o0Y
 EuNCKyBl5aSpnRXUaIGLg2VhToVAbVga4dCVeVm+FKCtXjdvEl1kMVnlX5bUnG0CbluRRkCVe
 ceiXjVxlKWZtV4ggKwGIb1UoyQk2od6fjQuqQU0Ds=
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org



> On Nov 23, 2018, at 4:46 PM, Thomas Gleixner <tglx@linutronix.de> wrote:
> 
> On Thu, 22 Nov 2018, Waiman Long wrote:
>> On 11/22/2018 11:31 PM, Qian Cai wrote:
>>> The current value of the early boot static pool size, 1024 is not big
>>> enough for systems with large number of CPUs with timer or/and workqueue
>>> objects selected. As the results, systems have 60+ CPUs with both timer
>>> and workqueue objects enabled could trigger "ODEBUG: Out of memory.
>>> ODEBUG disabled".
>>> 
>>> However, none of the things are actually used or required beofre
> 
> before
> 
>>> debug_objects_mem_init() is invoked.
>>> 
>>> According to tglx,
>>> "the reason why the call is at this place in start_kernel() is
>>> historical. It's because back in the days when debugobjects were added
>>> the memory allocator was enabled way later than today. So we can just
>>> move the debug_objects_mem_init() call right before sched_init()."
>>> 
>>> Afterwards, when calling debug_objects_mem_init(), interrupts have
>>> already been disabled and lockdep_init() will only be called later, so
>>> no need to worry about interrupts in
>>> debug_objects_replace_static_objects().
> 
> Just out of curiosity. How many objects are allocated between early and mem
> init?

64-CPU:   68
160-CPU: 164
256-CPU: 260

INIT_WORK(&p->wq, free_work) is called per CPU:

start_kernel
   vmalloc_init
      __init_work
        __debug_object_init

Once debug_objects_mem_init() is moved just before vmalloc_init(), there
is only 1 object.

ODEBUG: 1 of 1 active objects replace

> 
>>> diff --git a/lib/debugobjects.c b/lib/debugobjects.c
>>> index 70935ed91125..cc5818ced652 100644
>>> --- a/lib/debugobjects.c
>>> +++ b/lib/debugobjects.c
>>> @@ -1132,13 +1132,6 @@ static int __init debug_objects_replace_static_objects(void)
>>> 		hlist_add_head(&obj->node, &objects);
>>> 	}
>>> 
>>> -	/*
>>> -	 * When debug_objects_mem_init() is called we know that only
>>> -	 * one CPU is up, so disabling interrupts is enough
>>> -	 * protection. This avoids the lockdep hell of lock ordering.
>>> -	 */
>>> -	local_irq_disable();
>> 
>> I think you should have a comment saying that debug_objects_mm_init() is
>> called early with only one CPU up and interrupt disabled. So it is safe
>> to replace static objects without any protection.
> 
> Yes please.
> 
> Thanks,
> 
> 	tglx

