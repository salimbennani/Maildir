Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 23:34:43 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga006.jf.intel.com (orsmga006.jf.intel.com [10.7.209.51])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 673ED58037D;
	Fri, 23 Nov 2018 03:54:05 -0800 (PST)
Received: from orsmga106.jf.intel.com ([10.7.208.65])
  by orsmga006-1.jf.intel.com with ESMTP; 23 Nov 2018 03:54:05 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3A6nVDwxfz0Le3m3lUtow96818lGMj4u6mDksu8pMi?=
 =?us-ascii?q?zoh2WeGdxc6/YRyN2/xhgRfzUJnB7Loc0qyK6/CmATRIyK3CmUhKSIZLWR4BhJ?=
 =?us-ascii?q?detC0bK+nBN3fGKuX3ZTcxBsVIWQwt1Xi6NU9IBJS2PAWK8TW94jEIBxrwKxd+?=
 =?us-ascii?q?KPjrFY7OlcS30P2594HObwlSizexfbB/IA+qoQnNq8IbnZZsJqEtxxXTv3BGYf?=
 =?us-ascii?q?5WxWRmJVKSmxbz+MK994N9/ipTpvws6ddOXb31cKokQ7NYCi8mM30u683wqRbD?=
 =?us-ascii?q?VwqP6WACXWgQjxFFHhLK7BD+Xpf2ryv6qu9w0zSUMMHqUbw5Xymp4rx1QxH0li?=
 =?us-ascii?q?gIKz858HnWisNuiqJbvAmhrAF7z4LNfY2ZKOZycqbbcNwdWWRPXthcWzVYDo6h?=
 =?us-ascii?q?dYQAEvYMMvter4fhu1QOswaxCRexD+/ryjJEm3r60Ksn2OojDA7GxhQtEc8Qvn?=
 =?us-ascii?q?TarNv7N6kcXu66w6bK0TrNYOhW2S//5YXTbhAso+uBUa5sfcffy0QiER7OgFWK?=
 =?us-ascii?q?qYziOjOYzusDs26B7+phSe2klnMqpBt1ojir2MgslpLGhoUIwVDF6C533Zg6Jc?=
 =?us-ascii?q?eiSEFhfNWpF4VftyeAN4t3XswuWXpntzw+yr0Cp5G7YDMFyJM8yhHDbPyHd4yI?=
 =?us-ascii?q?7Qj4W+aWOzd3nmhpd664hxa36EWtzPD3WMqs0FtSsCZJjt3BumoQ2xHd9MSLUO?=
 =?us-ascii?q?Zx80S91TqV1g3e6PlILE81mKbBNZIszL49moANvUjdHCL6glv6gLGUe0gi5+Om?=
 =?us-ascii?q?8f7oYq/8qZ+ZL4J0ih/xMqApmsGnH+Q4PRYBX3KB9eS/yrLj50v5T6tOjvEsla?=
 =?us-ascii?q?nZqp/aKdwapq6/HQBVzp4u5wijAzqiytgUgHcKIExfdB6ajIXlJ0vCLfH6APun?=
 =?us-ascii?q?hlSjijZrx/TIPr37BZXNK2DOkLPgfbZ79k5dxxM/zdNB6JJODLEOPvbzVlb2tN?=
 =?us-ascii?q?3WCB82LRa0zv35CNVyyIweQ3iDAqyHP6PIt1+H+OYvL/OLZI8PtzbxM+Il6OL2?=
 =?us-ascii?q?jX8lhV8derGk3Z8WaHC7APtqOUqYYWf3j9cFEGcKuBc+TePwhF2DVz5Te2i9X6?=
 =?us-ascii?q?Ym6j4nD4KmCJ/JRpqxj7yZwCe7AppWa3hGCl+WEHfoa5+LW/AWZCKSP89uiDoE?=
 =?us-ascii?q?Vbe6Ro8l1BGushL6yrV9IurV/C0YqYzs1Nxv6+LPkhEy8CR+D96B3GGVU2F0gm?=
 =?us-ascii?q?QISic03KB4v0Nx0FSD0a9+g/xeEtxe/PdJUgY8NZ7BwO12EdHyWgTdftiXTFaq?=
 =?us-ascii?q?WMmpATY0Ttgp2d8Bf159G8m+jhDExyelGaQVl7yMBJw36K7cxWL+J8RmxnbC1a?=
 =?us-ascii?q?khiUQmQ8RVOW2ngK5/6xbcB4rTn0qFkKaqcLwW3DTR+2eb0WqOoEZYXRZzUarf?=
 =?us-ascii?q?W3ATfE/WrdXj6UPEQL+jErAnMgpHyc6fJapGcNzpjVNaRPj9PNTSeX6+m2C1BR?=
 =?us-ascii?q?yQ3LODcJLqe3kB3CXaEEULjhoc/WiYOgQkBieuuWTeDCdwGlLpZE/s9ep+qHa/?=
 =?us-ascii?q?TkIvywGKbkth16e6+xIPhPycTe8T0awAuCs7tzp0G1O91crMC9WcvwphYLlcYd?=
 =?us-ascii?q?Ql7Vhaz23ZqRJyMoagL694gF4eaBp4v0X12hVzC4VAl9UqrXwwwApzL6KYzE1O?=
 =?us-ascii?q?dzeC0Z/sPb3XL3H4/AqzZK7OxlHezNGW978T6PQ5rlXjux2pFkoi8nl9z9lZyX?=
 =?us-ascii?q?yc5o/ODAoTV5LxXV069xx7p7Hcfyk86JnY1XxqMamorDDC38glC/ciyhalZ91f?=
 =?us-ascii?q?Kr+LFBfuE80GAMijMPYlm1y3YRMLIu9T9LQ4MNi7d/SbwqGrOuVgnDW4jWlc5I?=
 =?us-ascii?q?B900SM9zdzS+LS3pYFxe2Y0RWDVzvmkFihtcX3k5heZT4OBmq/1TTkBIlJa6xy?=
 =?us-ascii?q?YIYHE3uhL9e2x9V+nZHtXXFY+UWnB1MH3s+pZBWTY0b83Q1WyUQYv3inlTGkwD?=
 =?us-ascii?q?xzljEjtrCf0zDWw+T+aBoHPXZGRHNjjVjwO4e0lc0VXE+yYwgvihSl/0f6y7FH?=
 =?us-ascii?q?q6tlK2ncXFlHfzLxL2FkSaawsruCY8hS6JInqylXUeK8YUyERb75uRcVzyTjH2?=
 =?us-ascii?q?5GzjAhaz6qoon5nwB9iG+FLHdzrWDVeMFqyRfE+dzcQ+Vc3j4HRCl+lDnWCUKw?=
 =?us-ascii?q?P9iv/dWIiZjDtvqyWH6mVp1WaSPr15+PtDOn5W12Bh2yh/Kzlcf9EQg50i/70M?=
 =?us-ascii?q?NmVT7Soxb/YYnr1qK6PvxhfkRzAF/86sx6Gpxxk4cqhZEQ32QaiYuR/XYdjWjz?=
 =?us-ascii?q?NtBb07rkbHURXT4L38LV4A/91UxjNH2JwJj1VnecwstnfNS6ZmIW2iQg78FFEq?=
 =?us-ascii?q?uU7bpEnTdrrVq8tw7eff99njIFw/s09HEam/0JuBYqziiFAbAdB0hYMTbslxSV?=
 =?us-ascii?q?9d++qqpXaX2rcbix0kp+gN+gAKuDogFaRHb2ZJMiETVs4cV4NVLGyGfz5Z38eN?=
 =?us-ascii?q?nMcdITsQWZkxLBj+hWMp09jPQLijR8OWLho3Il0fU0ggJ03ZG1p4WHL2Rt/KSk?=
 =?us-ascii?q?Ah9XLDH1ZsUT+i3zgqZahMqZw4evHpB5EDURQJToVe6oEC4Vtfn/KwaOFzg8pm?=
 =?us-ascii?q?2aGLXFGw+f9Vxmr2nOE52wM3GXJX8ZzchtRRWHJUxfhhwUUys+npIjCg+qw8nh?=
 =?us-ascii?q?el9j5j8N/l74tgdMyuVwOhbkSGjfowOoaiouRJibMRpb9QVC50bTMcyD4eN/BS?=
 =?us-ascii?q?BY/pu9rAOTLmyXfRhHDWYMWkacHVDsIqGu5cXc8+ifHue+LeHBYbCQpuxFTfuI?=
 =?us-ascii?q?2Yij0oh7/zaPK8WPOGNtD+Yg10pHXHB5HdnZmjoVRywWkSLNc9CUpBOm9iJrqc?=
 =?us-ascii?q?C/9ezhWBjz6ouXF7tSLdJv9gi2gKeEKu6QnTt5Jixe1p8W3n/Iz74f3FEJhiFq?=
 =?us-ascii?q?djmtF6kAtCHXQKLRnK9XEwAUaydpOMRU6KI82xFHOdTHhdPtyr54kvk1Bk9FVV?=
 =?us-ascii?q?P/m8GpZs8KI2CnOFPEHkaLM7uGKiPRw8HqeqOxUrlQjORStx2ttjeXCU7jPjKf?=
 =?us-ascii?q?lzb3UxCjK/1DjCaePBZGooGybg5tCXT/TNLhchC0KsJ3giYswbIqhnLGL2ocMT?=
 =?us-ascii?q?lnfkNJr72Q6z5Yg/plF2xA6HplMfeLmyKD4+bELZYWtONhAj5omOJC/HQ617xV?=
 =?us-ascii?q?4TlYRPx0nSvetMJhr0u6nemP1DVnVgFDqjJKhIKNoEVjNr/V9phGWXbY4h0N6X?=
 =?us-ascii?q?+cBAgNp9tgEtfvobxfysDTlKLvLzdP69LV8tEaB8jRKcKHNmIuMBvpGDHOCgsF?=
 =?us-ascii?q?QiWmNWXeh0xbjfGT+WeZrpk8qpjwhpUOTqVXW0AyFvMfWQxZG4ktPZpxQj4+2Y?=
 =?us-ascii?q?ScgcULrS66rR/MVO1AuZ3MVbePGrPpJSrP3pdeYB5d7LXiLI9bHIT/30F+YF4y?=
 =?us-ascii?q?nczxFlDKVJgZryt7bwRyqkxJ9HViRGob0EXhbgqn52UaU/Wzm0hl2UNFfe0x+W?=
 =?us-ascii?q?K0sB8MLV3QqX51zBg8?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0APAABQ6fdbh0O0hNFjHAEBAQQBAQcEA?=
 =?us-ascii?q?QGBUQcBAQsBgVWCFieDeYgYi32BYC0UlycUgVoxEwGIVyI0CQ0BAwEBAQEBAQI?=
 =?us-ascii?q?BEwEBAQgNCQgpL4I2JIJiAQEBAQIBAQIgBFIFAQkBAQoOCgICGA4CAgNUBg0GA?=
 =?us-ascii?q?gEBARaDBoF6CAQBpwl8M4VAhFeBC4p+gVc/gTiCa4RmgxyCVwKJGYZDgQKOT1U?=
 =?us-ascii?q?HAoophwAeiWGHJyyZSoINTSODPIInFxKOCz4zgQUBAYwhAQE?=
X-IPAS-Result: =?us-ascii?q?A0APAABQ6fdbh0O0hNFjHAEBAQQBAQcEAQGBUQcBAQsBgVW?=
 =?us-ascii?q?CFieDeYgYi32BYC0UlycUgVoxEwGIVyI0CQ0BAwEBAQEBAQIBEwEBAQgNCQgpL?=
 =?us-ascii?q?4I2JIJiAQEBAQIBAQIgBFIFAQkBAQoOCgICGA4CAgNUBg0GAgEBARaDBoF6CAQ?=
 =?us-ascii?q?Bpwl8M4VAhFeBC4p+gVc/gTiCa4RmgxyCVwKJGYZDgQKOT1UHAoophwAeiWGHJ?=
 =?us-ascii?q?yyZSoINTSODPIInFxKOCz4zgQUBAYwhAQE?=
X-IronPort-AV: E=Sophos;i="5.56,269,1539673200"; 
   d="scan'208";a="41290844"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 23 Nov 2018 03:53:03 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2405452AbeKWWg4 (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Fri, 23 Nov 2018 17:36:56 -0500
Received: from bhuna.collabora.co.uk ([46.235.227.227]:59976 "EHLO
        bhuna.collabora.co.uk" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S2387885AbeKWWg4 (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 23 Nov 2018 17:36:56 -0500
Received: from [127.0.0.1] (localhost [127.0.0.1])
        (Authenticated sender: eballetbo)
        with ESMTPSA id 77F5C263BE6
Subject: Re: [PATCH 2/7] mfd / platform: cros_ec: move lightbar attributes to
 its own driver.
To: Guenter Roeck <linux@roeck-us.net>
Cc: lee.jones@linaro.org, gwendal@chromium.org, drinkcat@chromium.org,
        linux-kernel@vger.kernel.org, groeck@chromium.org,
        kernel@collabora.com, bleung@chromium.org,
        Olof Johansson <olof@lixom.net>
References: <20181122113356.23610-1-enric.balletbo@collabora.com>
 <20181122113356.23610-3-enric.balletbo@collabora.com>
 <20181122174151.GA30386@roeck-us.net>
From: Enric Balletbo i Serra <enric.balletbo@collabora.com>
Message-ID: <2c70235f-8f10-de5f-7df5-21104fd371c4@collabora.com>
Date: Fri, 23 Nov 2018 12:52:55 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101
 Thunderbird/60.3.0
MIME-Version: 1.0
In-Reply-To: <20181122174151.GA30386@roeck-us.net>
Content-Type: text/plain; charset=utf-8
Content-Language: en-GB
Content-Transfer-Encoding: 7bit
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Hi Guenter,

On 22/11/18 18:41, Guenter Roeck wrote:
> Hi Enric,
> 
> On Thu, Nov 22, 2018 at 12:33:51PM +0100, Enric Balletbo i Serra wrote:
>> The entire way how cros sysfs attibutes are created is broken.
>> cros_ec_lightbar should be its own driver and its attributes should be
>> associated with a lightbar driver not the mfd driver. In order to retain
>> the path, the lightbar attributes are attached to the cros_class.
>>
>> The patch also adds the sysfs documentation.
>>
>> Signed-off-by: Enric Balletbo i Serra <enric.balletbo@collabora.com>
>> ---
>>
> ...
>>  
>> +int cros_ec_attach_attribute_group(struct cros_ec_dev *ec,
>> +				   struct attribute_group *attrs)
>> +{
>> +	return sysfs_create_group(&ec->class_dev.kobj, attrs);
>> +}
>> +EXPORT_SYMBOL(cros_ec_attach_attribute_group);
>> +
>> +void cros_ec_detach_attribute_group(struct cros_ec_dev *ec,
>> +				    struct attribute_group *attrs)
>> +{
>> +	sysfs_remove_group(&ec->class_dev.kobj, attrs);
>> +}
>> +EXPORT_SYMBOL(cros_ec_detach_attribute_group);
>> +
> 
> Are those two functions necessary ? Why not just call sysfs_create_group
> and sysfs_remove_group directly from the calling code ?
> 

Actually we have cros_ec_dev which registers the cros_ec class, and sysfs/vbc
and lightbar using this cros_ec class. I had problems unloading the different
modules. For example, when I removed cros_ec_dev modules before
cros_ec_sysfs/cros_ec_vbc/cros_ec_lightbar I got a hang.

To solve the hang I did the easy solution that is make these drivers depend on
cros_ec_dev so you're not able to unload cros_ec_dev if first you don't unload
the sysfs/vbc/lightbar.

Thinking again about it, I don't really understand now why failed in the first
place, cros_ec_dev is the parent, so, on remove should call mfd_remove_devices
for the subdevices.

So, let me check again this and I'll back to you.

Thanks,
 Enric


> Thanks,
> Guenter
> 
