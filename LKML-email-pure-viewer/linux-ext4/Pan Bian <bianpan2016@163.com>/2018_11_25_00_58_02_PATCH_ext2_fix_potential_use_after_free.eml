Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 25 Nov 2018 14:43:08 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga007.jf.intel.com (orsmga007.jf.intel.com [10.7.209.58])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 7B09F5803C2;
	Sat, 24 Nov 2018 17:01:21 -0800 (PST)
Received: from orsmga102-1.jf.intel.com (HELO mga09.intel.com) ([10.7.208.27])
  by orsmga007-1.jf.intel.com with ESMTP; 24 Nov 2018 17:01:21 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AMRxjqBLCyltDOpLgNdmcpTZWNBhigK39O0sv0rFi?=
 =?us-ascii?q?tYgUKfT+rarrMEGX3/hxlliBBdydt6oUzbKO+4nbGkU4qa6bt34DdJEeHzQksu?=
 =?us-ascii?q?4x2zIaPcieFEfgJ+TrZSFpVO5LVVti4m3peRMNQJW2aFLduGC94iAPERvjKwV1?=
 =?us-ascii?q?Ov71GonPhMiryuy+4ZLebxlLiTanfb9+MAi9oBnMuMURnYZsMLs6xAHTontPde?=
 =?us-ascii?q?RWxGdoKkyWkh3h+Mq+/4Nt/jpJtf45+MFOTav1f6IjTbxFFzsmKHw65NfqtRbY?=
 =?us-ascii?q?UwSC4GYXX3gMnRpJBwjF6wz6Xov0vyDnuOdxxDWWMMvrRr0yRD+s7bpkSAXwhS?=
 =?us-ascii?q?kHKTA37W/ZhM93gqJauxKhvx5yzpXIbI2JLvdyYrnQcc8GSWdHQ81fVzZBAoS5?=
 =?us-ascii?q?b4YXFeQOJ+BYpJTgqlsPtxS+AxSnCeT0xT9JnHD227U63P4nEQ3YwAAsAtMDvW?=
 =?us-ascii?q?/JoNj0OqoeS/y6zK7NzTjaaf5dxDTz6JDQfxw/vf2BWah8fdffxEUxDQ/Jk1ad?=
 =?us-ascii?q?pZD/Mz6U1OkBq3WX4/ZhWO61lmIrtR19riKxyssxhITFnIYYx1HC+C5k2og6P8?=
 =?us-ascii?q?e4R1R+YdO8EJtfqSWaN4xuT8M8TGFnpjw6xqcFuZGlZigKzoooxxrFZ/yAaYiI?=
 =?us-ascii?q?7QrvVOeXIThmmHJoYKyziwq2/ES61+HxWNe43ExXoidGjtXArHEA2h7L5siCUP?=
 =?us-ascii?q?R9/0Oh2TiV1wDU7+FJOUQ0lavdK548zb88j5kTvlrZHi/whkr2iLaadkIq++iu?=
 =?us-ascii?q?9evneK7rpoGTN4BqkAHyKKculdKlAeQ+LAcOW3KX+eOm1L3s5UH5WqlFjuUqkq?=
 =?us-ascii?q?nFt5DXPcAbpq+6AwBLyIoi5Au/Aiyi0NQZm3kHMV1EdAiGj4jvJ1HBPvT4Ae2j?=
 =?us-ascii?q?jFSrlTdh3+rGMaH5ApXRMnjDl6/sfbZn5E5d1Ao819df64hUCrEcOv3zXEDxuc?=
 =?us-ascii?q?fcDh84NQy03unmBM981oMYRWKAHKuZPLnOvl+P4+IlO/OMa5MNuDbhN/gl4Obj?=
 =?us-ascii?q?jX0+mVADZ6Wp3pwXaHa+HvRhOEiZZXvsgtEcEWYFpAY+TerqiEGcXj5XfXq9Q6?=
 =?us-ascii?q?U85jQjAoK8EYjDXpytgKCG3CqjBJJWfWBGClePEXvybYWLQfUMZTmWIs9glDwE?=
 =?us-ascii?q?SLegR5Ug1RGoqA/11b5nIvDI9S0fsJLpzMJ16PHLlREu6Tx0CNyQ02KXQGFyhG?=
 =?us-ascii?q?8IQz4207p5oUxy0VqD1al4g/pFFd1c/f9JUwE6NYLCwOx+Edz9RgXBftKRQla8?=
 =?us-ascii?q?XtqmGS0xTs42w9IWfklyAcuigQ7Z0yqqGbAVkaeLC4Iy8q7b23jxJMN9y3Ld2a?=
 =?us-ascii?q?kljlkmRNZPNGK8iq5+8QjTG5DGk0GDm6m2cqQc2TbH9H2fwmqWoEFYTAlwXL3Y?=
 =?us-ascii?q?Un8FeEvZs8715kPYQL+oErQoLA1BxNWGKqtLbN3pkFpHSO3iONTYf2K+hWOwCQ?=
 =?us-ascii?q?yUybOLaYrgY38d0znFCEgYjwAT+m6LNRQ/BiekpGLeEDxuFFL1b0Pw6+V+r2m7?=
 =?us-ascii?q?Tks1zwGMYE1szL61+h8ThfyBRPIfxLMEuCE9qzpqGFaxxc7ZC92FpwB5ZqVTfc?=
 =?us-ascii?q?s94Etb1WLerwFyJJigIL5th1EAcwV7pVjh1whqBYpal8gqr3QqzBRpJKKc0VNB?=
 =?us-ascii?q?cS6Y3J/qNr3WLGny4A6ga6rM1l7C19aW/78F6O4kpFX7oAGpCk0i/m1n0tlIyX?=
 =?us-ascii?q?eT+o/GDQsSUZ3rVEY3+AN3p7XbYik7+oPV2mdgMaiysj/exd0pAPEpxQqnf9da?=
 =?us-ascii?q?KKmEDhP9E9UGB8iyL+wng0KpbhMYM+9I7q47IsSme+GA2KG1JuZgnSuqgnhd74?=
 =?us-ascii?q?B5z02D6TB8SunO35sex/GY3w2HVyrzjVu7s8D3n5xEai8WHmal1SfkA4tRbLVo?=
 =?us-ascii?q?fYkXEWeuP9G3xtJmip/tWn5U7l6iC0kd2M+0fxqfdFj93QxW1UQKrn2rgyq4zz?=
 =?us-ascii?q?pokz43qqqTxjDBw+PndBAfIG5EWHFijUvwIYizl90aXlKnbxIqlBum4kb23bNb?=
 =?us-ascii?q?q758L2nQQEdIeTb5L2d5X6u0t7qCZdNP6ZwyvSVWVuS8fU6VSrrnrxQG1CPjGn?=
 =?us-ascii?q?NUxConeDGyppX5gxt6hXqdLXlpq3rVY8NwxRbZ5NHHQf5R3zwGRDR3iDXNB1i8?=
 =?us-ascii?q?OcWp8suQl5vZru++UGehXIVJcSb31YOAqDe75WpyDB28hf+zm8frEQgn0SDh0d?=
 =?us-ascii?q?lqWj7FrBL9YontyqS7PvhrfkhuBF/g9cV6HptynZc3hJEVwXIanIma/WIbkWfv?=
 =?us-ascii?q?NtVWwaf+bHsORTER2dLU7hbq2FZ/Ln2X3YL2TWuSwtFuZ9ShZmMW2yQ9791FCa?=
 =?us-ascii?q?uO7bxEmzd1rUS8rQ7Lffd9mTIdw+M06HEGm+EJpBYtziKFD7AOGklYODbglhWS?=
 =?us-ascii?q?4NC4saVXf32vcbmr2Up6nNChCqyCow5GVHb4fJciATF/7sFlPF3Q133z75nueM?=
 =?us-ascii?q?PMYtILqh2UjxDAgvBOJ50rkfoKgTdnNXj5vX040OM7iR1u3ZenvImIMWlt/aS5?=
 =?us-ascii?q?AgJGOT3xfc8c5jbtjaNGlMaMw4+vBolhGikMXJbwT/KnCjcSuur8NwqUDD0wsH?=
 =?us-ascii?q?SbGafcHQ+C7kdptWnPHouvN3GWInkZ0NpjSAOcJExZnAAbQjE6koQlGQCtwczr?=
 =?us-ascii?q?aF156SwJ5l7kthtMzfplNhn4UmfCvQeody07SJ6FIBpN6QFC4UjVPNea7uJyGS?=
 =?us-ascii?q?FY45KgoBaMKmydewRHE2UJVlaYCFDkO7mk/cPA/PSABuqiM/vOZq2DqexAWPeJ?=
 =?us-ascii?q?xpKv0Ypm8yyPNsWVOXliAOM02lBeXXBiAMnZnzQPSyoKlyPCdcKbpRG8+jFpoc?=
 =?us-ascii?q?C76vjkRAXv5Y6XAbtILdpv4wy2gbuEN+OInil5NC1X1okSyn7I0rQf2F8Shjpq?=
 =?us-ascii?q?dzmsF7QAqCHMQLjRmq9REx4UdSdzONFU4KI72wlHIdTbhc/t1r5kkv41DE9IVU?=
 =?us-ascii?q?DgmsGsf8AFP3uxO0/HBEmVMrSLPjnLw8DxYaOhRrxcluRUtxusuTmFF0/vJCiM?=
 =?us-ascii?q?lz7sVxq3K+FDkDmbPABCuIG6ahtsCXLsTNTjah26Nt94lTw3wb0uiXPMOm4RKj?=
 =?us-ascii?q?x8c0JLrr2N4iJUmPR/G2pd7nV7KemIgTqW7+7dKsVejfw+IC1y38FT+n1yn7lc?=
 =?us-ascii?q?5yJsX+FulW3Zqds48H+8leza8jNhGDBPozAD0IiKtEN6MKODrsAecS+ap1QG6m?=
 =?us-ascii?q?DGWEdCnMdsFtC64/MY8dPIjq+mcDo=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AVAAD08/lbh0O0hNFiHQEBBQEHBQGBU?=
 =?us-ascii?q?QgBCwGDaycKjAeMAIIhiGUkhTiIZ4F1KhMBiFoiNAkNAQMBAQEBAQECARMBAQE?=
 =?us-ascii?q?IDQkIKSMMgjYigmwCJBkBATcBBQkCGDgDWhMFgxyBaQEDFAEFo0qBbDOCdgEBB?=
 =?us-ascii?q?YJDgWoBSQSCGgiHXoQrghaIaoYSgSwBAQGOYo9kDgEGAgF6XI9bFolShzUBmXa?=
 =?us-ascii?q?CDU0jgW6BToIbg22KXzQxgQQBAQEhiXCBLgGBHgEB?=
X-IPAS-Result: =?us-ascii?q?A0AVAAD08/lbh0O0hNFiHQEBBQEHBQGBUQgBCwGDaycKjAe?=
 =?us-ascii?q?MAIIhiGUkhTiIZ4F1KhMBiFoiNAkNAQMBAQEBAQECARMBAQEIDQkIKSMMgjYig?=
 =?us-ascii?q?mwCJBkBATcBBQkCGDgDWhMFgxyBaQEDFAEFo0qBbDOCdgEBBYJDgWoBSQSCGgi?=
 =?us-ascii?q?HXoQrghaIaoYSgSwBAQGOYo9kDgEGAgF6XI9bFolShzUBmXaCDU0jgW6BToIbg?=
 =?us-ascii?q?22KXzQxgQQBAQEhiXCBLgGBHgEB?=
X-IronPort-AV: E=Sophos;i="5.56,276,1539673200"; 
   d="scan'208";a="54661841"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 24 Nov 2018 17:01:19 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1726754AbeKYLsA (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Sun, 25 Nov 2018 06:48:00 -0500
Received: from m12-16.163.com ([220.181.12.16]:54106 "EHLO m12-16.163.com"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1726323AbeKYLsA (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Sun, 25 Nov 2018 06:48:00 -0500
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=163.com;
        s=s110527; h=From:Subject:Date:Message-Id; bh=m5M4DMmmfC8+Hxib1I
        vpkBcysAcYi1Haj5CF53szmUY=; b=M5Rr+4osRIjWtlEQUR6z3UnVr+uw33S4oH
        GKRmKWFTMTeRjkYbEABpLI0EQUxfSekRGbzGT0ogLkdOjNum2wmL1TFA7fXo/Grz
        XTAp78fowzZiDzJX8HaZ9q0c28TahwBvn976mTKSJhQRnDbs8+QgFo9hco+wbqlX
        Y0mD1hHPE=
Received: from bp.localdomain (unknown [106.120.213.96])
        by smtp12 (Coremail) with SMTP id EMCowADHV1ef8_lbtG7IBg--.31384S3;
        Sun, 25 Nov 2018 08:58:10 +0800 (CST)
From: Pan Bian <bianpan2016@163.com>
To: Jan Kara <jack@suse.com>
Cc: linux-ext4@vger.kernel.org, linux-kernel@vger.kernel.org,
        Pan Bian <bianpan2016@163.com>
Subject: [PATCH] ext2: fix potential use after free
Date: Sun, 25 Nov 2018 08:58:02 +0800
Message-Id: <1543107482-97334-1-git-send-email-bianpan2016@163.com>
X-Mailer: git-send-email 2.7.4
X-CM-TRANSID: EMCowADHV1ef8_lbtG7IBg--.31384S3
X-Coremail-Antispam: 1Uf129KBjvdXoWrtFWkZFyDtrW8Cw1UuryxuFg_yoW3Xwb_Ka
        4UJw4Ikrs5GrZYq3WxAFWYy3Z5Kas5Ar1rur4rGr13ZayUtFZ7ZFyDXrWfZr15Xw47Gan8
        WF4kXry3ArWIgjkaLaAFLSUrUUUUUb8apTn2vfkv8UJUUUU8Yxn0WfASr-VFAUDa7-sFnT
        9fnUUvcSsGvfC2KfnxnUUI43ZEXa7IU0ubyJUUUUU==
X-Originating-IP: [106.120.213.96]
X-CM-SenderInfo: held01tdqsiiqw6rljoofrz/1tbiVBoKclUMGJWYxQAAs-
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

The function ext2_xattr_set calls brelse(bh) to drop the reference count
of bh. After that, bh may be freed. However, following brelse(bh),
it reads bh->b_data via macro HDR(bh). This may result in a
use-after-free bug. This patch moves brelse(bh) after reading field.

Signed-off-by: Pan Bian <bianpan2016@163.com>
---
 fs/ext2/xattr.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/fs/ext2/xattr.c b/fs/ext2/xattr.c
index 62d9a659a..dd8f10d 100644
--- a/fs/ext2/xattr.c
+++ b/fs/ext2/xattr.c
@@ -612,9 +612,9 @@ bad_block:		ext2_error(sb, "ext2_xattr_set",
 	}
 
 cleanup:
-	brelse(bh);
 	if (!(bh && header == HDR(bh)))
 		kfree(header);
+	brelse(bh);
 	up_write(&EXT2_I(inode)->xattr_sem);
 
 	return error;
-- 
2.7.4


