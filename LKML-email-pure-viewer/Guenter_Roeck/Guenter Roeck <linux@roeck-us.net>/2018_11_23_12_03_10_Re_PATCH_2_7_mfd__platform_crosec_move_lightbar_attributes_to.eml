Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 23:34:48 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga005.jf.intel.com (orsmga005.jf.intel.com [10.7.209.41])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 06A575803EB;
	Fri, 23 Nov 2018 04:03:28 -0800 (PST)
Received: from orsmga102-1.jf.intel.com (HELO mga09.intel.com) ([10.7.208.27])
  by orsmga005-1.jf.intel.com with ESMTP; 23 Nov 2018 04:03:27 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3ARUVfJhA9VV6wCz5GhvguUyQJP3N1i/DPJgcQr6Af?=
 =?us-ascii?q?oPdwSP7+pcmwAkXT6L1XgUPTWs2DsrQY07qQ6/iocFdDyK7JiGoFfp1IWk1Nou?=
 =?us-ascii?q?QttCtkPvS4D1bmJuXhdS0wEZcKflZk+3amLRodQ56mNBXdrXKo8DEdBAj0OxZr?=
 =?us-ascii?q?KeTpAI7SiNm82/yv95HJbAhEmDmwbaluIBmqsA7cqtQYjYx+J6gr1xDHuGFIe+?=
 =?us-ascii?q?NYxWNpIVKcgRPx7dqu8ZBg7ipdpesv+9ZPXqvmcas4S6dYDCk9PGAu+MLrrxjD?=
 =?us-ascii?q?QhCR6XYaT24bjwBHAwnB7BH9Q5fxri73vfdz1SWGIcH7S60/VC+85Kl3VhDnlC?=
 =?us-ascii?q?YHNyY48G7JjMxwkLlbqw+lqxBm3oLYfJ2ZOP94c6jAf90VWHBBU95MWSJfDIOy?=
 =?us-ascii?q?b4gBAeQPMulXrYbyu1QArQCmBQSuH+7v1j1Fi2Xq0aEm3eksEwfL1xEgEdIUt3?=
 =?us-ascii?q?TUqc34OqYPUe+ryqnI0SvMb+lL0jnh74jHbAwuofKRVr93dcrRyE8vFx7Kj1iL?=
 =?us-ascii?q?s4zlOC2a2fgOs2SC8upgTviji2g5pAFtuzWiwNonhIrRho8N1FzI6SF0zJwoKd?=
 =?us-ascii?q?C2VkJ3e8OoHZhMuy2ANoZ7QNsuT39ptSom1rELvIO3cSoWxJg7whPQdfKKf5aV?=
 =?us-ascii?q?7h/mVeudPzl4iG5gdb+xmRq/9VSvx+jiWsS63lZKoC9IktfSuX8T2RHe78yKRe?=
 =?us-ascii?q?Z/80i93zuEyhrd5fteIU8ukKrWM54hzaA0lpoUqUnDACD2l1vsjKOMdUUr5PKo?=
 =?us-ascii?q?6+L5bbXivJOcMJV0ig7mPqQvnMywH/g4PxAQU2SH/emwzqDv8EPnTLlQk/E7kb?=
 =?us-ascii?q?XVvIrbKMkZvqK5BhVa0ocn6xaxFTem19EYkGEDLFJEfhKHkofoN0jNIP/mF/e/?=
 =?us-ascii?q?hUqjkDNyy/DBMLzhBIvCLmLYnbf/crZy9VRcxBAwzd9B/ZJUDK8OIPbpVk/2rt?=
 =?us-ascii?q?zYAQc1MxaozOb/FNV9yoQeVHqLAq+YM6Pdr0WE5+0yI+SXYI8VuTD9K+Uq5vL0?=
 =?us-ascii?q?jH85n0Mdcret3ZcNdH+4GfFmKV2DYXXwmtcBDXsKvg0mQezqklKCUCJTaGy1X6?=
 =?us-ascii?q?4m5jE7FZipDYHMRo22hLyB3SG7HoBZZ2xcC1CMF2voeJuAW/sWdC2SJcphmCQe?=
 =?us-ascii?q?Vbe9U48hyQ2utAjixrplKerb5DcUtZHk1Nhz4e3Tkgo/9Th1D8SbzmGMQHt4nm?=
 =?us-ascii?q?IORz8qwq9/pVZxxUuE0ah9m/ZYD8Bc5+tVUgcmMp7R1/Z1C8vyWgLGfdeFUkym?=
 =?us-ascii?q?Tc+kATwqStIxwtkOY1tyGtm4jxDD2TaqDKERl7CRGJM09afc1WDrJ8lh03bGyL?=
 =?us-ascii?q?Uhj14+T8tML2KmgLRz9wzSB4HTlUWZmL2ndaAd3C7L6WeCwnCCvEBeUA5sT6rF?=
 =?us-ascii?q?WWoTaVfRrdT8/knCVaOhCaw7Mgtdzs6PMrZFZcf3jVpYXvvjOM7RY2Sqm2iuAx?=
 =?us-ascii?q?aEwbeMbInve2UZxyjdDEkEkwYO/XeJLwQ+ByGho37AAzxqD17gf0Ts8exmonOh?=
 =?us-ascii?q?UkA01x2Kb1Fm17et5xEan+KcRO0J0rIEoighrS50E0i739/ND9qApgxhfLhTYN?=
 =?us-ascii?q?8n4VdH037ZuBJ5PpC6M69igVseeRxtv0zyzxV3FplAkc8yoXM2zQpyLKWY0E9B?=
 =?us-ascii?q?dzKYx5zwJqfbKm7o/BCraq7W3F7e3c2S+qcO7vQ4tlrisBuoFkok73Vozd1V32?=
 =?us-ascii?q?GA6ZXNCQoYSYjxXVov9xhmu7HaZTEw6JnQ1XJyPqi7rD/D18gyC+s41xmvZdFf?=
 =?us-ascii?q?MKCDFA/sCMAaA8muKOo3m1mmdB4EPeZS9LIqMMOibfeJxKmrPON4ljK8kWtH+J?=
 =?us-ascii?q?x90l6L9ydkSu/IwowJzO2C0gqGVzfzllGhss/slIBAZDESGHe/yCf+CI5QYK1y?=
 =?us-ascii?q?YZgECWO0L8KrwdV+gobnW2RE+167G1MGxMipdAKIb1z8wQJfz14XrmGgmSeiyT?=
 =?us-ascii?q?x7jSsprquG0CPS2evicAcINXBRRGlli1fhOoy0j9EcXEi1YAkljhql5UDmx6dF?=
 =?us-ascii?q?oKRzNXXcQUBNfyLuNWFtTrOwtqaeY85I8J4psSRXXP68YFyAUb79vh0a3jjnH2?=
 =?us-ascii?q?tfwjA7aj6rto/4nxx8lGKSMnJzoGDFdsF3wBfV/MbcSuJJ3joaWCl4jiHaBlqm?=
 =?us-ascii?q?MNmz/tWUlJDDvvqlV227VZ1TcijrzYWeuyu9/mBqBRy/n/aumtzoCwQ60Cn718?=
 =?us-ascii?q?V0WiXMthrzfo7r16GiO+J9YkZoHEP869Z9Goxmkoo/npYQ1WIYhpWU+3oKimPz?=
 =?us-ascii?q?MdRd2aLjY3sBXz8Lw9jJ4Af73E1vNG6Gx4X8Vn+F2Mtue8G6Yn8K2iI6981KC7?=
 =?us-ascii?q?2b7L1ekSt1v1q3twTRYfdmkzcZyPsu7mMagu4TtAosyCWdHq4dHU1CMSPwkBSI?=
 =?us-ascii?q?6si0rL9La2a3bbiwyE1+kMikDLGDoQFTQmz1e5k8Ei9r8sVwLkjM32bt5YH+d9?=
 =?us-ascii?q?nddtYTthySkxfdgOlZMpMxlvwWhSV5PWLxp2Eqy+k+jRZ2x5G1oJCHK3lx/KK+?=
 =?us-ascii?q?GhNYKjr1Z8YJ9jDsl6lemNuW35u0HpVgATgLWJroTfS1EDMdr/jnNgCOECEipX?=
 =?us-ascii?q?efA7bQAQif6EJ+pXLVD5+rL22XJGUezdh6XxaSPktfgAQJXDkgmp45CxunxMjg?=
 =?us-ascii?q?cEd/+zAQ6UT0qhpKyuJ0KRb/Vn3TqxuvajcxUJKfNgZZ7hle50fJNsyT9uBzED?=
 =?us-ascii?q?td/pK/twyBMHCbax5LDWEUWUyEGlbjMaO15dTb9+iYB+y+L+bBYLmUqOxeUeuI?=
 =?us-ascii?q?yoyr0od84zmMMcCPNGF4D/InwkpDQWx5G8PBljQPTCwXijvNb9OBqxe64CF3tc?=
 =?us-ascii?q?e/8PLkWA/04YuPCr1SMchg+hysgKeDMfKQizh9KTpCypwMwnrIwqAF3FEOkyFu?=
 =?us-ascii?q?ayWtEbMYuC7NUq3Qm6xXDx0aay9pN8tI9aU83gZTNs7Bl9P1zaV1jvo0C1dDSF?=
 =?us-ascii?q?zgldulZc0MI2GhKlzHAFyHO6iBJT3O28v3e7+zSaVMjOVIsB29oSyUE1L4MTSZ?=
 =?us-ascii?q?iTboVwqjMeVNjCyAOBxeuYe9cgtiCGT5TdLmbAG7P8FzjTEs3bI0gXbKP3YGMT?=
 =?us-ascii?q?dga0NNsqGQ7SRAj/VjGmxB62BpIvWelymF7+nXNJAWvOBvAiR1keJa/Xs7x6FU?=
 =?us-ascii?q?7CFCWPx6hi/SosRyrFGhl+mF0iBnXwZWqjZXmIKLul1vOKXD+ZlGXHbE/RQN4n?=
 =?us-ascii?q?2RChQKvdRlDNLvtrtUytjOkqLzNThD/8jV/csaG8jbNsaHPGA9PhruHT6HRDcC?=
 =?us-ascii?q?GBOtL2DUz2ZUlPWf6neS5plykZX2gpNGHrJdTl0+UPkTDkBoANYFCJxwWjctm7?=
 =?us-ascii?q?mBhYgD4n/o/zfLQ8APkY3KUO6fG73VLzuSjvEQYxoO3KPQN4MePY6+xlckbFRm?=
 =?us-ascii?q?yteZU3HMVMxA93UyJjQ/p19ApT0nFjU+?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ANAADc6/dbh0O0hNFZChwBAQEEAQEHB?=
 =?us-ascii?q?AEBgVEHAQELAYEwgjsng3mIGIt9gWAIJRSXJxSBXRQBARgTAYhXIjQJDQEDAQE?=
 =?us-ascii?q?BAQEBAgETAQEBCA0JCCkjDII2JAGCYQEBAQECAQECIAQRCAE4AQMBAQkBAQUFG?=
 =?us-ascii?q?AICJgICAzEBBQEcBg0GAgEBARaDBoFqAw0IAQSbRTyLDXwzgncFgkSCMQ2CEQI?=
 =?us-ascii?q?GEnmJYoEcF4F/gTgMgl+EUxODHIJXAokZhkM0To5PVQmGP4NqhwAeiVGHNyyXX?=
 =?us-ascii?q?QIEAgQFAgUPIYElgg0zGggmCoMnghsMFxKDOIpzHzKBBQEBjCEBAQ?=
X-IPAS-Result: =?us-ascii?q?A0ANAADc6/dbh0O0hNFZChwBAQEEAQEHBAEBgVEHAQELAYE?=
 =?us-ascii?q?wgjsng3mIGIt9gWAIJRSXJxSBXRQBARgTAYhXIjQJDQEDAQEBAQEBAgETAQEBC?=
 =?us-ascii?q?A0JCCkjDII2JAGCYQEBAQECAQECIAQRCAE4AQMBAQkBAQUFGAICJgICAzEBBQE?=
 =?us-ascii?q?cBg0GAgEBARaDBoFqAw0IAQSbRTyLDXwzgncFgkSCMQ2CEQIGEnmJYoEcF4F/g?=
 =?us-ascii?q?TgMgl+EUxODHIJXAokZhkM0To5PVQmGP4NqhwAeiVGHNyyXXQIEAgQFAgUPIYE?=
 =?us-ascii?q?lgg0zGggmCoMnghsMFxKDOIpzHzKBBQEBjCEBAQ?=
X-IronPort-AV: E=Sophos;i="5.56,269,1539673200"; 
   d="scan'208";a="54526059"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 23 Nov 2018 04:03:18 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2504083AbeKWWrL (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Fri, 23 Nov 2018 17:47:11 -0500
Received: from mail-pg1-f195.google.com ([209.85.215.195]:43518 "EHLO
        mail-pg1-f195.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S2388025AbeKWWrK (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 23 Nov 2018 17:47:10 -0500
Received: by mail-pg1-f195.google.com with SMTP id v28so3003457pgk.10
        for <linux-kernel@vger.kernel.org>; Fri, 23 Nov 2018 04:03:13 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=sender:subject:to:cc:references:from:message-id:date:user-agent
         :mime-version:in-reply-to:content-language:content-transfer-encoding;
        bh=gXp7B0C6OpQdpsPvWbXiKDMl2kXbdFO+2j6/Vh1h1zQ=;
        b=PMGLIOJ14XlNaOFEUpQp809l2Ya5ujEEz2G++FfOHb104/aSu+GA488umDIQUOaZE6
         4Mc9499elPZHjkE7k1Svd3VAxlIPaV+wsD1fGfiZuocq6vCYciVCf489x7+vU3T5YcDb
         4dWCFgQserVGVgd6tmR0d/It//4h5wShWqwdYrRMcjfcW7B8/82EmB1vNFhf3SKBGHdT
         Ym34cFT9DQNs0EzDHxk9szuGfM33lDIXRMdfij4mAxUrGDjn3V1h5NegB2qu6gholYgX
         sQUPix1pgQngQZBPy9OGEeA5bihKmo6cTOctHGpew3LKR5X/R4iwh5Y2bp7ToO0hyNey
         3iug==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:sender:subject:to:cc:references:from:message-id
         :date:user-agent:mime-version:in-reply-to:content-language
         :content-transfer-encoding;
        bh=gXp7B0C6OpQdpsPvWbXiKDMl2kXbdFO+2j6/Vh1h1zQ=;
        b=mHL+Tdi8Hfos5zUN008frxSbTYvySFn//A8nErjuOMo3/zaQ83a6VKQZbx13ftOMbz
         VR6eBrZHWJm4wuWLuuT/ojNwS7v0DR1kDDzqZ8FhpFpSBMDTSiB+Z+ApDh2hHiiHZUCv
         BCw2f0mlCy8+nDYlWqcrW0pD3G9W4+pm41orczQGQKtLKsQ6nbOHxz/q98JAXq1Y4nF3
         8StSgz0dLYbg0v8XXRJo5Q6XfdxUCnLaNzsRwyO6XZtn8qyX+dgSPC6kCI/1Ds3guxRX
         4gVG3CI5Evi4Ung137VuAxIwA4PSCHTTcZy9p7GXSJIpSa4Y8vQMtAuSQnlt2/vt8FKe
         hM9g==
X-Gm-Message-State: AGRZ1gJ3fuNKQ8/yTNFdoUjr18Iw5wigMzkTlO9RLJ5bscv2XbwizZ6Z
        0jlq8oWJCNIt/8ARqcV5ex8=
X-Google-Smtp-Source: AJdET5cUhfDgL6xyPJUU24Qrs1/6TLylYVzq5St5X/B0HprcXS2rImnY/EPlwTRqSXqk/f0vhb6BeQ==
X-Received: by 2002:a62:e501:: with SMTP id n1-v6mr15591095pff.71.1542974592844;
        Fri, 23 Nov 2018 04:03:12 -0800 (PST)
Received: from server.roeck-us.net ([2600:1700:e321:62f0:329c:23ff:fee3:9d7c])
        by smtp.gmail.com with ESMTPSA id v70sm18248692pfa.152.2018.11.23.04.03.11
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Fri, 23 Nov 2018 04:03:12 -0800 (PST)
Subject: Re: [PATCH 2/7] mfd / platform: cros_ec: move lightbar attributes to
 its own driver.
To: Enric Balletbo i Serra <enric.balletbo@collabora.com>
Cc: lee.jones@linaro.org, gwendal@chromium.org, drinkcat@chromium.org,
        linux-kernel@vger.kernel.org, groeck@chromium.org,
        kernel@collabora.com, bleung@chromium.org,
        Olof Johansson <olof@lixom.net>
References: <20181122113356.23610-1-enric.balletbo@collabora.com>
 <20181122113356.23610-3-enric.balletbo@collabora.com>
 <20181122174151.GA30386@roeck-us.net>
 <2c70235f-8f10-de5f-7df5-21104fd371c4@collabora.com>
From: Guenter Roeck <linux@roeck-us.net>
Message-ID: <2ca66046-b5eb-6c3a-3559-a12dd869ebbf@roeck-us.net>
Date: Fri, 23 Nov 2018 04:03:10 -0800
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101
 Thunderbird/60.2.1
MIME-Version: 1.0
In-Reply-To: <2c70235f-8f10-de5f-7df5-21104fd371c4@collabora.com>
Content-Type: text/plain; charset=utf-8; format=flowed
Content-Language: en-US
Content-Transfer-Encoding: 7bit
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 11/23/18 3:52 AM, Enric Balletbo i Serra wrote:
> Hi Guenter,
> 
> On 22/11/18 18:41, Guenter Roeck wrote:
>> Hi Enric,
>>
>> On Thu, Nov 22, 2018 at 12:33:51PM +0100, Enric Balletbo i Serra wrote:
>>> The entire way how cros sysfs attibutes are created is broken.
>>> cros_ec_lightbar should be its own driver and its attributes should be
>>> associated with a lightbar driver not the mfd driver. In order to retain
>>> the path, the lightbar attributes are attached to the cros_class.
>>>
>>> The patch also adds the sysfs documentation.
>>>
>>> Signed-off-by: Enric Balletbo i Serra <enric.balletbo@collabora.com>
>>> ---
>>>
>> ...
>>>   
>>> +int cros_ec_attach_attribute_group(struct cros_ec_dev *ec,
>>> +				   struct attribute_group *attrs)
>>> +{
>>> +	return sysfs_create_group(&ec->class_dev.kobj, attrs);
>>> +}
>>> +EXPORT_SYMBOL(cros_ec_attach_attribute_group);
>>> +
>>> +void cros_ec_detach_attribute_group(struct cros_ec_dev *ec,
>>> +				    struct attribute_group *attrs)
>>> +{
>>> +	sysfs_remove_group(&ec->class_dev.kobj, attrs);
>>> +}
>>> +EXPORT_SYMBOL(cros_ec_detach_attribute_group);
>>> +
>>
>> Are those two functions necessary ? Why not just call sysfs_create_group
>> and sysfs_remove_group directly from the calling code ?
>>
> 
> Actually we have cros_ec_dev which registers the cros_ec class, and sysfs/vbc
> and lightbar using this cros_ec class. I had problems unloading the different
> modules. For example, when I removed cros_ec_dev modules before
> cros_ec_sysfs/cros_ec_vbc/cros_ec_lightbar I got a hang.
> 
> To solve the hang I did the easy solution that is make these drivers depend on
> cros_ec_dev so you're not able to unload cros_ec_dev if first you don't unload
> the sysfs/vbc/lightbar.
> 

That seems like a side effect of the callbacks, which may increase the use count
of cros_ec_dev. If the lack of these callbacks causes problems, we should identify
the root cause and fix it, and not depend on side effects of a callback.

Thanks,
Guenter

> Thinking again about it, I don't really understand now why failed in the first
> place, cros_ec_dev is the parent, so, on remove should call mfd_remove_devices
> for the subdevices.
> 
> So, let me check again this and I'll back to you.
> 
> Thanks,
>   Enric
> 
> 
>> Thanks,
>> Guenter
>>
> 

