Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 08:31:00 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga007.fm.intel.com (fmsmga007.fm.intel.com [10.253.24.52])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 33C96580460;
	Thu, 22 Nov 2018 11:25:52 -0800 (PST)
Received: from fmsmga101.fm.intel.com ([10.1.193.65])
  by fmsmga007-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 22 Nov 2018 11:25:51 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3A2CrpjxTI81W0zaj+yApOf+GjMNpsv+yvbD5Q0YIu?=
 =?us-ascii?q?jvd0So/mwa64YRaCt8tkgFKBZ4jH8fUM07OQ7/iwHzRYqb+681k6OKRWUBEEjc?=
 =?us-ascii?q?hE1ycBO+WiTXPBEfjxciYhF95DXlI2t1uyMExSBdqsLwaK+i764jEdAAjwOhRo?=
 =?us-ascii?q?LerpBIHSk9631+ev8JHPfglEnjWwba9xIRmssQndqtQdjJd/JKo21hbHuGZDdf?=
 =?us-ascii?q?5MxWNvK1KTnhL86dm18ZV+7SleuO8v+tBZX6nicKs2UbJXDDI9M2Ao/8LrrgXM?=
 =?us-ascii?q?TRGO5nQHTGoblAdDDhXf4xH7WpfxtTb6tvZ41SKHM8D6Uaw4VDK/5KpwVhTmlD?=
 =?us-ascii?q?kIOCI48GHPi8x/kqRboA66pxdix4LYeZyZOOZicq/Ye94RWGhPUdtLVyFZDI2y?=
 =?us-ascii?q?b5UBAfcCM+ZWoIbyu0YBohmwCgm3HOPiyCRFhmPq0aAgz+gtDRvL0BImEtkTsH?=
 =?us-ascii?q?rUttL1NKIKXO600anH0zPDb+9I1jfn9YPGbhchru+QUrJzbMHczk0vFwLDjlWN?=
 =?us-ascii?q?po3oJCmV1uMTvGeH7OpsTP+vi3U9pwF3vDev2t4hh4/UjYwW0lDJ7Tt1zJoxKN?=
 =?us-ascii?q?GiVUJ2b8CoHIFNuyyZK4d6WMIvTmNwtCoky7AKpYK3cS0XxJkl2xLTd/mKfJaG?=
 =?us-ascii?q?7x79SeqcJDZ1iGxreL6jghu//1asx+ngWcSxzlpHoCRFktfJu3ADyRPc9MaKR/?=
 =?us-ascii?q?5580i82zuAywbe4fxeL08uj6rUMZshz6YwlpUNtUTDGTf7mFv5jKCIbEUo4Ouo?=
 =?us-ascii?q?5Pr9YrXguJCcM5V4igbkMqQhgsC/AOI4PRYSX2WD5+iwyLnu8VfkTLhEkPE6iL?=
 =?us-ascii?q?TVvZPGKcgBp6O0ARdZ0oM55Ba+Czem3s4YnX4CLF9dfBKHjo7pO0zBIfzhDvew?=
 =?us-ascii?q?nU6skDF1yPDCJ7HhBZvMLn7dn7f7Zrt99UFcxxQpzdxF5JJbFKsBIPTtVU/1rt?=
 =?us-ascii?q?DYCQU5MwOsz+b9FNp9zp8eWX6IAqKBNKPSsFyI6fw1L+iDeY8YozL9K/kj5/7z?=
 =?us-ascii?q?gn41g14dfa+13ZQJbHC0BOhpI0KcYXD0mNcODX8KvhYiTOztkFCCUSRcZ3euX6?=
 =?us-ascii?q?0m4TE3EoKmDZrZSYCrj7yMxyO7HpxQZmBbBVGAC3bod4OYW/gSbCKeONNukjsB?=
 =?us-ascii?q?VbK5UY8uyQmutBPmy7pgNufU+CoYuoz52Nh24O3Tkxcy9TtvAsSZ0mGNSXx0n2?=
 =?us-ascii?q?wSSz832qB/vVJyylOZ3adkhPxYEMRZ5+lVXQciKZ7c0+t6BsjoVQLafteJT1Wm?=
 =?us-ascii?q?Ts+8AT4rTNI82NsOY0d7G9W/gRHPxSuqA7kJl7OVAJw46L7T33/0J8xl0XbJyL?=
 =?us-ascii?q?Ehj0U6QstILWCmhbRw9w7JC47NkkWWjaCqdasH0S7J9WeDy3eOvU5CXA5xV6XF?=
 =?us-ascii?q?QW4QZk/Modvl4UPCSqekCa47PQtZ1c6CNqxKZ8X0glpcWvfsJs7SY2KrlGe2Hh?=
 =?us-ascii?q?aH2LWMYI3ue2Ue2SXdDFMJkwQS/XaAKAg/CT2to2PYDDxyC13vZ1ng/vV5qHO+?=
 =?us-ascii?q?VkU01R2Fb1V917qp/R4YneGTROkN3r0aoishqy97HFCm393IDdqNvA5hfKRaYd?=
 =?us-ascii?q?Mg71ZLz2PZtwphPpO+K6BunEIRcwNyv0n2zRV4Fp1AkdQ2rHMt1AdyNaOY0FZG?=
 =?us-ascii?q?dzOE3ZDxOqfbKnXo8BCoca7W3lDe0NCZ+qoU7PQ4qlPjvBymF0Y48nVn1cVV3G?=
 =?us-ascii?q?WY5pnQEAUSVpfxWF4t9xdmv7HafjU954TM2HJ2Nam7rDDD1MwpBec/0RmgYspQ?=
 =?us-ascii?q?P7mCFA/xFM0aGdOjKOgrm1ivcxIFM/pe9K8yP8O6afSG3LSnM/pnnDKjlW5H+p?=
 =?us-ascii?q?xy0lqQ9ypgTe7Fx5YEw+yC0gSbTTv9jVehvdrxmYBLfjwSGmu/yS75BI9efKFy?=
 =?us-ascii?q?fIALCXuwLM2z3Nlxm5ntW3tA/l65G1wGwNOpeQaVb1Hlxw1Q1FgYrma9mSSlyD?=
 =?us-ascii?q?x4iTcpobSF3CzP2ujtaAAIOmpWS2Z8l1fsJo60gsseXEipaQgpiRSk6Vz7x6hd?=
 =?us-ascii?q?uKRwMW3TTV1UcCjxKmFoSrGwuaaaY85T9JMotj1aUeS9YVyASr/xuQAa0z7lH2?=
 =?us-ascii?q?ZFwDA7djequoj2nhBgiWKdKmpzo2Tdec1q2Rjf49ncT+ZL3jUaXCl4lSXXBl+k?=
 =?us-ascii?q?Mtmr59qUjZTDsuO5V267TZ1cayrrzYCBtCu9+2JqBwayn/Symt3hDAg73jX319?=
 =?us-ascii?q?hsVSXUshn8ZpPn2Li9MeJiZkNoHkPz69JmGoFilYs9nJER1mIdhpmP/3oHkGHz?=
 =?us-ascii?q?PM5f2aL/anoNWDEKz8TU4AjjxE1sMHaJy5jlWXWax8trf8O6bX8O2iIh88BKD7?=
 =?us-ascii?q?+Z7L9ekit0uFa4rR/RbuJ7njcS0vYu7H8ag+cUuAsi1CmdA7YSHVVGMizojRiH?=
 =?us-ascii?q?89e+rKBPbma1bbewzFZ+ncymDLyapwFcWXX5dY04ES5+8Mp/K07M32Pp6o7/Zt?=
 =?us-ascii?q?bQd90TuwaQkxfBiehVNZ0wmuALhSphJWLyo3klx/Qnghxp2JGwpJKHJHl1/KKl?=
 =?us-ascii?q?Hh5YMSX4Z98U+jHol6pfn9yZ34ayHpV6ATULXYDlTfapEDIUqPTmOByCEDw6qn?=
 =?us-ascii?q?eHB7XfGRWT51thr3LKC5qrLW2YJGEFzdV+QxmQPFdQjxoTXDU+g541DASqxNH6?=
 =?us-ascii?q?fUd95zAR4EP4qxRWxuJpMRn/TnnQpAOyZjgoT5ifKQJc7hte6EfNLcye8uVzEj?=
 =?us-ascii?q?la/pK7qQyCNHebax5UDW0TWUyEGlPjPqSo5dba6OiVHe6+L/rIYbWTpu1STfaI?=
 =?us-ascii?q?xZSz0oR4+zaALNmAPn5nD/cjwEpMQWh5G9jFmzUIUyEWlyXNb9OCpBeh4CJ3qN?=
 =?us-ascii?q?qz8O/sWALp6ouCEL9SMdRp+xCrjqaPLe+QhCBlKTlG0pMA32PHyL8a3FQKkSFh?=
 =?us-ascii?q?ayGtEagctS7KVK/QmrFYDx8YayNwNctE9aE83hNKOc7UlNz1zKN4juUuBldBVF?=
 =?us-ascii?q?zhnNypZMMQL2G8MlPHGFiENLCcKTLXxMH3ZLu2SadMg+VMqx2wpTGbHlf5MTSe?=
 =?us-ascii?q?jDbpTQ6gMOFWgCGfPRxTo4W9chdrCWj+Q9PqcBy7MNlrjTIoxb04nG/FNWkZMT?=
 =?us-ascii?q?JkaUNCsqWQ7T9EgvV4A2FB8ntlLeyelymF9eXXNpYWvuVtAilvk+Ja4XI6y6Za?=
 =?us-ascii?q?7S1eRfx1njfSocBqo128juaPzT9nWgJUqjlXnIKLoVliOaLB+5hAQ3nE+hcN7W?=
 =?us-ascii?q?SWCxsSptplCsfgu6ZfytXUkKLzKTFC88/b/McGBsjULt6HP2QlMRbzBDHUCw4F?=
 =?us-ascii?q?HnaXMjTygVZcm7m4/3mRo4QwrdDt0KEDUKVSHAg4EOkbAQJvFdgGLYt9WRsvlr?=
 =?us-ascii?q?qfhcQP/3P4px7UEpZ0pJfCA92PDPPzJSzRt75JbBhAlbf5K5kDHpf81kdhL0Rh?=
 =?us-ascii?q?2oLHBxyDDph2viR9Y1ps8w12+39kQzh2ghq9Zw=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ABAAAxAvdbh0O0hNFiGgEBAQEBAgEBA?=
 =?us-ascii?q?QEHAgEBAQGBUQUBAQEBCwGBMII7J4wRjACCDRSSL4R3gXMSAQEYEwGIUiI0CQ0?=
 =?us-ascii?q?BAwEBAQEBAQIBEwEBAQgNCQgpIwyCNiQBgmEBAQEBAgEBAiQTBgE4AQMBAQkBA?=
 =?us-ascii?q?QUFGAklAwwFIAEFASITBYMcgWoDDQgBBJ1MPIwJM4J3BYR7DYIRAgYSiluBHBe?=
 =?us-ascii?q?Bf4ERgxKIM4ImAokjhXZ3hSaKTAmRJCOJUYc3LJddAgQCBAUCBQ8hgSWCDTMaC?=
 =?us-ascii?q?CYKgyeCGzWDOIpzHzKBAgMBASETjCEBAQ?=
X-IPAS-Result: =?us-ascii?q?A0ABAAAxAvdbh0O0hNFiGgEBAQEBAgEBAQEHAgEBAQGBUQU?=
 =?us-ascii?q?BAQEBCwGBMII7J4wRjACCDRSSL4R3gXMSAQEYEwGIUiI0CQ0BAwEBAQEBAQIBE?=
 =?us-ascii?q?wEBAQgNCQgpIwyCNiQBgmEBAQEBAgEBAiQTBgE4AQMBAQkBAQUFGAklAwwFIAE?=
 =?us-ascii?q?FASITBYMcgWoDDQgBBJ1MPIwJM4J3BYR7DYIRAgYSiluBHBeBf4ERgxKIM4ImA?=
 =?us-ascii?q?okjhXZ3hSaKTAmRJCOJUYc3LJddAgQCBAUCBQ8hgSWCDTMaCCYKgyeCGzWDOIp?=
 =?us-ascii?q?zHzKBAgMBASETjCEBAQ?=
X-IronPort-AV: E=Sophos;i="5.56,266,1539673200"; 
   d="scan'208";a="63610142"
X-Amp-Result: UNKNOWN
X-Amp-Original-Verdict: FILE UNKNOWN
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mga01b.intel.com with ESMTP; 22 Nov 2018 11:25:50 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2406677AbeKWGGc (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Fri, 23 Nov 2018 01:06:32 -0500
Received: from mail-pl1-f196.google.com ([209.85.214.196]:41128 "EHLO
        mail-pl1-f196.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1726009AbeKWGGb (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 23 Nov 2018 01:06:31 -0500
Received: by mail-pl1-f196.google.com with SMTP id u6so9615288plm.8
        for <linux-kernel@vger.kernel.org>; Thu, 22 Nov 2018 11:25:46 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=sender:date:from:to:cc:subject:message-id:references:mime-version
         :content-disposition:in-reply-to:user-agent;
        bh=CtFQov3diMWmzCH/eueIdqic6nbQK8XnAWHttr7Ta4k=;
        b=rfjTyIAuFoq7fgtYVO1LHU8IvPITBUeNCWSx2O9vEstWzhBeYp+AilPjlv6nGb/jLT
         hsLWvW/m2vaGdkLBh7CojIii+DgboZZXkeQ8737rXVQRiB+cuCBb/b0+h5MBWgMgX+G3
         kjYgwQOnjCGWil6ml9aiSdY5eTiDkoHDD9jg0WHZovIu7sJKy7jAT8uOQVNrJMNj80wV
         xsLZI0nxauZYoybE4EByJprOZAXC6VOmOIBOgemSdYwNyvV2AxOCd6x2TLcWQTr5vtDQ
         y5w+zbfDK2HNOz93wUic+zeFIe+oUWpi2XDmE3LOhEpE5kh0LXvPJepqvCfJ0hMnWSg+
         GqkA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:sender:date:from:to:cc:subject:message-id
         :references:mime-version:content-disposition:in-reply-to:user-agent;
        bh=CtFQov3diMWmzCH/eueIdqic6nbQK8XnAWHttr7Ta4k=;
        b=brY22Rzjr6dAHhwAmx5sn2RhOZlF6/L1V+ecMtH1Tqs7SbDl73NJ6rxWNxqhkhZPE6
         MGRNgdJY6GZpMfMp7hASEi85feJ0MSLc80I238iK4tg09++YaX1dX21NI4v6RpkDT2dU
         lWAbUEWly9uWMg7hLlVqsyeOSlBzFlISbOZOmuSH63Hm+jBZhTtoPTJuKjO82UbmyPBw
         Quvq6u+77BfZdTHHDGZNFRF3tzzk9Mfhk9UFhrc6EnxtWvrwpD8BamGuhbbQIUmBYN/c
         cRBU6wRSGdgX/BM71GYiufuACFiMWGXNbUGsFd4x9fEJFNCkdJThHeQFnizIXOU0SdUA
         ixCw==
X-Gm-Message-State: AA+aEWakvyHPfbaSyztGtkV4HbSnD46YGf6xenMbnz8cuj2Bi36EPjvB
        rSk2dgqx9Jf1vRUvRlJtM8o=
X-Google-Smtp-Source: AFSGD/Wlrud1i8/wGshb64Zrz/yqbExQpn/q5Y3fzae9Y9SdbJaSVn6cHpYX8LVhdgXDKN/Alz1u+w==
X-Received: by 2002:a17:902:14e:: with SMTP id 72-v6mr12071244plb.299.1542914746466;
        Thu, 22 Nov 2018 11:25:46 -0800 (PST)
Received: from localhost ([2600:1700:e321:62f0:329c:23ff:fee3:9d7c])
        by smtp.gmail.com with ESMTPSA id e64-v6sm37453747pfc.122.2018.11.22.11.25.45
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Thu, 22 Nov 2018 11:25:45 -0800 (PST)
Date: Thu, 22 Nov 2018 11:25:44 -0800
From: Guenter Roeck <linux@roeck-us.net>
To: Enric Balletbo i Serra <enric.balletbo@collabora.com>
Cc: lee.jones@linaro.org, gwendal@chromium.org, drinkcat@chromium.org,
        linux-kernel@vger.kernel.org, groeck@chromium.org,
        kernel@collabora.com, bleung@chromium.org,
        Olof Johansson <olof@lixom.net>
Subject: Re: [PATCH 7/7] platform/chrome: cros_ec_lightbar: instantiate only
 if the EC has a lightbar.
Message-ID: <20181122192544.GA2410@roeck-us.net>
References: <20181122113356.23610-1-enric.balletbo@collabora.com>
 <20181122113356.23610-8-enric.balletbo@collabora.com>
MIME-Version: 1.0
Content-Type: text/plain; charset=us-ascii
Content-Disposition: inline
In-Reply-To: <20181122113356.23610-8-enric.balletbo@collabora.com>
User-Agent: Mutt/1.5.24 (2015-08-30)
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Thu, Nov 22, 2018 at 12:33:56PM +0100, Enric Balletbo i Serra wrote:
> Due to the way attribute groups visibility work, the function
> cros_ec_lightbar_attrs_are_visible is called multiple times, once per
> attribute, and each of these calls makes an EC transaction. For what is
> worth the EC log reports multiple errors on boot when the lightbar is
> not available. Instead, check if the EC has a lightbar in the probe
> function and only instantiate the device.
> 
> Ideally we should have instantiate the driver only if the
> EC_FEATURE_LIGHTBAR is defined, but that's not possible because that flag
> is not in the very first Pixel Chromebook (Link), only on Samus. So, the
> driver is instantiated by his parent always.
> 
> This patch changes a bit the actual behaviour. Before the patch if an EC
> doesn't have a lightbar an empty lightbar folder is created in
> /sys/class/chromeos/<ec device>, after the patch the empty folder is not
> created, so, the folder is only created if the lightbar exists.
> 
> Signed-off-by: Enric Balletbo i Serra <enric.balletbo@collabora.com>

Guess this is the answer to the suggestion I had before. Maybe the two patches
should be merged together ? Or do  others think that they should be kept
separate ?

Additional comment below.

Thanks,
Guenter

> ---
> 
>  drivers/platform/chrome/cros_ec_lightbar.c | 29 +++++++++-------------
>  1 file changed, 12 insertions(+), 17 deletions(-)
> 
> diff --git a/drivers/platform/chrome/cros_ec_lightbar.c b/drivers/platform/chrome/cros_ec_lightbar.c
> index 31d22f594fac..d255264eb082 100644
> --- a/drivers/platform/chrome/cros_ec_lightbar.c
> +++ b/drivers/platform/chrome/cros_ec_lightbar.c
> @@ -567,37 +567,28 @@ static struct attribute *__lb_cmds_attrs[] = {
>  	NULL,
>  };
>  
> -static bool ec_has_lightbar(struct cros_ec_dev *ec)
> +static bool cros_ec_has_lightbar(struct cros_ec_dev *ec_dev)
>  {
> -	return !!get_lightbar_version(ec, NULL, NULL);
> -}
> -
> -static umode_t cros_ec_lightbar_attrs_are_visible(struct kobject *kobj,
> -						  struct attribute *a, int n)
> -{
> -	struct device *dev = container_of(kobj, struct device, kobj);
> -	struct cros_ec_dev *ec = to_cros_ec_dev(dev);
> -	struct platform_device *pdev = to_platform_device(ec->dev);
> +	struct platform_device *pdev = to_platform_device(ec_dev->dev);
>  	struct cros_ec_platform *pdata = pdev->dev.platform_data;
>  	int is_cros_ec;
>  
>  	is_cros_ec = strcmp(pdata->ec_name, CROS_EC_DEV_NAME);
>  
Can this now ever be false ?

>  	if (is_cros_ec != 0)
> -		return 0;
> +		return false;
>  
> -	/* Only instantiate this stuff if the EC has a lightbar */
> -	if (ec_has_lightbar(ec)) {
> -		ec_with_lightbar = ec;
> -		return a->mode;
> +	if (!!get_lightbar_version(ec_dev, NULL, NULL)) {
> +		ec_with_lightbar = ec_dev;

Is this variable (and the associated check in lb_manual_suspend_ctrl)
still necessary ?

> +		return true;
>  	}
> -	return 0;
> +
> +	return false;
>  }
>  
>  struct attribute_group cros_ec_lightbar_attr_group = {
>  	.name = "lightbar",
>  	.attrs = __lb_cmds_attrs,
> -	.is_visible = cros_ec_lightbar_attrs_are_visible,
>  };
>  
>  static int cros_ec_lightbar_probe(struct platform_device *pd)
> @@ -611,6 +602,10 @@ static int cros_ec_lightbar_probe(struct platform_device *pd)
>  		return -EINVAL;
>  	}
>  
> +	/* Only instantiate this stuff if the EC has a lightbar */
> +	if (!cros_ec_has_lightbar(ec_dev))
> +		return -ENODEV;
> +
>  	/* Take control of the lightbar from the EC. */
>  	lb_manual_suspend_ctrl(ec_dev, 1);
>  
