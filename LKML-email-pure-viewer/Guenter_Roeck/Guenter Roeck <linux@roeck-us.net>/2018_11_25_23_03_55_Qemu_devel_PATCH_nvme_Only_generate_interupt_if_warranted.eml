Return-Path: <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 26 Nov 2018 08:52:39 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga003.jf.intel.com (orsmga003.jf.intel.com [10.7.209.27])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id A15605803C2
	for <like.xu@linux.intel.com>; Sun, 25 Nov 2018 15:04:25 -0800 (PST)
Received: from orsmga101.jf.intel.com ([10.7.208.22])
  by orsmga003-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 25 Nov 2018 15:04:25 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3AgcX46Rw/tNQBSGPXCy+O+j09IxM/srCxBDY+r6Qd?=
 =?us-ascii?q?0uoXKPad9pjvdHbS+e9qxAeQG9mDu7Qc06L/iOPJYSQ4+5GPsXQPItRndiQuro?=
 =?us-ascii?q?EopTEmG9OPEkbhLfTnPGQQFcVGU0J5rTngaRAGUMnxaEfPrXKs8DUcBgvwNRZv?=
 =?us-ascii?q?JuTyB4Xek9m72/q99pHPYAhEniaxba9vJxiqsAvdsdUbj5F/Iagr0BvJpXVIe+?=
 =?us-ascii?q?VSxWx2IF+Yggjx6MSt8pN96ipco/0u+dJOXqX8ZKQ4UKdXDC86PGAv5c3krgfM?=
 =?us-ascii?q?QA2S7XYBSGoWkx5IAw/Y7BHmW5r6ryX3uvZh1CScIMb7Vq4/Vyi84Kh3SR/okC?=
 =?us-ascii?q?YHOCA/8GHLkcx7kaZXrAu8qxBj34LYZYeYP+d8cKzAZ9MXXWpPUNhfWSJCBY2y?=
 =?us-ascii?q?cpMPAugDM+tXsoXwqUcCogWlBQS3GO/j1iVFimPs0KEmz+gsFxzN0gw6H9IJtX?=
 =?us-ascii?q?TZtNT7NLoMXuCz0KnH0y/DZO5K1zf69ofHbhMhquyLULJ0cMrRz1QvFgzeg1WK?=
 =?us-ascii?q?rozqIS+a1ucUv2iG9OpsT+SvhHA7qwxopDWk28QiipHRi44L1lzJ9j91zJsoKd?=
 =?us-ascii?q?C7UkJ3f9CpHZtKuy2HNYZ6Wt0uTmB0tComz7AKpJy2cDQWxJki2RHSZeKLf5WN?=
 =?us-ascii?q?7x/iSuqRLyt0iXdrdb6hgxu97U2txvPyW8m63lZHqyRFncfSuX0D0hHe7tWIR/?=
 =?us-ascii?q?lh8UqnxD2BzRrc6vteLkAxjafbK4Auwro3lpcLtUTDHzT2mFntjKOMeUUk/PWo?=
 =?us-ascii?q?5/7gYrX8qZ+QL450igfgPaQygsGzH/g0PwsUU2SG5Oix16fv8VP3TbhKlPE6j6?=
 =?us-ascii?q?vUvIjfJcsBp665BwFV0pwk6xa6FzqmycoXnXwaLF5cZR2IkZbpNE/KIPzhFvi/?=
 =?us-ascii?q?hEmskDF3yP/YJb3tBZHNLnnAkLj/Z7p85FNcxRI3zdBe4ZJUF74ALOjyWk/3qN?=
 =?us-ascii?q?zXEBs5PxaozObgDdVwzYUeWWWJAq+WNqPSrEWE5uU1I+mDfIMVoiryK+A55/7y?=
 =?us-ascii?q?in80gVsdfaiq3ZQJcny5EelmLl6dYXrthNcBDGgLshA/TOzslF2NTzpTa2yuUK?=
 =?us-ascii?q?I74zFoQL+gFprJE4CxnKSajmD8GpxNensADFeKHnH1MYKeVLAJYSOWJ8Zn1Tsc?=
 =?us-ascii?q?SbmmTZRmzByrqUr2xqRqKrnp/DYFv8fm3dlx++qBjBw36Hl4AtqQ1ySXQnhpk3?=
 =?us-ascii?q?gUbzkx2q95vAp60FjUyrVygfFTCYlO4ehUWBwxL5/Wwr9GDIXRVwPdfp+jVU2t?=
 =?us-ascii?q?Qp3yAjwwUtJ3ycIVaEZVGtO+gxSF1C2vVew7jbuOUbMp/6TA0mK5HcFwwHWOgK?=
 =?us-ascii?q?0giUQ2atFIOGalw7NksQ7eG9iawA2ii6+2ePFEj2b2/2CZwD/L5RkAXQ=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AEAwAyKvtbhxHrdtBhHQIfBQeBTQKBL?=
 =?us-ascii?q?4JijHCLH5lJgXAVAQEYFIhaIjQJDQEDAQEBAQEBAgETAQEBCgsJCBsOIwyCNgU?=
 =?us-ascii?q?CAxoBBoJfBAIkGQEFCikBAgECAQIGAgVDCAMBMAEFASITBYMcgWoDFQEEmWE8j?=
 =?us-ascii?q?AkzgncFgkSCMQ2CEQIGEodMgw+BHBeBf4hqhhICkBCEP4szCZExFolRhzeYCQI?=
 =?us-ascii?q?EAgQFAgUPIYElgg0zGggmCoMngicXg0qKc1GBAgUhE4lJVoF3AQE?=
X-IPAS-Result: =?us-ascii?q?A0AEAwAyKvtbhxHrdtBhHQIfBQeBTQKBL4JijHCLH5lJgXA?=
 =?us-ascii?q?VAQEYFIhaIjQJDQEDAQEBAQEBAgETAQEBCgsJCBsOIwyCNgUCAxoBBoJfBAIkG?=
 =?us-ascii?q?QEFCikBAgECAQIGAgVDCAMBMAEFASITBYMcgWoDFQEEmWE8jAkzgncFgkSCMQ2?=
 =?us-ascii?q?CEQIGEodMgw+BHBeBf4hqhhICkBCEP4szCZExFolRhzeYCQIEAgQFAgUPIYElg?=
 =?us-ascii?q?g0zGggmCoMngicXg0qKc1GBAgUhE4lJVoF3AQE?=
X-IronPort-AV: E=Sophos;i="5.56,279,1539673200"; 
   d="scan'208";a="42166437"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from lists.gnu.org ([208.118.235.17])
  by mtab.intel.com with ESMTP/TLS/AES256-SHA; 25 Nov 2018 15:04:24 -0800
Received: from localhost ([::1]:33397 helo=lists.gnu.org)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>)
	id 1gR3Rw-0007Fl-B4
	for like.xu@linux.intel.com; Sun, 25 Nov 2018 18:04:24 -0500
Received: from eggs.gnu.org ([2001:4830:134:3::10]:46552)
	by lists.gnu.org with esmtp (Exim 4.71)
	(envelope-from <groeck7@gmail.com>) id 1gR3Re-0007FK-3k
	for qemu-devel@nongnu.org; Sun, 25 Nov 2018 18:04:06 -0500
Received: from Debian-exim by eggs.gnu.org with spam-scanned (Exim 4.71)
	(envelope-from <groeck7@gmail.com>) id 1gR3Rc-0001zu-Uo
	for qemu-devel@nongnu.org; Sun, 25 Nov 2018 18:04:06 -0500
Received: from mail-pl1-x643.google.com ([2607:f8b0:4864:20::643]:39129)
	by eggs.gnu.org with esmtps (TLS1.0:RSA_AES_128_CBC_SHA1:16)
	(Exim 4.71) (envelope-from <groeck7@gmail.com>)
	id 1gR3Ra-0001yV-5c; Sun, 25 Nov 2018 18:04:02 -0500
Received: by mail-pl1-x643.google.com with SMTP id 101so6635295pld.6;
	Sun, 25 Nov 2018 15:03:59 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20161025;
	h=sender:from:to:cc:subject:date:message-id;
	bh=CJweXxiKgoQ8l5NrOBq3FAZ8bG9yUbfcRILellV7qVw=;
	b=LKDIefFkUDYNcLCIVHKqUSTUlViddv4ZYoOd+LFgvdbIiOH/z4hQPao5U2H4jeUECw
	Wo14EMWkNUsxwohfP8gGCcnHEBnyfYrgVjf0pUdRfNlmYqhngH7yHvGX5qKbFtjOtjxT
	7smD5dfVTkklDV+ETVlj8NQnUIoH0RAn0kuk0Zja6HaosrkbQqo8NKY9sOVi8m5VReYZ
	kfXriyb0DatPtm9QoEmE12rB5xlEJnNNf6nZDE52FaE7yXG0YpJKYrHfAtaIiz7Mdsf7
	oNtGh5JmQycD5ODkR+B7hhOdm4W51zXfSb3q004/Mg0U1ehyB13sHa76jIEJueoZ5qAz
	VNUA==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
	d=1e100.net; s=20161025;
	h=x-gm-message-state:sender:from:to:cc:subject:date:message-id;
	bh=CJweXxiKgoQ8l5NrOBq3FAZ8bG9yUbfcRILellV7qVw=;
	b=ZyRClQz9rXRv2nIuficvvKxGHcjt1vNc0f2vVDxGbeiW1nZHVWO//bkb1eTtnyXJDt
	iPg8SNPWt1N/J6BJ1YrEr3KHGa4EJVn7SNjd+zQWfVDql/Ic8io+fvnVs8+spc/UIEjH
	THKof0Yjgp7/7DdT2HCffw4anJX7HoJ6lJjxigXbWEhllnqggOejTFvuxPxEcMm92OKd
	GJ/1U9CvKSgu5V967EI5z49IIo7w+hjrO8QY1pmEqNzBGhEqlXFVlTBrk2hAnxMbbB3Y
	tv2CD6XIJDV0AwJkbSteN7MqptWIRBhqjWWa+N8DCAChxng39zxrV2OG/pb9EDqvO2EA
	WmSw==
X-Gm-Message-State: AA+aEWZQReq8GJ3MmBAHgKAdUY+WvYgwwSmKPFyddvcTvj2MwELD3bll
	EHCTSDN7xOc4WHxpJO/rnkU=
X-Google-Smtp-Source: AFSGD/WP5J+yXN9Z9hqkWzh7G8S6VduDfzm/jMFySdzphl4oOGh5YWnfMIpeqHfO1Rxu66it1UR4kQ==
X-Received: by 2002:a17:902:b112:: with SMTP id
	q18mr8439844plr.255.1543187038257; 
	Sun, 25 Nov 2018 15:03:58 -0800 (PST)
Received: from localhost ([2600:1700:e321:62f0:329c:23ff:fee3:9d7c])
	by smtp.gmail.com with ESMTPSA id
	l16sm59364967pfg.161.2018.11.25.15.03.57
	(version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
	Sun, 25 Nov 2018 15:03:57 -0800 (PST)
From: Guenter Roeck <linux@roeck-us.net>
To: Keith Busch <keith.busch@intel.com>
Date: Sun, 25 Nov 2018 15:03:55 -0800
Message-Id: <1543187035-32757-1-git-send-email-linux@roeck-us.net>
X-Mailer: git-send-email 2.7.4
X-detected-operating-system: by eggs.gnu.org: Genre and OS details not
	recognized.
X-Received-From: 2607:f8b0:4864:20::643
Subject: [Qemu-devel] [PATCH] nvme: Only generate interupt if warranted
X-BeenThere: qemu-devel@nongnu.org
X-Mailman-Version: 2.1.21
Precedence: list
List-Id: <qemu-devel.nongnu.org>
List-Unsubscribe: <https://lists.nongnu.org/mailman/options/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=unsubscribe>
List-Archive: <http://lists.nongnu.org/archive/html/qemu-devel/>
List-Post: <mailto:qemu-devel@nongnu.org>
List-Help: <mailto:qemu-devel-request@nongnu.org?subject=help>
List-Subscribe: <https://lists.nongnu.org/mailman/listinfo/qemu-devel>,
	<mailto:qemu-devel-request@nongnu.org?subject=subscribe>
Cc: Kevin Wolf <kwolf@redhat.com>, Guenter Roeck <linux@roeck-us.net>,
	qemu-devel@nongnu.org, qemu-block@nongnu.org, Max Reitz <mreitz@redhat.com>
Errors-To: qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org
Sender: "Qemu-devel" <qemu-devel-bounces+like.xu=linux.intel.com@nongnu.org>

So far the code generates interrupts even if it doesn't pass any new
information to the user. This can result in spurious interrupts as
sometimes observed with Linux.

Only generate interrupts if warranted, ie if anything new is passed
to the emulated code.

Signed-off-by: Guenter Roeck <linux@roeck-us.net>
---
 hw/block/nvme.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/hw/block/nvme.c b/hw/block/nvme.c
index 9fbe567..c543c01 100644
--- a/hw/block/nvme.c
+++ b/hw/block/nvme.c
@@ -252,6 +252,7 @@ static void nvme_post_cqes(void *opaque)
     NvmeCQueue *cq = opaque;
     NvmeCtrl *n = cq->ctrl;
     NvmeRequest *req, *next;
+    bool assert_irq = false;
 
     QTAILQ_FOREACH_SAFE(req, &cq->req_list, entry, next) {
         NvmeSQueue *sq;
@@ -271,8 +272,11 @@ static void nvme_post_cqes(void *opaque)
         pci_dma_write(&n->parent_obj, addr, (void *)&req->cqe,
             sizeof(req->cqe));
         QTAILQ_INSERT_TAIL(&sq->req_list, req, entry);
+        assert_irq = true;
+    }
+    if (assert_irq) {
+        nvme_irq_assert(n, cq);
     }
-    nvme_irq_assert(n, cq);
 }
 
 static void nvme_enqueue_req_completion(NvmeCQueue *cq, NvmeRequest *req)
-- 
2.7.4


