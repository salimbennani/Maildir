Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 25 Nov 2018 14:42:37 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from FMSMGA003.fm.intel.com (fmsmga003.fm.intel.com [10.253.24.29])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id E0BE858037D;
	Sat, 24 Nov 2018 11:49:22 -0800 (PST)
Received: from fmsmga101.fm.intel.com ([10.1.193.65])
  by FMSMGA003-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 24 Nov 2018 11:49:22 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3A0DxiPBefconVzcR2neWfqld/lGMj4u6mDksu8pMi?=
 =?us-ascii?q?zoh2WeGdxc6/YBaN2/xhgRfzUJnB7Loc0qyK6/CmATRIyK3CmUhKSIZLWR4BhJ?=
 =?us-ascii?q?detC0bK+nBN3fGKuX3ZTcxBsVIWQwt1Xi6NU9IBJS2PAWK8TW94jEIBxrwKxd+?=
 =?us-ascii?q?KPjrFY7OlcS30P2594HObwlSizexfbB/IA+qoQnNq8IbnZZsJqEtxxXTv3BGYf?=
 =?us-ascii?q?5WxWRmJVKSmxbz+MK994N9/ipTpvws6ddOXb31cKokQ7NYCi8mM30u683wqRbD?=
 =?us-ascii?q?VwqP6WACXWgQjxFFHhLK7BD+Xpf2ryv6qu9w0zSUMMHqUbw5Xymp4qF2QxHqlS?=
 =?us-ascii?q?gHLSY0/nzJhMx+jKxVoxyvqBJwzIHWfI6bO+F+frvfcN4BWWpMXdxcWzBdDo6y?=
 =?us-ascii?q?bYYCCfcKM+ZCr4n6olsDtRWwChOqBOPu1DBIgmL906sk3OUgDQ7JxgogH9UTu3?=
 =?us-ascii?q?nTsdr6LqESUeGrw6nM1znDa+1Z2Dbh54fSdBAhpuqBXbZxccrX00YvDQTFgk+X?=
 =?us-ascii?q?qYz/MDOYz+IAuHWV4epnUOKgkW8nqwdprzizyMYsi5XJhp4LxVDe7yl23IE1Jd?=
 =?us-ascii?q?igRE5/YN6kFoFftzudN4dsRcMiWW5otD40yrIcpZG0YjMFyJMgxx7ccfCIb4+I?=
 =?us-ascii?q?4hflWe2MIjl4nGpodKyjixu260Ss1+PxWteu3FpXrSdJjsPAu3EP2hDL6MWKSO?=
 =?us-ascii?q?Fx8lqv1DuOzQze6+5JLVo3mKfbLZMq36Q+mYAJsUvZGy/7gEX2g7GSdkUj4uWo?=
 =?us-ascii?q?9evnbav8ppOGNI97lBv+MqIwlcy7G+g4NRIOX2eD9eS90r3s41H5Ta1UgvEqlq?=
 =?us-ascii?q?TVqo3WKMoFqqKjHgNY0Zov5wy+AjqkyNgYmGMILFNBeBKJlYjpPFTOLej8Dfe+?=
 =?us-ascii?q?hVSsjThqy+nFPrL/GJXNKGbMkLP4cbZ65U9czhQ8zcpE6pJKBbEOPujzVlXytN?=
 =?us-ascii?q?PGFB85NRK7w+L9BNV6zIMeVnqDArWFP6PKrV+I+uUvLvGIZI8UuzbyNeIp5vHz?=
 =?us-ascii?q?jXIinV8dfK+p3YYYaXyiH/RmJVmZbmTogtsbDWgKuQ8+RvTwiFKeST5Te2qyX6?=
 =?us-ascii?q?Uk6zE7Eo2mDJvDSZqqgLCb3Ce7A4dZZmZJCl2XFXfodoOEW+oDaS6II89hlCAE?=
 =?us-ascii?q?WqalS4M7yR6uswr6waJ9LuXI4i0YqY7j1N9t6u3RkhE96yZ4D8ea02GLSWF0mX?=
 =?us-ascii?q?gFRzs33KB5vEx8xU2P0al+g/xEC9NT4+lFXRs9NZ7Z1+Z6Ecz9WhrdfteVT1ar?=
 =?us-ascii?q?Ws+pASoxTtI2wN8CeVx9FM+gjh3Y2yqqArkVl6GEBZAu86Lc2WTxKNh5y3rcyK?=
 =?us-ascii?q?YhiFwmSNNVNWK6nq5/6xTTB4nRnkWajamqc74Q3CrM9GiZy2qOs1pVUApxUaXD?=
 =?us-ascii?q?QHAeaVHardX/5kPeUbCuDa4rPRdGyc6HMqFKcMHmjU1aRPf/P9TTe3++lH2uBR?=
 =?us-ascii?q?mW3L+MbJDle2MG3CrDDkgIlAQT/XWDNQg6HSqhp2PeDDpzFVPgeU/s8O9+qG+l?=
 =?us-ascii?q?QU8w1Q2Fc0ph17+t8B4PmfOcU+8T3q4DuCo5tjp7Bki90MzMB9qAvQVher5cbs?=
 =?us-ascii?q?074Fpc0WLZtgp9PoGvLqx4h14edRh3sF3q1xltFopAls0qpmswzAVuMaKYzE9B?=
 =?us-ascii?q?dzSA0JDsO73XL27y/Ayva6/WwF3ezMya+qAV6PQ8qlXjug6pG1Em83Vm1dlVzn?=
 =?us-ascii?q?Sd6o/LDAoUTZL+TEI3+wJmqLHdZyk3/5nU2mF0Mamorj/C3MokC/Ehyhm+cNZQ?=
 =?us-ascii?q?LqOFGBXpHM0HGsehMuoqm1uubhIaJ+1S8K80P8W7d/qJwqKrPeBgnC64gmRD+o?=
 =?us-ascii?q?xyzkWM9y9kQO7Sw5kF2+2Y3heAVzrkjFahr9r7lpxeaTATHmqw0y7kBIFKa612?=
 =?us-ascii?q?fIYLD3quIsKtytV/gZ7tR2BX9Fq5C1wa38+pfAKYb0bh0g1IyUQXvXunlDOizz?=
 =?us-ascii?q?x1jz4mtLCf0zHJw+j4choIJHRLRGh7gVjwO4e0i80VU1aybwgukhuo/kL6x6ld?=
 =?us-ascii?q?pKRiIGjfW0ZIfy7qL258Vqu8rKaNY8lK6JkwqyVYTPy8YUyGSr76uxYb0yLjE3?=
 =?us-ascii?q?FexTwhbDGqp5P5kgd+iGKcKnZzsXXYddtxxRfZ+NzTW/pR0iAaSyl/jDndHkK8?=
 =?us-ascii?q?MMWx/dWIi5fDtfizV2C7WZ1JcinrzoSAuDGg5WJwAh2/nPGzmtv5Hgg8yiL709?=
 =?us-ascii?q?hqVSPVrBfzeIXr1qK6Mf55cUlsHlPz9816GoRmmIsqmJ4QwWQahomS/XcfkWb8?=
 =?us-ascii?q?K9Jb1bj8bHoMQz4G2NrV4Anj2E1+IXOF3YP5VnOBwsR/Y9m2eH8Z2iU478pSEq?=
 =?us-ascii?q?eb8KREnTdpolq/tQ/RYuJynjYHxfsu9X4VmecJuAU2wyWZA7ASG1RYPCP2mxSJ?=
 =?us-ascii?q?6dC+sLtYZGK1fbes00p+mMirDKuerQFERHb5ZpAiEDd17sV+M1LDymf/64/6d9?=
 =?us-ascii?q?nLcdIcqAeUnAzegOhPJ5I8jf4KhSthOWLgsnwp0e87jRpy3Z6kuIiLMXli/KW8?=
 =?us-ascii?q?AhRALD36e9sT+i3xjaZZhsuWw4evHpB7FjQKRpToS++oECkJtfTmLAuOFDw8qn?=
 =?us-ascii?q?GGGbvQBwOf6UFmr27RHJCvLX2YOH4ZzdB6ThmHOENfmBwUXCk9npMhDQ+l3svh?=
 =?us-ascii?q?cENk5jwL4l74twBByuZpNxn5T2feqx2kajYySJiDMhVW6htO6FvSMcyb9uhzBT?=
 =?us-ascii?q?1X/oW9rAyRLWyWfwZIAnsMWkOaHFDvJKWu6cPD8+iFBeq+Mv3Obq+VqeFFU/eI?=
 =?us-ascii?q?xJSv0pZp/jqWN8WPOGViAOM/2kZZQX95HMHZkS0VSyMLjyLNc9KbpBCk9yx3qc?=
 =?us-ascii?q?C/7e3rWB/16ouJEbdSKtJv+xa5gaqYM+6QhSB5KStX158WxH/IzqQf00AWiy10?=
 =?us-ascii?q?azatFrEAvzbXTK3Mgq9XEwIbayRrOctI8a083wpNOc3ait/v1b54lPk1C1hbWl?=
 =?us-ascii?q?z7h8GpftcHI2W8NFPBGUaKO66KJTzNw8Hrf6y8Tadcg/lTtx21oTybCVPsPiyf?=
 =?us-ascii?q?lzn1UBCiKftDjDyAMxxEpo68cgxhCWziTN/9bh27Mdl3jSA5wLEuh3PKM3IcPi?=
 =?us-ascii?q?Z4c09XsrKQ6iZYiO1lG2Nd9nplMfWEmyGB4unEK5YWtOFnDThum+1G4HQ11b1V?=
 =?us-ascii?q?4TpARPx0nivSs9Fvr0unkumJ1jpoTh5OpixXi4KMuEVoIb/Z+YVYWXbY4BIN6n?=
 =?us-ascii?q?2dChQQqNtjD93vuqZQxcDOlaLzMjhC9d3U8NAYB8jVLsKHLXUgPQDoGD7SEAsK?=
 =?us-ascii?q?UzqrOXvDiExalfHBvkGS+7Ygo57v0L4DR/cPSF0zB7UFC0JpDs4qL5J+Xzdimr?=
 =?us-ascii?q?me2opA+XW6vDHVRcNHoorAUPOCR/niexiDirwRSxIOwL78ZaAeJIby3UsqPlVz?=
 =?us-ascii?q?moXHHwzUUMJGqytmRgs1pkxX9z55VGJliBGtUR+k/HJGTa38pRUxkAYrOek=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AaAAAFqvlbh0O0hNFjHAEBAQQBAQcEA?=
 =?us-ascii?q?QGBUQcBAQsBgVqBDwN/J4N5iBiNYQglFIh4jjCBcRQBARgHDAGBS4cPIjQJDQE?=
 =?us-ascii?q?DAQEBAQEBAgETAQEBCA0JCCkjDII2IoJkAQEBAQIBAQIgDwENAQE3AQUJAQEKD?=
 =?us-ascii?q?goCAiYCAgMeEwEFARwGAQwGAgEBAQSCTUsBgWkDDQgEAQqbCDyKHXCBL4J2AQE?=
 =?us-ascii?q?FgkOCNQ2CEQgSeYligRyBVz+BOAyCX4JWOgsCAoRjgleHUoFJh0WOdi4HAoIcB?=
 =?us-ascii?q?IN7YYcIgyUGGIFZTYcrECaHASyNF4EKiTwCBAIEBQIFDyGBJV+BLjMaMIMvCYI?=
 =?us-ascii?q?SDBeDSoUUhT8/MoEFAQGMBwEB?=
X-IPAS-Result: =?us-ascii?q?A0AaAAAFqvlbh0O0hNFjHAEBAQQBAQcEAQGBUQcBAQsBgVq?=
 =?us-ascii?q?BDwN/J4N5iBiNYQglFIh4jjCBcRQBARgHDAGBS4cPIjQJDQEDAQEBAQEBAgETA?=
 =?us-ascii?q?QEBCA0JCCkjDII2IoJkAQEBAQIBAQIgDwENAQE3AQUJAQEKDgoCAiYCAgMeEwE?=
 =?us-ascii?q?FARwGAQwGAgEBAQSCTUsBgWkDDQgEAQqbCDyKHXCBL4J2AQEFgkOCNQ2CEQgSe?=
 =?us-ascii?q?YligRyBVz+BOAyCX4JWOgsCAoRjgleHUoFJh0WOdi4HAoIcBIN7YYcIgyUGGIF?=
 =?us-ascii?q?ZTYcrECaHASyNF4EKiTwCBAIEBQIFDyGBJV+BLjMaMIMvCYISDBeDSoUUhT8/M?=
 =?us-ascii?q?oEFAQGMBwEB?=
X-IronPort-AV: E=Sophos;i="5.56,275,1539673200"; 
   d="scan'208";a="63797705"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mga01b.intel.com with ESMTP; 24 Nov 2018 11:49:21 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1726184AbeKYGiX (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Sun, 25 Nov 2018 01:38:23 -0500
Received: from mail-wr1-f66.google.com ([209.85.221.66]:43813 "EHLO
        mail-wr1-f66.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1725981AbeKYGiX (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sun, 25 Nov 2018 01:38:23 -0500
Received: by mail-wr1-f66.google.com with SMTP id r10so15118485wrs.10
        for <linux-kernel@vger.kernel.org>; Sat, 24 Nov 2018 11:49:14 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linaro.org; s=google;
        h=subject:to:cc:references:from:message-id:date:user-agent
         :mime-version:in-reply-to:content-language:content-transfer-encoding;
        bh=eZ86WDoX0dcbFS5Ew7w8sfoMi/znBZaQN9tOsxYV/2Q=;
        b=kVPpO9JuijgQeZN/jmiZi62flIaBuyU/sIKhOqqV+Oiwalh1ZymDn/tzgr7wXkwFtl
         VQPN+qET8CeKsYvHmhPRbUib+Qs8WQcPeUy05OQ9q7r2tb/StUX+iUsR0qA4/UpLMas5
         U3wyfDCdVh7n6+CztsSUBRtZWYZA0N52OmAAs=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:subject:to:cc:references:from:message-id:date
         :user-agent:mime-version:in-reply-to:content-language
         :content-transfer-encoding;
        bh=eZ86WDoX0dcbFS5Ew7w8sfoMi/znBZaQN9tOsxYV/2Q=;
        b=IrM2T5fPv+Bm1BmU+0eCXocC2GSHaRcBxSCDd28aoxAt8CsS3jpE7FcZRI28thbQ+R
         jJ2NIt5TiI3ZWGfuKguwUYI2i5drWmFhCFxUs+ffFjXEXQLm925rjgRONto7SGW/z/nT
         wAgGqQQ/5r8PH0U8z19BfDjF5bRhNK+iG/7sV+duIlUqMc9m/PUDkSNEXoag6gGJmLkn
         4gg/+frAuj4JSJVTQvl7A3y8JolpTzN5V6B6HakdgglXJM8ySCEADQnSMllnnDM55s3r
         on9p+EQ/34+MrBaqOvhs+7Pa7d7Lkp1a+F/3kdfjSv/lKXz5ev7MiFZnRIRjJe84VZAn
         wHwQ==
X-Gm-Message-State: AA+aEWbvEU7/KE4BIndyfCqu4Q7TuMOCVoDWTcJj/Fr0UakHqm5UKwnh
        fBLDHpGnsAFpILFS2pvywmdQK3ZEKN4=
X-Google-Smtp-Source: AFSGD/VyLnQgUJGszi1vPL5osgJmaLgFCuNseeZrc1T3vZs0q5RU6/c7/0FBcA+9t3Svm9yrUv4hrQ==
X-Received: by 2002:a5d:44d1:: with SMTP id z17mr17948109wrr.271.1543088953356;
        Sat, 24 Nov 2018 11:49:13 -0800 (PST)
Received: from [192.168.0.40] (85.64.136.77.rev.sfr.net. [77.136.64.85])
        by smtp.googlemail.com with ESMTPSA id j199sm25745700wmf.13.2018.11.24.11.49.12
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Sat, 24 Nov 2018 11:49:12 -0800 (PST)
Subject: Re: [PATCH] clocksource/drivers/integrator-ap: add missing
 of_node_put()
To: Frank Lee <tiny.windzz@gmail.com>, tglx@linutronix.de
Cc: linux-kernel@vger.kernel.org
References: <20181122152331.25739-1-tiny.windzz@gmail.com>
 <CAEExFWt45G5hyAEZvaAW--ZANnTqmi7-i473jRfFLD0Wacp6-w@mail.gmail.com>
From: Daniel Lezcano <daniel.lezcano@linaro.org>
Message-ID: <97b95b60-8420-bad9-4d2c-6baee749b90f@linaro.org>
Date: Sat, 24 Nov 2018 20:49:11 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101
 Thunderbird/60.2.1
MIME-Version: 1.0
In-Reply-To: <CAEExFWt45G5hyAEZvaAW--ZANnTqmi7-i473jRfFLD0Wacp6-w@mail.gmail.com>
Content-Type: text/plain; charset=utf-8
Content-Language: en-US
Content-Transfer-Encoding: 8bit
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 24/11/2018 15:58, Frank Lee wrote:
> On Thu, Nov 22, 2018 at 11:23 PM Yangtao Li <tiny.windzz@gmail.com> wrote:
>>
>> of_find_node_by_path() acquires a reference to the node
>> returned by it and that reference needs to be dropped by its caller.
>> integrator_ap_timer_init_of() doesn't do that, so fix it.
>>
>> Signed-off-by: Yangtao Li <tiny.windzz@gmail.com>
>> ---
>>  drivers/clocksource/timer-integrator-ap.c | 20 ++++++++++++++------
>>  1 file changed, 14 insertions(+), 6 deletions(-)
>>
>> diff --git a/drivers/clocksource/timer-integrator-ap.c b/drivers/clocksource/timer-integrator-ap.c
>> index 76e526f58620..1f04069470bb 100644
>> --- a/drivers/clocksource/timer-integrator-ap.c
>> +++ b/drivers/clocksource/timer-integrator-ap.c
>> @@ -177,7 +177,7 @@ static int __init integrator_ap_timer_init_of(struct device_node *node)
>>  {
>>         const char *path;
>>         void __iomem *base;
>> -       int err;
>> +       int err,rc = 0;
>>         int irq;
>>         struct clk *clk;
>>         unsigned long rate;
>> @@ -210,26 +210,34 @@ static int __init integrator_ap_timer_init_of(struct device_node *node)
>>                                 "arm,timer-secondary", &path);
>>         if (err) {
>>                 pr_warn("Failed to read property\n");
>> -               return err;
>> +               rc = err;
>> +               goto out_put_pri_node;
>>         }
>>
>>
>>         sec_node = of_find_node_by_path(path);
>>
>> -       if (node == pri_node)
>> +       if (node == pri_node){
>>                 /* The primary timer lacks IRQ, use as clocksource */
>> -               return integrator_clocksource_init(rate, base);
>> +               rc = integrator_clocksource_init(rate, base);
>> +               goto out;
>> +       }
>>
>>         if (node == sec_node) {
>>                 /* The secondary timer will drive the clock event */
>>                 irq = irq_of_parse_and_map(node, 0);
>> -               return integrator_clockevent_init(rate, base, irq);
>> +               rc = integrator_clockevent_init(rate, base, irq);
>> +               goto out;
>>         }
>>
>>         pr_info("Timer @%p unused\n", base);
>>         clk_disable_unprepare(clk);
>> +out:
>> +       of_node_put(sec_node);
>> +out_put_pri_node:
>> +       of_node_put(pri_node);
>>
>> -       return 0;
>> +       return rc;
>>  }
>>
>>  TIMER_OF_DECLARE(integrator_ap_timer, "arm,integrator-timer",
>> --
>> 2.17.0
>>
> Hi Daniel：
> 
> How about this?

Hi,

I think there is a simpler fix. The pri_node and the sec_node are used
as an identifier to compare against the current node, we can directly
drop the refcount after getting the node from path as it is not used as
pointer. In addition, a single variable is needed, so we end up with a
fix like that.

	alias_node = of_find_node_by_path(path);
	of_node_put(alias_node);
	if (node == alias_node)
		return integrator_clocksource_init(rate, base);



> 
> Thanks，
> Yangtao
> 


-- 
 <http://www.linaro.org/> Linaro.org │ Open source software for ARM SoCs

Follow Linaro:  <http://www.facebook.com/pages/Linaro> Facebook |
<http://twitter.com/#!/linaroorg> Twitter |
<http://www.linaro.org/linaro-blog/> Blog

