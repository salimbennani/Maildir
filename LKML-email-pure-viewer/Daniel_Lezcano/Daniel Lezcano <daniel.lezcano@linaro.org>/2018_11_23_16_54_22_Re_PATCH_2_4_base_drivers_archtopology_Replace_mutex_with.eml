Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 24 Nov 2018 12:36:10 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga004.jf.intel.com (orsmga004.jf.intel.com [10.7.209.38])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 2264758037D;
	Fri, 23 Nov 2018 08:55:32 -0800 (PST)
Received: from orsmga101.jf.intel.com ([10.7.208.22])
  by orsmga004-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 08:55:32 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AONqDgB8v3zhne/9uRHKM819IXTAuvvDOBiVQ1KB9?=
 =?us-ascii?q?1uwTIJqq85mqBkHD//Il1AaPAd2Lraocw8Pt8InYEVQa5piAtH1QOLdtbDQizf?=
 =?us-ascii?q?ssogo7HcSeAlf6JvO5JwYzHcBFSUM3tyrjaRsdF8nxfUDdrWOv5jAOBBr/KRB1?=
 =?us-ascii?q?JuPoEYLOksi7ze+/94HQbglSmDaxfa55IQmrownWqsQYm5ZpJLwryhvOrHtIeu?=
 =?us-ascii?q?BWyn1tKFmOgRvy5dq+8YB6/ShItP0v68BPUaPhf6QlVrNYFygpM3o05MLwqxbO?=
 =?us-ascii?q?SxaE62YGXWUXlhpIBBXF7A3/U5zsvCb2qvZx1S+HNsDtU7s6RSqt4LtqSB/wiS?=
 =?us-ascii?q?cIKTg58H3MisdtiK5XuQ+tqwBjz4LRZoyeKfhwcb7Hfd4CWGRPQMhRWSxCDI2y?=
 =?us-ascii?q?YYQAAOgOMvpXoYnmv1sDrwCzBRWvCe711jNEmnH70K883u88EQ/GxgsgH9cWvX?=
 =?us-ascii?q?rattr1MqYSXv6xzKLVyzvMcfJX1ivn54jOdRAqvPaBUq9qfsrXyEkgCQfFgk+U?=
 =?us-ascii?q?qYP7PjKayv4Cs26c7+d7UeKvimgnpBtrojio3MssjZPJho0Mx13C6C53zoE1Jd?=
 =?us-ascii?q?iiR056Z96pCIdQti+bN4tqXsMtXXtotDwmxb0BvJ63ZCwKyJUhxxHFcfyHdJKE?=
 =?us-ascii?q?4hX5VOaeOTt4imhqd66hiBmp9kigze78WtOo31ZNqypIlMTHuHMV1xHL9MSLVv?=
 =?us-ascii?q?9w8l281TuByQzf8PxILEMomabBKpMswKY8m54NvUjZHSL7m1/6gLKVe0k54OSl?=
 =?us-ascii?q?5erqb7P7rZGGLYB0kBvxMqE2l8y/H+s4Ng8OUnCF+eSzyrLj51f1QLZUgf0slK?=
 =?us-ascii?q?nWrpTaKd4cpq6jDA9Zyocj6xChADe6yNkUg2ULIVZfdB6agYXlJUvCLO37APuj?=
 =?us-ascii?q?mVihkTVmy+jDPrL7A5XNKnbDkK3mfbZ480NczAszzdZC55NbE70BI+z8WlX3tN?=
 =?us-ascii?q?PGCh81Kgu0wujhCNpjzIMTQnyPAqCHP6PIq1OI5fwgI/OKZIALvDbxMf8l5+Th?=
 =?us-ascii?q?jXMhg18SYbGp3YcLaHC/BvlmJ0SZYXnyjdsbHmYKoxEzTOjriF2ETD5SaGy+X6?=
 =?us-ascii?q?M65jEnFo2mCZ3PSZyqgLyExC27BIFZZnhaClCQFnflb4WEVO0NaCKOOMBhlSYI?=
 =?us-ascii?q?Vbi8S4A70xGuuxT3y75mLurS5y0Zuojv1Nlz5+3Pix4y8SZ4ANia02GIV2t0hH?=
 =?us-ascii?q?8HRycq3KBjpkxw0lWD0a9mjPBCFtxT4PVJUgE9NZPHy+x6CtbyWh/Of9uTSVam?=
 =?us-ascii?q?RMmmDi81Tt4r39AOZEN9Ec24jh/fxyqqH6MVl7uTCZMu6aLc33/xJ8Vnx3bczq?=
 =?us-ascii?q?YhjUIrQs9ONW2gm65++BLfB4/Pk0WFiamqcb4Q0zLK9GeG1WCOpl1XUBZsUaXZ?=
 =?us-ascii?q?WnASfkjWos7/5k/YS7+uCK4oMg1OycOZLqtKa9vpjUhJRfv5OdTeZX6xlHm0BR?=
 =?us-ascii?q?qS2ryMa4/qcX0H3CrBEEgEjxwT/XGeOAcjHCihvXzRACZuFV31ZUPs6vdxqHW8?=
 =?us-ascii?q?Qk8wzAGKaklh2qGx+h4Ug/ycVvwS0qgFuCcntzV7AlK908jKBNqHogprZL9cbs?=
 =?us-ascii?q?8l4FdbyWLZsBRwMYG6IKB8mFESaQR3sFno1xVsFIpAl9MnrHcrzAp0NKKZ30lN?=
 =?us-ascii?q?dzKe3ZDsJLLXLnP+8wyoa67TwlveysqZ+r8T6PQkrFXupB2pFksn83Vgz9lV03?=
 =?us-ascii?q?ud6o/WDAYIVpLxSEI39xl8p7HVeSQ944LU1XtxMai7qDPC2tQpBPc7xRakZdtQ?=
 =?us-ascii?q?LKSEFArqGc0AG8euMPAqm0Subh8cJu9S8LA7Psy4ePqGwqKkJ/tgky+8gmRB44?=
 =?us-ascii?q?B91VyM+jF4Su7J2ZYF3v6Z0hGGVzf6kFeurMT3lZpYajEVG2q10TLkC5JJZq1u?=
 =?us-ascii?q?YYYLDn+jIs2qxtlkm5HhQX9Z9F65CFMA18+kYh6Sb1373Q1N2kUbu32nmS2kzz?=
 =?us-ascii?q?NqlzEltLaQ3CvLw+76bhoIJnZLRHV+jVfrOYW0ldEaU1SyYAgziRSl4lz2x65F?=
 =?us-ascii?q?q6RlLmnfWFtHcDLyL25/TKSwrL2CY8hU5ZMssCVXVvm8YF+ARr78pRsazz3sH2?=
 =?us-ascii?q?9EyD8ncDGqv43znwZmh2KFMHZzsH3ZdNlwxBfe/tDdReRd3iEbRCl+kjTXAlm8?=
 =?us-ascii?q?P9+0/dSbjZvDs+a+V36/WZ1XayXk0YSAtC6j721wHRK/h+yzmsHgEQUi0y/0zc?=
 =?us-ascii?q?NqVSbLrBb7eIXrzL61MeFkfklpAl/z9cx6F5p6kosxgpEQxHcbio+U/XoBjWf8?=
 =?us-ascii?q?L9Fb1bjiY3oKQD4B28TV7xT92E1/MnKJwJr0V3WHzctmfdW6YGIW2iQm4sBOCa?=
 =?us-ascii?q?eU6qFEnCRvrlq5qwLRfeZynjMHxfQy734ahvkDuBAxwSWFHrASAU5YMDTvlxuS?=
 =?us-ascii?q?7tCytqVXZHu1fri220pzhtShDLCEogFBV3f1YJYiHSls7sphNFLAymH86obheN?=
 =?us-ascii?q?PId9IcqgWUkwvcj+hSMJ8xk/sKhSl9Nm7ns3wq1fU7jQBw0pGgp4eINX9t/K2i?=
 =?us-ascii?q?Dx5cNz31Yd4T+z73gaZfmMaWw56gHpF7FjoXW5voSOqiECgOuvT/KwaODDo8p2?=
 =?us-ascii?q?+HGbrYGA+T8kZnoGjJE5C2LHGXP3gZwM5mRBmcIkxfnQ8VUC87np4/CgCl2sjh?=
 =?us-ascii?q?fF1l6TAW417ysgFMxf5wNxnjTmffox+lZSwuR5iYKBpW8xtO50PIMcGF6uJzHi?=
 =?us-ascii?q?dY/oCurQCXK2ybYRhIAn8NWkCeG1/jObyu78Ha8+eEHuq+M+fOYbKWpOxcTfiI?=
 =?us-ascii?q?wIyg0pB88zaQLMmPPWRiD/4m2kpFR395AN/UmzEOSywRiiLMYNSXpBa6+i1rsM?=
 =?us-ascii?q?+/9O7nVx7o5YuKE7FSK8lg+wiqgaefMO6dnCZ4KTFF1pMV2H/H0r4f0EQJiyFp?=
 =?us-ascii?q?cTmtHq8NtSrMTKLWh69WAAQXayJ1NMtU8a082hNBNtLcitPwzrR4lOI6C09ZVV?=
 =?us-ascii?q?z9ncGkfcwKLH+8NFPEB0aLNa6KJT7Rw8HwbqOzV6dQjPhPtxCrvTabEknjPimM?=
 =?us-ascii?q?ljXzVhCvN/1Mgz+fPBBEpI69dRNtA3D5TN36ch27LMN3jTouzLIum3PFLnQcPi?=
 =?us-ascii?q?Z8ck9Xqr2Q7DhVgvF+G2xH83pkIvOImyef7+nENJkWteFnDThzl+Jf+H460ada?=
 =?us-ascii?q?7DlYRPxpnyvftsJuo1CjkuWV1jVrSgZBqjZVi4KNpkhiPaTZ9p9dWXfL5h4N7G?=
 =?us-ascii?q?OQCwgUqNthENHgp6dQyt3XnqLpNDhC687U/dcbB8XMKMOIKnwhMR/oGD7SFAQE?=
 =?us-ascii?q?TD6rOnvZh0xSi/yS8nyVrp4nqpnjgpYOS7lbVEArGfMeEEhqANsCIJIkFg8jxI?=
 =?us-ascii?q?WGgMMF/TKeqx3VTY0OpY3LW/+KR/XoLDKQpbBeYl0DxraufqoJMYiu90Vka1R+?=
 =?us-ascii?q?1KDHCUHZW9cF9iFoaA45pANJ/Wp1R2s080bkbAq35zkUD/HizU1+sRd3fel4rG?=
 =?us-ascii?q?Sk2FwwPFef4XJoyEQ=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AZAABCMPhbh0O0hNFjHAEBAQQBAQcEA?=
 =?us-ascii?q?QGBUQcBAQsBgmkDfyeDeYgYjACBYC0UlyeBcRQBARgHDAGBS4cPIjQJDQEDAQE?=
 =?us-ascii?q?BAQEBAgETAQEBCA0JCCkjDII2JAGCYgECAwECIA8BDQEBNwEFCQEBChQEAgImA?=
 =?us-ascii?q?gIDMQEFARwGDQYCAQEBBIMYAYIBBAEKmz08ih1wgS+CdgEBBYJDhFIIEnmJYoE?=
 =?us-ascii?q?cgVc/gTiCa4MQCwIChGOCV4dSg0GUcQcCghwEg3thii0GGIFZTYcrECaHASyNF?=
 =?us-ascii?q?4d9gkkCBAIEBQIFDyGBJYINMxowgy8JghI1gziFFIU/PzKBBQEBjCEBAQ?=
X-IPAS-Result: =?us-ascii?q?A0AZAABCMPhbh0O0hNFjHAEBAQQBAQcEAQGBUQcBAQsBgmk?=
 =?us-ascii?q?DfyeDeYgYjACBYC0UlyeBcRQBARgHDAGBS4cPIjQJDQEDAQEBAQEBAgETAQEBC?=
 =?us-ascii?q?A0JCCkjDII2JAGCYgECAwECIA8BDQEBNwEFCQEBChQEAgImAgIDMQEFARwGDQY?=
 =?us-ascii?q?CAQEBBIMYAYIBBAEKmz08ih1wgS+CdgEBBYJDhFIIEnmJYoEcgVc/gTiCa4MQC?=
 =?us-ascii?q?wIChGOCV4dSg0GUcQcCghwEg3thii0GGIFZTYcrECaHASyNF4d9gkkCBAIEBQI?=
 =?us-ascii?q?FDyGBJYINMxowgy8JghI1gziFFIU/PzKBBQEBjCEBAQ?=
X-IronPort-AV: E=Sophos;i="5.56,270,1539673200"; 
   d="scan'208";a="42008276"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 23 Nov 2018 08:54:30 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2633072AbeKXDj1 (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Fri, 23 Nov 2018 22:39:27 -0500
Received: from mail-wr1-f66.google.com ([209.85.221.66]:41221 "EHLO
        mail-wr1-f66.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1729195AbeKXDj1 (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 23 Nov 2018 22:39:27 -0500
Received: by mail-wr1-f66.google.com with SMTP id x10so12966589wrs.8
        for <linux-kernel@vger.kernel.org>; Fri, 23 Nov 2018 08:54:25 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linaro.org; s=google;
        h=subject:to:cc:references:from:message-id:date:user-agent
         :mime-version:in-reply-to:content-language:content-transfer-encoding;
        bh=rA3rJeHl4bVAMRFBo2W5dMaaPO3u8C6pWLlXoXAvryQ=;
        b=J0NWXWfIaSKgtPQw5mgEDgAsvUWQPfaIRyy90aaADQFBmW5fmiqNh5R0ZUhqZLUO9e
         NykPBfJTUvZanlLqseE+Hu+dRuzOsMMQK22b8nNvivqAq5uPSSXb8llD2y4NQUrtoCS4
         53bbNYb40P4Fpx5eMjYBriTcq+YNZvcrviwvc=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:subject:to:cc:references:from:message-id:date
         :user-agent:mime-version:in-reply-to:content-language
         :content-transfer-encoding;
        bh=rA3rJeHl4bVAMRFBo2W5dMaaPO3u8C6pWLlXoXAvryQ=;
        b=H8xWErUwFpVPC+5StuGTD2CJ5V46hVRl3cgjLZQPd658Xvvi5ZYw0NpaigRU+t5bzV
         Va84h2wKhCGAcWRH0ncY4bndDSaxl0K84qlobCET8pE6A817+P+CQxXdjmzMwUC4GRt/
         dmeID+ArfzTGoXphfHbWfVNOod6QdcOfEr/iFl5MqwYoH9PeHojVId6tbf+gj56CF4d7
         8qCk2QmsquzVSItreqJDuzXYDP1pvnQ1CagfMtBJCrOVdBHRXDsmZM7YxIRoYCaLWXBL
         2S3AWhGQUz/LAqANb5oVenyQziMRrwf0X6L8WDsRThpAPkGGbIY7U1OYFcVM6HxQ6OhQ
         Hlfg==
X-Gm-Message-State: AA+aEWaDk3YGPUUU3zdvMpeLSCv7LmRLpkR4M9AviNVPAOg9zBE0MGj/
        58sbkiCPBqcMQZMmIx7hCbUjXDVyIcg=
X-Google-Smtp-Source: AFSGD/Wuk2S4wLjew2N/0O+rjPyLDK4apwbjFMXKvn1862VONLY7Sd2p0cIAwZ1PIdWxxxpklp9uWQ==
X-Received: by 2002:a5d:4e4a:: with SMTP id r10mr5179249wrt.54.1542992064628;
        Fri, 23 Nov 2018 08:54:24 -0800 (PST)
Received: from [192.168.0.40] (33.181.88.92.rev.sfr.net. [92.88.181.33])
        by smtp.googlemail.com with ESMTPSA id 82-v6sm6367610wms.17.2018.11.23.08.54.23
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Fri, 23 Nov 2018 08:54:24 -0800 (PST)
Subject: Re: [PATCH 2/4] base/drivers/arch_topology: Replace mutex with
 READ_ONCE / WRITE_ONCE
To: Sudeep Holla <sudeep.holla@arm.com>
Cc: rjw@rjwysocki.net, vincent.guittot@linaro.org,
        linux-kernel@vger.kernel.org,
        Greg Kroah-Hartman <gregkh@linuxfoundation.org>,
        "Rafael J. Wysocki" <rafael@kernel.org>,
        Kate Stewart <kstewart@linuxfoundation.org>,
        Juri Lelli <juri.lelli@redhat.com>,
        Thomas Gleixner <tglx@linutronix.de>,
        "Peter Zijlstra (Intel)" <peterz@infradead.org>,
        Juri Lelli <juri.lelli@redhat.com>
References: <1540830201-2947-1-git-send-email-daniel.lezcano@linaro.org>
 <1540830201-2947-2-git-send-email-daniel.lezcano@linaro.org>
 <20181123135807.GA14964@e107155-lin>
 <9cea4556-15f8-9377-305a-b629ba7e811f@linaro.org>
 <20181123162040.GB27793@e107155-lin>
From: Daniel Lezcano <daniel.lezcano@linaro.org>
Message-ID: <1e013fee-e218-c489-9cd6-a384950d304f@linaro.org>
Date: Fri, 23 Nov 2018 17:54:22 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101
 Thunderbird/60.2.1
MIME-Version: 1.0
In-Reply-To: <20181123162040.GB27793@e107155-lin>
Content-Type: text/plain; charset=utf-8
Content-Language: en-US
Content-Transfer-Encoding: 8bit
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 23/11/2018 17:20, Sudeep Holla wrote:
> On Fri, Nov 23, 2018 at 05:04:18PM +0100, Daniel Lezcano wrote:
>> On 23/11/2018 14:58, Sudeep Holla wrote:
>>> On Mon, Oct 29, 2018 at 05:23:18PM +0100, Daniel Lezcano wrote:
>>>> The mutex protects a per_cpu variable access. The potential race can
>>>> happen only when the cpufreq governor module is loaded and at the same
>>>> time the cpu capacity is changed in the sysfs.
>>>>
>>>
>>> I wonder if we really need that sysfs entry to be writable. For some
>>> reason, I had assumed it's read only, obviously it's not. I prefer to
>>> make it RO if there's no strong reason other than debug purposes.
>>
>> Are you suggesting to remove the READ_ONCE/WRITE_ONCE patch and set the
>> sysfs file read-only ?
>>
> 
> Just to be sure, if we retain RW capability we still need to fix the
> race you are pointing out.
> 
> However I just don't see the need for RW cpu_capacity sysfs and hence
> asking the reason here. IIRC I had pointed this out long back(not sure
> internally or externally) but seemed to have missed the version that got
> merged. So I am just asking if we really need write capability given that
> it has known issues.
> 
> If user-space starts writing the value to influence the scheduler, then
> it makes it difficult for kernel to change the way it uses the
> cpu_capacity in future.
> 
> Sorry if there's valid usecase and I am just making noise here.

It's ok [added Juri Lelli]

I've been through the history:

commit be8f185d8af4dbd450023a42a48c6faa8cbcdfe6
Author: Juri Lelli <juri.lelli@arm.com>
Date:   Thu Nov 3 05:40:18 2016 +0000

    arm64: add sysfs cpu_capacity attribute

    Add a sysfs cpu_capacity attribute with which it is possible to read and
    write (thus over-writing default values) CPUs capacity. This might be
    useful in situations where values needs changing after boot.

    The new attribute shows up as:

     /sys/devices/system/cpu/cpu*/cpu_capacity

    Cc: Will Deacon <will.deacon@arm.com>
    Cc: Mark Brown <broonie@kernel.org>
    Cc: Sudeep Holla <sudeep.holla@arm.com>
    Signed-off-by: Juri Lelli <juri.lelli@arm.com>
    Signed-off-by: Catalin Marinas <catalin.marinas@arm.com>

Juri do you have a use case where we want to override the capacity?

Shall we switch the sysfs attribute to read-only?


-- 
 <http://www.linaro.org/> Linaro.org │ Open source software for ARM SoCs

Follow Linaro:  <http://www.facebook.com/pages/Linaro> Facebook |
<http://twitter.com/#!/linaroorg> Twitter |
<http://www.linaro.org/linaro-blog/> Blog

