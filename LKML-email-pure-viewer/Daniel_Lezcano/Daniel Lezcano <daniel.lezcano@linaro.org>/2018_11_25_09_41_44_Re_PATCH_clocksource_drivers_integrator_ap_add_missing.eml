Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 25 Nov 2018 22:12:54 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga006.fm.intel.com (fmsmga006.fm.intel.com [10.253.24.20])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 4A3EB5803EB;
	Sun, 25 Nov 2018 01:42:55 -0800 (PST)
Received: from orsmga101.jf.intel.com ([10.7.208.22])
  by fmsmga006-1.fm.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 25 Nov 2018 01:42:54 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3Aon9TuBaSicig1PnNUs4YQCb/LSx+4OfEezUN459i?=
 =?us-ascii?q?sYplN5qZpcm4Zh7h7PlgxGXEQZ/co6odzbaO4+a4ASQp2tWoiDg6aptCVhsI24?=
 =?us-ascii?q?09vjcLJ4q7M3D9N+PgdCcgHc5PBxdP9nC/NlVJSo6lPwWB6nK94iQPFRrhKAF7?=
 =?us-ascii?q?Ovr6GpLIj8Swyuu+54Dfbx9HiTahYr5+Ngm6oRnMvcQKnIVuLbo8xAHUqXVSYe?=
 =?us-ascii?q?RWwm1oJVOXnxni48q74YBu/SdNtf8/7sBMSar1cbg2QrxeFzQmLns65Nb3uhnZ?=
 =?us-ascii?q?TAuA/WUTX2MLmRdVGQfF7RX6XpDssivms+d2xSeXMdHqQb0yRD+v6bpgRh31hy?=
 =?us-ascii?q?cdLzM37X/ZisJwgqxYrhyuqRNwzIzIb4+aL/p+ZqHQcMgGRWdCRMtdSzBND42+?=
 =?us-ascii?q?YoYJEuEPPfxYr474p1YWoxWxHw+sBOLxxT9Mm3T427M10uU9Hg7c2gwgGM8FvX?=
 =?us-ascii?q?PJo9rvMqcSUP66zK3SwTXHcfxX2Cvy55LOchAmuvyMWbNwcczLxkk1EAPJlFKQ?=
 =?us-ascii?q?qZbqPz6M0OkGrmaV7+1lVe21im4nrRl8oiShx8ctlonJmpwaykre+Splx4Y1IM?=
 =?us-ascii?q?W0SEp6Yd6iCpRQrSaaO5FxQsM4TGFkoCg6xacatpGlZycKz5Mnxx3FZ/ObdIiI?=
 =?us-ascii?q?5xTuX/uSLzdgnH9pZq6zihKo/US9xODwSNO43EtJoyZZiNXBt3IA2wTR58WFUP?=
 =?us-ascii?q?dx40ms1DeV2w3S5exIO0M5mKrdJpU82LA/jIATvl7GHiLumEX5kquWdkI89+i2?=
 =?us-ascii?q?5OTofK/mqoWfN4BqkAH+NLohmsilDeQ/KAgOUHCX+eW61LL94U30WKtGguEyn6?=
 =?us-ascii?q?XDrZzXK9oXqrSkDwJWzoov8ReyAjW+3NQdh3YHLVZFeBydj4juPlHDOPT4Dfa5?=
 =?us-ascii?q?g1SxnzZn3vPGMaP7ApXLMHfDlK7tfbFz6k5a1gUz18tS54xbCr4fOvL/QEzxu8?=
 =?us-ascii?q?LCDh8/LQO0x/zrCNJn1oMRQW6PGLOWMLvOsV+U4eIiO+2MZI4WuDnjMfQk6OPu?=
 =?us-ascii?q?gGQ9mV8ce6mpwJQWZGq5HvRgP0WWf37sjs0dHmcNuwo0VPbqh0GaUT5Pe3ayWL?=
 =?us-ascii?q?ox5jEhB4KnEYfMXIetjKaB3CemBJJWYG9GB0uIEXfpcYWERvgNZDiTIs9njjwL?=
 =?us-ascii?q?S7yhR5U92hGpsQ/w06BnIfbM+i0EqZLj08B45+/UlR4s7zB0DMOd02eLT2FzhW?=
 =?us-ascii?q?4IQz423KZioU1y0FuD0K54g+BGGtxX/f9GTgA6NZvExexgF9/yQh7BfsuOSFu+?=
 =?us-ascii?q?WNqmGjExTtUyw9MUeUZyAdeigwvH3yqrBb8VirOKCIY18qLaw3j+OcJ9x2za26?=
 =?us-ascii?q?kmilksWtFPOnG+hq5j6wjTAJbEk0aDmKasb6gc2C/N+32FzWqBp0xYVA9wUaPY?=
 =?us-ascii?q?XXEQfEfWrNL55l/cQL+qE7goLgxBycuaIKtQdtLplUlGROvkONnGfm2+gXmwCg?=
 =?us-ascii?q?iSyrOMdoXqfX4d0zvbCEQDlwAT/nOGNQwlCyelomLeCiFuFF31b0Pt9+l+tG20?=
 =?us-ascii?q?Tksuww6WaE1h0qK/+gQJivyEV/MTwrUEtT88pDpuAlaywcjaC9qaqApnZ6VTf9?=
 =?us-ascii?q?U97UxD1WLYsQx9I5OhI7pjhl4YbwR4oUfu2w9rBYVHlMggtGkqwxZqKaKEzFNB?=
 =?us-ascii?q?cCuV3YzxOr3SLWny4BCvaq7M1lHCytqW/b0P6PA5q1XlswGkDU4i83Rh09lI3H?=
 =?us-ascii?q?qQ/JTKDAwOUZ3vVkY77QR1p7bfYiMl/YPbyWVsMbWosj/Fw98mHu8lxQivfthB?=
 =?us-ascii?q?MKKIDhT9E9AHCMe0LuwqmF+pbgwfMeBW9a40Od6mdvSc1K6qOuZggCypjWBd7I?=
 =?us-ascii?q?9h1UKM8jJ2SvTU0JYd3/GYwgyHWi/8jVe8qMz4hZpIZDASHmWlzyjkC5VcZqlz?=
 =?us-ascii?q?fYYNFGevLNe7xtR4h57xRXFY8ESvCE8B2M+sYRCSdUDy3RVM1UQLpnyqgTG4zz?=
 =?us-ascii?q?1onD4ztKqQwSvOz/7kdBUZIG5LRXBugkv2Loiwkt8VQlKobw8vlBa+4Ub6xq5b?=
 =?us-ascii?q?pLlwLmXJQEdIeTT2IH9mUqeqqrWCZMtP4osysSpLSOS8fUyaSrnlrhoa0iPvBW?=
 =?us-ascii?q?tfyCogdzG3vJX0hBh6iGObLHZuo3vVY8BwxRHD5NPCQf5dxCYJRC59iTPPHFiz?=
 =?us-ascii?q?I8Gp/cmIl5fEqu2+VXiuVodQcSnoyoOMrjC76ndpAR28nvCznMPoEQ4h3C//1t?=
 =?us-ascii?q?lqUzjIrRnmbonq0aS6Lfxofk1yCFDg7Mp6H5l0kpEsi5EIxXgampKV8GIHkGjp?=
 =?us-ascii?q?NtVXw6D+bHsLRTMQx97V4Q7l2FBsL36TxoL5UGmdzdVlZ9WgfmwW3Sc95dhQCK?=
 =?us-ascii?q?iI9LxEgTd1ol2goALSe/d9ny0Ryfsz6HEAheEJtxEgziGcArAUAElZMjbglxWO?=
 =?us-ascii?q?79CisqpXYHyjfqS31Ep7hdqhFq2NohlAWHblfZcvBSpw7sR8MF3WynHy5J/reM?=
 =?us-ascii?q?LMbd0NrB2biAnPj/JaKJ8qkvoKhCxnOX/yvHE/yu47iwBu0o++vISdN2pt+6e5?=
 =?us-ascii?q?CAZCNjLpf8MT5i3tjaFGk8aK2ICvG49tGzQRU5vuUPKoCykStfX8OgaKET08rG?=
 =?us-ascii?q?qbGLXFEQ+e7kdms2zAE5SxO36LI3kZyM1oRAOBK0xHnAAUQDI6k4YiGQ+ww8zh?=
 =?us-ascii?q?dFp56ioV5l7lsRZMzuNoNx/iUmbQvguoazE0SISBIxpS9A1N+0DVMcmG5OJpAy?=
 =?us-ascii?q?5Y5oGhrBCKKmGDZQRHF2QJVVKfB1z5Irmi/9rA8/WbBuqjKfvBe66OpPdaV/eJ?=
 =?us-ascii?q?w5Kvz4Rn8yyNNsWJInltEfk71lBfUnB+HsTTgy8PRDAPlyLRc86bow+x+y1wrs?=
 =?us-ascii?q?Ci6fTrRRjg5Y2VB7tJNtVv/R+2jLyHN+6RgiZ5NDlZ2okNxX/O1LgQwloShzty?=
 =?us-ascii?q?eDmqFLQKrTTNQ77Imq9LEx4bbDt+NMtW4KI93QlNOs/bhsn21r5iif41BElKVU?=
 =?us-ascii?q?b8msGyfsEKJ2C9NFXaBEeELriGJDvLw93pbqO4U7FfkOJUtxioszaBD0DjJiiD?=
 =?us-ascii?q?lyXuVx23K+5MkTqUPAZAt4C9aBptDWnjQcniah26Nt93kDI3zac1hnPMKW4TLz?=
 =?us-ascii?q?x8f1lRob2X6CNSmu9/FHBZ7np5MemEnD6U7/XZKpYTq/dkHj54mP5a4HskzbtY?=
 =?us-ascii?q?9yVERP1zmCvPod9iuVCmku+TyjV5VBpCsCpEhIWOvU96I6XW6oFAWWrY/BIK9W?=
 =?us-ascii?q?iRCw4Fp91gCt3uvaBf0tnOlKLpJzdE/NLZ5s8cB8nSKMKaP3stKxvpGDjIDAQb?=
 =?us-ascii?q?ST6nL33Qh0tYkKLaynrAgIIzrJukvJcDAutHVVokUOwbDEh3DvQNJZ52WnUvlr?=
 =?us-ascii?q?vN3+AS4n/rgBDXRche9rTKRPmbB/KnfDqQi7hJY10MzKHzJIIUHon63UV4bR99?=
 =?us-ascii?q?houcSBmYZsxEviA0Nlx8m05K6nUrFmA=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AUAAD3bPpbh0O0hNFjHAEBAQQBAQcEA?=
 =?us-ascii?q?QGBUQcBAQsBgVqBDwN/J4N5iBiLf4FgLRSIeI4wgXMSAQEYBwwBgUuHDyI0CQ0?=
 =?us-ascii?q?BAwEBAQEBAQIBEwEBAQgNCQgpIwyCNiKCZQECAwECIA8BDQEBNwEFCQEBCg4KA?=
 =?us-ascii?q?gImAgIDHhMBBQEcBg0GAgEBAQSCTUsBgWkDFQQBCppaPIodcIEvgnYBAQWCQ4I?=
 =?us-ascii?q?yDYIRCBJ5iWKBHIFXP4E4gmuCVjoLAgKEY4JXh1KBSYdFjnYuBwKCHASDe2GHC?=
 =?us-ascii?q?IMlBhiBWU2HKxAmhwEsjReBCok8AgQCBAUCBQ8hgSWCDTMaMIMvCYISDBeDSoU?=
 =?us-ascii?q?UhT8/MoEFAQGMawEB?=
X-IPAS-Result: =?us-ascii?q?A0AUAAD3bPpbh0O0hNFjHAEBAQQBAQcEAQGBUQcBAQsBgVq?=
 =?us-ascii?q?BDwN/J4N5iBiLf4FgLRSIeI4wgXMSAQEYBwwBgUuHDyI0CQ0BAwEBAQEBAQIBE?=
 =?us-ascii?q?wEBAQgNCQgpIwyCNiKCZQECAwECIA8BDQEBNwEFCQEBCg4KAgImAgIDHhMBBQE?=
 =?us-ascii?q?cBg0GAgEBAQSCTUsBgWkDFQQBCppaPIodcIEvgnYBAQWCQ4IyDYIRCBJ5iWKBH?=
 =?us-ascii?q?IFXP4E4gmuCVjoLAgKEY4JXh1KBSYdFjnYuBwKCHASDe2GHCIMlBhiBWU2HKxA?=
 =?us-ascii?q?mhwEsjReBCok8AgQCBAUCBQ8hgSWCDTMaMIMvCYISDBeDSoUUhT8/MoEFAQGMa?=
 =?us-ascii?q?wEB?=
X-IronPort-AV: E=Sophos;i="5.56,277,1539673200"; 
   d="scan'208";a="42124314"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 25 Nov 2018 01:41:51 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1727253AbeKYUca (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Sun, 25 Nov 2018 15:32:30 -0500
Received: from mail-wm1-f65.google.com ([209.85.128.65]:53486 "EHLO
        mail-wm1-f65.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1726526AbeKYUca (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sun, 25 Nov 2018 15:32:30 -0500
Received: by mail-wm1-f65.google.com with SMTP id y1so12047663wmi.3
        for <linux-kernel@vger.kernel.org>; Sun, 25 Nov 2018 01:41:47 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linaro.org; s=google;
        h=subject:to:cc:references:from:message-id:date:user-agent
         :mime-version:in-reply-to:content-language:content-transfer-encoding;
        bh=kxWIdzOrN2mS+J/MOhJOBcKJGnUiahJujLAroPpV2MY=;
        b=KJmwqlsNUcA/DaR9NEnhJi+oUube0lGh/YJHYnJmmfh8UgffijmvHsmnZN4DTaPqV1
         MWg+JtnmZuQIb8Ic0OhL69AA4hcsaTCbGmGn//wJTGcd34fDNA/6ZCdR24fyd4CIzVYs
         ZKNx+ywseV5wGS6M8D2nYjq2z6NIA8mn53nN4=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:subject:to:cc:references:from:message-id:date
         :user-agent:mime-version:in-reply-to:content-language
         :content-transfer-encoding;
        bh=kxWIdzOrN2mS+J/MOhJOBcKJGnUiahJujLAroPpV2MY=;
        b=IjxWxPyDBB84Grfk36vICc22ywCRyf9yOMDGcg8m9iauQv1DmrmUpeu0IahOWTWDsV
         5oIxvJZGRO3vahEY8MvpemC6iKmhRaegWpW9DC2A+K0NmLY5w4U8jY53vhxxbfQNIOhs
         QIRoJNmngLZITtuXPeiurmaUoiUV26A3sdscv1jOCr0ZYPXOrP/n08qJKDRbTrizTYQl
         2im8uHd9RfJM6oWrVB4HqWtk3PXUbCJSUpNHqtQUDc4NFVTTLi/4cOmpyXMTL9PHeRXW
         8a0IGs0FcrSnf6/ibVRMJJfqCYITTOO3qjzzkO/MsSO8T1v/bBvpg5ZtaUTH/Wny74Ih
         Obsg==
X-Gm-Message-State: AA+aEWbrdrpZm62rfDr64rRdW4YxsXJBBIcVaF/BbWsAwfIbKFXdyAo/
        GyYZd3qMcykWknnGbMaKraJNQY4ZGjM=
X-Google-Smtp-Source: AJdET5dhfSbJPU44WkG2giaPce3e3StjAHsmX7PP7JdAIPbF+wrL8D0nWy6Q2odmBv4kb6YclagQdQ==
X-Received: by 2002:a1c:c2d4:: with SMTP id s203mr19807624wmf.3.1543138906495;
        Sun, 25 Nov 2018 01:41:46 -0800 (PST)
Received: from [192.168.0.40] (85.64.136.77.rev.sfr.net. [77.136.64.85])
        by smtp.googlemail.com with ESMTPSA id h16sm6239850wrb.62.2018.11.25.01.41.45
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Sun, 25 Nov 2018 01:41:45 -0800 (PST)
Subject: Re: [PATCH] clocksource/drivers/integrator-ap: add missing
 of_node_put()
To: Frank Lee <tiny.windzz@gmail.com>
Cc: tglx@linutronix.de, linux-kernel@vger.kernel.org
References: <20181122152331.25739-1-tiny.windzz@gmail.com>
 <CAEExFWt45G5hyAEZvaAW--ZANnTqmi7-i473jRfFLD0Wacp6-w@mail.gmail.com>
 <97b95b60-8420-bad9-4d2c-6baee749b90f@linaro.org>
 <CAEExFWsdEQCC--E5o5uKuT6nNK_TeqmVu-F1g7Bv_+FO7OkjjQ@mail.gmail.com>
From: Daniel Lezcano <daniel.lezcano@linaro.org>
Message-ID: <f36354fc-566a-a3f4-ff01-8aa99d5af753@linaro.org>
Date: Sun, 25 Nov 2018 10:41:44 +0100
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101
 Thunderbird/60.2.1
MIME-Version: 1.0
In-Reply-To: <CAEExFWsdEQCC--E5o5uKuT6nNK_TeqmVu-F1g7Bv_+FO7OkjjQ@mail.gmail.com>
Content-Type: text/plain; charset=utf-8
Content-Language: en-US
Content-Transfer-Encoding: 8bit
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On 25/11/2018 05:25, Frank Lee wrote:
> On Sun, Nov 25, 2018 at 3:49 AM Daniel Lezcano
> <daniel.lezcano@linaro.org> wrote:
>>
>> On 24/11/2018 15:58, Frank Lee wrote:
>>> On Thu, Nov 22, 2018 at 11:23 PM Yangtao Li <tiny.windzz@gmail.com> wrote:
>>>>
>>>> of_find_node_by_path() acquires a reference to the node
>>>> returned by it and that reference needs to be dropped by its caller.
>>>> integrator_ap_timer_init_of() doesn't do that, so fix it.
>>>>
>>>> Signed-off-by: Yangtao Li <tiny.windzz@gmail.com>
>>>> ---
>>>>  drivers/clocksource/timer-integrator-ap.c | 20 ++++++++++++++------
>>>>  1 file changed, 14 insertions(+), 6 deletions(-)
>>>>
>>>> diff --git a/drivers/clocksource/timer-integrator-ap.c b/drivers/clocksource/timer-integrator-ap.c
>>>> index 76e526f58620..1f04069470bb 100644
>>>> --- a/drivers/clocksource/timer-integrator-ap.c
>>>> +++ b/drivers/clocksource/timer-integrator-ap.c
>>>> @@ -177,7 +177,7 @@ static int __init integrator_ap_timer_init_of(struct device_node *node)
>>>>  {
>>>>         const char *path;
>>>>         void __iomem *base;
>>>> -       int err;
>>>> +       int err,rc = 0;
>>>>         int irq;
>>>>         struct clk *clk;
>>>>         unsigned long rate;
>>>> @@ -210,26 +210,34 @@ static int __init integrator_ap_timer_init_of(struct device_node *node)
>>>>                                 "arm,timer-secondary", &path);
>>>>         if (err) {
>>>>                 pr_warn("Failed to read property\n");
>>>> -               return err;
>>>> +               rc = err;
>>>> +               goto out_put_pri_node;
>>>>         }
>>>>
>>>>
>>>>         sec_node = of_find_node_by_path(path);
>>>>
>>>> -       if (node == pri_node)
>>>> +       if (node == pri_node){
>>>>                 /* The primary timer lacks IRQ, use as clocksource */
>>>> -               return integrator_clocksource_init(rate, base);
>>>> +               rc = integrator_clocksource_init(rate, base);
>>>> +               goto out;
>>>> +       }
>>>>
>>>>         if (node == sec_node) {
>>>>                 /* The secondary timer will drive the clock event */
>>>>                 irq = irq_of_parse_and_map(node, 0);
>>>> -               return integrator_clockevent_init(rate, base, irq);
>>>> +               rc = integrator_clockevent_init(rate, base, irq);
>>>> +               goto out;
>>>>         }
>>>>
>>>>         pr_info("Timer @%p unused\n", base);
>>>>         clk_disable_unprepare(clk);
>>>> +out:
>>>> +       of_node_put(sec_node);
>>>> +out_put_pri_node:
>>>> +       of_node_put(pri_node);
>>>>
>>>> -       return 0;
>>>> +       return rc;
>>>>  }
>>>>
>>>>  TIMER_OF_DECLARE(integrator_ap_timer, "arm,integrator-timer",
>>>> --
>>>> 2.17.0
>>>>
>>> Hi Daniel：
>>>
>>> How about this?
>>
>> Hi,
>>
>> I think there is a simpler fix. The pri_node and the sec_node are used
>> as an identifier to compare against the current node, we can directly
>> drop the refcount after getting the node from path as it is not used as
>> pointer. In addition, a single variable is needed, so we end up with a
>> fix like that.
>>
>>         alias_node = of_find_node_by_path(path);
>>         of_node_put(alias_node);
>>         if (node == alias_node)
>>                 return integrator_clocksource_init(rate, base);
> 
> Daniel,
> 
> OK,I will simplify it like you said.Although I think of_node_put
> should be called
> after we don't use node.

Except I'm missing something, we don't use the alias_node at any time.
The node itself has already a refcount which gives us the guarantee it
is valid.

I agree it can appear a bit strange to put the node right after getting
it but in our case the alias_node is used as an ID, not a pointer, so it
is fine.




-- 
 <http://www.linaro.org/> Linaro.org │ Open source software for ARM SoCs

Follow Linaro:  <http://www.facebook.com/pages/Linaro> Facebook |
<http://twitter.com/#!/linaroorg> Twitter |
<http://www.linaro.org/linaro-blog/> Blog

