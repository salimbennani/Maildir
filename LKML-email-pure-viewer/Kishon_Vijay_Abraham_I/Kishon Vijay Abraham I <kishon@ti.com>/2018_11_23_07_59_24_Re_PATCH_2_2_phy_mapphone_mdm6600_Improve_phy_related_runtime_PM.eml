Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 23:32:18 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga002.fm.intel.com (fmsmga002.fm.intel.com [10.253.24.26])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id D6BC458040F;
	Fri, 23 Nov 2018 00:00:09 -0800 (PST)
Received: from orsmga102-1.jf.intel.com (HELO mga09.intel.com) ([10.7.208.27])
  by fmsmga002-1.fm.intel.com with ESMTP; 23 Nov 2018 00:00:08 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3A7V9YUxbBRCebz+NUFxqLCjz/LSx+4OfEezUN459i?=
 =?us-ascii?q?sYplN5qZpcm5Yh7h7PlgxGXEQZ/co6odzbaO4+a4ASQp2tWoiDg6aptCVhsI24?=
 =?us-ascii?q?09vjcLJ4q7M3D9N+PgdCcgHc5PBxdP9nC/NlVJSo6lPwWB6nK94iQPFRrhKAF7?=
 =?us-ascii?q?Ovr6GpLIj8Swyuu+54Dfbx9HiTahYr5+Ngm6oRnMvcQKnIVuLbo8xAHUqXVSYe?=
 =?us-ascii?q?RWwm1oJVOXnxni48q74YBu/SdNtf8/7sBMSar1cbg2QrxeFzQmLns65Nb3uhnZ?=
 =?us-ascii?q?TAuA/WUTX2MLmRdVGQfF7RX6XpDssivms+d2xSeXMdHqQb0yRD+v9LlgRgP2hy?=
 =?us-ascii?q?gbNj456GDXhdJ2jKJHuxKquhhzz5fJbI2JKPZye6XQds4YS2VcRMZcTzFPDJ2y?=
 =?us-ascii?q?b4UPDOQPM+hXoIb/qFQSohW+HhGsCeH0xz9UhHL7x7E23/gvHAzE2gErAtIAsG?=
 =?us-ascii?q?7TrNXwLKocVOG1zLLIzTXEafNdxDjy6InKch87ofCHQK59ftHLyUY1FwPKlFCQ?=
 =?us-ascii?q?opHmMTiI0ekNsGmb7/FgVeKojW4qsB1xojm1ysgwjYnJg5sYx1bZ/it3x4Y1IM?=
 =?us-ascii?q?e3SE99YdO8CJtQtyGbO5JzQsw4W2FooCY6yroAuZGlZSQKzYkoxxveZvGGb4SE?=
 =?us-ascii?q?/gjvW/qILTthnX5qYrSyjAux/0i40uDwSNW43VJQoiZYnNTAqGoB2wHQ58SbUP?=
 =?us-ascii?q?dw/0Ws1S6S2w3T6OxIO104mKjHJ5I737I9lIYfvV7BEyL2nkj9kbWYeV8++uey?=
 =?us-ascii?q?7uTqerXmqYGYN49zkgz+LKsuldKlAegiMQgBQXKb+eKi273n50H5R69KjvIunq?=
 =?us-ascii?q?nYtpDVO9gbq7anDwNJ1osv8QuzAjm43NgCgHUKL05JdAiGgoXrI13OJer3Dfa7?=
 =?us-ascii?q?g1SiijdrwPXGM6XlApXMKHjDjbjgca9+60FC0gozy85Q55ZNBrEGLvPzXFH+tM?=
 =?us-ascii?q?bDAx8nPAy73fznBM9+1owAQ2KPBLGWMKfIvV+P/OIvLPGAZJUJtzblN/gl+/nu?=
 =?us-ascii?q?gGc9mV8cfqmmw4EbaX+lHvl9J0WZYHzsgsoOEGsQvwo+SvDqh0OGUTJJe3myWK?=
 =?us-ascii?q?c87CkhCI26FYfDWpytgLuZ0Se7BJJWZ3xGBUqLEXvyd4WERu0DaCSdIsJ6ljwE?=
 =?us-ascii?q?VL6hS5Iu1B20tQ/6zaZnIfTQ+iECqZ3j09117fXJlR4u7Tx0E9id02aVQmF2mW?=
 =?us-ascii?q?MHWSU63KN4oUx7zFeD1rN1g/hZFdxV+vNIXR02NZ/az+xmFd/yXhjNccuOSFaj?=
 =?us-ascii?q?Wt+mGy0+Tsotw98SZEZwA8+tjgvD3yqtAL8ZjaaLC4Y28q/H23jxJsB9y2vJ1a?=
 =?us-ascii?q?U7jlkmRNdPOnOihqJl6wfTAIvJmV2Dl6m2baQcwDLN9GCbwGqNpk5YVhR8UaHE?=
 =?us-ascii?q?XX8FYEvWos/05kfDT7+oFLQmPRFNyc+EKqtWdNLpiU9KS+vkONTbe2ixgXu/BQ?=
 =?us-ascii?q?6UxrOQa4rnY3gS0z/DCEcaiQwT/WyJNQ4lBii/pWLSCzhuFVHqY0Po6uR+rHK7?=
 =?us-ascii?q?TkkpzwCFdUFh1ry1+gILivyYUf8cwrUEuCI5oTVuAFm9x87WC8aHpwd5YapTe8?=
 =?us-ascii?q?0970ld2WLZrQN9OIegIL5khlMFdwR3vkXu1wh4C4lakMgqqm8qwxR2Ka6CzFxB?=
 =?us-ascii?q?cDaY14jqOrLLMmny4Ayva6nO11HC0daW/6AP6Og4q1Tjpg2pClAu83J909lR0n?=
 =?us-ascii?q?uc4JrKAREWUZLwVEY36hd7q6vbYik7+4Pby3lsPbOovT/F3tIjHPElxQq4f9dD?=
 =?us-ascii?q?LKOEExf/HNceB8ewJ+0lhVioYggfM+BP6aE7JcWmd/iB2K61J+tgmDOmjWJa4I?=
 =?us-ascii?q?FyyE6M9ix8SvLW0JYB2f2XwgyHVzLkhle7rs/3gZxEZS0VHmenySnkGZRdabFo?=
 =?us-ascii?q?cYcKCWehOcu3xtplip7pWn5Y8kOjBlwc1M+ofxqSc0Ly3QlK2UsLpnynnDOyzy?=
 =?us-ascii?q?ZonDExsqqfwCvOzvz4dBoGJmFEXnNigkrrIYSuidAVQlKobwkwmBS5/0n6w7VU?=
 =?us-ascii?q?q7plL2nUR0dFZCz2L2BkUqutubuOec9P6JU0sSpJVOSwe0yVSrn4oxECySPsA3?=
 =?us-ascii?q?NexCwndzGtopj4nx16hHidLXppt3rZZMdwyAzb5NzdQ/5RwzUHSDN5iTnRGliz?=
 =?us-ascii?q?Id2p8c+ImJfEt+C0T3ihWYFLcSn30YOAszO25W9wDh2lnPCzmdrnHRIh0SDh1N?=
 =?us-ascii?q?lqViTIrBDibYntzKm6NeNnfk91BF7z8cZ6G4d+kpcui5EUw3QVmpKV/X8fm2fp?=
 =?us-ascii?q?Ldpbwb7+bGYKRTMTw9/a+g/l1FdhLnKIwYL0TXGdwspnZ9mnbWIawCM978ZWCK?=
 =?us-ascii?q?iK6LxIhzd6ol29rQjJe/hygi8dyecy6H4dm+wJuxAiziSHDrASAElXJyrslxuT?=
 =?us-ascii?q?4tC6raVXYnuvcLeq2Ep/m9ChEK+NogVGVHnlfZciGDd67t9jP1LUzH3z9obkdc?=
 =?us-ascii?q?HVbdIStR2biQ3MjuZLJ5IqivoFmzBnNnnjsn0/xO42lhhu3ZC8vIiaJGRh5qO5?=
 =?us-ascii?q?AhhENjLrY8Mf4C3ijaFbnsyOxYCgAo1hGikXXJvvVf+oDDUStfH9OwePCjI8rG?=
 =?us-ascii?q?qbGaHEHQ+e80pmq3PPE5a2N3CYPnUZzNNiRAWDK0xbmgwbQDI6npshHACw2MPh?=
 =?us-ascii?q?aFt55iwW5lPgsRRD0OVoNx3iUmvFoAeodyw5SJyeLBpQ8wFD6F3ZMc2Y7uJvAS?=
 =?us-ascii?q?5Y+oetoxCKKmyefw5IF30GWlSYB1D/Obmj/dvA/PKdBuWgNPvCe6mOpfZdV/eV?=
 =?us-ascii?q?xpKvz41m8CyXNsiUOnliDvs72ldMXHxjGsTZnSkPRDITly7Xc8GboxK88DVtrs?=
 =?us-ascii?q?+j6PTrRB7v5YyXBrpSNtVv5gm2gbqZOO6Wnip5MjFY1pUDxXLTzLgf3VgSizxh?=
 =?us-ascii?q?djW3ELQAszLNQ7zUmqNNExEbbCZzPtNS760gxglNJdLbitTt2754kPE1ClRFVV?=
 =?us-ascii?q?/gms2zZswKOWa9NFzZC0aRKbSGPibGw8X2YaO6VL1Rg/9Ytxy2uTaHDUDjOi6P?=
 =?us-ascii?q?mCXuVxCqKetMlj2UPARCuIGhdRZgEXLsTM/9ZR2hLtB2jSc6wbk1hn7RMW4cMD?=
 =?us-ascii?q?58c15Cr7GK7CNYhOl/FHJF7nZ/MeaEnCOZ5fHCKpkKqftrHjh0l+VC7XQmyrtV?=
 =?us-ascii?q?6TtIS+BvlCTOrt5hvVemn/KLyjpmVhpOtzlKiJiKvUVkJaXW6J1AVWzY8xIK6G?=
 =?us-ascii?q?WaEw4KqMd9Ct3zp6BQzcDClaLpJzdE9tLU/M0cCNDVKcKHKnUhNxXpFSXQDAsE?=
 =?us-ascii?q?Sz6rKG7ei1ZckPGU6n2asJw6poLwl5oJT78IHGAyQ88dDFUtON0ELJhtUzVsxa?=
 =?us-ascii?q?Kcit8g7Ga5qRjdSYNRuZWRBdyIBvC6CzeCjb5CLyUJw7rpZa0ZLIT70kkqSxEu?=
 =?us-ascii?q?n4XRG03WdcxM5CZma1ln8w127HFiQzhriAreYQS37SpWTKbskw=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ARAABksvdbh0O0hNFiHAEBAQQBAQcEA?=
 =?us-ascii?q?QGBUQcBAQsBgmx/J4N5iBiLfoFgLRSDLpN5gXEUAQEYEwGIUiI0CQ0BAwEBAQE?=
 =?us-ascii?q?BAQIBEwEBAQgNCQgpIwyCNiQBgmIBAgMBAiAEGQEBNwEFCQEBChgCAiYCAgNEE?=
 =?us-ascii?q?AYLAgEFAgEBAYMcggIFpjRwfDOCdgEBBYJDhFAIgQuJYoEcEQaBf4ERJ4JriAK?=
 =?us-ascii?q?CV4sThEszj3MJkSkeiWGHJ5gJAgICAgQFAhSBRoINMyIbFYMnghuDbYpaOAExg?=
 =?us-ascii?q?QUBAYlVKYIkAQE?=
X-IPAS-Result: =?us-ascii?q?A0ARAABksvdbh0O0hNFiHAEBAQQBAQcEAQGBUQcBAQsBgmx?=
 =?us-ascii?q?/J4N5iBiLfoFgLRSDLpN5gXEUAQEYEwGIUiI0CQ0BAwEBAQEBAQIBEwEBAQgNC?=
 =?us-ascii?q?QgpIwyCNiQBgmIBAgMBAiAEGQEBNwEFCQEBChgCAiYCAgNEEAYLAgEFAgEBAYM?=
 =?us-ascii?q?cggIFpjRwfDOCdgEBBYJDhFAIgQuJYoEcEQaBf4ERJ4JriAKCV4sThEszj3MJk?=
 =?us-ascii?q?SkeiWGHJ5gJAgICAgQFAhSBRoINMyIbFYMnghuDbYpaOAExgQUBAYlVKYIkAQE?=
X-IronPort-AV: E=Sophos;i="5.56,268,1539673200"; 
   d="scan'208";a="54504691"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 22 Nov 2018 23:59:43 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2393519AbeKWSmp (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Fri, 23 Nov 2018 13:42:45 -0500
Received: from fllv0015.ext.ti.com ([198.47.19.141]:42226 "EHLO
        fllv0015.ext.ti.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1729827AbeKWSmp (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 23 Nov 2018 13:42:45 -0500
Received: from lelv0266.itg.ti.com ([10.180.67.225])
        by fllv0015.ext.ti.com (8.15.2/8.15.2) with ESMTP id wAN7xVhT070549;
        Fri, 23 Nov 2018 01:59:31 -0600
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=ti.com;
        s=ti-com-17Q1; t=1542959971;
        bh=5y01K78eceI8vVUZ4RQidg6M1quCMIqKPDZEdd/KYpY=;
        h=Subject:To:CC:References:From:Date:In-Reply-To;
        b=gDAHnhUsMCV2ndSx6PVw61iUsIo+4DPqxbe4I9DIAhBPvGIVluejuUgWp4Y+JzDiz
         Mi4cNkNBIL35fvANZuzfuU9MfLUiCCJLeMrpXhqXKQR553ctJkcIhfKIy8voaNbQuc
         ZiydpjjweSrBVvXux56MzLd8VtMUG/+tQfArRwAg=
Received: from DFLE101.ent.ti.com (dfle101.ent.ti.com [10.64.6.22])
        by lelv0266.itg.ti.com (8.15.2/8.15.2) with ESMTPS id wAN7xVLX024938
        (version=TLSv1.2 cipher=AES256-GCM-SHA384 bits=256 verify=FAIL);
        Fri, 23 Nov 2018 01:59:31 -0600
Received: from DFLE114.ent.ti.com (10.64.6.35) by DFLE101.ent.ti.com
 (10.64.6.22) with Microsoft SMTP Server (version=TLS1_2,
 cipher=TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256_P256) id 15.1.1591.10; Fri, 23
 Nov 2018 01:59:31 -0600
Received: from dlep33.itg.ti.com (157.170.170.75) by DFLE114.ent.ti.com
 (10.64.6.35) with Microsoft SMTP Server (version=TLS1_0,
 cipher=TLS_RSA_WITH_AES_256_CBC_SHA) id 15.1.1591.10 via Frontend Transport;
 Fri, 23 Nov 2018 01:59:31 -0600
Received: from [172.24.190.233] (ileax41-snat.itg.ti.com [10.172.224.153])
        by dlep33.itg.ti.com (8.14.3/8.13.8) with ESMTP id wAN7xSf9017028;
        Fri, 23 Nov 2018 01:59:29 -0600
Subject: Re: [PATCH 2/2] phy: mapphone-mdm6600: Improve phy related runtime PM
 calls
To: Tony Lindgren <tony@atomide.com>
CC: <linux-kernel@vger.kernel.org>, <linux-usb@vger.kernel.org>,
        <linux-omap@vger.kernel.org>, Pavel Machek <pavel@ucw.cz>,
        Sebastian Reichel <sre@kernel.org>
References: <20181117133755.9129-1-tony@atomide.com>
 <20181117133755.9129-3-tony@atomide.com>
From: Kishon Vijay Abraham I <kishon@ti.com>
Message-ID: <ac3a7cdd-4f03-069f-844a-072e99759c83@ti.com>
Date: Fri, 23 Nov 2018 13:29:24 +0530
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101
 Thunderbird/60.2.1
MIME-Version: 1.0
In-Reply-To: <20181117133755.9129-3-tony@atomide.com>
Content-Type: text/plain; charset="utf-8"
Content-Language: en-US
Content-Transfer-Encoding: 7bit
X-EXCLAIMER-MD-CONFIG: e1e8a2fd-e40a-4ac6-ac9b-f7e9cc9ee180
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Hi Tony,

On 17/11/18 7:07 PM, Tony Lindgren wrote:
> I noticed that phy_pm_runtime_get_sync() and phy_pm_runtime_put() are not
> currently doing anything for phy-mapphone-mdm6600, only the sysfs interface
> for works for "auto" and "on".
> 
> This is because of the shared GPIO pins between mdm6600 USB port and n_gsm
> port. We have not enabled runtime PM for the phy driver until after we've
> booted up mdm6600 properly to the USB mode. Otherwise phy_create() would
> have called pm_runtime_enable() and pm_runtime_no_callbacks() automatically
> on init.
> 
> Let's fix this by registering the phy a bit later after we've powered up the
> mdm6600 USB port.
> 
> And as the PM runtime support is only needed for the n_gsm mode and not for
> USB, we can allow the device to idle between phy_mdm6600_power_on() and
> phy_mdm6600_power_off(). Note that for suspend, runtime_pm is already
> disabled for the phy so we need to check for phy_pm_runtime_enabled().
> 
> Cc: Pavel Machek <pavel@ucw.cz>
> Cc: Sebastian Reichel <sre@kernel.org>
> Signed-off-by: Tony Lindgren <tony@atomide.com>
> ---
>  drivers/phy/motorola/phy-mapphone-mdm6600.c | 71 +++++++++++++++------
>  1 file changed, 51 insertions(+), 20 deletions(-)
> 
> diff --git a/drivers/phy/motorola/phy-mapphone-mdm6600.c b/drivers/phy/motorola/phy-mapphone-mdm6600.c
> --- a/drivers/phy/motorola/phy-mapphone-mdm6600.c
> +++ b/drivers/phy/motorola/phy-mapphone-mdm6600.c
> @@ -16,6 +16,7 @@
>  #include <linux/gpio/consumer.h>
>  #include <linux/of_platform.h>
>  #include <linux/phy/phy.h>
> +#include <linux/pinctrl/consumer.h>
>  
>  #define PHY_MDM6600_PHY_DELAY_MS	4000	/* PHY enable 2.2s to 3.5s */
>  #define PHY_MDM6600_ENABLED_DELAY_MS	8000	/* 8s more total for MDM6600 */
> @@ -124,12 +125,22 @@ static int phy_mdm6600_power_on(struct phy *x)
>  {
>  	struct phy_mdm6600 *ddata = phy_get_drvdata(x);
>  	struct gpio_desc *enable_gpio = ddata->ctrl_gpios[PHY_MDM6600_ENABLE];
> +	int error;
>  
>  	if (!ddata->enabled)
>  		return -ENODEV;
>  
> +	error = pinctrl_pm_select_default_state(ddata->dev);
> +	if (error)
> +		dev_warn(ddata->dev, "%s: error with default_state: %i\n",
> +			 __func__, error);
> +
>  	gpiod_set_value_cansleep(enable_gpio, 1);
>  
> +	/* Allow aggressive PM for USB, it's only needed for n_gsm port */
> +	if (phy_pm_runtime_enabled(ddata->generic_phy))
> +		phy_pm_runtime_put(ddata->generic_phy);

phy_*() API's are generally added to be used by the consumer driver. I guess in
this case we can directly use pm_runtime_enabled(x).

Thanks
Kishon
