Return-Path: <virtualization-bounces@lists.linux-foundation.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 23:49:35 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from fmsmga006.fm.intel.com (fmsmga006.fm.intel.com [10.253.24.20])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 75F9158037D
	for <like.xu@linux.intel.com>; Fri, 23 Nov 2018 07:41:36 -0800 (PST)
Received: from orsmga106.jf.intel.com ([10.7.208.65])
  by fmsmga006-1.fm.intel.com with ESMTP; 23 Nov 2018 07:41:36 -0800
IronPort-PHdr: =?us-ascii?q?9a23=3A99YZERerl+/CTVopavGltJDYlGMj4u6mDksu8pMi?=
 =?us-ascii?q?zoh2WeGdxc26bBWN2/xhgRfzUJnB7Loc0qyK6/CmATRIyK3CmUhKSIZLWR4BhJ?=
 =?us-ascii?q?detC0bK+nBN3fGKuX3ZTcxBsVIWQwt1Xi6NU9IBJS2PAWK8TW94jEIBxrwKxd+?=
 =?us-ascii?q?KPjrFY7OlcS30P2594HObwlSizexfbB/IA+qoQnNq8IbnZZsJqEtxxXTv3BGYf?=
 =?us-ascii?q?5WxWRmJVKSmxbz+MK994N9/ipTpvws6ddOXb31cKokQ7NYCi8mM30u683wqRbD?=
 =?us-ascii?q?VwqP6WACXWgQjxFFHhLK7BD+Xpf2ryv6qu9w0zSUMMHqUbw5Xymp4rx1QxH0li?=
 =?us-ascii?q?gIKz858HnWisNuiqJbvAmhrAF7z4LNfY2ZKOZycqbbcNgHR2ROQ9xRWjRPDI28?=
 =?us-ascii?q?cYUBEukPPehXoIbgpVQOtRmzCwujCe/yxDJEmmP506Ih0+s/CgzGwA4tEsgSvH?=
 =?us-ascii?q?jIsNn5KqEfWv21wqnSyjXDautb1Tn65ojJbh8hoeuDUqx0ccHM1EcjDR7OgEuL?=
 =?us-ascii?q?qYzkJTOV1eUNs26V4+F9Uu+vjnUnqx1qrzi12Mgjl4nJiZgJylze6Sp5x4M1KM?=
 =?us-ascii?q?S+RUVmb9CkF55QuDubN4twWs4iR2BouCAnyrwJt567ezUKyJI6yBHFd/yHco+I?=
 =?us-ascii?q?4hT5WOaWOzd4i3Roc6+8iRaq6UWs1+LxWtWu3FpUsyZJj8PAum0M2hHX8MSLV+?=
 =?us-ascii?q?Vx8l+/1TqT0w3f8PxILE4qmabBNpIswbA9moANvUnAGCL9hV/4g7WMdko+/+il?=
 =?us-ascii?q?8+Tnbavipp+bL4J0jxvxMqUqmsClBeQ4Mw4OX3WU+OSy073j4Ev5T6hQgf0qk6?=
 =?us-ascii?q?nZt5baKd4cpq6jDA9Zyocj6xChADe6yNkUgHYKIE5fdB6ZkoTlJkvCLO35APq7?=
 =?us-ascii?q?mVigjSlny+jDPrL7A5XNKnbDkK3mfbZ480Nc1gszzcpD55JJEL4BJPPzW07ru9?=
 =?us-ascii?q?zEDx85NAq0z//8B9V6y4MeX36ADbGCMK7JtV+I5/kvI/WXZIMPvDb9Kv4l5+Ph?=
 =?us-ascii?q?jHMgl18derSp3Z0KZ3+iAvRmIkKZYXz2jtcGC2cKsRIyTPb2h12aTT5Te3GyUr?=
 =?us-ascii?q?o45jE6C4KpE53PR4+wgLGa2Ce7H5tWZn1JC1yWEHfocZmEVOkIaC6IPsBhlTkE?=
 =?us-ascii?q?BvCcTZQ830SuqBPi0Oggae7V4TED85bi0sVl6erOkx076T1zCYKayW7KSmh1mm?=
 =?us-ascii?q?YBQXgxxLx+pkpmjUmCy7RlivhZB9VP5vRPATo8LoPWmulzCtTuXVDff82VVV+i?=
 =?us-ascii?q?Q8evHTA2SJcrzsYTbl1hM9GjlQzYmS6rBaIF0rKMGZo4+77d2H63INxynG3b3q?=
 =?us-ascii?q?sshEVzX81UKGe9jbR+/QWAO4mcsUyCkKDiSq0a02aZ9m6YynWHuk5wSgN8UazZ?=
 =?us-ascii?q?G3sYYx2Fg87+4xaIar6lCb0qNkN6j4a+MapQadzvxx0SQez/EM7Tb2K4hyG7Ah?=
 =?us-ascii?q?PeleDEV5bjZ2hIhHaVM0MDiQ1GuC/ebQU=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AfAABIH/hbhwyp04xjGgEBAQEBAgEBA?=
 =?us-ascii?q?QEHAgEBAQGBZYJqgRYTjHCLIYINgR6YDhYYCwmDeoRgIjgSAQMBAQEBAQECARM?=
 =?us-ascii?q?BAQEKCwkIKSMMgjYFAgMaAQaCWwEBAQECAQEBASQTDAoeCwMCAQECBgEBCg4KH?=
 =?us-ascii?q?gQECAMBIwEVGgYTBYMcAYF5CAUKp3gzihUFjAkRBoF/hCODGwEEhzkCiRmGQzR?=
 =?us-ascii?q?Ojl5GBwIChnqDLYJrhBsCFoFZh3YCNocBLI0Xim2BXYF2cBU7gmyCUIhMhVwhA?=
 =?us-ascii?q?QExgSOKDoF3AQE?=
X-IPAS-Result: =?us-ascii?q?A0AfAABIH/hbhwyp04xjGgEBAQEBAgEBAQEHAgEBAQGBZYJ?=
 =?us-ascii?q?qgRYTjHCLIYINgR6YDhYYCwmDeoRgIjgSAQMBAQEBAQECARMBAQEKCwkIKSMMg?=
 =?us-ascii?q?jYFAgMaAQaCWwEBAQECAQEBASQTDAoeCwMCAQECBgEBCg4KHgQECAMBIwEVGgY?=
 =?us-ascii?q?TBYMcAYF5CAUKp3gzihUFjAkRBoF/hCODGwEEhzkCiRmGQzROjl5GBwIChnqDL?=
 =?us-ascii?q?YJrhBsCFoFZh3YCNocBLI0Xim2BXYF2cBU7gmyCUIhMhVwhAQExgSOKDoF3AQE?=
X-IronPort-AV: E=Sophos;i="5.56,270,1539673200"; 
   d="scan'208";a="41310999"
X-Amp-Result: UNSCANNABLE
X-Amp-File-Uploaded: False
Unscannable: 2
Received: from mail.linuxfoundation.org ([140.211.169.12])
  by mtab.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 07:41:35 -0800
Received: from mail.linux-foundation.org (localhost [127.0.0.1])
	by mail.linuxfoundation.org (Postfix) with ESMTP id 022ABC9E;
	Fri, 23 Nov 2018 15:41:32 +0000 (UTC)
X-Original-To: virtualization@lists.linux-foundation.org
Delivered-To: virtualization@mail.linuxfoundation.org
Received: from smtp1.linuxfoundation.org (smtp1.linux-foundation.org
	[172.17.192.35])
	by mail.linuxfoundation.org (Postfix) with ESMTPS id 4C49CB77
	for <virtualization@lists.linux-foundation.org>;
	Fri, 23 Nov 2018 15:41:27 +0000 (UTC)
X-Greylist: domain auto-whitelisted by SQLgrey-1.7.6
Received: from mx1.redhat.com (mx1.redhat.com [209.132.183.28])
	by smtp1.linuxfoundation.org (Postfix) with ESMTPS id EC40C19B
	for <virtualization@lists.linux-foundation.org>;
	Fri, 23 Nov 2018 15:41:26 +0000 (UTC)
Received: from smtp.corp.redhat.com (int-mx06.intmail.prod.int.phx2.redhat.com
	[10.5.11.16])
	(using TLSv1.2 with cipher AECDH-AES256-SHA (256/256 bits))
	(No client certificate requested)
	by mx1.redhat.com (Postfix) with ESMTPS id 4C17E307EA83;
	Fri, 23 Nov 2018 15:41:26 +0000 (UTC)
Received: from redhat.com (ovpn-121-146.rdu2.redhat.com [10.10.121.146])
	by smtp.corp.redhat.com (Postfix) with SMTP id 908535C548;
	Fri, 23 Nov 2018 15:41:25 +0000 (UTC)
Date: Fri, 23 Nov 2018 10:41:25 -0500
From: "Michael S. Tsirkin" <mst@redhat.com>
To: Jason Wang <jasowang@redhat.com>
Subject: Re: [PATCH net-next 3/3] vhost: don't touch avail ring if in_order
	is negotiated
Message-ID: <20181123103750-mutt-send-email-mst@kernel.org>
References: <20181123030016.4924-1-jasowang@redhat.com>
	<20181123030016.4924-4-jasowang@redhat.com>
MIME-Version: 1.0
Content-Disposition: inline
In-Reply-To: <20181123030016.4924-4-jasowang@redhat.com>
X-Scanned-By: MIMEDefang 2.79 on 10.5.11.16
X-Greylist: Sender IP whitelisted, not delayed by milter-greylist-4.5.16
	(mx1.redhat.com [10.5.110.44]);
	Fri, 23 Nov 2018 15:41:26 +0000 (UTC)
X-Spam-Status: No, score=-6.9 required=5.0 tests=BAYES_00,RCVD_IN_DNSWL_HI
	autolearn=ham version=3.3.1
X-Spam-Checker-Version: SpamAssassin 3.3.1 (2010-03-16) on
	smtp1.linux-foundation.org
Cc: netdev@vger.kernel.org, linux-kernel@vger.kernel.org, kvm@vger.kernel.org,
	virtualization@lists.linux-foundation.org
X-BeenThere: virtualization@lists.linux-foundation.org
X-Mailman-Version: 2.1.12
Precedence: list
List-Id: Linux virtualization <virtualization.lists.linux-foundation.org>
List-Unsubscribe: <https://lists.linuxfoundation.org/mailman/options/virtualization>,
	<mailto:virtualization-request@lists.linux-foundation.org?subject=unsubscribe>
List-Archive: <http://lists.linuxfoundation.org/pipermail/virtualization/>
List-Post: <mailto:virtualization@lists.linux-foundation.org>
List-Help: <mailto:virtualization-request@lists.linux-foundation.org?subject=help>
List-Subscribe: <https://lists.linuxfoundation.org/mailman/listinfo/virtualization>,
	<mailto:virtualization-request@lists.linux-foundation.org?subject=subscribe>
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Sender: virtualization-bounces@lists.linux-foundation.org
Errors-To: virtualization-bounces@lists.linux-foundation.org

On Fri, Nov 23, 2018 at 11:00:16AM +0800, Jason Wang wrote:
> Device use descriptors table in order, so there's no need to read
> index from available ring. This eliminate the cache contention on
> avail ring completely.

Well this isn't what the in order feature says in the spec.

It forces the used ring to be in the same order as
the available ring. So I don't think you can skip
checking the available ring. And in fact depending on
ring size and workload, using all of descriptor buffer might
cause a slowdown.
Rather you should be able to get
about the same speedup, but from skipping checking
the used ring in virtio.


> Virito-user + vhost_kernel + XDP_DROP gives about ~10% improvement on
> TX from 4.8Mpps to 5.3Mpps on Intel(R) Core(TM) i7-5600U CPU @
> 2.60GHz.
> 
> Signed-off-by: Jason Wang <jasowang@redhat.com>
> ---
>  drivers/vhost/vhost.c | 19 ++++++++++++-------
>  1 file changed, 12 insertions(+), 7 deletions(-)
> 
> diff --git a/drivers/vhost/vhost.c b/drivers/vhost/vhost.c
> index 3a5f81a66d34..c8be151bc897 100644
> --- a/drivers/vhost/vhost.c
> +++ b/drivers/vhost/vhost.c
> @@ -2002,6 +2002,7 @@ int vhost_get_vq_desc(struct vhost_virtqueue *vq,
>  	__virtio16 avail_idx;
>  	__virtio16 ring_head;
>  	int ret, access;
> +	bool in_order = vhost_has_feature(vq, VIRTIO_F_IN_ORDER);
>  
>  	/* Check it isn't doing very strange things with descriptor numbers. */
>  	last_avail_idx = vq->last_avail_idx;
> @@ -2034,15 +2035,19 @@ int vhost_get_vq_desc(struct vhost_virtqueue *vq,
>  
>  	/* Grab the next descriptor number they're advertising, and increment
>  	 * the index we've seen. */
> -	if (unlikely(vhost_get_avail(vq, ring_head,
> -		     &vq->avail->ring[last_avail_idx & (vq->num - 1)]))) {
> -		vq_err(vq, "Failed to read head: idx %d address %p\n",
> -		       last_avail_idx,
> -		       &vq->avail->ring[last_avail_idx % vq->num]);
> -		return -EFAULT;
> +	if (!in_order) {
> +		if (unlikely(vhost_get_avail(vq, ring_head,
> +		    &vq->avail->ring[last_avail_idx & (vq->num - 1)]))) {
> +			vq_err(vq, "Failed to read head: idx %d address %p\n",
> +				last_avail_idx,
> +				&vq->avail->ring[last_avail_idx % vq->num]);
> +			return -EFAULT;
> +		}
> +		head = vhost16_to_cpu(vq, ring_head);
> +	} else {
> +		head = last_avail_idx & (vq->num - 1);
>  	}
>  
> -	head = vhost16_to_cpu(vq, ring_head);
>  
>  	/* If their number is silly, that's an error. */
>  	if (unlikely(head >= vq->num)) {
> -- 
> 2.17.1
_______________________________________________
Virtualization mailing list
Virtualization@lists.linux-foundation.org
https://lists.linuxfoundation.org/mailman/listinfo/virtualization
