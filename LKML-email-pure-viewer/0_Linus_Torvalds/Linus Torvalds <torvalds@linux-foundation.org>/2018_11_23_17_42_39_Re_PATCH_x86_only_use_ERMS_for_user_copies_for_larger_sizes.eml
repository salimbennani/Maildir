Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 24 Nov 2018 12:36:36 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga001.jf.intel.com (orsmga001.jf.intel.com [10.7.209.18])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 7DCD858037D;
	Fri, 23 Nov 2018 09:43:12 -0800 (PST)
Received: from fmsmga101.fm.intel.com ([10.1.193.65])
  by orsmga001-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 23 Nov 2018 09:43:11 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AJVfJwR8Uklrrwv9uRHKM819IXTAuvvDOBiVQ1KB9?=
 =?us-ascii?q?1+0RIJqq85mqBkHD//Il1AaPAd2Lraocw8Pt8InYEVQa5piAtH1QOLdtbDQizf?=
 =?us-ascii?q?ssogo7HcSeAlf6JvO5JwYzHcBFSUM3tyrjaRsdF8nxfUDdrWOv5jAOBBr/KRB1?=
 =?us-ascii?q?JuPoEYLOksi7ze+/94HQbglSmDaxfa55IQmrownWqsQYm5ZpJLwryhvOrHtIeu?=
 =?us-ascii?q?BWyn1tKFmOgRvy5dq+8YB6/ShItP0v68BPUaPhf6QlVrNYFygpM3o05MLwqxbO?=
 =?us-ascii?q?SxaE62YGXWUXlhpIBBXF7A3/U5zsvCb2qvZx1S+HNsDtU7s6RSqt4LtqSB/wiS?=
 =?us-ascii?q?cIKTg58H3MisdtiK5XuQ+tqwBjz4LRZoyeKfhwcb7Hfd4CSmVBUMReWSxPDI2/?=
 =?us-ascii?q?coUBEfYOPf1Ar4T/vFYOqAeyCBO2Ce/z1jNFhHn71rA63eQ7FgHG2RQtEdQPsH?=
 =?us-ascii?q?TSsdX1L7oZX/6yzKnS0zXMdfdW1irm6IPVdR0hvfaMXahuccXLzUkgChjFg06U?=
 =?us-ascii?q?qYzkOTOVy+sMv3GV7+pnSOKvjXMopBttojiuwccsjJPFhoUPylDL7Ch0xps+K9?=
 =?us-ascii?q?6gSENjf9KoDJ9duzuHO4Z4XM8uWXxktSUmxrEcuJO2fjAGxIo7yxPbcfCKcIiF?=
 =?us-ascii?q?7gj9WOqNIjp0nm9pdbCjixu07EOu0PfzVtOu31ZPtidFksfDtnQK1xHL9MiHRe?=
 =?us-ascii?q?Vy/l271TaMyQ/T8OdELl4wlabBLJ4h2LEwmoISsUTFACD2hF37gLGKekgg4OSk?=
 =?us-ascii?q?9urqbqv8qpOBNIJ4lhvyP6Usl8CnBOQ3KAkOX2yV+eSm073j+FX0QLFLjv0wj6?=
 =?us-ascii?q?nYv4nWJccFqa6jBQ9azIIj5w+4Dzao1tQXg2MHIUlbeBKIkYfpIUvCIPPmAvel?=
 =?us-ascii?q?hVSjjjNry+rBPr37DZXBNmLDn6v5fbZh905czxI+zdRe55JXFL4NOv3yWlLqud?=
 =?us-ascii?q?zcDx85NRG0wun9BNV80IMeRXyAAquDPKzOtl+I4/olI/OQa48NpDb9N/8l6ubu?=
 =?us-ascii?q?jXAjmF8dYbOm3ZwNZHC4A/RpOUOZYXX3j9cFEGcKuBc+TePwhF2DVz5Te2i9X6?=
 =?us-ascii?q?Ym6j4nD4KmCJ/JRpqxj7yZwCe7AppWa3hEClCLD3jkbYaEW/AKaCKUJc9siTgE?=
 =?us-ascii?q?VbmnS4882hCirg76y7x7LuXK/i0Ur47s1N9w5+fLjxE96SR0D9iB02GKV2x7hH?=
 =?us-ascii?q?gIRz8x3KB8u0B90E2M0apjjvxcFNxT4e5JUwggOZ7dyex6F879WgbbctiVT1am?=
 =?us-ascii?q?R82sASstQdIp398Of0F9Fs2hjh/Z2SqmGbsVl72RC5wy/aLRxHzxJ8d7y3bb26?=
 =?us-ascii?q?gtlVgmQs1TNWK4gq5z7RTcB4nMk0+Bjaalabwc3DLR9GeE1WeBoVtXUBBuXqnf?=
 =?us-ascii?q?XXAQfE3Wrc/n6UPESLOuDbcnMg5FycOZLqtKa9vpjUhJRfv5OdTeZX6xlHm0BR?=
 =?us-ascii?q?qS2ryMa4/qcX0H3CrBEEgEjxwT/XGeOAcjHCihvXzRACZuFV31ZUPs6vdxqHWg?=
 =?us-ascii?q?Q08wzgGKaVBh1rWv9h4Ug/ycV+0c3rYetCg9rDV0GU6338jKBNqYuwphYKJcbM?=
 =?us-ascii?q?sh4FdG0GLZsBB9PpygLqx4ml4SaQN3v1nq1xV2DIVAntMnrHcrzAp0NKKZ30lN?=
 =?us-ascii?q?dzKe3ZDsJLLXLnP+8wyoa67TwlveysqZ+r8T6PQkrFXupBumFk48/HRozdZU02?=
 =?us-ascii?q?GQ6Y7XDAUPS53xVEU39x9kp7zBZik95oXU1WBjMKWusz/C3c4pC/Uhyhq6Y9hf?=
 =?us-ascii?q?N6aEHhfoE8IGH8iuNPAqm1+xYxMEIeBe7rI7M9mndvuGwqGrOulgkSmijWRG5o?=
 =?us-ascii?q?B9z02N+zB9Su7Ow5YK3fWY0hGbWDf7iVerqtr3lpxcZTEOAmq/zjDpBJRQZqJu?=
 =?us-ascii?q?Z4kLE3qhI8qtytV4mZHtQX9Y+Ee/CFwc3M+mZASdb0b63Q1WzkkXpX2nmS2lzz?=
 =?us-ascii?q?17iT0pr6yf3DDQzOTmbhYIJmlLRGx6h1f2PYe0l8waXFSvbwUxlBql5Fz2xqhB?=
 =?us-ascii?q?qKRkMmnTR1xFfyz3L2FkT6uxuaCOY89J6JM0rypXVP6wbkydSr74uxEayT/sH3?=
 =?us-ascii?q?NCxDAncDGnopf5kAZgiGKeL3Zzq2DVedpqyhfc59zcRPhR0SQARCRjjTnXB168?=
 =?us-ascii?q?P8Sm/NmOlpfDtPy+WHylVpFJbSbryoaAvjOh5WJ2GR2/g+yzmtr/HAk6yyD70M?=
 =?us-ascii?q?NmVSfJrBb6eYTr06W6MeR6fkhnHlP86sx6Gp1gnYs0np0fxX8ahpCN93odjWjz?=
 =?us-ascii?q?Kclb2b75bHcVRj4E2d/V7BLl2E1+NH2JwY35W26ZwstgYdm6f2wX1jg878BMFK?=
 =?us-ascii?q?eb8rhEkTFprVq/qALbeeJ9kSsFyfsy9H4ahPkEuA8sziWeGL8eB0dZMjL3lxSU?=
 =?us-ascii?q?8d++tr5Ya3i1cbi/z0d+mdGhDLefogBTQnr5e5EiHTNu4cV7Kl7DzHrz6oT8ct?=
 =?us-ascii?q?nKcd0TrgGUkwvHj+VNNJIxkf8KiTBmOG3nu30l1vU7jQdv3ZyhuIiHKmNt/L+2?=
 =?us-ascii?q?AxJCNz31Yd8T9S/pjapEgsmW2IWvFI17GjoXRJvoUe6oEDUKuPv8LQmOFzk8qm?=
 =?us-ascii?q?qBFbrbAA+S80Nmr3PJE5C2OHCbPngZzdN+RBaDIExTmhwbXDI/npQhDACl2NTh?=
 =?us-ascii?q?cFtl5jAW/lP4qAFDyud2OBnkSGvfuB2kajQpSJicMRpW6BtN51zOPMya7+JzGT?=
 =?us-ascii?q?xY/5K7oAyMLGybexpHDWUTVkOYAFDjO6Gk5cPc/OiAGuq+M/zObK2OqOxZSveI?=
 =?us-ascii?q?3I+v3ZFg/zqWLcWPOX9iD/Ig10pHXHB5HdnZmjoVRywWkSLNc9CUpBOm9iJrqc?=
 =?us-ascii?q?C/9ezhWBjz6ouXF7tSLdJv9gi2gaidNu6QhyV5KTdC2pMP33/Iz7cf00AIiyFz?=
 =?us-ascii?q?bDmgCrAAtS/LTKLNla5bFR8bayVvNMRW66IwxBVCOcneitntzL53kuY1C0tZVV?=
 =?us-ascii?q?zmgsymf9EKLHqnNFzZBEeHLrCGJTzQzsHzYKO8T6BQjepOux2xvzabD1HsPjCZ?=
 =?us-ascii?q?mzb1UBCvNPlGjDuHMxxGpIG9bhFtBHD/TNLnbx23KsN4gScqzr00mHzKM3URMT?=
 =?us-ascii?q?x9c0NLs72R4jlUgvR5G2xd8HVlKfOIlDqe7+ndMpwWq+dkAjxol+JG53Q307tU?=
 =?us-ascii?q?4ztCRPxwmSvSqMZholCmkuaVzDpnXwFDqjJKhIKNoEVjNr/V9phGWXbY4h0N6X?=
 =?us-ascii?q?+cBAgNp9tgWZXTvPV8w8bOmOTXITZN88789MABA8HebsmANSkPKx3sTRrVChYe?=
 =?us-ascii?q?BQKsL3/Wg0BG2KWO8WeLp5w2sbDomZwTWvpVU0EzGvoGC0NjWtsYL8EkDXsfjb?=
 =?us-ascii?q?eHgZtQtjKFpx7LSZAf58ifWw=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AXAACIO/hbh0O0hNFjHgEGBwaBUQkLA?=
 =?us-ascii?q?YNrJ4N5gR2HWoshgg0UlyeBcxMBGBMBiFoiNAkNAQMBAQEBAQECARMBAQEIDQk?=
 =?us-ascii?q?IKSMMgjYkAYJiAQIDAQIgHQEBNwEFCQEBCgsNKgICAgEfEgEFARwZBQODGQGCA?=
 =?us-ascii?q?QWbPjyKHXCBL4J2AQEFhw4HCBKLdxeBf4ERgxKIAoJXixOEf48sRgmEIYF0ixo?=
 =?us-ascii?q?YiVGHN5gJAgQCBAUCBQ8hgSWCDU0wCGwGgjWCGwkDF4hehV8fMoEFAQGMIQEB?=
X-IPAS-Result: =?us-ascii?q?A0AXAACIO/hbh0O0hNFjHgEGBwaBUQkLAYNrJ4N5gR2HWos?=
 =?us-ascii?q?hgg0UlyeBcxMBGBMBiFoiNAkNAQMBAQEBAQECARMBAQEIDQkIKSMMgjYkAYJiA?=
 =?us-ascii?q?QIDAQIgHQEBNwEFCQEBCgsNKgICAgEfEgEFARwZBQODGQGCAQWbPjyKHXCBL4J?=
 =?us-ascii?q?2AQEFhw4HCBKLdxeBf4ERgxKIAoJXixOEf48sRgmEIYF0ixoYiVGHN5gJAgQCB?=
 =?us-ascii?q?AUCBQ8hgSWCDU0wCGwGgjWCGwkDF4hehV8fMoEFAQGMIQEB?=
X-IronPort-AV: E=Sophos;i="5.56,270,1539673200"; 
   d="diff'?scan'208";a="63713244"
X-Amp-Result: UNKNOWN
X-Amp-Original-Verdict: FILE UNKNOWN
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mga01b.intel.com with ESMTP; 23 Nov 2018 09:43:09 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2440985AbeKXE2T (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Fri, 23 Nov 2018 23:28:19 -0500
Received: from mail-lf1-f68.google.com ([209.85.167.68]:36741 "EHLO
        mail-lf1-f68.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S2388738AbeKXE2R (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Fri, 23 Nov 2018 23:28:17 -0500
Received: by mail-lf1-f68.google.com with SMTP id a16so9221051lfg.3
        for <linux-kernel@vger.kernel.org>; Fri, 23 Nov 2018 09:43:02 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=linux-foundation.org; s=google;
        h=mime-version:references:in-reply-to:from:date:message-id:subject:to
         :cc;
        bh=eRLaDoqDQyDzybsiVG52hhNs3y8bOzLOSLe2iT/iqao=;
        b=BIWL6o70yxUhnN8RqTGNNy2LI1uo3Qq3WOowxayOXyG/BC7Pv3Om1q04TSNZHXwrRa
         aQ6sq4Qiow8mnfjQGjdTASx/ZuQo48SAUnt9zUrXAbuGFmU8u40WEURBlDRC7mzCYgZF
         pRf/FlVhArGoSo1VQ8ac9Uszf+SJp5KeNhbV8=
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:mime-version:references:in-reply-to:from:date
         :message-id:subject:to:cc;
        bh=eRLaDoqDQyDzybsiVG52hhNs3y8bOzLOSLe2iT/iqao=;
        b=P3HXnwKAzYWsDiuIdg14PJwIRLtlegSJUSHSA4roXwjhyA/aBLC3suWqNbrDheTgNC
         QwgQILFfAJ+dBWu/sO+J01/1v9bHz8TNEfs7xPnXHVR96huzcjrl3I/7NTTfUiHbNm8w
         bw6I3QUky2SXRdf9OttAqz35Qe4SxRfAQ4YijvweP07RkB5ehYUPfHPWTViJs8tODDd9
         3qOO6tusvpYKTArK2Q+LMkW9qCP1OGclFj81YfJma9TDku9U8MxLuyPpuRjmJwjA22EW
         moPyJhI0pZCD3Zy6gVMD17dX9vNAaba1OMVXPmk3mFmwmPh9YNOw/xI6KHQI1uLDgWg/
         1NAQ==
X-Gm-Message-State: AGRZ1gJkoGX0x8e6rAo23EYayBmH22pMo+UXha1ww33Ake67MbZiZpBC
        PXZuGOZMk2HBZu8B0V0KEPDb7dDjV8Ge+w==
X-Google-Smtp-Source: AJdET5cQyGzjg5abcEZ4DArXBnY3Tsn7vUnc7fhhI+vNNZNQ1J5QO6lRRbEzsqLF/4NF7T3xaRAwqw==
X-Received: by 2002:a19:5510:: with SMTP id n16mr9678380lfe.68.1542994980647;
        Fri, 23 Nov 2018 09:43:00 -0800 (PST)
Received: from mail-lj1-f170.google.com (mail-lj1-f170.google.com. [209.85.208.170])
        by smtp.gmail.com with ESMTPSA id b25-v6sm7829635lji.94.2018.11.23.09.42.57
        for <linux-kernel@vger.kernel.org>
        (version=TLS1_2 cipher=ECDHE-RSA-AES128-GCM-SHA256 bits=128/128);
        Fri, 23 Nov 2018 09:42:57 -0800 (PST)
Received: by mail-lj1-f170.google.com with SMTP id c19-v6so11303099lja.5
        for <linux-kernel@vger.kernel.org>; Fri, 23 Nov 2018 09:42:57 -0800 (PST)
X-Received: by 2002:a2e:2416:: with SMTP id k22-v6mr11794449ljk.80.1542994976708;
 Fri, 23 Nov 2018 09:42:56 -0800 (PST)
MIME-Version: 1.0
References: <02bfc577-32a5-66be-64bf-d476b7d447d2@kernel.dk>
 <20181121063609.GA109082@gmail.com> <48e27a3a-2bb2-ff41-3512-8aeb3fd59e57@kernel.dk>
 <26eff539-7de7-784c-0c88-f1d30753299d@redhat.com> <7ea44458b90b4d41a08ba9012818d273@AcuMS.aculab.com>
 <CAHk-=wjLNuNpHRfuVTb6awstC9OOmSb3S8aP51ufep-Th4dXKw@mail.gmail.com>
 <CALCETrW=hMZLUM_nPEEgUW9x9Bmhm2LZ6ZRDiRRguxVT=-_BWA@mail.gmail.com>
 <CAHk-=wiEUVpSU-GxpKDvN9wnH2yDxkJgE7Vqh46A+fmnvhubyw@mail.gmail.com>
 <cd11d9423c8b46ecbf97753f8317c294@AcuMS.aculab.com> <64fd67993af04579b5262c270a7a4694@AcuMS.aculab.com>
 <CAHk-=wj9DA-mH8jahuEPUWxO4EgbCcPRgdOJAQD58DBtCCrHcQ@mail.gmail.com>
In-Reply-To: <CAHk-=wj9DA-mH8jahuEPUWxO4EgbCcPRgdOJAQD58DBtCCrHcQ@mail.gmail.com>
From: Linus Torvalds <torvalds@linux-foundation.org>
Date: Fri, 23 Nov 2018 09:42:39 -0800
X-Gmail-Original-Message-ID: <CAHk-=wjrdrZW5VgnKXqdayafYmQC2HBEA4kzMWYTyaj5jgURdA@mail.gmail.com>
Message-ID: <CAHk-=wjrdrZW5VgnKXqdayafYmQC2HBEA4kzMWYTyaj5jgURdA@mail.gmail.com>
Subject: Re: [PATCH] x86: only use ERMS for user copies for larger sizes
To: David.Laight@aculab.com
Cc: Andrew Lutomirski <luto@kernel.org>, dvlasenk@redhat.com,
        Jens Axboe <axboe@kernel.dk>, Ingo Molnar <mingo@kernel.org>,
        Thomas Gleixner <tglx@linutronix.de>,
        Ingo Molnar <mingo@redhat.com>, bp@alien8.de,
        Peter Anvin <hpa@zytor.com>,
        "the arch/x86 maintainers" <x86@kernel.org>,
        Andrew Morton <akpm@linux-foundation.org>,
        Peter Zijlstra <a.p.zijlstra@chello.nl>, brgerst@gmail.com,
        Linux List Kernel Mailing <linux-kernel@vger.kernel.org>,
        pabeni@redhat.com
Content-Type: multipart/mixed; boundary="0000000000007a8721057b5883b2"
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

--0000000000007a8721057b5883b2
Content-Type: text/plain; charset="UTF-8"

On Fri, Nov 23, 2018 at 8:36 AM Linus Torvalds
<torvalds@linux-foundation.org> wrote:
>
> Let me write a generic routine in lib/iomap_copy.c (which already does
> the "user specifies chunk size" cases), and hook it up for x86.

Something like this?

ENTIRELY UNTESTED! It might not compile. Seriously. And if it does
compile, it might not work.

And this doesn't actually do the memset_io() function at all, just the
memcpy ones.

Finally, it's worth noting that on x86, we have this:

  /*
   * override generic version in lib/iomap_copy.c
   */
  ENTRY(__iowrite32_copy)
          movl %edx,%ecx
          rep movsd
          ret
  ENDPROC(__iowrite32_copy)

because back in 2006, we did this:

    [PATCH] Add faster __iowrite32_copy routine for x86_64

    This assembly version is measurably faster than the generic version in
    lib/iomap_copy.c.

which actually implies that "rep movsd" is faster than doing
__raw_writel() by hand.

So it is possible that this should all be arch-specific code rather
than that butt-ugly "generic" code I wrote in this patch.

End result: I'm not really all that  happy about this patch, but it's
perhaps worth testing, and it's definitely worth discussing. Because
our current memcpy_{to,from}io() is truly broken garbage.

                   Linus

--0000000000007a8721057b5883b2
Content-Type: text/x-patch; charset="US-ASCII"; name="patch.diff"
Content-Disposition: attachment; filename="patch.diff"
Content-Transfer-Encoding: base64
Content-ID: <f_joubcpp90>
X-Attachment-Id: f_joubcpp90

IGFyY2gveDg2L2luY2x1ZGUvYXNtL2lvLmggfCAgIDYgKysKIGluY2x1ZGUvbGludXgvaW8uaCAg
ICAgICAgfCAgIDIgKwogbGliL2lvbWFwX2NvcHkuYyAgICAgICAgICB8IDE1MyArKysrKysrKysr
KysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrKysrCiAzIGZpbGVzIGNoYW5nZWQsIDE2
MSBpbnNlcnRpb25zKCspCgpkaWZmIC0tZ2l0IGEvYXJjaC94ODYvaW5jbHVkZS9hc20vaW8uaCBi
L2FyY2gveDg2L2luY2x1ZGUvYXNtL2lvLmgKaW5kZXggODMyZGE4MjI5Y2M3Li4zYjkyMDZlZTI1
YjggMTAwNjQ0Ci0tLSBhL2FyY2gveDg2L2luY2x1ZGUvYXNtL2lvLmgKKysrIGIvYXJjaC94ODYv
aW5jbHVkZS9hc20vaW8uaApAQCAtOTIsNiArOTIsMTIgQEAgYnVpbGRfbW1pb193cml0ZShfX3dy
aXRlbCwgImwiLCB1bnNpZ25lZCBpbnQsICJyIiwgKQogCiAjZGVmaW5lIG1taW93YigpIGJhcnJp
ZXIoKQogCit2b2lkIF9faW93cml0ZV9jb3B5KHZvaWQgX19pb21lbSAqdG8sIGNvbnN0IHZvaWQg
KmZyb20sIHNpemVfdCBjb3VudCk7Cit2b2lkIF9faW9yZWFkX2NvcHkodm9pZCAqdG8sIGNvbnN0
IHZvaWQgX19pb21lbSAqZnJvbSwgc2l6ZV90IGNvdW50KTsKKworI2RlZmluZSBtZW1jcHlfdG9p
byBfX2lvd3JpdGVfY29weQorI2RlZmluZSBtZW1jcHlfZnJvbWlvIF9faW9yZWFkX2NvcHkKKwog
I2lmZGVmIENPTkZJR19YODZfNjQKIAogYnVpbGRfbW1pb19yZWFkKHJlYWRxLCAicSIsIHU2NCwg
Ij1yIiwgOiJtZW1vcnkiKQpkaWZmIC0tZ2l0IGEvaW5jbHVkZS9saW51eC9pby5oIGIvaW5jbHVk
ZS9saW51eC9pby5oCmluZGV4IDMyZTMwZThmYjlkYi4uNjQyZjc4OTcwMDE4IDEwMDY0NAotLS0g
YS9pbmNsdWRlL2xpbnV4L2lvLmgKKysrIGIvaW5jbHVkZS9saW51eC9pby5oCkBAIC0yOCw2ICsy
OCw4IEBACiBzdHJ1Y3QgZGV2aWNlOwogc3RydWN0IHJlc291cmNlOwogCit2b2lkIF9faW9yZWFk
X2NvcHkodm9pZCAqdG8sIGNvbnN0IHZvaWQgX19pb21lbSAqZnJvbSwgc2l6ZV90IGNvdW50KTsK
K3ZvaWQgX19pb3dyaXRlX2NvcHkodm9pZCBfX2lvbWVtICp0bywgY29uc3Qgdm9pZCAqZnJvbSwg
c2l6ZV90IGNvdW50KTsKIF9fdmlzaWJsZSB2b2lkIF9faW93cml0ZTMyX2NvcHkodm9pZCBfX2lv
bWVtICp0bywgY29uc3Qgdm9pZCAqZnJvbSwgc2l6ZV90IGNvdW50KTsKIHZvaWQgX19pb3JlYWQz
Ml9jb3B5KHZvaWQgKnRvLCBjb25zdCB2b2lkIF9faW9tZW0gKmZyb20sIHNpemVfdCBjb3VudCk7
CiB2b2lkIF9faW93cml0ZTY0X2NvcHkodm9pZCBfX2lvbWVtICp0bywgY29uc3Qgdm9pZCAqZnJv
bSwgc2l6ZV90IGNvdW50KTsKZGlmZiAtLWdpdCBhL2xpYi9pb21hcF9jb3B5LmMgYi9saWIvaW9t
YXBfY29weS5jCmluZGV4IGI4ZjFkNmNiYjIwMC4uOGVkYzM1OWRkYTYyIDEwMDY0NAotLS0gYS9s
aWIvaW9tYXBfY29weS5jCisrKyBiL2xpYi9pb21hcF9jb3B5LmMKQEAgLTE3LDYgKzE3LDE1OSBA
QAogCiAjaW5jbHVkZSA8bGludXgvZXhwb3J0Lmg+CiAjaW5jbHVkZSA8bGludXgvaW8uaD4KKyNp
bmNsdWRlIDxhc20vdW5hbGlnbmVkLmg+CisKK3N0YXRpYyBpbmxpbmUgYm9vbCBpb21lbV9hbGln
bihjb25zdCB2b2lkIF9faW9tZW0gKnB0ciwgaW50IHNpemUsIGludCBjb3VudCkKK3sKKwlyZXR1
cm4gY291bnQgPj0gc2l6ZSAmJiAoX19mb3JjZSB1bnNpZ25lZCBsb25nKXB0ciAmIHNpemU7Cit9
CisKKworLyoqCisgKiBfX2lvd3JpdGVfY29weSAtIGNvcHkgZGF0YSB0byBNTUlPIHNwYWNlCisg
KiBAdG86IGRlc3RpbmF0aW9uLCBpbiBNTUlPIHNwYWNlCisgKiBAZnJvbTogc291cmNlCisgKiBA
Y291bnQ6IG51bWJlciBvZiBieXRlcyB0byBjb3B5LgorICoKKyAqIENvcHkgYXJiaXRyYXJpbHkg
YWxpZ25lZCBkYXRhIGZyb20ga2VybmVsIHNwYWNlIHRvIE1NSU8gc3BhY2UsCisgKiB1c2luZyBy
ZWFzb25hYmxlIGNodW5raW5nLgorICovCit2b2lkIF9fYXR0cmlidXRlX18oKHdlYWspKSBfX2lv
d3JpdGVfY29weSh2b2lkIF9faW9tZW0gKnRvLAorCQkJCQkgIGNvbnN0IHZvaWQgKmZyb20sCisJ
CQkJCSAgc2l6ZV90IGNvdW50KQoreworCWlmIChpb21lbV9hbGlnbih0bywgMSwgY291bnQpKSB7
CisJCXVuc2lnbmVkIGNoYXIgZGF0YSA9ICoodW5zaWduZWQgY2hhciAqKWZyb207CisJCV9fcmF3
X3dyaXRlYihkYXRhLCB0byk7CisJCWZyb20rKzsKKwkJdG8rKzsKKwkJY291bnQtLTsKKwl9CisJ
aWYgKGlvbWVtX2FsaWduKHRvLCAyLCBjb3VudCkpIHsKKwkJdW5zaWduZWQgc2hvcnQgZGF0YSA9
IGdldF91bmFsaWduZWQoKHVuc2lnbmVkIHNob3J0ICopZnJvbSk7CisJCV9fcmF3X3dyaXRldyhk
YXRhLCB0byk7CisJCWZyb20gKz0gMjsKKwkJdG8gKz0gMjsKKwkJY291bnQgLT0gMjsKKwl9Cisj
aWZkZWYgQ09ORklHXzY0QklUCisJaWYgKGlvbWVtX2FsaWduKHRvLCA0LCBjb3VudCkpIHsKKwkJ
dW5zaWduZWQgaW50IGRhdGEgPSBnZXRfdW5hbGlnbmVkKCh1bnNpZ25lZCBpbnQgKilmcm9tKTsK
KwkJX19yYXdfd3JpdGVsKGRhdGEsIHRvKTsKKwkJZnJvbSArPSA0OworCQl0byArPSA0OworCQlj
b3VudCAtPSA0OworCX0KKyNlbmRpZgorCXdoaWxlIChjb3VudCA+PSBzaXplb2YodW5zaWduZWQg
bG9uZykpIHsKKwkJdW5zaWduZWQgbG9uZyBkYXRhID0gZ2V0X3VuYWxpZ25lZCgodW5zaWduZWQg
bG9uZyAqKWZyb20pOworI2lmZGVmIENPTkZJR182NEJJVAorCQlfX3Jhd193cml0ZXEoZGF0YSwg
dG8pOworI2Vsc2UKKwkJX19yYXdfd3JpdGVsKGRhdGEsIHRvKTsKKyNlbmRpZgorCQlmcm9tICs9
IHNpemVvZih1bnNpZ25lZCBsb25nKTsKKwkJdG8gKz0gc2l6ZW9mKHVuc2lnbmVkIGxvbmcpOwor
CQljb3VudCAtPSBzaXplb2YodW5zaWduZWQgbG9uZyk7CisJfQorCisjaWZkZWYgQ09ORklHXzY0
QklUCisJaWYgKGNvdW50ID49IDQpIHsKKwkJdW5zaWduZWQgaW50IGRhdGEgPSBnZXRfdW5hbGln
bmVkKCh1bnNpZ25lZCBpbnQgKilmcm9tKTsKKwkJX19yYXdfd3JpdGVsKGRhdGEsIHRvKTsKKwkJ
ZnJvbSArPSA0OworCQl0byArPSA0OworCQljb3VudCAtPSA0OworCX0KKyNlbmRpZgorCisJaWYg
KGNvdW50ID49IDIpIHsKKwkJdW5zaWduZWQgc2hvcnQgZGF0YSA9IGdldF91bmFsaWduZWQoKHVu
c2lnbmVkIHNob3J0ICopZnJvbSk7CisJCV9fcmF3X3dyaXRldyhkYXRhLCB0byk7CisJCWZyb20g
Kz0gMjsKKwkJdG8gKz0gMjsKKwkJY291bnQgLT0gMjsKKwl9CisKKwlpZiAoY291bnQpIHsKKwkJ
dW5zaWduZWQgY2hhciBkYXRhID0gKih1bnNpZ25lZCBjaGFyICopZnJvbTsKKwkJX19yYXdfd3Jp
dGViKGRhdGEsIHRvKTsKKwl9Cit9CitFWFBPUlRfU1lNQk9MX0dQTChfX2lvd3JpdGVfY29weSk7
CisKKy8qKgorICogX19pb3JlYWRfY29weSAtIGNvcHkgZGF0YSBmcm9tIE1NSU8gc3BhY2UKKyAq
IEB0bzogZGVzdGluYXRpb24KKyAqIEBmcm9tOiBzb3VyY2UsIGluIE1NSU8gc3BhY2UKKyAqIEBj
b3VudDogbnVtYmVyIG9mIGJ5dGVzIHRvIGNvcHkuCisgKgorICogQ29weSBhcmJpdHJhcmlseSBh
bGlnbmVkIGRhdGEgZnJvbSBNTUlPIHNwYWNlIHRvIGtlcm5lbCBzcGFjZSwKKyAqIHVzaW5nIHJl
YXNvbmFibGUgY2h1bmtpbmcuCisgKi8KK3ZvaWQgX19hdHRyaWJ1dGVfXygod2VhaykpIF9faW9y
ZWFkX2NvcHkodm9pZCAqdG8sCisJCQkJCSBjb25zdCB2b2lkIF9faW9tZW0gKmZyb20sCisJCQkJ
CSBzaXplX3QgY291bnQpCit7CisJaWYgKGlvbWVtX2FsaWduKGZyb20sIDEsIGNvdW50KSkgewor
CQl1bnNpZ25lZCBjaGFyIGRhdGEgPSBfX3Jhd19yZWFkYihmcm9tKTsKKwkJcHV0X3VuYWxpZ25l
ZChkYXRhLCAodW5zaWduZWQgY2hhciAqKSB0byk7CisJCWZyb20rKzsKKwkJdG8rKzsKKwkJY291
bnQtLTsKKwl9CisJaWYgKGlvbWVtX2FsaWduKHRvLCAyLCBjb3VudCkpIHsKKwkJdW5zaWduZWQg
c2hvcnQgZGF0YSA9IF9fcmF3X3JlYWR3KGZyb20pOworCQlwdXRfdW5hbGlnbmVkKGRhdGEsICh1
bnNpZ25lZCBzaG9ydCAqKSB0byk7CisJCWZyb20gKz0gMjsKKwkJdG8gKz0gMjsKKwkJY291bnQg
LT0gMjsKKwl9CisjaWZkZWYgQ09ORklHXzY0QklUCisJaWYgKGlvbWVtX2FsaWduKHRvLCA0LCBj
b3VudCkpIHsKKwkJdW5zaWduZWQgaW50IGRhdGEgPSBfX3Jhd19yZWFkbChmcm9tKTsKKwkJcHV0
X3VuYWxpZ25lZChkYXRhLCAodW5zaWduZWQgaW50ICopIHRvKTsKKwkJZnJvbSArPSA0OworCQl0
byArPSA0OworCQljb3VudCAtPSA0OworCX0KKyNlbmRpZgorCXdoaWxlIChjb3VudCA+PSBzaXpl
b2YodW5zaWduZWQgbG9uZykpIHsKKyNpZmRlZiBDT05GSUdfNjRCSVQKKwkJdW5zaWduZWQgbG9u
ZyBkYXRhID0gX19yYXdfcmVhZHEoZnJvbSk7CisjZWxzZQorCQl1bnNpZ25lZCBsb25nIGRhdGEg
PSBfX3Jhd19yZWFkbChmcm9tKTsKKyNlbmRpZgorCQlwdXRfdW5hbGlnbmVkKGRhdGEsICh1bnNp
Z25lZCBsb25nICopIHRvKTsKKwkJZnJvbSArPSBzaXplb2YodW5zaWduZWQgbG9uZyk7CisJCXRv
ICs9IHNpemVvZih1bnNpZ25lZCBsb25nKTsKKwkJY291bnQgLT0gc2l6ZW9mKHVuc2lnbmVkIGxv
bmcpOworCX0KKworI2lmZGVmIENPTkZJR182NEJJVAorCWlmIChjb3VudCA+PSA0KSB7CisJCXVu
c2lnbmVkIGludCBkYXRhID0gX19yYXdfcmVhZGwoZnJvbSk7CisJCXB1dF91bmFsaWduZWQoZGF0
YSwgKHVuc2lnbmVkIGludCAqKSB0byk7CisJCWZyb20gKz0gNDsKKwkJdG8gKz0gNDsKKwkJY291
bnQgLT0gNDsKKwl9CisjZW5kaWYKKworCWlmIChjb3VudCA+PSAyKSB7CisJCXVuc2lnbmVkIHNo
b3J0IGRhdGEgPSBfX3Jhd19yZWFkdyhmcm9tKTsKKwkJcHV0X3VuYWxpZ25lZChkYXRhLCAodW5z
aWduZWQgc2hvcnQgKikgdG8pOworCQlmcm9tICs9IDI7CisJCXRvICs9IDI7CisJCWNvdW50IC09
IDI7CisJfQorCisJaWYgKGNvdW50KSB7CisJCXVuc2lnbmVkIGNoYXIgZGF0YSA9IF9fcmF3X3Jl
YWRiKGZyb20pOworCQlwdXRfdW5hbGlnbmVkKGRhdGEsICh1bnNpZ25lZCBjaGFyICopIHRvKTsK
Kwl9Cit9CitFWFBPUlRfU1lNQk9MX0dQTChfX2lvcmVhZF9jb3B5KTsKIAogLyoqCiAgKiBfX2lv
d3JpdGUzMl9jb3B5IC0gY29weSBkYXRhIHRvIE1NSU8gc3BhY2UsIGluIDMyLWJpdCB1bml0cwo=
--0000000000007a8721057b5883b2--
