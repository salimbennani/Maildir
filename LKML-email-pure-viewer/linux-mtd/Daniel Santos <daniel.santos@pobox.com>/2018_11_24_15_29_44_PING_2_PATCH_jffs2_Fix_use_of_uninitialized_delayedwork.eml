Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 25 Nov 2018 14:42:20 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga008.jf.intel.com (orsmga008.jf.intel.com [10.7.209.65])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 077315803C2;
	Sat, 24 Nov 2018 07:39:58 -0800 (PST)
Received: from orsmga101.jf.intel.com ([10.7.208.22])
  by orsmga008-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 24 Nov 2018 07:39:57 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AONXFCxZWH2Ha3GTminaYK+r/LSx+4OfEezUN459i?=
 =?us-ascii?q?sYplN5qZpcizbB7h7PlgxGXEQZ/co6odzbaO4+a4ASQp2tWoiDg6aptCVhsI24?=
 =?us-ascii?q?09vjcLJ4q7M3D9N+PgdCcgHc5PBxdP9nC/NlVJSo6lPwWB6nK94iQPFRrhKAF7?=
 =?us-ascii?q?Ovr6GpLIj8Swyuu+54Dfbx9HiTahYr5+Ngm6oRnMvcQKnIVuLbo8xAHUqXVSYe?=
 =?us-ascii?q?RWwm1oJVOXnxni48q74YBu/SdNtf8/7sBMSar1cbg2QrxeFzQmLns65Nb3uhnZ?=
 =?us-ascii?q?TAuA/WUTX2MLmRdVGQfF7RX6XpDssivms+d2xSeXMdHqQb0yRD+v9LlgRgP2hy?=
 =?us-ascii?q?gbNj456GDXhdJ2jKJHuxKquhhzz5fJbI2JKPZye6XQds4YS2VcRMZcTzFPDIOi?=
 =?us-ascii?q?YYsBDOQPM+hXoIb/qFQSohW+HhGsCeH0xz9UhHL7x7E23/gvHAzE2gErAtIAsG?=
 =?us-ascii?q?7TrNXwLKocX/q6zK/JzTrda/NdxCrz55LOchA9pvGMRq97fM3MxkY1EQPFj0uf?=
 =?us-ascii?q?qYj/MzOOzOsNtXSb7+17Ve+0k24nrBp+oj+gx8s2lobJgYcVx0nC+C5kw4g1Pc?=
 =?us-ascii?q?W1RFBnbdOgCpdcqi+XO5VsTs8/QGxkpDw2x7wEtJKjYSQG1JcqywTbZvCaaYSF?=
 =?us-ascii?q?5h3uWPyeLDp7gn9uZaixiAyo8Ue6z+3xTsm030hOripCitTMqH8N2ALJ6sSdSf?=
 =?us-ascii?q?ty4F2h2TCR2ADX8O1EJlo0laXDJ54gxL4/iIYTvFzdEiPqnEj6lrKae0s69uSy?=
 =?us-ascii?q?9ujqYanqqoWdOoJ2kg3+N74hms27AeQ2KAgOWG2b9Py41L3i+035XbpLguQ1kq?=
 =?us-ascii?q?bHqpDaI9oUpqqgDw9S3Icj7QiwDy293dQGknkIMkhFdAiEj4f3IVHOJu73DfOl?=
 =?us-ascii?q?j1SrijdryOjKPqf9DZXVMnjDjLDhcK55605dywo808pT5p1JCrwaJPLzW0nxtM?=
 =?us-ascii?q?HXDxMjMgy0xfrnB8t51o8ERW2PBaqZOrvIsVCU/uIvP/WMZIgNtTb9Mfcl5uLu?=
 =?us-ascii?q?gmU+mVMHfampwIEYaHa3Hvl9J0WZYHzsgsoOEGsQvwo+SvDqh0OGUTJJe3myWK?=
 =?us-ascii?q?c87CkhCI26FYfDWpytgLuZ0Se5GZ1ZeHpKClOLEXfucYWEXOwBaCaTIs9njzwF?=
 =?us-ascii?q?WqKtS44n1RGyqgD6z6BrIfbT+i0drZjjzsR65/XPlREu8jx5F96S03qNT2FznW?=
 =?us-ascii?q?MEXSU207p9oUFmzleD0K54g+FXFNBJ5vNJVBs6OoDYz+BgF9/yXQfBdM+TSFm6?=
 =?us-ascii?q?WtWmHS0xTtUpzt8NeUl9Hc+ujhTC3yWwBb8VmKeGBJg18qLawnjwKNxxy3fA1K?=
 =?us-ascii?q?k9kVYmRtFDOnGhhq567wLTHZLGk12Fl6a2cqQRxDPC+32dzWWQpk1YUBR/UaPe?=
 =?us-ascii?q?XX8BYEvaqtD55kDHT7+qErknNgpBycifKqpFcNHpjFNGROv9N9TaeW6+h2CwBR?=
 =?us-ascii?q?OQzLOWcIXqY3kd3DnaCEUcjg8c52iGOhYkCiehuW3eCiduGkzpY0739el+qXW7?=
 =?us-ascii?q?TlI7zg2Qbk1h0aa19QARhfCGV/wT2bcEsj87qzpoBFa9w87WC92Yqgp9faVcZN?=
 =?us-ascii?q?Q94EtH1WPZrQB9IoasL6d4hl4acgR3uUzu2g5zCoVBl8gqsXwrwBBzKaKezFNO?=
 =?us-ascii?q?aTeY0YrsNb3QL2n45AqvZLLO2lHCzNaW/b8C5+48q1r9swCmCEoj/2983NlIzn?=
 =?us-ascii?q?ST/JPKDAkVUZLvSUs38xl6p7fHYigy/Y/U1HtsMbWqvT/Gwd4mGOwlyhO4dddF?=
 =?us-ascii?q?LKyEDBPyE9EdB8W2KO0qhkKlYQ4eMOFT9K47JcWmd/Sd1a6vPeZgmi+mjGtd7I?=
 =?us-ascii?q?B81EKM6zRzSurS05kZxPGY2xONVy3gg1e5rsD3hYdEaCkIHmq+1SfrHpRRabB1?=
 =?us-ascii?q?fYoRD2ehPde3xtRni5HxQXFY8EOsCE0c2M+ufxqfdFj93QxW1UQKrn2rgyq4zz?=
 =?us-ascii?q?pokz43qqqTxjDBw+PndBAfIG5EWHFijUvwIYizl90bXEmoYxIplRe//kb62q5b?=
 =?us-ascii?q?qb97L2nSR0dIYif3I3tjUqu2qrqNfcpP5Ik0viVQVeS2eUqaRaLloxsGzyPjGH?=
 =?us-ascii?q?NTxDIheDGwuZX5nBt6hHiGLHlpr3rZesBwxRHB69zaXvNR2jsGRC9liTjYHFS8?=
 =?us-ascii?q?Pt+p/cmKmJfHqOyxS2WhVphLeynx0YyArDe75XFtARCnn/G8gNrnHRI40S/60d?=
 =?us-ascii?q?lnTiHIrBf6Yon22KW2K+Nnfk90BFDi78p2AJ1xkow1hJsIw3gVmo2V/WYbkWf0?=
 =?us-ascii?q?Kdhb2rjxbHsXST4L3t7a+g7l2EJ4I3KNxoL5UGidw8R7a9m7ZGMWxjwy78RQBK?=
 =?us-ascii?q?iI67xEmDN/okCkogLJffh9gjAdxOMr6H4bgOEGohAhzyuDDbAJAUlXIzbsmA+W?=
 =?us-ascii?q?4NCko6Vaf2Kvcbm21EpjktGtFrCCogdAWHnnfpcuBzN/7sJ6MFjUyn389pnkeM?=
 =?us-ascii?q?XMbdIUrhCUjxDAj+1PJJMwjPUKgzdnOXnmvX0k0OM7iR1u3ZenvImIMWlt/aS5?=
 =?us-ascii?q?AgJGOT3xfc8c5jbtjaNGlMaMw4+vBolhGikMXJbwVv2nCjUStfD6NwqUFD08t2?=
 =?us-ascii?q?yWGb7eHQ+Z9UdnoGjDE5GtN3GLOnYZyc9uSwWaJExamAoURik1noYlFgC2w8zs?=
 =?us-ascii?q?aEV56SoU5lHmsRtA0P5oOwP8UmfCpweodzE0R4KELBdN6gFC5kHVMdGR7+5pHi?=
 =?us-ascii?q?FY+IGhoxKJKmCBewtICmQJUFSeB1//Jrmu+cXA8++AC+u+KPvOfKyOqfFEWPeO?=
 =?us-ascii?q?356vyYxm/zCDNsiUOnliDvs72ldMXHxjGsTZnSkPRDITly7Xc8GboxK88DVtrs?=
 =?us-ascii?q?+j6PTrRB7v5YyXBrtSL9pv+hO2gaSCN+KKhyZ5MzFY1pwSyn/S1bgfx0UfiyVv?=
 =?us-ascii?q?dzmrDLQBujTBTKPWmq9LEREbbzl/O9dP76I5xgNNI9LUisvp1r5kif44E01KVU?=
 =?us-ascii?q?H6lcGze8MLI3uxNFfGBEuQMLSGJDvLw9z4YK+mSL1QivlUuAO0uTqBD0DjOTGD?=
 =?us-ascii?q?nSHzVx+zKeFMkD2bPBtGtYGhcxZtDHLvQ878ZhKnMN94kzs2zKYwhnPLM24cLD?=
 =?us-ascii?q?d9f1lMrr2W8SNXnPF/F3Zd4XpiKOmOgzyZ4PXAKpYKrftrBTx5luJA73Q8zrtV?=
 =?us-ascii?q?7SdES+R0mSvStNFupV6mn/KLyjpmVhpOtzlKiJiKvUVkJaXW6J1AVWzY8xIK6G?=
 =?us-ascii?q?XDQygN8vtiF5XTsqcYntjIib76L25q88/d4sYdQcPTLZTDeF4CFD6hTDrVChYV?=
 =?us-ascii?q?CD2mL2fSg2RDn/yIsH6YtJ43rt7rgpVYGZFBU1lgOvocC0lhVOcLJotwRXtwnb?=
 =?us-ascii?q?edjcMMo2G3qgXWX+1CuZrARrSZBvC5e2XRtqVNexZdmeCwFo8ULICunhU6MlQ?=
 =?us-ascii?q?=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0ANAACjb/lbh0O0hNFjHAEBAQQBAQcEA?=
 =?us-ascii?q?QGBUQcBAQsBg2sng3mIGI1hLRSXKIFxFhgTAYhaIjQJDQEDAQEBAQEBAgETAQE?=
 =?us-ascii?q?BCA0JCCkjDII2JAGCYgECAwECIAQZAwE1AQEECQEBIgICJgICA1QGAQwGAgEBA?=
 =?us-ascii?q?YMcggIFpWhwfDOCdgcChxQBCIELiWKBHIFXP4ERJ4cygzuCV49eNIUmikwHAoI?=
 =?us-ascii?q?cBI8JBhiJYYcnLJgEgUaCDTMaI4M8gicXg0qKcSEBMYEFAQGJPwICIgeCIAEB?=
X-IPAS-Result: =?us-ascii?q?A0ANAACjb/lbh0O0hNFjHAEBAQQBAQcEAQGBUQcBAQsBg2s?=
 =?us-ascii?q?ng3mIGI1hLRSXKIFxFhgTAYhaIjQJDQEDAQEBAQEBAgETAQEBCA0JCCkjDII2J?=
 =?us-ascii?q?AGCYgECAwECIAQZAwE1AQEECQEBIgICJgICA1QGAQwGAgEBAYMcggIFpWhwfDO?=
 =?us-ascii?q?CdgcChxQBCIELiWKBHIFXP4ERJ4cygzuCV49eNIUmikwHAoIcBI8JBhiJYYcnL?=
 =?us-ascii?q?JgEgUaCDTMaI4M8gicXg0qKcSEBMYEFAQGJPwICIgeCIAEB?=
X-IronPort-AV: E=Sophos;i="5.56,273,1539673200"; 
   d="scan'208";a="42072257"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 24 Nov 2018 07:39:56 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1726792AbeKYCZd (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Sat, 24 Nov 2018 21:25:33 -0500
Received: from pb-smtp21.pobox.com ([173.228.157.53]:59385 "EHLO
        pb-smtp21.pobox.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1726012AbeKYCZd (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sat, 24 Nov 2018 21:25:33 -0500
X-Greylist: delayed 330 seconds by postgrey-1.27 at vger.kernel.org; Sat, 24 Nov 2018 21:25:31 EST
Received: from pb-smtp21.pobox.com (unknown [127.0.0.1])
        by pb-smtp21.pobox.com (Postfix) with ESMTP id EFBC6271F1;
        Sat, 24 Nov 2018 10:31:21 -0500 (EST)
        (envelope-from daniel.santos@pobox.com)
DKIM-Signature: v=1; a=rsa-sha1; c=relaxed; d=pobox.com; h=subject:from
        :to:cc:references:message-id:date:mime-version:in-reply-to
        :content-type:content-transfer-encoding; s=sasl; bh=KwQBcNwstZcn
        3XKfpSzocoOPMYo=; b=WfQ4vowsVLlOH+qhMYf73urwCxvNX8CGMukXcoaNmTAT
        OKJncxnhYcklWvMHhkWixmsk6gkw1Kq491s4lPGVkEtzoJORHfiVTxa4s3jF7d1T
        hSM+vZyNbX+Fjl1BcCy5SaxgU3kZ1wfgiKPh/miWMA5VOMUrQRkE8Prr8fzgouQ=
DomainKey-Signature: a=rsa-sha1; c=nofws; d=pobox.com; h=subject:from:to
        :cc:references:message-id:date:mime-version:in-reply-to
        :content-type:content-transfer-encoding; q=dns; s=sasl; b=q5PLor
        T4FDZ+VPe6OlBDALnEziP3MdKbIi9pgtTM2sgwmcsq8Zk/SNaP8pC/IKQlu1e1JF
        C4lKa5q7/NL2bLeT/wp7mATfJa/PDLSLD1b3tJ5ax6b5fCCDRvpW+aprfDTc9WaS
        pOAgrhJcWcAx2GbZyt+7nI7cjnNb8UvbEWDPQ=
Received: from pb-smtp21.sea.icgroup.com (unknown [127.0.0.1])
        by pb-smtp21.pobox.com (Postfix) with ESMTP id E7FD4271EF;
        Sat, 24 Nov 2018 10:31:21 -0500 (EST)
        (envelope-from daniel.santos@pobox.com)
Received: from [10.69.183.138] (unknown [108.91.94.48])
        (using TLSv1.2 with cipher ECDHE-RSA-AES128-GCM-SHA256 (128/128 bits))
        (No client certificate requested)
        by pb-smtp21.pobox.com (Postfix) with ESMTPSA id CE693271EC;
        Sat, 24 Nov 2018 10:31:18 -0500 (EST)
        (envelope-from daniel.santos@pobox.com)
Subject: [PING 2] [PATCH] jffs2: Fix use of uninitialized delayed_work,
 lockdep breakage
From: Daniel Santos <daniel.santos@pobox.com>
To: Hou Tao <houtao1@huawei.com>, LKML <linux-kernel@vger.kernel.org>
Cc: David Woodhouse <dwmw2@infradead.org>,
        linux-mtd@lists.infradead.org
References: <20181019083020.14335-1-daniel.santos@pobox.com>
 <d2f16a3a-7237-6c4e-5ff8-43f05bdb7e0f@huawei.com>
 <11f65a20-dfca-0ddc-8c7f-58f29afe8c04@pobox.com>
Message-ID: <436a7243-4a32-40cd-5c40-6cc7f44d26c5@pobox.com>
Date: Sat, 24 Nov 2018 09:29:44 -0600
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101
 Thunderbird/52.9.1
MIME-Version: 1.0
In-Reply-To: <11f65a20-dfca-0ddc-8c7f-58f29afe8c04@pobox.com>
Content-Type: text/plain; charset=utf-8
Content-Transfer-Encoding: 7bit
Content-Language: en-US
X-Pobox-Relay-ID: FD692D7A-EFFD-11E8-8BA3-CC883AD79A78-06139138!pb-smtp21.pobox.com
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Ping 2!

On 11/05/2018 03:38 PM, Daniel Santos wrote:
> Ping.
>
> Daniel
>
> On 10/21/2018 07:32 PM, Hou Tao wrote:
>> On 2018/10/19 16:30, Daniel Santos wrote:
>>> jffs2_sync_fs makes the assumption that if CONFIG_JFFS2_FS_WRITEBUFFER
>>> is defined then a write buffer is available and has been initialized.
>>> However, this does is not the case when the mtd device has no
>>> out-of-band buffer:
>>>
>>> int jffs2_nand_flash_setup(struct jffs2_sb_info *c)
>>> {
>>>         if (!c->mtd->oobsize)
>>>                 return 0;
>>> ...
>>>
>>> The resulting call to cancel_delayed_work_sync passing a uninitialized
>>> (but zeroed) delayed_work struct forces lockdep to become disabled.
>>>
>>> [   90.050639] overlayfs: upper fs does not support tmpfile.
>>> [   90.652264] INFO: trying to register non-static key.
>>> [   90.662171] the code is fine but needs lockdep annotation.
>>> [   90.673090] turning off the locking correctness validator.
>>> [   90.684021] CPU: 0 PID: 1762 Comm: mount_root Not tainted 4.14.63 #0
>>> [   90.696672] Stack : 00000000 00000000 80d8f6a2 00000038 805f0000 80444600 8fe364f4 805dfbe7
>>> [   90.713349]         80563a30 000006e2 8068370c 00000001 00000000 00000001 8e2fdc48 ffffffff
>>> [   90.730020]         00000000 00000000 80d90000 00000000 00000106 00000000 6465746e 312e3420
>>> [   90.746690]         6b636f6c 03bf0000 f8000000 20676e69 00000000 80000000 00000000 8e2c2a90
>>> [   90.763362]         80d90000 00000001 00000000 8e2c2a90 00000003 80260dc0 08052098 80680000
>>> [   90.780033]         ...
>>> [   90.784902] Call Trace:
>>> [   90.789793] [<8000f0d8>] show_stack+0xb8/0x148
>>> [   90.798659] [<8005a000>] register_lock_class+0x270/0x55c
>>> [   90.809247] [<8005cb64>] __lock_acquire+0x13c/0xf7c
>>> [   90.818964] [<8005e314>] lock_acquire+0x194/0x1dc
>>> [   90.828345] [<8003f27c>] flush_work+0x200/0x24c
>>> [   90.837374] [<80041dfc>] __cancel_work_timer+0x158/0x210
>>> [   90.847958] [<801a8770>] jffs2_sync_fs+0x20/0x54
>>> [   90.857173] [<80125cf4>] iterate_supers+0xf4/0x120
>>> [   90.866729] [<80158fc4>] sys_sync+0x44/0x9c
>>> [   90.875067] [<80014424>] syscall_common+0x34/0x58
>>>
>>> Signed-off-by: Daniel Santos <daniel.santos@pobox.com>
>>> ---
>>>  fs/jffs2/super.c | 3 ++-
>>>  1 file changed, 2 insertions(+), 1 deletion(-)
>>>
>>> diff --git a/fs/jffs2/super.c b/fs/jffs2/super.c
>>> index 793ad30970ff..cae4ecda3c50 100644
>>> --- a/fs/jffs2/super.c
>>> +++ b/fs/jffs2/super.c
>>> @@ -101,7 +101,8 @@ static int jffs2_sync_fs(struct super_block *sb, int wait)
>>>  	struct jffs2_sb_info *c = JFFS2_SB_INFO(sb);
>>>  
>>>  #ifdef CONFIG_JFFS2_FS_WRITEBUFFER
>>> -	cancel_delayed_work_sync(&c->wbuf_dwork);
>>> +	if (jffs2_is_writebuffered(c))
>>> +		cancel_delayed_work_sync(&c->wbuf_dwork);
>>>  #endif
>>>  
>>>  	mutex_lock(&c->alloc_sem);
>>>
>> Reviewed-by: Hou Tao <houtao1@huawei.com>
>>
>> And I am curious that why is there NAND Flash without OOB area ? So for them
>> the ECC data must be saved in data area ?
>>
>> Regards,
>>
>> Tao
>>
>>
>>

