Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 25 Nov 2018 14:42:45 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga001.jf.intel.com (orsmga001.jf.intel.com [10.7.209.18])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id 6E89258037D;
	Sat, 24 Nov 2018 12:48:22 -0800 (PST)
Received: from orsmga106.jf.intel.com ([10.7.208.65])
  by orsmga001-1.jf.intel.com with ESMTP; 24 Nov 2018 12:48:22 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AxIcbaBRNhBn+dHaizhHSw6pofNpsv+yvbD5Q0YIu?=
 =?us-ascii?q?jvd0So/mwa64YRePt8tkgFKBZ4jH8fUM07OQ7/iwHzRYqb+681k6OKRWUBEEjc?=
 =?us-ascii?q?hE1ycBO+WiTXPBEfjxciYhF95DXlI2t1uyMExSBdqsLwaK+i764jEdAAjwOhRo?=
 =?us-ascii?q?LerpBIHSk9631+ev8JHPfglEnjWwba9xIRmssQndqtQdjJd/JKo21hbHuGZDdf?=
 =?us-ascii?q?5MxWNvK1KTnhL86dm18ZV+7SleuO8v+tBZX6nicKs2UbJXDDI9M2Ao/8LrrgXM?=
 =?us-ascii?q?TRGO5nQHTGoblAdDDhXf4xH7WpfxtTb6tvZ41SKHM8D6Uaw4VDK/5KpwVhTmlD?=
 =?us-ascii?q?kIOCI48GHPi8x/kqRboA66pxdix4LYeZyZOOZicq/Ye94RWGhPUdtLVyFZDYy8?=
 =?us-ascii?q?YYkAAeoPM+hbsofzuUcBrQCmBQSuH+7v1iNEi2Xq0aEmz+gsEwfL1xEgEdIUt3?=
 =?us-ascii?q?TUqc34OrsTUe+pzKnH1y/DYO5L0jj99ofIcxYhruqSUrJqfsre11MvHB7Cg1WK?=
 =?us-ascii?q?qIzqIzOV2f4Xs2eG9eZhW/ygi28hqw5qvDev3MgshZfTho8OxVDE8D92wIcxJd?=
 =?us-ascii?q?GiVEF7ZtukHYJWuiqHNIV2WtsvT390tCs+0LEKpJC2cDYQxJg6xBPTd+aLfomK?=
 =?us-ascii?q?7x77SuqdPTN1iGhmdb+/nRq+7Fasx+7mWsS10VtHqDdOnMPWuXAXzRPT79CKSv?=
 =?us-ascii?q?tj8Uel3jaCzx7T6u5aLkAuj6bbKIAuwqQ2lpUNtUTPBCj2mF/5jKOOd0Uk/Pan?=
 =?us-ascii?q?6/j/b7n4upORM5V4hhzwP6gwgMCzHOc1PhQUU2Wa++mwzLjj8lf4QLVOgP02iK?=
 =?us-ascii?q?7ZsJXCKMQfp665BRJV04k65xa8ETimytIYkmcDLF5cfxKGgY7pNE/UIP3jE/e/?=
 =?us-ascii?q?jEqjkC1xy/DFILLhGJPNIWbHkLv7erZ98UFcxBIpzd9D/5JUFq0BIPXrV0/1td?=
 =?us-ascii?q?zYDQE2Pxa7wub6E9h90oIeWWSSAq6WKq/SsFmI5v4xLOmIfoMapDH9K/097f70?=
 =?us-ascii?q?kXA5gUMdfbWu3ZYPaHC3BPVmI1mDbnrrmNsBEXoKsRA4TOzlk1CCVT9TZ3CvX6?=
 =?us-ascii?q?Mz/D07CYSmDZvdSYCpmrCOwCC7HphObGBcFl+MCWvod5mDW/oUaiKSJdFuniYH?=
 =?us-ascii?q?VbimTY8h0xauuRT+y7pmKOrU5yIZuYji1Nhz++3cixUy+SZoAMSa1mGHV3t0kX?=
 =?us-ascii?q?8QRz8qwKB/plRwxU2Y0ah4hPxYFsZf5+lTXQc4LpPcy+16C9bvWgPOZNuJSVCm?=
 =?us-ascii?q?Qsm4DjE1VN4+39gOY0NlEdW4kh/DxzaqA6MSl7GTB5w76KTc02L1J8Z80XnG0q?=
 =?us-ascii?q?YhgkIiQstOM22mm6F++xLSB47Pj0WWiaKqeb4A0y7K8WeJ1XCOs11AUA5sTaXF?=
 =?us-ascii?q?WmgSaVbMotTn+EzOVb+uBq4hMgta18GCLKxGatnqjVVDQPfuI9DeY2O3m2etCh?=
 =?us-ascii?q?eE3LKMbIz2e2oD2CXRElQLkwcW/XyeLwgxGj+ho37CDDxpDV/gflnj8fdgp3+h?=
 =?us-ascii?q?Tk871QeKb1Z/2Lqz4RMVgf2cS/UO3rMLoishqjN0HEqj0NLSEdaPuw1hfKBEa9?=
 =?us-ascii?q?Mn/FhHzX7ZtxB6PpG4M6Bih1secwNrv0Pu1xR7EJlAndItrHMwyApyKKSY0Fxa?=
 =?us-ascii?q?ejOc3JDwPKDXK2bo8BCuba7Wxk/R0NKM9qgT7/Q4rk3pvBu1GUo673Vnz95V3m?=
 =?us-ascii?q?OG6ZXOEgUTXoz+U0Yt+xdhurHVfzMy54XX1X1rL6m5qTvC29MvBOs4xResZdZf?=
 =?us-ascii?q?MKWYFADsF80WHdShKOsvm1KxdBILIPhS9LIoP8Ohb/aH2LOrMPx8kz68jGVH4J?=
 =?us-ascii?q?py0kSD9ydnTu7I3pAFw+yX3wedVjf8ikuhvd7zmYxeeT4SGW+/wzD+BIFNfq1y?=
 =?us-ascii?q?YZoLCWC2Ls2tx9Vxm4TiW2RF+16kHV8G3tGmeQCTb1DkwQJfz0AXrmG5liuiyD?=
 =?us-ascii?q?x0lSokrq6e3CzI3uTjewALOm9NRGl+k1jsJZK4gMwdXEitdwIpjgeq5V7mx6hH?=
 =?us-ascii?q?o6RyN2nSQUZScyn2NW1iSbawtryZbs5L6ZMotzhXUeumbVCbTL79vwUV0yf5E2?=
 =?us-ascii?q?RCwzA7cimguo/lkBxilGKdMHFzoWLbec5q3xff59/cRflL0jodXiZ4ijrXBlm6?=
 =?us-ascii?q?P9a3+9WZjJPDsuG4V2K8WZxfayjrzYWctCSl4W1mGwGwn/e2mtf/Cwg1zTf718?=
 =?us-ascii?q?V2VSXPtBv9YpPk16OgPeJlf0loAkTx6857GoF4j4sxi4sc2XkchpWJ43UHlX3/?=
 =?us-ascii?q?Pslc2aL7dHANXyIEw8bJ4Aj5301uNnGJyJj4VnmHwsthesO1YmUZ2i8m68BKCa?=
 =?us-ascii?q?GU7KFLnCdvo1q4qx7RbuZ5njsH1fQu73saifkTuAUx1iWdHqwSHU5AMCzplhSI?=
 =?us-ascii?q?7MqxoL9ZZWmxariwyFRxncq6A76cuAFcV230epMjHS9288V+P0jA0Hz16oH4Zt?=
 =?us-ascii?q?bQacgfuQGTkxfFl+JVMo4+luIWhSp7PmLwpWEly+k+jRB03JC1po6HK3h2/KKi?=
 =?us-ascii?q?Ax5VLTn1Z8IV+jHwgqdShMeW34azHpp/HjUHRofnTfWtEDgKr/ToKx6OECEgqn?=
 =?us-ascii?q?ecAbfQBhWQ6EBir3LSCZyrM2yXKWIdzdVjQhmdOUNejBoVXDU8gp42CASqyNb9?=
 =?us-ascii?q?f0d+4zAb/kT4pQdUyuJ0Kxn/VX/SpAWyZTcxVpefNwBa7h1Y60fWLMye7f9zHy?=
 =?us-ascii?q?dC8Z26twGNLm2bZwJVDWAGQECEBlbjPqWw6tnE6eSXGu2+L/7Wa7WUteNeT+uI?=
 =?us-ascii?q?xY6o0oZ+/zeMMdiPPmB/D/Ih3EpPR2t5G8PfmzUAUCEXkyPNb8iGpBaz4CF3r8?=
 =?us-ascii?q?a/8Oj1VwLr/4eAF7xSMdB38RCsnaiDL/KQhDp+KTtA1pMD237IyLsc3F4TkS1u?=
 =?us-ascii?q?dCOtEbMPtSHTVqLQh7RXAgUfayNyMstI8q090hNMOc7dltP6yLp4guQpBFdCUF?=
 =?us-ascii?q?zrgtupatASI2GhKFPHA16GO66bJTLQ2cH4f6O9RadUjOVVrBCwvTebE0n+PjWM?=
 =?us-ascii?q?jTXpVhavMf1SgyGfJhBRpIa9chN1A2j5UN3mcgG7MMNwjTAu3b00h3bKOXQAPj?=
 =?us-ascii?q?Rmb0xNrqOf7SVDj/V7GmxB6GdlLOaelyaY6enYNogZsf9xDitokOJa5Wwwy6FJ?=
 =?us-ascii?q?4yFcWPx1hCzSo8Zuol68lOmPzztnUBxWpTdKhIKEp0NiOarC+5lEWHbE+g8N7G?=
 =?us-ascii?q?qKBxQLodtlFsPgu6RKxtfTk6LzLWQKz9WB8cIaBsXQbtmONmYmKjLxHzTTHE0O?=
 =?us-ascii?q?SjvvfUvYnU1G2NuI+2+Uqpw9rNC4kp0US6QdXkY4BPIeDkNjNNIYLZoyUzcpmq?=
 =?us-ascii?q?KBi8gTo3G5qU+Cat9du8X9V/mSCO/jYAmUjL9OagEHzKmweZ4SPY3ywUAkdVR7?=
 =?us-ascii?q?mo7HAUXdR/hCpyRgakk/p0Aboys2dXE6x0+wMlDl23QUD/Ph20du0gY=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AhAADft/lbh0O0hNFjHgEGBwaBUQkLA?=
 =?us-ascii?q?YNrJ4N5g3uSKhSJCW6NMYFzLBMBiFoiNAkNAQMBAQEBAQECARMBAQEIDQkIKSM?=
 =?us-ascii?q?MgjYkAYJiAQIDAQIgBBkBGx0BAwIJAQEFBQsNAgImAgIDHwERAQUBHAYBEgUDg?=
 =?us-ascii?q?xmBaQEDFQWbETyLDXwWBQEXgncFhC4KGScNWoE3AgYSeYp+gVc/gRGDEoRHgzu?=
 =?us-ascii?q?CVwKgAgcCghwEjw8YgVmFC4okLJd1MIElgg1wgQGCO4IbDBcSgziKUz4zgQUBA?=
 =?us-ascii?q?Yk6AgIiB4IgAQE?=
X-IPAS-Result: =?us-ascii?q?A0AhAADft/lbh0O0hNFjHgEGBwaBUQkLAYNrJ4N5g3uSKhS?=
 =?us-ascii?q?JCW6NMYFzLBMBiFoiNAkNAQMBAQEBAQECARMBAQEIDQkIKSMMgjYkAYJiAQIDA?=
 =?us-ascii?q?QIgBBkBGx0BAwIJAQEFBQsNAgImAgIDHwERAQUBHAYBEgUDgxmBaQEDFQWbETy?=
 =?us-ascii?q?LDXwWBQEXgncFhC4KGScNWoE3AgYSeYp+gVc/gRGDEoRHgzuCVwKgAgcCghwEj?=
 =?us-ascii?q?w8YgVmFC4okLJd1MIElgg1wgQGCO4IbDBcSgziKUz4zgQUBAYk6AgIiB4IgAQE?=
X-IronPort-AV: E=Sophos;i="5.56,275,1539673200"; 
   d="scan'208";a="41402433"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 24 Nov 2018 12:48:20 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1726493AbeKYHhc (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Sun, 25 Nov 2018 02:37:32 -0500
Received: from mail-wm1-f66.google.com ([209.85.128.66]:52989 "EHLO
        mail-wm1-f66.google.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S1726287AbeKYHhc (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Sun, 25 Nov 2018 02:37:32 -0500
Received: by mail-wm1-f66.google.com with SMTP id r11-v6so14573682wmb.2
        for <linux-kernel@vger.kernel.org>; Sat, 24 Nov 2018 12:48:15 -0800 (PST)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=gmail.com; s=20161025;
        h=mime-version:references:in-reply-to:from:date:message-id:subject:to
         :cc;
        bh=Nt6y6/RIIkqsdEHJA6ya3MkxHGoX7rIlscpsqVpprvM=;
        b=WIffzH79KTGwOWiCg+6WDnel8Bs62okj5NOc9SJ8LtmTWFSVlycd8ql+esCmwaUrtC
         wdAYZv6joKA0gq4TwEGqcjSYtksf2fxSaHvHyrSDxlIiAhX/JkUpTV1xD77e66t4vQRk
         EdzqdTLzS0hK+hwPVzxExNK7nuhluC2k4HQoRTe14FoUkO6AFFdLah1d0uVNBQbnKWs4
         LWybEoBQhIZJMt8z7fgY4vhp4zl9MR9x8/sD64sAlTie9+DeaLUr4AtTHsy0mUcw7q40
         U/HGgWM9HoNnLa5++Wpm5XStRmvZIZfjhhzbrL8+kE7PBSG9l75QtSTujYgU/tYE/t6e
         hv/Q==
X-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
        d=1e100.net; s=20161025;
        h=x-gm-message-state:mime-version:references:in-reply-to:from:date
         :message-id:subject:to:cc;
        bh=Nt6y6/RIIkqsdEHJA6ya3MkxHGoX7rIlscpsqVpprvM=;
        b=Uh2sGw+0FFL/BdcICmBp+vRiqFXwYzw5wqsL6TjHNOtKeF6I9xJFg6opBuwZ0ZN32V
         H/7EksV7bBxx6Dg/9NO/eCmojG6c31QqrpKJ2b2WjWjJEWj6xID3HQaGDJazB0Tin7Zz
         JiONpbfqrTMW0zfkCX6trArE1BdnEq5jqMN9aL1H4y6mrEeFpls+XcFpPOIytYy091TU
         jHsSAC3MCJvxiiWm9JOeCnXSF5AEeugFQiVfgi3gvw2KX3CsWB2PYHk1FfVKbQlH8p3u
         /K4Dih7+8FxygH/Bite6so764JzasdQKdaO4twahlj/Segt5FahoVBrJTo8vMYNOoy7r
         79FQ==
X-Gm-Message-State: AGRZ1gKEdQsT1bfGhefVwSxy5UyOej4g2vn/AQ2xzx6aa58pEtiLM660
        p4/mDl3FixHvJCPX5Bf5deuT+BzfBJRZIGytbtA=
X-Google-Smtp-Source: AJdET5d6Rwcsh9avP0eMI5XU98YVHXtm55jMbRf5WAPgDiXdZokOhpWAFy9Mi4at0oyJy5VHpVq3RmUu3RRfvU8lGOA=
X-Received: by 2002:a7b:cc86:: with SMTP id p6mr17733882wma.19.1543092495049;
 Sat, 24 Nov 2018 12:48:15 -0800 (PST)
MIME-Version: 1.0
References: <20181019083020.14335-1-daniel.santos@pobox.com>
 <d2f16a3a-7237-6c4e-5ff8-43f05bdb7e0f@huawei.com> <11f65a20-dfca-0ddc-8c7f-58f29afe8c04@pobox.com>
 <436a7243-4a32-40cd-5c40-6cc7f44d26c5@pobox.com>
In-Reply-To: <436a7243-4a32-40cd-5c40-6cc7f44d26c5@pobox.com>
From: Richard Weinberger <richard.weinberger@gmail.com>
Date: Sat, 24 Nov 2018 21:48:02 +0100
Message-ID: <CAFLxGvwwgoBOWsp-Yxnmn9aKHTrft2gsUj1byRkNwT9o3MFCOg@mail.gmail.com>
Subject: Re: [PING 2] [PATCH] jffs2: Fix use of uninitialized delayed_work,
 lockdep breakage
To: daniel.santos@pobox.com,
        Boris Brezillon <boris.brezillon@free-electrons.com>
Cc: houtao1@huawei.com, LKML <linux-kernel@vger.kernel.org>,
        "linux-mtd @ lists . infradead . org" <linux-mtd@lists.infradead.org>,
        David Woodhouse <dwmw2@infradead.org>
Content-Type: text/plain; charset="UTF-8"
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

On Sat, Nov 24, 2018 at 4:32 PM Daniel Santos <daniel.santos@pobox.com> wrote:
>
> Ping 2!
>
> On 11/05/2018 03:38 PM, Daniel Santos wrote:
> > Ping.
> >
> > Daniel
> >
> > On 10/21/2018 07:32 PM, Hou Tao wrote:
> >> On 2018/10/19 16:30, Daniel Santos wrote:
> >>> jffs2_sync_fs makes the assumption that if CONFIG_JFFS2_FS_WRITEBUFFER
> >>> is defined then a write buffer is available and has been initialized.
> >>> However, this does is not the case when the mtd device has no
> >>> out-of-band buffer:
> >>>
> >>> int jffs2_nand_flash_setup(struct jffs2_sb_info *c)
> >>> {
> >>>         if (!c->mtd->oobsize)
> >>>                 return 0;
> >>> ...
> >>>
> >>> The resulting call to cancel_delayed_work_sync passing a uninitialized
> >>> (but zeroed) delayed_work struct forces lockdep to become disabled.
> >>>
> >>> [   90.050639] overlayfs: upper fs does not support tmpfile.
> >>> [   90.652264] INFO: trying to register non-static key.
> >>> [   90.662171] the code is fine but needs lockdep annotation.
> >>> [   90.673090] turning off the locking correctness validator.
> >>> [   90.684021] CPU: 0 PID: 1762 Comm: mount_root Not tainted 4.14.63 #0
> >>> [   90.696672] Stack : 00000000 00000000 80d8f6a2 00000038 805f0000 80444600 8fe364f4 805dfbe7
> >>> [   90.713349]         80563a30 000006e2 8068370c 00000001 00000000 00000001 8e2fdc48 ffffffff
> >>> [   90.730020]         00000000 00000000 80d90000 00000000 00000106 00000000 6465746e 312e3420
> >>> [   90.746690]         6b636f6c 03bf0000 f8000000 20676e69 00000000 80000000 00000000 8e2c2a90
> >>> [   90.763362]         80d90000 00000001 00000000 8e2c2a90 00000003 80260dc0 08052098 80680000
> >>> [   90.780033]         ...
> >>> [   90.784902] Call Trace:
> >>> [   90.789793] [<8000f0d8>] show_stack+0xb8/0x148
> >>> [   90.798659] [<8005a000>] register_lock_class+0x270/0x55c
> >>> [   90.809247] [<8005cb64>] __lock_acquire+0x13c/0xf7c
> >>> [   90.818964] [<8005e314>] lock_acquire+0x194/0x1dc
> >>> [   90.828345] [<8003f27c>] flush_work+0x200/0x24c
> >>> [   90.837374] [<80041dfc>] __cancel_work_timer+0x158/0x210
> >>> [   90.847958] [<801a8770>] jffs2_sync_fs+0x20/0x54
> >>> [   90.857173] [<80125cf4>] iterate_supers+0xf4/0x120
> >>> [   90.866729] [<80158fc4>] sys_sync+0x44/0x9c
> >>> [   90.875067] [<80014424>] syscall_common+0x34/0x58
> >>>
> >>> Signed-off-by: Daniel Santos <daniel.santos@pobox.com>
> >>> ---
> >>>  fs/jffs2/super.c | 3 ++-
> >>>  1 file changed, 2 insertions(+), 1 deletion(-)
> >>>
> >>> diff --git a/fs/jffs2/super.c b/fs/jffs2/super.c
> >>> index 793ad30970ff..cae4ecda3c50 100644
> >>> --- a/fs/jffs2/super.c
> >>> +++ b/fs/jffs2/super.c
> >>> @@ -101,7 +101,8 @@ static int jffs2_sync_fs(struct super_block *sb, int wait)
> >>>     struct jffs2_sb_info *c = JFFS2_SB_INFO(sb);
> >>>
> >>>  #ifdef CONFIG_JFFS2_FS_WRITEBUFFER
> >>> -   cancel_delayed_work_sync(&c->wbuf_dwork);
> >>> +   if (jffs2_is_writebuffered(c))
> >>> +           cancel_delayed_work_sync(&c->wbuf_dwork);
> >>>  #endif
> >>>
> >>>     mutex_lock(&c->alloc_sem);
> >>>
> >> Reviewed-by: Hou Tao <houtao1@huawei.com>

Boris, can you please queue up this patch?

-- 
Thanks,
//richard
