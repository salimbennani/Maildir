Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 25 Nov 2018 14:41:55 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga002.jf.intel.com (orsmga002.jf.intel.com [10.7.209.21])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id EB7F1580460;
	Sat, 24 Nov 2018 01:57:32 -0800 (PST)
Received: from orsmga102-1.jf.intel.com (HELO mga09.intel.com) ([10.7.208.27])
  by orsmga002-1.jf.intel.com with ESMTP; 24 Nov 2018 01:57:32 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3AQvq14h2Pp7RcDKAPsmDT+DRfVm0co7zxezQtwd8Z?=
 =?us-ascii?q?segSKfnxwZ3uMQTl6Ol3ixeRBMOHs6IC07KempujcFRI2YyGvnEGfc4EfD4+ou?=
 =?us-ascii?q?JSoTYdBtWYA1bwNv/gYn9yNs1DUFh44yPzahANS47xaFLIv3K98yMZFAnhOgpp?=
 =?us-ascii?q?POT1HZPZg9iq2+yo9JDffwZFiCChbb9uMR67sRjfus4KjIV4N60/0AHJonxGe+?=
 =?us-ascii?q?RXwWNnO1eelAvi68mz4ZBu7T1et+ou+MBcX6r6eb84TaFDAzQ9L281/szrugLd?=
 =?us-ascii?q?QgaJ+3ART38ZkhtMAwjC8RH6QpL8uTb0u+ZhxCWXO9D9QLYpUjqg8qhrUgflhi?=
 =?us-ascii?q?cZOTAk/m/Zict+jKNAoBK5pRFy2JLYbJ2POfZiZK7RYc8WSGxcVchRTSxBBYa8?=
 =?us-ascii?q?YpMVAeUbO+ZTspTwp1oUohu4GAKhA/jgyj5SiX/wxa01yeIhHR/a0AA9Ht8Dq2?=
 =?us-ascii?q?nYodT7OasITe+1y6zIwCzFYvhL2jn98JDFfg49rfyIR758bMTcxVc1Gw/YjVic?=
 =?us-ascii?q?tZbpMjKX2+gVrmSX8+ttWfiyh2I5tw19uCajytoih4XTgo8Yy1bJ/jhjzokvP9?=
 =?us-ascii?q?23Ukt7bMakEJROsyGaMJN7Qt0tQ252oiY20L4GtoChfCgM1psnwwTTa/udc4iH?=
 =?us-ascii?q?+h7jVeCRLilkhH99Zr6zmxK//VK9xuDySMW4yktGoylZntXWt30A1QTf6s2dRf?=
 =?us-ascii?q?t8+keh1yyP1wfW6uxcJUA0lKzbK4Muw7IplZocr17DHinol0XylaOWcUsl+u62?=
 =?us-ascii?q?5OT9ebjmuJCcOJFuig3kMaQhhNa/AeImPQgKRWSb/v681LL78U3jXLpKluE2kr?=
 =?us-ascii?q?XesJ3CIcQbp625DBFP3ocs9hayFDOm0NUenXkaI1NJYhOHj471O17QJPD0F+uw?=
 =?us-ascii?q?g1OpkD1z3fDJIqXhAonRLnjEiLrhfaxy609AyAUpytBT/ZJUCqwbL/L1VU/8r9?=
 =?us-ascii?q?jYDh4/MwypzOfrEtR91oUCWW2RBq+VKr/dsViN5ug3OemDeJcVuCrhK/gi//Pu?=
 =?us-ascii?q?j3g5lkEHcamq2psXbna4HvN9LkWdYHrshMoBEGgQsgo/SuzqlEONUTpJa3muWK?=
 =?us-ascii?q?I84ykxCJi6AofbWoCtnLuB0T+hEZ1NZmBGDVOMHW3yd4qeWfcBcyaSIs5nkjwZ?=
 =?us-ascii?q?WrmtUY4h1ReytADkz7prNPbb+iodtZj7zth6+/XTlQ0u9TxzF8md0HuCT2dukm?=
 =?us-ascii?q?MMRj85xqZ/oUNmx1eH0Kh4heFYFNNJ6/NIVAc6KYDTz+hgB9/uXQLBe8+DSEy6?=
 =?us-ascii?q?TdW+HTExUtUxzscTbElnBdWtkArP3yqwDL8TjLyEGpo0/qXY33jyIsZ9z23L1K?=
 =?us-ascii?q?0gj1kgX8tOOneqhq959wjPGYHJl1+VmLqtdaQZxCTN7nuMzXKSvEFEVw59SbjK?=
 =?us-ascii?q?UmoBZkTIt9j55lnNT7m1Cbs5NAtM0sqCKqpMat30glRKXvbjONLCY22vn2e8Hw?=
 =?us-ascii?q?qHxrSJbIDyYWUSwD3dCFQYkwAU5XuGKQk+BiKmo2LCDDxvFUjjY1/2/el5snO7?=
 =?us-ascii?q?Sk40zweFb0B607q1+xgVheGTSv8J37IEvjshpCtwHFqnw93WDN+ArRJ7fKpAed?=
 =?us-ascii?q?M9/EtH1WXBugNnOpyvMa9jiUAecghtpEzuygh4BZ9Gkcgpq3Mq0hF/KaaZ0FNH?=
 =?us-ascii?q?ajOZ0or8OrzRKmnu4h+vb7Ta1U3Z0NaT4q0P8ug3q03/vAG1EUov63Vm08RP33?=
 =?us-ascii?q?SA/JnLDQoSXoj3UkY47BV6o7DaYi8g54Lbz3FsMK+0siPc1NItHucq1hGgf9JH?=
 =?us-ascii?q?OqOeCADyC9EaB9SpKOEygVipbw4LM/pI9KEpOMOqbf2G17CxPOZhhT6pkX5I4I?=
 =?us-ascii?q?Rg3U2S7Sp8TejI0o0Bw/GZ2AuHSjj9gE2gssDxhYBLezUSEnCjxijjAY5bfrdy?=
 =?us-ascii?q?cpoTCWeyP823wc1zhp7sW3JC9F+vHUgG2NKveReJa1z93AtQ1VkYoHC9mCu4yS?=
 =?us-ascii?q?B0nC8trqaFwCPOxOHifgIdOmFXXGlikUvsIY+sgtAYRkeodQsplBii5Urg3KhU?=
 =?us-ascii?q?vqd/L2rSQUdOYSf2KXpvUq+xtrqEfs5O54kksSRRUOSgf1+aTqTxrAcd0yPmB2?=
 =?us-ascii?q?Fe3iw0dym2upXlmBx3kGKcI2x0rHbDe8FwxBHf6cfYRf5Q2DoGWSZ5hSPWBli6?=
 =?us-ascii?q?I9mm49GUm43fveC5UmKrTodTfjXzzYOcqCu74nVnAR6lkPCygNHnERU63jX919?=
 =?us-ascii?q?llTijIqBf8Yo/216W1K+5nf09oBEPi5Mp+AI1xjowwhJQI03gAmpqV5WYHkXv0?=
 =?us-ascii?q?MdhD3KL+bXkNSiQRz9/b/gflw1FjIWyTx43iSHqd2MRhasK+YmMX3CI98s9LBL?=
 =?us-ascii?q?2V7LxCgSt6vF64oRjNbvh6mzcX0eEu52ICg+EVpAotyT2QAqwVHUldJyDtlg6H?=
 =?us-ascii?q?79ajrKVMf2avcKO91E5/ndCnEbGDrRtQWHf/epc+AyBw6t9zP07L0H328ovkYs?=
 =?us-ascii?q?XfbcoPth2IlBfNl/NaJ4g2lvoOmCprI2b9vWA+xu4/jBxu24y6vYedJ2Vs+qK5?=
 =?us-ascii?q?HgBXNjnva8wP/THtiL5UntyK0IC3ApVhBjILUYPqTf2yFTIdq+/nOxySEDEmqX?=
 =?us-ascii?q?ebBLnfHRKZ6Eh8tHLCCJSrN3CRJHkEwtRuXhidJEpDgA8KWDU2hII2FgevxMb5?=
 =?us-ascii?q?akd2+igR5kLkqhtL0u9pNx7/UnrGpAe1cDg0ToKTLAFR7gFE6EfYKsie7uN1Hy?=
 =?us-ascii?q?FF8Zyttg2NKmqHZwtWCWEFQFCLB1fmPrO2/9nP7/CYBvaiL/vJebiOqfJRV/aL?=
 =?us-ascii?q?xZKs04tq5TWMNt+IPnltEfI7wFdDXWtiFsTdmjUPTTEXli3XY86aohe85jN4rs?=
 =?us-ascii?q?Sl/Pv3XwLv4JOFC6FOPtV35xC2naCDOvaKiyZkMjlYzI0DxH/SxLgb3V4fkCVu?=
 =?us-ascii?q?dzirEbQdui/BVqPQmqlLDxEFbyN/LtdH76U53gNVI87Ulsv11qJkjv4yE1pFSV?=
 =?us-ascii?q?3hmsSzacMWOW2yKFPHC1iNNLmdIT3Lwsf3Yb6zSLFKjeVUsQGwtiifE0P5IjuD?=
 =?us-ascii?q?kDzpXQi1Me5QlCGbIABeuIalfxdtE2fjStfmahy9MNBvjDw2wac7hnXFNWMHNT?=
 =?us-ascii?q?h8ckVNrqCf7C9Cg/V/HXBB4WRhLeWehymZ6OzYed4qtq5CBChumv0SxXMg17xT?=
 =?us-ascii?q?pHVNR+RwsC/TqMN+5l+hj++DwyZmVxwIrSxE0sbDsF9kNL7F8d9FX3qC8h8X62?=
 =?us-ascii?q?yWBxkYj9RgA9zr/atXz4vhjqX2fQ9L9Zr+/MIaT5zeKcuBKHMna0KwRhaNUlBD?=
 =?us-ascii?q?RjmuYzKMz3dBme2foyXG5qMxrYLhzcID?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0AYAABdH/lbh0O0hNFjHQEBBQEHBQGBU?=
 =?us-ascii?q?QgBCwGDaycKjAeMAYIhiGUkhTgDiGSBdSoTAYhaIjQJDQEDAQEBAQEBAgETAQE?=
 =?us-ascii?q?BCA0JCCkjDII2IoJsAiQZAQE3AQUJAhg4A1oBEgWDHIFpAQMUAQWmAoFsM4J2A?=
 =?us-ascii?q?QEFgkOBbAFJBIIaCIdehCuCFohqhhKBLAEBAY5ij2QOAQYCAXpcj1sWiVKHNpl?=
 =?us-ascii?q?2gg1NI4FugU6CGwwXg0qKXzQxgQQBAQEhiSqBLgGBHgEB?=
X-IPAS-Result: =?us-ascii?q?A0AYAABdH/lbh0O0hNFjHQEBBQEHBQGBUQgBCwGDaycKjAe?=
 =?us-ascii?q?MAYIhiGUkhTgDiGSBdSoTAYhaIjQJDQEDAQEBAQEBAgETAQEBCA0JCCkjDII2I?=
 =?us-ascii?q?oJsAiQZAQE3AQUJAhg4A1oBEgWDHIFpAQMUAQWmAoFsM4J2AQEFgkOBbAFJBII?=
 =?us-ascii?q?aCIdehCuCFohqhhKBLAEBAY5ij2QOAQYCAXpcj1sWiVKHNpl2gg1NI4FugU6CG?=
 =?us-ascii?q?wwXg0qKXzQxgQQBAQEhiSqBLgGBHgEB?=
X-IronPort-AV: E=Sophos;i="5.56,273,1539673200"; 
   d="scan'208";a="54610695"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 24 Nov 2018 01:57:31 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S1726137AbeKXUpb (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Sat, 24 Nov 2018 15:45:31 -0500
Received: from m12-13.163.com ([220.181.12.13]:60059 "EHLO m12-13.163.com"
        rhost-flags-OK-OK-OK-OK) by vger.kernel.org with ESMTP
        id S1725940AbeKXUpb (ORCPT <rfc822;linux-kernel@vger.kernel.org>);
        Sat, 24 Nov 2018 15:45:31 -0500
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=163.com;
        s=s110527; h=From:Subject:Date:Message-Id; bh=7J89eZ5fW8/oS2WhaN
        DIG5+D61MYEvp2nIuYqqeYPZo=; b=fmBaIyevuH37KFRuqYQlE+vZXg0cDhTzch
        E6T+fbPBnm8z5k02XPNduecKKA8HX7k6+IHZiDbBSDGnDB1YGGkQCMzr3lzC1BK1
        X7t/umUNcP+CTI3IEl6U91MTU8tWsnUGv8S2wKHMnpDmCEIDn/uCWEW4Zqh+0/B8
        MAcUAO/UU=
Received: from bp.localdomain (unknown [106.120.213.96])
        by smtp9 (Coremail) with SMTP id DcCowAA3zhaAIPlb6G5XBg--.53608S3;
        Sat, 24 Nov 2018 17:57:25 +0800 (CST)
From: Pan Bian <bianpan2016@163.com>
To: Andrew Morton <akpm@linux-foundation.org>,
        ernesto.mnd.fernandez@gmail.com
Cc: linux-fsdevel@vger.kernel.org, linux-kernel@vger.kernel.org,
        Pan Bian <bianpan2016@163.com>
Subject: [PATCH 1/1] hfsplus: do not free node before using
Date: Sat, 24 Nov 2018 17:57:21 +0800
Message-Id: <1543053441-66942-1-git-send-email-bianpan2016@163.com>
X-Mailer: git-send-email 2.7.4
X-CM-TRANSID: DcCowAA3zhaAIPlb6G5XBg--.53608S3
X-Coremail-Antispam: 1Uf129KBjvdXoWrtr1DCw1xCFy5WF43tF48Xrb_yoWfGFc_Xa
        1I9as7t3yrJFZ7JrZxArZ8t3sFgF4rG3s7Ww4xtF1Yk3yjyan8Jr1kZrnYkryfurWYqr15
        JrWktry5Ga4UXjkaLaAFLSUrUUUUUb8apTn2vfkv8UJUUUU8Yxn0WfASr-VFAUDa7-sFnT
        9fnUUvcSsGvfC2KfnxnUUI43ZEXa7IU0sYFJUUUUU==
X-Originating-IP: [106.120.213.96]
X-CM-SenderInfo: held01tdqsiiqw6rljoofrz/1tbiQAIJclSIYSB5fQAAsg
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

The function hfs_bmap_free frees node via hfs_bnode_put(node).
However, it then reads node->this when dumping error message on an error
path, which may result in a use-after-free bug. This patch frees node
only when it is never used.

Signed-off-by: Pan Bian <bianpan2016@163.com>
---
 fs/hfsplus/btree.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/fs/hfsplus/btree.c b/fs/hfsplus/btree.c
index 236efe5..66774f4 100644
--- a/fs/hfsplus/btree.c
+++ b/fs/hfsplus/btree.c
@@ -466,14 +466,15 @@ void hfs_bmap_free(struct hfs_bnode *node)
 
 		nidx -= len * 8;
 		i = node->next;
-		hfs_bnode_put(node);
 		if (!i) {
 			/* panic */;
 			pr_crit("unable to free bnode %u. "
 					"bmap not found!\n",
 				node->this);
+			hfs_bnode_put(node);
 			return;
 		}
+		hfs_bnode_put(node);
 		node = hfs_bnode_find(tree, i);
 		if (IS_ERR(node))
 			return;
-- 
2.7.4


