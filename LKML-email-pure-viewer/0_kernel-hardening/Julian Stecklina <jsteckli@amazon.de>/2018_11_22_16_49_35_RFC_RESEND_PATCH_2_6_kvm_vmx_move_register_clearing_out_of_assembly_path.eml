Return-Path: <linux-kernel-owner@vger.kernel.org>
Delivered-To: unknown
Received: from linux.intel.com (10.54.29.200:995) by likexu-workstation with
  POP3-SSL; 23 Nov 2018 08:29:40 -0000
X-Original-To: like.xu@linux.intel.com
Delivered-To: like.xu@linux.intel.com
Received: from orsmga002.jf.intel.com (orsmga002.jf.intel.com [10.7.209.21])
	(using TLSv1.2 with cipher ECDHE-RSA-AES256-GCM-SHA384 (256/256 bits))
	(No client certificate requested)
	by linux.intel.com (Postfix) with ESMTPS id CD86B58037D;
	Thu, 22 Nov 2018 08:50:11 -0800 (PST)
Received: from orsmga103.jf.intel.com ([10.7.208.35])
  by orsmga002-1.jf.intel.com with ESMTP/TLS/DHE-RSA-AES256-GCM-SHA384; 22 Nov 2018 08:50:11 -0800
X-SG-BADATTACHMENTNOREPLY: True
IronPort-PHdr: =?us-ascii?q?9a23=3ALQaUihRaTadhk2MTgtRsXdymTtpsv+yvbD5Q0YIu?=
 =?us-ascii?q?jvd0So/mwa64YRKAt8tkgFKBZ4jH8fUM07OQ7/iwHzRYqb+681k6OKRWUBEEjc?=
 =?us-ascii?q?hE1ycBO+WiTXPBEfjxciYhF95DXlI2t1uyMExSBdqsLwaK+i764jEdAAjwOhRo?=
 =?us-ascii?q?LerpBIHSk9631+ev8JHPfglEnjWwba9xIRmssQndqtQdjJd/JKo21hbHuGZDdf?=
 =?us-ascii?q?5MxWNvK1KTnhL86dm18ZV+7SleuO8v+tBZX6nicKs2UbJXDDI9M2Ao/8LrrgXM?=
 =?us-ascii?q?TRGO5nQHTGoblAdDDhXf4xH7WpfxtTb6tvZ41SKHM8D6Uaw4VDK/5KpwVhTmlD?=
 =?us-ascii?q?kIOCI48GHPi8x/kqRboA66pxdix4LYeZyZOOZicq/Ye94VQnZPUMZPWiBYG4+y?=
 =?us-ascii?q?bZYAD/AYMehFson9vEMOogWiCgmwHe/vzjhIh3Hr1qE+0+ktFAfL0ws8EdwOrn?=
 =?us-ascii?q?nYtcz5OqUPXuCv1aXG0CjDb+hO2Tjj9IfIbg0qrfWSUb5sdMbcz1QkGQHYgVWK?=
 =?us-ascii?q?sYHrPy2b2PkDvWaY6ORvV+yvhGwpqw5+vjehydwsipHLi48O1lDJ9j90zJovKN?=
 =?us-ascii?q?GkSkN2Z8OvHptKtyGdMot7WscsQ3xsuCY70LIGv4OwcjUWyJs52xHfaPiHc4mO?=
 =?us-ascii?q?4h35Se2cJjV4hGl5eL2hmxmy8kygyuznW8au1VZFtCtEkt7KtnwXyhPc9NGKR/?=
 =?us-ascii?q?1g9UmiwTaCzx7f5v1ALEwuiKbWJYAtzqQtmpcQrUjPBC77lUfugKOIakkp+PKk?=
 =?us-ascii?q?5/nlb7n7vJOQKot5hh3kPqgzhsCyB/kzPBIUUGiB4+u80aXu/U3nT7VOif07ir?=
 =?us-ascii?q?fZsJ/EKsQBvKK5ABFa0pwl6xmhCzeqytMYnWMILF5deRKHiZbmO03WLfzmEfuy?=
 =?us-ascii?q?h06gnCplyvzYJLHtH5bAImTZnLrgf7tx80tcxxAyzdBb6ZJUELYBIPfrV0/1td?=
 =?us-ascii?q?zYCAI5MgOtz+bkFtp9zIUeVnyLAqOAN6PTv1mI6fw1I+SXeo8VtyjyK+I/6/7t?=
 =?us-ascii?q?k3A5g1kdcret3ZcNb3C4BPtmL12DYXXwmtcBDXsKvg0mQezuiV2CUiBca2y9Xq?=
 =?us-ascii?q?Ih/Tw7DIOmDYHeRoGimrCB3SG7HoFIaWBCEFyDDXDod4CcUfcWdC2SOtNhkiAD?=
 =?us-ascii?q?VbW5S48uzxCutBPgxLpgNObU+jAYuojl1Nh6/ODTkRAy9TppD8WSyW2NTmd0nn?=
 =?us-ascii?q?8WSD8yxqxwvUt9ylKb26hin/NYDcBT5+9OUgoiN57cyPJ1B8rxWgLGeNeJTlGm?=
 =?us-ascii?q?T86iATEwSNIx3tAPb1x8G9WkkhDMwS6qD6UJmLyMAZw+6rjc0GTpJ8Zh13bG07?=
 =?us-ascii?q?EsgEM9QstPMm2mhbRz9xLJCI7LiEiZk6eqdaIB3C/C7muDzGyOvF1GXw50S6nK?=
 =?us-ascii?q?QXcfZk7Op9Tj+kzCV6OuCaggMgZZys6NMK1KZsftjVVHXvjjPtvebnm1m2exAx?=
 =?us-ascii?q?aI27yNYJDre2UbwCXSFkwEnxoP8naBMAg0Hj2hrH7GDDxyCVLvZFvh/vRkp3Ol?=
 =?us-ascii?q?UEA41QGKYFdn17qu5BEVg/uQS/cQ3rIBvCcssDF0HFe739LLBNuMvQthfKNAYd?=
 =?us-ascii?q?wj5FdLz37Wtwt4Ppa4NaBtmkYecxhrv0Ppzxh4F59PkdY0o38wzAp9M6SY0Ehf?=
 =?us-ascii?q?eDOexp3wPrzXKm/v/BGgcaLW21fe0MqI9acL8vg3t1LjvASxHEo473pny8VV02?=
 =?us-ascii?q?eb5pjSEAoSUJfxUkEr9xh6p7DWeDU965nT1X12Nam0sznC290yCeshyxagecpf?=
 =?us-ascii?q?MayeGA/zFc0aG9ahKOgwl1e1aRIEOfhY9LQoMMO+a/uGxKmrMf56kzKik2tG75?=
 =?us-ascii?q?5y00KW+yVnV+7HwowKw/eb3guASTfxl1OhssHxmYBZajAeBGu/yS74BIFPYq1+?=
 =?us-ascii?q?Z5oECWCrI8ev3NVxm4btW2JE9F6kH14H2NKpdQCOYFDn3AxQ1V4YoXqomSajyz?=
 =?us-ascii?q?x0kjcprreQ3SDUwuTicgYHNXBPRGV4kVjsJo20hcgAXEe0dwgpiAel5UHiyqhB?=
 =?us-ascii?q?paRwM3PcQV1VcCjxNW1iVLW/tqCDY8JW9JwnqyFXX/miblCATb79pQAX0yfiH2?=
 =?us-ascii?q?tY2TA6eCumupT/nxxmlm2dKGx/o2beecF13R3f/sDTReZN3joaQyl1kTnWBlmm?=
 =?us-ascii?q?M9ip59mUjIrDsualWmKlV51TdzTrzIyauCu6421qHQOwn/SpltL7Fgg61Dfx18?=
 =?us-ascii?q?N2WiXQsBb8fo7r2ry4Me19ZEloB1z8681gFoFliIQwh5IQ2XkchpqL+3oKimPz?=
 =?us-ascii?q?MdRd2aLjY3sBXz8Lw9jJ4Af73E1vNG6Gx4X8Vn+F2Mtue8G6Yn8K2iI6981LCL?=
 =?us-ascii?q?2b7LtekSt3o1q4qxncYfx8njcb1Psv52QWg+APuAox0CqdBqoeElVfPSzpjx6I?=
 =?us-ascii?q?9cyxrL1LZGazdri9zEl+ksqgDL2YogFcRWz2epEtHSJr6sV/MVTM0GD8643+ed?=
 =?us-ascii?q?nQa84TuQOQkxvak+dVL5cxnOIQhSV7IWL9oWEly+kjgBxr3JG6v5KIJ39j/a2n?=
 =?us-ascii?q?GR5YKiP6Z9kI9T7zl6Zekd2b34SuHpVnBzUKU4HkTfOuEDIOq/vnMxyCHyE7qn?=
 =?us-ascii?q?eeAbDfBxOQ6F96r3LTFJCmL22XJH4czdl4RRiSPkpfgB0PXDUhn540DQSqxM3n?=
 =?us-ascii?q?cEdk6TEd/F/4qh1Qyu12MxnzSHvQpACtaj0sUpiQMAJW7h1e50fSKcGR9fh8Hy?=
 =?us-ascii?q?Zc/p28tgCNLnGbah9MDWEIXEyEGl/iMqOv5dnG7+iXGO6+I+HSbrWJrOxUT+2I?=
 =?us-ascii?q?yo630ot64zaMMd2CPnt4AP0+xEVDRmp1G9jDlzUMViwXlD/Nb8iBqxen4SB3qs?=
 =?us-ascii?q?G/8PL2WAPg/4ePCr1SMclx9BCym6uMK+mQhCNhIzZCypwM3WPIyKQY3FMKiyBu?=
 =?us-ascii?q?cCStEa0dtSHXSqLcgLRXDxkdayN8L8ZI66M83g9QOc/UkN/117h4juIrBFdBT1?=
 =?us-ascii?q?DuhsapZckSKWGnKFzHHFqLNKiBJTDTw8H4f6K8Sb5TjOVVrRGwuiybE0jsPjud?=
 =?us-ascii?q?jTnpSguvPPpIjCGaOhxepY68fgxsCWjlUNLpdBm7PMVrgj0xxL0+nmnKOnIEMT?=
 =?us-ascii?q?hgb0NNqaWd4jlFgvpkAWxO8HpkIfOAmyaY9OTYLpcWsf12AiV7je5a4XI6y6dL?=
 =?us-ascii?q?4yFAXvB6hCzSrtt2qVG8juaP0iZnUAZJqjtTmIKLvEBiNb/F+ZVaRXnE/AwC7W?=
 =?us-ascii?q?OLBhQOpttlDMDvuq9KxtjOkqLzNClN89bO8cQAAMjULdqNMGA9PhrxBD7UEAwF?=
 =?us-ascii?q?QCarNG7FgUxdlfCS9nuNoZk7qpjjgpwOSrBAWVwxF/MaDFllHdMYLJd2WDMkja?=
 =?us-ascii?q?CUjMoS6XWiqxnRQZYSgpeSVf+IB/jrbTaQl7VJYRoOzpv8LJ8PLcv8w0FkdVB+?=
 =?us-ascii?q?mMLBHE+Dc8pKp3hDcws1qUMFy2RzRW432kTsIlev+2MeHv2wnzY/jwJsZuJr+D?=
 =?us-ascii?q?q6sAR/HUbDuCZlyBp5ot7imz3ENWGsIQ=3D=3D?=
X-IronPort-Anti-Spam-Filtered: true
X-IronPort-Anti-Spam-Result: =?us-ascii?q?A0BuAwC+3fZbh0O0hNFihXESJ4N4iHeLI?=
 =?us-ascii?q?QGBaDmJBI9GA0oUAQEYEwGIUiI4EgEDAQEBAQEBAgETAQEBCA0JCCkjDII2JIJ?=
 =?us-ascii?q?jAwMBAg4SDwENAQE3AQUJAQEkAiYCAgNUGQWDHIF1DQWSVQEBiQ4BjE9wgS+Cd?=
 =?us-ascii?q?gEBBYcaCIELhlODD4EcF4FAP4ERM4V6AoIugjeCV4klgW6UcQkddJAeGIlRhze?=
 =?us-ascii?q?YCQIECwITAYFdVYEhTSQUgyeCJxeDfYogPgEBMYEFAQGMVAEB?=
X-IPAS-Result: =?us-ascii?q?A0BuAwC+3fZbh0O0hNFihXESJ4N4iHeLIQGBaDmJBI9GA0o?=
 =?us-ascii?q?UAQEYEwGIUiI4EgEDAQEBAQEBAgETAQEBCA0JCCkjDII2JIJjAwMBAg4SDwENA?=
 =?us-ascii?q?QE3AQUJAQEkAiYCAgNUGQWDHIF1DQWSVQEBiQ4BjE9wgS+CdgEBBYcaCIELhlO?=
 =?us-ascii?q?DD4EcF4FAP4ERM4V6AoIugjeCV4klgW6UcQkddJAeGIlRhzeYCQIECwITAYFdV?=
 =?us-ascii?q?YEhTSQUgyeCJxeDfYogPgEBMYEFAQGMVAEB?=
X-IronPort-AV: E=Sophos;i="5.56,266,1539673200"; 
   d="scan'208";a="53375448"
X-Amp-Result: SKIPPED(no attachment in message)
X-Amp-File-Uploaded: False
Received: from vger.kernel.org ([209.132.180.67])
  by mtab.intel.com with ESMTP; 22 Nov 2018 08:50:09 -0800
Received: (majordomo@vger.kernel.org) by vger.kernel.org via listexpand
        id S2404346AbeKWDaR (ORCPT <rfc822;like.xu@linux.intel.com>
        + 23 others); Thu, 22 Nov 2018 22:30:17 -0500
Received: from smtp-fw-33001.amazon.com ([207.171.190.10]:48409 "EHLO
        smtp-fw-33001.amazon.com" rhost-flags-OK-OK-OK-OK) by vger.kernel.org
        with ESMTP id S2403948AbeKWDaQ (ORCPT
        <rfc822;linux-kernel@vger.kernel.org>);
        Thu, 22 Nov 2018 22:30:16 -0500
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;
  d=amazon.de; i=@amazon.de; q=dns/txt; s=amazon201209;
  t=1542905405; x=1574441405;
  h=from:to:cc:subject:date:message-id:mime-version:
   content-transfer-encoding;
  bh=JrL1vEL41+eim8P8jSIRf07IUBu42y+4esgLR4Um2+s=;
  b=pmQ1SNqvMsEup1BwmRaG0OWvne8cSfnw5T3qYzpb58fJukGZPCDKi3n1
   xcWMuKP9EAIwecgVy/BDEkTjKBR2N9HeJ0VOGSVi/T9W2I8oEBpFamnCu
   0VW2HzXTss8tmff5Ppd+10HLQjcgx4QjSBl737joMGFuRO+PDvjDlLnd3
   w=;
X-IronPort-AV: E=Sophos;i="5.56,253,1539648000"; 
   d="scan'208";a="766849695"
Received: from sea3-co-svc-lb6-vlan2.sea.amazon.com (HELO email-inbound-relay-2a-c5104f52.us-west-2.amazon.com) ([10.47.22.34])
  by smtp-border-fw-out-33001.sea14.amazon.com with ESMTP/TLS/DHE-RSA-AES256-SHA; 22 Nov 2018 16:50:03 +0000
Received: from u54ee758033e858cfa736.ant.amazon.com (pdx2-ws-svc-lb17-vlan2.amazon.com [10.247.140.66])
        by email-inbound-relay-2a-c5104f52.us-west-2.amazon.com (8.14.7/8.14.7) with ESMTP id wAMGnwWR079444
        (version=TLSv1/SSLv3 cipher=DHE-RSA-AES256-SHA bits=256 verify=NO);
        Thu, 22 Nov 2018 16:50:00 GMT
Received: from u54ee758033e858cfa736.ant.amazon.com (localhost [127.0.0.1])
        by u54ee758033e858cfa736.ant.amazon.com (8.15.2/8.15.2/Debian-3) with ESMTP id wAMGnvPc008110;
        Thu, 22 Nov 2018 17:49:57 +0100
Received: (from jsteckli@localhost)
        by u54ee758033e858cfa736.ant.amazon.com (8.15.2/8.15.2/Submit) id wAMGnuwX008109;
        Thu, 22 Nov 2018 17:49:56 +0100
From: Julian Stecklina <jsteckli@amazon.de>
To: kernel-hardening@lists.openwall.com
Cc: Julian Stecklina <jsteckli@amazon.de>,
        Liran Alon <liran.alon@oracle.com>,
        Tycho Andersen <tycho@tycho.ws>,
        Jonathan Adams <jwadams@google.com>,
        David Woodhouse <dwmw2@infradead.org>,
        LKML <linux-kernel@vger.kernel.org>
Subject: [RFC RESEND PATCH 2/6] kvm, vmx: move register clearing out of assembly path
Date: Thu, 22 Nov 2018 17:49:35 +0100
Message-Id: <4c9432269f81f28cc929811b3eb17c473f94bcfa.1542905228.git.jsteckli@amazon.de>
X-Mailer: git-send-email 2.7.4
In-Reply-To: <cover.1542905228.git.jsteckli@amazon.de>
References: <cover.1542905228.git.jsteckli@amazon.de>
In-Reply-To: <cover.1542905228.git.jsteckli@amazon.de>
References: <cover.1542905228.git.jsteckli@amazon.de>
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit
Sender: linux-kernel-owner@vger.kernel.org
Precedence: bulk
List-ID: <linux-kernel.vger.kernel.org>
X-Mailing-List: linux-kernel@vger.kernel.org

Split the security related register clearing out of the large inline
assembly VM entry path. This results in two slightly less complicated
inline assembly statements, where it is clearer what each one does.

Signed-off-by: Julian Stecklina <jsteckli@amazon.de>
Reviewed-by: Jan H. Sch√∂nherr <jschoenh@amazon.de>
Reviewed-by: Konrad Jan Miller <kjm@amazon.de>
Reviewed-by: Jim Mattson <jmattson@google.com>
---
 arch/x86/kvm/vmx.c | 46 +++++++++++++++++++++++++++++-----------------
 1 file changed, 29 insertions(+), 17 deletions(-)

diff --git a/arch/x86/kvm/vmx.c b/arch/x86/kvm/vmx.c
index a6e5a5cd8f14..8ebd41d935b8 100644
--- a/arch/x86/kvm/vmx.c
+++ b/arch/x86/kvm/vmx.c
@@ -11281,24 +11281,7 @@ static void __noclone vmx_vcpu_run(struct kvm_vcpu *vcpu)
 		"mov %%r13, %c[r13](%0) \n\t"
 		"mov %%r14, %c[r14](%0) \n\t"
 		"mov %%r15, %c[r15](%0) \n\t"
-		/*
-		* Clear host registers marked as clobbered to prevent
-		* speculative use.
-		*/
-		"xor %%r8d,  %%r8d \n\t"
-		"xor %%r9d,  %%r9d \n\t"
-		"xor %%r10d, %%r10d \n\t"
-		"xor %%r11d, %%r11d \n\t"
-		"xor %%r12d, %%r12d \n\t"
-		"xor %%r13d, %%r13d \n\t"
-		"xor %%r14d, %%r14d \n\t"
-		"xor %%r15d, %%r15d \n\t"
 #endif
-
-		"xor %%eax, %%eax \n\t"
-		"xor %%ebx, %%ebx \n\t"
-		"xor %%esi, %%esi \n\t"
-		"xor %%edi, %%edi \n\t"
 		"pop  %%" _ASM_BP "; pop  %%" _ASM_DX " \n\t"
 		".pushsection .rodata \n\t"
 		".global vmx_return \n\t"
@@ -11335,6 +11318,35 @@ static void __noclone vmx_vcpu_run(struct kvm_vcpu *vcpu)
 #endif
 	      );
 
+	/*
+         * Explicitly clear (in addition to marking them as clobbered) all GPRs
+         * that have not been loaded with host state to prevent speculatively
+         * using the guest's values.
+         */
+	asm volatile (
+		"xor %%eax, %%eax \n\t"
+		"xor %%ebx, %%ebx \n\t"
+		"xor %%esi, %%esi \n\t"
+		"xor %%edi, %%edi \n\t"
+#ifdef CONFIG_X86_64
+		"xor %%r8d,  %%r8d \n\t"
+		"xor %%r9d,  %%r9d \n\t"
+		"xor %%r10d, %%r10d \n\t"
+		"xor %%r11d, %%r11d \n\t"
+		"xor %%r12d, %%r12d \n\t"
+		"xor %%r13d, %%r13d \n\t"
+		"xor %%r14d, %%r14d \n\t"
+		"xor %%r15d, %%r15d \n\t"
+#endif
+		::: "cc"
+#ifdef CONFIG_X86_64
+		 , "rax", "rbx", "rsi", "rdi"
+		 , "r8", "r9", "r10", "r11", "r12", "r13", "r14", "r15"
+#else
+		 , "eax", "ebx", "esi", "edi"
+#endif
+		);
+
 	/*
 	 * We do not use IBRS in the kernel. If this vCPU has used the
 	 * SPEC_CTRL MSR it may have left it on; save the value and
-- 
2.17.1

